<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Chen Kai Blog</title>
  
  
  <link href="https://chenk.top/atom.xml" rel="self"/>
  
  <link href="https://chenk.top/"/>
  <updated>2026-01-30T15:35:14.134Z</updated>
  <id>https://chenk.top/</id>
  
  <author>
    <name>Chen Kai</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>学习率：从入门到大模型训练的终极指南</title>
    <link href="https://chenk.top/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/"/>
    <id>https://chenk.top/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/</id>
    <published>2025-03-26T16:00:00.000Z</published>
    <updated>2026-01-30T15:35:14.134Z</updated>
    
    <content type="html"><![CDATA[<p>学习率（Learning Rate, LR）是深度学习里<strong>最重要、也最容易“看起来像玄学”的超参数</strong>。它既像汽车的油门（决定你每一步走多快），也像方向盘的灵敏度（太敏感会蛇形走位甚至翻车，太迟钝又永远到不了目的地）。</p><p>这篇文章会从最简单的二次函数出发，把“学习率为什么会影响稳定性、为什么训练后期要降学习率、为什么 warmup 常见”讲清楚。</p><span id="more"></span><hr><h1>一句话把学习率讲清楚</h1><p>把训练想象成“在雾里下山”：</p><ul><li><strong>参数 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.061ex" height="1.618ex" role="img" focusable="false" viewbox="0 -705 469 715"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g></g></g></svg></mjx-container></strong> 是你的位置；</li><li><strong>损失 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.362ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 1928 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></strong> 是海拔（越低越好）；</li><li><strong>梯度 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.247ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2761 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(1514,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1903,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(2372,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></strong> 是“坡度方向提示”；</li><li><strong>学习率 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></strong> 是“你每一步迈多大”。</li></ul><p>你每一步大致按下面走：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="16.22ex" height="2.084ex" role="img" focusable="false" viewbox="0 -705 7169.4 921"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(5074.2,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(5909.5,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="msub" transform="translate(6354.1,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>其中 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.844ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 815.3 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> 是你看到的梯度（通常是小批量 mini-batch 的随机梯度）。</p><p>学习率的核心矛盾就一句话：</p><blockquote><p><strong><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 越大越快，但越容易不稳定；<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 越小越稳，但越慢、也可能卡住。</strong></p></blockquote><p>接下来我们用“从最简单的二次函数”开始，把这句话拆开讲透。</p><hr><h1>最小可用数学：为什么“太大就炸，太小就慢”</h1><h2 id="从一维抛物线开始（最重要的直觉）"><a class="header-anchor" href="#从一维抛物线开始（最重要的直觉）">¶</a>从一维抛物线开始（最重要的直觉）</h2><p>考虑最简单的损失：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="21.365ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 9443.3 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2205.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(3261.6,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mi" transform="translate(4201.6,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="msup" transform="translate(4730.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mn" transform="translate(502,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(5636.1,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(5914.1,0)"><g data-mml-node="mspace"/></g><g data-mml-node="mi" transform="translate(7080.8,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(7887.6,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"/></g><g data-mml-node="mn" transform="translate(8943.3,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g></svg></mjx-container></p><p>梯度是：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.522ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 5092.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(1514,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1903,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(2372,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(3038.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(4094.6,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(4623.6,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g></g></g></svg></mjx-container></p><p>做梯度下降：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="29.456ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 13019.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(5074.2,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(5571.2,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(6015.9,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="msub" transform="translate(6544.9,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(7629.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mo" transform="translate(8685.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(9074.7,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(9796.9,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(10797.1,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(11294.1,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(11823.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msub" transform="translate(12212.1,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>你看到一个关键系数：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="7.978ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3526.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1111.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(2111.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(2608.4,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(3137.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>。它决定了收敛还是发散：</p><ul><li>若 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.564ex;" xmlns="http://www.w3.org/2000/svg" width="11.624ex" height="2.26ex" role="img" focusable="false" viewbox="0 -749.5 5138 999"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mn" transform="translate(278,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1000.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(2000.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(2497.4,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(3026.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mo" transform="translate(3582.2,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mn" transform="translate(4638,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></svg></mjx-container>，会收敛；</li><li>若 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.564ex;" xmlns="http://www.w3.org/2000/svg" width="11.624ex" height="2.26ex" role="img" focusable="false" viewbox="0 -749.5 5138 999"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mn" transform="translate(278,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1000.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(2000.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(2497.4,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(3026.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mo" transform="translate(3582.2,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"/></g><g data-mml-node="mn" transform="translate(4638,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></svg></mjx-container>，会发散（来回跳并越跳越大）。</li></ul><p>于是得到稳定条件：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.575ex;" xmlns="http://www.w3.org/2000/svg" width="10.482ex" height="4.611ex" role="img" focusable="false" viewbox="0 -1342 4633.1 2038"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(234.5,676)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="729" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p><strong>类比</strong>：你下山时每一步都按“坡度”迈。如果坡太陡（<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container> 大），同样的步幅（<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container>）更容易跨过谷底到另一边再反弹；坡越缓（<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container> 小），你可以迈更大步仍然不翻车。</p><h2 id="多维情况下，“最陡的方向”决定是否爆炸"><a class="header-anchor" href="#多维情况下，“最陡的方向”决定是否爆炸">¶</a>多维情况下，“最陡的方向”决定是否爆炸</h2><p>把 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container> 推广到多维二次型：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="15.069ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 6660.7 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2205.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(3261.6,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="msup" transform="translate(4201.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,413) scale(0.707)"><path data-c="22A4" d="M55 642T55 648T59 659T66 666T71 668H708Q723 660 723 648T708 628H409V15Q402 2 391 0Q387 0 384 1T379 3T375 6T373 9T371 13T369 16V628H71Q70 628 67 630T59 637Z"/></g></g><g data-mml-node="mi" transform="translate(5303.7,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mi" transform="translate(6191.7,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g></g></g></svg></mjx-container></p><p>其中 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container> 是 Hessian（曲率矩阵）。稳定性由最大特征值 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.253ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3647.9 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="TeXAtom" transform="translate(616,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(1981.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2370.9,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3258.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> 主导：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.172ex;" xmlns="http://www.w3.org/2000/svg" width="17.539ex" height="5.208ex" role="img" focusable="false" viewbox="0 -1342 7752 2302"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(1794,676)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="TeXAtom" transform="translate(616,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(1981.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2370.9,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3258.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g><rect width="3847.9" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p><strong>一句话</strong>：训练是否会炸，往往由“最陡那条方向”决定。</p><p><strong>类比</strong>：你在山谷里走路，整体看起来很平缓，但某一条方向上突然很陡（比如悬崖边）。你迈步时只要有分量朝那条方向，就可能摔下去。</p><h2 id="GIF：二维“椭圆谷底”里为什么会走成“之”字"><a class="header-anchor" href="#GIF：二维“椭圆谷底”里为什么会走成“之”字">¶</a>GIF：二维“椭圆谷底”里为什么会走成“之”字</h2><p>二维二次函数是理解“曲率不均匀导致震荡”的最佳玩具模型。考虑：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="24.929ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 11018.7 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mo" transform="translate(550,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(939,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(1511,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(1955.7,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2445.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(3112.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(4168.2,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(5108.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(5497.2,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g><g data-mml-node="msup" transform="translate(6513.7,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mn" transform="translate(605,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(7744.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(8744.7,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="msup" transform="translate(9703.2,0)"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(523,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(10629.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></p><p>当 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.667ex;" xmlns="http://www.w3.org/2000/svg" width="7.988ex" height="1.95ex" role="img" focusable="false" viewbox="0 -567 3530.5 862"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(1236.3,0)"><path data-c="226B" d="M55 539T55 547T60 561T74 567Q81 567 207 498Q297 449 365 412Q633 265 636 261Q639 255 639 250Q639 241 626 232Q614 224 365 88Q83 -65 79 -66Q76 -67 73 -67Q65 -67 60 -61T55 -47Q55 -39 61 -33Q62 -33 95 -15T193 39T320 109L321 110H322L323 111H324L325 112L326 113H327L329 114H330L331 115H332L333 116L334 117H335L336 118H337L338 119H339L340 120L341 121H342L343 122H344L345 123H346L347 124L348 125H349L351 126H352L353 127H354L355 128L356 129H357L358 130H359L360 131H361L362 132L363 133H364L365 134H366L367 135H368L369 136H370L371 137L372 138H373L374 139H375L376 140L378 141L576 251Q63 530 62 533Q55 539 55 547ZM360 539T360 547T365 561T379 567Q386 567 512 498Q602 449 670 412Q938 265 941 261Q944 255 944 250Q944 241 931 232Q919 224 670 88Q388 -65 384 -66Q381 -67 378 -67Q370 -67 365 -61T360 -47Q360 -39 366 -33Q367 -33 400 -15T498 39T625 109L626 110H627L628 111H629L630 112L631 113H632L634 114H635L636 115H637L638 116L639 117H640L641 118H642L643 119H644L645 120L646 121H647L648 122H649L650 123H651L652 124L653 125H654L656 126H657L658 127H659L660 128L661 129H662L663 130H664L665 131H666L667 132L668 133H669L670 134H671L672 135H673L674 136H675L676 137L677 138H678L679 139H680L681 140L683 141L881 251Q368 530 367 533Q360 539 360 547Z"/></g><g data-mml-node="msub" transform="translate(2514,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></g></svg></mjx-container> 时，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.109ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 490 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 方向更“陡”，同一个学习率 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 会在 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.109ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 490 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 方向产生更强的回弹，于是轨迹常常呈现“之”字形（尤其是没加动量时）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">ax, ay = <span class="number">1.0</span>, <span class="number">12.0</span></span><br><span class="line">eta = <span class="number">0.12</span></span><br><span class="line">x = np.array([<span class="number">2.0</span>, <span class="number">1.5</span>])</span><br><span class="line"></span><br><span class="line">path = [x.copy()]</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">45</span>):</span><br><span class="line">    g = np.array([ax * x[<span class="number">0</span>], ay * x[<span class="number">1</span>]])</span><br><span class="line">    x = x - eta * g</span><br><span class="line">    path.append(x.copy())</span><br></pre></td></tr></table></figure><p><img src="/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/gd_path_2d.gif" alt="2D 二次函数上的梯度下降轨迹（GIF）"></p><h2 id="为什么深度网络更难：曲率在训练中会变"><a class="header-anchor" href="#为什么深度网络更难：曲率在训练中会变">¶</a>为什么深度网络更难：曲率在训练中会变</h2><p>真实神经网络不是二次函数，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container> 会随训练变化；更麻烦的是：</p><ul><li>梯度是随机的（mini-batch）；</li><li>不同层/不同参数的“有效尺度”差异巨大；</li><li>还会有动量、归一化、权重衰减、裁剪等“附加物理”。</li></ul><p>所以现代训练几乎不会只用一个常数学习率跑到底，而是用<strong>学习率调度（schedule）</strong>：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.89ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 835.3 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> 随时间变化。</p><h2 id="更进一步：-L-光滑（L-smooth）告诉你“学习率上限”从哪来"><a class="header-anchor" href="#更进一步：-L-光滑（L-smooth）告诉你“学习率上限”从哪来">¶</a>更进一步：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container>-光滑（L-smooth）告诉你“学习率上限”从哪来</h2><p>上面的二次函数例子有个隐藏前提：曲率 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container> 固定不变。更一般地，优化里常见一个假设叫 <strong><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container>-光滑</strong>：</p><blockquote><p>梯度不会变化得太快（损失曲线不会突然“折成直角”）。</p></blockquote><p>一种常见表述是：对任意 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="3.409ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 1506.7 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(572,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(1016.7,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container>，有</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="27.189ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 12017.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(1111,0)"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mo" transform="translate(1661,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2050,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(2622,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(3233.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(4233.4,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(5066.4,0)"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mo" transform="translate(5616.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(6005.4,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(6495.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(6884.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mo" transform="translate(7440.2,0)"><path data-c="2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"/></g><g data-mml-node="mi" transform="translate(8496,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(9177,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(9455,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(10249.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(11249.4,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(11739.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g></g></g></svg></mjx-container></p><p>这意味着“局部曲率”不会超过某个上界 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container>（你可以把 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container> 理解为“最陡的最大程度”）。在这种情况下，梯度下降取</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="10.826ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 4785.1 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(310.5,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><rect width="881" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p>通常就能保证每步不至于把损失抬高（直观上是“别一步跨太大”）。</p><p><strong>类比</strong>：你在一个城市里开车，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container> 像“这座城市里最陡的下坡路的坡度上限”。如果你把油门踩到超过这个城市道路条件能承受的程度，你迟早会在某个最陡路段失控。</p><h2 id="强凸（strongly-convex）与“为什么后期需要降低学习率”"><a class="header-anchor" href="#强凸（strongly-convex）与“为什么后期需要降低学习率”">¶</a>强凸（strongly convex）与“为什么后期需要降低学习率”</h2><p>如果函数在最优点附近像一个“碗”，并且碗的曲率不会太小（<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.364ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 603 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D707" d="M58 -216Q44 -216 34 -208T23 -186Q23 -176 96 116T173 414Q186 442 219 442Q231 441 239 435T249 423T251 413Q251 401 220 279T187 142Q185 131 185 107V99Q185 26 252 26Q261 26 270 27T287 31T302 38T315 45T327 55T338 65T348 77T356 88T365 100L372 110L408 253Q444 395 448 404Q461 431 491 431Q504 431 512 424T523 412T525 402L449 84Q448 79 448 68Q448 43 455 35T476 26Q485 27 496 35Q517 55 537 131Q543 151 547 152Q549 153 557 153H561Q580 153 580 144Q580 138 575 117T555 63T523 13Q510 0 491 -8Q483 -10 467 -10Q446 -10 429 -4T402 11T385 29T376 44T374 51L368 45Q362 39 350 30T324 12T288 -4T246 -11Q199 -11 153 12L129 -85Q108 -167 104 -180T92 -202Q76 -216 58 -216Z"/></g></g></g></svg></mjx-container>-强凸），那么会有更快的收敛性质。你可以把这理解成：</p><ul><li>碗太浅：你靠近最低点后，坡度很小，继续用大步长会来回晃；</li><li>碗够“硬”：你能更快被拉回最低点附近。</li></ul><p>很多理论告诉我们：在随机梯度（有噪声）下，学习率通常需要逐步变小，才能把“最后那点抖动”压下去。这就是 schedule 后期 decay/cooldown 的一个根源：<strong>让你从“探索”切换到“精修”。</strong></p><h2 id="一维二次函数里“稳定-临界-发散”长什么样"><a class="header-anchor" href="#一维二次函数里“稳定-临界-发散”长什么样">¶</a>一维二次函数里“稳定 / 临界 / 发散”长什么样</h2><p>用 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.781ex;" xmlns="http://www.w3.org/2000/svg" width="12.42ex" height="2.737ex" role="img" focusable="false" viewbox="0 -864.9 5489.7 1209.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2205.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(3261.6,0)"><g data-mml-node="mn" transform="translate(220,394) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-345) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="553.6" height="60" x="120" y="220"/></g><g data-mml-node="mi" transform="translate(4055.1,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="msup" transform="translate(4584.1,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mn" transform="translate(502,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g></g></g></svg></mjx-container> 这个最简单模型，你可以用一小段代码亲眼看到：</p><ul><li><strong>稳定</strong>：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.797ex;" xmlns="http://www.w3.org/2000/svg" width="10.132ex" height="2.753ex" role="img" focusable="false" viewbox="0 -864.9 4478.2 1217"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(230.3,394) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-345) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="574.1" height="60" x="120" y="220"/></g></g></g></svg></mjx-container>，参数与 loss 都会快速衰减；\</li><li><strong>临界</strong>：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.797ex;" xmlns="http://www.w3.org/2000/svg" width="5.983ex" height="2.753ex" role="img" focusable="false" viewbox="0 -864.9 2644.6 1217"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(774.8,0)"><path data-c="2248" d="M55 319Q55 360 72 393T114 444T163 472T205 482Q207 482 213 482T223 483Q262 483 296 468T393 413L443 381Q502 346 553 346Q609 346 649 375T694 454Q694 465 698 474T708 483Q722 483 722 452Q722 386 675 338T555 289Q514 289 468 310T388 357T308 404T224 426Q164 426 125 393T83 318Q81 289 69 289Q55 289 55 319ZM55 85Q55 126 72 159T114 210T163 238T205 248Q207 248 213 248T223 249Q262 249 296 234T393 179L443 147Q502 112 553 112Q609 112 649 141T694 220Q694 249 708 249T722 217Q722 153 675 104T555 55Q514 55 468 76T388 123T308 170T224 192Q164 192 125 159T83 84Q80 55 69 55Q55 55 55 85Z"/></g><g data-mml-node="mfrac" transform="translate(1830.6,0)"><g data-mml-node="mn" transform="translate(230.3,394) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-345) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="574.1" height="60" x="120" y="220"/></g></g></g></svg></mjx-container>，会在谷底两侧来回“弹跳”，loss 降得很慢；\</li><li><strong>发散</strong>：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.797ex;" xmlns="http://www.w3.org/2000/svg" width="5.983ex" height="2.753ex" role="img" focusable="false" viewbox="0 -864.9 2644.6 1217"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(774.8,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"/></g><g data-mml-node="mfrac" transform="translate(1830.6,0)"><g data-mml-node="mn" transform="translate(230.3,394) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-345) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="574.1" height="60" x="120" y="220"/></g></g></g></svg></mjx-container>，振幅越来越大，loss 直接爆炸。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = <span class="number">4.0</span></span><br><span class="line">steps = <span class="number">60</span></span><br><span class="line">theta0 = <span class="number">2.0</span></span><br><span class="line">etas = [<span class="number">0.3</span>, <span class="number">2.0</span> / a, <span class="number">0.7</span>]  <span class="comment"># stable / borderline / unstable</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">eta: <span class="built_in">float</span></span>):</span><br><span class="line">    theta = theta0</span><br><span class="line">    thetas, losses = [], []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(steps):</span><br><span class="line">        g = a * theta</span><br><span class="line">        theta = theta - eta * g</span><br><span class="line">        thetas.append(theta)</span><br><span class="line">        losses.append(<span class="number">0.5</span> * a * theta * theta)</span><br><span class="line">    <span class="keyword">return</span> np.array(thetas), np.array(losses)</span><br><span class="line"></span><br><span class="line">ths1, l1 = run(etas[<span class="number">0</span>])</span><br><span class="line">ths2, l2 = run(etas[<span class="number">1</span>])</span><br><span class="line">ths3, l3 = run(etas[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">9</span>, <span class="number">4.5</span>), dpi=<span class="number">160</span>)</span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">plt.plot(ths1, label=<span class="string">f"stable eta=<span class="subst">{etas[<span class="number">0</span>]:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line">plt.plot(ths2, label=<span class="string">f"borderline eta=<span class="subst">{etas[<span class="number">1</span>]:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line">plt.plot(ths3, label=<span class="string">f"unstable eta=<span class="subst">{etas[<span class="number">2</span>]:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line">plt.title(<span class="string">"Parameter trajectory $\\theta_t$"</span>)</span><br><span class="line">plt.xlabel(<span class="string">"step"</span>)</span><br><span class="line">plt.ylabel(<span class="string">"$\\theta$"</span>)</span><br><span class="line">plt.legend(frameon=<span class="literal">False</span>, fontsize=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">plt.semilogy(l1 + <span class="number">1e-18</span>, label=<span class="string">"stable"</span>)</span><br><span class="line">plt.semilogy(l2 + <span class="number">1e-18</span>, label=<span class="string">"borderline"</span>)</span><br><span class="line">plt.semilogy(l3 + <span class="number">1e-18</span>, label=<span class="string">"unstable"</span>)</span><br><span class="line">plt.title(<span class="string">"Loss trajectory (log scale)"</span>)</span><br><span class="line">plt.xlabel(<span class="string">"step"</span>)</span><br><span class="line">plt.ylabel(<span class="string">"$L(\\theta)$"</span>)</span><br><span class="line">plt.legend(frameon=<span class="literal">False</span>, fontsize=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.savefig(<span class="string">"gd_stability_1d.png"</span>)</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><p><img src="/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/gd_stability_1d.png" alt="一维二次函数：学习率太大为什么会炸"></p><hr><h1>学习率与“噪声”：为什么 batch size 会影响学习率</h1><h2 id="随机梯度的两张脸：方向有用，噪声也很大"><a class="header-anchor" href="#随机梯度的两张脸：方向有用，噪声也很大">¶</a>随机梯度的两张脸：方向有用，噪声也很大</h2><p>mini-batch 梯度可以看成：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="16.395ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 7246.8 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1093,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(2148.8,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(2981.8,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3662.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(4051.8,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4859.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(5470.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(6470.5,0)"><g data-mml-node="mi"><path data-c="1D709" d="M268 632Q268 704 296 704Q314 704 314 687Q314 682 311 664T308 635T309 620V616H315Q342 619 360 619Q443 619 443 586Q439 548 358 546H344Q326 546 317 549T290 566Q257 550 226 505T195 405Q195 381 201 364T211 342T218 337Q266 347 298 347Q375 347 375 314Q374 297 359 288T327 277T280 275Q234 275 208 283L195 286Q149 260 119 214T88 130Q88 116 90 108Q101 79 129 63T229 20Q238 17 243 15Q337 -21 354 -33Q383 -53 383 -94Q383 -137 351 -171T273 -205Q240 -205 202 -190T158 -167Q156 -163 156 -159Q156 -151 161 -146T176 -140Q182 -140 189 -143Q232 -168 274 -168Q286 -168 292 -165Q313 -151 313 -129Q313 -112 301 -104T232 -75Q214 -68 204 -64Q198 -62 171 -52T136 -38T107 -24T78 -8T56 12T36 37T26 66T21 103Q21 149 55 206T145 301L154 307L148 313Q141 319 136 323T124 338T111 358T103 382T99 413Q99 471 143 524T259 602L271 607Q268 618 268 632Z"/></g><g data-mml-node="mi" transform="translate(471,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>其中 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.756ex" height="2.057ex" role="img" focusable="false" viewbox="0 -704 776.3 909"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D709" d="M268 632Q268 704 296 704Q314 704 314 687Q314 682 311 664T308 635T309 620V616H315Q342 619 360 619Q443 619 443 586Q439 548 358 546H344Q326 546 317 549T290 566Q257 550 226 505T195 405Q195 381 201 364T211 342T218 337Q266 347 298 347Q375 347 375 314Q374 297 359 288T327 277T280 275Q234 275 208 283L195 286Q149 260 119 214T88 130Q88 116 90 108Q101 79 129 63T229 20Q238 17 243 15Q337 -21 354 -33Q383 -53 383 -94Q383 -137 351 -171T273 -205Q240 -205 202 -190T158 -167Q156 -163 156 -159Q156 -151 161 -146T176 -140Q182 -140 189 -143Q232 -168 274 -168Q286 -168 292 -165Q313 -151 313 -129Q313 -112 301 -104T232 -75Q214 -68 204 -64Q198 -62 171 -52T136 -38T107 -24T78 -8T56 12T36 37T26 66T21 103Q21 149 55 206T145 301L154 307L148 313Q141 319 136 323T124 338T111 358T103 382T99 413Q99 471 143 524T259 602L271 607Q268 618 268 632Z"/></g><g data-mml-node="mi" transform="translate(471,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> 是噪声（随机性）。这件事带来两种效应：</p><ul><li>好处：噪声让你不容易困在“很尖的坏坑”，像在地形里加了点抖动；</li><li>坏处：噪声让大步长更容易“抖飞”，训练不稳定。</li></ul><p><strong>类比</strong>：你蒙眼下山，手里拿指南针（梯度方向），但指南针会抖（噪声）。你走得越快（学习率大），抖动造成的偏差越大。</p><h2 id="经典经验：线性缩放法则与-warmup（大-batch-训练）"><a class="header-anchor" href="#经典经验：线性缩放法则与-warmup（大-batch-训练）">¶</a>经典经验：线性缩放法则与 warmup（大 batch 训练）</h2><p>很多设置里，增大 batch size 可以减少梯度噪声，因此人们常用经验：</p><ul><li>batch 变大 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container> 倍，学习率也乘 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container>（线性缩放）；</li><li>但训练初期“系统还没稳定”，所以先用 warmup 把学习率从小慢慢升到目标值。</li></ul><p>warmup 的典型形式（线性 warmup）：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.909ex;" xmlns="http://www.w3.org/2000/svg" width="31.539ex" height="4.855ex" role="img" focusable="false" viewbox="0 -1302 13940.1 2145.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(278,0)"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(834,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1112,0)"/></g></g></g><g data-mml-node="mo" transform="translate(4032.4,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(5032.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(5421.6,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(389,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(889,0)"/><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(1281,0)"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1781,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2225,0)"/></g></g></g><g data-mml-node="mo" transform="translate(8072.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9072.5,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(278,0)"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(834,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1112,0)"/></g></g></g><g data-mml-node="mo" transform="translate(10713.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mfrac" transform="translate(11102.8,0)"><g data-mml-node="mi" transform="translate(1238.1,676)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="msub" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(722,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1222,0)"/><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1614,0)"/></g></g></g><rect width="2597.3" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p>近年的研究进一步解释了 warmup 的作用：它往往不是“为了收集 Adam 的统计量”这么简单，而是<strong>帮助模型进入更“好条件”的区域，从而能承受更大的目标学习率</strong>（见后文“最新进展”部分）。</p><hr><h1>动量：学习率的“隐形放大器”</h1><h2 id="SGD-Momentum-的更新与直觉"><a class="header-anchor" href="#SGD-Momentum-的更新与直觉">¶</a>SGD + Momentum 的更新与直觉</h2><p>动量（以经典形式为例）：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="32.413ex" height="2.084ex" role="img" focusable="false" viewbox="0 -705 14326.6 921"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1101,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(2156.8,0)"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="msub" transform="translate(2722.8,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="TeXAtom" transform="translate(518,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(4672,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(5672.2,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(6487.5,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(6765.5,0)"><g data-mml-node="mspace"/></g><g data-mml-node="msub" transform="translate(7932.1,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(9920.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(10976.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(12006.1,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(13006.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msub" transform="translate(13503.4,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>其中 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.075ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4011.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mo" transform="translate(843.8,0)"><path data-c="2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"/></g><g data-mml-node="mo" transform="translate(1788.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(2177.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(2677.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(3122.2,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(3622.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> 常取 0.9。</p><p><strong>类比</strong>：你推一个很重的购物车下坡：</p><ul><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.844ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 815.3 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> 是你当下看到的坡度；</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="1.863ex" height="1.359ex" role="img" focusable="false" viewbox="0 -443 823.3 600.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> 是车的速度（带惯性）；</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.281ex" height="2.034ex" role="img" focusable="false" viewbox="0 -705 566 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g></g></g></svg></mjx-container> 越大，车越“刹不住”，但也越能穿过小坑洼；</li><li>学习率 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 相当于“你给速度换算成位移的比例”。</li></ul><h2 id="为什么动量会让你更容易“过冲”"><a class="header-anchor" href="#为什么动量会让你更容易“过冲”">¶</a>为什么动量会让你更容易“过冲”</h2><p>直觉上，动量会把一段时间内的梯度方向叠加起来，相当于“长期沿一个方向加速”。因此：</p><ul><li>同样的 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container>，加动量后等效步长更大；</li><li>所以很多时候 <strong>SGD+momentum 的可用学习率上限会更低</strong>，否则会更容易震荡。</li></ul><p>这也是为什么一些训练 recipe 会写：</p><ul><li>SGD 的 base LR 比 AdamW 大；</li><li>但 SGD + momentum 需要更谨慎的 warmup/decay；</li><li>或者配合更强的正则化（weight decay、label smoothing 等）稳住。</li></ul><hr><h1>自适应优化器：学习率“变成一组学习率”</h1><p>如果说 SGD 的学习率是一把锤子（全局同一个 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container>），那么 Adam 类方法像是一套“带扭矩控制的电动螺丝刀”：不同参数会自动用不同的步长。</p><h2 id="Adam-的核心公式（一定要看懂）"><a class="header-anchor" href="#Adam-的核心公式（一定要看懂）">¶</a>Adam 的核心公式（一定要看懂）</h2><p>Adam（省略一些细节，只保留关键结构）：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="25.369ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 11213 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1494,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2549.8,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="msub" transform="translate(3552.4,0)"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(911,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(5894.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(6894.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(7283.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(8006,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9006.2,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="mo" transform="translate(10008.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msub" transform="translate(10397.8,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.625ex;" xmlns="http://www.w3.org/2000/svg" width="25.058ex" height="2.625ex" role="img" focusable="false" viewbox="0 -883.9 11075.4 1160"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1101,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2156.8,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="msub" transform="translate(3159.4,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="TeXAtom" transform="translate(518,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(5108.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(6108.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(6497.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(7220,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(8220.2,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(9222.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msubsup" transform="translate(9611.8,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="TeXAtom" transform="translate(510,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2299" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM682 250Q682 322 649 387T546 497T381 542Q272 542 184 459T95 250Q95 132 178 45T389 -42Q515 -42 598 45T682 250ZM311 250Q311 285 332 304T375 328Q376 328 382 328T392 329Q424 326 445 305T466 250Q466 217 445 195T389 172Q354 172 333 195T311 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mi" transform="translate(510,-268.3) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.76ex;" xmlns="http://www.w3.org/2000/svg" width="21.455ex" height="6.122ex" role="img" focusable="false" viewbox="0 -1486 9482.9 2706"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(5074.2,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mfrac" transform="translate(5571.2,0)"><g data-mml-node="msub" transform="translate(1347.7,676)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(439,16) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mrow" transform="translate(220,-1014.1)"><g data-mml-node="msqrt"><g transform="translate(1020,0)"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g><g data-mml-node="mo" transform="translate(0,144.1)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="823.3" height="60" x="1020" y="934.1"/></g><g data-mml-node="mo" transform="translate(2065.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(3065.7,0)"><path data-c="1D716" d="M227 -11Q149 -11 95 41T40 174Q40 262 87 322Q121 367 173 396T287 430Q289 431 329 431H367Q382 426 382 411Q382 385 341 385H325H312Q191 385 154 277L150 265H327Q340 256 340 246Q340 228 320 219H138V217Q128 187 128 143Q128 77 160 52T231 26Q258 26 284 36T326 57T343 68Q350 68 354 58T358 39Q358 36 357 35Q354 31 337 21T289 0T227 -11Z"/></g></g><rect width="3671.7" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p>其中 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.626ex;" xmlns="http://www.w3.org/2000/svg" width="3.311ex" height="2.625ex" role="img" focusable="false" viewbox="0 -883.2 1463.7 1160"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="TeXAtom" transform="translate(510,412.3) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2299" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM682 250Q682 322 649 387T546 497T381 542Q272 542 184 459T95 250Q95 132 178 45T389 -42Q515 -42 598 45T682 250ZM311 250Q311 285 332 304T375 328Q376 328 382 328T392 329Q424 326 445 305T466 250Q466 217 445 195T389 172Q354 172 333 195T311 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mi" transform="translate(510,-269) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> 表示逐元素平方；<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="5.62ex" height="2.274ex" role="img" focusable="false" viewbox="0 -811 2484.2 1005"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(439,16) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1216.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="msub" transform="translate(1660.9,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> 是偏置修正后的估计。</p><p>你应该抓住一句话：</p><blockquote><p><strong>Adam 的“有效学习率”大致是 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.87ex" height="2.95ex" role="img" focusable="false" viewbox="0 -1054.1 5246.7 1304.1"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(497,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mo" transform="translate(997,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msqrt" transform="translate(1386,0)"><g transform="translate(1020,0)"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g><g data-mml-node="mo" transform="translate(0,144.1)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="823.3" height="60" x="1020" y="934.1"/></g><g data-mml-node="mo" transform="translate(3451.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(4451.7,0)"><path data-c="1D716" d="M227 -11Q149 -11 95 41T40 174Q40 262 87 322Q121 367 173 396T287 430Q289 431 329 431H367Q382 426 382 411Q382 385 341 385H325H312Q191 385 154 277L150 265H327Q340 256 340 246Q340 228 320 219H138V217Q128 187 128 143Q128 77 160 52T231 26Q258 26 284 36T326 57T343 68Q350 68 354 58T358 39Q358 36 357 35Q354 31 337 21T289 0T227 -11Z"/></g><g data-mml-node="mo" transform="translate(4857.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></strong>，所以每个参数的步长会随其梯度尺度自动缩放。</p></blockquote><p><strong>类比</strong>：同一辆车在不同路面（不同参数维度）行驶。路面越颠（梯度方差越大），系统自动把那一侧轮子的扭矩（步长）调小，避免打滑。</p><h2 id="为什么-Adam-仍然需要-warmup（而且经常更需要）"><a class="header-anchor" href="#为什么-Adam-仍然需要-warmup（而且经常更需要）">¶</a>为什么 Adam 仍然需要 warmup（而且经常更需要）</h2><p>很多人以为：Adam 都自适应了，为什么还要 warmup？</p><p>一个关键原因：<strong>训练初期的统计量不稳定 + 某些方向的“预条件化曲率”很大</strong>，导致你如果一上来就用目标学习率，容易出现大幅抖动（loss spike）甚至训练失败。</p><p>这也是近年关于 warmup 的理论解释里经常出现的关键词：<strong>sharpness / preconditioned sharpness</strong>（可理解为“有效曲率”）。</p><hr><h1>学习率调度（schedule）大全：从老办法到大模型默认</h1><p>把 schedule 看成“训练过程的配速策略”：</p><ul><li>前期：探索更大范围（跑得快）</li><li>中期：稳定推进（匀速）</li><li>后期：精细收敛（减速、微调）</li></ul><p>先看一张“最常用曲线”对比图（同样由 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="24.434ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 10800 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="merror" data-mjx-error="'_' allowed only in math mode" title="'_' allowed only in math mode"><rect data-background="true" width="10800" height="950" y="-200"/><title>'_' allowed only in math mode</title><g data-mml-node="mtext" style="font-family: serif;"><text data-variant="-explicitFont" transform="scale(1,-1)" font-size="884px">\texttt{lr_viz.py}</text></g></g></g></g></svg></mjx-container> 生成）：</p><p><img src="/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/lr_schedules.png" alt="三种常见学习率曲线：Constant / Warmup+Cosine / WSD"></p><h2 id="常数学习率（Constant）"><a class="header-anchor" href="#常数学习率（Constant）">¶</a>常数学习率（Constant）</h2><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="7.019ex" height="1.808ex" role="img" focusable="false" viewbox="0 -583 3102.4 799"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(530,-150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g></g></svg></mjx-container></p><p>优点：简单。</p><p>缺点：几乎总会在“速度 vs 稳定”之间两难：要么前期太慢，要么后期太抖。</p><h2 id="Step-decay（台阶式）"><a class="header-anchor" href="#Step-decay（台阶式）">¶</a>Step decay（台阶式）</h2><p>例如每到某些 epoch 乘以 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.229ex" height="1.486ex" role="img" focusable="false" viewbox="0 -441 543 657"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g></g></g></svg></mjx-container>：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.288ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 8525.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(774.8,0)"><path data-c="2190" d="M944 261T944 250T929 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270H929Q944 261 944 250Z"/></g><g data-mml-node="mi" transform="translate(2052.6,0)"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g><g data-mml-node="mi" transform="translate(2595.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(3092.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(3370.6,0)"><g data-mml-node="mspace"/></g><g data-mml-node="mi" transform="translate(4537.2,0)"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g><g data-mml-node="mo" transform="translate(5358,0)"><path data-c="2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"/></g><g data-mml-node="mo" transform="translate(6302.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(6691.8,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(7191.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(7636.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(8136.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></p><p>类比：跑步时每过一段路程突然把速度降一档。</p><p>优点：实现简单。</p><p>缺点：变化不平滑，可能造成训练指标突然波动。</p><h2 id="Exponential-decay（指数衰减）"><a class="header-anchor" href="#Exponential-decay（指数衰减）">¶</a>Exponential decay（指数衰减）</h2><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="10.763ex" height="2.425ex" role="img" focusable="false" viewbox="0 -855.6 4757.3 1071.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(530,-150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g><g data-mml-node="mo" transform="translate(3324.6,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/></g><g data-mml-node="msup" transform="translate(3824.8,0)"><g data-mml-node="mi"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g><g data-mml-node="mi" transform="translate(627.3,413) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>优点：平滑。</p><p>缺点：后期可能衰得太快，等效“刹车过早”，尤其在长训练中。</p><h2 id="Cosine-decay（余弦退火，深度学习最常用之一）"><a class="header-anchor" href="#Cosine-decay（余弦退火，深度学习最常用之一）">¶</a>Cosine decay（余弦退火，深度学习最常用之一）</h2><p>（最常见版本：从峰值衰到一个最小值）</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.148ex;" xmlns="http://www.w3.org/2000/svg" width="44.789ex" height="5.428ex" role="img" focusable="false" viewbox="0 -1449.5 19796.9 2399"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(4149.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mfrac" transform="translate(5150,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(6090,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(6479,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(8597.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9597.4,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(11356.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mrow" transform="translate(11911.8,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mn" transform="translate(736,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1458.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(2458.4,0)"><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"/><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(444,0)"/><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(944,0)"/></g><g data-mml-node="mo" transform="translate(3796.4,0)"><path data-c="2061" d=""/></g><g data-mml-node="mrow" transform="translate(3963.1,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mi" transform="translate(736,0)"><path data-c="1D70B" d="M132 -11Q98 -11 98 22V33L111 61Q186 219 220 334L228 358H196Q158 358 142 355T103 336Q92 329 81 318T62 297T53 285Q51 284 38 284Q19 284 19 294Q19 300 38 329T93 391T164 429Q171 431 389 431Q549 431 553 430Q573 423 573 402Q573 371 541 360Q535 358 472 358H408L405 341Q393 269 393 222Q393 170 402 129T421 65T431 37Q431 20 417 5T381 -10Q370 -10 363 -7T347 17T331 77Q330 86 330 121Q330 170 339 226T357 318T367 358H269L268 354Q268 351 249 275T206 114T175 17Q164 -11 132 -11Z"/></g><g data-mml-node="mfrac" transform="translate(1306,0)"><g data-mml-node="mi" transform="translate(391.5,676)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><rect width="904" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(2450,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g><g data-mml-node="mo" transform="translate(7149.1,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g></g></g></svg></mjx-container></p><p><strong>直觉</strong>：一开始减速慢（保持探索），后面减速快（冲向收敛）。</p><p>大模型训练中常见结构是：</p><ul><li>warmup：线性升到 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></li><li>cosine：从 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container> 退到 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="3.979ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1758.7 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g></g></g></svg></mjx-container></li></ul><h2 id="Cosine-warm-restarts（SGDR）"><a class="header-anchor" href="#Cosine-warm-restarts（SGDR）">¶</a>Cosine warm restarts（SGDR）</h2><p>余弦衰到低点后又“重启”到高学习率，再衰一次。</p><p>直觉：像周期性“冲坡”，有时能跳出局部坏盆地。</p><p>在现代大模型预训练中，<strong>不如纯一次性 cosine / WSD 常见</strong>，但在一些中小模型与某些任务上仍有价值。</p><h2 id="One-cycle（超级收敛思想）"><a class="header-anchor" href="#One-cycle（超级收敛思想）">¶</a>One-cycle（超级收敛思想）</h2><p>核心：学习率先升后降（并配合动量反向变化）。</p><p>直觉：前期把学习率推到接近稳定边界，加速探索；后期快速降下来收敛。</p><p>很适合“训练步数较短、希望快速到一个不错解”的场景。</p><h2 id="逆平方根（Transformer-经典-schedule）"><a class="header-anchor" href="#逆平方根（Transformer-经典-schedule）">¶</a>逆平方根（Transformer 经典 schedule）</h2><p>在 Transformer 早期训练 recipe 中很常见的一类形式（示意）：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.469ex;" xmlns="http://www.w3.org/2000/svg" width="25.414ex" height="4.07ex" role="img" focusable="false" viewbox="0 -1149.5 11233.2 1799"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="221D" d="M56 124T56 216T107 375T238 442Q260 442 280 438T319 425T352 407T382 385T406 361T427 336T442 315T455 297T462 285L469 297Q555 442 679 442Q687 442 722 437V398H718Q710 400 694 400Q657 400 623 383T567 343T527 294T503 253T495 235Q495 231 520 192T554 143Q625 44 696 44Q717 44 719 46H722V-5Q695 -11 678 -11Q552 -11 457 141Q455 145 454 146L447 134Q362 -11 235 -11Q157 -11 107 56ZM93 213Q93 143 126 87T220 31Q258 31 292 48T349 88T389 137T413 178T421 196Q421 200 396 239T362 288Q322 345 288 366T213 387Q163 387 128 337T93 213Z"/></g><g data-mml-node="mo" transform="translate(2168.8,0)"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g><g data-mml-node="mrow" transform="translate(4002.5,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M180 96T180 250T205 541T266 770T353 944T444 1069T527 1150H555Q561 1144 561 1141Q561 1137 545 1120T504 1072T447 995T386 878T330 721T288 513T272 251Q272 133 280 56Q293 -87 326 -209T399 -405T475 -531T536 -609T561 -640Q561 -643 555 -649H527Q483 -612 443 -568T353 -443T266 -270T205 -41Z"/></g><g data-mml-node="msup" transform="translate(597,0)"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="TeXAtom" transform="translate(394,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1278,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mn" transform="translate(1778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g></g><g data-mml-node="mo" transform="translate(2651.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(3096.5,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(3679.7,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/></g><g data-mml-node="msubsup" transform="translate(4179.9,0)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><g data-mml-node="TeXAtom" transform="translate(793,530.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1278,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mn" transform="translate(1778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="TeXAtom" transform="translate(617,-143.2) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(722,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1222,0)"/><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1614,0)"/></g></g></g><g data-mml-node="mo" transform="translate(6633.7,0) translate(0 -0.5)"><path data-c="29" d="M35 1138Q35 1150 51 1150H56H69Q113 1113 153 1069T243 944T330 771T391 541T416 250T391 -40T330 -270T243 -443T152 -568T69 -649H56Q43 -649 39 -647T35 -637Q65 -607 110 -548Q283 -316 316 56Q324 133 324 251Q324 368 316 445Q278 877 48 1123Q36 1137 35 1138Z"/></g></g></g></g></svg></mjx-container></p><p>直觉：warmup 后开始按 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="4.649ex" height="2.046ex" role="img" focusable="false" viewbox="0 -893.3 2054.8 904.3"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="TeXAtom" transform="translate(394,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1278,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mn" transform="translate(1778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g></g></g></g></svg></mjx-container> 缓慢衰减。</p><p>这类 schedule 的精神是：<strong>长期训练别衰太快</strong>。</p><h2 id="WSD（Warmup–Stable–Decay）：近年大模型训练的重要趋势"><a class="header-anchor" href="#WSD（Warmup–Stable–Decay）：近年大模型训练的重要趋势">¶</a>WSD（Warmup–Stable–Decay）：近年大模型训练的重要趋势</h2><p>WSD 的核心形状：</p><ul><li>warmup：上升</li><li>stable：长时间保持常数学习率</li><li>decay/cooldown：最后线性（或其他形式）降到很小</li></ul><p>直觉：中段“匀速巡航”，最后“进站刹车”。</p><p>为什么它近年很受欢迎？</p><ul><li>它比 cosine 更“可复用”：你可以先训练一段稳定期，后面想延长训练时不必从头设计一个依赖总步数的半周期 cosine。</li><li>很多工作观察到 cooldown 开始时损失会出现“明显下降”，像模型终于被允许“精细贴合”盆地。</li></ul><p>（后文会结合 2025 的理论解释更详细讲。）</p><hr><h1>从“能跑”到“跑得好”：一套可操作的学习率调参流程</h1><p>下面给一套你可以在绝大多数任务里复用的流程（从小白视角写，但足够深）。</p><h2 id="先搞清楚：你训练失败到底是哪种失败？"><a class="header-anchor" href="#先搞清楚：你训练失败到底是哪种失败？">¶</a>先搞清楚：你训练失败到底是哪种失败？</h2><p>训练“坏掉”常见有三类：</p><ol><li><strong>直接发散</strong>：loss 变成 NaN/inf，或者几步内冲天。</li><li><strong>抖动不收敛</strong>：loss 在高位大幅波动，指标上不去。</li><li><strong>看似稳定但学不动</strong>：loss 缓慢下降甚至平台期很早出现。</li></ol><p>对应的学习率结论通常是：</p><ul><li>(1)(2)：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 太大（或动量太大、或缺少 warmup、或裁剪/正则不够）</li><li>(3)：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 太小（或 schedule 衰减太快、或 batch 太小噪声太大）</li></ul><h2 id="用-“LR-range-test”-快速找可行区间（强烈推荐）"><a class="header-anchor" href="#用-“LR-range-test”-快速找可行区间（强烈推荐）">¶</a>用 “LR range test” 快速找可行区间（强烈推荐）</h2><p>经典做法：在很短的训练里，让学习率从很小指数增长到很大，观察 loss 什么时候开始明显上升/发散。</p><p>直觉：你在“试探油门”，找到“刚好不翻车”的上限。</p><p>简化版伪代码（PyTorch）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lr_range_test</span>(<span class="params">model, loader, loss_fn, optimizer, lr_min=<span class="number">1e-7</span>, lr_max=<span class="number">10</span>, num_steps=<span class="number">200</span></span>):</span><br><span class="line">    model.train()</span><br><span class="line">    <span class="comment"># 指数增长</span></span><br><span class="line">    mult = (lr_max / lr_min) ** (<span class="number">1</span> / (num_steps - <span class="number">1</span>))</span><br><span class="line">    lr = lr_min</span><br><span class="line">    <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">        g[<span class="string">"lr"</span>] = lr</span><br><span class="line"></span><br><span class="line">    losses = []</span><br><span class="line">    lrs = []</span><br><span class="line">    it = <span class="built_in">iter</span>(loader)</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(num_steps):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            x, y = <span class="built_in">next</span>(it)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            it = <span class="built_in">iter</span>(loader)</span><br><span class="line">            x, y = <span class="built_in">next</span>(it)</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        pred = model(x)</span><br><span class="line">        loss = loss_fn(pred, y)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        losses.append(loss.item())</span><br><span class="line">        lrs.append(lr)</span><br><span class="line"></span><br><span class="line">        lr *= mult</span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            g[<span class="string">"lr"</span>] = lr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lrs, losses</span><br></pre></td></tr></table></figure><p>你会得到一个曲线：</p><ul><li>初期 loss 下降（学习开始）</li><li>到某个点开始抖动甚至上升（接近稳定边界）</li></ul><p>经验：把“刚开始明显变差前”的学习率当作 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container> 的量级，然后正式训练用它的 0.3～1 倍（按任务调整）。</p><h2 id="选择-schedule：小模型-vs-大模型的经验差异"><a class="header-anchor" href="#选择-schedule：小模型-vs-大模型的经验差异">¶</a>选择 schedule：小模型 vs 大模型的经验差异</h2><ul><li><strong>中小模型（训练步数不算特别长）</strong>：cosine / one-cycle 往往很稳妥。</li><li><strong>大模型预训练（训练极长、可能要多次续训）</strong>：WSD 或 schedule-free 值得优先考虑。</li></ul><p>一个很实用的默认（尤其是 AdamW）：</p><ul><li>warmup：1%～5% steps（大 batch 或很深模型倾向更长）</li><li>stable：大部分训练保持 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></li><li>cooldown：最后 10%～20% steps 线性降到 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="3.979ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1758.7 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g></g></g></svg></mjx-container>（比如 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container> 的 0.1 倍或更小）</li></ul><h2 id="“学习率、batch、权重衰减”三者要一起看"><a class="header-anchor" href="#“学习率、batch、权重衰减”三者要一起看">¶</a>“学习率、batch、权重衰减”三者要一起看</h2><p>很多人只调学习率，然后觉得“怎么总是不稳”。实际上这三者高度耦合：</p><ul><li>batch 影响梯度噪声；</li><li>weight decay 影响参数尺度（等价于持续把参数往 0 拉）；</li><li>学习率决定你每一步“顺着梯度走多远”。</li></ul><p><strong>类比</strong>：你驾驶一辆车：</p><ul><li>learning rate 是油门；</li><li>batch size 是路面摩擦/风噪（稳定性）；</li><li>weight decay 像一直有个刹车在轻踩（让车别越跑越飘）。</li></ul><p>不稳定时不要只想着“降学习率”，很多时候：</p><ul><li>加一点梯度裁剪（clip norm）</li><li>适当加 weight decay</li><li>或者延长 warmup</li></ul><p>会比一味降 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container> 更好，因为降 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container> 往往会牺牲最终效果或训练效率。</p><hr><h1>代码：从零实现常用 schedule（PyTorch）</h1><p>下面给一个“够用且清晰”的实现：warmup + cosine / warmup + WSD（cooldown 线性）。</p><h2 id="Warmup-Cosine"><a class="header-anchor" href="#Warmup-Cosine">¶</a>Warmup + Cosine</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lr_warmup_cosine</span>(<span class="params">step, total_steps, warmup_steps, lr_max, lr_min=<span class="number">0.0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> step &lt; warmup_steps:</span><br><span class="line">        <span class="comment"># 线性 warmup</span></span><br><span class="line">        <span class="keyword">return</span> lr_max * (step + <span class="number">1</span>) / <span class="built_in">max</span>(<span class="number">1</span>, warmup_steps)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># cosine decay</span></span><br><span class="line">    t = step - warmup_steps</span><br><span class="line">    T = <span class="built_in">max</span>(<span class="number">1</span>, total_steps - warmup_steps)</span><br><span class="line">    cos = <span class="number">0.5</span> * (<span class="number">1.0</span> + math.cos(math.pi * t / T))</span><br><span class="line">    <span class="keyword">return</span> lr_min + (lr_max - lr_min) * cos</span><br></pre></td></tr></table></figure><h2 id="Warmup-Stable-Decay（WSD）"><a class="header-anchor" href="#Warmup-Stable-Decay（WSD）">¶</a>Warmup + Stable + Decay（WSD）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lr_wsd</span>(<span class="params">step, total_steps, warmup_steps, cooldown_steps, lr_max, lr_min=<span class="number">0.0</span></span>):</span><br><span class="line">    <span class="comment"># warmup</span></span><br><span class="line">    <span class="keyword">if</span> step &lt; warmup_steps:</span><br><span class="line">        <span class="keyword">return</span> lr_max * (step + <span class="number">1</span>) / <span class="built_in">max</span>(<span class="number">1</span>, warmup_steps)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># stable</span></span><br><span class="line">    stable_end = total_steps - cooldown_steps</span><br><span class="line">    <span class="keyword">if</span> step &lt; stable_end:</span><br><span class="line">        <span class="keyword">return</span> lr_max</span><br><span class="line"></span><br><span class="line">    <span class="comment"># cooldown: 线性衰减到 lr_min</span></span><br><span class="line">    t = step - stable_end</span><br><span class="line">    T = <span class="built_in">max</span>(<span class="number">1</span>, cooldown_steps)</span><br><span class="line">    frac = <span class="built_in">min</span>(<span class="number">1.0</span>, (t + <span class="number">1</span>) / T)</span><br><span class="line">    <span class="keyword">return</span> lr_max + (lr_min - lr_max) * frac</span><br></pre></td></tr></table></figure><h2 id="把它接到-optimizer-上（训练循环骨架）"><a class="header-anchor" href="#把它接到-optimizer-上（训练循环骨架）">¶</a>把它接到 optimizer 上（训练循环骨架）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_one_epoch</span>(<span class="params">model, loader, optimizer, step_offset, total_steps, schedule_fn, device=<span class="string">"cuda"</span></span>):</span><br><span class="line">    model.train()</span><br><span class="line">    step = step_offset</span><br><span class="line">    <span class="keyword">for</span> x, y <span class="keyword">in</span> loader:</span><br><span class="line">        x, y = x.to(device), y.to(device)</span><br><span class="line"></span><br><span class="line">        lr = schedule_fn(step, total_steps)</span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            g[<span class="string">"lr"</span>] = lr</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        pred = model(x)</span><br><span class="line">        loss = torch.nn.functional.cross_entropy(pred, y)</span><br><span class="line">        loss.backward()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 可选：梯度裁剪，常用于大模型稳定性</span></span><br><span class="line">        torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">        optimizer.step()</span><br><span class="line">        step += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> step</span><br></pre></td></tr></table></figure><p>你可以像这样传入 schedule：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">schedule_fn = <span class="keyword">lambda</span> step, total_steps: lr_wsd(</span><br><span class="line">    step=step,</span><br><span class="line">    total_steps=total_steps,</span><br><span class="line">    warmup_steps=<span class="built_in">int</span>(<span class="number">0.02</span> * total_steps),</span><br><span class="line">    cooldown_steps=<span class="built_in">int</span>(<span class="number">0.10</span> * total_steps),</span><br><span class="line">    lr_max=<span class="number">3e-4</span>,</span><br><span class="line">    lr_min=<span class="number">3e-5</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><hr><h1>最新研究进展：大家在“学学习率”什么？</h1><p>如果你把学习率看成“油门曲线”，那么近年的研究大致沿着三条路在推进：</p><ol><li><strong>更好的油门曲线</strong>：cosine 之外，WSD、power-law family、token/batch agnostic schedule。</li><li><strong>把油门交给系统</strong>：schedule-free（不需要指定总步数的 schedule）、甚至 learning-rate-free（让算法自动估计合适步长）。</li><li><strong>解释为什么有效</strong>：warmup、cooldown 的机制解释，稳定边界、曲率/尖锐度（sharpness）视角，和大模型不稳定的预测。</li></ol><p>下面按时间线串起来。</p><h2 id="2023：Learning-rate-free-的代表——D-Adaptation"><a class="header-anchor" href="#2023：Learning-rate-free-的代表——D-Adaptation">¶</a>2023：Learning-rate-free 的代表——D-Adaptation</h2><p>一句话：<strong>尽量不让你手动调 base learning rate</strong>。</p><p>D-Adaptation（2023，Meta）提出用一种理论驱动的方式自动估计步长尺度，使得在很多任务上能接近手调学习率的效果。</p><p>你可以把它理解成：传统方法需要你告诉系统“从起点到终点大概有多远”（步长尺度），而 D-Adaptation 试图在训练过程中估计这个“距离尺度”，从而自动设定合适的步长。</p><p>参考：<a class="link" href="https://ai.meta.com/research/publications/learning-rate-free-learning-by-d-adaptation/">Learning Rate-Free Learning by D-Adaptation (Meta, 2023)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024：Schedule-Free-AdamW（The-Road-Less-Scheduled）"><a class="header-anchor" href="#2024：Schedule-Free-AdamW（The-Road-Less-Scheduled）">¶</a>2024：Schedule-Free AdamW（The Road Less Scheduled）</h2><p>经典痛点：很多 schedule 需要你提前知道总训练步数 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewbox="0 -677 704 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g></g></svg></mjx-container>（例如 cosine 的半周期要对齐训练长度）。但现实中你经常会：</p><ul><li>训练到一半发现还想继续；</li><li>或者想做不同训练预算的对比；</li><li>或者数据/算力不确定。</li></ul><p>Schedule-Free AdamW（2024）提出一种做法：<strong>干脆不显式做 schedule，但性能能与有 schedule 的方法竞争</strong>。</p><p>直觉理解：它把“调度”和“迭代平均”等思想统一起来，让算法在不需要知道停止时间 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewbox="0 -677 704 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g></g></svg></mjx-container> 的情况下，仍能走出类似“先快后慢”的有效轨迹。</p><p>参考：<a class="link" href="https://arxiv.org/abs/2405.15682">Schedule-Free AdamW (arXiv:2405.15682)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024：Why-Warmup-——warmup-机制被更系统地解释"><a class="header-anchor" href="#2024：Why-Warmup-——warmup-机制被更系统地解释">¶</a>2024：Why Warmup?——warmup 机制被更系统地解释</h2><p>2024 的一条重要结论是：warmup 的主要收益往往是<strong>让网络能承受更大的目标学习率</strong>，而不是仅仅“让 Adam 统计量更准”。</p><p>这会改变你调参的思路：</p><ul><li>你不是在问“warmup 要不要”</li><li>而是在问“我希望最终的 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.669ex;" xmlns="http://www.w3.org/2000/svg" width="5.494ex" height="1.669ex" role="img" focusable="false" viewbox="0 -442 2428.4 737.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(389,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(889,0)"/><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(1281,0)"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1781,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2225,0)"/></g></g></g></g></g></svg></mjx-container> 能有多大、稳定边界在哪，warmup 帮我把边界推到哪里”</li></ul><p>参考：<a class="link" href="https://arxiv.org/abs/2406.09405">Why Warmup the Learning Rate? (arXiv:2406.09405)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024：Power-Scheduler——对-batch-size-与-token-数不敏感"><a class="header-anchor" href="#2024：Power-Scheduler——对-batch-size-与-token-数不敏感">¶</a>2024：Power Scheduler——对 batch size 与 token 数不敏感</h2><p>大模型预训练的现实痛点是：你经常会换 batch size、换训练 tokens（预算变化），而最优学习率也会跟着漂移。</p><p>Power Scheduler（2024）发现并利用一种 <strong>学习率、batch size、训练 tokens 的幂律关系</strong>，构建出对 batch/token 更“免调”的调度方式，并强调与 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.364ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 603 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D707" d="M58 -216Q44 -216 34 -208T23 -186Q23 -176 96 116T173 414Q186 442 219 442Q231 441 239 435T249 423T251 413Q251 401 220 279T187 142Q185 131 185 107V99Q185 26 252 26Q261 26 270 27T287 31T302 38T315 45T327 55T338 65T348 77T356 88T365 100L372 110L408 253Q444 395 448 404Q461 431 491 431Q504 431 512 424T523 412T525 402L449 84Q448 79 448 68Q448 43 455 35T476 26Q485 27 496 35Q517 55 537 131Q543 151 547 152Q549 153 557 153H561Q580 153 580 144Q580 138 575 117T555 63T523 13Q510 0 491 -8Q483 -10 467 -10Q446 -10 429 -4T402 11T385 29T376 44T374 51L368 45Q362 39 350 30T324 12T288 -4T246 -11Q199 -11 153 12L129 -85Q108 -167 104 -180T92 -202Q76 -216 58 -216Z"/></g></g></g></svg></mjx-container>P 等参数化结合的可迁移性。</p><p>参考：<a class="link" href="https://arxiv.org/abs/2408.13359">Power Scheduler (arXiv:2408.13359)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2023–2024：用“小模型复现大模型不稳定”——学习率稳定性研究"><a class="header-anchor" href="#2023–2024：用“小模型复现大模型不稳定”——学习率稳定性研究">¶</a>2023–2024：用“小模型复现大模型不稳定”——学习率稳定性研究</h2><p>大模型训练常见“同样超参，小模型没事，大模型炸了”的现象。Wortsman 等工作提出：很多不稳定性其实能在小模型里通过更高学习率复现，从而可以用更低成本研究：</p><ul><li>哪些干预能降低对学习率的敏感性（warmup、weight decay、参数化等）；</li><li>能否在训练早期通过某些信号预测后续不稳定。</li></ul><p>参考：<a class="link" href="https://arxiv.org/abs/2309.14322">Small-scale proxies for large-scale Transformer instabilities (arXiv:2309.14322)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024：No-More-Adam-——把关键放回“学习率尺度”"><a class="header-anchor" href="#2024：No-More-Adam-——把关键放回“学习率尺度”">¶</a>2024：No More Adam?——把关键放回“学习率尺度”</h2><p>一条很“反直觉但很有启发”的路线是：也许 Adam 的优势很大部分来自“不同参数组的有效学习率尺度被自动调平”。</p><p>2024 的 SGD-SaI 提出在初始化时基于某种信号（例如 g-SNR）对不同参数组做学习率缩放，从而用更接近 SGD 的方法获得接近 AdamW 的效果，并且显著减少优化器状态的显存占用。</p><p>这对学习率研究的意义是：<strong>学习率不只是一个数，而是一个“与参数尺度/信噪比耦合的系统设计问题”。</strong></p><p>参考：<a class="link" href="https://arxiv.org/abs/2412.11768">No More Adam / SGD-SaI (arXiv:2412.11768)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2025：cosine-vs-WSD-的理论联系（凸优化视角）"><a class="header-anchor" href="#2025：cosine-vs-WSD-的理论联系（凸优化视角）">¶</a>2025：cosine vs WSD 的理论联系（凸优化视角）</h2><p>2025 的一条很有意思的观察是：一些大模型训练中的学习率曲线（尤其是 WSD 的 cooldown）在形状上和某些凸优化理论界非常接近，并且 cooldown 的收益在界里体现为“去掉了对数项”等。</p><p>你不需要完全理解那套界，但你可以记住结论：</p><ul><li>WSD 的 cooldown 不是“玄学的最后一脚刹车”，它能在一些理论模型中被解释为更好的收敛项；</li><li>这也提供了在不同 schedule 间迁移 base learning rate 的思路。</li></ul><p>参考：<a class="link" href="https://arxiv.org/abs/2501.18965">Convex theory view of WSD cooldown (arXiv:2501.18965)<i class="fas fa-external-link-alt"></i></a></p><hr><h1>FAQ：最常见的学习率问题（小白高频）</h1><h2 id="“我该用-AdamW-还是-SGD？”"><a class="header-anchor" href="#“我该用-AdamW-还是-SGD？”">¶</a>“我该用 AdamW 还是 SGD？”</h2><p>如果你是小白并且目标是“先跑通、稳定产出”：</p><ul><li>默认：AdamW + warmup + cosine/WSD。</li></ul><p>如果你追求更低显存、更强可解释性、或在某些视觉任务上想追极致：</p><ul><li>SGD（通常配动量）仍然很强，但更依赖调参经验。</li></ul><h2 id="“loss-一开始就炸怎么办？”"><a class="header-anchor" href="#“loss-一开始就炸怎么办？”">¶</a>“loss 一开始就炸怎么办？”</h2><p>按优先级排查（从最有效到次要）：</p><ul><li>把 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container> 降一个数量级试试；</li><li>增加 warmup（或把 warmup 起点设得更小）；</li><li>打开梯度裁剪；</li><li>检查混合精度（loss scaling）与数值稳定；</li><li>适当增加 weight decay（尤其是大模型）。</li></ul><h2 id="“loss-不炸但不怎么降怎么办？”"><a class="header-anchor" href="#“loss-不炸但不怎么降怎么办？”">¶</a>“loss 不炸但不怎么降怎么办？”</h2><p>常见原因：</p><ul><li>学习率太小；</li><li>衰减太快（过早进入小学习率阶段）；</li><li>batch 太小导致噪声很大，模型“原地抖动”；</li><li>数据/标签问题（这不是学习率能救的）。</li></ul><p>策略：</p><ul><li>做 LR range test 找上限；</li><li>让中段更长时间保持在较大 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container>（WSD 的 stable 部分很适合）。</li></ul><hr><h1>一页速查表（把“怎么选学习率”落地）</h1><h2 id="AdamW-常见起手式（通用）"><a class="header-anchor" href="#AdamW-常见起手式（通用）">¶</a>AdamW 常见起手式（通用）</h2><ul><li><strong>schedule</strong>：warmup + cosine 或 warmup + WSD</li><li><strong>warmup</strong>：1%～5%</li><li><strong>cooldown（若用 WSD）</strong>：10%～20%</li><li><strong>梯度裁剪</strong>：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="25.792ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 11400 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="merror" data-mjx-error="'_' allowed only in math mode" title="'_' allowed only in math mode"><rect data-background="true" width="11400" height="950" y="-200"/><title>'_' allowed only in math mode</title><g data-mml-node="mtext" style="font-family: serif;"><text data-variant="-explicitFont" transform="scale(1,-1)" font-size="884px">\text{max_norm}=1.0</text></g></g></g></g></svg></mjx-container>（大模型常用）</li></ul><h2 id="你应该关注的-3-个指标（比“看-loss”更直接）"><a class="header-anchor" href="#你应该关注的-3-个指标（比“看-loss”更直接）">¶</a>你应该关注的 3 个指标（比“看 loss”更直接）</h2><ul><li><strong>训练是否接近稳定边界</strong>：是否出现持续的 loss spike / 梯度范数爆炸迹象</li><li><strong>有效步长是否过小</strong>：学习太慢、长期平台</li><li><strong>对学习率的敏感性</strong>：轻微改动 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 是否导致结果大幅变化（越敏感越说明你在边界附近/系统不稳）</li></ul><h2 id="当你不知道选-cosine-还是-WSD"><a class="header-anchor" href="#当你不知道选-cosine-还是-WSD">¶</a>当你不知道选 cosine 还是 WSD</h2><ul><li>训练长度固定、不会续训：cosine 很稳妥；</li><li>训练长度可能变化、需要续训/多预算对比：优先 WSD；</li><li>想尽量少调 schedule：可以关注 schedule-free / learning-rate-free 方向（但要看你代码栈是否方便接入）。</li></ul><hr><h1>参考资料（按本文提到的关键脉络）</h1><ul><li><a class="link" href="https://ai.meta.com/research/publications/learning-rate-free-learning-by-d-adaptation/">Learning Rate-Free Learning by D-Adaptation (Meta, 2023)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2405.15682">Schedule-Free AdamW (arXiv:2405.15682)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2406.09405">Why Warmup the Learning Rate? (arXiv:2406.09405)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2408.13359">Power Scheduler (arXiv:2408.13359)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2309.14322">Small-scale proxies for large-scale Transformer instabilities (arXiv:2309.14322)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2501.18965">Convex theory view of WSD cooldown (arXiv:2501.18965)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2412.11768">No More Adam / SGD-SaI (arXiv:2412.11768)<i class="fas fa-external-link-alt"></i></a></li></ul><hr><h1>小白友好补充：用比喻理解学习率</h1><h2 id="🎯-核心概念的生活化比喻-v2"><a class="header-anchor" href="#🎯-核心概念的生活化比喻-v2">¶</a>🎯 核心概念的生活化比喻</h2><h3 id="学习率-下山的步幅"><a class="header-anchor" href="#学习率-下山的步幅">¶</a>学习率 = 下山的步幅</h3><p>想象你在黑暗的山顶，目标是走到最低的山谷（损失函数的最小值）：</p><ul><li><p><strong>学习率太大</strong>（步幅太大）：每一步跨度很大</p><ul><li>优点：下山快</li><li>缺点：可能跳过山谷，甚至越走越高（震荡）</li><li>极端情况：直接跳下悬崖（梯度爆炸）</li></ul></li><li><p><strong>学习率太小</strong>（步幅太小）：每一步只挪一点点</p><ul><li>优点：稳定，不会跳过山谷</li><li>缺点：下山慢得令人绝望</li><li>极端情况：可能在半山腰的小坑里止步不前（局部最优）</li></ul></li><li><p><strong>理想学习率</strong>（自适应步幅）：</p><ul><li>山坡陡峭时：步子大一点（梯度大时，学习率可以大）</li><li>接近山谷时：步子小一点（接近最优时，学习率应该小）</li><li>这就是<strong>学习率调度</strong>的核心思想！</li></ul></li></ul><h3 id="Warmup-热身跑"><a class="header-anchor" href="#Warmup-热身跑">¶</a>Warmup = 热身跑</h3><p>为什么训练初期要"warmup"（逐渐增大学习率）？</p><p><strong>比喻</strong>：你早上起床去跑步，不会一开始就全速冲刺，而是：</p><ol><li>先慢走（学习率从 0 开始）</li><li>快走（学习率逐渐增大）</li><li>慢跑（学习率达到目标值）</li><li>开始正式训练</li></ol><p><strong>原因</strong>：</p><ul><li>训练初期，模型参数是<strong>随机初始化</strong>的（相当于"肌肉还没活动开"）</li><li>如果一开始就用大学习率，梯度可能乱飞（相当于"拉伤肌肉"）</li><li>Warmup 让模型先"适应"数据分布，再加速训练</li></ul><h2 id="💡-直觉优先的深度讲解"><a class="header-anchor" href="#💡-直觉优先的深度讲解">¶</a>💡 直觉优先的深度讲解</h2><h3 id="为什么大模型训练需要更小的学习率？"><a class="header-anchor" href="#为什么大模型训练需要更小的学习率？">¶</a>为什么大模型训练需要更小的学习率？</h3><p><strong>直觉理解</strong>：<br>想象你在调整一个有 <strong>1000 亿个旋钮</strong> 的复杂机器（GPT-3）：</p><p><strong>小模型</strong>（1000 万参数）：</p><ul><li>旋钮少，每个旋钮调整对结果影响大</li><li>可以"大胆尝试"（学习率 <code>1e-3</code>）</li></ul><p><strong>大模型</strong>（1000 亿参数）：</p><ul><li>旋钮太多，每个旋钮调整的"副作用"会叠加</li><li>需要"小心翼翼"（学习率 <code>1e-5</code> 或更小）</li></ul><p><strong>数学原因</strong>：</p><ul><li>梯度更新量 ∝ 学习率 × 梯度 × 参数数量</li><li>参数多 → 总更新量大 → 需要更小的学习率来控制变化幅度</li></ul><h3 id="Adam-为什么比-SGD-“聪明”？"><a class="header-anchor" href="#Adam-为什么比-SGD-“聪明”？">¶</a>Adam 为什么比 SGD “聪明”？</h3><p><strong>SGD（随机梯度下降）</strong>：</p><ul><li>就像一个"固执的人"，沿着梯度方向一直走</li><li>不管地形如何，步幅固定</li></ul><p><strong>Adam（自适应矩估计）</strong>：</p><ul><li>就像一个"会观察地形的人"</li><li><strong>自适应 1</strong>：记住过去的方向（Momentum），避免来回震荡</li><li><strong>自适应 2</strong>：根据每个参数的历史梯度大小，调整每个参数的"个性化学习率"</li></ul><p><strong>比喻</strong>：</p><ul><li>SGD：所有人用相同步幅走路（不管腿长腿短）</li><li>Adam：给每个人定制步幅（腿长的迈大步，腿短的迈小步）</li></ul><h3 id="Cosine-Decay：为什么要-余弦衰减-？"><a class="header-anchor" href="#Cosine-Decay：为什么要-余弦衰减-？">¶</a>Cosine Decay：为什么要"余弦衰减"？</h3><p><strong>直觉</strong>：<br>想象你开车从高速公路到市区停车场：</p><ol><li><strong>高速路段</strong>（训练初期）：速度快（学习率大）</li><li><strong>下高速匝道</strong>（训练中期）：逐渐减速（学习率平滑下降）</li><li><strong>市区道路</strong>（训练后期）：慢速行驶（学习率很小）</li><li><strong>停车场</strong>（接近收敛）：缓慢挪车（学习率接近 0）</li></ol><p><strong>为什么用余弦而不是线性？</strong></p><ul><li><strong>线性衰减</strong>：速度均匀降低（像踩刹车一样生硬）</li><li><strong>余弦衰减</strong>：速度平滑降低（像松油门一样自然）</li></ul><p><strong>数学形式</strong>：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.148ex;" xmlns="http://www.w3.org/2000/svg" width="44.013ex" height="5.428ex" role="img" focusable="false" viewbox="0 -1449.5 19453.9 2399"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(4149.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mfrac" transform="translate(5150,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(6090,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(6479,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(8597.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9597.4,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(11356.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mrow" transform="translate(11911.8,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mn" transform="translate(736,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1458.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(2458.4,0)"><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"/><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(444,0)"/><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(944,0)"/></g><g data-mml-node="mo" transform="translate(3796.4,0)"><path data-c="2061" d=""/></g><g data-mml-node="mrow" transform="translate(3963.1,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mfrac" transform="translate(736,0)"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(361,0)"><path data-c="1D70B" d="M132 -11Q98 -11 98 22V33L111 61Q186 219 220 334L228 358H196Q158 358 142 355T103 336Q92 329 81 318T62 297T53 285Q51 284 38 284Q19 284 19 294Q19 300 38 329T93 391T164 429Q171 431 389 431Q549 431 553 430Q573 423 573 402Q573 371 541 360Q535 358 472 358H408L405 341Q393 269 393 222Q393 170 402 129T421 65T431 37Q431 20 417 5T381 -10Q370 -10 363 -7T347 17T331 77Q330 86 330 121Q330 170 339 226T357 318T367 358H269L268 354Q268 351 249 275T206 114T175 17Q164 -11 132 -11Z"/></g></g><g data-mml-node="mi" transform="translate(333.5,-686)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><rect width="1131" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(2107,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g><g data-mml-node="mo" transform="translate(6806.1,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g></g></g></svg></mjx-container></p><p><strong>关键点</strong>：余弦函数天然"头尾平滑"，避免训练初期和末期的剧烈波动。</p><h2 id="❓-Q-A：新手常见疑问-v2"><a class="header-anchor" href="#❓-Q-A：新手常见疑问-v2">¶</a>❓ Q&amp;A：新手常见疑问</h2><h3 id="Q1：学习率到底该设多大？"><a class="header-anchor" href="#Q1：学习率到底该设多大？">¶</a>Q1：学习率到底该设多大？</h3><p><strong>经验法则</strong>（按模型类型）：</p><table><thead><tr><th>模型类型</th><th>初始学习率</th><th>优化器</th><th>备注</th></tr></thead><tbody><tr><td><strong>小 MLP</strong>（&lt;1M 参数）</td><td><code>1e-3</code></td><td>Adam</td><td>标准配置</td></tr><tr><td><strong>CNN</strong>（如 ResNet）</td><td><code>1e-3 ~ 3e-4</code></td><td>SGD + Momentum 或 AdamW</td><td>视觉任务</td></tr><tr><td><strong>BERT 微调</strong></td><td><code>2e-5 ~ 5e-5</code></td><td>AdamW</td><td>NLP 预训练模型微调</td></tr><tr><td><strong>GPT 预训练</strong></td><td><code>1e-4 ~ 3e-4</code></td><td>AdamW</td><td>大规模语言模型</td></tr><tr><td><strong>Stable Diffusion 微调</strong></td><td><code>1e-5 ~ 1e-6</code></td><td>AdamW</td><td>图像生成模型</td></tr></tbody></table><p><strong>快速检验法</strong>（LR Range Test）：</p><ol><li>从很小的学习率（如 <code>1e-7</code>）开始</li><li>每个 batch 将学习率乘以 1.1</li><li>记录每个学习率下的损失</li><li>画图：损失最陡峭下降的点 × 0.1 = 你的最佳学习率</li></ol><h3 id="Q2：训练-loss-震荡怎么办？"><a class="header-anchor" href="#Q2：训练-loss-震荡怎么办？">¶</a>Q2：训练 loss 震荡怎么办？</h3><p><strong>症状</strong>：loss 曲线上下波动剧烈，不稳定收敛</p><p><strong>可能原因和解决方案</strong>：</p><table><thead><tr><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>学习率太大</strong></td><td>降低学习率（<code>1e-3 → 1e-4</code>）</td></tr><tr><td><strong>Batch size 太小</strong></td><td>增大 batch size（<code>32 → 128</code>）</td></tr><tr><td><strong>梯度爆炸</strong></td><td>添加梯度裁剪（<code>torch.nn.utils.clip_grad_norm_()</code>）</td></tr><tr><td><strong>数据不平衡</strong></td><td>使用加权损失或数据采样平衡</td></tr><tr><td><strong>模型初始化不当</strong></td><td>检查权重初始化（He init / Xavier init）</td></tr></tbody></table><h3 id="Q3：什么时候该停止训练？"><a class="header-anchor" href="#Q3：什么时候该停止训练？">¶</a>Q3：什么时候该停止训练？</h3><p><strong>标志</strong>：</p><ol><li><strong>验证 loss 不再下降</strong>（连续 5-10 个 epoch 无改善）</li><li><strong>验证 loss 开始上升</strong>（过拟合信号）</li><li><strong>学习率已经衰减到极小值</strong>（如 <code>&lt; 1e-7</code>）</li></ol><p><strong>早停（Early Stopping）策略</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">best_val_loss = <span class="built_in">float</span>(<span class="string">'inf'</span>)</span><br><span class="line">patience = <span class="number">10</span></span><br><span class="line">patience_counter = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(max_epochs):</span><br><span class="line">    train_loss = train_one_epoch()</span><br><span class="line">    val_loss = validate()</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> val_loss &lt; best_val_loss:</span><br><span class="line">        best_val_loss = val_loss</span><br><span class="line">        patience_counter = <span class="number">0</span></span><br><span class="line">        save_checkpoint()  <span class="comment"># 保存最佳模型</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        patience_counter += <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> patience_counter &gt;= patience:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Early stopping triggered!"</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><h3 id="Q4：Warmup-要做多久？"><a class="header-anchor" href="#Q4：Warmup-要做多久？">¶</a>Q4：Warmup 要做多久？</h3><p><strong>经验法则</strong>：</p><table><thead><tr><th>训练总步数</th><th>Warmup 步数</th><th>比例</th></tr></thead><tbody><tr><td>&lt; 1000 步</td><td>50-100 步</td><td>5-10%</td></tr><tr><td>1000-10000 步</td><td>100-500 步</td><td>5%</td></tr><tr><td>&gt; 10000 步</td><td>500-2000 步</td><td>2-5%</td></tr><tr><td>大模型预训练</td><td>1000-10000 步</td><td>根据收敛曲线调整</td></tr></tbody></table><p><strong>判断标准</strong>：</p><ul><li>Warmup 结束时，训练应该"稳定下来"（loss 曲线不再剧烈波动）</li><li>如果 warmup 后 loss 仍然震荡 → 延长 warmup 或降低目标学习率</li></ul><h3 id="Q5：为什么有时候降低学习率反而变差？"><a class="header-anchor" href="#Q5：为什么有时候降低学习率反而变差？">¶</a>Q5：为什么有时候降低学习率反而变差？</h3><p><strong>反直觉现象</strong>：<br>有时候训练卡住了，你降低学习率，结果 loss 不降反升。</p><p><strong>可能原因</strong>：</p><p><strong>原因 1：陷入尖锐局部最优</strong></p><ul><li>学习率太小，模型"困"在一个尖锐的坑里</li><li><strong>解决</strong>：先<strong>提高</strong>学习率"跳出"，再降低</li></ul><p><strong>原因 2：模型已经过拟合</strong></p><ul><li>继续训练只会让验证 loss 变差</li><li><strong>解决</strong>：停止训练，使用早停保存的最佳模型</li></ul><p><strong>原因 3：Batch size 太小 + 学习率太小</strong></p><ul><li>梯度估计噪声太大</li><li><strong>解决</strong>：增大 batch size 或使用梯度累积</li></ul><h2 id="⚠️-新手常见误区-v2"><a class="header-anchor" href="#⚠️-新手常见误区-v2">¶</a>⚠️ 新手常见误区</h2><h3 id="误区-1：盲目照搬论文的学习率"><a class="header-anchor" href="#误区-1：盲目照搬论文的学习率">¶</a>误区 1：盲目照搬论文的学习率</h3><p>❌ <strong>错误认知</strong>：论文用 <code>1e-3</code>，我也用 <code>1e-3</code></p><p>✅ <strong>正确理解</strong>：</p><ul><li>论文的学习率基于特定的：Batch size、优化器、模型架构、数据集</li><li>你的配置不同时，学习率需要调整</li></ul><p><strong>线性缩放规则</strong>：<br>如果论文用 batch size 256 和学习率 <code>0.1</code>，你用 batch size 128，那么学习率应该缩放为 <code>0.05</code>（减半）。</p><h3 id="误区-2：认为学习率越小越安全"><a class="header-anchor" href="#误区-2：认为学习率越小越安全">¶</a>误区 2：认为学习率越小越安全</h3><p>❌ <strong>错误认知</strong>：学习率小一点总是更稳</p><p>✅ <strong>正确理解</strong>：</p><ul><li>学习率<strong>太小</strong>：训练慢，容易卡在局部最优</li><li>学习率<strong>太大</strong>：不稳定，可能发散</li><li><strong>最佳实践</strong>：从大开始尝试，逐步降低直到稳定</li></ul><h3 id="误区-3：一直用固定学习率"><a class="header-anchor" href="#误区-3：一直用固定学习率">¶</a>误区 3：一直用固定学习率</h3><p>❌ <strong>错误认知</strong>：设置一个学习率就不管了</p><p>✅ <strong>正确理解</strong>：</p><ul><li>固定学习率在简单任务上可行</li><li>复杂任务（如大模型训练）<strong>必须</strong>使用学习率调度</li><li>常见调度：Cosine Decay、Step Decay、Warmup + Cosine</li></ul><h3 id="误区-4：混淆-学习率-和-收敛速度"><a class="header-anchor" href="#误区-4：混淆-学习率-和-收敛速度">¶</a>误区 4：混淆"学习率"和"收敛速度"</h3><p>❌ <strong>错误认知</strong>：学习率大 = 收敛快</p><p>⚠️ <strong>部分正确</strong>：</p><ul><li>初期：学习率大确实收敛快</li><li>后期：学习率大可能导致震荡，反而收敛慢</li><li><strong>关键</strong>：学习率调度是"先快后慢"的艺术</li></ul><h2 id="📚-实战调优-Checklist"><a class="header-anchor" href="#📚-实战调优-Checklist">¶</a>📚 实战调优 Checklist</h2><h3 id="步骤-1：快速验证（首次训练）"><a class="header-anchor" href="#步骤-1：快速验证（首次训练）">¶</a>步骤 1：快速验证（首次训练）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- [ ] 使用默认学习率（Adam: 1e-3, SGD: 0.1）</span><br><span class="line">- [ ] 训练 10-20 个 epoch</span><br><span class="line">- [ ] 观察 loss 曲线是否平滑下降</span><br></pre></td></tr></table></figure><h3 id="步骤-2：学习率范围测试（如果效果不理想）"><a class="header-anchor" href="#步骤-2：学习率范围测试（如果效果不理想）">¶</a>步骤 2：学习率范围测试（如果效果不理想）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- [ ] 实现 LR Range Test</span><br><span class="line">- [ ] 找到 loss 下降最快的区间</span><br><span class="line">- [ ] 选择该区间中点作为初始学习率</span><br></pre></td></tr></table></figure><h3 id="步骤-3：添加学习率调度（提升性能）"><a class="header-anchor" href="#步骤-3：添加学习率调度（提升性能）">¶</a>步骤 3：添加学习率调度（提升性能）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- [ ] 小数据集：使用 Step Decay 或 Exponential Decay</span><br><span class="line">- [ ] 大数据集：使用 Cosine Decay 或 WSD</span><br><span class="line">- [ ] 添加 Warmup（推荐总步数的 2-5%）</span><br></pre></td></tr></table></figure><h3 id="步骤-4：微调超参数（榨干最后一点性能）"><a class="header-anchor" href="#步骤-4：微调超参数（榨干最后一点性能）">¶</a>步骤 4：微调超参数（榨干最后一点性能）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- [ ] 调整 Warmup 长度</span><br><span class="line">- [ ] 调整 Cosine 的 min_lr（通常是 max_lr 的 1/10 到 1/100）</span><br><span class="line">- [ ] 调整优化器（试试 AdamW vs Adam）</span><br><span class="line">- [ ] 尝试不同的权重衰减（1e-4 ~ 1e-2）</span><br></pre></td></tr></table></figure><h2 id="🎓-总结：学习率优化的-5-大黄金法则"><a class="header-anchor" href="#🎓-总结：学习率优化的-5-大黄金法则">¶</a>🎓 总结：学习率优化的 5 大黄金法则</h2><ol><li><strong>从大到小探索</strong>：宁愿从大学习率开始降低，也不要从小学习率开始提高</li><li><strong>观察曲线</strong>：loss 曲线是最好的老师，震荡=太大，停滞=太小</li><li><strong>使用调度</strong>：复杂任务必须用学习率调度（推荐 Warmup + Cosine Decay）</li><li><strong>批大小联动</strong>：batch size 增大 → 学习率也应该增大（线性缩放规则）</li><li><strong>耐心调试</strong>：学习率是超参数中最重要的，值得花时间精调</li></ol><p><strong>记忆口诀</strong>：</p><blockquote><p><strong>大胆尝试，小心收敛，曲线说话，调度护航，批量联动</strong></p></blockquote><p><strong>最后的建议</strong>：</p><ul><li>新手：直接用 AdamW + Cosine Decay（90% 场景都适用）</li><li>进阶：学会 LR Range Test，找到最佳起点</li><li>高手：理解每个超参数的物理意义，根据任务特点定制策略</li></ul><p>学习率调优是深度学习的"手艺活"，多实验、多观察、多总结，你会越来越有"手感"！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;学习率（Learning Rate, LR）是深度学习里&lt;strong&gt;最重要、也最容易“看起来像玄学”的超参数&lt;/strong&gt;。它既像汽车的油门（决定你每一步走多快），也像方向盘的灵敏度（太敏感会蛇形走位甚至翻车，太迟钝又永远到不了目的地）。&lt;/p&gt;
&lt;p&gt;这篇文章会从最简单的二次函数出发，把“学习率为什么会影响稳定性、为什么训练后期要降学习率、为什么 warmup 常见”讲清楚。&lt;/p&gt;</summary>
    
    
    
    
    <category term="LLM" scheme="https://chenk.top/tags/LLM/"/>
    
    <category term="Optimization" scheme="https://chenk.top/tags/Optimization/"/>
    
    <category term="ML-Basics" scheme="https://chenk.top/tags/ML-Basics/"/>
    
    <category term="深度学习" scheme="https://chenk.top/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Learning Rate: From Basics to Large-Scale Training (2026 Complete Guide)</title>
    <link href="https://chenk.top/en/learning-rate-guide/"/>
    <id>https://chenk.top/en/learning-rate-guide/</id>
    <published>2025-03-26T16:00:00.000Z</published>
    <updated>2026-01-30T15:35:11.645Z</updated>
    
    <content type="html"><![CDATA[<p>Learning rate (LR) is the knob that most often decides whether training <strong>converges</strong>, <strong>crawls</strong>, or <strong>blows up</strong>. This post builds an actionable mental model—from the simplest quadratic loss to modern large-scale training recipes—so you can choose schedules (warmup/cosine/WSD), debug instability, and tune LR systematically. We cover the math (why “too big explodes, too small stalls”), practical workflows (LR range test, schedule selection), failure mode diagnosis, recent research (schedule-free, power scheduler, warmup theory), and a troubleshooting checklist for common issues.</p><span id="more"></span><h1>The One-Sentence Definition</h1><p><strong>Learning rate</strong> controls how far you move in the direction suggested by the gradient each step.</p><p>A typical update is:</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="16.22ex" height="2.084ex" role="img" focusable="false" viewbox="0 -705 7169.4 921"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(5074.2,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(5909.5,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="msub" transform="translate(6354.1,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>where <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.844ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 815.3 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> is often a mini-batch (stochastic) gradient.</p><p><strong>Core trade-off</strong>:</p><blockquote><p><strong><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> large → fast but unstable; <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> small → stable but slow (or stuck)</strong></p></blockquote><hr><h1>Minimal Math: Why “Too Big Explodes, Too Small Stalls”</h1><h2 id="1D-quadratic-the-simplest-intuition"><a class="header-anchor" href="#1D-quadratic-the-simplest-intuition">¶</a>1D quadratic: the simplest intuition</h2><p>Consider a 1D quadratic:</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="27.541ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 12173.3 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2205.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(3261.6,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mi" transform="translate(4201.6,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="msup" transform="translate(4730.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mn" transform="translate(502,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(5636.1,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(5914.1,0)"><g data-mml-node="mspace"/></g><g data-mml-node="mi" transform="translate(7080.8,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(7913.8,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(8594.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(8983.8,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(9452.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(10119.6,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(11175.3,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(11704.3,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g></g></g></svg></mjx-container></p><p>Gradient descent gives:</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="16.693ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 7378.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mo" transform="translate(3044.5,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(3433.5,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(4155.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(5155.9,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(5684.9,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(6181.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msub" transform="translate(6570.9,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>Stability requires:</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.575ex;" xmlns="http://www.w3.org/2000/svg" width="10.482ex" height="4.611ex" role="img" focusable="false" viewbox="0 -1342 4633.1 2038"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(234.5,676)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="729" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p><strong>Intuition</strong>: If <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> is too large, you overshoot the valley and bounce back with increasing amplitude.</p><h2 id="Multi-dimensional-case-most-curved-direction-controls-stability"><a class="header-anchor" href="#Multi-dimensional-case-most-curved-direction-controls-stability">¶</a>Multi-dimensional case: most curved direction controls stability</h2><p>In higher dimensions with Hessian <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container>:</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.172ex;" xmlns="http://www.w3.org/2000/svg" width="17.539ex" height="5.208ex" role="img" focusable="false" viewbox="0 -1342 7752 2302"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(1794,676)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="TeXAtom" transform="translate(616,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(1981.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2370.9,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3258.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g><rect width="3847.9" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p><strong>Key insight</strong>: The <strong>steepest direction</strong> (largest eigenvalue) determines the stability boundary.</p><p><strong>Analogy</strong>: You’re walking in a valley. Most directions are gentle slopes, but one direction is a cliff edge. Your step size must be small enough to not fall off that cliff.</p><h2 id="Why-schedules-help"><a class="header-anchor" href="#Why-schedules-help">¶</a>Why schedules help</h2><p>In real networks, curvature and gradient noise change over training. A schedule typically provides:</p><ul><li><strong>Warmup</strong>: stabilizes early training and enables larger peak LR</li><li><strong>Stable phase</strong>: efficient progress at a good LR</li><li><strong>Decay / cooldown</strong>: reduces noise and refines the final solution</li></ul><p>Common choices:</p><ul><li>Warmup + cosine decay</li><li>Warmup–stable–decay (WSD)</li></ul><hr><h1>Why Batch Size Affects Learning Rate</h1><h2 id="Gradient-noise-model"><a class="header-anchor" href="#Gradient-noise-model">¶</a>Gradient noise model</h2><p>Mini-batch gradient can be viewed as:</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="16.395ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 7246.8 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1093,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(2148.8,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(2981.8,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3662.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(4051.8,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4859.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(5470.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(6470.5,0)"><g data-mml-node="mi"><path data-c="1D709" d="M268 632Q268 704 296 704Q314 704 314 687Q314 682 311 664T308 635T309 620V616H315Q342 619 360 619Q443 619 443 586Q439 548 358 546H344Q326 546 317 549T290 566Q257 550 226 505T195 405Q195 381 201 364T211 342T218 337Q266 347 298 347Q375 347 375 314Q374 297 359 288T327 277T280 275Q234 275 208 283L195 286Q149 260 119 214T88 130Q88 116 90 108Q101 79 129 63T229 20Q238 17 243 15Q337 -21 354 -33Q383 -53 383 -94Q383 -137 351 -171T273 -205Q240 -205 202 -190T158 -167Q156 -163 156 -159Q156 -151 161 -146T176 -140Q182 -140 189 -143Q232 -168 274 -168Q286 -168 292 -165Q313 -151 313 -129Q313 -112 301 -104T232 -75Q214 -68 204 -64Q198 -62 171 -52T136 -38T107 -24T78 -8T56 12T36 37T26 66T21 103Q21 149 55 206T145 301L154 307L148 313Q141 319 136 323T124 338T111 358T103 382T99 413Q99 471 143 524T259 602L271 607Q268 618 268 632Z"/></g><g data-mml-node="mi" transform="translate(471,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>where <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.756ex" height="2.057ex" role="img" focusable="false" viewbox="0 -704 776.3 909"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D709" d="M268 632Q268 704 296 704Q314 704 314 687Q314 682 311 664T308 635T309 620V616H315Q342 619 360 619Q443 619 443 586Q439 548 358 546H344Q326 546 317 549T290 566Q257 550 226 505T195 405Q195 381 201 364T211 342T218 337Q266 347 298 347Q375 347 375 314Q374 297 359 288T327 277T280 275Q234 275 208 283L195 286Q149 260 119 214T88 130Q88 116 90 108Q101 79 129 63T229 20Q238 17 243 15Q337 -21 354 -33Q383 -53 383 -94Q383 -137 351 -171T273 -205Q240 -205 202 -190T158 -167Q156 -163 156 -159Q156 -151 161 -146T176 -140Q182 -140 189 -143Q232 -168 274 -168Q286 -168 292 -165Q313 -151 313 -129Q313 -112 301 -104T232 -75Q214 -68 204 -64Q198 -62 171 -52T136 -38T107 -24T78 -8T56 12T36 37T26 66T21 103Q21 149 55 206T145 301L154 307L148 313Q141 319 136 323T124 338T111 358T103 382T99 413Q99 471 143 524T259 602L271 607Q268 618 268 632Z"/></g><g data-mml-node="mi" transform="translate(471,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> is noise (variance decreases with batch size).</p><p><strong>Two effects</strong>:</p><ul><li><strong>Good</strong>: Noise helps escape sharp local minima</li><li><strong>Bad</strong>: Noise makes large step sizes unstable</li></ul><p><strong>Linear scaling rule</strong> (empirical):</p><ul><li>If you increase batch size by <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container>, multiply LR by <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container></li><li>But add warmup to stabilize early training</li></ul><p><strong>Why warmup?</strong> Early training is chaotic (parameters uninitialized, high curvature). Warmup lets the model enter a “good region” before cranking up the LR.</p><hr><h1>Momentum: The Hidden LR Amplifier</h1><h2 id="SGD-Momentum"><a class="header-anchor" href="#SGD-Momentum">¶</a>SGD + Momentum</h2><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="32.413ex" height="2.084ex" role="img" focusable="false" viewbox="0 -705 14326.6 921"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1101,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(2156.8,0)"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="msub" transform="translate(2722.8,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="TeXAtom" transform="translate(518,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(4672,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(5672.2,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(6487.5,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(6765.5,0)"><g data-mml-node="mspace"/></g><g data-mml-node="msub" transform="translate(7932.1,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(9920.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(10976.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(12006.1,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(13006.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msub" transform="translate(13503.4,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p>where <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.075ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4011.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mo" transform="translate(843.8,0)"><path data-c="2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"/></g><g data-mml-node="mo" transform="translate(1788.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(2177.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(2677.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(3122.2,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(3622.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> (typically 0.9).</p><p><strong>Intuition</strong>: You’re pushing a shopping cart downhill:</p><ul><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.844ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 815.3 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container>: current slope</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="1.863ex" height="1.359ex" role="img" focusable="false" viewbox="0 -443 823.3 600.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container>: cart’s velocity (has inertia)</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.281ex" height="2.034ex" role="img" focusable="false" viewbox="0 -705 566 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g></g></g></svg></mjx-container>: how much the cart “remembers” past momentum</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container>: conversion from velocity to displacement</li></ul><p><strong>Critical insight</strong>: Momentum <strong>amplifies</strong> effective step size, so you often need <strong>smaller LR</strong> with momentum than without.</p><hr><h1>Adaptive Optimizers: Per-Parameter Learning Rates</h1><h2 id="Adam-core-formula"><a class="header-anchor" href="#Adam-core-formula">¶</a>Adam core formula</h2><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="25.369ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 11213 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1494,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2549.8,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="msub" transform="translate(3552.4,0)"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(911,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(5894.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(6894.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(7283.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(8006,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9006.2,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="mo" transform="translate(10008.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msub" transform="translate(10397.8,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.625ex;" xmlns="http://www.w3.org/2000/svg" width="25.058ex" height="2.625ex" role="img" focusable="false" viewbox="0 -883.9 11075.4 1160"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1101,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2156.8,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="msub" transform="translate(3159.4,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="TeXAtom" transform="translate(518,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(5108.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(6108.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(6497.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(7220,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(8220.2,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(9222.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msubsup" transform="translate(9611.8,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="TeXAtom" transform="translate(510,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2299" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM682 250Q682 322 649 387T546 497T381 542Q272 542 184 459T95 250Q95 132 178 45T389 -42Q515 -42 598 45T682 250ZM311 250Q311 285 332 304T375 328Q376 328 382 328T392 329Q424 326 445 305T466 250Q466 217 445 195T389 172Q354 172 333 195T311 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mi" transform="translate(510,-268.3) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.76ex;" xmlns="http://www.w3.org/2000/svg" width="21.455ex" height="6.122ex" role="img" focusable="false" viewbox="0 -1486 9482.9 2706"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(5074.2,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mfrac" transform="translate(5571.2,0)"><g data-mml-node="msub" transform="translate(1347.7,676)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(439,16) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mrow" transform="translate(220,-1014.1)"><g data-mml-node="msqrt"><g transform="translate(1020,0)"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g><g data-mml-node="mo" transform="translate(0,144.1)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="823.3" height="60" x="1020" y="934.1"/></g><g data-mml-node="mo" transform="translate(2065.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(3065.7,0)"><path data-c="1D716" d="M227 -11Q149 -11 95 41T40 174Q40 262 87 322Q121 367 173 396T287 430Q289 431 329 431H367Q382 426 382 411Q382 385 341 385H325H312Q191 385 154 277L150 265H327Q340 256 340 246Q340 228 320 219H138V217Q128 187 128 143Q128 77 160 52T231 26Q258 26 284 36T326 57T343 68Q350 68 354 58T358 39Q358 36 357 35Q354 31 337 21T289 0T227 -11Z"/></g></g><rect width="3671.7" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></p><p><strong>Key insight</strong>: The effective LR is roughly <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.87ex" height="2.95ex" role="img" focusable="false" viewbox="0 -1054.1 5246.7 1304.1"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(497,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mo" transform="translate(997,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msqrt" transform="translate(1386,0)"><g transform="translate(1020,0)"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g><g data-mml-node="mo" transform="translate(0,144.1)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="823.3" height="60" x="1020" y="934.1"/></g><g data-mml-node="mo" transform="translate(3451.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(4451.7,0)"><path data-c="1D716" d="M227 -11Q149 -11 95 41T40 174Q40 262 87 322Q121 367 173 396T287 430Q289 431 329 431H367Q382 426 382 411Q382 385 341 385H325H312Q191 385 154 277L150 265H327Q340 256 340 246Q340 228 320 219H138V217Q128 187 128 143Q128 77 160 52T231 26Q258 26 284 36T326 57T343 68Q350 68 354 58T358 39Q358 36 357 35Q354 31 337 21T289 0T227 -11Z"/></g><g data-mml-node="mo" transform="translate(4857.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>, so <strong>each parameter gets a different step size</strong> based on its gradient history.</p><p><strong>Analogy</strong>: Same car on different roads. Bumpy roads (high gradient variance) automatically reduce effective LR to prevent skidding.</p><h2 id="Why-Adam-still-needs-warmup"><a class="header-anchor" href="#Why-Adam-still-needs-warmup">¶</a>Why Adam still needs warmup</h2><p>Even with adaptive scaling, early training has:</p><ul><li>Unstable statistics (<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.752ex" height="1.357ex" role="img" focusable="false" viewbox="0 -442 1216.3 599.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container>, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="1.863ex" height="1.359ex" role="img" focusable="false" viewbox="0 -443 823.3 600.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container> not converged)</li><li>High <strong>preconditioned sharpness</strong> (effective curvature after Adam’s scaling)</li></ul><p><strong>Solution</strong>: Warmup from small LR to target LR over 1-5% of steps.</p><hr><h1>LR Schedules: From Old-School to Modern LLMs</h1><h2 id="Constant-LR"><a class="header-anchor" href="#Constant-LR">¶</a>Constant LR</h2><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="7.019ex" height="1.808ex" role="img" focusable="false" viewbox="0 -583 3102.4 799"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(530,-150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g></g></svg></mjx-container></p><p><strong>Pros</strong>: Simple.</p><p><strong>Cons</strong>: Either too slow early or too noisy late (can’t have both).</p><h2 id="Step-decay"><a class="header-anchor" href="#Step-decay">¶</a>Step decay</h2><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="24.232ex" height="2.059ex" role="img" focusable="false" viewbox="0 -694 10710.6 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(774.8,0)"><path data-c="2190" d="M944 261T944 250T929 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270H929Q944 261 944 250Z"/></g><g data-mml-node="mi" transform="translate(2052.6,0)"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g><g data-mml-node="mi" transform="translate(2595.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mstyle" transform="translate(3092.6,0)"><g data-mml-node="mspace"/></g><g data-mml-node="mtext" transform="translate(4092.6,0)"><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"/><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z" transform="translate(444,0)"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(972,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1416,0)"/><path data-c="79" d="M69 -66Q91 -66 104 -80T118 -116Q118 -134 109 -145T91 -160Q84 -163 97 -166Q104 -168 111 -168Q131 -168 148 -159T175 -138T197 -106T213 -75T225 -43L242 0L170 183Q150 233 125 297Q101 358 96 368T80 381Q79 382 78 382Q66 385 34 385H19V431H26L46 430Q65 430 88 429T122 428Q129 428 142 428T171 429T200 430T224 430L233 431H241V385H232Q183 385 185 366L286 112Q286 113 332 227L376 341V350Q376 365 366 373T348 383T334 385H331V431H337H344Q351 431 361 431T382 430T405 429T422 429Q477 429 503 431H508V385H497Q441 380 422 345Q420 343 378 235T289 9T227 -131Q180 -204 113 -204Q69 -204 44 -177T19 -116Q19 -89 35 -78T69 -66Z" transform="translate(1808,0)"/><path data-c="A0" d="" transform="translate(2336,0)"/></g><g data-mml-node="mi" transform="translate(6678.6,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mtext" transform="translate(7566.6,0)"><path data-c="A0" d=""/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(250,0)"/><path data-c="70" d="M36 -148H50Q89 -148 97 -134V-126Q97 -119 97 -107T97 -77T98 -38T98 6T98 55T98 106Q98 140 98 177T98 243T98 296T97 335T97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 61 434T98 436Q115 437 135 438T165 441T176 442H179V416L180 390L188 397Q247 441 326 441Q407 441 464 377T522 216Q522 115 457 52T310 -11Q242 -11 190 33L182 40V-45V-101Q182 -128 184 -134T195 -145Q216 -148 244 -148H260V-194H252L228 -193Q205 -192 178 -192T140 -191Q37 -191 28 -194H20V-148H36ZM424 218Q424 292 390 347T305 402Q234 402 182 337V98Q222 26 294 26Q345 26 384 80T424 218Z" transform="translate(694,0)"/><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(1250,0)"/><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(1750,0)"/><path data-c="68" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 124T102 167T103 217T103 272T103 329Q103 366 103 407T103 482T102 542T102 586T102 603Q99 622 88 628T43 637H25V660Q25 683 27 683L37 684Q47 685 66 686T103 688Q120 689 140 690T170 693T181 694H184V367Q244 442 328 442Q451 442 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2194,0)"/><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(2750,0)"/></g></g></g></svg></mjx-container></p><p><strong>Pros</strong>: Easy to implement.</p><p><strong>Cons</strong>: Abrupt changes can cause loss spikes.</p><h2 id="Cosine-decay-most-popular-in-deep-learning"><a class="header-anchor" href="#Cosine-decay-most-popular-in-deep-learning">¶</a>Cosine decay (most popular in deep learning)</h2><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.148ex;" xmlns="http://www.w3.org/2000/svg" width="44.789ex" height="5.428ex" role="img" focusable="false" viewbox="0 -1449.5 19796.9 2399"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(4149.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mfrac" transform="translate(5150,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(6090,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(6479,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(8597.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9597.4,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(11356.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mrow" transform="translate(11911.8,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mn" transform="translate(736,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1458.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(2458.4,0)"><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"/><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(444,0)"/><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(944,0)"/></g><g data-mml-node="mo" transform="translate(3796.4,0)"><path data-c="2061" d=""/></g><g data-mml-node="mrow" transform="translate(3963.1,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mi" transform="translate(736,0)"><path data-c="1D70B" d="M132 -11Q98 -11 98 22V33L111 61Q186 219 220 334L228 358H196Q158 358 142 355T103 336Q92 329 81 318T62 297T53 285Q51 284 38 284Q19 284 19 294Q19 300 38 329T93 391T164 429Q171 431 389 431Q549 431 553 430Q573 423 573 402Q573 371 541 360Q535 358 472 358H408L405 341Q393 269 393 222Q393 170 402 129T421 65T431 37Q431 20 417 5T381 -10Q370 -10 363 -7T347 17T331 77Q330 86 330 121Q330 170 339 226T357 318T367 358H269L268 354Q268 351 249 275T206 114T175 17Q164 -11 132 -11Z"/></g><g data-mml-node="mfrac" transform="translate(1306,0)"><g data-mml-node="mi" transform="translate(391.5,676)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><rect width="904" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(2450,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g><g data-mml-node="mo" transform="translate(7149.1,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g></g></g></svg></mjx-container></p><p><strong>Intuition</strong>: Slow decay early (exploration), fast decay late (convergence).</p><p><strong>Typical setup</strong>: Warmup to <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container>, then cosine decay to <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="3.979ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1758.7 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g></g></g></svg></mjx-container>.</p><h2 id="WSD-Warmup–Stable–Decay-modern-large-model-default"><a class="header-anchor" href="#WSD-Warmup–Stable–Decay-modern-large-model-default">¶</a>WSD (Warmup–Stable–Decay): modern large-model default</h2><p><strong>Structure</strong>:</p><ul><li>Warmup: ramp up to <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></li><li>Stable: hold at <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container> for most of training</li><li>Decay/cooldown: linearly (or otherwise) drop to <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="3.979ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1758.7 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g></g></g></svg></mjx-container> in final 10-20%</li></ul><p><strong>Why popular?</strong></p><ul><li>More <strong>resumable</strong> (you can extend training without redesigning schedule)</li><li>Cooldown phase often shows a <strong>sharp loss drop</strong> (model finally “fine-tunes”)</li></ul><hr><h1>Practical Workflow: From “It Runs” to “It Works”</h1><h2 id="Step-1-Identify-the-failure-mode"><a class="header-anchor" href="#Step-1-Identify-the-failure-mode">¶</a>Step 1: Identify the failure mode</h2><p>Training “fails” in 3 ways:</p><ol><li><strong>Immediate divergence</strong>: Loss → NaN/inf within a few steps</li><li><strong>High oscillation</strong>: Loss bounces around, no consistent descent</li><li><strong>Stuck plateau</strong>: Loss barely moves, validation accuracy flat</li></ol><p><strong>Diagnosis</strong>:</p><ul><li>(1)(2): LR too high, insufficient warmup, or missing gradient clipping</li><li>(3): LR too small, schedule decays too fast, or batch too noisy</li></ul><h2 id="Step-2-Run-an-LR-range-test"><a class="header-anchor" href="#Step-2-Run-an-LR-range-test">¶</a>Step 2: Run an LR range test</h2><p><strong>Classic method</strong> (<a class="link" href="http://fast.ai">fast.ai<i class="fas fa-external-link-alt"></i></a> style):</p><ul><li>Start with very small LR (e.g., 1e-7)</li><li>Exponentially increase LR each step (e.g., multiply by 1.1)</li><li>Stop when loss explodes</li><li>Plot LR vs loss curve</li></ul><p><strong>Interpretation</strong>:</p><ul><li>Loss decreases → LR is safe</li><li>Loss starts increasing → approaching stability boundary</li><li><strong>Pick 0.3-1× the “edge” as your peak LR</strong></li></ul><h3 id="Code-example-PyTorch"><a class="header-anchor" href="#Code-example-PyTorch">¶</a>Code example (PyTorch)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lr_range_test</span>(<span class="params">model, loader, loss_fn, optimizer, lr_min=<span class="number">1e-7</span>, lr_max=<span class="number">10</span>, num_steps=<span class="number">200</span></span>):</span><br><span class="line">    model.train()</span><br><span class="line">    mult = (lr_max / lr_min) ** (<span class="number">1</span> / (num_steps - <span class="number">1</span>))</span><br><span class="line">    lr = lr_min</span><br><span class="line">    <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">        g[<span class="string">"lr"</span>] = lr</span><br><span class="line">  </span><br><span class="line">    losses, lrs = [], []</span><br><span class="line">    it = <span class="built_in">iter</span>(loader)</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(num_steps):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            x, y = <span class="built_in">next</span>(it)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            it = <span class="built_in">iter</span>(loader)</span><br><span class="line">            x, y = <span class="built_in">next</span>(it)</span><br><span class="line">    </span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        pred = model(x)</span><br><span class="line">        loss = loss_fn(pred, y)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line">    </span><br><span class="line">        losses.append(loss.item())</span><br><span class="line">        lrs.append(lr)</span><br><span class="line">    </span><br><span class="line">        lr *= mult</span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            g[<span class="string">"lr"</span>] = lr</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> lrs, losses</span><br></pre></td></tr></table></figure><h2 id="Step-3-Choose-a-schedule"><a class="header-anchor" href="#Step-3-Choose-a-schedule">¶</a>Step 3: Choose a schedule</h2><p><strong>For mid-size models</strong> (&lt; 1B params, &lt; 1 week training):</p><ul><li><strong>Default</strong>: Warmup + cosine (simple, robust)</li></ul><p><strong>For LLMs</strong> (LLM pretraining, long runs):</p><ul><li><strong>Default</strong>: WSD (more flexible for resuming/extending)</li></ul><p><strong>Warmup duration</strong>:</p><ul><li>Small models: 1-2% of steps</li><li>LLMs / large batch: 5-10% of steps</li></ul><p><strong>Cooldown duration</strong> (WSD only):</p><ul><li>Typically 10-20% of total steps</li><li>Should see a “loss elbow” when cooldown starts</li></ul><h2 id="Step-4-Tune-the-“3-way-coupling”"><a class="header-anchor" href="#Step-4-Tune-the-“3-way-coupling”">¶</a>Step 4: Tune the “3-way coupling”</h2><p>LR, batch size, and weight decay are <strong>highly coupled</strong>:</p><table><thead><tr><th>Issue</th><th>Don’t only adjust LR</th><th>Try also</th></tr></thead><tbody><tr><td>Training unstable</td><td>❌ Lower LR blindly</td><td>✅ Add gradient clipping, increase warmup, add weight decay</td></tr><tr><td>Loss stuck high</td><td>❌ Raise LR blindly</td><td>✅ Increase batch size (reduce noise), check for bugs</td></tr><tr><td>Overfitting</td><td>❌ Lower LR only</td><td>✅ Increase weight decay, add dropout, use data augmentation</td></tr></tbody></table><p><strong>Analogy</strong>: LR is the gas pedal, batch size is road friction, weight decay is a gentle brake. Adjusting only one rarely fixes the problem.</p><hr><h1>Troubleshooting Checklist</h1><h2 id="Problem-1-Loss-immediately-explodes-NaN-inf"><a class="header-anchor" href="#Problem-1-Loss-immediately-explodes-NaN-inf">¶</a>Problem 1: Loss immediately explodes (NaN/inf)</h2><p><strong>Priority order</strong>:</p><ol><li><strong>Lower peak LR</strong> by 10× (e.g., 3e-4 → 3e-5)</li><li><strong>Increase warmup</strong> (0 → 5% steps)</li><li><strong>Add gradient clipping</strong>: <code>torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=1.0)</code></li><li><strong>Check mixed precision</strong>: Ensure loss scaling is enabled (<code>torch.cuda.amp.GradScaler</code>)</li><li><strong>Increase weight decay</strong> (especially for LLMs)</li></ol><h2 id="Problem-2-Loss-decreases-very-slowly"><a class="header-anchor" href="#Problem-2-Loss-decreases-very-slowly">¶</a>Problem 2: Loss decreases very slowly</h2><p><strong>Common causes</strong>:</p><ul><li>LR too small</li><li>Schedule decays too aggressively</li><li>Batch too small (high gradient noise)</li><li>Data/label issue (not LR-related)</li></ul><p><strong>Solutions</strong>:</p><ol><li>Run LR range test to find safe upper bound</li><li>Use WSD with longer stable phase</li><li>Increase batch size (if memory allows)</li><li>Check data pipeline (labels correct? augmentation too strong?)</li></ol><h2 id="Problem-3-Loss-oscillates-wildly"><a class="header-anchor" href="#Problem-3-Loss-oscillates-wildly">¶</a>Problem 3: Loss oscillates wildly</h2><p><strong>Common causes</strong>:</p><ul><li>LR too high</li><li>Momentum too high</li><li>Weight decay mismatched with normalization</li></ul><p><strong>Solutions</strong>:</p><ol><li>Lower peak LR</li><li>Reduce momentum (<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="15.719ex" height="2.034ex" role="img" focusable="false" viewbox="0 -705 6947.7 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="mo" transform="translate(1280.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(2336.1,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"/><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(778,0)"/></g><g data-mml-node="mo" transform="translate(3891.9,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(5169.7,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"/><path data-c="38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z" transform="translate(778,0)"/><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1278,0)"/></g></g></g></svg></mjx-container>)</li><li>Add gradient clipping</li><li>Check optimizer-norm interaction (e.g., AdamW + LayerNorm is safe, but SGD + BatchNorm can be tricky)</li></ol><h2 id="Problem-4-Validation-loss-diverges-from-training-loss"><a class="header-anchor" href="#Problem-4-Validation-loss-diverges-from-training-loss">¶</a>Problem 4: Validation loss diverges from training loss</h2><p><strong>Cause</strong>: Overfitting (not directly LR-related, but LR affects regularization)</p><p><strong>Solutions</strong>:</p><ol><li>Increase weight decay</li><li>Lower peak LR slightly (slower training can reduce overfitting)</li><li>Add dropout, label smoothing, or data augmentation</li><li>Early stopping</li></ol><hr><h1>Recent Research: What’s New in LR Tuning?</h1><h2 id="2023-Learning-rate-free-optimization-D-Adaptation"><a class="header-anchor" href="#2023-Learning-rate-free-optimization-D-Adaptation">¶</a>2023: Learning-rate-free optimization (D-Adaptation)</h2><p><strong>Idea</strong>: Automatically estimate the LR scale without manual tuning.</p><p><strong>How</strong>: Theory-driven method that estimates “distance to optimum” during training.</p><p><strong>When to use</strong>: Prototyping, grid search reduction.</p><p><strong>Reference</strong>: <a class="link" href="https://ai.meta.com/research/publications/learning-rate-free-learning-by-d-adaptation/">Learning Rate-Free Learning by D-Adaptation (Meta, 2023)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024-Schedule-Free-AdamW"><a class="header-anchor" href="#2024-Schedule-Free-AdamW">¶</a>2024: Schedule-Free AdamW</h2><p><strong>Problem</strong>: Most schedules require knowing total steps <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewbox="0 -677 704 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g></g></svg></mjx-container> upfront (e.g., cosine half-period).</p><p><strong>Solution</strong>: Combine scheduling + iterate averaging to achieve schedule-like performance without explicit decay.</p><p><strong>Benefit</strong>: Can extend training mid-run without redesigning the schedule.</p><p><strong>Reference</strong>: <a class="link" href="https://arxiv.org/abs/2405.15682">Schedule-Free AdamW (arXiv:2405.15682)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024-Why-Warmup-Helps-New-Theory"><a class="header-anchor" href="#2024-Why-Warmup-Helps-New-Theory">¶</a>2024: Why Warmup Helps (New Theory)</h2><p><strong>Old view</strong>: Warmup helps Adam’s statistics stabilize.</p><p><strong>New view</strong>: Warmup lets the model enter a region where it can <strong>tolerate larger LR</strong> (lower effective sharpness).</p><p><strong>Implication</strong>: Warmup is not just about “waiting for statistics”—it’s about <strong>shaping the optimization landscape</strong>.</p><p><strong>Reference</strong>: <a class="link" href="https://arxiv.org/abs/2406.09405">Why Warmup the Learning Rate? (arXiv:2406.09405)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024-Power-Scheduler-Batch-Token-Agnostic"><a class="header-anchor" href="#2024-Power-Scheduler-Batch-Token-Agnostic">¶</a>2024: Power Scheduler (Batch/Token Agnostic)</h2><p><strong>Problem</strong>: Optimal LR changes when you change batch size or training tokens.</p><p><strong>Solution</strong>: Use power-law relationships between LR, batch size, and tokens to design <strong>transferable schedules</strong>.</p><p><strong>Benefit</strong>: Less retuning when scaling up/down.</p><p><strong>Reference</strong>: <a class="link" href="https://arxiv.org/abs/2408.13359">Power Scheduler (arXiv:2408.13359)<i class="fas fa-external-link-alt"></i></a></p><h2 id="2024-2025-Small-Models-Reproduce-LLM-Instabilities"><a class="header-anchor" href="#2024-2025-Small-Models-Reproduce-LLM-Instabilities">¶</a>2024-2025: Small Models Reproduce LLM Instabilities</h2><p><strong>Insight</strong>: Many “LLM bugs” (e.g., loss spikes) can be reproduced in small models by using <strong>higher LR</strong>.</p><p><strong>Benefit</strong>: Debug instabilities at 1/100 the cost.</p><p><strong>Reference</strong>: <a class="link" href="https://arxiv.org/abs/2309.14322">Small-scale proxies for large-scale Transformer instabilities (arXiv:2309.14322)<i class="fas fa-external-link-alt"></i></a></p><hr><h1>Comparison: Cosine vs WSD vs Schedule-Free</h1><table><thead><tr><th>Schedule</th><th>Pros</th><th>Cons</th><th>Best For</th></tr></thead><tbody><tr><td><strong>Cosine</strong></td><td>Simple, smooth, well-tested</td><td>Requires knowing<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewbox="0 -677 704 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g></g></svg></mjx-container> upfront</td><td>Fixed-length runs</td></tr><tr><td><strong>WSD</strong></td><td>Resumable, clear phases</td><td>Need to choose cooldown timing</td><td>Long/resumable training</td></tr><tr><td><strong>Schedule-Free</strong></td><td>No<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewbox="0 -677 704 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g></g></svg></mjx-container> needed, minimal tuning</td><td>Newer, less battle-tested</td><td>Research, variable budgets</td></tr></tbody></table><p><strong>Rule of thumb</strong>:</p><ul><li><strong>Fixed training budget</strong> → Cosine</li><li><strong>May resume/extend</strong> → WSD</li><li><strong>Prototyping / unknown budget</strong> → Schedule-Free</li></ul><hr><h1>Code: Implementing Warmup + Cosine and WSD</h1><h2 id="Warmup-Cosine-v2"><a class="header-anchor" href="#Warmup-Cosine-v2">¶</a>Warmup + Cosine</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lr_warmup_cosine</span>(<span class="params">step, total_steps, warmup_steps, lr_max, lr_min=<span class="number">0.0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> step &lt; warmup_steps:</span><br><span class="line">        <span class="comment"># Linear warmup</span></span><br><span class="line">        <span class="keyword">return</span> lr_max * (step + <span class="number">1</span>) / <span class="built_in">max</span>(<span class="number">1</span>, warmup_steps)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Cosine decay</span></span><br><span class="line">    t = step - warmup_steps</span><br><span class="line">    T = <span class="built_in">max</span>(<span class="number">1</span>, total_steps - warmup_steps)</span><br><span class="line">    cos = <span class="number">0.5</span> * (<span class="number">1.0</span> + math.cos(math.pi * t / T))</span><br><span class="line">    <span class="keyword">return</span> lr_min + (lr_max - lr_min) * cos</span><br></pre></td></tr></table></figure><h2 id="Warmup-Stable-Decay-WSD"><a class="header-anchor" href="#Warmup-Stable-Decay-WSD">¶</a>Warmup + Stable + Decay (WSD)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lr_wsd</span>(<span class="params">step, total_steps, warmup_steps, cooldown_steps, lr_max, lr_min=<span class="number">0.0</span></span>):</span><br><span class="line">    <span class="comment"># Warmup</span></span><br><span class="line">    <span class="keyword">if</span> step &lt; warmup_steps:</span><br><span class="line">        <span class="keyword">return</span> lr_max * (step + <span class="number">1</span>) / <span class="built_in">max</span>(<span class="number">1</span>, warmup_steps)</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Stable</span></span><br><span class="line">    stable_end = total_steps - cooldown_steps</span><br><span class="line">    <span class="keyword">if</span> step &lt; stable_end:</span><br><span class="line">        <span class="keyword">return</span> lr_max</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Cooldown (linear decay to lr_min)</span></span><br><span class="line">    t = step - stable_end</span><br><span class="line">    T = <span class="built_in">max</span>(<span class="number">1</span>, cooldown_steps)</span><br><span class="line">    frac = <span class="built_in">min</span>(<span class="number">1.0</span>, (t + <span class="number">1</span>) / T)</span><br><span class="line">    <span class="keyword">return</span> lr_max + (lr_min - lr_max) * frac</span><br></pre></td></tr></table></figure><h2 id="Usage-in-training-loop"><a class="header-anchor" href="#Usage-in-training-loop">¶</a>Usage in training loop</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_one_epoch</span>(<span class="params">model, loader, optimizer, step_offset, total_steps, schedule_fn, device=<span class="string">"cuda"</span></span>):</span><br><span class="line">    model.train()</span><br><span class="line">    step = step_offset</span><br><span class="line">    <span class="keyword">for</span> x, y <span class="keyword">in</span> loader:</span><br><span class="line">        x, y = x.to(device), y.to(device)</span><br><span class="line">    </span><br><span class="line">        lr = schedule_fn(step, total_steps)</span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            g[<span class="string">"lr"</span>] = lr</span><br><span class="line">    </span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        pred = model(x)</span><br><span class="line">        loss = torch.nn.functional.cross_entropy(pred, y)</span><br><span class="line">        loss.backward()</span><br><span class="line">    </span><br><span class="line">        <span class="comment"># Optional: gradient clipping (common for LLMs)</span></span><br><span class="line">        torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=<span class="number">1.0</span>)</span><br><span class="line">    </span><br><span class="line">        optimizer.step()</span><br><span class="line">        step += <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> step</span><br></pre></td></tr></table></figure><hr><h1>One-Page Cheat Sheet</h1><h2 id="AdamW-Default-Recipe"><a class="header-anchor" href="#AdamW-Default-Recipe">¶</a>AdamW Default Recipe</h2><ul><li><strong>Schedule</strong>: Warmup + cosine or warmup + WSD</li><li><strong>Warmup</strong>: 1-5% of total steps</li><li><strong>Cooldown</strong> (WSD): 10-20% of total steps</li><li><strong>Gradient clipping</strong>: <code>max_norm=1.0</code> (LLMs)</li><li><strong>Weight decay</strong>: 0.01-0.1 (tune with LR)</li></ul><h2 id="3-Key-Metrics-to-Monitor"><a class="header-anchor" href="#3-Key-Metrics-to-Monitor">¶</a>3 Key Metrics to Monitor</h2><ol><li><strong>Training stability</strong>: Watch for loss spikes / gradient norm explosions</li><li><strong>Effective step size</strong>: Is loss decreasing steadily or stuck?</li><li><strong>LR sensitivity</strong>: Small LR changes → big result changes = you’re near instability</li></ol><h2 id="When-to-Use-Cosine-vs-WSD"><a class="header-anchor" href="#When-to-Use-Cosine-vs-WSD">¶</a>When to Use Cosine vs WSD</h2><ul><li><strong>Fixed training length, no resume</strong>: Cosine (simple, robust)</li><li><strong>May extend training / multiple budgets</strong>: WSD (resumable)</li><li><strong>Want minimal tuning</strong>: Schedule-Free (research, prototyping)</li></ul><hr><h1>Summary: LR in 5 Steps</h1><ol><li><strong>Run LR range test</strong> → Find stability boundary</li><li><strong>Pick peak LR</strong> = 0.3-1× the “edge”</li><li><strong>Add warmup</strong> (1-5% steps, longer for LLMs)</li><li><strong>Choose schedule</strong> (Cosine for fixed, WSD for resumable)</li><li><strong>Couple with batch/weight decay</strong> (don’t tune LR in isolation)</li></ol><p><strong>Key hyperparameters</strong>:</p><ul><li>Peak LR (3e-4 typical for AdamW)</li><li>Warmup fraction (0.01-0.05)</li><li>Cooldown fraction (0.1-0.2 for WSD)</li></ul><p><strong>Common pitfalls</strong>:</p><ul><li>Immediate divergence → Lower LR, add warmup, clip gradients</li><li>Slow training → Raise LR (run range test), extend stable phase</li><li>High oscillation → Lower LR or momentum, add clipping</li></ul><p><strong>Further reading</strong>:</p><ul><li><a class="link" href="https://ai.meta.com/research/publications/learning-rate-free-learning-by-d-adaptation/">D-Adaptation (2023)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2405.15682">Schedule-Free AdamW (2024)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2406.09405">Why Warmup? (2024)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2408.13359">Power Scheduler (2024)<i class="fas fa-external-link-alt"></i></a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Learning rate (LR) is the knob that most often decides whether training &lt;strong&gt;converges&lt;/strong&gt;, &lt;strong&gt;crawls&lt;/strong&gt;, or &lt;strong&gt;blows up&lt;/strong&gt;. This post builds an actionable mental model—from the simplest quadratic loss to modern large-scale training recipes—so you can choose schedules (warmup/cosine/WSD), debug instability, and tune LR systematically. We cover the math (why “too big explodes, too small stalls”), practical workflows (LR range test, schedule selection), failure mode diagnosis, recent research (schedule-free, power scheduler, warmup theory), and a troubleshooting checklist for common issues.&lt;/p&gt;</summary>
    
    
    
    
    <category term="LLM" scheme="https://chenk.top/tags/LLM/"/>
    
    <category term="Optimization" scheme="https://chenk.top/tags/Optimization/"/>
    
    <category term="ML" scheme="https://chenk.top/tags/ML/"/>
    
    <category term="Deep Learning" scheme="https://chenk.top/tags/Deep-Learning/"/>
    
  </entry>
  
  <entry>
    <title>Linux 磁盘管理</title>
    <link href="https://chenk.top/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-17T16:00:00.000Z</published>
    <updated>2026-01-30T01:42:06.361Z</updated>
    
    <content type="html"><![CDATA[<p>磁盘相关的问题，很多时候不是“记几个命令”就能解决：分区表怎么选、文件系统怎么挂、扩容怎么尽量少停机、删文件为什么空间不立刻回来，背后都有明确的机制约束。本文从热/冷存储与磁盘结构切入，串起 RAID 与 LVM 的落地用法、MBR/GPT 分区与 <code>fdisk</code>/<code>gdisk</code> 的实际操作、格式化与挂载的完整流程，并补上 <code>/dev</code> 特殊设备、inode 与硬/软链接、文件删除原理这些最容易踩坑但又最“救命”的细节。读完你应该能按步骤把一块新盘从“识别—分区—格式化—挂载—扩容—排障”走通。</p><span id="more"></span><h1>网站存储</h1><p>数据存储是网站架构的一大重点，关于存储方案我们通常需要考虑硬件角度和软件角度，本文我们只关注硬件角度。</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/20210701123415976-1024x556.png" alt="img"></p><h2 id="1-存储层的设计"><a class="header-anchor" href="#1-存储层的设计">¶</a>1. 存储层的设计</h2><p><strong>热存储（Hot Storage）</strong>：存储需要频繁访问的数据。通常使用 SSD（固态硬盘），例如数据库存储。</p><ul><li>SSD 基于 NAND 闪存技术，具有更快的读写速度和更高的耐用性。</li><li>通过电子电荷存储数据，每个单元存储一个或多个比特的数据。</li><li>和顺序读写比起来，固态硬盘的随机读写慢不了多少，随件写入效率略微降低，随机读取能力也就下降一半左右。</li><li>固态硬盘写入数据前要对齐，所以有独特的 <code>trim</code> 指令。文件删除以后，操作系统会挑选空余时间自动执行 <code>trim</code>，而不是下次使用的时候再对齐，机械硬盘不需要对齐，直接覆盖就行了。所以机械硬盘的数据在没有覆盖之前都是可以恢复了，固态硬盘一般在回收站里面删除以后很快就执行了 <code>trim</code> 命令，几乎不能再恢复数据了。</li></ul><p><strong><a class="link" href="https://www.cnblogs.com/cxygg/p/16389505.html">冷存储<i class="fas fa-external-link-alt"></i></a>（Cold Storage）</strong>：用于长期存储访问频率低的数据。可以使用 HDD（机械硬盘）或分布式存储系统。</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/4f588e4702ddcda3b22aa8b231cbbc47.png" alt="机械硬盘结构"></p><ul><li><p>HDD 通过磁性盘片和磁头来读取和写入数据，硬盘存储设备和电磁有关因此也被称为磁盘：磁头在盘片上移动，通过磁性变化来写入和读取数据。机械硬盘里有很多张磁盘。</p></li><li><p>数据存储分为多个<strong>扇区</strong>和<strong>轨道</strong>。</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/1435314-20220619000212007-1461023647.webp" alt="img"></p><ul><li><p>一个磁盘里面有一到多个盘片，盘片可以可以单面或者双面的。单面盘片只有一个面有磁头，双面盘片两个面都有磁头。多盘片，双盘面的磁盘，是协同工作的，这时候他们机械臂的位置相同，盘面相对位置恒定，理论上多盘片之间可以相互配合共同读写，多盘片的硬盘，也并不会成倍的提升读写性能，大概只能归结于工艺原因，并不能做到多盘片协同工作。</p></li><li><p>一个扇区模默认大小是512字节，也就是 0.5KB。如下图，我们格式化硬盘的时候，可以指定分配单元大小，理论上一个分配单元最小值就是一个扇区。</p><p><img src="https://img2022.cnblogs.com/blog/1435314/202206/1435314-20220619000532622-448669195.png" alt="img"></p></li><li><p>操作系统的分配单元大小叫做簇（或者块 block），一个簇由一到多个连续扇区组成，一个文件只能被连续的存储在一个或者多个簇里面。比如我4K对齐(操作系统指定1个簇由8个扇区构成)，那么我即便有的文件只有1个字节，那么它也会占用4K的存储空间。</p></li><li><p>有时候我们文件显示存储空间是0，这是操作系统优化的结果，太小的文件，占用一个簇太浪费，我们可以公用区域存放，这个文件如果再大一点，或者公共区域放不下了，就会直接分配单独的一个簇存储。</p></li></ul></li><li><p>对机械硬盘而言，转速和缓存是高性能的指标</p><ul><li>常见的是 7200 rpm（转每分钟）+ 64 MB 的缓存配置</li><li>一些需要高负载和大型数据传输的高性能服务器会配置 10000 或 15000 rpm + 128 MB 甚至更高的缓存</li></ul></li><li><p>磁盘读写过程：</p><ul><li>通过地址确定需要读取的数据所在的磁道，和扇区。</li><li>机械摆臂移动磁头到指定磁道位置（等待机械结构移动）</li><li>等到磁盘扇区转到到磁头位置开始读取（等待机械结构转动）</li><li>如果数数据是在相邻扇区，或者相邻的蔟，那么就能连续的读取，这种叫做顺序读取</li><li>如果所需数据位于不同扇区，不同磁道，那么需要不断移动机械臂，和等待磁盘转动到指定扇区，这种就是随机读写。</li></ul><p>机械硬盘随机读写慢的原因主要就是两次等待机械机构移动到指定位置。摆臂移动时间大概是6-8毫秒，7200转的硬盘一秒钟转120圈，每圈时间8.3毫秒，平均半圈是4 毫秒的样子。所以7200转的机械银盘随机读取的平均延时在10多毫秒。机械硬盘顺序读写速度比随机读写快80倍以上，差异巨大。</p></li></ul><p><strong>对象存储</strong>：如 AWS S3、阿里云 OSS，用于存储大量不常访问的文件和数据。</p><ul><li>在 Hadoop 分布式文件系统（HDFS）中使用对象存储来处理大规模数据。</li></ul><h2 id="2-存储的数据备份（RAID磁盘阵列技术）"><a class="header-anchor" href="#2-存储的数据备份（RAID磁盘阵列技术）">¶</a>2. 存储的数据备份（RAID磁盘阵列技术）</h2><p>使用 <code>raid</code> 磁盘阵列技术进行磁盘备份，以保证数据安全性。</p><h3 id="RAID-的基本概念"><a class="header-anchor" href="#RAID-的基本概念">¶</a>RAID 的基本概念</h3><ul><li><strong>RAID（Redundant Array of Independent Disks）</strong>：将多个硬盘组合在一起形成一个逻辑单元，以提高数据冗余和/或性能。</li><li><strong>RAID 级别</strong>：<ul><li><strong>RAID 0</strong>：数据条带化，分布到多个磁盘上，提高读写性能，但没有冗余，单个磁盘故障将导致数据丢失。</li><li><strong>RAID 1</strong>：镜像，数据在两个磁盘上完全复制，提高数据安全性，但存储空间减半。</li><li><strong>RAID 5</strong>：条带化+奇偶校验，至少需要三块磁盘，具有数据冗余和较好的性能平衡。</li><li><strong>RAID 6</strong>：类似 RAID 5，但使用双重奇偶校验，可以容忍两块磁盘同时故障。</li><li><strong>RAID 10</strong>：结合 RAID 0 和 RAID 1，先进行镜像再条带化，提供高性能和冗余，但成本较高。</li></ul></li></ul><h3 id="软件-RAID（软-RAID）"><a class="header-anchor" href="#软件-RAID（软-RAID）">¶</a>软件 RAID（软 RAID）</h3><p>软件 RAID 是由操作系统通过软件实现 RAID 功能，而不是依赖硬件 RAID 控制器。常见工具包括 Linux 下的 <code>mdadm</code>。优点是：</p><ul><li>成本低，无需专用硬件。</li><li>灵活性高，可动态调整 RAID 配置。</li></ul><p>对应的缺点是占用 CPU 资源，对系统性能有一定影响（现代 CPU 通常能很好地应对）。</p><h3 id="软件-RAID-命令实践"><a class="header-anchor" href="#软件-RAID-命令实践">¶</a>软件 RAID 命令实践</h3><ul><li><p><strong>创建 RAID</strong>：例如，创建一个 RAID 1 镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1</span><br></pre></td></tr></table></figure><ul><li><code>/dev/md0</code>：新创建的 RAID 设备</li><li><code>--level=1</code>：指定 RAID 1（镜像）</li><li><code>--raid-devices=2</code>：使用两个磁盘分区</li><li><code>/dev/sda1 /dev/sdb1</code>：参与 RAID 的设备</li></ul></li><li><p><strong>查看 RAID 状态</strong>：使用如下命令检查 RAID 设备状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/mdstat</span><br></pre></td></tr></table></figure></li><li><p><strong>管理 RAID</strong>：添加、移除、重建等操作都可以使用 <code>mdadm</code> 进行管理。例如：</p><ul><li><p><strong>停止 RAID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --stop /dev/md0</span><br></pre></td></tr></table></figure></li><li><p><strong>移除设备</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm /dev/md0 --fail /dev/sda1 --remove /dev/sda1</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>配置文件</strong>：将 RAID 配置信息写入配置文件（如 <code>/etc/mdadm.conf</code>），以便系统启动时自动组装 RAID 设备：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --detail --scan &gt;&gt; /etc/mdadm.conf</span><br></pre></td></tr></table></figure></li></ul><h2 id="3-存储的数据扩容"><a class="header-anchor" href="#3-存储的数据扩容">¶</a>3. 存储的数据扩容</h2><p>磁盘的数据满了怎么办，需要涉及存储的设备扩容</p><ol><li>保证数据库数据完整的情况下，将用户数据迁移到另一个硬盘中</li><li>考虑到用户数据会不断增长，新磁盘采用 <code>lvm</code> 逻辑卷管理，方便日后动态扩容</li></ol><h3 id="扩容业务整体流程"><a class="header-anchor" href="#扩容业务整体流程">¶</a>扩容业务整体流程</h3><ol><li>需要一块新硬盘（虚拟机可添加）</li><li>新硬盘需要做 <code>lvm</code> 管理</li><li>数据库迁移（夜间停机维护，凌晨 2 点）<ul><li>停止数据库监控</li><li>停止前端（关闭前端数据入口，比如停用博客发表功能）：<code>systemctl stop apache</code></li><li>停止后端（可选）</li><li>停止 MySQL 数据库（防止数据还在写入，或者锁表）</li><li>备份数据库（全备）</li><li>迁移数据到新硬盘（使用 <code>rsync</code>【比 <code>cp</code> 命令更强大】），新硬盘已经做好了 <code>lvm</code>，且挂载好了</li><li>启动数据库</li><li>启动前端入口</li><li>测试数据读写</li><li>博客功能重新恢复上线</li><li>开启数据库监控</li></ul></li></ol><h3 id="lvm-技术"><a class="header-anchor" href="#lvm-技术">¶</a><code>lvm</code> 技术</h3><p>LVM（逻辑卷管理器，Logical Volume Manager）是一种将物理存储设备抽象为逻辑存储单元的技术，允许系统管理员更加灵活地管理存储设备。与传统的分区方式（如直接将磁盘划分为固定大小的分区）不同，LVM 提供了更高的灵活性，能够在系统运行时动态地调整存储空间。</p><p>LVM 技术包括以下几个核心概念：</p><p><strong>物理卷（Physical Volume, PV）</strong></p><p>物理卷是 LVM 中的最底层存储单元，通常是磁盘或者磁盘分区。LVM 会将一个或多个物理卷组织在一起，形成一个“卷组”（Volume Group，VG）。物理卷不一定是整个磁盘，可以是磁盘的一个分区，也可以是整个磁盘。</p><p>创建物理卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/sdb1  <span class="comment"># 创建一个物理卷</span></span><br></pre></td></tr></table></figure><p><strong>卷组（Volume Group, VG）</strong></p><p>卷组是由多个物理卷组成的逻辑容器。它可以将多个物理卷中的存储空间汇聚到一起，形成一个大的池，供逻辑卷使用。一个卷组可以包含多个物理卷，也可以只有一个物理卷。</p><p>创建卷组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgcreate my_volume_group /dev/sdb1 /dev/sdc1  <span class="comment"># 创建一个卷组，包含 /dev/sdb1 和 /dev/sdc1</span></span><br></pre></td></tr></table></figure><p><strong>逻辑卷（Logical Volume, LV）</strong></p><p>逻辑卷是实际存储数据的地方，它类似于传统分区。逻辑卷是从卷组中分配的存储空间，可以根据需要进行扩展或缩减。LVM 提供了动态创建、删除和调整逻辑卷大小的能力。</p><p>创建逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 10G -n my_logical_volume my_volume_group  <span class="comment"># 创建一个大小为10GB的逻辑卷</span></span><br></pre></td></tr></table></figure><p><strong>逻辑卷的扩展与收缩</strong></p><p>LVM 允许在逻辑卷中增加或减少存储空间。对于增加存储空间，可以将新的物理卷加入到卷组中，并扩展逻辑卷的大小；对于减少存储空间，需要先对文件系统进行缩减，确保数据的安全。</p><p>扩展逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvextend -L +5G /dev/my_volume_group/my_logical_volume  <span class="comment"># 将逻辑卷扩展5GB</span></span><br><span class="line">resize2fs /dev/my_volume_group/my_logical_volume  <span class="comment"># 调整文件系统的大小</span></span><br></pre></td></tr></table></figure><p>缩小逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e2fsck -f /dev/my_volume_group/my_logical_volume  <span class="comment"># 检查文件系统</span></span><br><span class="line">resize2fs /dev/my_volume_group/my_logical_volume 5G  <span class="comment"># 调整文件系统大小到5GB</span></span><br><span class="line">lvreduce -L 5G /dev/my_volume_group/my_logical_volume  <span class="comment"># 缩小逻辑卷</span></span><br></pre></td></tr></table></figure><p><strong>快照（Snapshot）</strong></p><p>LVM 还支持创建快照。快照是某个逻辑卷的时间点副本，可以用于数据备份或在对逻辑卷进行修改之前进行保护。快照是增量的，仅记录自创建快照以来的变化。</p><p>创建和删除快照：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 1G -s -n my_snapshot /dev/my_volume_group/my_logical_volume  <span class="comment"># 创建快照</span></span><br><span class="line">lvremove /dev/my_volume_group/my_snapshot  <span class="comment"># 删除快照</span></span><br></pre></td></tr></table></figure><p><strong>LVM 的优点</strong></p><ul><li><strong>灵活性</strong>：可以动态增加、缩小卷的大小，无需重新分区和格式化磁盘。</li><li><strong>卷扩展性</strong>：可以将多个物理卷合并为一个卷组，增加存储池的空间。</li><li><strong>数据保护</strong>：通过快照功能，可以在修改数据之前创建数据副本，保护数据不被误删。</li><li><strong>性能优化</strong>：LVM 支持多种策略，如镜像（Mirroring）、条带化（Striping）等，来提高性能或容错性。</li></ul><p><strong>LVM 的常用命令</strong></p><p>查看物理卷、卷组、逻辑卷的状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pvs  <span class="comment"># 查看物理卷</span></span><br><span class="line">vgs  <span class="comment"># 查看卷组</span></span><br><span class="line">lvs  <span class="comment"># 查看逻辑卷</span></span><br></pre></td></tr></table></figure><p>删除物理卷、卷组、逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lvremove /dev/my_volume_group/my_logical_volume  <span class="comment"># 删除逻辑卷</span></span><br><span class="line">vgremove my_volume_group  <span class="comment"># 删除卷组</span></span><br><span class="line">pvremove /dev/sdb1  <span class="comment"># 删除物理卷</span></span><br></pre></td></tr></table></figure><p>将物理卷加入卷组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgextend my_volume_group /dev/sdd1  <span class="comment"># 向卷组添加物理卷</span></span><br></pre></td></tr></table></figure><p>移除物理卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgreduce my_volume_group /dev/sdb1  <span class="comment"># 从卷组中移除物理卷</span></span><br></pre></td></tr></table></figure><hr><p>举个例子，在 Mac 系统上，<strong>硬盘空间的增加</strong>会被自动识别为新的分区或逻辑卷（LVM），而不需要手动进行分区。</p><p>我们可以首先进行硬盘空间分配来验证之（注意这里的硬盘空间分配了之后，主机的硬盘空间不会立刻少这么多，而是慢慢减少直到用满了这新增的空间）。</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250214204528744.png" alt="image-20250214204528744"></p><p>然后我们查看 <code>lablk</code>：</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250218010311167.png" alt="image-20250218010311167"></p><p><strong>nvme0n1 硬盘</strong>是我的物理硬盘，大小为 50GB。这个硬盘上有三个分区：</p><ul><li>/dev/nvme0n1p1：EFI 系统分区，大小 953MB。</li><li>/dev/nvme0n1p2：启动分区，大小 1.8GB。</li><li>/dev/nvme0n1p3：剩余的分区，大小 45.3GB。<ul><li>在 /dev/nvme0n1p3 上，系统使用了 LVM，具体来说是 <strong>ubuntu–vg-ubuntu–lv</strong> 这个逻辑卷，大小为 45.3GB，挂载在 /（根目录）下。</li><li>当我们增加硬盘空间时，<strong>LVM</strong>（逻辑卷管理）在已经有的物理分区（如 /dev/nvme0n1p3）上自动扩展了空间。因此我们无需手动分区，LVM 可以动态调整卷的大小以适应新加入的空间。</li><li><strong>LVM</strong> 使得我们可以动态管理存储，不需要像传统的分区方式那样手动分区。</li></ul></li></ul><p>进一步地，我们可以通过 lvdisplay 命令查看逻辑卷的详细信息，确认新的硬盘空间是否已正确分配给逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lvdisplay</span></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ubuntu-vg/ubuntu-lv</span><br><span class="line">  LV Name                ubuntu-lv</span><br><span class="line">  VG Name                ubuntu-vg</span><br><span class="line">  LV UUID                ZtYUOm-9g6w-j6i3-fnJu-Bqly-BtYQ-s3dRWH</span><br><span class="line">  LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line">  LV Creation host, time ubuntu-server, 2025-01-12 03:55:17 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  <span class="comment"># open                 1</span></span><br><span class="line">  LV Size                &lt;45.32 GiB</span><br><span class="line">  Current LE             11601</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently <span class="built_in">set</span> to     256</span><br><span class="line">  Block device           252:0</span><br></pre></td></tr></table></figure><h1>磁盘管理业务背景与流程</h1><p>磁盘管理确保硬件存储的健康和可靠性。磁盘的使用涉及到磁盘健康监控、备份、恢复等多个方面。我们可以与 Windows 的磁盘管理做一个对比，在 Windows 系统中，磁盘的管理包括分区、格式化、磁盘检查等。</p><ul><li><strong>磁盘分区</strong>：可以通过“磁盘管理”工具创建、删除、格式化磁盘分区。</li><li><strong>磁盘碎片整理</strong>：Windows 提供磁盘碎片整理工具。</li><li><strong>查看磁盘信息：</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">diskpart  <span class="comment"># 启动磁盘管理工具</span></span><br><span class="line">list disk  <span class="comment"># 列出所有磁盘</span></span><br></pre></td></tr></table></figure><p>在 Linux 下，具体的内容为：</p><ol><li><p><strong>硬盘健康检查</strong>：定期运行 <code>smartctl</code> 检查硬盘状态，提前发现潜在问题，如坏道、读写错误等。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smartctl -a /dev/sda  <span class="comment"># 查看硬盘健康状态</span></span><br><span class="line">   <span class="built_in">df</span> -h  <span class="comment"># 显示磁盘空间使用情况</span></span><br></pre></td></tr></table></figure><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250213152728125.png" alt="image-20250213152728125"></p></li><li><p><strong>磁盘碎片整理</strong>：对于机械硬盘（HDD），我们可以使用工具如 <code>bleachbit</code> 或 <code>ncdu</code> 进行磁盘清理，释放磁盘空间。并使用 <code>e4defrag</code> 碎片整理工具进行整理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e4defrag /dev/sda  <span class="comment"># 对 /dev/sda 分区进行碎片整理</span></span><br></pre></td></tr></table></figure></li><li><p><strong>数据备份与恢复</strong>：使用工具如 <code>rsync</code> 或 <code>tar</code> 进行定期备份。</p></li></ol><h1>磁盘使用流程</h1><p>磁盘在计算机中是用来存储数据的设备，磁盘的使用包括挂载、分区以及对文件系统的访问。Linux 系统中的磁盘挂载是磁盘和文件系统连接的过程，Linux 系统通过挂载将磁盘分区与文件系统连接，使得用户可以通过路径访问磁盘上的文件。</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/3baffb6c16dc43cc92b87baad5700594.png" alt="关于Linux中卷/分区等知识的一些总结-云社区-华为云"></p><p>我们可以将磁盘从被识别到可以使用的过程与实际生活中房子类比：</p><ol><li><strong>磁盘准备存储数据</strong>：类比为人盖房子。磁盘需要在计算机系统中准备好，才能进行数据存储。</li><li><strong>磁盘分区</strong>：类比为房子改好后需要隔断。磁盘需要分区，才能将磁盘空间划分为不同的区域（例如：卧室、厨房、卫生间等），不同区域用于存储不同类型的数据。</li><li><strong>磁盘格式化与创建文件系统</strong>：类比为房子装修。分区后，磁盘还需要格式化并创建文件系统，不同的文件系统有不同的功能和用途，就像房子的装修风格（欧式、中式等）决定了居住体验。</li><li><strong>磁盘挂载到文件夹</strong>：类比为安装门窗，确保进出。格式化并创建文件系统后，磁盘需要挂载到系统的文件夹中，才能通过操作系统进行数据存储和读取，就像房子需要安装门窗才能与外界沟通。</li></ol><h2 id="1-磁盘分区"><a class="header-anchor" href="#1-磁盘分区">¶</a>1. 磁盘分区</h2><p>分区方案指的是磁盘布局的特定基础结构、分区的实际排列方式、功能以及限制。</p><table><thead><tr><th>特性</th><th>MBR（主引导记录）</th><th>GPT（GUID 分区表）</th></tr></thead><tbody><tr><td><strong>最大存储空间</strong></td><td>最大支持 2TB</td><td>支持大于 2TB，最大支持 9.4ZB（远超当前硬盘技术）</td></tr><tr><td><strong>最大分区数量</strong></td><td>最多支持 4 个主分区，或 3 个主分区 + 1 个扩展分区</td><td>最多支持 128 个主分区</td></tr><tr><td><strong>分区表大小</strong></td><td>固定为 512 字节</td><td>可自定义，支持更大规模的分区表</td></tr><tr><td><strong>冗余与备份</strong></td><td>无冗余备份，一旦损坏可能导致数据丢失</td><td>提供冗余备份，分区表存储在磁盘的开始和结尾部分</td></tr><tr><td><strong>支持的引导模式</strong></td><td>传统 BIOS 引导模式</td><td>与 UEFI 配合使用，支持更现代的引导方式</td></tr><tr><td><strong>操作系统兼容性</strong></td><td>支持所有 32 位和 64 位 Windows 操作系统</td><td>支持大多数 Windows 版本，但需要 UEFI 支持</td></tr><tr><td><strong>使用场景</strong></td><td>适用于小容量磁盘（2TB 以下）和老旧系统</td><td>适用于大容量磁盘（2TB 以上）和现代系统</td></tr><tr><td><strong>系统安装和维护</strong></td><td>适合传统的磁盘管理方式</td><td>支持多重操作系统安装和复杂的硬件配置</td></tr></tbody></table><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/Difference-between-MBR-and-GPT.png" alt="Difference between MBR and GPTMustBeGeek"></p><h3 id="MBR"><a class="header-anchor" href="#MBR">¶</a>MBR</h3><p>MBR （master boot record - 主引导记录）支持最多 4 个主分区（3 个主分区+1 个扩展分区），最大支持 2 TB 的磁盘。</p><p><img src="https://i-blog.csdnimg.cn/blog_migrate/d17d97002fe76459d24b269d44c4c9e8.png" alt="MBR、主引导扇区，主分区、扩展分区、逻辑分区，活动分区、引导分区、系统分区、启动分区_活动分区和引导分区-CSDN博客"></p><ul><li>简单来说，MBR 是磁盘里的第一个扇区，作用是告诉操作系统怎么加载磁盘顺序，如何开机</li><li>优点是兼容性好，缺点是不支持管理大硬盘结构。对于大于 2TB 的硬盘，MBR 会无法识别，导致硬盘空间浪费。这是因为 MBR 使用 32 位寻址方式，限制了可寻址的空间。</li><li>主引导扇区位于整个磁盘的 0 磁头 0 柱头 1 扇面，包括硬盘主引导记录 MBR 和分区表 DPT（Disk Partition Table）。主引导记录用于检查分区表是否正确以及哪个分区为引导分区，也就是操作系统引导扇区调入内存加以执行。</li></ul><p>从原理上说：</p><ol><li>MBR分区方案使用硬盘的第一个物理扇区中的 64 个字节作为分区表的空间保存硬盘分区信息，每个分区的信息要占 16 个字节。所以，MBR分区表最多只能保存4个分区的分区信息。</li><li>MBR分区方案中，有三种类型的分区，主分区、扩展分区和逻辑分区。扩展分区与逻辑分区是为了突破分区表中只能保存 4 个分区的限制而出现的</li><li>MBR分区表中保存的分区信息都是主分区与扩展分区的分区信息，扩展分区不能直接使用，需要在扩展分区内划分一个或多个逻辑分区后才能使用，逻辑分区的分区信息保存在扩展分区内，而不是保存在 MBR 分区表内，这样就可以突破 MBR 分区表只能保存 4 个分区的限制。</li><li>16 个字节的分区信息保存有分区活动状态标志、文件系统标识、起止柱面号、磁头号、扇区号、起始扇区位置（4 个字节）、分区总扇区数目（4 个字节）等内容。这里最重要的是：分区的起始扇区位置与分区的总扇区数，都是用 4 个字节表示的。一般每个廓区的容量是 512 字节，4 个字节的扇区能表示的最大容量是 2 TB，由此可知，在 MBR 分区表中，分区的起始位置不能大于 2 TB，分区的最大容量，也不能大于 2 TB，所以，对 2 TB 以上容量的物理硬盘，不适合使用MBR分区方案。</li></ol><h3 id="GPT"><a class="header-anchor" href="#GPT">¶</a>GPT</h3><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/gpt-partition.png" alt="2.6. GUID 分区表| Red Hat Product Documentation"></p><p>GPT（GUID 分区表）可以给超过 2 TB 的硬盘使用，支持更多分区（最多 128 个），且没有大小限制。GPT 使用 64 位寻址方式，支持最大 9.4ZB（zettabytes）的硬盘空间，远超当前硬盘技术的需求。</p><p><strong>新购电脑的主板类型</strong>：</p><ul><li>如果电脑使用传统的 <strong>BIOS</strong> 主板，建议使用 <strong>MBR</strong> 格式。</li><li>如果电脑使用现代的 <strong>UEFI</strong> 主板，建议使用 <strong>GPT</strong> 格式。UEFI 模式可以更好地支持 GPT，提供更快速、更安全的启动过程。</li></ul><p><strong>重装操作系统时的兼容性</strong>：</p><ul><li>在重装操作系统前，了解所安装的操作系统版本是否支持 MBR 或者 UEFI 模式（即 GPT 格式）。大多数操作系统，特别是 Windows 7 及以后的版本，都支持 GPT 格式，但老旧版本的 Windows（如 XP）可能不支持 GPT。</li><li><strong>注意</strong>：虽然 MBR 格式支持大部分操作系统版本，但并非所有 Windows 版本都兼容 GPT 格式。例如，Windows XP 不支持 GPT，而 Windows 10 和 Windows 11 则完全支持 GPT 格式，尤其是在 UEFI 启动模式下。</li></ul><p><strong>磁盘类型选择</strong>：</p><ul><li>对于传统硬盘（HDD）和容量较小（2TB 以下）的硬盘，使用 MBR 可以满足基本需求。</li><li>对于大容量硬盘（大于 2TB），SSD，以及希望获得更高可靠性和灵活性的用户，使用 GPT 是更优的选择。</li></ul><p><strong>系统安装和维护</strong>：</p><ul><li>如果计划使用 RAID、加密、或者多重操作系统的安装，GPT 格式会提供更多的优势，尤其是在支持 UEFI 的系统上。</li><li>由于 GPT 格式支持更多的分区，它适合多重操作系统的安装或大型磁盘的管理。</li></ul><h3 id="fdisk-和-gdisk"><a class="header-anchor" href="#fdisk-和-gdisk">¶</a><code>fdisk</code> 和 <code>gdisk</code></h3><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221115341740.png" alt="image-20250221115341740"></p><p><code>fdisk</code> 是管理 MBR 分区表的命令行工具，常用来创建、删除和修改分区。常见操作是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新分区</span></span><br><span class="line">fdisk /dev/sda  <span class="comment"># 对 /dev/sda 硬盘进行操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前分区</span></span><br><span class="line">fdisk -l  <span class="comment"># 列出所有磁盘和分区</span></span><br></pre></td></tr></table></figure><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250218233923991.png" alt="image-20250218233923991"></p><p>我的系统显示是 <code>GPT</code> 类型，因此不支持 <code>fdisk</code> 分区，需要用到 <code>gdisk</code>。<code>gdisk</code> 是一个用于 GPT 分区表的工具，适用于支持 UEFI 启动的系统。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新分区</span></span><br><span class="line">gdisk /dev/sda  <span class="comment"># 对 /dev/sda 硬盘进行 GPT 分区操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前分区</span></span><br><span class="line">gdisk -l /dev/sda  <span class="comment"># 列出 GPT 分区表</span></span><br></pre></td></tr></table></figure><p>要将分区类型做修改，可以参考如下操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mbr ----&gt; gpt</span></span><br><span class="line">parted /dev/sdc1</span><br><span class="line">mktable gpt</span><br><span class="line"></span><br><span class="line"><span class="comment"># gpt -----&gt; mbr</span></span><br><span class="line">parted /dev/sdc1</span><br><span class="line">mktable msdos</span><br></pre></td></tr></table></figure><h3 id="硬盘接口与命名规则"><a class="header-anchor" href="#硬盘接口与命名规则">¶</a>硬盘接口与命名规则</h3><p>在 Linux 系统中，磁盘设备的命名规则通常采用 <code>/dev/sdX</code> 或 <code>/dev/nvmeX</code> 的格式。</p><p><strong>常见命名规则：</strong></p><ul><li><strong>/dev/sda</strong>：第一个 SATA 硬盘</li><li><strong>/dev/nvme0n1</strong>：第一个 NVMe 固态硬盘</li><li><strong>/dev/sr0</strong>：光盘驱动器</li></ul><p>更具体一点的命名规则其实得追溯到硬盘接口</p><p>硬盘接口主要分为以下几种：</p><ul><li><strong>SATA</strong>：常见的消费级接口，速度适中，广泛使用。</li><li><strong>SAS</strong>：企业级接口，速度较快且稳定性好，常用于服务器。SAS 比 SATA 多了一个金手指。</li><li><strong>NVMe</strong>：最现代的存储接口，专为固态硬盘设计，提供超高速数据传输。</li><li><strong>PCIe</strong>：不仅适用于硬盘，还用于显卡等高性能设备，是一个高速的通用接口。</li><li><strong>IDE</strong>：老旧的接口，现已几乎完全被 SATA 替代。</li><li><strong>U.2 和 M.2</strong>：适用于现代高性能固态硬盘，M.2 更适合笔记本，U.2 多用于企业级 SSD。</li></ul><p><img src="https://picx.zhimg.com/80/v2-0b265dff6192f6bbeef41084d8e55da3.png" alt="固态硬盘接口有哪几种如何选择合适的SSD接口-墨铺"></p><table><thead><tr><th>接口类型</th><th>数据传输速度</th><th>主要特点</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>SATA (Serial ATA)</strong></td><td>最高 6Gb/s</td><td>- 最常见的硬盘接口，适用于台式机和笔记本<br>- 适合机械硬盘和一些固态硬盘</td><td>适用于大多数消费级硬盘，兼容性好</td></tr><tr><td><strong>SAS (Serial Attached SCSI)</strong></td><td>最高 12Gb/s</td><td>- 专为企业级存储设计，支持多设备连接<br>- 提供更高的稳定性和可靠性</td><td>企业级存储，服务器，数据中心</td></tr><tr><td><strong>NVMe (Non-Volatile Memory Express)</strong></td><td>最高 32Gb/s</td><td>- 基于 PCIe，总线速度更快<br>- 主要用于固态硬盘，低延迟</td><td>高性能计算、大型数据应用、游戏</td></tr><tr><td><strong>PCIe (Peripheral Component Interconnect Express)</strong></td><td>取决于版本，最大可达 64Gb/s（PCIe 4.0 x16）</td><td>- 高速数据传输接口，用于显卡、存储设备等<br>- 非常适合高性能存储设备</td><td>高端工作站、服务器、快速 SSD 存储</td></tr><tr><td><strong>IDE (Integrated Drive Electronics)</strong></td><td>最高 133MB/s</td><td>- 较老的硬盘接口，速度较慢<br>- 现已被 SATA 取代</td><td>主要用于老旧设备，不推荐用于现代系统</td></tr><tr><td><strong>U.2 (previously SFF-8639)</strong></td><td>最高 32Gb/s</td><td>- 连接方式类似于 SATA，但基于 PCIe 协议<br>- 用于高性能企业级固态硬盘</td><td>企业级 SSD，数据中心、高端服务器</td></tr><tr><td><strong>M.2</strong></td><td>最高 32Gb/s (取决于协议，如 SATA 或 PCIe)</td><td>- 小型接口，用于笔记本、主板上<br>- 支持 SATA 和 NVMe 协议</td><td>笔记本电脑、主板上的固态硬盘</td></tr></tbody></table><p>硬盘在不同操作系统和不同接口类型中有不同的命名规则，主要依赖于硬盘的接口类型、顺序以及分区情况。以下是一些常见的命名规则和详细说明。</p><table><thead><tr><th>操作系统</th><th>硬盘命名规则</th><th>描述</th></tr></thead><tbody><tr><td><strong>Linux (RHEL)</strong></td><td><code>/dev/hda</code>, <code>/dev/sda</code></td><td>- <strong>/dev/hda</strong>：IDE 接口硬盘（早期版本）<br>- <strong>/dev/sda</strong>：SATA 或 SCSI 接口硬盘</td></tr><tr><td><strong>IDE 接口</strong></td><td><code>/dev/hda</code></td><td>IDE 接口的硬盘，较旧的命名方式</td></tr><tr><td><strong>SATA 接口</strong></td><td><code>/dev/sda</code>, <code>/dev/sdb</code></td><td>SATA 接口硬盘命名规则，<code>a</code> 为第一块硬盘，<code>b</code> 为第二块硬盘</td></tr><tr><td><strong>SCSI 接口</strong></td><td><code>/dev/sda</code>, <code>/dev/sdb</code></td><td>SCSI 接口硬盘命名，类似 SATA，但在服务器环境中常见</td></tr><tr><td><strong>多块硬盘</strong></td><td><code>/dev/sda1</code>, <code>/dev/sdb1</code></td><td>多块硬盘时，根据硬盘顺序命名，如第一块硬盘为 <code>/dev/sda</code>，第二块为 <code>/dev/sdb</code>，每个硬盘的分区由数字表示，<code>/dev/sda1</code> 表示第一块硬盘的第一个分区</td></tr><tr><td>惠普服务器硬盘</td><td><code>/dev/cciss/c0d0</code>,<br><code>/dev/cciss/c0d0p1</code>,<br><code>/dev/cciss/c0d0p2</code></td><td></td></tr><tr><td>虚拟硬盘</td><td><code>/dev/vd</code></td><td>阿里云服务器等可能会用</td></tr></tbody></table><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250214114911032.png" alt="image-20250214114911032"></p><p>总结来说：</p><ul><li><p><strong>硬盘命名</strong>：硬盘的名字通常由接口类型（如 SATA、SCSI）、硬盘的顺序（<code>a</code>, <code>b</code>, <code>c</code> 等）以及分区编号组成。</p><ul><li><code>/dev/sda</code>：第一块硬盘。</li><li><code>/dev/sdb</code>：第二块硬盘。</li><li><code>/dev/sdc</code>：第三块硬盘。</li><li>以此类推，字母递增。</li></ul></li><li><p><strong>分区命名</strong>：每个硬盘上的分区通过数字表示：</p><ul><li><code>/dev/sda1</code>：第一块硬盘的第一个分区。</li><li><code>/dev/sda2</code>：第一块硬盘的第二个分区。</li><li><code>/dev/sda3</code>：第一块硬盘的第三个分区。</li><li><code>/dev/sda4</code>：第一块硬盘的第四个分区。</li></ul></li></ul><blockquote><p>虚拟硬盘格式：</p><table><thead><tr><th>格式</th><th>描述</th><th>主要应用</th></tr></thead><tbody><tr><td><strong>VMDK</strong></td><td>VMware 使用的虚拟硬盘格式。它能够模拟物理硬盘的特性，用于 VMware 虚拟机中。</td><td>VMware 虚拟化平台</td></tr><tr><td><strong>VHD</strong></td><td>Microsoft 的虚拟硬盘格式，支持微软 Hyper-V 虚拟化平台。</td><td>Hyper-V 虚拟化平台</td></tr><tr><td><strong>VHDX</strong></td><td>VHD 的增强版本，支持更大的虚拟硬盘和更高的可靠性。</td><td>Hyper-V 虚拟化平台</td></tr><tr><td><strong>QCOW2</strong></td><td>QEMU 的虚拟硬盘格式，支持快照和压缩，适用于 KVM 和 QEMU 虚拟机。</td><td>QEMU/KVM 虚拟化平台</td></tr><tr><td><strong>VDI</strong></td><td>VirtualBox 使用的虚拟硬盘格式。</td><td>VirtualBox 虚拟化平台</td></tr></tbody></table></blockquote><p>在 Windows 中，硬盘分区命名类似：</p><ul><li><strong>C:</strong> 代表硬盘的第一个分区（通常是操作系统分区）。</li><li><strong>D:</strong> 代表第二个分区。</li><li><strong>E:</strong> 代表第三个分区。</li><li><strong>F:</strong> 代表第四个分区。</li></ul><p>这和 Linux 中的硬盘命名规则 <code>/dev/sda1</code>, <code>/dev/sda2</code> 等相对应。</p><h2 id="2-格式化文件系统"><a class="header-anchor" href="#2-格式化文件系统">¶</a>2. 格式化文件系统</h2><p>常见的文件系统有 EXT4、XFS 和 NTFS 等，可以对分区在格式化的时候进行选择：</p><ul><li><strong>EXT4</strong>：Linux 常用的文件系统，支持大文件和较高的性能。</li><li><strong>XFS</strong>：高性能文件系统，常用于大型数据库和大规模存储。</li><li><strong>NTFS</strong>：Windows 操作系统的标准文件系统，支持文件压缩、加密等功能。</li><li><strong>ExFAT</strong>：MacOS下的文件系统，在 MacOS和Windows之间都可以读写</li></ul><table><thead><tr><th>文件系统</th><th>最大分区</th><th>最大文件</th><th>支持的操作系统</th><th>备注</th></tr></thead><tbody><tr><td>FAT32</td><td>128GB</td><td>4GB</td><td>Windows, Linux, Mac, 其他</td><td>适用于U盘和老旧设备，不支持大文件和大分区</td></tr><tr><td>NTFS</td><td>2TB</td><td>2TB</td><td>Windows, Linux (通过第三方软件支持)</td><td>常用于Windows操作系统，支持较大的文件和分区</td></tr><tr><td>FAT16</td><td>2GB</td><td>2GB</td><td>Windows, Linux, 其他</td><td>较老的文件系统，适合小容量设备，常见于早期的Windows版本</td></tr><tr><td>HPFS</td><td>2TB</td><td>2GB</td><td>OS/2</td><td>主要用于OS/2系统，适合较大的分区和文件</td></tr><tr><td>EXT2</td><td>4TB</td><td>2GB</td><td>Linux</td><td>早期Linux的标准文件系统，支持大文件，但没有日志功能</td></tr><tr><td>EXT3</td><td>4TB</td><td>2GB</td><td>Linux</td><td>EXT2的升级版，加入了日志功能，提高了可靠性</td></tr><tr><td>JFS</td><td>4PB</td><td>4PB</td><td>AIX</td><td>高性能文件系统，常用于大型企业级服务器，支持极大分区和文件大小</td></tr><tr><td>XFS</td><td>9EB（2^63）</td><td>9EB（2^63）</td><td>IRIX, Linux</td><td>64位文件系统，支持非常大的分区和文件，常用于高性能和大数据场景</td></tr><tr><td>exFAT</td><td>无限制（但实际应用中通常为256TB）</td><td>16EB</td><td>Windows, Mac, Linux (通过第三方软件支持)</td><td>适合闪存和移动存储设备，克服了FAT32的文件大小限制，不适合磁盘存储</td></tr></tbody></table><p>CentOS 4/5/6 都采用 Ext 2/3/4 文件系统，到了 CentOS 7 采用了 XFS 系统，因为 CentOS 7 是容器的时代，docker 不支持原来的文件系统。但都支持日志系统，日志系统指的是不会因为突然断电造成磁盘数据损坏，能够通过日志恢复磁盘文件。</p><p>Windows 10 使用 NTFS，支持加密、压缩、权限控制等等，且还支持日志保持数据一致性，主流硬盘都是 NTFS，专门给闪存使用的 ExFAT 属于是 FAT32 和 NTFS 的折中，同时支持 Windows 和 Mac。</p><p>不同的文件系统区别在于</p><ul><li>兼容性：不同系统平台不一定识别，可能无法进行读写操作。例如 Windows 上可能无法读取 XFS 文件系统的 U 盘；</li><li>容量大小：不同的文件系统对分区容量的支持以及文件数量及单个文件的容量支持有区别。例如以前的 Windows 机械硬盘使用 FAT32 文件系统，该文件系统不支持单个文件超过 4G。</li></ul><p>可以通过 <code>mkfs</code> 然后 TAB 查看当前支持什么操作系统（实际上这个是进行分区文件系统格式化的命令）：</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221234934355.png" alt="image-20250221234934355"></p><p>以 <code>mkfs.xfs</code> 为例：</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221235819691.png" alt="image-20250221235819691"></p><h2 id="3-挂载目录到分区"><a class="header-anchor" href="#3-挂载目录到分区">¶</a>3. 挂载目录到分区</h2><h4 id="什么是挂载（Mount）？"><a class="header-anchor" href="#什么是挂载（Mount）？">¶</a>什么是挂载（Mount）？</h4><p>想象你的电脑是一个大房子，房子里有很多房间（文件夹），比如 <code>/home</code>（你的卧室）、<code>/etc</code>（工具箱）等。但房子里原本没有连接外部设备（比如U盘、硬盘、光盘）。<strong>挂载</strong>就像是在墙上开一扇门，把外部设备（比如U盘）连接到房子的某个房间（比如 <code>/mnt/usb</code>），这样你就能通过这个房间访问外部设备的内容。</p><ul><li><strong>设备</strong>：U盘、硬盘、光盘等（物理存储介质）。</li><li><strong>挂载点</strong>：房子里的一扇门（比如 <code>/mnt/usb</code> 这个空文件夹）。</li><li><strong>挂载操作</strong>：把设备通过这扇门连接到房子。</li></ul><h4 id="挂载的基本操作"><a class="header-anchor" href="#挂载的基本操作">¶</a><strong>挂载的基本操作</strong></h4><p>假设你插入一个U盘，系统识别它为 <code>/dev/sdb1</code>（设备名可能不同）。你要把它挂载到 <code>/mnt/usb</code> 这个空文件夹：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb1 /mnt/usb</span><br></pre></td></tr></table></figure><p>其结果就是我们进入 <code>/mnt/usb</code> 就能看到U盘里的文件。但要注意，当我们挂载后，<code>/mnt/usb</code> 不再是普通文件夹，而是U盘的“入口”。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo umount /mnt/usb</span><br></pre></td></tr></table></figure><p>卸载后，<code>/mnt/usb</code> 恢复成普通空文件夹，U盘可以安全拔出。</p><h4 id="挂载后新建的文件在哪？"><a class="header-anchor" href="#挂载后新建的文件在哪？">¶</a><strong>挂载后新建的文件在哪？</strong></h4><p><strong>场景1：挂载后创建文件</strong></p><ol><li>挂载U盘到 <code>/mnt/usb</code>。</li><li>在 <code>/mnt/usb</code> 新建文件 <code>test.txt</code>。</li><li>卸载U盘。</li></ol><p><strong>问题</strong>：<code>test.txt</code> 存在哪里？<br><strong>答案</strong>：文件实际保存在U盘中！卸载后，文件依然在U盘里，下次挂载还能看到。</p><p><strong>场景2：换一个挂载点</strong></p><ol><li>将U盘挂载到 <code>/mnt/usb</code>，创建文件 <code>test.txt</code>。</li><li>卸载后，重新挂载到 <code>/media/myusb</code>。</li><li>进入 <code>/media/myusb</code>，依然能看到 <code>test.txt</code>。</li></ol><p><strong>结论</strong>：文件存储在设备（U盘）中，和挂载点无关。换挂载点只是换了一个“入口”。</p><h4 id="挂载点原有内容会怎样？"><a class="header-anchor" href="#挂载点原有内容会怎样？">¶</a><strong>挂载点原有内容会怎样？</strong></h4><p><strong>场景：挂载到非空文件夹</strong></p><p>假设 <code>/mnt/usb</code> 原本有一个文件 <code>old.txt</code>：</p><ol><li>挂载U盘到 <code>/mnt/usb</code>。</li><li>此时访问 <code>/mnt/usb</code>，只能看到U盘的内容，<code>old.txt</code> 被“隐藏”。</li><li>卸载后，<code>old.txt</code> 重新出现。</li></ol><p><strong>结论</strong>：挂载到非空文件夹时，原内容会被临时隐藏（但不会被删除！）。</p><h4 id="常见挂载类型"><a class="header-anchor" href="#常见挂载类型">¶</a><strong>常见挂载类型</strong></h4><p><strong>挂载光盘</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/cdrom /mnt/cd</span><br></pre></td></tr></table></figure><p>光盘内容会出现在 <code>/mnt/cd</code>。</p><p><strong>挂载硬盘分区</strong></p><p>假设硬盘分区是 <code>/dev/sda2</code>，挂载到 <code>/data</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sda2 /data</span><br></pre></td></tr></table></figure><p>所有存到 <code>/data</code> 的文件实际保存在硬盘分区中。</p><p><strong>挂载网络存储</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs 192.168.1.100:/shared /mnt/nfs</span><br></pre></td></tr></table></figure><p>通过网络访问远程文件夹。</p><h4 id="自动挂载（开机自动挂载）"><a class="header-anchor" href="#自动挂载（开机自动挂载）">¶</a><strong>自动挂载（开机自动挂载）</strong></h4><p>编辑 <code>/etc/fstab</code> 文件，添加一行配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1  /mnt/usb  ext4  defaults  0  0</span><br></pre></td></tr></table></figure><p>系统启动时会自动挂载设备到指定位置。另外还有一种方法，通过 <code>blkid</code> 获取要挂载设备的 <code>UUID</code>，然后使用 <code>UUID</code> 挂载。</p><h2 id="4-取消挂载"><a class="header-anchor" href="#4-取消挂载">¶</a>4. 取消挂载</h2><p>取消挂载使用 <code>umount</code> 命令，需要注意的是，要取消挂载需要退出挂载点所在的目录，我们结合报错例子来学习，例如在执行下面的取消挂载命令时：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /data</span><br></pre></td></tr></table></figure><p>可能会出现下面的报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">umount: target is busy</span><br><span class="line">(In some cases useful info about processes that use</span><br><span class="line">the device is found by lsof(8) or fuser(1))</span><br></pre></td></tr></table></figure><h3 id="原因解析"><a class="header-anchor" href="#原因解析">¶</a>原因解析</h3><ol><li><strong>文件系统被占用</strong><ul><li><strong>打开文件</strong>：有进程正在 <code>/data</code> 目录下打开文件（例如日志文件、数据文件等），导致文件系统处于“忙”状态。</li><li><strong>当前工作目录</strong>：某个用户或服务的当前工作目录设置在 <code>/data</code> 下。如果用户的 shell 或程序正处于该目录，也会阻止卸载。</li></ul></li><li><strong>多用户环境的影响</strong><ul><li><strong>多用户使用</strong>：在多用户系统中，不同用户可能同时在 <code>/data</code> 挂载点下运行应用程序或脚本。即使你自己不在使用，其他用户的进程也可能占用该目录。</li><li><strong>服务使用</strong>：某些服务（如数据库、Web服务器或其他网络服务）可能将 <code>/data</code> 用作数据存储目录，并且这些服务可能由不同用户启动。</li></ul></li><li><strong>后台进程和网络端口</strong><ul><li>某些后台进程或守护进程可能绑定了特定端口，并且其配置文件或数据存放在 <code>/data</code> 下。使用 <code>ps -ef | grep &lt;端口号&gt;</code> 可帮助定位这些进程。</li></ul></li></ol><h3 id="解决方法"><a class="header-anchor" href="#解决方法">¶</a>解决方法</h3><ol><li><p><strong>使用 lsof 命令查看占用情况</strong></p><ul><li><p>运行以下命令，查看哪些进程正在访问  <code>/data</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof /data</span><br></pre></td></tr></table></figure></li><li><p>此命令会列出所有打开 <code>/data</code> 下文件的进程及其详细信息。</p></li></ul></li><li><p><strong>使用 fuser 命令确认进程</strong></p><ul><li><p>通过 fuser 命令可以直接看到占用挂载点的进程ID：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fuser -m /data</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>使用 ps 命令查找特定端口进程（如有需要）</strong></p><ul><li><p>如果怀疑某个服务在使用特定端口（例如数据库或 Web 服务），可以使用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep &lt;端口号&gt;</span><br></pre></td></tr></table></figure></li><li><p>这样可以帮助你定位使用该端口的进程，从而确认它们是否涉及到 <code>/data</code> 目录的使用。</p></li></ul></li><li><p><strong>停止或终止相关进程</strong></p><ul><li><p>根据上面的命令输出，确认占用 <code>/data</code></p><p>的进程后，可以采取以下措施：</p><ul><li><p><strong>通知用户</strong>：在多用户环境中，先通知使用者退出或切换工作目录，确保不再访问 <code>/data</code>。</p></li><li><p><strong>终止进程</strong>：如果确认进程可以安全终止，使用以下命令（注意要谨慎操作）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p><strong>使用延迟卸载（Lazy Unmount）</strong></p><ul><li><p>如果确定暂时无法中止所有进程，也可以采用延迟卸载的方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount -l /data</span><br></pre></td></tr></table></figure></li><li><p>此方法会立即断开挂载点，但会在进程不再使用时真正卸载。但需注意，这种方式可能会导致数据同步问题。</p></li></ul></li></ol><h1>特殊设备文件</h1><h2 id="1-dev-null-——-空设备（黑洞）"><a class="header-anchor" href="#1-dev-null-——-空设备（黑洞）">¶</a>1. <code>/dev/null</code> —— 空设备（黑洞）</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时总是返回 EOF（End of File）。</li><li>写入的数据会被直接丢弃，不占用存储空间。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>丢弃输出：常用于忽略命令的标准输出（<code>stdout</code>）或错误输出（<code>stderr</code>）。</p></li><li><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> &gt; /dev/null   <span class="comment"># 丢弃 ls 命令的标准输出</span></span><br><span class="line"><span class="built_in">ls</span> 2&gt; /dev/null  <span class="comment"># 丢弃 ls 命令的错误输出</span></span><br><span class="line"><span class="built_in">ls</span> &gt; /dev/null 2&gt;&amp;1  <span class="comment"># 同时丢弃标准输出和错误输出</span></span><br></pre></td></tr></table></figure></li><li><p>作为空文件输入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /dev/null &gt; file.txt  <span class="comment"># 清空 file.txt</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><hr><h2 id="2-dev-zero-——-无限输出零字节"><a class="header-anchor" href="#2-dev-zero-——-无限输出零字节">¶</a>2. <code>/dev/zero</code> —— 无限输出零字节</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时会不断返回 <code>0x00</code>（空字节）。</li><li>适用于生成填充数据（例如创建大文件）。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>创建特定大小的文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=file.bin bs=1M count=100</span><br></pre></td></tr></table></figure><p>该命令创建一个 100MB 的全零文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file.bin</span><br></pre></td></tr></table></figure></li><li><p>初始化文件系统：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/zero  <span class="comment"># 格式化磁盘时用于填充数据</span></span><br></pre></td></tr></table></figure></li><li><p>用于共享内存（如 <code>mmap</code>）或虚拟内存文件系统（如 <code>tmpfs</code>）。</p></li></ul></li></ul><h2 id="3-dev-random-——-高质量随机数生成器"><a class="header-anchor" href="#3-dev-random-——-高质量随机数生成器">¶</a>3. <code>/dev/random</code> —— 高质量随机数生成器</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时返回加密安全的随机数据（由环境噪声等熵源提供）。</li><li>如果熵池（entropy pool）不足，读取可能会阻塞（等待更多随机熵）。</li><li>适用于生成高质量的加密密钥。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>生成安全随机数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">head</span> -c 16 /dev/random | <span class="built_in">base64</span>  <span class="comment"># 生成 16 字节的随机数据并编码</span></span><br></pre></td></tr></table></figure></li><li><p>生成随机密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /dev/random | <span class="built_in">tr</span> -dc <span class="string">&#x27;A-Za-z0-9&#x27;</span> | <span class="built_in">head</span> -c 12</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="4-dev-urandom-——-非阻塞随机数生成器"><a class="header-anchor" href="#4-dev-urandom-——-非阻塞随机数生成器">¶</a>4. <code>/dev/urandom</code> —— 非阻塞随机数生成器</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时返回伪随机数，熵不足时不会阻塞（不同于 <code>/dev/random</code>）。</li><li>适用于大多数非极端安全需求的随机数生成场景。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>生成随机文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/urandom of=random.bin bs=1M count=10</span><br></pre></td></tr></table></figure><p>生成一个 10MB 的随机文件。</p></li><li><p>生成随机密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">base64</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong><code>/dev/random</code> vs <code>/dev/urandom</code></strong></p><table><thead><tr><th>特性</th><th><code>/dev/random</code></th><th><code>/dev/urandom</code></th></tr></thead><tbody><tr><td>是否阻塞</td><td>是（熵池不足时）</td><td>否</td></tr><tr><td>安全性</td><td>高（适用于加密密钥）</td><td>较高（但不适用于极端安全需求）</td></tr><tr><td>适用场景</td><td>需要高质量随机数，如密钥生成</td><td>普通随机需求，如随机 ID、随机测试数据</td></tr></tbody></table><p><strong>结论：</strong></p><ul><li><code>/dev/random</code> 适用于生成高安全性密钥（如 GPG/SSH 密钥）。</li><li><code>/dev/urandom</code> 适用于一般随机数需求（如 session ID）。</li></ul><h1>文件系统、链接与 RAID 技术详解</h1><p>下面将详细介绍 inode、块（block）、硬链接、文件删除原理、软链接、硬链接。</p><h2 id="1-inode-与文件系统"><a class="header-anchor" href="#1-inode-与文件系统">¶</a>1. inode 与文件系统</h2><p><strong>inode（Index Node）</strong>：是 Unix/Linux 文件系统中用于存储文件元数据（metadata）的数据结构。它记录了文件的所有属性信息（如所有者、权限、时间戳、文件大小、数据块指针等），但不包含文件名。换句话说，Linux 的文件内容其实是包含了文件名和元数据两个部分的，元数据可以通过 <code>stat</code> 命令查看得到。一个新的磁盘在格式化文件系统后存在两个存储空间，一个叫做 <code>inode</code> 存储空间（存储元数据），一个叫做 <code>block</code> 存储空间（存储文件数据），创建文件系统之后 <code>inode</code> 和 <code>block</code> 的数量就会固定下来。Linux 读取文件内容是通过 <code>文件名 &gt; inode 编号 &gt; block 的顺序</code> 来读取的。</p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311223710806.png" alt="image-20250311223710806"></p><h3 id="文件与-inode-的关系"><a class="header-anchor" href="#文件与-inode-的关系">¶</a>文件与 inode 的关系</h3><ul><li><strong>文件数据与 inode</strong>：<ul><li>每个文件在创建时都会分配一个 inode，inode 存储文件的元数据。</li><li>文件的数据实际存放在数据块中，而 inode 中包含指向这些数据块的指针。</li></ul></li><li><strong>目录与 inode</strong>：<ul><li>目录本身也是一个特殊类型的文件，其内容是文件名和对应 inode 编号的映射表。</li><li>当你通过文件名访问文件时，系统实际上先通过目录查找对应的 inode 编号，再根据 inode 获取文件的相关信息和数据。</li></ul></li></ul><h3 id="块（block）"><a class="header-anchor" href="#块（block）">¶</a>块（block）</h3><ul><li><strong>块的概念</strong>：<ul><li>硬盘上的数据以块为单位存储。块是文件系统读写的基本单位，其大小通常在 512 字节到 4KB 之间，具体取决于文件系统的设置。</li><li>inode 中的指针正是指向这些块的位置。</li></ul></li><li><strong>块在性能上的影响</strong>：<ul><li>块的大小会影响文件存储的效率与性能。过小可能导致大量索引；过大则可能浪费存储空间（内部碎片）。</li></ul></li></ul><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311235850437.png" alt="image-20250311235850437"></p><h2 id="2-链接（Link）：硬链接与软链接"><a class="header-anchor" href="#2-链接（Link）：硬链接与软链接">¶</a>2. 链接（Link）：硬链接与软链接</h2><h3 id="硬链接（Hard-Link）"><a class="header-anchor" href="#硬链接（Hard-Link）">¶</a>硬链接（Hard Link）</h3><p>硬链接是多个目录项（文件名）指向同一个 inode。也就是说，同一个文件的多个名字都指向同一组数据和属性，其特点是：</p><ul><li>共享 inode：硬链接和原始文件共享同一个 inode，所以它们是完全等价的。</li><li>不能跨文件系统：硬链接只能在同一个文件系统内建立。</li><li>不能对目录建立硬链接（防止循环引用）。</li><li>当删除一个硬链接时，只是删除了目录中的一个引用。如果该 inode 的链接计数不为 0，则文件数据仍然保留。</li><li>只有当所有指向该 inode 的硬链接都被删除后，系统才真正回收 inode 和数据块。</li></ul><h3 id="软链接（符号链接，Symbolic-Link）"><a class="header-anchor" href="#软链接（符号链接，Symbolic-Link）">¶</a>软链接（符号链接，Symbolic Link）</h3><p>软链接是一个特殊类型的文件，其中存储了另一个文件或目录的路径，其特点是：</p><ul><li>不共享 inode：软链接有自己的 inode，其内容指向目标文件的路径。</li><li>可以跨文件系统：软链接可以引用其他文件系统上的文件或目录。</li><li>如果目标文件被删除，软链接就会变成“悬挂链接”（dangling link），即指向不存在的目标。</li></ul><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311234336552.png" alt="image-20250311234336552"></p><h2 id="3-目录的链接数"><a class="header-anchor" href="#3-目录的链接数">¶</a><strong>3. 目录的链接数</strong></h2><p>在 Linux 中，<strong>目录的链接数</strong>（link count）表示有多少个硬链接指向该目录。可以通过 <code>ls -ld</code> 来查看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld 目录名</span><br></pre></td></tr></table></figure><h3 id="目录的硬链接数"><a class="header-anchor" href="#目录的硬链接数">¶</a>目录的硬链接数</h3><ul><li><p>普通目录</p><p>（非空目录）：硬链接数 = 2 + 该目录下的子目录个数</p><ul><li><code>.</code> 指向自身（1 个链接）</li><li><code>..</code> 存在于每个子目录（父目录的链接数 +1）</li><li>目录下的每个子目录都会在父目录中创建一个 <code>..</code>，增加父目录的链接数。</li></ul></li><li><p><strong>根目录 <code>/</code></strong>：其硬链接数等于 2 + <code>/</code> 下的一级子目录数量。</p></li></ul><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> test_dir</span><br><span class="line"><span class="built_in">ls</span> -ld test_dir</span><br><span class="line"><span class="comment"># 输出类似：</span></span><br><span class="line"><span class="comment"># drwxr-xr-x 2 user user 4096 Sep 26 12:00 test_dir</span></span><br><span class="line"><span class="comment"># 其中 `2` 表示当前目录有 2 个硬链接（自身 `.` 和父目录 `..`）</span></span><br></pre></td></tr></table></figure><h3 id="子目录的影响"><a class="header-anchor" href="#子目录的影响">¶</a>子目录的影响</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> test_dir/sub_dir</span><br><span class="line"><span class="built_in">ls</span> -ld test_dir</span><br><span class="line"><span class="comment"># 硬链接数增加到 3，因为 `sub_dir` 内部有 `..` 指向 `test_dir`</span></span><br></pre></td></tr></table></figure><p><strong>总结：</strong></p><ul><li><strong>空目录的硬链接数是 2</strong>（自身 <code>.</code> + 父目录的 <code>..</code>）。</li><li><strong>每增加一个子目录，父目录的硬链接数增加 1</strong>。</li></ul><h2 id="4-文件删除原理"><a class="header-anchor" href="#4-文件删除原理">¶</a>4. 文件删除原理</h2><ul><li><p><strong>目录项删除</strong>：当删除文件时，实际上是从目录中移除了对该文件 inode 的引用（即减少了 inode 的链接计数）。</p></li><li><p><strong>数据实际删除</strong>：只有当 inode 的链接计数归零时，操作系统才会将该 inode 和对应的数据块标记为可回收，从而真正释放磁盘空间。</p></li><li><p><strong>缓存与文件句柄</strong>：如果某个进程已打开文件，即使目录项被删除，该文件仍可被进程读取或写入，直到文件描述符关闭后，数据才会最终释放。</p></li><li><p><strong>移动和删除文件对软硬链接的影响：</strong></p><p><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311235231646.png" alt="image-20250311235231646"></p></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;磁盘相关的问题，很多时候不是“记几个命令”就能解决：分区表怎么选、文件系统怎么挂、扩容怎么尽量少停机、删文件为什么空间不立刻回来，背后都有明确的机制约束。本文从热/冷存储与磁盘结构切入，串起 RAID 与 LVM 的落地用法、MBR/GPT 分区与 &lt;code&gt;fdisk&lt;/code&gt;/&lt;code&gt;gdisk&lt;/code&gt; 的实际操作、格式化与挂载的完整流程，并补上 &lt;code&gt;/dev&lt;/code&gt; 特殊设备、inode 与硬/软链接、文件删除原理这些最容易踩坑但又最“救命”的细节。读完你应该能按步骤把一块新盘从“识别—分区—格式化—挂载—扩容—排障”走通。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux Disk Management: From Hardware to Filesystems (RAID, LVM, GPT/MBR, Mounting, and Recovery)</title>
    <link href="https://chenk.top/en/linux-disk-management/"/>
    <id>https://chenk.top/en/linux-disk-management/</id>
    <published>2025-02-17T16:00:00.000Z</published>
    <updated>2026-01-29T15:14:20.437Z</updated>
    
    <content type="html"><![CDATA[<p>Disk issues in production are rarely fixed by “one magic command”. You’re usually dealing with a whole stack: <strong>hardware behavior (HDD vs SSD)</strong>, <strong>block devices and partition tables</strong>, <strong>RAID/LVM layering</strong>, and finally <strong>filesystem semantics</strong> (inodes, links, deletion, and why space doesn’t come back). This post walks the end-to-end workflow—identify a new disk, partition it, format it, mount it, make it persistent, expand capacity with minimal downtime, and debug the common failure modes—while also explaining the underlying mechanisms so you can reason about what the system is doing.</p><span id="more"></span><h2 id="Storage-basics-what-you’re-really-buying-latency-vs-throughput-vs-safety"><a class="header-anchor" href="#Storage-basics-what-you’re-really-buying-latency-vs-throughput-vs-safety">¶</a>Storage basics: what you’re really buying (latency vs throughput vs safety)</h2><p>Before you touch a single command, it helps to have the right mental model.</p><h3 id="Hot-vs-cold-storage-SSD-vs-HDD-and-the-“random-I-O-tax”"><a class="header-anchor" href="#Hot-vs-cold-storage-SSD-vs-HDD-and-the-“random-I-O-tax”">¶</a>Hot vs cold storage (SSD vs HDD) and the “random I/O tax”</h3><p><strong>SSD (hot storage)</strong> is great when you need low latency and fast random reads/writes (databases, caches, indexes). <strong>HDD (cold storage)</strong> is great when you need cheap capacity and large sequential throughput (archives, backups, large logs).</p><p>Where the big difference comes from:</p><ul><li>HDD random I/O pays <strong>two mechanical waits</strong>: seek time (move head) + rotational latency (wait for the sector to rotate under the head).</li><li>SSD is electronic; random I/O is much closer to sequential, but writes have their own complexity (erase blocks, garbage collection, write amplification).</li></ul><p>Practical takeaway:</p><ul><li>If a workload becomes random-I/O heavy on HDD, performance can collapse even if “MB/s” looks fine for sequential tests.</li><li>If you saturate SSD writes, you may see latency spikes due to internal garbage collection.</li></ul><p><img src="/en/linux-disk-management/20210701123415976-1024x556.png" alt="storage overview"></p><h3 id="What-is-a-“sector”-what-is-a-filesystem-“block”-and-why-small-files-waste-space"><a class="header-anchor" href="#What-is-a-“sector”-what-is-a-filesystem-“block”-and-why-small-files-waste-space">¶</a>What is a “sector”, what is a filesystem “block”, and why small files waste space</h3><p>Disks store data in <strong>sectors</strong> (historically 512B; many drives are 4K physical sectors). Filesystems allocate in <strong>blocks</strong> (allocation units). A file cannot occupy “half a block”, so a 1-byte file still consumes at least one block plus metadata.</p><p>This explains real-world surprises:</p><ul><li>“My directory of tiny files is huge on disk.”</li><li>“<code>du</code> and <code>ls -l</code> report different sizes.”</li></ul><h3 id="TRIM-on-SSD-and-“can-deleted-data-be-recovered-”"><a class="header-anchor" href="#TRIM-on-SSD-and-“can-deleted-data-be-recovered-”">¶</a>TRIM on SSD and “can deleted data be recovered?”</h3><p>On HDD, deletion typically only removes directory entries and metadata; the old data may remain until overwritten. On SSD, after deletion the OS may issue TRIM/discard, and the device may reclaim blocks quickly. That’s why recovery assumptions differ.</p><h3 id="Object-storage-is-a-different-abstraction-S3-OSS"><a class="header-anchor" href="#Object-storage-is-a-different-abstraction-S3-OSS">¶</a>Object storage is a different abstraction (S3/OSS)</h3><p>If your “disk problem” is really “I have too many blobs to manage on one VM”, you often want object storage instead of endlessly growing a filesystem.</p><hr><h2 id="Block-devices-in-Linux-how-disks-show-up-and-how-to-not-shoot-yourself"><a class="header-anchor" href="#Block-devices-in-Linux-how-disks-show-up-and-how-to-not-shoot-yourself">¶</a>Block devices in Linux: how disks show up (and how to not shoot yourself)</h2><h3 id="The-core-commands-to-identify-hardware-and-mapping"><a class="header-anchor" href="#The-core-commands-to-identify-hardware-and-mapping">¶</a>The core commands to identify hardware and mapping</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lsblk -f</span><br><span class="line">sudo fdisk -l</span><br><span class="line">sudo blkid</span><br></pre></td></tr></table></figure><p>What you’re looking for:</p><ul><li>device name: <code>/dev/sda</code>, <code>/dev/nvme0n1</code>, etc.</li><li>partitions: <code>/dev/sda1</code>, <code>/dev/nvme0n1p1</code></li><li>filesystem type and UUID (for persistent mounts)</li></ul><h3 id="Naming-pitfalls-why-dev-sdb-can-“change”"><a class="header-anchor" href="#Naming-pitfalls-why-dev-sdb-can-“change”">¶</a>Naming pitfalls: why <code>/dev/sdb</code> can “change”</h3><p>Device names can change across reboots (especially with multiple disks). For persistence:</p><ul><li>mount by <strong>UUID</strong></li><li>or use stable paths like <code>/dev/disk/by-uuid/</code> and <code>/dev/disk/by-id/</code></li></ul><hr><h2 id="Partition-tables-GPT-vs-MBR-and-what-tools-to-use"><a class="header-anchor" href="#Partition-tables-GPT-vs-MBR-and-what-tools-to-use">¶</a>Partition tables: GPT vs MBR (and what tools to use)</h2><h3 id="MBR-vs-GPT-decision-guide"><a class="header-anchor" href="#MBR-vs-GPT-decision-guide">¶</a>MBR vs GPT (decision guide)</h3><ul><li><strong>MBR</strong>: legacy, limited partitioning model, historically painful for large disks in old BIOS setups.</li><li><strong>GPT</strong>: modern standard (UEFI-friendly), more partitions, better metadata and robustness.</li></ul><p>In practice: use GPT unless you are constrained by old hardware/boot modes.</p><h3 id="Tools-fdisk-vs-gdisk-vs-parted"><a class="header-anchor" href="#Tools-fdisk-vs-gdisk-vs-parted">¶</a>Tools: <code>fdisk</code> vs <code>gdisk</code> vs <code>parted</code></h3><ul><li><code>fdisk</code>: common, works for MBR and (on modern distros) GPT too</li><li><code>gdisk</code>: GPT-focused</li><li><code>parted</code>: convenient for some scripted workflows</li></ul><h3 id="Example-create-a-partition-high-level"><a class="header-anchor" href="#Example-create-a-partition-high-level">¶</a>Example: create a partition (high-level)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk /dev/sdb</span><br></pre></td></tr></table></figure><p>Typical flow inside <code>fdisk</code>:</p><ul><li>create a new partition</li><li>write changes</li><li>re-read partition table (or reboot if required)</li></ul><p>Afterwards verify:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsblk -f</span><br></pre></td></tr></table></figure><hr><h2 id="Filesystems-format-mount-and-persist-with-fstab"><a class="header-anchor" href="#Filesystems-format-mount-and-persist-with-fstab">¶</a>Filesystems: format, mount, and persist with <code>fstab</code></h2><h3 id="Choose-a-filesystem-ext4-vs-xfs"><a class="header-anchor" href="#Choose-a-filesystem-ext4-vs-xfs">¶</a>Choose a filesystem: ext4 vs xfs</h3><ul><li><strong>ext4</strong>: common default, solid general-purpose filesystem</li><li><strong>xfs</strong>: strong for large files and parallel I/O; excellent tooling; must be grown online and cannot be shrunk easily</li></ul><h3 id="Format"><a class="header-anchor" href="#Format">¶</a>Format</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 /dev/sdb1</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">sudo mkfs.xfs /dev/sdb1</span><br></pre></td></tr></table></figure><h3 id="Mount"><a class="header-anchor" href="#Mount">¶</a>Mount</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /mnt/data</span><br><span class="line">sudo mount /dev/sdb1 /mnt/data</span><br><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><h3 id="Make-mount-persistent-etc-fstab"><a class="header-anchor" href="#Make-mount-persistent-etc-fstab">¶</a>Make mount persistent: <code>/etc/fstab</code></h3><p>Always prefer UUID:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo blkid /dev/sdb1</span><br></pre></td></tr></table></figure><p>Example <code>fstab</code> entry:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=&lt;uuid&gt;  /mnt/data  ext4  defaults  0  2</span><br></pre></td></tr></table></figure><p>Safety tip: after editing <code>fstab</code>, test without reboot:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure><p>If this errors, fix it before rebooting.</p><hr><h2 id="RAID-redundancy-and-performance-with-real-trade-offs"><a class="header-anchor" href="#RAID-redundancy-and-performance-with-real-trade-offs">¶</a>RAID: redundancy and performance, with real trade-offs</h2><p>RAID is about two knobs:</p><ul><li><strong>availability</strong> (tolerate disk failures)</li><li><strong>performance</strong> (especially read throughput)</li></ul><h3 id="RAID-levels-what-people-actually-choose"><a class="header-anchor" href="#RAID-levels-what-people-actually-choose">¶</a>RAID levels (what people actually choose)</h3><ul><li><strong>RAID 0</strong>: fastest, no redundancy (one disk fails → everything fails)</li><li><strong>RAID 1</strong>: mirroring (capacity ~50%), simple redundancy</li><li><strong>RAID 5</strong>: parity, tolerate 1 disk failure; write penalty; rebuild risk on large arrays</li><li><strong>RAID 6</strong>: double parity, tolerate 2 disk failures; more write overhead</li><li><strong>RAID 10</strong>: mirror + stripe; high performance + redundancy; higher cost</li></ul><p>When in doubt in production:</p><ul><li>prefer RAID 10 for latency-sensitive workloads</li><li>prefer RAID 6 for large HDD arrays where rebuild risk matters</li></ul><h3 id="Software-RAID-on-Linux-mdadm"><a class="header-anchor" href="#Software-RAID-on-Linux-mdadm">¶</a>Software RAID on Linux (<code>mdadm</code>)</h3><p>Create a RAID 1 array:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1</span><br><span class="line"><span class="built_in">cat</span> /proc/mdstat</span><br><span class="line">sudo mdadm --detail /dev/md0</span><br></pre></td></tr></table></figure><p>Persist array definition (file varies by distro):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mdadm --detail --scan | sudo <span class="built_in">tee</span> -a /etc/mdadm.conf</span><br></pre></td></tr></table></figure><p>Fail/remove a device (example):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mdadm /dev/md0 --fail /dev/sda1 --remove /dev/sda1</span><br></pre></td></tr></table></figure><p>Operational rule: always verify rebuild status in <code>/proc/mdstat</code> before assuming you’re safe again.</p><hr><h2 id="LVM-how-to-expand-disks-without-re-partitioning-pain"><a class="header-anchor" href="#LVM-how-to-expand-disks-without-re-partitioning-pain">¶</a>LVM: how to expand disks without re-partitioning pain</h2><p>LVM is the layer that makes capacity changes manageable. The mental model:</p><ul><li><strong>PV</strong>: a disk/partition enrolled into LVM</li><li><strong>VG</strong>: a pool of capacity built from one or more PVs</li><li><strong>LV</strong>: virtual block devices carved from a VG</li></ul><h3 id="Typical-expansion-workflow-the-“minimal-downtime”-playbook"><a class="header-anchor" href="#Typical-expansion-workflow-the-“minimal-downtime”-playbook">¶</a>Typical expansion workflow (the “minimal downtime” playbook)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1) Prepare a new disk (or partition) as PV</span></span><br><span class="line">sudo pvcreate /dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2) Add it into an existing VG</span></span><br><span class="line">sudo vgextend vg0 /dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3) Extend the LV (example: +100G)</span></span><br><span class="line">sudo lvextend -L +100G /dev/vg0/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4) Grow the filesystem</span></span><br><span class="line">sudo resize2fs /dev/vg0/data    <span class="comment"># ext4</span></span><br><span class="line">sudo xfs_growfs /mount/point    <span class="comment"># xfs (must be mounted)</span></span><br></pre></td></tr></table></figure><p>Why this works operationally:</p><ul><li>you can add capacity without moving the old blocks first</li><li>expansion is often online (service can stay up if filesystem supports it)</li></ul><h3 id="A-safer-“data-migration”-variant-when-you-really-need-to-move"><a class="header-anchor" href="#A-safer-“data-migration”-variant-when-you-really-need-to-move">¶</a>A safer “data migration” variant (when you really need to move)</h3><p>If you must migrate data to a new mount, do it in a controlled window:</p><ul><li>stop writes (or stop the service)</li><li>snapshot/backup</li><li>copy with <code>rsync</code> preserving permissions</li><li>switch mount points</li><li>verify, then reopen traffic</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rsync -aHAX --delete /old/ /new/</span><br></pre></td></tr></table></figure><hr><h2 id="dev-special-devices-you’ll-see-in-disk-work"><a class="header-anchor" href="#dev-special-devices-you’ll-see-in-disk-work">¶</a><code>/dev</code> special devices you’ll see in disk work</h2><p>These are not “real disks”, but they matter for ops:</p><ul><li><code>/dev/null</code>: discard output</li><li><code>/dev/zero</code>: infinite zeros (create files, test throughput)</li><li><code>/dev/random</code> / <code>/dev/urandom</code>: randomness sources</li></ul><p>Examples:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a 1GB file for testing (fast on many systems)</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=test.bin bs=1M count=1024</span><br></pre></td></tr></table></figure><hr><h2 id="Inodes-hard-links-symlinks-filesystem-semantics-that-explain-weird-incidents"><a class="header-anchor" href="#Inodes-hard-links-symlinks-filesystem-semantics-that-explain-weird-incidents">¶</a>Inodes, hard links, symlinks: filesystem semantics that explain weird incidents</h2><h3 id="Inodes-why-“file-name”-is-not-“the-file”"><a class="header-anchor" href="#Inodes-why-“file-name”-is-not-“the-file”">¶</a>Inodes: why “file name” is not “the file”</h3><p>A filename is a directory entry pointing to an inode. The inode points to data blocks.</p><p>This helps explain:</p><ul><li>why hard links work</li><li>why deleting a file doesn’t always reclaim space immediately</li><li>why inode exhaustion can happen even with free disk space</li></ul><p>Check inode usage:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -i</span><br></pre></td></tr></table></figure><h3 id="Hard-link-vs-symlink-what’s-the-real-difference"><a class="header-anchor" href="#Hard-link-vs-symlink-what’s-the-real-difference">¶</a>Hard link vs symlink (what’s the real difference)</h3><ul><li><strong>Hard link</strong>: another directory entry pointing to the same inode (cannot cross filesystems; usually not for directories)</li><li><strong>Symlink</strong>: its own inode containing a path (can cross filesystems; can become dangling)</li></ul><hr><h2 id="“I-deleted-files-but-disk-space-didn’t-come-back”-the-real-cause-and-the-fix"><a class="header-anchor" href="#“I-deleted-files-but-disk-space-didn’t-come-back”-the-real-cause-and-the-fix">¶</a>“I deleted files but disk space didn’t come back”: the real cause and the fix</h2><p>The classic root cause is: a process still has the file open.</p><p>Find deleted-but-open files:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof | grep <span class="string">&#x27;(deleted)&#x27;</span></span><br></pre></td></tr></table></figure><p>Fix options:</p><ul><li>restart the holding process (common for log files)</li><li>or rotate logs properly (avoid truncation pitfalls)</li></ul><p>This is one of those incidents where understanding filesystem semantics saves hours of guessing.</p><hr><h2 id="End-to-end-checklist-new-disk-→-usable-space-→-expandable-setup"><a class="header-anchor" href="#End-to-end-checklist-new-disk-→-usable-space-→-expandable-setup">¶</a>End-to-end checklist: new disk → usable space → expandable setup</h2><p>If you want a compact “do it right” path:</p><ol><li>Identify disk: <code>lsblk -f</code></li><li>Partition (GPT preferred): <code>fdisk</code>/<code>gdisk</code></li><li>Format: <code>mkfs.ext4</code> or <code>mkfs.xfs</code></li><li>Mount and verify: <code>mount</code>, <code>df -h</code></li><li>Persist mount by UUID: <code>/etc/fstab</code> + <code>mount -a</code></li><li>If you expect growth: plan RAID/LVM from day 1 (don’t paint yourself into a corner)</li></ol><p>If you can run this checklist confidently, most disk incidents become systematic rather than stressful.</p><hr><h2 id="A-deeper-performance-model-why-“MB-s-looks-fine”-but-the-service-is-slow"><a class="header-anchor" href="#A-deeper-performance-model-why-“MB-s-looks-fine”-but-the-service-is-slow">¶</a>A deeper performance model: why “MB/s looks fine” but the service is slow</h2><p>In production, disk complaints usually show up as one of these:</p><ul><li>requests timing out even though CPU is low</li><li>high load average with low CPU utilization</li><li>periodic latency spikes that correlate with log rotation or backups</li></ul><p>A useful lens is to separate <strong>throughput</strong> from <strong>latency</strong>:</p><ul><li>Throughput answers: “how many MB per second can I stream?”</li><li>Latency answers: “how long does one small read/write take?”</li></ul><p>Databases and many web workloads care far more about latency than bulk throughput.</p><h3 id="Random-I-O-and-IOPS"><a class="header-anchor" href="#Random-I-O-and-IOPS">¶</a>Random I/O and IOPS</h3><p>IOPS (I/O operations per second) is a better metric than MB/s when operations are small (4K–16K). HDD can have decent MB/s sequentially but terrible random IOPS because each random access pays mechanical latency.</p><h3 id="Page-cache-why-reads-can-be-fast-until-they-aren’t"><a class="header-anchor" href="#Page-cache-why-reads-can-be-fast-until-they-aren’t">¶</a>Page cache: why reads can be fast until they aren’t</h3><p>Linux aggressively caches file data in memory. This is good. But it can mislead you if you benchmark without clearing cache or if your workload suddenly exceeds memory.</p><p>Quick sanity checks:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free -h</span><br><span class="line"><span class="built_in">cat</span> /proc/meminfo | <span class="built_in">head</span></span><br></pre></td></tr></table></figure><p>If you see most “free” memory in <code>buff/cache</code>, that is normal and reclaimable.</p><h3 id="I-O-wait-and-load-average"><a class="header-anchor" href="#I-O-wait-and-load-average">¶</a>I/O wait and load average</h3><p>High load average with low CPU often points to I/O wait. Tools:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line">vmstat 1</span><br><span class="line">iostat -x 1</span><br></pre></td></tr></table></figure><p>Look for:</p><ul><li>high <code>%wa</code> in <code>vmstat</code></li><li>high <code>await</code> and low <code>svctm</code>/high utilization in <code>iostat -x</code></li></ul><hr><h2 id="Partition-alignment-and-4K-sectors-the-silent-performance-killer"><a class="header-anchor" href="#Partition-alignment-and-4K-sectors-the-silent-performance-killer">¶</a>Partition alignment and 4K sectors (the silent performance killer)</h2><p>Modern disks often have 4K physical sectors even if they expose 512B logical sectors. If partitions are misaligned, a single filesystem write can turn into multiple physical reads/writes.</p><p>Practical rule:</p><ul><li>align partitions to 1MiB boundaries (most modern tools do this by default)</li></ul><p>Check alignment (roughly):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk -l /dev/sdb</span><br></pre></td></tr></table></figure><p>If you see partition starts at 2048 sectors on 512B logical sector disks, you’re typically aligned (2048 * 512B = 1MiB).</p><hr><h2 id="Filesystem-selection-and-tuning-ext4-vs-xfs-vs-“what-knobs-matter”"><a class="header-anchor" href="#Filesystem-selection-and-tuning-ext4-vs-xfs-vs-“what-knobs-matter”">¶</a>Filesystem selection and tuning (ext4 vs xfs vs “what knobs matter”)</h2><h3 id="ext4-safe-defaults-broad-compatibility"><a class="header-anchor" href="#ext4-safe-defaults-broad-compatibility">¶</a>ext4: safe defaults, broad compatibility</h3><p>ext4 is often a good default because:</p><ul><li>tooling is mature (<code>fsck</code>, <code>tune2fs</code>)</li><li>it behaves predictably across workloads</li></ul><h3 id="xfs-strong-for-large-volumes-and-parallel-I-O"><a class="header-anchor" href="#xfs-strong-for-large-volumes-and-parallel-I-O">¶</a>xfs: strong for large volumes and parallel I/O</h3><p>xfs shines with:</p><ul><li>large files</li><li>parallel access patterns</li><li>big filesystems</li></ul><p>Operational note: <strong>shrinking xfs is not supported</strong> in the usual way; plan capacity accordingly.</p><h3 id="Mount-options-small-changes-big-behavior-differences"><a class="header-anchor" href="#Mount-options-small-changes-big-behavior-differences">¶</a>Mount options: small changes, big behavior differences</h3><p>Some options you’ll actually care about:</p><ul><li><code>noatime</code>: reduce metadata writes from access-time updates (common for read-heavy workloads)</li><li><code>discard</code>: continuous TRIM (can add overhead); many setups prefer periodic <code>fstrim</code> instead</li></ul><p>Example (conceptual):</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID=&lt;uuid&gt; /mnt/data ext4 defaults,noatime 0 2</span><br></pre></td></tr></table></figure><p>For SSD TRIM on a schedule:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fstrim -av</span><br></pre></td></tr></table></figure><hr><h2 id="RAID-in-production-rebuild-risk-write-penalties-and-what-people-forget"><a class="header-anchor" href="#RAID-in-production-rebuild-risk-write-penalties-and-what-people-forget">¶</a>RAID in production: rebuild risk, write penalties, and what people forget</h2><h3 id="Rebuild-windows-are-dangerous"><a class="header-anchor" href="#Rebuild-windows-are-dangerous">¶</a>Rebuild windows are dangerous</h3><p>During rebuild:</p><ul><li>performance often degrades</li><li>the array is in a more fragile state (another disk failure can be catastrophic depending on RAID level)</li></ul><p>This is why large HDD arrays often prefer RAID 6 over RAID 5.</p><h3 id="RAID-is-not-a-backup"><a class="header-anchor" href="#RAID-is-not-a-backup">¶</a>RAID is not a backup</h3><p>RAID protects against <em>disk failure</em>, not:</p><ul><li>accidental deletion</li><li>ransomware</li><li>application bugs that corrupt data</li></ul><p>You still need backups and restore drills.</p><h3 id="Monitoring-RAID-health"><a class="header-anchor" href="#Monitoring-RAID-health">¶</a>Monitoring RAID health</h3><p>You should be able to answer at any moment:</p><ul><li>Is the array degraded?</li><li>Is a rebuild happening?</li><li>How far along is it?</li></ul><p>Commands:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/mdstat</span><br><span class="line">sudo mdadm --detail /dev/md0</span><br></pre></td></tr></table></figure><hr><h2 id="LVM-in-production-snapshots-rescue-workflows-and-practical-patterns"><a class="header-anchor" href="#LVM-in-production-snapshots-rescue-workflows-and-practical-patterns">¶</a>LVM in production: snapshots, rescue workflows, and practical patterns</h2><h3 id="Snapshots-conceptual"><a class="header-anchor" href="#Snapshots-conceptual">¶</a>Snapshots (conceptual)</h3><p>LVM snapshots can help with:</p><ul><li>short maintenance windows</li><li>consistency points before risky operations</li></ul><p>But snapshots are not free; they consume space as changes accumulate. If the snapshot fills, it becomes invalid. The safe mindset is: snapshots help you <em>roll back quickly</em>, but they do not replace backups.</p><h3 id="Growing-vs-shrinking"><a class="header-anchor" href="#Growing-vs-shrinking">¶</a>Growing vs shrinking</h3><p>Growing is often safe if filesystem supports it; shrinking is harder:</p><ul><li>ext4 can be shrunk offline (carefully)</li><li>xfs cannot be shrunk (typical approach is migrate data to a new LV)</li></ul><p>This is one reason people prefer to “grow-only” and plan headroom.</p><hr><h2 id="Filesystem-repair-and-“read-only-remount”-incidents"><a class="header-anchor" href="#Filesystem-repair-and-“read-only-remount”-incidents">¶</a>Filesystem repair and “read-only remount” incidents</h2><p>Sometimes the kernel remounts a filesystem as read-only to prevent further corruption. Symptoms:</p><ul><li>writes fail with “Read-only file system”</li><li>services crash on writes</li></ul><p>First check logs:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dmesg | <span class="built_in">tail</span> -n 200</span><br><span class="line">journalctl -k --since \&quot;1 hour ago\&quot;</span><br></pre></td></tr></table></figure><p>Then consider a controlled repair:</p><ul><li>ext4: <code>fsck</code> (offline; requires unmounted filesystem)</li><li>xfs: <code>xfs_repair</code> (offline; requires unmounted filesystem)</li></ul><p>Be careful: repair tools can change data structures. If this is production data, take snapshots/backups first.</p><hr><h2 id="Disk-health-SMART-bad-sectors-and-when-to-replace-hardware"><a class="header-anchor" href="#Disk-health-SMART-bad-sectors-and-when-to-replace-hardware">¶</a>Disk health: SMART, bad sectors, and when to replace hardware</h2><p>If you see intermittent I/O errors, timeouts, or “hung task” warnings, don’t assume it’s software. Check disk health.</p><p>Install tools (varies by distro) and inspect SMART:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo smartctl -a /dev/sda</span><br></pre></td></tr></table></figure><p>Things that matter:</p><ul><li>reallocated sector count (HDD)</li><li>media errors</li><li>device temperature</li></ul><p>If the trend is worsening, replacement is often the correct fix.</p><hr><h2 id="Real-world-troubleshooting-playbook-what-to-do-when-something-breaks"><a class="header-anchor" href="#Real-world-troubleshooting-playbook-what-to-do-when-something-breaks">¶</a>Real-world troubleshooting playbook (what to do when something breaks)</h2><h3 id="“Disk-full”-but-you-deleted-files"><a class="header-anchor" href="#“Disk-full”-but-you-deleted-files">¶</a>“Disk full” but you deleted files</h3><p>This is almost always:</p><ul><li>deleted file still open by a process</li></ul><p>Confirm:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof | grep <span class="string">&#x27;(deleted)&#x27;</span></span><br></pre></td></tr></table></figure><p>Fix: restart the process holding the file, or rotate logs correctly.</p><h3 id="“Device-or-resource-busy”-on-unmount"><a class="header-anchor" href="#“Device-or-resource-busy”-on-unmount">¶</a>“Device or resource busy” on unmount</h3><p>Find who is using the mount:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof +D /mnt/data | <span class="built_in">head</span></span><br><span class="line">sudo fuser -vm /mnt/data</span><br></pre></td></tr></table></figure><h3 id="“Mount-fails-after-reboot”"><a class="header-anchor" href="#“Mount-fails-after-reboot”">¶</a>“Mount fails after reboot”</h3><p>Common causes:</p><ul><li>wrong UUID in <code>/etc/fstab</code></li><li>missing filesystem driver/module</li><li>ordering: trying to mount before RAID/LVM is ready</li></ul><p>Use <code>mount -a</code> to test, and review boot logs.</p><h3 id="“Performance-suddenly-got-worse”"><a class="header-anchor" href="#“Performance-suddenly-got-worse”">¶</a>“Performance suddenly got worse”</h3><p>Checklist:</p><ol><li><code>iostat -x 1</code> (is the disk saturated?)</li><li><code>vmstat 1</code> (is there I/O wait / swapping?)</li><li><code>dmesg</code> (are there I/O errors?)</li><li>Is RAID rebuilding?</li><li>Did a backup/log job start?</li></ol><hr><h2 id="A-worked-example-minimal-downtime-capacity-expansion-for-a-growing-service"><a class="header-anchor" href="#A-worked-example-minimal-downtime-capacity-expansion-for-a-growing-service">¶</a>A worked example: minimal-downtime capacity expansion for a growing service</h2><p>Scenario:</p><ul><li>a service writes to <code>/data</code></li><li>disk usage is approaching 80%</li><li>you want to expand with minimal downtime</li></ul><p>One practical pattern:</p><ol><li>Attach a new disk.</li><li>Enroll it into LVM as a PV.</li><li>Extend the VG, then extend the LV backing <code>/data</code>.</li><li>Grow the filesystem online (if supported).</li><li>Verify with <code>df -h</code> and run a small write test.</li></ol><p>Example commands (adjust to your VG/LV names):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo pvcreate /dev/sdb</span><br><span class="line">sudo vgextend vg0 /dev/sdb</span><br><span class="line">sudo lvextend -l +100%FREE /dev/vg0/data</span><br><span class="line">sudo resize2fs /dev/vg0/data</span><br><span class="line"><span class="built_in">df</span> -h /data</span><br></pre></td></tr></table></figure><p>If you’re using xfs:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo xfs_growfs /data</span><br></pre></td></tr></table></figure><p>The key operational idea is to remove “migration” from the critical path. With LVM, you can often expand in-place.</p><hr><h2 id="How-disk-space-is-reported-df-vs-du-and-why-the-numbers-disagree"><a class="header-anchor" href="#How-disk-space-is-reported-df-vs-du-and-why-the-numbers-disagree">¶</a>How disk space is reported (df vs du) and why the numbers disagree</h2><p>This is a recurring ops confusion, and it matters when you are debugging “where did my space go?”</p><h3 id="df-answers-how-full-is-the-filesystem"><a class="header-anchor" href="#df-answers-how-full-is-the-filesystem">¶</a><code>df</code> answers: how full is the filesystem?</h3><p><code>df</code> reports filesystem-level allocation (blocks reserved, metadata, etc.):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure><h3 id="du-answers-how-much-space-do-these-paths-account-for"><a class="header-anchor" href="#du-answers-how-much-space-do-these-paths-account-for">¶</a><code>du</code> answers: how much space do these paths account for?</h3><p><code>du</code> walks directories and sums file sizes (as seen by directory entries):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">du</span> -h -d 1 /var | <span class="built_in">sort</span> -h</span><br></pre></td></tr></table></figure><h3 id="Why-df-says-“full”-but-du-can’t-find-the-culprit"><a class="header-anchor" href="#Why-df-says-“full”-but-du-can’t-find-the-culprit">¶</a>Why <code>df</code> says “full” but <code>du</code> can’t find the culprit</h3><p>Common causes:</p><ol><li><strong>Deleted-but-open files</strong> (logs are the most common)</li><li><strong>Mount confusion</strong> (you are looking at a directory that is no longer the mount point you think it is)</li><li><strong>Reserved blocks</strong> (e.g., ext4 reserves a percentage for root to keep the system alive)</li></ol><p>For deleted-but-open files:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof | grep <span class="string">&#x27;(deleted)&#x27;</span></span><br></pre></td></tr></table></figure><p>For mount confusion:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount | grep <span class="string">&#x27; /var &#x27;</span></span><br><span class="line">findmnt /var</span><br></pre></td></tr></table></figure><p>For ext4 reserved blocks:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tune2fs -l /dev/sdb1 | grep -i <span class="string">&#x27;reserved&#x27;</span></span><br></pre></td></tr></table></figure><p>You can reduce reserved blocks on non-root volumes (carefully):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo tune2fs -m 1 /dev/sdb1</span><br></pre></td></tr></table></figure><hr><h2 id="Swap-and-“disk-pressure-masquerading-as-memory-pressure”"><a class="header-anchor" href="#Swap-and-“disk-pressure-masquerading-as-memory-pressure”">¶</a>Swap and “disk pressure masquerading as memory pressure”</h2><p>Sometimes the user experience feels like “disk is slow”, but the root cause is memory pressure leading to swapping, which then produces heavy disk I/O.</p><p>Check swap usage:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free -h</span><br><span class="line">swapon --show</span><br></pre></td></tr></table></figure><p>If swap is actively used and the system is thrashing, you will see high I/O wait and high latency. The correct fix is usually:</p><ul><li>add memory</li><li>reduce memory footprint</li><li>tune workload</li></ul><p>Swap is a safety net, not a performance plan.</p><hr><h2 id="Common-mount-topologies-for-web-stacks-why-layouts-matter"><a class="header-anchor" href="#Common-mount-topologies-for-web-stacks-why-layouts-matter">¶</a>Common mount topologies for web stacks (why layouts matter)</h2><p>For a typical web/app server, a reasonable layout often separates:</p><ul><li><code>/</code> (OS + core binaries)</li><li><code>/var</code> (logs, package caches, some DBs depending on layout)</li><li><code>/data</code> or <code>/srv</code> (application data)</li></ul><p>Why this helps:</p><ul><li>logs can’t fill the root filesystem and break boot/login</li><li>you can snapshot or expand data volumes independently</li><li>permissions and ownership can be scoped more cleanly</li></ul><p>In cloud environments, this often maps naturally to separate block volumes attached to the instance.</p><hr><h2 id="A-short-“decision-tree”-for-day-2-operations"><a class="header-anchor" href="#A-short-“decision-tree”-for-day-2-operations">¶</a>A short “decision tree” for day-2 operations</h2><p>If you want a quick mental flow:</p><ol><li><strong>Need redundancy?</strong> → RAID 1/10 (latency) or RAID 6 (big HDD arrays)</li><li><strong>Need flexible growth?</strong> → put data under LVM (VG/LV), plan for grow-only</li><li><strong>Need predictable behavior?</strong> → ext4; need huge scale/parallel I/O → xfs</li><li><strong>Debugging space issues?</strong> → <code>df</code> + <code>du</code> + <code>lsof (deleted)</code> + <code>findmnt</code></li></ol><p>The point isn’t to memorize more commands; it’s to know which layer you’re operating on (hardware → block → RAID/LVM → filesystem → application).</p><hr><h2 id="Practical-command-appendix-small-but-complete"><a class="header-anchor" href="#Practical-command-appendix-small-but-complete">¶</a>Practical command appendix (small but complete)</h2><p>This section is deliberately “boring”: it’s a compact list you can copy when you’re on-call.</p><h3 id="Discover-and-inspect"><a class="header-anchor" href="#Discover-and-inspect">¶</a>Discover and inspect</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lsblk -f</span><br><span class="line">findmnt</span><br><span class="line">mount</span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line"><span class="built_in">df</span> -i</span><br><span class="line">sudo blkid</span><br></pre></td></tr></table></figure><h3 id="Partitioning"><a class="header-anchor" href="#Partitioning">¶</a>Partitioning</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk -l</span><br><span class="line">sudo fdisk /dev/sdb</span><br><span class="line">sudo gdisk /dev/sdb</span><br></pre></td></tr></table></figure><h3 id="Filesystem-creation-and-checks"><a class="header-anchor" href="#Filesystem-creation-and-checks">¶</a>Filesystem creation and checks</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 /dev/sdb1</span><br><span class="line">sudo mkfs.xfs /dev/sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ext4 info</span></span><br><span class="line">sudo tune2fs -l /dev/sdb1 | <span class="built_in">head</span></span><br></pre></td></tr></table></figure><h3 id="Mounting-and-persistence"><a class="header-anchor" href="#Mounting-and-persistence">¶</a>Mounting and persistence</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb1 /mnt/data</span><br><span class="line">sudo umount /mnt/data</span><br><span class="line">sudo mount -a</span><br></pre></td></tr></table></figure><h3 id="RAID-mdadm"><a class="header-anchor" href="#RAID-mdadm">¶</a>RAID (<code>mdadm</code>)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/mdstat</span><br><span class="line">sudo mdadm --detail /dev/md0</span><br></pre></td></tr></table></figure><h3 id="LVM"><a class="header-anchor" href="#LVM">¶</a>LVM</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo pvs</span><br><span class="line">sudo vgs</span><br><span class="line">sudo lvs</span><br><span class="line"></span><br><span class="line">sudo pvcreate /dev/sdb</span><br><span class="line">sudo vgextend vg0 /dev/sdb</span><br><span class="line">sudo lvextend -L +100G /dev/vg0/data</span><br></pre></td></tr></table></figure><h3 id="“Space-not-reclaimed”"><a class="header-anchor" href="#“Space-not-reclaimed”">¶</a>“Space not reclaimed”</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo lsof | grep <span class="string">&#x27;(deleted)&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="Kernel-messages-for-I-O-issues"><a class="header-anchor" href="#Kernel-messages-for-I-O-issues">¶</a>Kernel messages for I/O issues</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dmesg | <span class="built_in">tail</span> -n 200</span><br><span class="line">journalctl -k --since \&quot;1 hour ago\&quot; | <span class="built_in">tail</span> -n 200</span><br></pre></td></tr></table></figure><h3 id="SMART-health-if-available"><a class="header-anchor" href="#SMART-health-if-available">¶</a>SMART health (if available)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo smartctl -a /dev/sda | <span class="built_in">head</span> -n 60</span><br></pre></td></tr></table></figure><h3 id="Two-“save-you-at-3am”-reminders"><a class="header-anchor" href="#Two-“save-you-at-3am”-reminders">¶</a>Two “save you at 3am” reminders</h3><ul><li>Always double-check the target device before destructive operations. If you are unsure, stop and re-run <code>lsblk -f</code>.</li><li>After any change to partitioning/RAID/LVM, verify the layer you just changed is visible <em>before</em> moving to the next layer (block → md → lvm → filesystem → mount).</li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Disk issues in production are rarely fixed by “one magic command”. You’re usually dealing with a whole stack: &lt;strong&gt;hardware behavior (HDD vs SSD)&lt;/strong&gt;, &lt;strong&gt;block devices and partition tables&lt;/strong&gt;, &lt;strong&gt;RAID/LVM layering&lt;/strong&gt;, and finally &lt;strong&gt;filesystem semantics&lt;/strong&gt; (inodes, links, deletion, and why space doesn’t come back). This post walks the end-to-end workflow—identify a new disk, partition it, format it, mount it, make it persistent, expand capacity with minimal downtime, and debug the common failure modes—while also explaining the underlying mechanisms so you can reason about what the system is doing.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>LAMP 与阿里云服务器详解</title>
    <link href="https://chenk.top/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/"/>
    <id>https://chenk.top/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/</id>
    <published>2025-02-15T16:00:00.000Z</published>
    <updated>2026-01-30T01:42:06.346Z</updated>
    
    <content type="html"><![CDATA[<p>把一台刚买的阿里云 ECS 从“能 SSH 登录”变成“公网可访问、可稳定跑站点”的服务器，中间最容易卡在三件事：网络放行（安全组/防火墙）、服务联动（Apache–PHP–MySQL 的请求链路）以及权限与版本（目录权限、PHP 版本与扩展）。这篇文章先用架构图把 LAMP 的工作流讲清楚，然后按可复现的顺序完成：安全组与端口配置、基础环境安装与验证、Apache/MySQL/PHP 的安装与关键配置，最后给出 Discuz 部署与源码编译安装的整套流程（含清理旧环境、依赖准备、服务自启与常见排错点），让你从 0 到 1 把一套传统 Web 栈在云上真正跑起来。</p><span id="more"></span><p>LAMP 是 Linux 服务器上的一套经典 Web 服务器架构，由 <strong>Linux</strong>（操作系统）、<strong>Apache</strong>（Web 服务器）、<strong>MySQL</strong>（数据库）和 <strong>PHP/Python/Perl</strong>（动态脚本语言）组成。阿里云服务器提供了强大的计算资源，使得用户可以在云环境中搭建 LAMP 服务器来部署 Web 应用。</p><hr><h1>LAMP 架构概述</h1><p>LAMP 是构建动态网站和 Web 应用的主流架构。它的每个组件在架构中发挥特定作用：</p><ul><li><strong>Linux</strong>：作为服务器操作系统，提供稳定的运行环境。</li><li><strong>Apache</strong>：作为 Web 服务器，处理 HTTP 请求并将网页内容返回给客户端。</li><li><strong>MySQL</strong>：提供数据库服务，用于存储网站数据。</li><li><strong>PHP、Python、Perl</strong>：用于动态生成网页，与 MySQL 交互，处理用户请求。</li></ul><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/420px-LAMP_software_bundle.svg.png" alt="img"></p><p>下图展示了 LAMP 架构的工作流程：</p><ol><li>用户访问网站，浏览器向 Apache 服务器发送 HTTP 请求。</li><li>Apache 解析请求并调用 PHP 处理逻辑。</li><li>PHP 脚本查询 MySQL 数据库获取数据。</li><li>数据返回给 PHP 处理，并最终由 Apache 服务器返回给用户。</li></ol><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/ee8c173e981c46068d93961c484c43e2.png" alt="LAMP架构_lamp具体结构包括-CSDN博客"></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/992547-20170619140819648-1336856462.png" alt="LAMP架构的详细内容以及通信过程- Nice_keep-going - 博客园"></p><h1>阿里云服务器概述与网络配置</h1><p>阿里云服务器（ECS）为用户提供弹性计算资源，并支持多种操作系统（如 Ubuntu）。在阿里云环境中，关键的网络配置包括公网 IP 与防火墙安全组设置。下面是云服务器控制台的监控界面：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211211700378.png" alt="image-20250211211700378"></p><h2 id="1-阿里云服务器基础"><a class="header-anchor" href="#1-阿里云服务器基础">¶</a>1. 阿里云服务器基础</h2><ul><li><p><strong>弹性扩展</strong>：根据实际需求调整 CPU、内存、带宽等资源。</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211211940966.png" alt="image-20250211211940966"></p></li><li><p><strong>公网 IP</strong>：使服务器可以被外部访问。你可以在阿里云控制台为 ECS 实例分配公网 IP。</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211212019600.png" alt="image-20250211212019600"></p></li><li><p><strong>安全组（防火墙）</strong>：阿里云提供安全组管理工具，用于配置允许哪些端口和 IP 能访问你的服务器。</p></li></ul><h2 id="2-防火墙与公网-IP-配置"><a class="header-anchor" href="#2-防火墙与公网-IP-配置">¶</a>2. 防火墙与公网 IP 配置</h2><h3 id="公网-IP-配置"><a class="header-anchor" href="#公网-IP-配置">¶</a>公网 IP 配置</h3><p>在阿里云 ECS 控制台：</p><ul><li>为实例分配或绑定公网 IP。</li><li>在实例信息中查看公网 IP，并通过浏览器访问测试。</li></ul><h3 id="安全组规则设置"><a class="header-anchor" href="#安全组规则设置">¶</a>安全组规则设置</h3><p>在 ECS 控制台的安全组配置中，添加以下入站规则：</p><ul><li><strong>SSH</strong>：端口 22（允许远程登录）。</li><li><strong>HTTP</strong>：端口 80（用于网站访问）。</li><li><strong>HTTPS</strong>：端口 443（用于安全网站访问）。</li><li>可根据需要开放 MySQL（3306）、FTP 等端口。</li></ul><p>默认安全组配置如下：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211154055070.png" alt="image-20250211154055070"></p><p>配置方式如下：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221452657.png" alt="image-20250211221452657"></p><p>配置结果如下：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221531005.png" alt="image-20250211221531005"></p><p><strong>或在服务器上使用 iptables 命令手动配置：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 允许 HTTP 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"># 允许 HTTPS 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT</span><br><span class="line"># 允许 SSH 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"># 保存规则（Ubuntu 下使用 iptables-persistent）</span><br><span class="line">sudo netfilter-persistent save</span><br></pre></td></tr></table></figure><h1>LAMP 环境搭建（Ubuntu 实例）</h1><p>在阿里云的 Ubuntu 服务器上，搭建 LAMP 环境主要包括安装 Apache、MySQL 和 PHP，并进行简单配置与验证。</p><h2 id="0-准备工作"><a class="header-anchor" href="#0-准备工作">¶</a>0. 准备工作</h2><p>在开始之前，我们一般要关闭所有防火墙（内置防火墙和 Linux 的软件防火墙）。</p><p>第一步就是关闭 <code>selinux</code>，这是美国航空安全局开发的内置防火墙。我们首先可以通过 <code>getenforce</code> 查询 <code>selinux</code> 状态，但基本只有CentOS 8 会有比较多的 <code>seinux</code> 的策略，CentOS7 不用。我们可以修改其默认配置，永久禁止其开机自启：</p><p>第二步是关闭内置的 <code>firewalld</code> 以及清空 <code>iptables</code> 规则：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h2 id="1-安装-Apache-Web-服务器"><a class="header-anchor" href="#1-安装-Apache-Web-服务器">¶</a>1. 安装 Apache Web 服务器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install apache2 -y</span><br><span class="line"></span><br><span class="line"># 或者在CentOS里</span><br><span class="line">yum install httpd -y</span><br></pre></td></tr></table></figure><p>启动并设置 Apache 开机自启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start apache2</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> apache2</span><br></pre></td></tr></table></figure><p>验证：在浏览器访问 <code>http://&lt;公网_IP&gt;/</code> 应显示 Apache 默认欢迎页面。</p><p>⚠️注意，如果之前没有配置安全组通过 80 端口，会显示：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221630066.png" alt="image-20250211221630066"></p><p>按前面说的配置一下安全组就行，最终会显示如下页面：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221716957.png" alt="image-20250211221716957"></p><p>下面为 CentOS 下的 Apache 服务器启动以及测试方式：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211220450481.png" alt="image-20250211220450481"></p><blockquote><p><code>curl ifconfig.me</code> 可以拿到自己的 ip 地址</p></blockquote><h2 id="2-MySQL-数据库"><a class="header-anchor" href="#2-MySQL-数据库">¶</a>2. MySQL 数据库</h2><h3 id="安装"><a class="header-anchor" href="#安装">¶</a>安装</h3><p>命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mysql-server -y</span><br></pre></td></tr></table></figure><p>运行安全安装向导：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure><p>按照提示设置 MySQL root 密码，移除匿名用户，禁止远程 root 登录。</p><p>验证：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></table></figure><p>在阿里云服务器安装时，默认的阿里云源是没有 <code>mysql</code> 的，只有 <code>mariadb</code>：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211222133896.png" alt="image-20250211222133896"></p><p>我们可以给服务器换源：</p><p>首先进入到 <code>/etc/yum.repos.d</code>，进行如下操作：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211225358267.png" alt="image-20250211225358267"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm </span><br></pre></td></tr></table></figure><p>查看 <code>mysql-community.repo</code> 文件：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211225836835.png" alt="image-20250211225836835"></p><p>随后运行以下命令安装即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mysql-community-server</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232057979.png" alt="image-20250211232057979"></p><p>可以输入 <code>mysql_secure_installation</code> 来进行密码设置：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232544886.png" alt="image-20250211232544886"></p><p>登录后可以查看一些基本信息如下：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232802711.png" alt="image-20250211232802711"></p><blockquote><p>当使用源码编译的方式安装 mysql 时如果系统中没有安装 openssl 或其开发头文件和库，就会遇到报错<strong>缺少 openssl</strong>，这时我们需要做两步：</p><ol><li><p><strong>删除编译的目录</strong>：编译失败后，通常会有一个部分完成的目录（即使没有完全成功安装），此时需要删除该目录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /path/to/mysql/source/directory</span><br></pre></td></tr></table></figure><p>删除这个目录，确保不会使用到损坏的或不完整的文件。</p></li><li><p><strong>安装 openssl</strong>：确保系统中安装了 openssl 和相关的开发工具。如果缺少开发头文件，还需要安装 openssl-devel 包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl openssl-devel</span><br></pre></td></tr></table></figure></li><li><p><strong>重新编译 MySQL</strong>：在安装了 openssl 之后，重新进入 MySQL 源代码目录，开始新的编译安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/mysql/source</span><br><span class="line">./configure  <span class="comment"># 配置 MySQL 编译选项</span></span><br><span class="line">make         <span class="comment"># 编译 MySQL</span></span><br><span class="line">make install <span class="comment"># 安装 MySQL</span></span><br></pre></td></tr></table></figure></li></ol></blockquote><h3 id="配置与远程访问"><a class="header-anchor" href="#配置与远程访问">¶</a>配置与远程访问</h3><p>现在我们可以对 MySQL 数据库进行配置与远程访问</p><p><strong>1. 修改 MySQL 绑定地址</strong></p><p>编辑 MySQL 配置文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure><p>找到 bind-address 字段，将其改为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind-address = 0.0.0.0</span><br></pre></td></tr></table></figure><p>保存后退出编辑器，然后重启 MySQL 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart mysql</span><br></pre></td></tr></table></figure><p><strong>2. 创建远程访问用户</strong></p><p>登录 MySQL 客户端：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><p>在 MySQL 提示符下，执行以下 SQL 语句：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;yourpassword&#x27;</span>;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>退出 MySQL。</p><p><strong>3. 安全注意</strong></p><p>确保安全组允许 MySQL 端口（3306）的访问，或通过 SSH 隧道访问 MySQL 服务。</p><h2 id="3-PHP-及相关模块"><a class="header-anchor" href="#3-PHP-及相关模块">¶</a>3. PHP 及相关模块</h2><h3 id="安装-v2"><a class="header-anchor" href="#安装-v2">¶</a>安装</h3><p>命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install php libapache2-mod-php php-mysql -y</span><br><span class="line"><span class="comment"># CentOS下</span></span><br><span class="line">yum install php -y</span><br></pre></td></tr></table></figure><p>验证 PHP 安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 5.4.16 (cli) (built: Apr  1 2020 04:07:17) </span></span><br><span class="line"><span class="comment"># Copyright (c) 1997-2013 The PHP Group</span></span><br><span class="line"><span class="comment"># Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies</span></span><br></pre></td></tr></table></figure><h3 id="创建页面"><a class="header-anchor" href="#创建页面">¶</a>创建页面</h3><p>为了确认 PHP 环境安装成功，我们可以创建一个简单的 <code>phpinfo()</code> 页面。</p><p><strong>1. 创建 <code>phpinfo.php</code> 测试页面</strong></p><p>将以下内容写入 <code>/var/www/html/phpinfo.php</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;?php phpinfo(); ?&gt;&quot; | sudo tee /var/www/html/phpinfo.php</span><br></pre></td></tr></table></figure><p><strong>2. 访问测试页面</strong></p><p>在浏览器中访问：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;公网_IP&gt;/phpinfo.php</span><br></pre></td></tr></table></figure><p>如果页面显示 PHP 的详细配置信息，说明 PHP 安装正确并且与 Apache 正常集成。（访问不成功可以尝试 <code>systemctl restart httpd</code>）</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212000319587.png" alt="image-20250212000319587"></p><p>或者可以尝试些别的，我们可以使用 PHP 的数组、随机函数以及内置的日期函数生成动态内容</p><ul><li>利用 <code>array_rand()</code> 随机选择名言</li><li>使用 <code>date()</code> 函数显示当前时间</li><li>输出简单的 HTML 页面</li></ul><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212000842498.png" alt="image-20250212000842498"></p><h1>Discuz! 论坛部署</h1><p>Discuz! 是一个基于 PHP 和 MySQL 的开源论坛程序，常用于搭建社区网站。下面介绍如何在 LAMP 环境中部署 Discuz!。</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212003942527.png" alt="image-20250212003942527"></p><h2 id="1-下载并解压-Discuz-安装包"><a class="header-anchor" href="#1-下载并解压-Discuz-安装包">¶</a>1. 下载并解压 Discuz! 安装包</h2><p>我们要进入 Apache 的默认目录，可以通过 <code>rpm -ql</code> 来查找：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211235946415.png" alt="image-20250211235946415"></p><p>上面那些 <code>share</code> 的都可以不用管，只有最后一行数据是有用的，也就是我们要找的 Apache 的默认目录，进入 Apache 默认目录并下载：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html</span><br><span class="line">wget https://download.comsenz.com/DiscuzX/3.4/Discuz_X3.4_SC_UTF8.zip</span><br></pre></td></tr></table></figure><p>解压安装包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip Discuz_X3.4_SC_UTF8.zip</span><br></pre></td></tr></table></figure><p>将解压后的内容移动到网站根目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> upload/* /var/www/html/</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005140326.png" alt="image-20250212005140326"></p><h2 id="2-安装-Discuz"><a class="header-anchor" href="#2-安装-Discuz">¶</a>2. 安装 Discuz!</h2><p>在浏览器中访问：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;公网_IP&gt;/install/</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005209279.png" alt="image-20250212005209279"></p><p>发现报错：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005412101.png" alt="image-20250212005412101"></p><p>下面开始升级 PHP 版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 更新系统并安装必要的软件包</span></span><br><span class="line">sudo yum update -y  <span class="comment"># 更新系统</span></span><br><span class="line">sudo yum install -y epel-release yum-utils  <span class="comment"># 安装 EPEL 仓库和 yum-utils 工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装 Remi 仓库（CentOS 7 专用）</span></span><br><span class="line">sudo yum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm  <span class="comment"># 添加 Remi 仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启用所需的 PHP 版本</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">enable</span> remi-php81  <span class="comment"># 这里以 PHP 8.1 为例，其他版本请修改对应的数字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 升级或安装 PHP 及其常见扩展</span></span><br><span class="line">sudo yum install -y php php-cli php-common php-mbstring php-xml php-mysqlnd php-fpm php-opcache php-curl php-gd php-zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 验证 PHP 版本是否正确安装</span></span><br><span class="line">php -v  <span class="comment"># 查看 PHP 版本，确认升级是否成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 选择正确的 PHP 版本（如果 `php -v` 仍然是旧版本）</span></span><br><span class="line">sudo alternatives --config php  <span class="comment"># 可能需要手动选择 PHP 版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 重启 Web 服务器以应用新 PHP 版本</span></span><br><span class="line">sudo systemctl restart httpd  <span class="comment"># 如果使用的是 Apache</span></span><br><span class="line">sudo systemctl restart php-fpm  <span class="comment"># 如果使用的是 Nginx+PHP-FPM</span></span><br><span class="line">sudo systemctl restart nginx  <span class="comment"># 如果 Nginx 也需要重启</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 确保 PHP-FPM 正常运行</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> php-fpm  <span class="comment"># 开机自启 PHP-FPM</span></span><br><span class="line">sudo systemctl status php-fpm  <span class="comment"># 检查 PHP-FPM 运行状态</span></span><br></pre></td></tr></table></figure><p>经过一系列猛如虎的操作，PHP升级成功了，环境检查也不再报错了：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010201948.png" alt="image-20250212010201948"></p><p>但下面又报错了，问题出在了目录权限，下面我们就把目录权限做修改。</p><h2 id="3-配置-Apache-目录权限"><a class="header-anchor" href="#3-配置-Apache-目录权限">¶</a>3. 配置 Apache 目录权限</h2><p>设置文件所有者为 www-data，并赋予适当权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 ./*</span><br></pre></td></tr></table></figure><h2 id="image-20250212010501483"><a class="header-anchor" href="#image-20250212010501483">¶</a><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010501483.png" alt="image-20250212010501483"></h2><p>现在终于大功告成：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010528759.png" alt="image-20250212010528759"></p><p>如果提示少了驱动，我们可以通过 <code>yum install php-mysqli -y</code> 安装</p><p>按照安装向导输入数据库信息：</p><ul><li><strong>数据库地址</strong>：localhost</li><li><strong>数据库名称</strong>：discuz</li><li><strong>数据库用户</strong>：admin</li><li><strong>数据库密码</strong>：yourpassword</li></ul><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212011051827.png" alt="image-20250212011051827"></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212011102231.png" alt="image-20250212011102231"></p><p>完成安装后，即可进入 Discuz! 后台管理，进一步配置论坛设置。</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212013221831.png" alt="image-20250212013221831"></p><h1>源码编译安装</h1><p>我们现在要搞事情，我们现在准备清空整个 LAMP（Linux + Apache + MySQL + PHP）环境并从头开始重新用源码编译，以下是详细的步骤指南。</p><p>MySQL 5.6.31 + PHP 7.2.17</p><h2 id="1-清空原有环境"><a class="header-anchor" href="#1-清空原有环境">¶</a>1. 清空原有环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 停止 Apache 和 MySQL 服务</span></span><br><span class="line">sudo systemctl stop httpd</span><br><span class="line">sudo systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 卸载 Apache、MySQL 和 PHP</span></span><br><span class="line">sudo yum remove httpd mysql mysql-server php php-cli php-fpm php-mysqlnd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除 Apache、MySQL 和 PHP 配置文件和数据文件</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/httpd</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/www</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/mysql</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/my.cnf</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 删除 MySQL 和 Apache 用户和组，组可能不存在，会报错，但不用管</span></span><br><span class="line">sudo userdel mysql</span><br><span class="line">sudo groupdel mysql</span><br><span class="line">sudo userdel apache</span><br><span class="line">sudo groupdel apache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 删除残留的依赖和配置文件</span></span><br><span class="line">sudo yum autoremove</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212115847770.png" alt="image-20250212115847770"></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212115742880.png" alt="image-20250212115742880"></p><h2 id="2-基础软件运行环境准备"><a class="header-anchor" href="#2-基础软件运行环境准备">¶</a>2. 基础软件运行环境准备</h2><p>在重新安装之前，确保系统安装了编译所需的工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum groupinstall <span class="string">&quot;Development Tools&quot;</span></span><br><span class="line">sudo yum install -y gcc-c++ make cmake bison libaio-devel ncurses-devel zlib-devel openssl-devel</span><br></pre></td></tr></table></figure><p>还可以选择安装一些其他的开发包以避免可能存在的错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc patch libffi-devel python-devel bzip2-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel net-tools vim -y</span><br></pre></td></tr></table></figure><p>注意：在开始后续操作之前一定要关闭防火墙（<code>selinux</code> 和 <code>firewalld</code>）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z yum.repos.d]<span class="comment"># systemctl status firewalld</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure><blockquote><p>下载太慢可以更换yum源或dns源或换网络环境</p></blockquote><h2 id="3-编译安装-MySQL"><a class="header-anchor" href="#3-编译安装-MySQL">¶</a>3. 编译安装 MySQL</h2><blockquote><p>编译安装顺序：</p><ol><li>Apache 一定要先于 PHP</li><li>Apache 和 MySQL没有明显的依赖关系，先后无所谓</li><li>在 PHP 3.5 之前，MySQL必须先于 PHP 编译，因为 PHP 需要实现连接数据库的功能，它通过 MySQL接口才能实现这一功能；在 3.5 之后 PHP 已经集成了一套连接 MySQL 数据库的代码，编译顺序无所谓了</li></ol></blockquote><h3 id="创建-MySQL-用户"><a class="header-anchor" href="#创建-MySQL-用户">¶</a>创建 MySQL 用户</h3><p>用于给 MySQL 的数据、进程设置相关的 user 属主：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin mysql</span><br></pre></td></tr></table></figure><h3 id="下载-MySQL"><a class="header-anchor" href="#下载-MySQL">¶</a>下载 MySQL</h3><p>首先我们要创建一个源码目录用于下载对应软件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> software-mysql</span><br><span class="line"><span class="built_in">cd</span> software-mysql</span><br></pre></td></tr></table></figure><p>我们可以在<a class="link" href="https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/">华为提供的库内<i class="fas fa-external-link-alt"></i></a>下载需要的 MySQL 版本：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212171131843.png" alt="image-20250212171131843"></p><p>选择一个合适的版本：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202606094.png" alt="image-20250214202606094"></p><p>下载源码并解压缩：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/MySQL-5.6/mysql-5.6.49.tar.gz</span><br><span class="line">tar -xzvf mysql-5.6.49.tar.gz</span><br></pre></td></tr></table></figure><h3 id="编译安装"><a class="header-anchor" href="#编译安装">¶</a>编译安装</h3><p>进入解压缩后的目录可以发现，这里没有我们之前看到的 <code>configure</code>，只有 <code>cmake</code>，我们需要安装 <code>cmake</code> 命令。然后我们需要在 MySQL 的源码目录下，执行 cmake 命令以配置并生成 Makefile，然后编译源代码。可以将以下命令保存为 <code>cmake.sh</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmake . \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">-DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">-DENABLE_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DMYSQL_TCP_PORT=3306 \</span><br><span class="line">-DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>下面是对这些参数的解释：</p><ul><li>-DCMAKE_INSTALL_PREFIX=/usr/local/mysql：指定 MySQL 安装路径</li><li>-DMYSQL_DATADIR=/usr/local/mysql/data：指定 MySQL 数据目录</li><li>-DENABLE_LOCAL_INFILE=1：启用 LOCAL 文件加载</li><li>-DWITH_INNOBASE_STORAGE_ENGINE=1：启用 InnoDB 存储引擎</li><li>-DMYSQL_TCP_PORT=3306：指定 MySQL 使用的 TCP 端口</li><li>-DDEFAULT_CHARSET=utf8mb4：指定默认字符集为 utf8mb4</li><li>-DDEFAULT_COLLATION=utf8mb4_general_ci：指定默认排序规则为 utf8mb4_general_ci</li><li>-DWITH_EXTRA_CHARSETS=all：启用所有额外字符集</li><li>-DMYSQL_USER=mysql：指定 MySQL 的默认用户</li></ul><p>然后对文件需要修改权限，加入可执行权限，首先运行 <code>cmake.sh</code></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202711590.png" alt="image-20250214202711590"></p><p>运行成功如上图后，执行 <code>make</code>，因为时间不是太久就直接选择前台执行了：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202440317.png" alt="image-20250214202440317"></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214205348391.png" alt="image-20250214205348391"></p><p>运行成功后如上图所示，再执行 <code>make install</code>，就会发现 <code>/usr/local/</code> 路径下多了 <code>mysql</code> 这个文件夹，随后将文件夹里的 <code>bin</code> 目录添加到 <code>~/.bashrc</code> 即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/local/mysql/bin</span><br></pre></td></tr></table></figure><p>保存并激活即可。</p><h3 id="删除旧文件残留"><a class="header-anchor" href="#删除旧文件残留">¶</a>删除旧文件残留</h3><p>我们接下来要检查是否有旧的 <code>mysql</code> 数据文件残留，发现存在我们将其进行移动备份：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214122846366.png" alt="image-20250214122846366"></p><h3 id="修改文件属主属组"><a class="header-anchor" href="#修改文件属主属组">¶</a>修改文件属主属组</h3><p>可以看到现在文件的属主和属组都还是 <code>root</code>，我们需要将其修改为 <code>mysql</code>：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214213331153.png" alt="image-20250214213331153"></p><h3 id="初始化-mysql"><a class="header-anchor" href="#初始化-mysql">¶</a>初始化 <code>mysql</code></h3><p>现在我们开始尝试连接 <code>mysql</code> 客户端，但会报错，说无法连接到本地的 <code>mysql</code> 服务端：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214210714681.png" alt="image-20250214210714681"></p><p>Linux 的软件启动后会有两种形式提供给客户端去访问：</p><ol><li><code>ip:port</code> 形式，如 <code>0.0.0.0:3306</code>，网络连接方式</li><li><code>socket</code> 本地套接字文件形式，本地进程套接字文件，启动 <code>mysql</code>，提供它的本地连接进程文件 <code>tmp/mysql.sock</code>，只要这个文件存在，<code>mysql</code> 就是启动的</li></ol><p>总之就是 <code>mysql</code> 还没启动，因此此时首先要对 <code>mysql</code> 数据库初始化，生成一些必备的数据文件，因为 <code>mysql</code> 要设置账号密码总得有一个库和表可以存储。具体操作如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-5.6.49]<span class="comment"># cd /usr/local/mysql</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql]<span class="comment"># ls ./scripts/</span></span><br><span class="line">mysql_install_db</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql]<span class="comment"># ./scripts/mysql_install_db --user=mysql</span></span><br><span class="line">Installing MySQL system tables...2025-02-14 21:36:08 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="keyword">for</span> more details).</span><br><span class="line">2025-02-14 21:36:08 0 [Note] Ignoring --secure-file-priv value as server is running with --bootstrap.</span><br><span class="line">2025-02-14 21:36:08 0 [Note] ./bin/mysqld (mysqld 5.6.49) starting as process 1270 ...</span><br><span class="line">2025-02-14 21:36:08 1270 [Note] InnoDB: Using atomics to ref count buffer pool pages</span><br><span class="line">2025-02-14 21:36:08 1270 [Note] InnoDB: The InnoDB memory heap is disabled</span><br></pre></td></tr></table></figure><p>运行一长串之后我们会看到两个 OK，这说明初始化成功：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214213731409.png" alt="image-20250214213731409"></p><h3 id="创建启动脚本"><a class="header-anchor" href="#创建启动脚本">¶</a>创建启动脚本</h3><p>因为我们是手动编译安装，还需要自己创建启动脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql</span><br></pre></td></tr></table></figure><p>我们可以查看这个文件：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214214619451.png" alt="image-20250214214619451"></p><p>此时使用 <code>service</code> 命令，会去读取 <code>/etc/init.d</code> 下的脚本文件，启动 <code>mysql</code>：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214214835608.png" alt="image-20250214214835608"></p><h3 id="设置密码与登录"><a class="header-anchor" href="#设置密码与登录">¶</a>设置密码与登录</h3><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214215614743.png" alt="image-20250214215614743"></p><h2 id="4-编译安装-Apache"><a class="header-anchor" href="#4-编译安装-Apache">¶</a>4. 编译安装 Apache</h2><h3 id="安装依赖包-apr"><a class="header-anchor" href="#安装依赖包-apr">¶</a>安装依赖包 <code>apr</code></h3><p><code>apr</code>（Apache portable run-time Libraries，Apache 可移植运行库），主要是为上层的应用程序提供一个可以跨越多操作系统平台的底层支持接口库。下载地址为：<a class="link" href="https://archive.apache.org/dist/apr/%EF%BC%8C%E8%BF%9B%E5%85%A5%E8%AF%A5%E5%9C%B0%E5%9D%80%E4%BC%9A%E6%9C%89%E5%A6%82%E4%B8%8B%E5%86%85%E5%AE%B9%EF%BC%9A">https://archive.apache.org/dist/apr/，进入该地址会有如下内容：<i class="fas fa-external-link-alt"></i></a></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214220544809.png" alt="image-20250214220544809"></p><p>一直往下拉会有一些可以下载的安装包，具体的地址可以用下面的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/apr/apr-1.5.2.tar.bz2</span><br><span class="line">tar -xf apr-1.5.2.tar.bz2; <span class="built_in">cd</span> apr-1.5.2</span><br></pre></td></tr></table></figure><p>可能由于这个版本的一个 bug，这里我们需要修改一个配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim configure</span><br><span class="line"><span class="comment"># 修改 29605 行    ‘RM’ = &#x27;RM -f&#x27;   添加一个 -f 参数</span></span><br></pre></td></tr></table></figure><p>如果不指定配置参数，就会安装到默认路径 <code>/usr/local</code>，一般推荐这些小的依赖库不要修改路径，我们直接 <code>./configure</code>：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214221932200.png" alt="image-20250214221932200"></p><p>然后执行编译三部曲的后两步即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214222220789.png" alt="image-20250214222220789"></p><h3 id="安装基础库-apr-util"><a class="header-anchor" href="#安装基础库-apr-util">¶</a>安装基础库 <code>apr-util</code></h3><p>完整的 APR（Apache 可移植运行库）实际上包含了三个开发包：<code>apr</code>，<code>apr-util</code> 和 <code>apr-iconv</code>，每一个包分别独立开发，并拥有自己的版本。<code>apr-util</code>这个库中也是包含了一些常用的开发组件，这些组件与 <code>apr</code> 目录下的相比，它们与 Apache 的关系更加密切一些，比如存储段和存储段组、加密等。这个包还是在刚刚的 <a class="link" href="https://archive.apache.org/dist/apr/">https://archive.apache.org/dist/apr/<i class="fas fa-external-link-alt"></i></a> 下可以找到</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/apr/apr-util-1.5.4.tar.bz2</span><br><span class="line">tar -xf apr-util-1.5.4.tar.bz2; <span class="built_in">cd</span> apr-util-1.5.4</span><br></pre></td></tr></table></figure><p>然后还是三部曲，这里的 configure 要加个参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-apr=/usr/local/apr/bin/apr-1-config</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214224641704.png" alt="image-20250214224641704"></p><p>此时 <code>apr</code> 和 <code>apr-util</code> 库就生成了一些基础的 Linux 文件（动态链接库，和 C 语言相关），我们需要告诉 Linux 系统多了一些这些工具，Linux 才能读取到这些信息，才能给 Apache 调用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls /usr/local/apr/lib/</span></span><br><span class="line">apr.exp     aprutil.exp  libapr-1.la  libapr-1.so.0      libaprutil-1.a   libaprutil-1.so    libaprutil-1.so.0.5.4</span><br><span class="line">apr-util-1  libapr-1.a   libapr-1.so  libapr-1.so.0.5.2  libaprutil-1.la  libaprutil-1.so.0  pkgconfig</span><br></pre></td></tr></table></figure><blockquote><p>通常，库文件会被安装到标准的系统目录，如 <code>/lib</code>, <code>/lib64</code>, <code>/usr/lib/</code>, <code>/usr/lib64</code> 等地方，这些路径是默认的库文件搜索路径，因此系统和应用程序能够找到它们。</p><p>但是，如果某个软件 <strong>A</strong> 将库文件安装到一个非标准目录，例如 <code>/usr/local/A/lib</code>，那么你需要将该路径添加到系统的动态链接库搜索路径中。否则，系统和其他程序将无法找到这个库文件。</p><p><code>ldconfig</code> 是一个用于动态链接库管理的命令，它的主要作用是搜索系统中的共享动态链接库，并将它们添加到缓存中，以供程序使用。<code>ldconfig</code> 会在以下路径中查找共享库：</p><ul><li>默认搜索路径：<code>/lib</code>, <code>/lib64</code>, <code>/usr/lib/</code>, <code>/usr/lib64</code></li><li>动态库配置文件：<code>/etc/ld.so.conf</code> 中列出的路径</li></ul><p>如果你将新的库文件安装到非标准路径（如 <code>/usr/local/A/lib</code>），你需要通过以下方式更新搜索路径：</p><ol><li>编辑 <code>/etc/ld.so.conf</code> 或添加一个新的 <code>.conf</code> 文件到 <code>/etc/ld.so.conf.d/</code> 目录。</li><li>运行 <code>ldconfig</code> 命令，让系统知道这个新的路径，从而能够找到并使用该路径下的动态库。</li></ol></blockquote><p>具体命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/apr/lib&quot;</span> &gt;&gt; /etc/ld.so.conf</span><br><span class="line"><span class="built_in">cat</span> /etc/ld.so.conf</span><br><span class="line"><span class="comment"># include ld.so.conf.d/*.conf</span></span><br><span class="line"><span class="comment"># /usr/local/apr/lib</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者新建一个 .conf 文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/apr/lib&quot;</span> &gt; /etc/ld.so.conf.d/lamp.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><h3 id="编译-Apache步骤"><a class="header-anchor" href="#编译-Apache步骤">¶</a>编译 Apache步骤</h3><p>回到刚刚的下载安装包的目录，再上一級找到 <code>httpd</code> 获取链接进行 <code>wget</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/httpd/httpd-2.4.37.tar.bz2</span><br><span class="line">tar -xf httpd-2.4.37.tar.bz2; <span class="built_in">cd</span> httpd-2.4.37</span><br></pre></td></tr></table></figure><p>制作配置脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">--enable-modules=all \</span><br><span class="line">--enable-mods-shared=all \</span><br><span class="line">--enable-so \</span><br><span class="line">  --enable-rewrite \</span><br><span class="line">--with-pcre \</span><br><span class="line">--enable-ssl \</span><br><span class="line">--with-mpm=prefork \</span><br><span class="line">--with-apr=/usr/local/apr/bin/apr-1-config \</span><br><span class="line">--with-apr-util=/usr/local/apr/bin/apu-1-config</span><br></pre></td></tr></table></figure><p>添加执行权限并执行脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x apache-configure.sh</span><br><span class="line">./apache-configure.sh</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214233341542.png" alt="image-20250214233341542"></p><p>直接成功结果如上，最后 <code>make &amp; make install</code> 即可，最后安装到了 <code>/usr/local/apache2</code> 下。</p><h3 id="修改配置文件"><a class="header-anchor" href="#修改配置文件">¶</a>修改配置文件</h3><h4 id="语言支持"><a class="header-anchor" href="#语言支持">¶</a>语言支持</h4><p>我们修改 <code>/usr/local/apache2/conf</code> 里的 <code>httpd.conf</code> 的参数以获得中文语言支持，我们删除第 159 行以及 481 行的注释即可：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215002204065.png" alt="image-20250215002204065"></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215002456908.png" alt="image-20250215002456908"></p><p>我们会发现如果想要使用一些功能，只需要在这里取消一些功能的对应注释即可～</p><h4 id="PHP-支持"><a class="header-anchor" href="#PHP-支持">¶</a>PHP 支持</h4><p>另外我们还需要开启 PHP 的插件，当有用户访问 PHP 程序时，Apache 自动转发给 PHP 去解析，168 和 169 行的意思是以 <code>.php</code> 结尾的文件都认为是 PHP 程序文件</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215004856276.png" alt="image-20250215004856276"></p><p>并且要设置当访问这台机器的时候，当什么都不添加时会访问磁盘上的 <code>index.php</code> 文件：</p><p>原本是这样的：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215005511442.png" alt="image-20250215005511442"></p><p>要改成这样（谁在前面就先解析谁）：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215005537989.png" alt="image-20250215005537989"></p><p>这行参数的作用就是会让原本只是访问 <code>8.134.207.88</code> 自动变成访问 <code>8.134.207.88/index.php</code>。</p><h4 id="HTML-文件路径"><a class="header-anchor" href="#HTML-文件路径">¶</a>HTML 文件路径</h4><p>关于网站默认的首页 HTML 文件存放的目录路径由以下参数控制：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215010011089.png" alt="image-20250215010011089"></p><h4 id="修改子配置文件"><a class="header-anchor" href="#修改子配置文件">¶</a>修改子配置文件</h4><p>要修改该配置文件使得优先支持中文：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache2/conf/extra/httpd-languages.conf</span><br></pre></td></tr></table></figure><p>取消第 19 行的注释，将原本的 <code>DefaultLanguage nl</code> 修改为 <code>DefaultLanguage zh-CN</code></p><p>以及调整第 79 行的优先级，将中文的优先级放在第一个：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LanguagePriority zh-CN en ca cs da de el eo es et fr he hr it ja ko ltz <span class="built_in">nl</span> nn no pl pt pt-BR ru sv <span class="built_in">tr</span> zh-TW</span><br></pre></td></tr></table></figure><h4 id="域名设置"><a class="header-anchor" href="#域名设置">¶</a>域名设置</h4><p>可以在主配置文件的这里添加域名：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215010744599.png" alt="image-20250215010744599"></p><h2 id="5-编译安装-PHP"><a class="header-anchor" href="#5-编译安装-PHP">¶</a>5. 编译安装 PHP</h2><h3 id="编译与安装"><a class="header-anchor" href="#编译与安装">¶</a>编译与安装</h3><p>这里比较简单，我们直接快速操作了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://museum.php.net/php7/php-7.2.17.tar.xz</span><br><span class="line">tar -xf php-7.2.17.tar.xz</span><br><span class="line"><span class="built_in">cd</span> php-7.2.17</span><br><span class="line">vim configure_php.sh</span><br></pre></td></tr></table></figure><p>在文件中写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">  --with-apxs2=/usr/local/apache2/bin/apxs \</span><br><span class="line">  --with-mysqli \</span><br><span class="line">  --with-pdo-mysql \</span><br><span class="line">  --with-zlib \</span><br><span class="line">  --with-curl \</span><br><span class="line">  --enable-zip \</span><br><span class="line">  --with-gd \</span><br><span class="line">  --with-freetype-dir \</span><br><span class="line">  --with-jpeg-dir \</span><br><span class="line">  --with-png-dir \</span><br><span class="line">  --enable-sockets \</span><br><span class="line">  --with-xmlrpc \</span><br><span class="line">  --enable-soap \</span><br><span class="line">  --enable-opcache \</span><br><span class="line">  --enable-mbstring \</span><br><span class="line">  --enable-mbregex \</span><br><span class="line">  --enable-pcntl \</span><br><span class="line">  --enable-shmop \</span><br><span class="line">  --enable-sysvmsg \</span><br><span class="line">  --enable-sysvsem \</span><br><span class="line">  --enable-sysvshm \</span><br><span class="line">  --enable-calendar \</span><br><span class="line">  --enable-bcmath</span><br></pre></td></tr></table></figure><p>然后依次执行<code>chmod +x configure_php.sh</code>、 <code>./configure_php.sh</code> 与 <code>make &amp;&amp; make install</code> 即可。</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215014045762.png" alt="image-20250215014045762"></p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215014117280.png" alt="image-20250215014117280"></p><h3 id="检查-Apache是否支持PHP"><a class="header-anchor" href="#检查-Apache是否支持PHP">¶</a>检查 Apache是否支持PHP</h3><p>进入 Apache 的网页根目录 <code>/usr/local/apache2/htdocs</code>，创建一个 PHP 文件，查看是否支持：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215011611322.png" alt="image-20250215011611322"></p><p>启动 Apache：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z php-7.2.17]<span class="comment"># service apache start</span></span><br><span class="line">AH00558: httpd: Could not reliably determine the server<span class="string">&#x27;s fully qualified domain name, using 172.20.53.217. Set the &#x27;</span>ServerName<span class="string">&#x27; directive globally to suppress this message</span></span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215015006688.png" alt="image-20250215015006688"></p><p>查看对应的 IP 地址，访问正常：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215015140320.png" alt="image-20250215015140320"></p><p>由于默认端口和默认文件都已经配置好了，就不需要再写端口和 <code>index.php</code> 了</p><h2 id="6-WordPress"><a class="header-anchor" href="#6-WordPress">¶</a>6. WordPress</h2><p>下载源码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># wget https://cn.wordpress.org/wordpress-4.7.3-zh_CN.tar.gz</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># mkdir wordpress</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># mv wordpress-4.7.3-zh_CN.tar.gz  wordpress</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># cd wordpress/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># tar -zxf wordpress-4.7.3-zh_CN.tar.gz </span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># ls</span></span><br><span class="line">wordpress  wordpress-4.7.3-zh_CN.tar.gz</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># cp -a wordpress/* ../www/test_wordpress_blog/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># chown -R daemon.daemon ../www/test_wordpress_blog/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># rm -rf /usr/local/apache2/htdocs/*</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># mv ../www/test_wordpress_blog/* /usr/local/apache2/htdocs/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># ls /usr/local/apache2/htdocs/</span></span><br><span class="line">index.php    wp-activate.php     wp-comments-post.php  wp-cron.php        wp-load.php   wp-settings.php   xmlrpc.php</span><br><span class="line">license.txt  wp-admin            wp-config-sample.php  wp-includes        wp-login.php  wp-signup.php</span><br><span class="line">readme.html  wp-blog-header.php  wp-content            wp-links-opml.php  wp-mail.php   wp-trackback.php</span><br></pre></td></tr></table></figure><p>访问网站会有下面的内容：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020259972.png" alt="image-20250215020259972"></p><p>填写基本信息后发现我们还没有创建这个数据库：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020513590.png" alt="image-20250215020513590"></p><p>我们进入 MySQL 进行操作：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020803966.png" alt="image-20250215020803966"></p><p>注意我们需要回到前面修改我们前面创建的数据库名，使得数据库名与我们创建的能对得上：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020903213.png" alt="image-20250215020903213"></p><p>然后再执行一下傻瓜操作：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020921167.png" alt="image-20250215020921167"></p><p>然后执行完下面这一步就结束了：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215021153620.png" alt="image-20250215021153620"></p><p>一个漂亮的博客管理页面就做好啦：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215021254303.png" alt="image-20250215021254303"></p><hr><h1><code>debug</code>日志</h1><h2 id="1-新版本-MySQL-安装凉经"><a class="header-anchor" href="#1-新版本-MySQL-安装凉经">¶</a>1. 新版本 MySQL 安装凉经</h2><p>这里我们创建文件夹的方式都一样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> software-mysql</span><br><span class="line"><span class="built_in">cd</span> software-mysql</span><br></pre></td></tr></table></figure><p>同样在<a class="link" href="https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/">华为提供的库内<i class="fas fa-external-link-alt"></i></a>下载需要的 MySQL 版本，我们选择了较新版的 8.0.25：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212171518515.png" alt="image-20250212171518515"></p><p>下载源码并解压缩：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/MySQL-8.0/mysql-8.0.25.tar.gz</span><br><span class="line">tar -xzvf mysql-8.0.25.tar.gz</span><br><span class="line"><span class="built_in">du</span> -sh *</span><br></pre></td></tr></table></figure><h3 id="🧰-关于-cmake-版本"><a class="header-anchor" href="#🧰-关于-cmake-版本">¶</a>🧰 关于 cmake 版本</h3><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212175149284.png" alt="image-20250212175149284"></p><p>在安装 MySQL 的时候我们需要使用 <code>cmake</code> 进行编译，首先我遇到了 <code>cmake</code> 的版本问题，我们通过升级 <code>cmake</code> 版本修正这个问题：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212200732906.png" alt="image-20250212200732906"></p><p>修改指令并尝试运行该文件</p><h3 id="🧰-gcc-路径"><a class="header-anchor" href="#🧰-gcc-路径">¶</a>🧰 gcc 路径</h3><p>好的，不出意外地再次报错</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212200925468.png" alt="image-20250212200925468"></p><p>我们通过 <code>cmak</code> <code>命令中的 </code>CMAKE_C_COMPILER<code>和</code>CMAKE_CXX_COMPILER` 变量来手动指定编译器路径。例如，假设 gcc 和 g++ 安装在默认路径下，尝试如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 . \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>依然不是很成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-8.0.25]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 4.8.5</span><br><span class="line">-- The CXX compiler identification is GNU 4.8.5</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">CMake Error at CMakeLists.txt:382 (MESSAGE):</span><br><span class="line">  Please <span class="keyword">do</span> not build in-source.  Out-of <span class="built_in">source</span> builds are highly</span><br><span class="line">  recommended: you can have multiple builds <span class="keyword">for</span> the same <span class="built_in">source</span>, and there is</span><br><span class="line">  an easy way to <span class="keyword">do</span> cleanup, simply remove the build directory (note that</span><br><span class="line">  <span class="string">&#x27;make clean&#x27;</span> or <span class="string">&#x27;make distclean&#x27;</span> does *not* work)</span><br><span class="line"></span><br><span class="line">  You *can* force in-source build by invoking cmake with</span><br><span class="line">  -DFORCE_INSOURCE_BUILD=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br></pre></td></tr></table></figure><p>这条报错是在说 CMake 强烈建议不要在源代码目录内进行编译，因为这样会造成源代码目录的污染，无法轻松清理。理想的做法是 <strong>在源代码外的单独目录中进行构建</strong>。这个还比较好解决，如果我们非要<strong>在源代码目录中构建，可以通过使用 -DFORCE_INSOURCE_BUILD=1 强制进行构建，但这不是推荐的做法：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 强制在源代码目录内构建</span></span><br><span class="line">cmake3 . -DFORCE_INSOURCE_BUILD=1</span><br></pre></td></tr></table></figure><p>推荐的做法是：</p><p><strong>2. 在源代码目录之外创建一个新的目录进行构建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回到 /usr/local/software-mysql</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/software-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的构建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> mysql-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入构建目录</span></span><br><span class="line"><span class="built_in">cd</span> mysql-build</span><br></pre></td></tr></table></figure><p>那我们使用后者吧：</p><p>在开始编译之前我们需要清理原来的 <code>builds</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /usr/local/software-mysql/mysql-8.0.25/CMakeFiles</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/local/software-mysql/mysql-8.0.25/CMakeCache.txt</span><br></pre></td></tr></table></figure><p>然后我们修改 <code>cmake.sh</code> 命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 /usr/local/software-mysql/mysql-8.0.25 \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>再运行它一次！我不信还会出错了！</p><p>然而。。。果然又有新的问题了。。。这次是 GCC 版本过低，MySQL 8.0.25 需要 GCC 5.3 或更高版本来进行编译：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- Found Git: /usr/bin/git (found version <span class="string">&quot;1.8.3.1&quot;</span>) </span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 4.8.5</span><br><span class="line">-- The CXX compiler identification is GNU 4.8.5</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-build</span><br><span class="line">-- CMAKE_GENERATOR: Unix Makefiles</span><br><span class="line">CMake Error at cmake/os/Linux.cmake:80 (MESSAGE):</span><br><span class="line">  GCC 5.3 or newer is required (-dumpversion says 4.8.5)</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:491 (INCLUDE)</span><br></pre></td></tr></table></figure><h3 id="🧰-关于-centos-release-scl-的一个小插曲（待解决）"><a class="header-anchor" href="#🧰-关于-centos-release-scl-的一个小插曲（待解决）">¶</a>🧰 关于 <code>centos-release-scl</code> 的一个小插曲（待解决）</h3><p>我试图安装 <code>centos-release-scl</code> 进而安装新版本的 <code>gcc</code>，这个软件包提供了 <strong>Software Collections (SCL)</strong> 的支持。SCL 是一种在不影响系统默认软件版本的情况下，让用户安装和使用不同版本的软件包的机制。简单来说，它允许用户安装、使用与系统默认版本不同的软件版本，例如最新版本的 Python、GCC、Ruby、PHP 等，而不需要更改系统的默认版本。SCL 提供了以下优势：</p><ol><li>你可以同时使用多个版本的相同软件，比如使用系统自带的老版本 Python，同时安装并使用新版本的 Python。</li><li>在不同的环境中切换版本变得更加灵活。</li><li>不会影响到系统自带的包，减少了与其他系统包的冲突风险。</li></ol><p>安装命令很简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install centos-release-scl -y</span><br></pre></td></tr></table></figure><p>但安装完之后其他包的安装存在了问题，例如我原本准备执行这个命令安装 <code>gcc</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install devtoolset-8-gcc* -y</span><br></pre></td></tr></table></figure><p>然而报了如下的错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># sudo yum install devtoolset-8-gcc* -y</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Could not retrieve mirrorlist http://mirrorlist.centos.org?<span class="built_in">arch</span>=x86_64&amp;release=7&amp;repo=sclo-rh error was</span><br><span class="line">14: curl<span class="comment">#6 - &quot;Could not resolve host: mirrorlist.centos.org; Unknown error&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> One of the configured repositories failed (Unknown),</span><br><span class="line"> and yum doesn<span class="string">&#x27;t have enough cached data to continue. At this point the only</span></span><br><span class="line"><span class="string"> safe thing yum can do is fail. There are a few ways to work &quot;fix&quot; this:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     1. Contact the upstream for the repository and get them to fix the problem.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     2. Reconfigure the baseurl/etc. for the repository, to point to a working</span></span><br><span class="line"><span class="string">        upstream. This is most often useful if you are using a newer</span></span><br><span class="line"><span class="string">        distribution release than is supported by the repository (and the</span></span><br><span class="line"><span class="string">        packages for the previous distribution release still work).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     3. Run the command with the repository temporarily disabled</span></span><br><span class="line"><span class="string">            yum --disablerepo=&lt;repoid&gt; ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     4. Disable the repository permanently, so yum won&#x27;</span>t use it by default. Yum</span><br><span class="line">        will <span class="keyword">then</span> just ignore the repository until you permanently <span class="built_in">enable</span> it</span><br><span class="line">        again or use --enablerepo <span class="keyword">for</span> temporary usage:</span><br><span class="line"></span><br><span class="line">            yum-config-manager --<span class="built_in">disable</span> &lt;repoid&gt;</span><br><span class="line">        or</span><br><span class="line">            subscription-manager repos --<span class="built_in">disable</span>=&lt;repoid&gt;</span><br><span class="line"></span><br><span class="line">     5. Configure the failing repository to be skipped, <span class="keyword">if</span> it is unavailable.</span><br><span class="line">        Note that yum will try to contact the repo. when it runs most commands,</span><br><span class="line">        so will have to try and fail each time (and thus. yum will be be much</span><br><span class="line">        slower). If it is a very temporary problem though, this is often a <span class="built_in">nice</span></span><br><span class="line">        compromise:</span><br><span class="line"></span><br><span class="line">            yum-config-manager --save --<span class="built_in">setopt</span>=&lt;repoid&gt;.skip_if_unavailable=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Cannot find a valid baseurl <span class="keyword">for</span> repo: centos-sclo-rh/x86_64</span><br></pre></td></tr></table></figure><p>显示软件源可以看到多了两条：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># ls /etc/yum.repos.d/</span></span><br><span class="line">CentOS-Base.repo  CentOS-SCLo-scl.repo  CentOS-SCLo-scl-rh.repo  epel.repo  epel.repo.rpmnew  epel-testing.repo</span><br></pre></td></tr></table></figure><p>以 <code>CentOS-SCLo-scl.repo</code> 为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># cat /etc/yum.repos.d/CentOS-SCLo-scl.repo </span></span><br><span class="line"><span class="comment"># CentOS-SCLo-sclo.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see http://wiki.centos.org/SpecialInterestGroup/SCLo for more</span></span><br><span class="line"><span class="comment"># information</span></span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo]</span><br><span class="line">name=CentOS-7 - SCLo sclo</span><br><span class="line"><span class="comment"># baseurl=http://mirror.centos.org/centos/7/sclo/$basearch/sclo/</span></span><br><span class="line">mirrorlist=http://mirrorlist.centos.org?<span class="built_in">arch</span>=<span class="variable">$basearch</span>&amp;release=7&amp;repo=sclo-sclo</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-testing]</span><br><span class="line">name=CentOS-7 - SCLo sclo Testing</span><br><span class="line">baseurl=http://buildlogs.centos.org/centos/7/sclo/<span class="variable">$basearch</span>/sclo/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-source]</span><br><span class="line">name=CentOS-7 - SCLo sclo Sources</span><br><span class="line">baseurl=http://vault.centos.org/centos/7/sclo/Source/sclo/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-debuginfo]</span><br><span class="line">name=CentOS-7 - SCLo sclo Debuginfo</span><br><span class="line">baseurl=http://debuginfo.centos.org/centos/7/sclo/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br></pre></td></tr></table></figure><p>我们只能先禁用他们：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁用 centos-sclo-sclo 仓库</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">disable</span> centos-sclo-sclo</span><br><span class="line">sudo yum-config-manager --<span class="built_in">disable</span> centos-sclo-rh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除缓存</span></span><br><span class="line">sudo yum clean all</span><br><span class="line">sudo yum makecache</span><br></pre></td></tr></table></figure><p>这个限于目前的技术水平，暂时不知道是什么原因，我估计是梯子的问题，留待之后排查</p><h3 id="🧰-继续解决前面的-gcc-版本问题"><a class="header-anchor" href="#🧰-继续解决前面的-gcc-版本问题">¶</a>🧰 继续解决前面的 <code>gcc</code> 版本问题</h3><p>我们可以尝试直接源码编译</p><p>访问 GCC 的官方网站下载最新版本的源代码，并执行 configure 脚本以及编译步骤：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.gnu.org/gnu/gcc/gcc-8.5.0/gcc-8.5.0.tar.gz</span><br><span class="line">tar -xvzf gcc-8.5.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> gcc-8.5.0</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">sudo yum install -y gmp-devel mpfr-devel libmpc-devel</span><br><span class="line"><span class="comment"># 运行 configure 脚本</span></span><br><span class="line">./configure --disable-multilib --enable-languages=c,c++</span><br><span class="line"></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)  <span class="comment"># 使用所有 CPU 核心加速编译</span></span><br><span class="line"><span class="comment"># 通过 make -j 来增加并行任务数，make -j2 表示使用两个并行任务</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>这个编译过程特别耗时，对于 GCC 8.5.0 这种大型项目，单核 CPU 编译可能需要 <strong>6-12 小时</strong>，两核 CPU 的情况下，可能需要 <strong>3-6 小时</strong> 或更长时间。</p><p>编译完之后，我们还需要把这个<code> gcc</code> 的路径加入到环境变量中，特别是 <code>PATH</code> 和 <code>LD_LIBRARY_PATH</code>，首先我们查找路径：</p><ol><li><p>找到新 GCC 的安装路径。通常，<code>make install</code> 会将 GCC 安装到 <code>/usr/local/bin</code> 中。</p></li><li><p>通过以下命令检查新 GCC 是否安装在 <code>/usr/local/bin</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /usr/local/bin/gcc</span><br></pre></td></tr></table></figure><p>如果文件存在，表示新的 GCC 已安装在该目录。</p></li></ol><p>接下来在 <code>~/.bashrc</code> 文件中添加新 GCC 的路径：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/local/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/local/lib64:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213181357527.png" alt="image-20250213181357527"></p><p>然后退出并 <code>source ~/.bashrc</code> 即可，我们再次打印 <code>gcc --version</code> 会发现版本已经更新了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># vim ~/.bashrc</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># source ~/.bashrc</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># gcc --version</span></span><br><span class="line">gcc (GCC) 8.5.0</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure><h3 id="🧰-Boost-依赖项"><a class="header-anchor" href="#🧰-Boost-依赖项">¶</a>🧰 <code>Boost</code> 依赖项</h3><p>我们需要修改 <code>cmake.sh</code> 文件里的 <code>gcc</code> 的路径为最新安装的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 /usr/local/software-mysql/mysql-8.0.25  \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/local/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/local/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>然后清除目录下的 CMakeFiles 和 CMakeCache.txt：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># rm -rf CMakeFiles</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># rm -rf CMakeCache.txt</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh</span></span><br></pre></td></tr></table></figure><p>现在出现了新的报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- Found Git: /usr/bin/git (found version <span class="string">&quot;1.8.3.1&quot;</span>) </span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 8.5.0</span><br><span class="line">-- The CXX compiler identification is GNU 8.5.0</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/local/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/local/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/local/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/local/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-build</span><br><span class="line">-- CMAKE_GENERATOR: Unix Makefiles</span><br><span class="line">-- Looking <span class="keyword">for</span> SHM_HUGETLB</span><br><span class="line">-- Looking <span class="keyword">for</span> SHM_HUGETLB - found</span><br><span class="line">-- Looking <span class="keyword">for</span> sys/types.h</span><br><span class="line">-- Looking <span class="keyword">for</span> sys/types.h - found</span><br><span class="line">-- Looking <span class="keyword">for</span> stdint.h</span><br><span class="line">-- Looking <span class="keyword">for</span> stdint.h - found</span><br><span class="line">-- Looking <span class="keyword">for</span> stddef.h</span><br><span class="line">-- Looking <span class="keyword">for</span> stddef.h - found</span><br><span class="line">-- Check size of void *</span><br><span class="line">-- Check size of void * - <span class="keyword">done</span></span><br><span class="line">-- SIZEOF_VOIDP 8</span><br><span class="line">-- Performing Test HAVE_C_FLOATING_POINT_FUSED_MADD</span><br><span class="line">-- Performing Test HAVE_C_FLOATING_POINT_FUSED_MADD - Failed</span><br><span class="line">-- Performing Test HAVE_CXX_FLOATING_POINT_FUSED_MADD</span><br><span class="line">-- Performing Test HAVE_CXX_FLOATING_POINT_FUSED_MADD - Failed</span><br><span class="line">-- Packaging as: mysql-8.0.25-Linux-x86_64</span><br><span class="line">-- Performing Test C_LD_LLD_RESULT</span><br><span class="line">-- Performing Test C_LD_LLD_RESULT - Failed</span><br><span class="line">-- Performing Test CXX_LD_LLD_RESULT</span><br><span class="line">-- Performing Test CXX_LD_LLD_RESULT - Failed</span><br><span class="line">-- Performing Test C_LD_GOLD_RESULT</span><br><span class="line">-- Performing Test C_LD_GOLD_RESULT - Success</span><br><span class="line">-- Performing Test CXX_LD_GOLD_RESULT</span><br><span class="line">-- Performing Test CXX_LD_GOLD_RESULT - Success</span><br><span class="line">-- Looked <span class="keyword">for</span> boost/version.hpp <span class="keyword">in</span>  and </span><br><span class="line">-- BOOST_INCLUDE_DIR BOOST_INCLUDE_DIR-NOTFOUND</span><br><span class="line">-- LOCAL_BOOST_DIR </span><br><span class="line">-- LOCAL_BOOST_ZIP </span><br><span class="line">-- Could not find (the correct version of) boost.</span><br><span class="line">-- MySQL currently requires boost_1_73_0</span><br><span class="line"></span><br><span class="line">CMake Error at cmake/boost.cmake:107 (MESSAGE):</span><br><span class="line">  You can download it with -DDOWNLOAD_BOOST=1 -DWITH_BOOST=&lt;directory&gt;</span><br><span class="line"></span><br><span class="line">  This CMake script will look <span class="keyword">for</span> boost <span class="keyword">in</span> &lt;directory&gt;.  If it is not there,</span><br><span class="line">  it will download and unpack it (<span class="keyword">in</span> that directory) <span class="keyword">for</span> you.</span><br><span class="line"></span><br><span class="line">  You can also download boost manually, from</span><br><span class="line">  https://dl.bintray.com/boostorg/release/1.73.0/source/boost_1_73_0.tar.gz</span><br><span class="line"></span><br><span class="line">  If you are inside a firewall, you may need to use an https proxy:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> https_proxy=http://example.com:80</span><br><span class="line"></span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  cmake/boost.cmake:276 (COULD_NOT_FIND_BOOST)</span><br><span class="line">  CMakeLists.txt:1147 (INCLUDE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also <span class="string">&quot;/usr/local/software-mysql/mysql-build/CMakeFiles/CMakeOutput.log&quot;</span>.</span><br><span class="line">See also <span class="string">&quot;/usr/local/software-mysql/mysql-build/CMakeFiles/CMakeError.log&quot;</span>.</span><br></pre></td></tr></table></figure><p>当前问题是 <strong>找不到 Boost 1.73.0</strong> 版本，这是 MySQL 8.0.25 的一个依赖项。</p><ol><li><p><strong>下载并安装 Boost 1.73.0</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/software-mysql/mysql-build</span><br><span class="line">wget https://archives.boost.io/release/1.73.0/source/boost_1_73_0.tar.gz</span><br><span class="line">tar -xvzf boost_1_73_0.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>在 <code>cmake.sh</code> 文件最后添加一行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-DWITH_BOOST=/usr/local/software-mysql/mysql-build/boost_1_73_0</span><br></pre></td></tr></table></figure></li><li><p>然后执行 <code>cmake.sh</code> 文件即可：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213191157461.png" alt="image-20250213191157461"></p></li></ol><p>成功～</p><p>我们将所有 CPU 一起启动在后台安装，并将日志输出到 <code>mysql_make_output.log</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> make -j$(<span class="built_in">nproc</span>) &gt; mysql_make_output.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213191603813.png" alt="image-20250213191603813"></p><p>胜利的曙光就在眼前～让我们拭目以待！！！</p><h3 id="🧰-程序被系统终止（重新-make）"><a class="header-anchor" href="#🧰-程序被系统终止（重新-make）">¶</a>🧰 程序被系统终止（重新 <code>make</code>）</h3><p>不出意外的是，又出问题了 👿</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213204627873.png" alt="image-20250213204627873"></p><blockquote><p>可能的原因如下：</p><p><strong>1. 内存不足</strong></p><p>编译 MySQL 这样的复杂程序时，特别是在使用 <code>make -j$(nproc)</code> 进行并行编译时，系统可能会耗尽内存。<code>cc1plus</code> 是 <code>g++</code> 编译器的一个关键部分，当系统的内存不足时，操作系统可能会终止该进程。</p><p><strong>解决方案</strong>：</p><ul><li>增加系统的物理内存。</li><li>如果是虚拟机，考虑增加虚拟内存或增加物理内存。</li><li>如果不能增加内存，可以尝试减少并行任务数，使用 <code>make -j2</code> 或者 <code>make -j1</code> 让编译过程使用较少的内存。</li></ul><p><strong>2. SWAP空间不足</strong></p><p>当内存不足时，系统会使用交换空间（SWAP）。如果 SWAP 空间不足，也会导致编译失败。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查当前的 SWAP 空间：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon -s</span><br></pre></td></tr></table></figure></li><li><p>如果 SWAP 空间不足，可以通过以下命令增加 SWAP：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1M count=4096  <span class="comment"># 创建一个 4GB 的交换文件</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /swapfile  <span class="comment"># 设置权限</span></span><br><span class="line">sudo mkswap /swapfile  <span class="comment"># 设置交换文件</span></span><br><span class="line">sudo swapon /swapfile  <span class="comment"># 启用交换文件</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>3. CPU 或系统资源被占满</strong></p><p>由于并行编译使用了大量的 CPU 核心，系统可能因资源消耗过高导致进程被杀死。</p><p><strong>解决方案</strong>：</p><ul><li>降低 make 命令的并行度，减少 CPU 核心数的使用，尝试 make -j2 或 make -j1。</li></ul><p><strong>4. 硬盘空间不足</strong></p><p>如果磁盘空间不足，编译过程中的临时文件和输出文件可能无法正确写入磁盘，导致编译中断。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查磁盘空间：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure></li><li><p>如果磁盘空间不足，删除一些不必要的文件或扩展磁盘空间。</p></li></ul><p><strong>5. 系统限制</strong></p><p>Linux 系统有时会根据进程的资源使用情况（如内存、CPU 时间等）进行限制，可能会在某些情况下杀死进程。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查 ulimit 设置，增加进程允许使用的内存或文件描述符数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -a  <span class="comment"># 查看所有限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -n  <span class="comment"># 查看文件描述符限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -u  <span class="comment"># 查看最大进程数限制</span></span><br></pre></td></tr></table></figure></li></ul></blockquote><p>经过检查猜测大概率是内存不足的问题，现在我们需要使用 <code>make clean</code> 命令清理之前的编译结果，这会删除 <code>make</code> 过程中生成的所有中间文件和目标文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line"><span class="built_in">rm</span> -rf CMakeCache.txt CMakeFiles</span><br><span class="line">./cmake.sh</span><br></pre></td></tr></table></figure><p>我们对交换空间、虚拟内存与 CPU 核数均做了优化：</p><ol><li><p>按前面所说流程增加交换空间大小</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1M count=4096  <span class="comment"># 创建一个 4GB 的交换文件</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /swapfile  <span class="comment"># 设置权限</span></span><br><span class="line">sudo mkswap /swapfile  <span class="comment"># 设置交换文件</span></span><br><span class="line">sudo swapon /swapfile  <span class="comment"># 启用交换文件</span></span><br></pre></td></tr></table></figure></li><li><p>为了让交换空间在系统重启后自动生效，编辑 /etc/fstab 文件并添加以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/swapfile none swap sw 0 0</span><br></pre></td></tr></table></figure></li><li><p>然后增加操作系统的虚拟内存限制，来避免进程因内存溢出而被杀死：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -v unlimited</span><br></pre></td></tr></table></figure></li><li><p>最后再尝试使用单核 CPU 进行编译：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./cmake.sh</span><br><span class="line"><span class="built_in">nohup</span> make -j1 &gt; mysql_make_output.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 使用下面命令查看日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /usr/local/software-mysql/mysql-build/mysql_make_output.log</span><br></pre></td></tr></table></figure></li></ol><p>下面还是老样子，再次祈祷！</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214105213109.png" alt="image-20250214105213109"></p><p>经过了漫长的等待，终于迎来了胜利！</p><p>再把这个 <code>bin</code> 的路径保存到 <code>~/.bashrc</code> 并激活即可：</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214121526166.png" alt="image-20250214121526166"></p><h3 id="🧰-gcc-版本还是太低"><a class="header-anchor" href="#🧰-gcc-版本还是太低">¶</a>🧰 gcc 版本还是太低</h3><p>看起来一切都很顺利，但在最后的初始化这一步还是凉了～</p><p><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214132359514.png" alt="image-20250214132359514"></p><p>运行以下命令来列出 libstdc++ 的版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># strings /usr/lib64/libstdc++.so.6 | grep GLIBCXX</span></span><br><span class="line">GLIBCXX_3.4</span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line">GLIBCXX_3.4.3</span><br><span class="line">GLIBCXX_3.4.4</span><br><span class="line">GLIBCXX_3.4.5</span><br><span class="line">GLIBCXX_3.4.6</span><br><span class="line">GLIBCXX_3.4.7</span><br><span class="line">GLIBCXX_3.4.8</span><br><span class="line">GLIBCXX_3.4.9</span><br><span class="line">GLIBCXX_3.4.10</span><br><span class="line">GLIBCXX_3.4.11</span><br><span class="line">GLIBCXX_3.4.12</span><br><span class="line">GLIBCXX_3.4.13</span><br><span class="line">GLIBCXX_3.4.14</span><br><span class="line">GLIBCXX_3.4.15</span><br><span class="line">GLIBCXX_3.4.16</span><br><span class="line">GLIBCXX_3.4.17</span><br><span class="line">GLIBCXX_3.4.18</span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># strings /usr/lib64/libstdc++.so.6 | grep CXXABI</span></span><br><span class="line">CXXABI_1.3</span><br><span class="line">CXXABI_1.3.1</span><br><span class="line">CXXABI_1.3.2</span><br><span class="line">CXXABI_1.3.3</span><br><span class="line">CXXABI_1.3.4</span><br><span class="line">CXXABI_1.3.5</span><br><span class="line">CXXABI_1.3.6</span><br><span class="line">CXXABI_1.3.7</span><br><span class="line">CXXABI_TM_1</span><br></pre></td></tr></table></figure><p>还得重新安装 GCC 9 才能行得通，886了！下次安装前一定要提前看好适配的包是什么，要去官网先看一遍安装教程，不然又会凉 🥹 血的教训！一定要人家写了什么版本就安装什么版本！！</p><h2 id="2-PHP-编译"><a class="header-anchor" href="#2-PHP-编译">¶</a>2. PHP 编译</h2><p>如果 <code>configure</code> 的时候遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: libxml2 not found. Please check your libxml2 installation.</span><br></pre></td></tr></table></figure><p>可以执行以下命令补充安装再次 <code>configure</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install libxml2 libxml2-devel -y</span><br></pre></td></tr></table></figure><p>遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checking <span class="keyword">for</span> cURL 7.10.5 or greater... configure: error: cURL version 7.10.5 or later is required to compile php with cURL support</span><br></pre></td></tr></table></figure><p>则升级 <code>cURL</code> 即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install curl curl-devel -y</span><br></pre></td></tr></table></figure><p>遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checking whether to <span class="built_in">enable</span> JIS-mapped Japanese font support <span class="keyword">in</span> GD... no</span><br><span class="line">If configure fails try --with-webp-dir=&lt;DIR&gt;</span><br><span class="line">configure: error: jpeglib.h not found.</span><br></pre></td></tr></table></figure><p>说明在配置 PHP 时，找不到 jpeglib.h 头文件，这是 JPEG 图像库的一部分，PHP 在编译时需要它来支持处理 JPEG 图像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install libjpeg-devel -y</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;把一台刚买的阿里云 ECS 从“能 SSH 登录”变成“公网可访问、可稳定跑站点”的服务器，中间最容易卡在三件事：网络放行（安全组/防火墙）、服务联动（Apache–PHP–MySQL 的请求链路）以及权限与版本（目录权限、PHP 版本与扩展）。这篇文章先用架构图把 LAMP 的工作流讲清楚，然后按可复现的顺序完成：安全组与端口配置、基础环境安装与验证、Apache/MySQL/PHP 的安装与关键配置，最后给出 Discuz 部署与源码编译安装的整套流程（含清理旧环境、依赖准备、服务自启与常见排错点），让你从 0 到 1 把一套传统 Web 栈在云上真正跑起来。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>LAMP Stack on Alibaba Cloud ECS: From Fresh Instance to Production-Ready Web Server</title>
    <link href="https://chenk.top/en/lamp-on-ecs/"/>
    <id>https://chenk.top/en/lamp-on-ecs/</id>
    <published>2025-02-15T16:00:00.000Z</published>
    <updated>2026-01-29T16:52:14.338Z</updated>
    
    <content type="html"><![CDATA[<p>Turning a fresh Alibaba Cloud ECS instance from “I can SSH in” to “public visitors can access my site reliably” involves three common stumbling blocks: network access (security groups + firewall rules), service coordination (Apache–PHP–MySQL request pipeline), and permission/version mismatches (directory ownership, PHP extensions, MySQL authentication). This guide first clarifies the LAMP architecture with diagrams, then walks through security group configuration, environment installation with verification steps, Apache/MySQL/PHP installation with key configurations, and finally a complete Discuz deployment plus source-compile installation workflow (including cleanup, dependency preparation, service auto-start, and common troubleshooting scenarios). By the end, you’ll have a traditional Web stack running on the cloud from 0 to 1.</p><span id="more"></span><h1>Why LAMP Still Matters in 2025</h1><p>LAMP (<strong>L</strong>inux + <strong>A</strong>pache + <strong>M</strong>ySQL + <strong>P</strong>HP) is often dismissed as “legacy” compared to containerized microservices, but for small to mid-sized content sites, CMS platforms (WordPress, Discuz, Drupal), and many SaaS backends, LAMP remains the <strong>most cost-effective, well-documented, and maintenance-friendly</strong> solution.</p><p><strong>Key advantages</strong>:</p><ul><li><strong>Mature ecosystem</strong>: Decades of plugins, tutorials, stack overflow answers</li><li><strong>Shared hosting compatibility</strong>: Easy to migrate from/to managed hosting</li><li><strong>Predictable performance</strong>: No orchestration overhead, direct request path</li><li><strong>Lower barrier</strong>: One server, three services—easier to reason about than Kubernetes</li></ul><p><strong>When NOT to use LAMP</strong>:</p><ul><li>High concurrency APIs (consider Nginx + Node/Go/Rust)</li><li>Microservices architecture (use Docker + orchestration)</li><li>Real-time features (WebSocket-heavy apps prefer event-driven stacks)</li></ul><hr><h1>LAMP Architecture: The Request Flow</h1><p>Understanding how a request travels through the stack is critical for debugging.</p><h2 id="The-four-layer-model"><a class="header-anchor" href="#The-four-layer-model">¶</a>The four-layer model</h2><ol><li><p><strong>User → Apache (Web Server)</strong><br>Browser sends HTTP request to port 80/443. Apache parses the URL and determines which file to serve.</p></li><li><p><strong>Apache → PHP (Application Runtime)</strong><br>If the requested file is <code>.php</code>, Apache invokes PHP via <code>mod_php</code> or FastCGI to execute the script.</p></li><li><p><strong>PHP → MySQL (Database)</strong><br>PHP script queries MySQL via <code>mysqli</code>/<code>PDO</code> extensions to fetch/store data.</p></li><li><p><strong>MySQL → PHP → Apache → User</strong><br>Data flows back through the same pipeline, rendered as HTML and returned to the browser.</p></li></ol><p><strong>Critical interfaces to verify</strong>:</p><ul><li>Apache can read <code>.php</code> files (file permissions)</li><li>Apache can invoke PHP (module loaded)</li><li>PHP can connect to MySQL (extension installed, credentials correct)</li></ul><hr><h1>Part I: Alibaba Cloud ECS Networking Setup</h1><p>Before installing any software, you must open ports at two layers: <strong>cloud security group</strong> (virtual firewall) and <strong>OS-level firewall</strong> (iptables/firewalld).</p><h2 id="1-Assigning-a-Public-IP"><a class="header-anchor" href="#1-Assigning-a-Public-IP">¶</a>1. Assigning a Public IP</h2><p>In the ECS console:</p><ul><li>Select your instance → <strong>Networking</strong> → <strong>Public IP</strong>.</li><li>If no public IP is assigned, bind one from your available IP pool.</li><li>Record the IP (e.g., <code>8.134.207.88</code>) for testing later.</li></ul><h2 id="2-Configuring-Security-Group-Rules"><a class="header-anchor" href="#2-Configuring-Security-Group-Rules">¶</a>2. Configuring Security Group Rules</h2><p>Navigate to <strong>Security Groups</strong> → <strong>Manage Rules</strong> → <strong>Inbound</strong>. Add:</p><table><thead><tr><th>Protocol</th><th>Port</th><th>Source CIDR</th><th>Purpose</th></tr></thead><tbody><tr><td>TCP</td><td>22</td><td>0.0.0.0/0</td><td>SSH login</td></tr><tr><td>TCP</td><td>80</td><td>0.0.0.0/0</td><td>HTTP traffic</td></tr><tr><td>TCP</td><td>443</td><td>0.0.0.0/0</td><td>HTTPS traffic</td></tr><tr><td>TCP</td><td>3306</td><td>Your IP only</td><td>MySQL remote access (optional, risky if opened to all)</td></tr></tbody></table><p><strong>Security tip</strong>: Never expose MySQL (3306) to <code>0.0.0.0/0</code> in production. Use SSH tunneling instead:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -L 3306:localhost:3306 user@8.134.207.88</span><br></pre></td></tr></table></figure><h2 id="3-OS-level-Firewall-iptables-firewalld"><a class="header-anchor" href="#3-OS-level-Firewall-iptables-firewalld">¶</a>3. OS-level Firewall (iptables/firewalld)</h2><p>On <strong>CentOS/RHEL</strong> (firewalld):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --permanent --add-service=http</span><br><span class="line">sudo firewall-cmd --permanent --add-service=https</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>On <strong>Ubuntu/Debian</strong> (ufw):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo ufw allow 22/tcp</span><br><span class="line">sudo ufw allow 80/tcp</span><br><span class="line">sudo ufw allow 443/tcp</span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure><p><strong>Verification</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://YOUR_PUBLIC_IP</span><br></pre></td></tr></table></figure><p>If you see “Connection refused,” check security group. If you see “No route to host,” check OS firewall.</p><hr><h1>Part II: Installing LAMP Components (Ubuntu Example)</h1><h2 id="Prerequisites-Disable-conflicting-services"><a class="header-anchor" href="#Prerequisites-Disable-conflicting-services">¶</a>Prerequisites: Disable conflicting services</h2><p>Before installing, stop any existing web servers or databases:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Check for running services</span></span><br><span class="line">sudo systemctl status apache2 httpd nginx mysql mariadb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Stop if found</span></span><br><span class="line">sudo systemctl stop apache2 httpd nginx mysql mariadb</span><br><span class="line">sudo systemctl <span class="built_in">disable</span> apache2 httpd nginx mysql mariadb</span><br></pre></td></tr></table></figure><h2 id="1-Apache-Web-Server"><a class="header-anchor" href="#1-Apache-Web-Server">¶</a>1. Apache Web Server</h2><h3 id="Installation"><a class="header-anchor" href="#Installation">¶</a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install -y apache2</span><br></pre></td></tr></table></figure><h3 id="Start-and-enable"><a class="header-anchor" href="#Start-and-enable">¶</a>Start and enable</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start apache2</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> apache2</span><br></pre></td></tr></table></figure><h3 id="Verify"><a class="header-anchor" href="#Verify">¶</a>Verify</h3><p>Visit <code>http://YOUR_PUBLIC_IP/</code>. You should see the <strong>Apache2 Ubuntu Default Page</strong>.</p><p><strong>If you see “Unable to connect”</strong>:</p><ol><li>Check security group (port 80 open?)</li><li>Check firewall: <code>sudo ufw status</code></li><li>Check Apache is running: <code>sudo systemctl status apache2</code></li></ol><h3 id="Key-directories"><a class="header-anchor" href="#Key-directories">¶</a>Key directories</h3><ul><li><strong>Config</strong>: <code>/etc/apache2/apache2.conf</code></li><li><strong>Virtual hosts</strong>: <code>/etc/apache2/sites-available/</code></li><li><strong>Document root</strong>: <code>/var/www/html/</code> (default landing page)</li><li><strong>Logs</strong>: <code>/var/log/apache2/access.log</code>, <code>/var/log/apache2/error.log</code></li></ul><h2 id="2-MySQL-Database"><a class="header-anchor" href="#2-MySQL-Database">¶</a>2. MySQL Database</h2><h3 id="Installation-Ubuntu-uses-MySQL-CentOS-often-uses-MariaDB"><a class="header-anchor" href="#Installation-Ubuntu-uses-MySQL-CentOS-often-uses-MariaDB">¶</a>Installation (Ubuntu uses MySQL, CentOS often uses MariaDB)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y mysql-server</span><br></pre></td></tr></table></figure><h3 id="Run-security-wizard"><a class="header-anchor" href="#Run-security-wizard">¶</a>Run security wizard</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure><p>Follow the prompts:</p><ul><li>Set root password (strong, at least 12 chars)</li><li>Remove anonymous users: <strong>Yes</strong></li><li>Disallow root login remotely: <strong>Yes</strong> (use SSH tunnel instead)</li><li>Remove test database: <strong>Yes</strong></li></ul><h3 id="Verify-v2"><a class="header-anchor" href="#Verify-v2">¶</a>Verify</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status mysql</span><br><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><p>Inside MySQL:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> DATABASES;</span><br><span class="line"><span class="keyword">CREATE</span> DATABASE test_lamp;</span><br><span class="line">EXIT;</span><br></pre></td></tr></table></figure><h3 id="Common-pitfall-Authentication-plugin-mismatch"><a class="header-anchor" href="#Common-pitfall-Authentication-plugin-mismatch">¶</a>Common pitfall: Authentication plugin mismatch</h3><p>MySQL 8.0+ uses <code>caching_sha2_password</code> by default, but many PHP apps expect <code>mysql_native_password</code>. Fix:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">WITH</span> mysql_native_password <span class="keyword">BY</span> <span class="string">&#x27;yourpassword&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><h2 id="3-PHP-and-Extensions"><a class="header-anchor" href="#3-PHP-and-Extensions">¶</a>3. PHP and Extensions</h2><h3 id="Installation-v2"><a class="header-anchor" href="#Installation-v2">¶</a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y php libapache2-mod-php php-mysql</span><br></pre></td></tr></table></figure><h3 id="Verify-PHP-integration-with-Apache"><a class="header-anchor" href="#Verify-PHP-integration-with-Apache">¶</a>Verify PHP integration with Apache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> | sudo <span class="built_in">tee</span> /var/www/html/info.php</span><br></pre></td></tr></table></figure><p>Visit <code>http://YOUR_PUBLIC_IP/info.php</code>. You should see a PHP information page listing:</p><ul><li>PHP version (e.g., 7.4 or 8.1)</li><li>Loaded extensions (check for <code>mysqli</code>, <code>pdo_mysql</code>)</li></ul><p><strong>If you see the source code instead of the PHP info page</strong>:</p><ul><li>Apache is not processing <code>.php</code> files. Check: <code>sudo a2enmod php7.4</code> (replace with your version).</li><li>Restart Apache: <code>sudo systemctl restart apache2</code>.</li></ul><h3 id="Install-additional-extensions-commonly-needed"><a class="header-anchor" href="#Install-additional-extensions-commonly-needed">¶</a>Install additional extensions (commonly needed)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y php-curl php-gd php-mbstring php-xml php-zip</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><hr><h1>Part III: Deploying a Real Application (Discuz! Forum)</h1><p>Discuz! is a popular PHP forum software. Deploying it reveals the most common LAMP pitfalls: file permissions, MySQL user creation, and PHP extension requirements.</p><h2 id="1-Download-and-extract-Discuz"><a class="header-anchor" href="#1-Download-and-extract-Discuz">¶</a>1. Download and extract Discuz!</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/html</span><br><span class="line">sudo wget https://download.comsenz.com/DiscuzX/3.4/Discuz_X3.4_SC_UTF8.zip</span><br><span class="line">sudo apt install -y unzip</span><br><span class="line">sudo unzip Discuz_X3.4_SC_UTF8.zip</span><br><span class="line">sudo <span class="built_in">mv</span> upload/* .</span><br><span class="line">sudo <span class="built_in">rm</span> -rf upload Discuz_X3.4_SC_UTF8.zip</span><br></pre></td></tr></table></figure><h2 id="2-Set-directory-permissions"><a class="header-anchor" href="#2-Set-directory-permissions">¶</a>2. Set directory permissions</h2><p>Apache runs as user <code>www-data</code> (Ubuntu) or <code>apache</code> (CentOS). It must be able to read/write certain directories:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R www-data:www-data /var/www/html</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 755 /var/www/html</span><br></pre></td></tr></table></figure><p><strong>For Discuz-specific directories</strong> (the installer checks these):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> -R 777 /var/www/html/data</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 777 /var/www/html/config</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 777 /var/www/html/uc_server/data</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 777 /var/www/html/uc_client/data</span><br></pre></td></tr></table></figure><p><strong>Security note</strong>: <code>chmod 777</code> is convenient but risky. After installation, tighten to <code>755</code> or <code>750</code>.</p><h2 id="3-Create-MySQL-database-and-user"><a class="header-anchor" href="#3-Create-MySQL-database-and-user">¶</a>3. Create MySQL database and user</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><p>Inside MySQL:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DATABASE discuz <span class="type">CHARACTER</span> <span class="keyword">SET</span> utf8mb4 <span class="keyword">COLLATE</span> utf8mb4_general_ci;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> <span class="string">&#x27;discuz_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">&#x27;StrongPassword123!&#x27;</span>;</span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">ALL</span> PRIVILEGES <span class="keyword">ON</span> discuz.<span class="operator">*</span> <span class="keyword">TO</span> <span class="string">&#x27;discuz_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line">EXIT;</span><br></pre></td></tr></table></figure><h2 id="4-Run-the-web-installer"><a class="header-anchor" href="#4-Run-the-web-installer">¶</a>4. Run the web installer</h2><p>Visit <code>http://YOUR_PUBLIC_IP/install/</code>. The installer will:</p><ol><li><strong>Check environment</strong> (PHP version, extensions)</li><li><strong>Check permissions</strong> (can it write to <code>data/</code>, <code>config/</code>?)</li><li><strong>Ask for database credentials</strong></li></ol><p>Fill in:</p><ul><li>Database host: <code>localhost</code></li><li>Database name: <code>discuz</code></li><li>Database user: <code>discuz_user</code></li><li>Database password: <code>StrongPassword123!</code></li></ul><p>If the installer complains about missing extensions, install them:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y php-mysqli php-gd</span><br><span class="line">sudo systemctl restart apache2</span><br></pre></td></tr></table></figure><h2 id="5-Post-installation-cleanup"><a class="header-anchor" href="#5-Post-installation-cleanup">¶</a>5. Post-installation cleanup</h2><p>After installation succeeds, delete the installer:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> -rf /var/www/html/install</span><br></pre></td></tr></table></figure><hr><h1>Part IV: Troubleshooting Checklist</h1><h2 id="Problem-1-“Connection-refused”-when-accessing-site"><a class="header-anchor" href="#Problem-1-“Connection-refused”-when-accessing-site">¶</a>Problem 1: “Connection refused” when accessing site</h2><p><strong>Cause</strong>: Port blocked or service not running</p><p><strong>Debug steps</strong>:</p><ol><li>Check Apache is running: <code>sudo systemctl status apache2</code></li><li>Check listening ports: <code>sudo ss -tuln | grep 80</code></li><li>Check security group (port 80 open?)</li><li>Check OS firewall: <code>sudo ufw status</code> or <code>sudo firewall-cmd --list-all</code></li></ol><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start apache2</span><br><span class="line">sudo ufw allow 80/tcp</span><br></pre></td></tr></table></figure><h2 id="Problem-2-“403-Forbidden”-when-accessing-a-directory"><a class="header-anchor" href="#Problem-2-“403-Forbidden”-when-accessing-a-directory">¶</a>Problem 2: “403 Forbidden” when accessing a directory</h2><p><strong>Cause</strong>: Missing <code>index.php</code>/<code>index.html</code> or directory permissions</p><p><strong>Debug steps</strong>:</p><ol><li>Check if file exists: <code>ls -l /var/www/html/</code></li><li>Check Apache can read it: <code>sudo -u www-data cat /var/www/html/index.php</code></li><li>Check <code>DirectoryIndex</code> directive in Apache config</li></ol><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Fix ownership</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R www-data:www-data /var/www/html</span><br><span class="line"></span><br><span class="line"><span class="comment"># Or temporarily test with permissive permissions</span></span><br><span class="line">sudo <span class="built_in">chmod</span> -R 755 /var/www/html</span><br></pre></td></tr></table></figure><h2 id="Problem-3-PHP-shows-as-plain-text-source-code-visible"><a class="header-anchor" href="#Problem-3-PHP-shows-as-plain-text-source-code-visible">¶</a>Problem 3: PHP shows as plain text (source code visible)</h2><p><strong>Cause</strong>: Apache is not processing <code>.php</code> files</p><p><strong>Debug steps</strong>:</p><ol><li>Check if PHP module is loaded: <code>apache2ctl -M | grep php</code></li><li>Check <code>.htaccess</code> or virtual host config</li></ol><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Enable PHP module (Ubuntu/Debian)</span></span><br><span class="line">sudo a2enmod php7.4  <span class="comment"># Replace with your PHP version</span></span><br><span class="line">sudo systemctl restart apache2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify: curl http://localhost/info.php (should see PHP output, not source)</span></span><br></pre></td></tr></table></figure><h2 id="Problem-4-“Can’t-connect-to-MySQL-server-on-‘localhost’”"><a class="header-anchor" href="#Problem-4-“Can’t-connect-to-MySQL-server-on-‘localhost’”">¶</a>Problem 4: “Can’t connect to MySQL server on ‘localhost’”</h2><p><strong>Cause</strong>: MySQL service not running or connection credentials wrong</p><p><strong>Debug steps</strong>:</p><ol><li>Check MySQL is running: <code>sudo systemctl status mysql</code></li><li>Test connection: <code>mysql -u discuz_user -p -h localhost</code></li><li>Check <code>bind-address</code> in <code>/etc/mysql/mysql.conf.d/mysqld.cnf</code> (should be <code>127.0.0.1</code> for localhost)</li></ol><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start mysql</span><br><span class="line"><span class="comment"># If still failing, check MySQL error log:</span></span><br><span class="line">sudo <span class="built_in">tail</span> -f /var/log/mysql/error.log</span><br></pre></td></tr></table></figure><h2 id="Problem-5-Discuz-installer-says-“Directory-not-writable”"><a class="header-anchor" href="#Problem-5-Discuz-installer-says-“Directory-not-writable”">¶</a>Problem 5: Discuz installer says “Directory not writable”</h2><p><strong>Cause</strong>: Apache cannot write to required directories</p><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R www-data:www-data /var/www/html</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 777 /var/www/html/data /var/www/html/config /var/www/html/uc_server/data /var/www/html/uc_client/data</span><br></pre></td></tr></table></figure><p>After installation, tighten permissions:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> -R 755 /var/www/html/data</span><br></pre></td></tr></table></figure><hr><h1>Part V: Best Practices for Production LAMP</h1><h2 id="1-Never-run-as-root"><a class="header-anchor" href="#1-Never-run-as-root">¶</a>1. Never run as root</h2><p>Always run services as dedicated users:</p><ul><li>Apache: <code>www-data</code> (Ubuntu) or <code>apache</code> (CentOS)</li><li>MySQL: <code>mysql</code></li></ul><h2 id="2-Use-virtual-hosts-for-multiple-sites"><a class="header-anchor" href="#2-Use-virtual-hosts-for-multiple-sites">¶</a>2. Use virtual hosts for multiple sites</h2><p>Instead of dumping everything in <code>/var/www/html/</code>, create virtual hosts:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *<span class="number">:80</span>&gt;</span></span><br><span class="line">    <span class="attribute">ServerName</span> example.com</span><br><span class="line">    <span class="attribute">DocumentRoot</span> /var/www/example.com</span><br><span class="line">    <span class="section">&lt;Directory /var/www/example.com&gt;</span></span><br><span class="line">        <span class="attribute">AllowOverride</span> <span class="literal">All</span></span><br><span class="line">        <span class="attribute">Require</span> <span class="literal">all</span> granted</span><br><span class="line">    <span class="section">&lt;/Directory&gt;</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure><p>Save to <code>/etc/apache2/sites-available/example.com.conf</code>, then:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo a2ensite example.com</span><br><span class="line">sudo systemctl reload apache2</span><br></pre></td></tr></table></figure><h2 id="3-Enable-HTTPS"><a class="header-anchor" href="#3-Enable-HTTPS">¶</a>3. Enable HTTPS</h2><p>Use Let’s Encrypt for free certificates:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y certbot python3-certbot-apache</span><br><span class="line">sudo certbot --apache -d example.com -d www.example.com</span><br></pre></td></tr></table></figure><h2 id="4-Harden-MySQL"><a class="header-anchor" href="#4-Harden-MySQL">¶</a>4. Harden MySQL</h2><ul><li>Disable remote root login</li><li>Use strong passwords (12+ chars, mixed case, symbols)</li><li>Create per-app database users (never reuse <code>root</code>)</li></ul><h2 id="5-Monitor-logs"><a class="header-anchor" href="#5-Monitor-logs">¶</a>5. Monitor logs</h2><p>Set up log rotation and monitoring:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Apache logs</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/apache2/access.log</span><br><span class="line"><span class="built_in">tail</span> -f /var/log/apache2/error.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL logs</span></span><br><span class="line">sudo <span class="built_in">tail</span> -f /var/log/mysql/error.log</span><br></pre></td></tr></table></figure><h2 id="6-Automate-backups"><a class="header-anchor" href="#6-Automate-backups">¶</a>6. Automate backups</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Database backup script</span></span><br><span class="line">mysqldump -u root -p discuz &gt; /backups/discuz_$(<span class="built_in">date</span> +%F).sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># Schedule daily backups</span></span><br><span class="line">crontab -e</span><br><span class="line">0 2 * * * mysqldump -u root -pYourPassword discuz &gt; /backups/discuz_$(<span class="built_in">date</span> +\%F).sql</span><br></pre></td></tr></table></figure><hr><h1>Part VI: Source Compilation (Advanced)</h1><p>If you need a specific version not available in repos, or want maximum optimization, compile from source.</p><h2 id="Why-compile-from-source"><a class="header-anchor" href="#Why-compile-from-source">¶</a>Why compile from source?</h2><p><strong>Pros</strong>:</p><ul><li>Control over build flags (enable/disable features)</li><li>Latest version (repos lag behind)</li><li>Custom patches</li></ul><p><strong>Cons</strong>:</p><ul><li>Time-consuming (hours for MySQL)</li><li>Manual dependency resolution</li><li>No automatic security updates</li></ul><h2 id="Compiling-MySQL-5-6-from-source"><a class="header-anchor" href="#Compiling-MySQL-5-6-from-source">¶</a>Compiling MySQL 5.6 from source</h2><h3 id="Prerequisites"><a class="header-anchor" href="#Prerequisites">¶</a>Prerequisites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y gcc gcc-c++ cmake bison libaio-devel ncurses-devel zlib-devel openssl-devel</span><br></pre></td></tr></table></figure><h3 id="Download-and-extract"><a class="header-anchor" href="#Download-and-extract">¶</a>Download and extract</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line">sudo <span class="built_in">mkdir</span> software-mysql &amp;&amp; <span class="built_in">cd</span> software-mysql</span><br><span class="line">sudo wget https://repo.huaweicloud.com/mysql/Downloads/MySQL-5.6/mysql-5.6.49.tar.gz</span><br><span class="line">sudo tar -xzvf mysql-5.6.49.tar.gz</span><br><span class="line"><span class="built_in">cd</span> mysql-5.6.49</span><br></pre></td></tr></table></figure><h3 id="Configure"><a class="header-anchor" href="#Configure">¶</a>Configure</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmake . \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLE_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><h3 id="Compile-expect-1-3-hours"><a class="header-anchor" href="#Compile-expect-1-3-hours">¶</a>Compile (expect 1-3 hours)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><h3 id="Initialize"><a class="header-anchor" href="#Initialize">¶</a>Initialize</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -r -s /sbin/nologin mysql</span><br><span class="line">sudo <span class="built_in">chown</span> -R mysql:mysql /usr/local/mysql</span><br><span class="line"><span class="built_in">cd</span> /usr/local/mysql</span><br><span class="line">sudo ./scripts/mysql_install_db --user=mysql</span><br></pre></td></tr></table></figure><h3 id="Create-systemd-service"><a class="header-anchor" href="#Create-systemd-service">¶</a>Create systemd service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> support-files/mysql.server /etc/init.d/mysql</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> mysql</span><br><span class="line">sudo systemctl start mysql</span><br></pre></td></tr></table></figure><hr><h1>Part VII: Real-World Case Studies</h1><h2 id="Case-1-Migrating-from-shared-hosting"><a class="header-anchor" href="#Case-1-Migrating-from-shared-hosting">¶</a>Case 1: Migrating from shared hosting</h2><p><strong>Scenario</strong>: Moving a WordPress site from GoDaddy to Alibaba Cloud ECS.</p><p><strong>Steps</strong>:</p><ol><li>Export database: <code>mysqldump</code> from old host</li><li>Copy files via SFTP to <code>/var/www/html</code></li><li>Import database on new host</li><li>Update <code>wp-config.php</code> with new DB credentials</li><li>Update DNS A record to new public IP</li></ol><p><strong>Pitfall</strong>: File permissions. On shared hosting, everything is owned by your user. On ECS, Apache runs as <code>www-data</code>. Fix: <code>sudo chown -R www-data:www-data /var/www/html</code>.</p><h2 id="Case-2-Running-multiple-sites-virtual-hosts"><a class="header-anchor" href="#Case-2-Running-multiple-sites-virtual-hosts">¶</a>Case 2: Running multiple sites (virtual hosts)</h2><p><strong>Scenario</strong>: Host <code>blog.example.com</code> and <code>forum.example.com</code> on one instance.</p><p><strong>Solution</strong>: Create two virtual hosts:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/apache2/sites-available/blog.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName blog.example.com</span><br><span class="line">    DocumentRoot /var/www/blog</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/apache2/sites-available/forum.conf</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName forum.example.com</span><br><span class="line">    DocumentRoot /var/www/forum</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><p>Enable:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo a2ensite blog forum</span><br><span class="line">sudo systemctl reload apache2</span><br></pre></td></tr></table></figure><h2 id="Case-3-Handling-PHP-version-conflicts"><a class="header-anchor" href="#Case-3-Handling-PHP-version-conflicts">¶</a>Case 3: Handling PHP version conflicts</h2><p><strong>Scenario</strong>: Old app requires PHP 5.6, new app requires PHP 7.4.</p><p><strong>Solution</strong>: Use <code>php-fpm</code> with different versions:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install both versions</span></span><br><span class="line">sudo apt install -y php5.6-fpm php7.4-fpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure virtual host to use specific version</span></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    ServerName oldapp.example.com</span><br><span class="line">    &lt;FilesMatch \.php$&gt;</span><br><span class="line">        SetHandler <span class="string">&quot;proxy:unix:/run/php/php5.6-fpm.sock|fcgi://localhost&quot;</span></span><br><span class="line">    &lt;/FilesMatch&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><hr><h1>Summary: LAMP in 5 Steps</h1><ol><li><strong>Open ports</strong> (security group + OS firewall)</li><li><strong>Install services</strong> (Apache, MySQL, PHP)</li><li><strong>Verify each layer</strong> (Apache serves HTML → PHP runs → MySQL connects)</li><li><strong>Set permissions</strong> (Apache user can read/write)</li><li><strong>Deploy app</strong> (Discuz, WordPress, etc.)</li></ol><p><strong>Next steps</strong>:</p><ul><li>Enable HTTPS with Let’s Encrypt</li><li>Set up automated backups</li><li>Monitor with Zabbix or Prometheus</li><li>Explore Nginx as an Apache alternative</li></ul><p><strong>Further reading</strong>:</p><ul><li>Apache docs: <a class="link" href="https://httpd.apache.org/docs/">https://httpd.apache.org/docs/<i class="fas fa-external-link-alt"></i></a></li><li>MySQL reference: <a class="link" href="https://dev.mysql.com/doc/">https://dev.mysql.com/doc/<i class="fas fa-external-link-alt"></i></a></li><li>PHP manual: <a class="link" href="https://www.php.net/manual/en/">https://www.php.net/manual/en/<i class="fas fa-external-link-alt"></i></a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Turning a fresh Alibaba Cloud ECS instance from “I can SSH in” to “public visitors can access my site reliably” involves three common stumbling blocks: network access (security groups + firewall rules), service coordination (Apache–PHP–MySQL request pipeline), and permission/version mismatches (directory ownership, PHP extensions, MySQL authentication). This guide first clarifies the LAMP architecture with diagrams, then walks through security group configuration, environment installation with verification steps, Apache/MySQL/PHP installation with key configurations, and finally a complete Discuz deployment plus source-compile installation workflow (including cleanup, dependency preparation, service auto-start, and common troubleshooting scenarios). By the end, you’ll have a traditional Web stack running on the cloud from 0 to 1.&lt;/p&gt;</summary>
    
    
    
    <category term="Tutorial" scheme="https://chenk.top/categories/Tutorial/"/>
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud Computing" scheme="https://chenk.top/tags/Cloud-Computing/"/>
    
    <category term="Web Server" scheme="https://chenk.top/tags/Web-Server/"/>
    
  </entry>
  
  <entry>
    <title>Linux 文件权限</title>
    <link href="https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/"/>
    <id>https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/</id>
    <published>2025-02-13T16:00:00.000Z</published>
    <updated>2026-01-29T16:41:58.676Z</updated>
    
    <content type="html"><![CDATA[<p>文件权限是 Linux 运维里最&quot;基础但最容易踩坑&quot;的部分：一边是权限不足导致服务起不来、脚本跑不动、Web 应用 403 报错；另一边是权限给大了带来安全风险（任何人都能改配置、删日志、写 crontab）。要把它用对，你需要的不只是记住 <code>chmod 755</code>，而是理解<strong>权限位在文件与目录上的语义差异</strong>（r/w/x 对目录的含义与文件完全不同）、属主/属组/其他人的边界、以及 <code>umask</code>、SUID/SGID、Sticky Bit 这些机制为什么会存在、什么场景下才该用。本篇会从最小概念集出发，系统讲清 <code>rwx</code> 的语义、数字/符号写法、<code>chmod/chown</code> 的典型用法与排错思路，并用常见场景（共享目录、可执行脚本、临时目录、安全加固）解释&quot;该怎么给权限、给到什么程度&quot;，再补上 ACL、<code>chattr</code> 这些扩展机制与实战排障清单，让你能把权限问题一次性定位并修正确。</p><span id="more"></span><h1>Linux 权限模型：owner/group/others 三层架构</h1><h2 id="基本概念"><a class="header-anchor" href="#基本概念">¶</a>基本概念</h2><p>Linux 是多用户系统，每个文件/目录都有三个身份属性：</p><ul><li><strong>属主（Owner, u）</strong>：创建或被指定为文件/目录拥有者的用户（UID）</li><li><strong>属组（Group, g）</strong>：多个用户可以同属一个组，在组内具有共享权限（GID）</li><li><strong>其他用户（Others, o）</strong>：不属于该文件属主或属组的所有人</li></ul><p><strong>为什么要这么设计？</strong></p><ul><li><strong>属主</strong>：文件的&quot;所有者&quot;，通常有最高权限（如读写执行）</li><li><strong>属组</strong>：适用于团队协作（如开发组、运维组），组内成员共享权限</li><li><strong>其他用户</strong>：防止文件被任意用户访问（安全隔离）</li></ul><h2 id="三种权限位（rwx）"><a class="header-anchor" href="#三种权限位（rwx）">¶</a>三种权限位（rwx）</h2><p>每个身份（u/g/o）都有三个权限位：</p><ul><li><strong>r（read）</strong>：读权限</li><li><strong>w（write）</strong>：写权限</li><li><strong>x（execute）</strong>：执行权限</li></ul><p><strong>示例</strong>：<code>rwxr-xr-x</code></p><ul><li>属主：<code>rwx</code>（可读可写可执行）</li><li>属组：<code>r-x</code>（可读可执行，不可写）</li><li>其他：<code>r-x</code>（可读可执行，不可写）</li></ul><p><strong>转换为数字</strong>：</p><ul><li><code>rwx</code> = 4+2+1 = 7</li><li><code>r-x</code> = 4+0+1 = 5</li><li><code>r-x</code> = 4+0+1 = 5</li><li>所以 <code>rwxr-xr-x</code> = <code>755</code></li></ul><hr><h1>rwx 在文件和目录上的语义差异（最容易踩的坑）</h1><p><strong>这是最容易混淆的点</strong>：rwx 在文件和目录上的含义完全不同。</p><h2 id="对文件（普通文件）"><a class="header-anchor" href="#对文件（普通文件）">¶</a>对文件（普通文件）</h2><table><thead><tr><th>权限</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>r</code></td><td>可读取文件内容</td><td><code>cat file.txt</code></td></tr><tr><td><code>w</code></td><td>可修改文件内容</td><td><code>echo &quot;new&quot; &gt; file.txt</code></td></tr><tr><td><code>x</code></td><td>可执行文件（脚本需要有 shebang 如 <code>#!/bin/bash</code>）</td><td><code>./script.sh</code></td></tr></tbody></table><h2 id="对目录"><a class="header-anchor" href="#对目录">¶</a>对目录</h2><table><thead><tr><th>权限</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>r</code></td><td>可列出目录内容（看到文件名）</td><td><code>ls dir</code></td></tr><tr><td><code>w</code></td><td>可在目录内创建、删除、重命名文件（<strong>通常需要 <code>x</code></strong>）</td><td><code>touch dir/newfile</code></td></tr><tr><td><code>x</code></td><td>可进入目录（<code>cd</code>）、访问目录内的文件（如果知道文件名）</td><td><code>cd dir</code> 或 <code>cat dir/file.txt</code></td></tr></tbody></table><p><strong>实际例子</strong>：</p><h3 id="情况-1：目录有-r-但没有-x"><a class="header-anchor" href="#情况-1：目录有-r-但没有-x">¶</a>情况 1：目录有 <code>r</code> 但没有 <code>x</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 644 mydir  <span class="comment"># mydir 权限变成 rw-r--r--（没有 x）</span></span><br><span class="line"><span class="built_in">ls</span> mydir  <span class="comment"># ✅ 可以列出文件名</span></span><br><span class="line"><span class="built_in">cd</span> mydir  <span class="comment"># ❌ Permission denied（不能进入）</span></span><br><span class="line"><span class="built_in">cat</span> mydir/file.txt  <span class="comment"># ❌ Permission denied（不能访问文件）</span></span><br></pre></td></tr></table></figure><p><strong>原因</strong>：没有 <code>x</code> 就不能进入目录，也不能访问目录内的文件。</p><h3 id="情况-2：目录有-x-但没有-r"><a class="header-anchor" href="#情况-2：目录有-x-但没有-r">¶</a>情况 2：目录有 <code>x</code> 但没有 <code>r</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 311 mydir  <span class="comment"># mydir 权限变成 -wx--x--x（有 x 但没有 r）</span></span><br><span class="line"><span class="built_in">ls</span> mydir  <span class="comment"># ❌ Permission denied（不能列出文件名）</span></span><br><span class="line"><span class="built_in">cd</span> mydir  <span class="comment"># ✅ 可以进入</span></span><br><span class="line"><span class="built_in">cat</span> mydir/file.txt  <span class="comment"># ✅ 可以访问（如果知道文件名）</span></span><br></pre></td></tr></table></figure><p><strong>原因</strong>：有 <code>x</code> 就能进入和访问文件，但没有 <code>r</code> 就不能列出目录内容。</p><h3 id="情况-3：目录有-w-但没有-x"><a class="header-anchor" href="#情况-3：目录有-w-但没有-x">¶</a>情况 3：目录有 <code>w</code> 但没有 <code>x</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 622 mydir  <span class="comment"># mydir 权限变成 rw--w--w-（有 w 但没有 x）</span></span><br><span class="line"><span class="built_in">touch</span> mydir/newfile  <span class="comment"># ❌ Permission denied（不能创建文件）</span></span><br></pre></td></tr></table></figure><p><strong>原因</strong>：虽然有 <code>w</code>，但没有 <code>x</code> 就不能进入目录，也就不能在目录内操作。</p><p><strong>结论</strong>：对目录来说，<strong><code>x</code> 是最基本的权限</strong>（没有 <code>x</code> 就什么都干不了）；<code>w</code> 通常需要配合 <code>x</code> 使用。</p><hr><h1>chmod：修改权限（数字和符号两种写法）</h1><h2 id="数字写法（快速且常用）"><a class="header-anchor" href="#数字写法（快速且常用）">¶</a>数字写法（快速且常用）</h2><p>每个权限位对应一个数字：</p><ul><li><code>r = 4</code></li><li><code>w = 2</code></li><li><code>x = 1</code></li></ul><p>相加得到一个 3 位数（owner/group/others）：</p><ul><li><code>7 = rwx</code>（4+2+1）</li><li><code>6 = rw-</code>（4+2）</li><li><code>5 = r-x</code>（4+1）</li><li><code>4 = r--</code>（4）</li><li><code>0 = ---</code>（无权限）</li></ul><p><strong>常见示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 755 script.sh  <span class="comment"># owner=rwx, group=r-x, others=r-x（可执行脚本）</span></span><br><span class="line"><span class="built_in">chmod</span> 644 file.txt  <span class="comment"># owner=rw-, group=r--, others=r--（普通文件）</span></span><br><span class="line"><span class="built_in">chmod</span> 600 secret.key  <span class="comment"># owner=rw-, group=---, others=---（私钥文件）</span></span><br><span class="line"><span class="built_in">chmod</span> 777 shared  <span class="comment"># owner=rwx, group=rwx, others=rwx（完全开放，不推荐）</span></span><br></pre></td></tr></table></figure><h2 id="符号写法（更安全，适合增量修改）"><a class="header-anchor" href="#符号写法（更安全，适合增量修改）">¶</a>符号写法（更安全，适合增量修改）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+x script.sh  <span class="comment"># 给 owner 加上执行权限</span></span><br><span class="line"><span class="built_in">chmod</span> g-w file.txt  <span class="comment"># 去掉 group 的写权限</span></span><br><span class="line"><span class="built_in">chmod</span> o=r file.txt  <span class="comment"># 设置 others 只有读权限</span></span><br><span class="line"><span class="built_in">chmod</span> a+r notes.md  <span class="comment"># 给所有人加上读权限（a=all）</span></span><br><span class="line"><span class="built_in">chmod</span> u+rwx,g+rx,o-rwx <span class="built_in">dir</span>  <span class="comment"># 组合修改（逗号分隔）</span></span><br></pre></td></tr></table></figure><p><strong>递归修改</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 755 <span class="built_in">dir</span>  <span class="comment"># 递归修改目录及其内容</span></span><br><span class="line"><span class="built_in">chmod</span> -R u+rwX,g+rX,o-rwx <span class="built_in">dir</span>  <span class="comment"># 大写 X 只给目录和已有执行权限的文件加 x（避免所有文件都变成可执行）</span></span><br></pre></td></tr></table></figure><p><strong>什么时候用数字、什么时候用符号？</strong></p><ul><li><strong>数字</strong>：适合&quot;一次性设置到目标值&quot;（如 <code>chmod 644 file</code>）</li><li><strong>符号</strong>：适合&quot;增量修改&quot;（如 <code>chmod u+x script.sh</code>），更安全（不会误改其他权限位）</li></ul><hr><h1>chown：修改文件所有权</h1><p><code>chown</code> 用于修改文件的属主和属组。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> newowner file  <span class="comment"># 只改属主</span></span><br><span class="line">sudo <span class="built_in">chown</span> newowner:newgroup file  <span class="comment"># 同时改属主和属组</span></span><br><span class="line">sudo <span class="built_in">chown</span> :newgroup file  <span class="comment"># 只改属组</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R user:group <span class="built_in">dir</span>  <span class="comment"># 递归修改目录及其内容</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>只有 <code>root</code> 或文件的当前属主可以修改所有权</li><li>普通用户不能把文件&quot;送给&quot;别人（防止恶意占用别人的配额）</li></ul><p><strong>常见场景</strong>：</p><ul><li>Web 服务器目录：<code>sudo chown -R www-data:www-data /var/www/html</code></li><li>共享项目目录：<code>sudo chown -R :developers /srv/project</code></li></ul><hr><h1>umask：新建文件的默认权限</h1><h2 id="什么是-umask"><a class="header-anchor" href="#什么是-umask">¶</a>什么是 umask</h2><p><code>umask</code> 是 <strong>User File Creation Mask</strong>（用户文件创建掩码），决定新建文件/目录的默认权限。</p><p><strong>计算方法</strong>：</p><ol><li><strong>默认权限</strong>（系统预设）：<ul><li>文件：<code>666</code>（rw-rw-rw-，不包括执行权限，防止误执行）</li><li>目录：<code>777</code>（rwxrwxrwx，目录需要 x 才能进入）</li></ul></li><li><strong>实际权限</strong> = 默认权限 - umask 值</li></ol><p><strong>示例</strong>（umask = 022）：</p><ul><li>文件：<code>666 - 022 = 644</code>（rw-r–r–）</li><li>目录：<code>777 - 022 = 755</code>（rwxr-xr-x）</li></ul><h2 id="查看和设置-umask"><a class="header-anchor" href="#查看和设置-umask">¶</a>查看和设置 umask</h2><p><strong>查看当前 umask</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span>  <span class="comment"># 输出：0022（第一位是特殊权限位，通常忽略）</span></span><br></pre></td></tr></table></figure><p><strong>临时设置 umask</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027  <span class="comment"># 设置为 027</span></span><br><span class="line"><span class="comment"># 之后新建的文件权限是 640（666-027），目录权限是 750（777-027）</span></span><br></pre></td></tr></table></figure><p><strong>永久设置 umask</strong>（对当前用户）：<br>编辑 <code>~/.bashrc</code> 或 <code>~/.zshrc</code>，添加：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027</span><br></pre></td></tr></table></figure><p><strong>常见 umask 值</strong>：</p><table><thead><tr><th>umask</th><th>文件权限</th><th>目录权限</th><th>适用场景</th></tr></thead><tbody><tr><td>022</td><td>644</td><td>755</td><td>默认值（文件不被其他用户修改）</td></tr><tr><td>027</td><td>640</td><td>750</td><td>更严格（仅允许同组用户访问），<strong>生产环境推荐</strong></td></tr><tr><td>002</td><td>664</td><td>775</td><td>共享环境（允许同组用户修改），<strong>开发环境</strong></td></tr><tr><td>077</td><td>600</td><td>700</td><td>极度严格（只有属主能访问），适合个人私密文件</td></tr></tbody></table><hr><h1>特殊权限：SUID/SGID/Sticky Bit</h1><p>这三种特殊权限位用于特定的运维需求，理解它们的原理和使用场景很重要。</p><h2 id="SUID（Set-User-ID）"><a class="header-anchor" href="#SUID（Set-User-ID）">¶</a>SUID（Set User ID）</h2><h3 id="原理"><a class="header-anchor" href="#原理">¶</a>原理</h3><p>当可执行文件被赋予 SUID 权限后，<strong>普通用户执行该文件时，会以该文件的属主身份运行</strong>，而不是调用者自身的身份。</p><p><strong>常见示例</strong>：<code>/usr/bin/passwd</code></p><ul><li><code>ls -l /usr/bin/passwd</code> 显示：<code>-rwsr-xr-x</code> root root（注意 owner 的 x 变成了 s）</li><li>普通用户执行 <code>passwd</code> 时，以 root 身份运行，才能修改 <code>/etc/shadow</code>（只有 root 能写）</li></ul><p><strong>为什么需要 SUID？</strong></p><ul><li>允许普通用户执行特定的需要高权限的操作（如修改自己的密码）</li><li>不需要给用户 <code>sudo</code> 权限（更安全）</li></ul><h3 id="查看和设置"><a class="header-anchor" href="#查看和设置">¶</a>查看和设置</h3><p><strong>查看</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l file  <span class="comment"># 如果属主的 x 位显示为 s（小写）或 S（大写），说明有 SUID</span></span><br></pre></td></tr></table></figure><ul><li><code>s</code>（小写）：SUID 且有执行权限</li><li><code>S</code>（大写）：SUID 但没有执行权限（通常是配置错误）</li></ul><p><strong>设置 SUID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+s myprog  <span class="comment"># 符号写法</span></span><br><span class="line"><span class="built_in">chmod</span> 4755 myprog  <span class="comment"># 数字写法（4 表示 SUID，755 是基础权限）</span></span><br></pre></td></tr></table></figure><p><strong>去除 SUID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u-s myprog</span><br></pre></td></tr></table></figure><h3 id="实战示例"><a class="header-anchor" href="#实战示例">¶</a>实战示例</h3><p>假设你有一个 C 程序 <code>myprog.c</code>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Real UID=%d, Effective UID=%d\n&quot;</span>, getuid(), geteuid());</span><br><span class="line">    system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译并设置 SUID：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o myprog myprog.c</span><br><span class="line">sudo <span class="built_in">chown</span> root myprog  <span class="comment"># 属主改为 root</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 4755 myprog  <span class="comment"># 设置 SUID + 755</span></span><br></pre></td></tr></table></figure><p>普通用户执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./myprog</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Real UID=1000, Effective UID=0</span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) groups=1000(user)</span><br></pre></td></tr></table></figure><ul><li>Real UID 是当前用户（1000）</li><li>Effective UID 是文件属主（0=root）</li><li>所以程序以 root 权限运行</li></ul><h3 id="安全注意事项"><a class="header-anchor" href="#安全注意事项">¶</a>安全注意事项</h3><p><strong>SUID 是高风险的</strong>：</p><ul><li>SUID 程序一旦有漏洞（如缓冲区溢出、命令注入），攻击者可以获得 root 权限</li><li>避免对不可信的程序设置 SUID</li><li>定期审计系统中的 SUID 程序</li></ul><p><strong>查找系统中所有 SUID 程序</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 -<span class="built_in">type</span> f 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><strong>常见的 SUID 程序</strong>（这些是合理的）：</p><ul><li><code>/usr/bin/passwd</code>：修改密码</li><li><code>/usr/bin/sudo</code>：临时提权</li><li><code>/usr/bin/mount</code>：挂载文件系统</li><li><code>/usr/bin/ping</code>：发送 ICMP 包（需要 raw socket 权限）</li></ul><hr><h2 id="SGID（Set-Group-ID）"><a class="header-anchor" href="#SGID（Set-Group-ID）">¶</a>SGID（Set Group ID）</h2><h3 id="应用场景"><a class="header-anchor" href="#应用场景">¶</a>应用场景</h3><p>SGID 有两种用法：</p><h4 id="1-对可执行文件"><a class="header-anchor" href="#1-对可执行文件">¶</a>1. 对可执行文件</h4><p>进程运行时，其有效组 ID（GID）替换为文件的属组。这在需要访问特定组资源的工具中很常见。</p><h4 id="2-对目录（更常用）"><a class="header-anchor" href="#2-对目录（更常用）">¶</a>2. 对目录（更常用）</h4><p><strong>当目录设置 SGID 后，在此目录中新建的文件或子目录会继承该目录的组</strong>，而非创建者的默认组。这非常适合团队共享目录。</p><p><strong>示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /srv/project</span><br><span class="line">sudo <span class="built_in">chown</span> :developers /srv/project  <span class="comment"># 属组改为 developers</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 2775 /srv/project  <span class="comment"># 设置 SGID + 775（2 表示 SGID）</span></span><br></pre></td></tr></table></figure><p>现在，任何 developers 组的成员在 <code>/srv/project</code> 里创建的文件，属组都自动是 <code>developers</code>，组内其他成员也能访问。</p><h3 id="查看和设置-v2"><a class="header-anchor" href="#查看和设置-v2">¶</a>查看和设置</h3><p><strong>查看</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l file  <span class="comment"># 如果属组的 x 位显示为 s（小写）或 S（大写），说明有 SGID</span></span><br></pre></td></tr></table></figure><p><strong>设置 SGID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> g+s shared_dir  <span class="comment"># 符号写法</span></span><br><span class="line"><span class="built_in">chmod</span> 2775 shared_dir  <span class="comment"># 数字写法（2 表示 SGID）</span></span><br></pre></td></tr></table></figure><p><strong>去除 SGID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> g-s shared_dir</span><br></pre></td></tr></table></figure><hr><h2 id="Sticky-Bit（粘滞位）"><a class="header-anchor" href="#Sticky-Bit（粘滞位）">¶</a>Sticky Bit（粘滞位）</h2><h3 id="作用与原理"><a class="header-anchor" href="#作用与原理">¶</a>作用与原理</h3><p>Sticky Bit 最常见于多用户可写的公共目录，如 <code>/tmp</code>。<strong>当目录设置 Sticky Bit 后，该目录中的文件只能被其属主或 root 删除或改名</strong>，即使其他人对该目录也有写权限。</p><p><strong>为什么需要 Sticky Bit？</strong></p><ul><li><code>/tmp</code> 是所有用户共享的临时目录，权限是 <code>1777</code>（rwxrwxrwt）</li><li>如果没有 Sticky Bit，用户 A 可以删除用户 B 的临时文件（安全风险）</li><li>有了 Sticky Bit，用户 A 只能删除自己的文件，不能删除用户 B 的文件</li></ul><h3 id="查看和设置-v3"><a class="header-anchor" href="#查看和设置-v3">¶</a>查看和设置</h3><p><strong>查看</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld /tmp  <span class="comment"># 输出：drwxrwxrwt（最后一位是 t）</span></span><br></pre></td></tr></table></figure><p><strong>设置 Sticky Bit</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> o+t <span class="built_in">dirname</span>  <span class="comment"># 符号写法</span></span><br><span class="line"><span class="built_in">chmod</span> 1777 /tmp  <span class="comment"># 数字写法（1 表示 Sticky Bit）</span></span><br></pre></td></tr></table></figure><p><strong>去除 Sticky Bit</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> o-t <span class="built_in">dirname</span></span><br></pre></td></tr></table></figure><hr><h1>常见场景与最佳实践</h1><h2 id="场景-1：可执行脚本"><a class="header-anchor" href="#场景-1：可执行脚本">¶</a>场景 1：可执行脚本</h2><p><strong>问题</strong>：<code>./script.sh: Permission denied</code></p><p><strong>排查</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l script.sh  <span class="comment"># 查看权限</span></span><br></pre></td></tr></table></figure><p>如果显示 <code>-rw-r--r--</code>（没有 x），说明没有执行权限。</p><p><strong>解决</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x script.sh  <span class="comment"># 给所有人加上执行权限</span></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line"><span class="built_in">chmod</span> 755 script.sh  <span class="comment"># owner=rwx, group=r-x, others=r-x</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：脚本还需要有 shebang（如 <code>#!/bin/bash</code>），否则需要用 <code>bash script.sh</code> 运行。</p><h2 id="场景-2：Web-服务器目录"><a class="header-anchor" href="#场景-2：Web-服务器目录">¶</a>场景 2：Web 服务器目录</h2><p><strong>需求</strong>：Nginx/Apache 需要读取 <code>/var/www/html</code> 里的文件。</p><p><strong>排查</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld /var/www /var/www/html</span><br><span class="line"><span class="built_in">ls</span> -l /var/www/html/index.html</span><br></pre></td></tr></table></figure><p><strong>常见问题</strong>：</p><ul><li>目录权限不足（Nginx 用户没有 x 权限，不能进入）</li><li>文件权限不足（Nginx 用户没有 r 权限，不能读取）</li></ul><p><strong>解决</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R www-data:www-data /var/www/html  <span class="comment"># 属主改为 www-data</span></span><br><span class="line">sudo <span class="built_in">chmod</span> -R 755 /var/www/html  <span class="comment"># 目录和文件都设为 755</span></span><br><span class="line"><span class="comment"># 或者更严格</span></span><br><span class="line">sudo find /var/www/html -<span class="built_in">type</span> d -<span class="built_in">exec</span> <span class="built_in">chmod</span> 755 &#123;&#125; \;  <span class="comment"># 目录 755</span></span><br><span class="line">sudo find /var/www/html -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; \;  <span class="comment"># 文件 644</span></span><br></pre></td></tr></table></figure><h2 id="场景-3：共享目录（团队协作）"><a class="header-anchor" href="#场景-3：共享目录（团队协作）">¶</a>场景 3：共享目录（团队协作）</h2><p><strong>需求</strong>：<code>/srv/project</code> 目录，developers 组的成员都能读写，其他人不能访问。</p><p><strong>方案</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /srv/project</span><br><span class="line">sudo <span class="built_in">chown</span> :developers /srv/project  <span class="comment"># 属组改为 developers</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 2770 /srv/project  <span class="comment"># SGID + 770（只有 owner 和 group 能访问）</span></span><br></pre></td></tr></table></figure><ul><li><code>2</code>：SGID（新建文件自动继承 developers 组）</li><li><code>770</code>：owner 和 group 都是 rwx，others 无权限</li></ul><p><strong>验证</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户 A（developers 组成员）创建文件</span></span><br><span class="line"><span class="built_in">touch</span> /srv/project/fileA</span><br><span class="line"><span class="built_in">ls</span> -l /srv/project/fileA  <span class="comment"># 输出：-rw-r--r-- userA developers</span></span><br></pre></td></tr></table></figure><p>文件属组自动是 <code>developers</code>，组内其他成员也能访问。</p><h2 id="场景-4：临时目录（防止互删文件）"><a class="header-anchor" href="#场景-4：临时目录（防止互删文件）">¶</a>场景 4：临时目录（防止互删文件）</h2><p><strong>需求</strong>：<code>/tmp</code> 目录，所有用户都能创建文件，但不能删除别人的文件。</p><p><strong>方案</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 1777 /tmp  <span class="comment"># Sticky Bit + 777</span></span><br></pre></td></tr></table></figure><ul><li><code>1</code>：Sticky Bit（只有属主和 root 能删除文件）</li><li><code>777</code>：所有用户都能读写执行</li></ul><hr><h1>扩展机制：ACL 和 chattr</h1><h2 id="ACL（Access-Control-Lists）"><a class="header-anchor" href="#ACL（Access-Control-Lists）">¶</a>ACL（Access Control Lists）</h2><p><strong>为什么需要 ACL？</strong></p><ul><li>传统权限只能设置 owner/group/others 三层，不够灵活</li><li>ACL 可以为特定用户或特定组设置权限（如&quot;用户 A 有读权限，用户 B 有写权限&quot;）</li></ul><p><strong>查看 ACL</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getfacl file.txt</span><br></pre></td></tr></table></figure><p><strong>设置 ACL</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setfacl -m u:alice:rw file.txt  <span class="comment"># 给用户 alice 读写权限</span></span><br><span class="line">setfacl -m g:dev:rx <span class="built_in">dir</span>  <span class="comment"># 给组 dev 读执行权限</span></span><br><span class="line">setfacl -x u:alice file.txt  <span class="comment"># 移除用户 alice 的 ACL</span></span><br><span class="line">setfacl -b file.txt  <span class="comment"># 移除所有 ACL</span></span><br></pre></td></tr></table></figure><p><strong>递归设置</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setfacl -R -m u:alice:rwx <span class="built_in">dir</span>  <span class="comment"># 递归设置</span></span><br></pre></td></tr></table></figure><h2 id="chattr：文件属性（防止误删-误改）"><a class="header-anchor" href="#chattr：文件属性（防止误删-误改）">¶</a>chattr：文件属性（防止误删/误改）</h2><p><code>chattr</code> 可以设置文件的特殊属性（ext4 文件系统支持）。</p><p><strong>常用属性</strong>：</p><ul><li><code>i</code>（immutable）：文件不可修改、删除、重命名（连 root 也不行，除非先去掉 i 属性）</li><li><code>a</code>（append-only）：文件只能追加写入，不能修改已有内容（适合日志文件）</li></ul><p><strong>设置不可修改</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +i important.conf  <span class="comment"># 文件变成不可修改</span></span><br><span class="line"><span class="built_in">rm</span> important.conf  <span class="comment"># ❌ Operation not permitted（连 root 也删不掉）</span></span><br><span class="line">sudo chattr -i important.conf  <span class="comment"># 去掉 i 属性后才能删</span></span><br></pre></td></tr></table></figure><p><strong>设置只能追加</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +a logfile.txt  <span class="comment"># 只能追加</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;new line&quot;</span> &gt;&gt; logfile.txt  <span class="comment"># ✅ 可以追加</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;overwrite&quot;</span> &gt; logfile.txt  <span class="comment"># ❌ Operation not permitted（不能覆盖）</span></span><br></pre></td></tr></table></figure><p><strong>查看属性</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsattr file.txt</span><br></pre></td></tr></table></figure><p><strong>使用场景</strong>：</p><ul><li>保护重要配置文件（<code>/etc/fstab</code>、<code>/etc/passwd</code>）</li><li>防止日志文件被清空</li></ul><p><strong>chattr 的其他属性</strong>：</p><ul><li><code>d</code>（no dump）：备份时忽略该文件</li><li><code>s</code>（secure deletion）：删除时用 0 填充数据（安全删除）</li><li><code>u</code>（undeletable）：删除后内容可恢复</li></ul><p><strong>示例</strong>：保护 <code>/etc/fstab</code> 不被误删</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +i /etc/fstab</span><br><span class="line"><span class="built_in">rm</span> /etc/fstab  <span class="comment"># ❌ Operation not permitted</span></span><br><span class="line">sudo chattr -i /etc/fstab  <span class="comment"># 需要先解除保护</span></span><br></pre></td></tr></table></figure><hr><h1>权限排障清单：出问题了怎么办</h1><h2 id="问题-1：Permission-denied"><a class="header-anchor" href="#问题-1：Permission-denied">¶</a>问题 1：<code>Permission denied</code></h2><p><strong>排查步骤</strong>：</p><ol><li>确认执行用户：<code>whoami</code>（或查看服务的运行用户，如 systemd unit 文件）</li><li>查看文件权限：<code>ls -l file</code></li><li>查看所有父目录权限：<code>namei -l /full/path/to/file</code>（需要安装 <code>util-linux</code> 包）</li><li>检查组成员：<code>id</code>（看当前用户属于哪些组）</li><li>检查特殊属性：<code>lsattr file</code>（是否有 <code>i</code> 或 <code>a</code> 属性）</li></ol><p><strong>常见原因</strong>：</p><ul><li>文件没有读/写/执行权限</li><li>父目录没有 x 权限（不能进入）</li><li>用户不在文件的属组里</li></ul><p><strong>解决</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 644 file  <span class="comment"># 给读权限</span></span><br><span class="line">sudo <span class="built_in">chmod</span> +x script.sh  <span class="comment"># 给执行权限</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 755 /path/to/parent/dir  <span class="comment"># 给父目录 x 权限</span></span><br><span class="line">sudo <span class="built_in">chown</span> user:group file  <span class="comment"># 修改所有权</span></span><br></pre></td></tr></table></figure><h2 id="问题-2：Web-服务器-403-Forbidden"><a class="header-anchor" href="#问题-2：Web-服务器-403-Forbidden">¶</a>问题 2：Web 服务器 403 Forbidden</h2><p><strong>原因</strong>：Nginx/Apache 用户（如 <code>www-data</code>、<code>nginx</code>）没有权限读取文件。</p><p><strong>排查</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep nginx  <span class="comment"># 查看 nginx 运行用户</span></span><br><span class="line"><span class="built_in">ls</span> -l /var/www/html/index.html  <span class="comment"># 查看文件权限</span></span><br><span class="line">namei -l /var/www/html/index.html  <span class="comment"># 查看所有父目录权限</span></span><br></pre></td></tr></table></figure><p><strong>解决</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R www-data:www-data /var/www/html</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 755 /var/www/html  <span class="comment"># 目录 755</span></span><br><span class="line">sudo find /var/www/html -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; \;  <span class="comment"># 文件 644</span></span><br></pre></td></tr></table></figure><h2 id="问题-3：脚本执行失败"><a class="header-anchor" href="#问题-3：脚本执行失败">¶</a>问题 3：脚本执行失败</h2><p><strong>原因</strong>：脚本没有执行权限或 shebang 错误。</p><p><strong>排查</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l script.sh  <span class="comment"># 查看权限</span></span><br><span class="line"><span class="built_in">head</span> -1 script.sh  <span class="comment"># 查看 shebang</span></span><br></pre></td></tr></table></figure><p><strong>解决</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x script.sh  <span class="comment"># 加执行权限</span></span><br><span class="line"><span class="comment"># 确保 shebang 正确（如 #!/bin/bash）</span></span><br></pre></td></tr></table></figure><h2 id="问题-4：rm-cannot-remove-file-Operation-not-permitted"><a class="header-anchor" href="#问题-4：rm-cannot-remove-file-Operation-not-permitted">¶</a>问题 4：<code>rm: cannot remove 'file': Operation not permitted</code></h2><p><strong>原因</strong>：文件可能有 <code>i</code> 属性（不可修改/删除）。</p><p><strong>排查</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsattr file</span><br></pre></td></tr></table></figure><p>如果输出包含 <code>i</code>（如 <code>----i--------</code>），说明文件有 immutable 属性。</p><p><strong>解决</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr -i file  <span class="comment"># 去掉 i 属性</span></span><br><span class="line"><span class="built_in">rm</span> file  <span class="comment"># 现在可以删除了</span></span><br></pre></td></tr></table></figure><hr><h1>总结与扩展阅读</h1><p>这篇文章涵盖了 Linux 文件权限的核心内容：</p><ol><li>✅ Linux 权限模型（owner/group/others、rwx 语义）</li><li>✅ rwx 在文件和目录上的差异（最容易踩的坑）</li><li>✅ chmod 和 chown 的使用（数字/符号写法）</li><li>✅ umask 的原理和常见值（新建文件的默认权限）</li><li>✅ 特殊权限（SUID/SGID/Sticky Bit 的原理和使用场景）</li><li>✅ 扩展机制（ACL、chattr）</li><li>✅ 权限排障清单（Permission denied、403、脚本执行失败等）</li></ol><p><strong>扩展阅读</strong>：</p><ul><li><code>man chmod</code>：查看 chmod 的详细手册</li><li><code>man chown</code>：查看 chown 的详细手册</li><li><code>man 5 acl</code>：查看 ACL 的详细说明</li><li>SELinux / AppArmor：更高级的安全模型（强制访问控制 MAC）</li></ul><p><strong>下一步</strong>：</p><ul><li><strong>《Linux 用户管理》</strong>：学习如何管理用户/组、<code>/etc/passwd</code>、<code>/etc/shadow</code>、sudo 配置</li><li><strong>《Linux 文件操作深入解析》</strong>：学习管道、重定向、stdin/stdout/stderr、<code>xargs</code>、<code>tee</code></li></ul><hr><p><strong>到这里，你应该已经从&quot;会用 chmod 755&quot;升级到&quot;理解权限语义、能设计共享目录权限方案、能排查权限问题&quot;。文件权限是 Linux 安全的基石，掌握了它，你就能更好地保护系统和数据。</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;文件权限是 Linux 运维里最&amp;quot;基础但最容易踩坑&amp;quot;的部分：一边是权限不足导致服务起不来、脚本跑不动、Web 应用 403 报错；另一边是权限给大了带来安全风险（任何人都能改配置、删日志、写 crontab）。要把它用对，你需要的不只是记住 &lt;code&gt;chmod 755&lt;/code&gt;，而是理解&lt;strong&gt;权限位在文件与目录上的语义差异&lt;/strong&gt;（r/w/x 对目录的含义与文件完全不同）、属主/属组/其他人的边界、以及 &lt;code&gt;umask&lt;/code&gt;、SUID/SGID、Sticky Bit 这些机制为什么会存在、什么场景下才该用。本篇会从最小概念集出发，系统讲清 &lt;code&gt;rwx&lt;/code&gt; 的语义、数字/符号写法、&lt;code&gt;chmod/chown&lt;/code&gt; 的典型用法与排错思路，并用常见场景（共享目录、可执行脚本、临时目录、安全加固）解释&amp;quot;该怎么给权限、给到什么程度&amp;quot;，再补上 ACL、&lt;code&gt;chattr&lt;/code&gt; 这些扩展机制与实战排障清单，让你能把权限问题一次性定位并修正确。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux File Permissions: rwx, chmod/chown, umask, SUID/SGID/Sticky, and Troubleshooting</title>
    <link href="https://chenk.top/en/linux-file-permissions/"/>
    <id>https://chenk.top/en/linux-file-permissions/</id>
    <published>2025-02-13T16:00:00.000Z</published>
    <updated>2026-01-29T16:31:44.795Z</updated>
    
    <content type="html"><![CDATA[<p>File permissions are “basic” in Linux, but they are also one of the most common causes of production incidents: a service won’t start, a deploy script can’t execute, a web app returns 403, or a shared directory becomes a security hole because permissions were made too broad. To use permissions correctly, you need more than memorizing <code>chmod 755</code>—you need to understand how <strong>permission bits have completely different semantics on files vs directories</strong> (r/w/x mean different things for directories), the boundaries between owner/group/others, and why mechanisms like <code>umask</code>, SUID/SGID, and the sticky bit exist and when they should be used. This post starts from the minimal concept set, systematically explains rwx semantics, numeric/symbolic notation, typical usage and troubleshooting approaches for chmod/chown, uses common scenarios (shared directories, executable scripts, temp directories, security hardening) to explain “how to grant permissions and to what extent,” then adds extended mechanisms like ACL and <code>chattr</code> plus a practical troubleshooting checklist, enabling you to locate and correctly fix permission issues in one shot.</p><span id="more"></span><h1>Linux Permission Model: The Three-Tier Architecture of owner/group/others</h1><h2 id="Basic-Concepts"><a class="header-anchor" href="#Basic-Concepts">¶</a>Basic Concepts</h2><p>Linux is a multi-user system; every file/directory has three identity attributes:</p><ul><li><strong>Owner (u)</strong>: The user (UID) who created or was designated as the file/directory owner</li><li><strong>Group (g)</strong>: Multiple users can belong to one group, sharing permissions within the group (GID)</li><li><strong>Others (o)</strong>: Everyone who is neither the file owner nor in the file’s group</li></ul><p><strong>Why this design?</strong></p><ul><li><strong>Owner</strong>: The file’s “owner,” usually has highest permissions (like read/write/execute)</li><li><strong>Group</strong>: Suitable for team collaboration (like dev team, ops team), members share permissions</li><li><strong>Others</strong>: Prevents files from being accessed by arbitrary users (security isolation)</li></ul><h2 id="Three-Permission-Bits-rwx"><a class="header-anchor" href="#Three-Permission-Bits-rwx">¶</a>Three Permission Bits (rwx)</h2><p>Each identity (u/g/o) has three permission bits:</p><ul><li><strong>r (read)</strong>: Read permission</li><li><strong>w (write)</strong>: Write permission</li><li><strong>x (execute)</strong>: Execute permission</li></ul><p><strong>Example</strong>: <code>rwxr-xr-x</code></p><ul><li>Owner: <code>rwx</code> (can read, write, execute)</li><li>Group: <code>r-x</code> (can read, execute, cannot write)</li><li>Others: <code>r-x</code> (can read, execute, cannot write)</li></ul><p><strong>Convert to numeric</strong>:</p><ul><li><code>rwx</code> = 4+2+1 = 7</li><li><code>r-x</code> = 4+0+1 = 5</li><li><code>r-x</code> = 4+0+1 = 5</li><li>So <code>rwxr-xr-x</code> = <code>755</code></li></ul><hr><h1>rwx Semantic Differences on Files vs Directories (The Most Common Pitfall)</h1><p><strong>This is the most confusing point</strong>: rwx mean completely different things on files vs directories.</p><h2 id="On-Files-Regular-Files"><a class="header-anchor" href="#On-Files-Regular-Files">¶</a>On Files (Regular Files)</h2><table><thead><tr><th>Permission</th><th>Meaning</th><th>Example</th></tr></thead><tbody><tr><td><code>r</code></td><td>Can read file contents</td><td><code>cat file.txt</code></td></tr><tr><td><code>w</code></td><td>Can modify file contents</td><td><code>echo &quot;new&quot; &gt; file.txt</code></td></tr><tr><td><code>x</code></td><td>Can execute file (scripts need shebang like <code>#!/bin/bash</code>)</td><td><code>./script.sh</code></td></tr></tbody></table><h2 id="On-Directories"><a class="header-anchor" href="#On-Directories">¶</a>On Directories</h2><table><thead><tr><th>Permission</th><th>Meaning</th><th>Example</th></tr></thead><tbody><tr><td><code>r</code></td><td>Can list directory contents (see filenames)</td><td><code>ls dir</code></td></tr><tr><td><code>w</code></td><td>Can create, delete, rename files within directory (<strong>usually requires <code>x</code></strong>)</td><td><code>touch dir/newfile</code></td></tr><tr><td><code>x</code></td><td>Can enter directory (<code>cd</code>), access files within if you know the name</td><td><code>cd dir</code> or <code>cat dir/file.txt</code></td></tr></tbody></table><p><strong>Real-world examples</strong>:</p><h3 id="Case-1-Directory-has-r-but-not-x"><a class="header-anchor" href="#Case-1-Directory-has-r-but-not-x">¶</a>Case 1: Directory has <code>r</code> but not <code>x</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 644 mydir  <span class="comment"># mydir permissions become rw-r--r-- (no x)</span></span><br><span class="line"><span class="built_in">ls</span> mydir  <span class="comment"># ✅ Can list filenames</span></span><br><span class="line"><span class="built_in">cd</span> mydir  <span class="comment"># ❌ Permission denied (can&#x27;t enter)</span></span><br><span class="line"><span class="built_in">cat</span> mydir/file.txt  <span class="comment"># ❌ Permission denied (can&#x27;t access file)</span></span><br></pre></td></tr></table></figure><p><strong>Reason</strong>: Without <code>x</code>, can’t enter directory or access files within.</p><h3 id="Case-2-Directory-has-x-but-not-r"><a class="header-anchor" href="#Case-2-Directory-has-x-but-not-r">¶</a>Case 2: Directory has <code>x</code> but not <code>r</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 311 mydir  <span class="comment"># mydir permissions become -wx--x--x (has x but not r)</span></span><br><span class="line"><span class="built_in">ls</span> mydir  <span class="comment"># ❌ Permission denied (can&#x27;t list filenames)</span></span><br><span class="line"><span class="built_in">cd</span> mydir  <span class="comment"># ✅ Can enter</span></span><br><span class="line"><span class="built_in">cat</span> mydir/file.txt  <span class="comment"># ✅ Can access (if you know the filename)</span></span><br></pre></td></tr></table></figure><p><strong>Reason</strong>: With <code>x</code> you can enter and access files, but without <code>r</code> you can’t list directory contents.</p><h3 id="Case-3-Directory-has-w-but-not-x"><a class="header-anchor" href="#Case-3-Directory-has-w-but-not-x">¶</a>Case 3: Directory has <code>w</code> but not <code>x</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 622 mydir  <span class="comment"># mydir permissions become rw--w--w- (has w but not x)</span></span><br><span class="line"><span class="built_in">touch</span> mydir/newfile  <span class="comment"># ❌ Permission denied (can&#x27;t create file)</span></span><br></pre></td></tr></table></figure><p><strong>Reason</strong>: Although it has <code>w</code>, without <code>x</code> you can’t enter directory, so can’t operate within.</p><p><strong>Conclusion</strong>: For directories, <strong><code>x</code> is the most fundamental permission</strong> (without <code>x</code> you can’t do anything); <code>w</code> usually needs to be used with <code>x</code>.</p><hr><h1>chmod: Modifying Permissions (Numeric and Symbolic Notation)</h1><h2 id="Numeric-Notation-Fast-and-Common"><a class="header-anchor" href="#Numeric-Notation-Fast-and-Common">¶</a>Numeric Notation (Fast and Common)</h2><p>Each permission bit corresponds to a number:</p><ul><li><code>r = 4</code></li><li><code>w = 2</code></li><li><code>x = 1</code></li></ul><p>Sum to get a 3-digit number (owner/group/others):</p><ul><li><code>7 = rwx</code> (4+2+1)</li><li><code>6 = rw-</code> (4+2)</li><li><code>5 = r-x</code> (4+1)</li><li><code>4 = r--</code> (4)</li><li><code>0 = ---</code> (no permissions)</li></ul><p><strong>Common examples</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 755 script.sh  <span class="comment"># owner=rwx, group=r-x, others=r-x (executable script)</span></span><br><span class="line"><span class="built_in">chmod</span> 644 file.txt  <span class="comment"># owner=rw-, group=r--, others=r-- (regular file)</span></span><br><span class="line"><span class="built_in">chmod</span> 600 secret.key  <span class="comment"># owner=rw-, group=---, others=--- (private key file)</span></span><br><span class="line"><span class="built_in">chmod</span> 777 shared  <span class="comment"># owner=rwx, group=rwx, others=rwx (fully open, not recommended)</span></span><br></pre></td></tr></table></figure><h2 id="Symbolic-Notation-Safer-Suitable-for-Incremental-Changes"><a class="header-anchor" href="#Symbolic-Notation-Safer-Suitable-for-Incremental-Changes">¶</a>Symbolic Notation (Safer, Suitable for Incremental Changes)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+x script.sh  <span class="comment"># Add execute permission for owner</span></span><br><span class="line"><span class="built_in">chmod</span> g-w file.txt  <span class="comment"># Remove write permission for group</span></span><br><span class="line"><span class="built_in">chmod</span> o=r file.txt  <span class="comment"># Set others to only read permission</span></span><br><span class="line"><span class="built_in">chmod</span> a+r notes.md  <span class="comment"># Add read permission for all (a=all)</span></span><br><span class="line"><span class="built_in">chmod</span> u+rwx,g+rx,o-rwx <span class="built_in">dir</span>  <span class="comment"># Combined modification (comma-separated)</span></span><br></pre></td></tr></table></figure><p><strong>Recursive modification</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 755 <span class="built_in">dir</span>  <span class="comment"># Recursively modify directory and its contents</span></span><br><span class="line"><span class="built_in">chmod</span> -R u+rwX,g+rX,o-rwx <span class="built_in">dir</span>  <span class="comment"># Capital X only adds x to directories and files that already have execute (avoids making all files executable)</span></span><br></pre></td></tr></table></figure><p><strong>When to use numeric vs symbolic?</strong></p><ul><li><strong>Numeric</strong>: Suitable for “one-shot set to target value” (like <code>chmod 644 file</code>)</li><li><strong>Symbolic</strong>: Suitable for “incremental modification” (like <code>chmod u+x script.sh</code>), safer (won’t accidentally change other permission bits)</li></ul><hr><h1>chown: Modifying File Ownership</h1><p><code>chown</code> is used to modify file owner and group.</p><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> newowner file  <span class="comment"># Only change owner</span></span><br><span class="line">sudo <span class="built_in">chown</span> newowner:newgroup file  <span class="comment"># Change both owner and group</span></span><br><span class="line">sudo <span class="built_in">chown</span> :newgroup file  <span class="comment"># Only change group</span></span><br><span class="line">sudo <span class="built_in">chown</span> -R user:group <span class="built_in">dir</span>  <span class="comment"># Recursively modify directory and its contents</span></span><br></pre></td></tr></table></figure><p><strong>Notes</strong>:</p><ul><li>Only <code>root</code> or the file’s current owner can modify ownership</li><li>Regular users can’t “give” files to others (prevents malicious quota abuse)</li></ul><p><strong>Common scenarios</strong>:</p><ul><li>Web server directory: <code>sudo chown -R www-data:www-data /var/www/html</code></li><li>Shared project directory: <code>sudo chown -R :developers /srv/project</code></li></ul><hr><h1>umask: Default Permissions for New Files</h1><h2 id="What-is-umask"><a class="header-anchor" href="#What-is-umask">¶</a>What is umask</h2><p><code>umask</code> is the <strong>User File Creation Mask</strong>, determining default permissions for newly created files/directories.</p><p><strong>Calculation method</strong>:</p><ol><li><strong>Default permissions</strong> (system preset):<ul><li>Files: <code>666</code> (rw-rw-rw-, no execute permission, prevents accidental execution)</li><li>Directories: <code>777</code> (rwxrwxrwx, directories need x to be enterable)</li></ul></li><li><strong>Actual permissions</strong> = Default permissions - umask value</li></ol><p><strong>Example</strong> (umask = 022):</p><ul><li>File: <code>666 - 022 = 644</code> (rw-r–r–)</li><li>Directory: <code>777 - 022 = 755</code> (rwxr-xr-x)</li></ul><h2 id="View-and-Set-umask"><a class="header-anchor" href="#View-and-Set-umask">¶</a>View and Set umask</h2><p><strong>View current umask</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span>  <span class="comment"># Output: 0022 (first digit is special permission bit, usually ignored)</span></span><br></pre></td></tr></table></figure><p><strong>Temporarily set umask</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027  <span class="comment"># Set to 027</span></span><br><span class="line"><span class="comment"># New files will have 640 (666-027), directories 750 (777-027)</span></span><br></pre></td></tr></table></figure><p><strong>Permanently set umask</strong> (for current user):<br>Edit <code>~/.bashrc</code> or <code>~/.zshrc</code>, add:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027</span><br></pre></td></tr></table></figure><p><strong>Common umask values</strong>:</p><table><thead><tr><th>umask</th><th>File Perms</th><th>Dir Perms</th><th>Use Case</th></tr></thead><tbody><tr><td>022</td><td>644</td><td>755</td><td>Default (files not modifiable by others)</td></tr><tr><td>027</td><td>640</td><td>750</td><td>Stricter (only group can access), <strong>recommended for production</strong></td></tr><tr><td>002</td><td>664</td><td>775</td><td>Shared environment (group can modify), <strong>development</strong></td></tr><tr><td>077</td><td>600</td><td>700</td><td>Extremely strict (only owner can access), personal private files</td></tr></tbody></table><hr><h1>Special Permissions: SUID/SGID/Sticky Bit</h1><p>These three special permission bits are for specific operational needs; understanding their principles and use cases is important.</p><h2 id="SUID-Set-User-ID"><a class="header-anchor" href="#SUID-Set-User-ID">¶</a>SUID (Set User ID)</h2><h3 id="Principle"><a class="header-anchor" href="#Principle">¶</a>Principle</h3><p>When an executable file is given SUID permission, <strong>ordinary users executing the file run it with the file owner’s identity</strong>, not the caller’s own identity.</p><p><strong>Common example</strong>: <code>/usr/bin/passwd</code></p><ul><li><code>ls -l /usr/bin/passwd</code> shows: <code>-rwsr-xr-x</code> root root (note owner’s x became s)</li><li>When ordinary users execute <code>passwd</code>, it runs as root, allowing modification of <code>/etc/shadow</code> (only root can write)</li></ul><p><strong>Why is SUID needed?</strong></p><ul><li>Allows ordinary users to execute specific operations requiring high permissions (like changing own password)</li><li>Doesn’t need to give users <code>sudo</code> privileges (more secure)</li></ul><h3 id="View-and-Set"><a class="header-anchor" href="#View-and-Set">¶</a>View and Set</h3><p><strong>View</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l file  <span class="comment"># If owner&#x27;s x position shows s (lowercase) or S (uppercase), SUID is set</span></span><br></pre></td></tr></table></figure><ul><li><code>s</code> (lowercase): SUID and has execute permission</li><li><code>S</code> (uppercase): SUID but no execute permission (usually a configuration error)</li></ul><p><strong>Set SUID</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+s myprog  <span class="comment"># Symbolic notation</span></span><br><span class="line"><span class="built_in">chmod</span> 4755 myprog  <span class="comment"># Numeric notation (4 means SUID, 755 is base permissions)</span></span><br></pre></td></tr></table></figure><p><strong>Remove SUID</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u-s myprog</span><br></pre></td></tr></table></figure><h3 id="Hands-On-Example"><a class="header-anchor" href="#Hands-On-Example">¶</a>Hands-On Example</h3><p>Suppose you have a C program <code>myprog.c</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Real UID=%d, Effective UID=%d\n&quot;</span>, getuid(), geteuid());</span><br><span class="line">    system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Compile and set SUID:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o myprog myprog.c</span><br><span class="line">sudo <span class="built_in">chown</span> root myprog  <span class="comment"># Change owner to root</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 4755 myprog  <span class="comment"># Set SUID + 755</span></span><br></pre></td></tr></table></figure><p>Execute as ordinary user:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./myprog</span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Real UID=1000, Effective UID=0</span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) groups=1000(user)</span><br></pre></td></tr></table></figure><ul><li>Real UID is current user (1000)</li><li>Effective UID is file owner (0=root)</li><li>So program runs with root privileges</li></ul><h3 id="Security-Considerations"><a class="header-anchor" href="#Security-Considerations">¶</a>Security Considerations</h3><p><strong>SUID is high-risk</strong>:</p><ul><li>If SUID program has vulnerabilities (like buffer overflow, command injection), attackers can gain root privileges</li><li>Avoid setting SUID on untrusted programs</li><li>Regularly audit SUID programs on system</li></ul><p><strong>Find all SUID programs on system</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 -<span class="built_in">type</span> f 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><strong>Common SUID programs</strong> (these are reasonable):</p><ul><li><code>/usr/bin/passwd</code>: Change password</li><li><code>/usr/bin/sudo</code>: Temporary privilege escalation</li><li><code>/usr/bin/mount</code>: Mount filesystems</li><li><code>/usr/bin/ping</code>: Send ICMP packets (needs raw socket permission)</li></ul><hr><h2 id="SGID-Set-Group-ID"><a class="header-anchor" href="#SGID-Set-Group-ID">¶</a>SGID (Set Group ID)</h2><h3 id="Use-Cases"><a class="header-anchor" href="#Use-Cases">¶</a>Use Cases</h3><p>SGID has two uses:</p><h4 id="1-On-Executable-Files"><a class="header-anchor" href="#1-On-Executable-Files">¶</a>1. On Executable Files</h4><p>When process runs, its effective group ID (GID) is replaced by the file’s group. Common in tools that need to access specific group resources.</p><h4 id="2-On-Directories-More-Common"><a class="header-anchor" href="#2-On-Directories-More-Common">¶</a>2. On Directories (More Common)</h4><p><strong>When a directory has SGID set, new files or subdirectories created within inherit the directory’s group</strong>, not the creator’s default group. This is perfect for team shared directories.</p><p><strong>Example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /srv/project</span><br><span class="line">sudo <span class="built_in">chown</span> :developers /srv/project  <span class="comment"># Change group to developers</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 2775 /srv/project  <span class="comment"># Set SGID + 775 (2 means SGID)</span></span><br></pre></td></tr></table></figure><p>Now, any files created by developers group members in <code>/srv/project</code> automatically have group <code>developers</code>, accessible to other group members.</p><h3 id="View-and-Set-v2"><a class="header-anchor" href="#View-and-Set-v2">¶</a>View and Set</h3><p><strong>View</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l file  <span class="comment"># If group&#x27;s x position shows s (lowercase) or S (uppercase), SGID is set</span></span><br></pre></td></tr></table></figure><p><strong>Set SGID</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> g+s shared_dir  <span class="comment"># Symbolic notation</span></span><br><span class="line"><span class="built_in">chmod</span> 2775 shared_dir  <span class="comment"># Numeric notation (2 means SGID)</span></span><br></pre></td></tr></table></figure><p><strong>Remove SGID</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> g-s shared_dir</span><br></pre></td></tr></table></figure><hr><h2 id="Sticky-Bit"><a class="header-anchor" href="#Sticky-Bit">¶</a>Sticky Bit</h2><h3 id="Function-and-Principle"><a class="header-anchor" href="#Function-and-Principle">¶</a>Function and Principle</h3><p>Sticky Bit is most common on multi-user writable public directories like <code>/tmp</code>. <strong>When a directory has Sticky Bit set, files in that directory can only be deleted or renamed by their owner or root</strong>, even if others have write permission on the directory.</p><p><strong>Why is Sticky Bit needed?</strong></p><ul><li><code>/tmp</code> is a temporary directory shared by all users, permissions are <code>1777</code> (rwxrwxrwt)</li><li>Without Sticky Bit, user A could delete user B’s temp files (security risk)</li><li>With Sticky Bit, user A can only delete their own files, not user B’s files</li></ul><h3 id="View-and-Set-v3"><a class="header-anchor" href="#View-and-Set-v3">¶</a>View and Set</h3><p><strong>View</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld /tmp  <span class="comment"># Output: drwxrwxrwt (last character is t)</span></span><br></pre></td></tr></table></figure><p><strong>Set Sticky Bit</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> o+t <span class="built_in">dirname</span>  <span class="comment"># Symbolic notation</span></span><br><span class="line"><span class="built_in">chmod</span> 1777 /tmp  <span class="comment"># Numeric notation (1 means Sticky Bit)</span></span><br></pre></td></tr></table></figure><p><strong>Remove Sticky Bit</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> o-t <span class="built_in">dirname</span></span><br></pre></td></tr></table></figure><hr><h1>Common Scenarios and Best Practices</h1><h2 id="Scenario-1-Executable-Script"><a class="header-anchor" href="#Scenario-1-Executable-Script">¶</a>Scenario 1: Executable Script</h2><p><strong>Problem</strong>: <code>./script.sh: Permission denied</code></p><p><strong>Troubleshoot</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l script.sh  <span class="comment"># Check permissions</span></span><br></pre></td></tr></table></figure><p>If it shows <code>-rw-r--r--</code> (no x), execute permission is missing.</p><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x script.sh  <span class="comment"># Add execute permission for all</span></span><br><span class="line"><span class="comment"># Or</span></span><br><span class="line"><span class="built_in">chmod</span> 755 script.sh  <span class="comment"># owner=rwx, group=r-x, others=r-x</span></span><br></pre></td></tr></table></figure><p><strong>Note</strong>: Script also needs shebang (like <code>#!/bin/bash</code>), otherwise need to run with <code>bash script.sh</code>.</p><h2 id="Scenario-2-Web-Server-Directory"><a class="header-anchor" href="#Scenario-2-Web-Server-Directory">¶</a>Scenario 2: Web Server Directory</h2><p><strong>Requirement</strong>: Nginx/Apache needs to read files in <code>/var/www/html</code>.</p><p><strong>Troubleshoot</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld /var/www /var/www/html</span><br><span class="line"><span class="built_in">ls</span> -l /var/www/html/index.html</span><br></pre></td></tr></table></figure><p><strong>Common issues</strong>:</p><ul><li>Insufficient directory permissions (Nginx user doesn’t have x permission, can’t enter)</li><li>Insufficient file permissions (Nginx user doesn’t have r permission, can’t read)</li></ul><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R www-data:www-data /var/www/html  <span class="comment"># Change owner to www-data</span></span><br><span class="line">sudo <span class="built_in">chmod</span> -R 755 /var/www/html  <span class="comment"># Both directories and files set to 755</span></span><br><span class="line"><span class="comment"># Or stricter</span></span><br><span class="line">sudo find /var/www/html -<span class="built_in">type</span> d -<span class="built_in">exec</span> <span class="built_in">chmod</span> 755 &#123;&#125; \;  <span class="comment"># Directories 755</span></span><br><span class="line">sudo find /var/www/html -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; \;  <span class="comment"># Files 644</span></span><br></pre></td></tr></table></figure><h2 id="Scenario-3-Shared-Directory-Team-Collaboration"><a class="header-anchor" href="#Scenario-3-Shared-Directory-Team-Collaboration">¶</a>Scenario 3: Shared Directory (Team Collaboration)</h2><p><strong>Requirement</strong>: <code>/srv/project</code> directory, developers group members can all read/write, others cannot access.</p><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> /srv/project</span><br><span class="line">sudo <span class="built_in">chown</span> :developers /srv/project  <span class="comment"># Change group to developers</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 2770 /srv/project  <span class="comment"># SGID + 770 (only owner and group can access)</span></span><br></pre></td></tr></table></figure><ul><li><code>2</code>: SGID (new files automatically inherit developers group)</li><li><code>770</code>: owner and group both rwx, others no permissions</li></ul><p><strong>Verification</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># User A (developers group member) creates file</span></span><br><span class="line"><span class="built_in">touch</span> /srv/project/fileA</span><br><span class="line"><span class="built_in">ls</span> -l /srv/project/fileA  <span class="comment"># Output: -rw-r--r-- userA developers</span></span><br></pre></td></tr></table></figure><p>File group is automatically <code>developers</code>, other group members can also access.</p><h2 id="Scenario-4-Temp-Directory-Prevent-Mutual-File-Deletion"><a class="header-anchor" href="#Scenario-4-Temp-Directory-Prevent-Mutual-File-Deletion">¶</a>Scenario 4: Temp Directory (Prevent Mutual File Deletion)</h2><p><strong>Requirement</strong>: <code>/tmp</code> directory, all users can create files, but can’t delete others’ files.</p><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 1777 /tmp  <span class="comment"># Sticky Bit + 777</span></span><br></pre></td></tr></table></figure><ul><li><code>1</code>: Sticky Bit (only owner and root can delete files)</li><li><code>777</code>: All users can read/write/execute</li></ul><hr><h1>Extended Mechanisms: ACL and chattr</h1><h2 id="ACL-Access-Control-Lists"><a class="header-anchor" href="#ACL-Access-Control-Lists">¶</a>ACL (Access Control Lists)</h2><p><strong>Why ACL is needed?</strong></p><ul><li>Traditional permissions can only set three layers (owner/group/others), not flexible enough</li><li>ACL can set permissions for specific users or specific groups (like “user A has read permission, user B has write permission”)</li></ul><p><strong>View ACL</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getfacl file.txt</span><br></pre></td></tr></table></figure><p><strong>Set ACL</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setfacl -m u:alice:rw file.txt  <span class="comment"># Give user alice read/write permission</span></span><br><span class="line">setfacl -m g:dev:rx <span class="built_in">dir</span>  <span class="comment"># Give group dev read/execute permission</span></span><br><span class="line">setfacl -x u:alice file.txt  <span class="comment"># Remove alice&#x27;s ACL</span></span><br><span class="line">setfacl -b file.txt  <span class="comment"># Remove all ACLs</span></span><br></pre></td></tr></table></figure><p><strong>Recursive setting</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setfacl -R -m u:alice:rwx <span class="built_in">dir</span>  <span class="comment"># Recursively set</span></span><br></pre></td></tr></table></figure><h2 id="chattr-File-Attributes-Prevent-Accidental-Deletion-Modification"><a class="header-anchor" href="#chattr-File-Attributes-Prevent-Accidental-Deletion-Modification">¶</a>chattr: File Attributes (Prevent Accidental Deletion/Modification)</h2><p><code>chattr</code> can set special file attributes (supported by ext4 filesystem).</p><p><strong>Common attributes</strong>:</p><ul><li><code>i</code> (immutable): File cannot be modified, deleted, renamed (not even by root, unless i attribute is removed first)</li><li><code>a</code> (append-only): File can only be appended to, cannot modify existing content (suitable for log files)</li></ul><p><strong>Set immutable</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +i important.conf  <span class="comment"># File becomes immutable</span></span><br><span class="line"><span class="built_in">rm</span> important.conf  <span class="comment"># ❌ Operation not permitted (not even root can delete)</span></span><br><span class="line">sudo chattr -i important.conf  <span class="comment"># Remove i attribute before deleting</span></span><br></pre></td></tr></table></figure><p><strong>Set append-only</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +a logfile.txt  <span class="comment"># Only append allowed</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;new line&quot;</span> &gt;&gt; logfile.txt  <span class="comment"># ✅ Can append</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;overwrite&quot;</span> &gt; logfile.txt  <span class="comment"># ❌ Operation not permitted (cannot overwrite)</span></span><br></pre></td></tr></table></figure><p><strong>View attributes</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsattr file.txt</span><br></pre></td></tr></table></figure><p><strong>Use cases</strong>:</p><ul><li>Protect important config files (<code>/etc/fstab</code>, <code>/etc/passwd</code>)</li><li>Prevent log files from being cleared</li></ul><hr><h1>Permission Troubleshooting Checklist: What to Do When Problems Arise</h1><h2 id="Problem-1-Permission-denied"><a class="header-anchor" href="#Problem-1-Permission-denied">¶</a>Problem 1: <code>Permission denied</code></h2><p><strong>Troubleshooting steps</strong>:</p><ol><li>Confirm executing user: <code>whoami</code> (or check service’s running user, like systemd unit file)</li><li>View file permissions: <code>ls -l file</code></li><li>View all parent directory permissions: <code>namei -l /full/path/to/file</code> (needs <code>util-linux</code> package)</li><li>Check group membership: <code>id</code> (see which groups current user belongs to)</li><li>Check special attributes: <code>lsattr file</code> (whether has <code>i</code> or <code>a</code> attribute)</li></ol><p><strong>Common causes</strong>:</p><ul><li>File doesn’t have read/write/execute permission</li><li>Parent directory doesn’t have x permission (can’t enter)</li><li>User not in file’s group</li></ul><p><strong>Solutions</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 644 file  <span class="comment"># Give read permission</span></span><br><span class="line">sudo <span class="built_in">chmod</span> +x script.sh  <span class="comment"># Give execute permission</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 755 /path/to/parent/dir  <span class="comment"># Give parent directory x permission</span></span><br><span class="line">sudo <span class="built_in">chown</span> user:group file  <span class="comment"># Modify ownership</span></span><br></pre></td></tr></table></figure><h2 id="Problem-2-Web-Server-403-Forbidden"><a class="header-anchor" href="#Problem-2-Web-Server-403-Forbidden">¶</a>Problem 2: Web Server 403 Forbidden</h2><p><strong>Cause</strong>: Nginx/Apache user (like <code>www-data</code>, <code>nginx</code>) doesn’t have permission to read file.</p><p><strong>Troubleshoot</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep nginx  <span class="comment"># Check nginx running user</span></span><br><span class="line"><span class="built_in">ls</span> -l /var/www/html/index.html  <span class="comment"># Check file permissions</span></span><br><span class="line">namei -l /var/www/html/index.html  <span class="comment"># Check all parent directory permissions</span></span><br></pre></td></tr></table></figure><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> -R www-data:www-data /var/www/html</span><br><span class="line">sudo <span class="built_in">chmod</span> -R 755 /var/www/html  <span class="comment"># Directories 755</span></span><br><span class="line">sudo find /var/www/html -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; \;  <span class="comment"># Files 644</span></span><br></pre></td></tr></table></figure><h2 id="Problem-3-Script-Execution-Fails"><a class="header-anchor" href="#Problem-3-Script-Execution-Fails">¶</a>Problem 3: Script Execution Fails</h2><p><strong>Cause</strong>: Script doesn’t have execute permission or shebang is wrong.</p><p><strong>Troubleshoot</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l script.sh  <span class="comment"># Check permissions</span></span><br><span class="line"><span class="built_in">head</span> -1 script.sh  <span class="comment"># Check shebang</span></span><br></pre></td></tr></table></figure><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x script.sh  <span class="comment"># Add execute permission</span></span><br><span class="line"><span class="comment"># Ensure shebang is correct (like #!/bin/bash)</span></span><br></pre></td></tr></table></figure><h2 id="Problem-4-rm-cannot-remove-file-Operation-not-permitted"><a class="header-anchor" href="#Problem-4-rm-cannot-remove-file-Operation-not-permitted">¶</a>Problem 4: <code>rm: cannot remove 'file': Operation not permitted</code></h2><p><strong>Cause</strong>: File might have <code>i</code> attribute (immutable).</p><p><strong>Troubleshoot</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsattr file</span><br></pre></td></tr></table></figure><p>If output contains <code>i</code> (like <code>----i--------</code>), file has immutable attribute.</p><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr -i file  <span class="comment"># Remove i attribute</span></span><br><span class="line"><span class="built_in">rm</span> file  <span class="comment"># Can delete now</span></span><br></pre></td></tr></table></figure><hr><h1>Summary and Further Reading</h1><p>This article covers the core content of Linux file permissions:</p><ol><li>✅ Linux permission model (owner/group/others, rwx semantics)</li><li>✅ rwx differences on files vs directories (most common pitfall)</li><li>✅ chmod and chown usage (numeric/symbolic notation)</li><li>✅ umask principles and common values (default permissions for new files)</li><li>✅ Special permissions (SUID/SGID/Sticky Bit principles and use cases)</li><li>✅ Extended mechanisms (ACL, chattr)</li><li>✅ Permission troubleshooting checklist (Permission denied, 403, script execution failure, etc.)</li></ol><p><strong>Further Reading</strong>:</p><ul><li><code>man chmod</code>: View detailed chmod manual</li><li><code>man chown</code>: View detailed chown manual</li><li><code>man 5 acl</code>: View detailed ACL explanation</li><li>SELinux / AppArmor: More advanced security models (Mandatory Access Control MAC)</li></ul><p><strong>Next Steps</strong>:</p><ul><li><strong>《Linux User Management》</strong>: Learn how to manage users/groups, <code>/etc/passwd</code>, <code>/etc/shadow</code>, sudo configuration</li><li><strong>《Linux Advanced File Operations》</strong>: Learn pipes, redirection, stdin/stdout/stderr, <code>xargs</code>, <code>tee</code></li></ul><hr><p><strong>By this point, you should have upgraded from “can use chmod 755” to “understand permission semantics, can design shared directory permission schemes, can troubleshoot permission issues.” File permissions are the cornerstone of Linux security; mastering them allows you to better protect systems and data.</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;File permissions are “basic” in Linux, but they are also one of the most common causes of production incidents: a service won’t start, a deploy script can’t execute, a web app returns 403, or a shared directory becomes a security hole because permissions were made too broad. To use permissions correctly, you need more than memorizing &lt;code&gt;chmod 755&lt;/code&gt;—you need to understand how &lt;strong&gt;permission bits have completely different semantics on files vs directories&lt;/strong&gt; (r/w/x mean different things for directories), the boundaries between owner/group/others, and why mechanisms like &lt;code&gt;umask&lt;/code&gt;, SUID/SGID, and the sticky bit exist and when they should be used. This post starts from the minimal concept set, systematically explains rwx semantics, numeric/symbolic notation, typical usage and troubleshooting approaches for chmod/chown, uses common scenarios (shared directories, executable scripts, temp directories, security hardening) to explain “how to grant permissions and to what extent,” then adds extended mechanisms like ACL and &lt;code&gt;chattr&lt;/code&gt; plus a practical troubleshooting checklist, enabling you to locate and correctly fix permission issues in one shot.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux 用户管理</title>
    <link href="https://chenk.top/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-09T16:00:00.000Z</published>
    <updated>2026-01-29T16:43:55.584Z</updated>
    
    <content type="html"><![CDATA[<p>在 Linux 多用户、多任务环境中，用户与组的管理不只是&quot;添加账号&quot;这么简单——它直接决定了谁能登录、哪些进程以哪个身份运行、权限模型如何执行、以及 sudo 权限怎么分配。本文会从用户与组的概念模型（users vs groups、UID/GID 的含义与边界）讲起，系统梳理你真正会用到的命令（<code>useradd/usermod/userdel</code>、<code>groupadd/groupmod/groupdel</code>、<code>passwd/chage</code>），补齐安全机制（锁定账号、密码策略、sudo 配置、<code>/etc/sudoers</code> 的正确写法），并详细解析核心系统文件（<code>/etc/passwd</code>、<code>/etc/shadow</code>、<code>/etc/group</code>、<code>/etc/gshadow</code>、<code>/etc/skel</code> 的字段含义与实际用途）。最后用实战案例（共享项目目录、服务账号配置、sudo 权限分级、批量用户管理）把&quot;如何设计合理的用户权限方案&quot;落到实处，让你能独立完成从创建用户到权限分配再到安全加固的完整流程。</p><span id="more"></span><h1>Linux 用户与组的核心概念</h1><h2 id="用户（User）与组（Group）的关系"><a class="header-anchor" href="#用户（User）与组（Group）的关系">¶</a>用户（User）与组（Group）的关系</h2><p>Linux 是多用户系统，每个用户都有：</p><ul><li><strong>唯一的用户名</strong>（如 <code>alice</code>、<code>bob</code>）</li><li><strong>唯一的 UID</strong>（User ID，数字标识）</li><li><strong>一个初始组</strong>（Primary Group，GID）</li><li><strong>零个或多个附加组</strong>（Supplementary Groups）</li></ul><p><strong>为什么要有组？</strong></p><ul><li>方便权限管理（如&quot;所有开发人员都能访问 <code>/srv/project</code>&quot;）</li><li>避免给每个用户单独设置权限（维护成本高）</li></ul><p><strong>示例</strong>：</p><ul><li>用户 <code>alice</code> 的初始组是 <code>alice</code>（默认创建同名组）</li><li>附加组：<code>developers</code>、<code>docker</code></li><li>这样 <code>alice</code> 可以访问 <code>developers</code> 组和 <code>docker</code> 组拥有的资源</li></ul><h2 id="UID-和-GID-的边界"><a class="header-anchor" href="#UID-和-GID-的边界">¶</a>UID 和 GID 的边界</h2><table><thead><tr><th>UID 范围</th><th>用途</th><th>示例</th></tr></thead><tbody><tr><td><strong>0</strong></td><td>超级用户（root）</td><td>root</td></tr><tr><td><strong>1-999</strong></td><td>系统用户（服务账号，不允许登录）</td><td>nginx、mysql、www-data</td></tr><tr><td><strong>1000-60000</strong></td><td>普通用户（由管理员创建，允许登录）</td><td>alice、bob、charlie</td></tr></tbody></table><p><strong>注意</strong>：</p><ul><li>CentOS 6 及更早版本，普通用户从 UID 500 开始</li><li>CentOS 7+ 和 Ubuntu，普通用户从 UID 1000 开始</li></ul><p><strong>为什么要区分系统用户和普通用户？</strong></p><ul><li>系统用户（如 <code>nginx</code>）只用于运行服务，不需要登录（shell 设为 <code>/sbin/nologin</code>）</li><li>普通用户可以登录、运行程序、管理文件</li></ul><hr><h1>核心系统文件详解</h1><p>Linux 的用户信息分布在几个关键文件里：</p><h2 id="1-etc-passwd（公开的用户数据库）"><a class="header-anchor" href="#1-etc-passwd（公开的用户数据库）">¶</a>1. <code>/etc/passwd</code>（公开的用户数据库）</h2><p>存储所有用户的基本信息，<strong>任何用户都可以读取</strong>（但只有 root 可以修改）。</p><p><strong>格式</strong>：每行代表一个用户，字段用冒号 <code>:</code> 分隔</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username:x:UID:GID:comment:home:shell</span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">testuser:x:1001:1001:Test User:/home/testuser:/bin/bash</span><br><span class="line">nginx:x:33:33:nginx user:/var/lib/nginx:/sbin/nologin</span><br></pre></td></tr></table></figure><p><strong>字段解释</strong>：</p><ul><li><strong>username</strong>：登录名（如 <code>testuser</code>）</li><li><strong>x</strong>：密码占位符（真正的密码哈希在 <code>/etc/shadow</code>）</li><li><strong>UID</strong>：用户 ID（1001）<ul><li><code>0</code>：root 用户</li><li><code>1-999</code>：系统用户（服务账号）</li><li><code>1000+</code>：普通用户</li></ul></li><li><strong>GID</strong>：初始组 ID（1001）</li><li><strong>comment</strong>：注释信息（GECOS 字段，通常是用户全名或描述）</li><li><strong>home</strong>：家目录（<code>/home/testuser</code>）</li><li><strong>shell</strong>：登录 shell（<code>/bin/bash</code>）<ul><li><code>/bin/bash</code>：允许登录</li><li><code>/sbin/nologin</code>：禁止登录（服务账号常用）</li></ul></li></ul><h2 id="2-etc-shadow（密码哈希和密码策略）"><a class="header-anchor" href="#2-etc-shadow（密码哈希和密码策略）">¶</a>2. <code>/etc/shadow</code>（密码哈希和密码策略）</h2><p>存储用户的密码哈希和密码过期策略，<strong>只有 root 可以读取</strong>。</p><p><strong>格式</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username:password_hash:last_change:min:max:warn:inactive:expire:reserved</span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testuser:$6$4kTxu1...:19103:0:99999:7:::</span><br></pre></td></tr></table></figure><p><strong>字段解释</strong>：</p><ul><li><strong>username</strong>：用户名</li><li><strong>password_hash</strong>：密码哈希<ul><li><code>$6$...</code>：SHA-512 加密</li><li><code>$5$...</code>：SHA-256 加密</li><li><code>$1$...</code>：MD5 加密（不推荐）</li><li><code>!</code> 或 <code>*</code>：账号被锁定</li></ul></li><li><strong>last_change</strong>：最后一次修改密码的日期（自 1970-01-01 起的天数）</li><li><strong>min</strong>：密码最短使用期限（天数，0 表示随时可改）</li><li><strong>max</strong>：密码最长使用期限（天数，99999 表示永不过期）</li><li><strong>warn</strong>：密码过期前多少天开始警告（天数）</li><li><strong>inactive</strong>：密码过期后多少天禁用账号</li><li><strong>expire</strong>：账号过期日期（自 1970-01-01 起的天数）</li><li><strong>reserved</strong>：保留字段</li></ul><p><strong>常见操作</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -l testuser  <span class="comment"># 查看用户的密码策略</span></span><br><span class="line">sudo chage testuser  <span class="comment"># 交互式修改密码策略</span></span><br><span class="line">sudo chage -M 90 testuser  <span class="comment"># 设置密码最长使用期限为 90 天</span></span><br><span class="line">sudo chage -E 2025-12-31 testuser  <span class="comment"># 设置账号过期日期</span></span><br></pre></td></tr></table></figure><h2 id="3-etc-group（组信息）"><a class="header-anchor" href="#3-etc-group（组信息）">¶</a>3. <code>/etc/group</code>（组信息）</h2><p>存储所有组的基本信息。</p><p><strong>格式</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupname:x:GID:member1,member2,member3</span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">developers:x:1001:alice,bob,charlie</span><br><span class="line">docker:x:999:alice</span><br></pre></td></tr></table></figure><p><strong>字段解释</strong>：</p><ul><li><strong>groupname</strong>：组名（如 <code>developers</code>）</li><li><strong>x</strong>：组密码占位符（真正的组密码在 <code>/etc/gshadow</code>，很少用）</li><li><strong>GID</strong>：组 ID（1001）</li><li><strong>members</strong>：组成员列表（逗号分隔）</li></ul><p><strong>注意</strong>：</p><ul><li>这里的成员列表<strong>只包含附加组成员</strong>（不包括初始组成员）</li><li>比如 <code>alice</code> 的初始组是 <code>alice</code>（UID=GID=1001），她的附加组是 <code>developers</code> 和 <code>docker</code>，所以在 <code>/etc/group</code> 里只能在 <code>developers</code> 和 <code>docker</code> 的成员列表里看到她</li></ul><h2 id="4-etc-gshadow（组密码和管理信息）"><a class="header-anchor" href="#4-etc-gshadow（组密码和管理信息）">¶</a>4. <code>/etc/gshadow</code>（组密码和管理信息）</h2><p>类似 <code>/etc/shadow</code>，存储组密码和详细的组管理信息（在大公司/复杂权限管理场景下会用到）。</p><p><strong>格式</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupname:password:administrators:members</span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">developers:!::alice,bob,charlie</span><br></pre></td></tr></table></figure><ul><li><code>!</code>：表示没有组密码</li><li><code>administrators</code>：组管理员（可以管理组成员）</li><li><code>members</code>：组成员列表</li></ul><h2 id="5-etc-skel（家目录模板）"><a class="header-anchor" href="#5-etc-skel（家目录模板）">¶</a>5. <code>/etc/skel</code>（家目录模板）</h2><p>当创建新用户时，系统会把 <code>/etc/skel</code> 目录下的所有文件复制到新用户的家目录。</p><p><strong>默认内容</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -la /etc/skel</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bashrc</span><br><span class="line">.bash_logout</span><br><span class="line">.profile</span><br></pre></td></tr></table></figure><p><strong>用途</strong>：</p><ul><li>为所有新用户提供统一的初始配置（如 <code>.bashrc</code>、<code>.vimrc</code> 等）</li><li>可以自定义 <code>/etc/skel</code> 来提供公司统一的环境配置</li></ul><p><strong>如果之前创建用户时没有创建家目录，可以手动初始化</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /home/username</span><br><span class="line">sudo <span class="built_in">cp</span> -r /etc/skel/. /home/username/</span><br><span class="line">sudo <span class="built_in">chown</span> -R username:username /home/username</span><br></pre></td></tr></table></figure><hr><h1>用户管理命令</h1><h2 id="useradd：创建用户"><a class="header-anchor" href="#useradd：创建用户">¶</a>useradd：创建用户</h2><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd testuser</span><br></pre></td></tr></table></figure><p><strong>常用参数</strong>：</p><ul><li><code>-m</code>：自动创建家目录（推荐）</li><li><code>-d PATH</code>：指定家目录路径（默认 <code>/home/username</code>）</li><li><code>-s SHELL</code>：指定登录 shell（如 <code>/bin/bash</code>、<code>/bin/zsh</code>、<code>/sbin/nologin</code>）</li><li><code>-g GROUP</code>：指定初始组（默认创建同名组）</li><li><code>-G GROUPS</code>：指定附加组（逗号分隔，如 <code>developers,docker</code>）</li><li><code>-u UID</code>：指定 UID（默认自动分配）</li><li><code>-c COMMENT</code>：添加注释信息</li></ul><p><strong>实战示例</strong>：</p><h3 id="1-创建普通用户"><a class="header-anchor" href="#1-创建普通用户">¶</a>1. 创建普通用户</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m -s /bin/bash alice</span><br><span class="line">sudo passwd alice  <span class="comment"># 设置密码</span></span><br></pre></td></tr></table></figure><h3 id="2-创建服务账号（不允许登录）"><a class="header-anchor" href="#2-创建服务账号（不允许登录）">¶</a>2. 创建服务账号（不允许登录）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -r -s /sbin/nologin nginx</span><br></pre></td></tr></table></figure><ul><li><code>-r</code>：创建系统用户（UID &lt; 1000）</li></ul><h3 id="3-创建用户并指定初始组和附加组"><a class="header-anchor" href="#3-创建用户并指定初始组和附加组">¶</a>3. 创建用户并指定初始组和附加组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m -g developers -G docker,sudo bob</span><br><span class="line">sudo passwd bob</span><br></pre></td></tr></table></figure><ul><li><code>-g developers</code>：初始组是 <code>developers</code></li><li><code>-G docker,sudo</code>：附加组是 <code>docker</code> 和 <code>sudo</code></li></ul><h2 id="usermod：修改用户"><a class="header-anchor" href="#usermod：修改用户">¶</a>usermod：修改用户</h2><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod [选项] username</span><br></pre></td></tr></table></figure><p><strong>常用参数</strong>：</p><ul><li><code>-l NEWNAME</code>：修改用户名</li><li><code>-d PATH</code>：修改家目录</li><li><code>-m</code>：配合 <code>-d</code> 使用，迁移原家目录内容到新位置</li><li><code>-s SHELL</code>：修改登录 shell</li><li><code>-g GROUP</code>：修改初始组</li><li><code>-G GROUPS</code>：修改附加组（会覆盖原有附加组）</li><li><code>-aG GROUPS</code>：追加附加组（<strong>推荐</strong>，不覆盖原有附加组）</li><li><code>-L</code>：锁定用户（禁用密码）</li><li><code>-U</code>：解锁用户</li></ul><p><strong>实战示例</strong>：</p><ol><li>将用户加入 sudo 组</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG sudo alice  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo usermod -aG wheel alice  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><ol start="2"><li>修改用户的 shell</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -s /bin/zsh alice</span><br></pre></td></tr></table></figure><ol start="3"><li>迁移用户家目录</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -d /data/alice -m alice</span><br></pre></td></tr></table></figure><ul><li><code>-d /data/alice</code>：新家目录</li><li><code>-m</code>：迁移原家目录内容</li></ul><ol start="4"><li>锁定和解锁用户</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -L alice  <span class="comment"># 锁定（在 /etc/shadow 的密码哈希前加 `!`）</span></span><br><span class="line">sudo usermod -U alice  <span class="comment"># 解锁</span></span><br></pre></td></tr></table></figure><h2 id="userdel：删除用户"><a class="header-anchor" href="#userdel：删除用户">¶</a>userdel：删除用户</h2><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo userdel testuser  <span class="comment"># 删除用户（保留家目录）</span></span><br><span class="line">sudo userdel -r testuser  <span class="comment"># 删除用户及家目录</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：</p><ul><li>删除用户前先确认该用户没有正在运行的进程（<code>ps -u testuser</code>）</li><li>删除用户后，该用户创建的文件会变成&quot;孤儿文件&quot;（属主显示为 UID，如 <code>1001</code>）</li></ul><p><strong>最佳实践</strong>：不要直接删除用户，而是先锁定</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -L testuser  <span class="comment"># 锁定用户（禁止登录）</span></span><br><span class="line">sudo usermod -s /sbin/nologin testuser  <span class="comment"># 禁用 shell</span></span><br></pre></td></tr></table></figure><p>之后确认没有问题再删除。</p><p><strong>批量删除用户示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 从文件读取用户列表并删除</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> username; <span class="keyword">do</span></span><br><span class="line">    sudo userdel -r <span class="string">&quot;<span class="variable">$username</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;已删除用户：<span class="variable">$username</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span> &lt; users_to_delete.txt</span><br></pre></td></tr></table></figure><hr><h1>组管理命令</h1><h2 id="groupadd：创建组"><a class="header-anchor" href="#groupadd：创建组">¶</a>groupadd：创建组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd developers  <span class="comment"># 创建组</span></span><br><span class="line">sudo groupadd -g 2000 testgroup  <span class="comment"># 指定 GID</span></span><br></pre></td></tr></table></figure><h2 id="groupmod：修改组"><a class="header-anchor" href="#groupmod：修改组">¶</a>groupmod：修改组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo groupmod -n newname oldname  <span class="comment"># 修改组名</span></span><br><span class="line">sudo groupmod -g 3000 developers  <span class="comment"># 修改 GID</span></span><br></pre></td></tr></table></figure><h2 id="groupdel：删除组"><a class="header-anchor" href="#groupdel：删除组">¶</a>groupdel：删除组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo groupdel testgroup</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：不能删除用户的初始组（需要先删除用户或修改用户的初始组）。</p><p><strong>查看组信息</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getent group developers  <span class="comment"># 查看 developers 组的信息</span></span><br><span class="line">grep developers /etc/group  <span class="comment"># 同上（直接查看文件）</span></span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">developers:x:1001:alice,bob,charlie</span><br></pre></td></tr></table></figure><h2 id="用户与组的关联操作"><a class="header-anchor" href="#用户与组的关联操作">¶</a>用户与组的关联操作</h2><h3 id="将用户加入组"><a class="header-anchor" href="#将用户加入组">¶</a>将用户加入组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG groupname username  <span class="comment"># -a 表示追加（不覆盖原有附加组）</span></span><br></pre></td></tr></table></figure><h3 id="查看用户所属的组"><a class="header-anchor" href="#查看用户所属的组">¶</a>查看用户所属的组</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">groups</span> username  <span class="comment"># 查看用户所属的所有组</span></span><br><span class="line"><span class="built_in">id</span> username  <span class="comment"># 查看用户的 UID、GID、附加组</span></span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid=1001(alice) gid=1001(alice) groups=1001(alice),1002(developers),999(docker)</span><br></pre></td></tr></table></figure><h3 id="移除用户与某组的关联"><a class="header-anchor" href="#移除用户与某组的关联">¶</a>移除用户与某组的关联</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -d username groupname  <span class="comment"># 从组中删除用户</span></span><br></pre></td></tr></table></figure><p><strong>查看当前登录用户</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">whoami</span>  <span class="comment"># 显示当前用户名</span></span><br><span class="line"><span class="built_in">id</span>  <span class="comment"># 显示当前用户的 UID、GID、附加组</span></span><br><span class="line"><span class="built_in">who</span>  <span class="comment"># 显示所有登录的用户</span></span><br><span class="line">w  <span class="comment"># 更详细的版本（包括用户在干什么）</span></span><br></pre></td></tr></table></figure><p><strong>查看用户登录历史</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">last  <span class="comment"># 显示用户登录历史</span></span><br><span class="line">last username  <span class="comment"># 显示指定用户的登录历史</span></span><br><span class="line">lastlog  <span class="comment"># 显示所有用户的最后登录时间</span></span><br></pre></td></tr></table></figure><hr><h1>密码管理与安全策略</h1><h2 id="passwd：设置和修改密码"><a class="header-anchor" href="#passwd：设置和修改密码">¶</a>passwd：设置和修改密码</h2><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">passwd  <span class="comment"># 修改当前用户密码</span></span><br><span class="line">sudo passwd username  <span class="comment"># 修改指定用户密码</span></span><br></pre></td></tr></table></figure><p><strong>高级用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd -l username  <span class="comment"># 锁定用户（禁用密码）</span></span><br><span class="line">sudo passwd -u username  <span class="comment"># 解锁用户</span></span><br><span class="line">sudo passwd -d username  <span class="comment"># 删除用户密码（允许无密码登录，不推荐）</span></span><br><span class="line">sudo passwd -e username  <span class="comment"># 强制用户下次登录时修改密码</span></span><br></pre></td></tr></table></figure><h2 id="chage：密码过期策略"><a class="header-anchor" href="#chage：密码过期策略">¶</a>chage：密码过期策略</h2><p><code>chage</code> 用于管理用户的密码过期策略。</p><p><strong>查看用户的密码策略</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -l username</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Last password change                                    : Jan 28, 2025</span><br><span class="line">Password expires                                        : never</span><br><span class="line">Password inactive                                       : never</span><br><span class="line">Account expires                                         : never</span><br><span class="line">Minimum number of days between password change          : 0</span><br><span class="line">Maximum number of days between password change          : 99999</span><br><span class="line">Number of days of warning before password expires       : 7</span><br></pre></td></tr></table></figure><p><strong>常用操作</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -M 90 username  <span class="comment"># 密码最长使用期限 90 天</span></span><br><span class="line">sudo chage -m 7 username  <span class="comment"># 密码最短使用期限 7 天（防止频繁改密码绕过策略）</span></span><br><span class="line">sudo chage -W 7 username  <span class="comment"># 密码过期前 7 天开始警告</span></span><br><span class="line">sudo chage -E 2025-12-31 username  <span class="comment"># 设置账号过期日期</span></span><br><span class="line">sudo chage -I 30 username  <span class="comment"># 密码过期后 30 天禁用账号</span></span><br></pre></td></tr></table></figure><p><strong>密码策略最佳实践</strong>（安全加固）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -M 90 -W 7 -I 30 username</span><br></pre></td></tr></table></figure><ul><li>密码最长使用期限 90 天</li><li>过期前 7 天开始警告</li><li>过期后 30 天禁用账号</li></ul><p><strong>密码复杂度策略</strong>（通过 PAM 配置）：<br>编辑 <code>/etc/pam.d/common-password</code>（Debian/Ubuntu）或 <code>/etc/pam.d/system-auth</code>（CentOS/RHEL），添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password requisite pam_pwquality.so retry=3 minlen=12 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1</span><br></pre></td></tr></table></figure><ul><li><code>minlen=12</code>：最小长度 12 位</li><li><code>dcredit=-1</code>：至少 1 个数字</li><li><code>ucredit=-1</code>：至少 1 个大写字母</li><li><code>ocredit=-1</code>：至少 1 个特殊字符</li><li><code>lcredit=-1</code>：至少 1 个小写字母</li></ul><p><strong>强制历史密码检查</strong>（防止重复使用旧密码）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password required pam_pwhistory.so remember=5</span><br></pre></td></tr></table></figure><ul><li><code>remember=5</code>：记住最近 5 个密码，不允许重复使用</li></ul><hr><h1>sudo 权限配置</h1><h2 id="为什么要用-sudo"><a class="header-anchor" href="#为什么要用-sudo">¶</a>为什么要用 sudo</h2><p><strong>问题</strong>：如果直接用 root 登录：</p><ul><li>风险高（一个 <code>rm -rf /</code> 就删光系统）</li><li>日志里分不清是谁干的（都是 root）</li></ul><p><strong>解决</strong>：用普通用户登录，需要权限时用 <code>sudo</code>。</p><p><strong>优点</strong>：</p><ul><li>日志里能看到是哪个用户执行了哪个 <code>sudo</code> 命令</li><li>可以限制用户只能执行特定命令（如只能重启 nginx，不能删除文件）</li><li>不需要告诉用户 root 密码</li></ul><h2 id="sudo-的工作原理"><a class="header-anchor" href="#sudo-的工作原理">¶</a>sudo 的工作原理</h2><ol><li>用户执行 <code>sudo command</code></li><li>sudo 检查 <code>/etc/sudoers</code> 文件，看该用户是否有权限</li><li>如果有权限，sudo 要求用户输入<strong>自己的密码</strong>（不是 root 密码）</li><li>验证通过后，以 root 身份执行命令</li></ol><h2 id="配置-sudoers"><a class="header-anchor" href="#配置-sudoers">¶</a>配置 sudoers</h2><p><strong>配置文件</strong>：<code>/etc/sudoers</code></p><p><strong>重要</strong>：<strong>永远用 <code>visudo</code> 编辑</strong>（不要直接 <code>vim /etc/sudoers</code>）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo visudo</span><br></pre></td></tr></table></figure><p><code>visudo</code> 会检查语法，防止你写错导致 sudo 彻底锁死（连 root 都修复不了，只能重启到单用户模式修复）。</p><p><strong>基本格式</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user    host=(runas_user:runas_group) commands</span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><h3 id="1-给用户完整的-sudo-权限"><a class="header-anchor" href="#1-给用户完整的-sudo-权限">¶</a>1. 给用户完整的 sudo 权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure><ul><li>第一个 <code>ALL</code>：在所有主机上</li><li><code>(ALL:ALL)</code>：可以以任何用户和组的身份运行</li><li>最后一个 <code>ALL</code>：可以执行任何命令</li></ul><h3 id="2-给组完整的-sudo-权限"><a class="header-anchor" href="#2-给组完整的-sudo-权限">¶</a>2. 给组完整的 sudo 权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%sudo ALL=(ALL:ALL) ALL  <span class="comment"># Debian/Ubuntu（% 表示组）</span></span><br><span class="line">%wheel ALL=(ALL:ALL) ALL  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h3 id="3-允许用户执行特定命令（不需要密码）"><a class="header-anchor" href="#3-允许用户执行特定命令（不需要密码）">¶</a>3. 允许用户执行特定命令（不需要密码）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx</span><br></pre></td></tr></table></figure><ul><li><code>NOPASSWD:</code>：不需要输入密码</li><li><code>/usr/bin/systemctl restart nginx</code>：只允许重启 nginx</li></ul><h3 id="4-允许用户执行多个命令"><a class="header-anchor" href="#4-允许用户执行多个命令">¶</a>4. 允许用户执行多个命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx, /usr/bin/systemctl status nginx</span><br></pre></td></tr></table></figure><h2 id="快速方法：加入-sudo-组"><a class="header-anchor" href="#快速方法：加入-sudo-组">¶</a>快速方法：加入 sudo 组</h2><p><strong>Debian/Ubuntu</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG sudo alice</span><br></pre></td></tr></table></figure><p><strong>CentOS/RHEL</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG wheel alice</span><br></pre></td></tr></table></figure><p>之后 <code>alice</code> 就可以用 <code>sudo</code> 执行任何命令了。</p><h2 id="sudo-日志审计"><a class="header-anchor" href="#sudo-日志审计">¶</a>sudo 日志审计</h2><p>sudo 的所有操作都会记录在日志里，方便审计。</p><p><strong>查看 sudo 日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo grep sudo /var/log/auth.log  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo grep sudo /var/log/secure  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><p><strong>查看某个用户的 sudo 历史</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo grep <span class="string">&quot;alice.*COMMAND&quot;</span> /var/log/auth.log</span><br></pre></td></tr></table></figure><p><strong>实时监控 sudo 操作</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tail</span> -f /var/log/auth.log | grep sudo</span><br></pre></td></tr></table></figure><hr><h1>实战场景</h1><h2 id="场景-1：创建共享项目目录"><a class="header-anchor" href="#场景-1：创建共享项目目录">¶</a>场景 1：创建共享项目目录</h2><p><strong>需求</strong>：<code>/srv/project</code> 目录，developers 组的成员都能读写，其他人不能访问，新建文件自动继承 developers 组。</p><p><strong>方案</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd developers  <span class="comment"># 创建组</span></span><br><span class="line">sudo useradd -m -G developers alice  <span class="comment"># 创建用户并加入组</span></span><br><span class="line">sudo useradd -m -G developers bob</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">mkdir</span> /srv/project</span><br><span class="line">sudo <span class="built_in">chown</span> :developers /srv/project  <span class="comment"># 属组改为 developers</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 2770 /srv/project  <span class="comment"># SGID + 770</span></span><br></pre></td></tr></table></figure><ul><li><code>2</code>：SGID（新建文件自动继承 developers 组）</li><li><code>770</code>：owner 和 group 都是 rwx，others 无权限</li></ul><p><strong>验证</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su - alice</span><br><span class="line"><span class="built_in">touch</span> /srv/project/test.txt</span><br><span class="line"><span class="built_in">ls</span> -l /srv/project/test.txt  <span class="comment"># 输出：-rw-r--r-- alice developers</span></span><br></pre></td></tr></table></figure><h2 id="场景-2：创建服务账号（如-Nginx）"><a class="header-anchor" href="#场景-2：创建服务账号（如-Nginx）">¶</a>场景 2：创建服务账号（如 Nginx）</h2><p><strong>需求</strong>：创建 <code>nginx</code> 用户，用于运行 Nginx 服务，不允许登录。</p><p><strong>方案</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -r -s /sbin/nologin -d /var/lib/nginx -M nginx</span><br></pre></td></tr></table></figure><ul><li><code>-r</code>：创建系统用户（UID &lt; 1000）</li><li><code>-s /sbin/nologin</code>：禁止登录</li><li><code>-d /var/lib/nginx</code>：指定家目录</li><li><code>-M</code>：不创建家目录</li></ul><h2 id="场景-3：批量创建用户"><a class="header-anchor" href="#场景-3：批量创建用户">¶</a>场景 3：批量创建用户</h2><p>假设你有一个用户列表 <code>users.txt</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alice</span><br><span class="line">bob</span><br><span class="line">charlie</span><br></pre></td></tr></table></figure><p><strong>方案</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> username; <span class="keyword">do</span></span><br><span class="line">    sudo useradd -m -s /bin/bash <span class="string">&quot;<span class="variable">$username</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;password123&quot;</span> | sudo passwd --stdin <span class="string">&quot;<span class="variable">$username</span>&quot;</span>  <span class="comment"># CentOS/RHEL</span></span><br><span class="line">    <span class="comment"># 或 Ubuntu/Debian:</span></span><br><span class="line">    <span class="comment"># echo &quot;$username:password123&quot; | sudo chpasswd</span></span><br><span class="line"><span class="keyword">done</span> &lt; users.txt</span><br></pre></td></tr></table></figure><h2 id="场景-4：sudo-权限分级"><a class="header-anchor" href="#场景-4：sudo-权限分级">¶</a>场景 4：sudo 权限分级</h2><p><strong>需求</strong>：</p><ul><li><code>alice</code> 可以执行任何命令</li><li><code>bob</code> 只能重启 nginx</li><li><code>charlie</code> 只能查看日志</li></ul><p><strong>方案</strong>：编辑 <code>sudo visudo</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL:ALL) ALL</span><br><span class="line">bob ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx, /usr/bin/systemctl status nginx</span><br><span class="line">charlie ALL=(ALL) NOPASSWD: /usr/bin/tail, /usr/bin/less, /usr/bin/cat</span><br></pre></td></tr></table></figure><h2 id="场景-5：限制用户只能访问特定目录（chroot）"><a class="header-anchor" href="#场景-5：限制用户只能访问特定目录（chroot）">¶</a>场景 5：限制用户只能访问特定目录（chroot）</h2><p><strong>需求</strong>：限制 <code>ftpuser</code> 只能访问 <code>/srv/ftp</code> 目录，不能访问系统其他目录。</p><p><strong>方案</strong>：使用 chroot jail（需要配置 SSH 或 FTP 服务）</p><p><strong>SSH chroot 配置</strong>（编辑 <code>/etc/ssh/sshd_config</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Match User ftpuser</span><br><span class="line">    ChrootDirectory /srv/ftp</span><br><span class="line">    ForceCommand internal-sftp</span><br><span class="line">    AllowTcpForwarding no</span><br><span class="line">    X11Forwarding no</span><br></pre></td></tr></table></figure><p>重启 SSH 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart sshd</span><br></pre></td></tr></table></figure><p>现在 <code>ftpuser</code> 登录后只能看到 <code>/srv/ftp</code> 目录，系统其他目录完全看不到。</p><h2 id="场景-6：用户配额管理（防止某个用户占满磁盘）"><a class="header-anchor" href="#场景-6：用户配额管理（防止某个用户占满磁盘）">¶</a>场景 6：用户配额管理（防止某个用户占满磁盘）</h2><p><strong>需求</strong>：限制用户只能使用 10GB 磁盘空间。</p><p><strong>方案</strong>：使用磁盘配额（quota）</p><p><strong>1. 启用配额</strong>（在 <code>/etc/fstab</code> 里添加 <code>usrquota</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sda1 /home ext4 defaults,usrquota 0 2</span><br></pre></td></tr></table></figure><p><strong>2. 重新挂载并初始化配额</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -o remount /home</span><br><span class="line">sudo quotacheck -cugm /home</span><br><span class="line">sudo quotaon /home</span><br></pre></td></tr></table></figure><p><strong>3. 设置配额</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo edquota -u alice</span><br></pre></td></tr></table></figure><p>在编辑器里设置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Disk quotas for user alice (uid 1001):</span><br><span class="line">Filesystem blocks soft hard inodes soft hard</span><br><span class="line">/dev/sda1      0    10G  12G    0    0    0</span><br></pre></td></tr></table></figure><ul><li><code>soft</code>：软限制（超过会警告）</li><li><code>hard</code>：硬限制（无法超过）</li></ul><p><strong>4. 查看配额使用情况</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">quota -u alice  <span class="comment"># 查看 alice 的配额使用</span></span><br><span class="line">sudo repquota -a  <span class="comment"># 查看所有用户的配额</span></span><br></pre></td></tr></table></figure><h2 id="场景-7：禁用-root-直接登录（安全加固）"><a class="header-anchor" href="#场景-7：禁用-root-直接登录（安全加固）">¶</a>场景 7：禁用 root 直接登录（安全加固）</h2><p><strong>需求</strong>：禁止 root 用户通过 SSH 直接登录，强制使用普通用户 + sudo。</p><p><strong>方案</strong>：编辑 <code>/etc/ssh/sshd_config</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PermitRootLogin no</span><br></pre></td></tr></table></figure><p>重启 SSH 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart sshd</span><br></pre></td></tr></table></figure><p><strong>最佳实践</strong>：</p><ol><li>先创建一个有 sudo 权限的普通用户（如 <code>admin</code>）</li><li>确认该用户可以 <code>sudo su -</code> 切换到 root</li><li>再禁用 root 登录（否则可能把自己锁在外面）</li></ol><hr><h1>总结与扩展阅读</h1><p>这篇文章涵盖了 Linux 用户管理的核心内容：</p><ol><li>✅ 用户与组的概念模型（users vs groups、UID/GID 边界）</li><li>✅ 核心系统文件详解（<code>/etc/passwd</code>、<code>/etc/shadow</code>、<code>/etc/group</code>、<code>/etc/gshadow</code>、<code>/etc/skel</code>）</li><li>✅ 用户管理命令（<code>useradd/usermod/userdel</code>、<code>passwd/chage</code>）</li><li>✅ 组管理命令（<code>groupadd/groupmod/groupdel</code>）</li><li>✅ sudo 权限配置（<code>/etc/sudoers</code>、<code>visudo</code>、权限分级）</li><li>✅ 实战场景（共享目录、服务账号、批量创建、sudo 分级）</li></ol><p><strong>扩展阅读</strong>：</p><ul><li><code>man useradd</code>：查看 useradd 的详细手册</li><li><code>man sudoers</code>：查看 sudoers 的详细配置说明</li><li>PAM（Pluggable Authentication Modules）：更高级的认证框架</li></ul><p><strong>下一步</strong>：</p><ul><li><strong>《Linux 文件权限》</strong>：学习如何管理文件/目录权限（rwx、SUID/SGID、ACL）</li><li><strong>《Linux 系统服务管理》</strong>：学习如何管理服务、配置开机自启</li></ul><hr><p><strong>到这里，你应该已经从&quot;会创建用户&quot;升级到&quot;能设计合理的用户权限方案、能配置 sudo 分级权限、能管理密码策略&quot;。用户管理是 Linux 安全的基础，掌握了它，你就能更好地保护系统和数据。</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在 Linux 多用户、多任务环境中，用户与组的管理不只是&amp;quot;添加账号&amp;quot;这么简单——它直接决定了谁能登录、哪些进程以哪个身份运行、权限模型如何执行、以及 sudo 权限怎么分配。本文会从用户与组的概念模型（users vs groups、UID/GID 的含义与边界）讲起，系统梳理你真正会用到的命令（&lt;code&gt;useradd/usermod/userdel&lt;/code&gt;、&lt;code&gt;groupadd/groupmod/groupdel&lt;/code&gt;、&lt;code&gt;passwd/chage&lt;/code&gt;），补齐安全机制（锁定账号、密码策略、sudo 配置、&lt;code&gt;/etc/sudoers&lt;/code&gt; 的正确写法），并详细解析核心系统文件（&lt;code&gt;/etc/passwd&lt;/code&gt;、&lt;code&gt;/etc/shadow&lt;/code&gt;、&lt;code&gt;/etc/group&lt;/code&gt;、&lt;code&gt;/etc/gshadow&lt;/code&gt;、&lt;code&gt;/etc/skel&lt;/code&gt; 的字段含义与实际用途）。最后用实战案例（共享项目目录、服务账号配置、sudo 权限分级、批量用户管理）把&amp;quot;如何设计合理的用户权限方案&amp;quot;落到实处，让你能独立完成从创建用户到权限分配再到安全加固的完整流程。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux User Management: Users, Groups, UID/GID, sudo, and Password Policies</title>
    <link href="https://chenk.top/en/linux-user-management/"/>
    <id>https://chenk.top/en/linux-user-management/</id>
    <published>2025-02-09T16:00:00.000Z</published>
    <updated>2026-01-29T16:39:54.771Z</updated>
    
    <content type="html"><![CDATA[<p>In Linux’s multi-user, multi-task environment, user and group management is not “just admin work”—it directly determines who can log in, which processes run under which identities, how the permission model executes, and how sudo privileges are allocated. This post starts from the conceptual model of users and groups (users vs groups, UID/GID meaning and boundaries), systematically organizes commands you’ll actually use (<code>useradd/usermod/userdel</code>, <code>groupadd/groupmod/groupdel</code>, <code>passwd/chage</code>), fills in security mechanisms (account locking, password policies, sudo configuration, correct <code>/etc/sudoers</code> syntax), and provides detailed analysis of core system files (<code>/etc/passwd</code>, <code>/etc/shadow</code>, <code>/etc/group</code>, <code>/etc/gshadow</code>, <code>/etc/skel</code> field meanings and practical uses). Finally, it uses practical cases (shared project directories, service account configuration, sudo permission stratification, batch user management) to ground “how to design reasonable user permission schemes” in practice, enabling you to independently complete the full workflow from creating users to permission allocation to security hardening.</p><span id="more"></span><h1>Core Linux User and Group Concepts</h1><h2 id="Relationship-Between-Users-and-Groups"><a class="header-anchor" href="#Relationship-Between-Users-and-Groups">¶</a>Relationship Between Users and Groups</h2><p>Linux is a multi-user system; every user has:</p><ul><li><strong>Unique username</strong> (like <code>alice</code>, <code>bob</code>)</li><li><strong>Unique UID</strong> (User ID, numeric identifier)</li><li><strong>One primary group</strong> (Primary Group, GID)</li><li><strong>Zero or more supplementary groups</strong> (Supplementary Groups)</li></ul><p><strong>Why groups?</strong></p><ul><li>Convenient permission management (like “all developers can access <code>/srv/project</code>”)</li><li>Avoids setting permissions for each user individually (high maintenance cost)</li></ul><p><strong>Example</strong>:</p><ul><li>User <code>alice</code>’s primary group is <code>alice</code> (default creates same-name group)</li><li>Supplementary groups: <code>developers</code>, <code>docker</code></li><li>This way <code>alice</code> can access resources owned by <code>developers</code> and <code>docker</code> groups</li></ul><h2 id="UID-and-GID-Boundaries"><a class="header-anchor" href="#UID-and-GID-Boundaries">¶</a>UID and GID Boundaries</h2><table><thead><tr><th>UID Range</th><th>Purpose</th><th>Example</th></tr></thead><tbody><tr><td><strong>0</strong></td><td>Superuser (root)</td><td>root</td></tr><tr><td><strong>1-999</strong></td><td>System users (service accounts, no login allowed)</td><td>nginx, mysql, www-data</td></tr><tr><td><strong>1000-60000</strong></td><td>Normal users (created by admin, login allowed)</td><td>alice, bob, charlie</td></tr></tbody></table><p><strong>Notes</strong>:</p><ul><li>CentOS 6 and earlier, normal users start from UID 500</li><li>CentOS 7+ and Ubuntu, normal users start from UID 1000</li></ul><p><strong>Why distinguish system users and normal users?</strong></p><ul><li>System users (like <code>nginx</code>) only run services, don’t need login (shell set to <code>/sbin/nologin</code>)</li><li>Normal users can log in, run programs, manage files</li></ul><hr><h1>Core System Files Explained</h1><p>Linux user information is distributed across several key files:</p><h2 id="1-etc-passwd-Public-User-Database"><a class="header-anchor" href="#1-etc-passwd-Public-User-Database">¶</a>1. <code>/etc/passwd</code> (Public User Database)</h2><p>Stores all users’ basic information, <strong>any user can read</strong> (but only root can modify).</p><p><strong>Format</strong>: Each line represents one user, fields separated by colon <code>:</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username:x:UID:GID:comment:home:shell</span><br></pre></td></tr></table></figure><p><strong>Examples</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">testuser:x:1001:1001:Test User:/home/testuser:/bin/bash</span><br><span class="line">nginx:x:33:33:nginx user:/var/lib/nginx:/sbin/nologin</span><br></pre></td></tr></table></figure><p><strong>Field Explanations</strong>:</p><ul><li><strong>username</strong>: Login name (like <code>testuser</code>)</li><li><strong>x</strong>: Password placeholder (real password hash in <code>/etc/shadow</code>)</li><li><strong>UID</strong>: User ID (1001)<ul><li><code>0</code>: root user</li><li><code>1-999</code>: System users (service accounts)</li><li><code>1000+</code>: Normal users</li></ul></li><li><strong>GID</strong>: Primary group ID (1001)</li><li><strong>comment</strong>: Comment info (GECOS field, usually user’s full name or description)</li><li><strong>home</strong>: Home directory (<code>/home/testuser</code>)</li><li><strong>shell</strong>: Login shell (<code>/bin/bash</code>)<ul><li><code>/bin/bash</code>: Login allowed</li><li><code>/sbin/nologin</code>: Login disabled (commonly used for service accounts)</li></ul></li></ul><h2 id="2-etc-shadow-Password-Hashes-and-Policies"><a class="header-anchor" href="#2-etc-shadow-Password-Hashes-and-Policies">¶</a>2. <code>/etc/shadow</code> (Password Hashes and Policies)</h2><p>Stores user password hashes and password expiration policies, <strong>only root can read</strong>.</p><p><strong>Format</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username:password_hash:last_change:min:max:warn:inactive:expire:reserved</span><br></pre></td></tr></table></figure><p><strong>Example</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testuser:$6$4kTxu1...:19103:0:99999:7:::</span><br></pre></td></tr></table></figure><p><strong>Field Explanations</strong>:</p><ul><li><strong>username</strong>: Username</li><li><strong>password_hash</strong>: Password hash<ul><li><code>$6$...</code>: SHA-512 encryption</li><li><code>$5$...</code>: SHA-256 encryption</li><li><code>$1$...</code>: MD5 encryption (not recommended)</li><li><code>!</code> or <code>*</code>: Account locked</li></ul></li><li><strong>last_change</strong>: Date of last password change (days since 1970-01-01)</li><li><strong>min</strong>: Minimum password age (days, 0 means can change anytime)</li><li><strong>max</strong>: Maximum password age (days, 99999 means never expires)</li><li><strong>warn</strong>: Days before password expiration to start warnings</li><li><strong>inactive</strong>: Days after password expiration before account is disabled</li><li><strong>expire</strong>: Account expiration date (days since 1970-01-01)</li><li><strong>reserved</strong>: Reserved field</li></ul><p><strong>Common operations</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -l testuser  <span class="comment"># View user&#x27;s password policy</span></span><br><span class="line">sudo chage testuser  <span class="comment"># Interactively modify password policy</span></span><br><span class="line">sudo chage -M 90 testuser  <span class="comment"># Set max password age to 90 days</span></span><br><span class="line">sudo chage -E 2025-12-31 testuser  <span class="comment"># Set account expiration date</span></span><br></pre></td></tr></table></figure><h2 id="3-etc-group-Group-Information"><a class="header-anchor" href="#3-etc-group-Group-Information">¶</a>3. <code>/etc/group</code> (Group Information)</h2><p>Stores all groups’ basic information.</p><p><strong>Format</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupname:x:GID:member1,member2,member3</span><br></pre></td></tr></table></figure><p><strong>Examples</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">developers:x:1001:alice,bob,charlie</span><br><span class="line">docker:x:999:alice</span><br></pre></td></tr></table></figure><p><strong>Field Explanations</strong>:</p><ul><li><strong>groupname</strong>: Group name (like <code>developers</code>)</li><li><strong>x</strong>: Group password placeholder (real group password in <code>/etc/gshadow</code>, rarely used)</li><li><strong>GID</strong>: Group ID (1001)</li><li><strong>members</strong>: Group member list (comma-separated)</li></ul><p><strong>Note</strong>:</p><ul><li>Member list <strong>only includes supplementary group members</strong> (not primary group members)</li><li>For example, <code>alice</code>’s primary group is <code>alice</code> (UID=GID=1001), her supplementary groups are <code>developers</code> and <code>docker</code>, so in <code>/etc/group</code> she only appears in <code>developers</code> and <code>docker</code> member lists</li></ul><h2 id="4-etc-gshadow-Group-Passwords-and-Admin-Info"><a class="header-anchor" href="#4-etc-gshadow-Group-Passwords-and-Admin-Info">¶</a>4. <code>/etc/gshadow</code> (Group Passwords and Admin Info)</h2><p>Similar to <code>/etc/shadow</code>, stores group passwords and detailed group management info (used in large companies/complex permission management scenarios).</p><p><strong>Format</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupname:password:administrators:members</span><br></pre></td></tr></table></figure><p><strong>Example</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">developers:!::alice,bob,charlie</span><br></pre></td></tr></table></figure><ul><li><code>!</code>: No group password</li><li><code>administrators</code>: Group administrators (can manage group members)</li><li><code>members</code>: Group member list</li></ul><h2 id="5-etc-skel-Home-Directory-Template"><a class="header-anchor" href="#5-etc-skel-Home-Directory-Template">¶</a>5. <code>/etc/skel</code> (Home Directory Template)</h2><p>When creating new users, system copies all files from <code>/etc/skel</code> to new user’s home directory.</p><p><strong>Default contents</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -la /etc/skel</span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bashrc</span><br><span class="line">.bash_logout</span><br><span class="line">.profile</span><br></pre></td></tr></table></figure><p><strong>Purpose</strong>:</p><ul><li>Provide unified initial configuration for all new users (like <code>.bashrc</code>, <code>.vimrc</code>, etc.)</li><li>Can customize <code>/etc/skel</code> to provide company-wide unified environment configuration</li></ul><p><strong>If you created user without home directory before, can manually initialize</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /home/username</span><br><span class="line">sudo <span class="built_in">cp</span> -r /etc/skel/. /home/username/</span><br><span class="line">sudo <span class="built_in">chown</span> -R username:username /home/username</span><br></pre></td></tr></table></figure><hr><h1>User Management Commands</h1><h2 id="useradd-Create-User"><a class="header-anchor" href="#useradd-Create-User">¶</a>useradd: Create User</h2><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd testuser</span><br></pre></td></tr></table></figure><p><strong>Common parameters</strong>:</p><ul><li><code>-m</code>: Auto-create home directory (recommended)</li><li><code>-d PATH</code>: Specify home directory path (default <code>/home/username</code>)</li><li><code>-s SHELL</code>: Specify login shell (like <code>/bin/bash</code>, <code>/bin/zsh</code>, <code>/sbin/nologin</code>)</li><li><code>-g GROUP</code>: Specify primary group (default creates same-name group)</li><li><code>-G GROUPS</code>: Specify supplementary groups (comma-separated, like <code>developers,docker</code>)</li><li><code>-u UID</code>: Specify UID (default auto-assign)</li><li><code>-c COMMENT</code>: Add comment info</li></ul><p><strong>Practical examples</strong>:</p><h3 id="1-Create-Normal-User"><a class="header-anchor" href="#1-Create-Normal-User">¶</a>1. Create Normal User</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m -s /bin/bash alice</span><br><span class="line">sudo passwd alice  <span class="comment"># Set password</span></span><br></pre></td></tr></table></figure><h3 id="2-Create-Service-Account-No-Login-Allowed"><a class="header-anchor" href="#2-Create-Service-Account-No-Login-Allowed">¶</a>2. Create Service Account (No Login Allowed)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -r -s /sbin/nologin nginx</span><br></pre></td></tr></table></figure><ul><li><code>-r</code>: Create system user (UID &lt; 1000)</li></ul><h3 id="3-Create-User-with-Specified-Primary-and-Supplementary-Groups"><a class="header-anchor" href="#3-Create-User-with-Specified-Primary-and-Supplementary-Groups">¶</a>3. Create User with Specified Primary and Supplementary Groups</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -m -g developers -G docker,sudo bob</span><br><span class="line">sudo passwd bob</span><br></pre></td></tr></table></figure><ul><li><code>-g developers</code>: Primary group is <code>developers</code></li><li><code>-G docker,sudo</code>: Supplementary groups are <code>docker</code> and <code>sudo</code></li></ul><h2 id="usermod-Modify-User"><a class="header-anchor" href="#usermod-Modify-User">¶</a>usermod: Modify User</h2><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod [options] username</span><br></pre></td></tr></table></figure><p><strong>Common parameters</strong>:</p><ul><li><code>-l NEWNAME</code>: Modify username</li><li><code>-d PATH</code>: Modify home directory</li><li><code>-m</code>: Use with <code>-d</code> to migrate original home directory contents to new location</li><li><code>-s SHELL</code>: Modify login shell</li><li><code>-g GROUP</code>: Modify primary group</li><li><code>-G GROUPS</code>: Modify supplementary groups (will overwrite existing supplementary groups)</li><li><code>-aG GROUPS</code>: Append supplementary groups (<strong>recommended</strong>, doesn’t overwrite existing)</li><li><code>-L</code>: Lock user (disable password)</li><li><code>-U</code>: Unlock user</li></ul><p><strong>Practical examples</strong>:</p><h3 id="1-Add-User-to-sudo-Group"><a class="header-anchor" href="#1-Add-User-to-sudo-Group">¶</a>1. Add User to sudo Group</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG sudo alice  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo usermod -aG wheel alice  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h3 id="2-Modify-User’s-Shell"><a class="header-anchor" href="#2-Modify-User’s-Shell">¶</a>2. Modify User’s Shell</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -s /bin/zsh alice</span><br></pre></td></tr></table></figure><h3 id="3-Migrate-User-Home-Directory"><a class="header-anchor" href="#3-Migrate-User-Home-Directory">¶</a>3. Migrate User Home Directory</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -d /data/alice -m alice</span><br></pre></td></tr></table></figure><ul><li><code>-d /data/alice</code>: New home directory</li><li><code>-m</code>: Migrate original home directory contents</li></ul><h3 id="4-Lock-and-Unlock-User"><a class="header-anchor" href="#4-Lock-and-Unlock-User">¶</a>4. Lock and Unlock User</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -L alice  <span class="comment"># Lock (adds `!` before password hash in /etc/shadow)</span></span><br><span class="line">sudo usermod -U alice  <span class="comment"># Unlock</span></span><br></pre></td></tr></table></figure><h2 id="userdel-Delete-User"><a class="header-anchor" href="#userdel-Delete-User">¶</a>userdel: Delete User</h2><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo userdel testuser  <span class="comment"># Delete user (keep home directory)</span></span><br><span class="line">sudo userdel -r testuser  <span class="comment"># Delete user and home directory</span></span><br></pre></td></tr></table></figure><p><strong>Notes</strong>:</p><ul><li>Before deleting user, confirm no processes are running (<code>ps -u testuser</code>)</li><li>After deleting user, files created by that user become “orphaned files” (owner shows as UID, like <code>1001</code>)</li></ul><p><strong>Best practice</strong>: Don’t directly delete user, lock first</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -L testuser  <span class="comment"># Lock user (disable login)</span></span><br><span class="line">sudo usermod -s /sbin/nologin testuser  <span class="comment"># Disable shell</span></span><br></pre></td></tr></table></figure><p>Confirm no issues then delete.</p><hr><h1>Group Management Commands</h1><h2 id="groupadd-Create-Group"><a class="header-anchor" href="#groupadd-Create-Group">¶</a>groupadd: Create Group</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd developers  <span class="comment"># Create group</span></span><br><span class="line">sudo groupadd -g 2000 testgroup  <span class="comment"># Specify GID</span></span><br></pre></td></tr></table></figure><h2 id="groupmod-Modify-Group"><a class="header-anchor" href="#groupmod-Modify-Group">¶</a>groupmod: Modify Group</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo groupmod -n newname oldname  <span class="comment"># Modify group name</span></span><br><span class="line">sudo groupmod -g 3000 developers  <span class="comment"># Modify GID</span></span><br></pre></td></tr></table></figure><h2 id="groupdel-Delete-Group"><a class="header-anchor" href="#groupdel-Delete-Group">¶</a>groupdel: Delete Group</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo groupdel testgroup</span><br></pre></td></tr></table></figure><p><strong>Note</strong>: Cannot delete user’s primary group (need to delete user first or modify user’s primary group).</p><h2 id="User-Group-Association-Operations"><a class="header-anchor" href="#User-Group-Association-Operations">¶</a>User-Group Association Operations</h2><h3 id="Add-User-to-Group"><a class="header-anchor" href="#Add-User-to-Group">¶</a>Add User to Group</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG groupname username  <span class="comment"># -a means append (don&#x27;t overwrite existing supplementary groups)</span></span><br></pre></td></tr></table></figure><h3 id="View-User’s-Groups"><a class="header-anchor" href="#View-User’s-Groups">¶</a>View User’s Groups</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">groups</span> username  <span class="comment"># View all groups user belongs to</span></span><br><span class="line"><span class="built_in">id</span> username  <span class="comment"># View user&#x27;s UID, GID, supplementary groups</span></span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid=1001(alice) gid=1001(alice) groups=1001(alice),1002(developers),999(docker)</span><br></pre></td></tr></table></figure><h3 id="Remove-User-from-Group"><a class="header-anchor" href="#Remove-User-from-Group">¶</a>Remove User from Group</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gpasswd -d username groupname  <span class="comment"># Remove user from group</span></span><br></pre></td></tr></table></figure><hr><h1>Password Management and Security Policies</h1><h2 id="passwd-Set-and-Modify-Passwords"><a class="header-anchor" href="#passwd-Set-and-Modify-Passwords">¶</a>passwd: Set and Modify Passwords</h2><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">passwd  <span class="comment"># Modify current user&#x27;s password</span></span><br><span class="line">sudo passwd username  <span class="comment"># Modify specified user&#x27;s password</span></span><br></pre></td></tr></table></figure><p><strong>Advanced usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo passwd -l username  <span class="comment"># Lock user (disable password)</span></span><br><span class="line">sudo passwd -u username  <span class="comment"># Unlock user</span></span><br><span class="line">sudo passwd -d username  <span class="comment"># Delete user password (allow passwordless login, not recommended)</span></span><br><span class="line">sudo passwd -e username  <span class="comment"># Force user to change password on next login</span></span><br></pre></td></tr></table></figure><h2 id="chage-Password-Expiration-Policy"><a class="header-anchor" href="#chage-Password-Expiration-Policy">¶</a>chage: Password Expiration Policy</h2><p><code>chage</code> is used to manage user password expiration policies.</p><p><strong>View user’s password policy</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -l username</span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Last password change                                    : Jan 28, 2025</span><br><span class="line">Password expires                                        : never</span><br><span class="line">Password inactive                                       : never</span><br><span class="line">Account expires                                         : never</span><br><span class="line">Minimum number of days between password change          : 0</span><br><span class="line">Maximum number of days between password change          : 99999</span><br><span class="line">Number of days of warning before password expires       : 7</span><br></pre></td></tr></table></figure><p><strong>Common operations</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -M 90 username  <span class="comment"># Max password age 90 days</span></span><br><span class="line">sudo chage -m 7 username  <span class="comment"># Min password age 7 days (prevent frequent password changes to bypass policy)</span></span><br><span class="line">sudo chage -W 7 username  <span class="comment"># Start warnings 7 days before password expiration</span></span><br><span class="line">sudo chage -E 2025-12-31 username  <span class="comment"># Set account expiration date</span></span><br><span class="line">sudo chage -I 30 username  <span class="comment"># Disable account 30 days after password expiration</span></span><br></pre></td></tr></table></figure><p><strong>Password policy best practices</strong> (security hardening):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chage -M 90 -W 7 -I 30 username</span><br></pre></td></tr></table></figure><ul><li>Max password age 90 days</li><li>Start warnings 7 days before expiration</li><li>Disable account 30 days after expiration</li></ul><hr><h1>sudo Permission Configuration</h1><h2 id="Why-Use-sudo"><a class="header-anchor" href="#Why-Use-sudo">¶</a>Why Use sudo</h2><p><strong>Problem</strong>: If you log in directly as root:</p><ul><li>High risk (one <code>rm -rf /</code> deletes entire system)</li><li>Logs can’t tell who did what (everything is root)</li></ul><p><strong>Solution</strong>: Log in as normal user, use <code>sudo</code> when permissions needed.</p><p><strong>Advantages</strong>:</p><ul><li>Logs show which user executed which <code>sudo</code> command</li><li>Can limit users to only execute specific commands (like only restart nginx, can’t delete files)</li><li>Don’t need to tell users root password</li></ul><h2 id="How-sudo-Works"><a class="header-anchor" href="#How-sudo-Works">¶</a>How sudo Works</h2><ol><li>User executes <code>sudo command</code></li><li>sudo checks <code>/etc/sudoers</code> file to see if user has permission</li><li>If has permission, sudo requires user to enter <strong>their own password</strong> (not root password)</li><li>After verification, execute command as root</li></ol><h2 id="Configure-sudoers"><a class="header-anchor" href="#Configure-sudoers">¶</a>Configure sudoers</h2><p><strong>Config file</strong>: <code>/etc/sudoers</code></p><p><strong>Important</strong>: <strong>Always use <code>visudo</code> to edit</strong> (don’t directly <code>vim /etc/sudoers</code>)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo visudo</span><br></pre></td></tr></table></figure><p><code>visudo</code> checks syntax, preventing you from writing errors that completely lock sudo (not even root can fix, only reboot to single-user mode to fix).</p><p><strong>Basic format</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user    host=(runas_user:runas_group) commands</span><br></pre></td></tr></table></figure><p><strong>Examples</strong>:</p><h3 id="1-Give-User-Full-sudo-Permissions"><a class="header-anchor" href="#1-Give-User-Full-sudo-Permissions">¶</a>1. Give User Full sudo Permissions</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure><ul><li>First <code>ALL</code>: On all hosts</li><li><code>(ALL:ALL)</code>: Can run as any user and group</li><li>Last <code>ALL</code>: Can execute any command</li></ul><h3 id="2-Give-Group-Full-sudo-Permissions"><a class="header-anchor" href="#2-Give-Group-Full-sudo-Permissions">¶</a>2. Give Group Full sudo Permissions</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%sudo ALL=(ALL:ALL) ALL  <span class="comment"># Debian/Ubuntu (% indicates group)</span></span><br><span class="line">%wheel ALL=(ALL:ALL) ALL  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h3 id="3-Allow-User-to-Execute-Specific-Command-No-Password"><a class="header-anchor" href="#3-Allow-User-to-Execute-Specific-Command-No-Password">¶</a>3. Allow User to Execute Specific Command (No Password)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx</span><br></pre></td></tr></table></figure><ul><li><code>NOPASSWD:</code>: Don’t need to enter password</li><li><code>/usr/bin/systemctl restart nginx</code>: Only allow restarting nginx</li></ul><h3 id="4-Allow-User-to-Execute-Multiple-Commands"><a class="header-anchor" href="#4-Allow-User-to-Execute-Multiple-Commands">¶</a>4. Allow User to Execute Multiple Commands</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx, /usr/bin/systemctl status nginx</span><br></pre></td></tr></table></figure><h2 id="Quick-Method-Add-to-sudo-Group"><a class="header-anchor" href="#Quick-Method-Add-to-sudo-Group">¶</a>Quick Method: Add to sudo Group</h2><p><strong>Debian/Ubuntu</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG sudo alice</span><br></pre></td></tr></table></figure><p><strong>CentOS/RHEL</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo usermod -aG wheel alice</span><br></pre></td></tr></table></figure><p>After this, <code>alice</code> can use <code>sudo</code> to execute any command.</p><hr><h1>Practical Scenarios</h1><h2 id="Scenario-1-Create-Shared-Project-Directory"><a class="header-anchor" href="#Scenario-1-Create-Shared-Project-Directory">¶</a>Scenario 1: Create Shared Project Directory</h2><p><strong>Requirement</strong>: <code>/srv/project</code> directory, developers group members can all read/write, others cannot access, new files automatically inherit developers group.</p><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo groupadd developers  <span class="comment"># Create group</span></span><br><span class="line">sudo useradd -m -G developers alice  <span class="comment"># Create user and add to group</span></span><br><span class="line">sudo useradd -m -G developers bob</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">mkdir</span> /srv/project</span><br><span class="line">sudo <span class="built_in">chown</span> :developers /srv/project  <span class="comment"># Change group to developers</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 2770 /srv/project  <span class="comment"># SGID + 770</span></span><br></pre></td></tr></table></figure><ul><li><code>2</code>: SGID (new files automatically inherit developers group)</li><li><code>770</code>: owner and group both rwx, others no permissions</li></ul><p><strong>Verification</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su - alice</span><br><span class="line"><span class="built_in">touch</span> /srv/project/test.txt</span><br><span class="line"><span class="built_in">ls</span> -l /srv/project/test.txt  <span class="comment"># Output: -rw-r--r-- alice developers</span></span><br></pre></td></tr></table></figure><h2 id="Scenario-2-Create-Service-Account-Like-Nginx"><a class="header-anchor" href="#Scenario-2-Create-Service-Account-Like-Nginx">¶</a>Scenario 2: Create Service Account (Like Nginx)</h2><p><strong>Requirement</strong>: Create <code>nginx</code> user for running Nginx service, no login allowed.</p><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo useradd -r -s /sbin/nologin -d /var/lib/nginx -M nginx</span><br></pre></td></tr></table></figure><ul><li><code>-r</code>: Create system user (UID &lt; 1000)</li><li><code>-s /sbin/nologin</code>: Disable login</li><li><code>-d /var/lib/nginx</code>: Specify home directory</li><li><code>-M</code>: Don’t create home directory</li></ul><h2 id="Scenario-3-Batch-Create-Users"><a class="header-anchor" href="#Scenario-3-Batch-Create-Users">¶</a>Scenario 3: Batch Create Users</h2><p>Suppose you have a user list <code>users.txt</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alice</span><br><span class="line">bob</span><br><span class="line">charlie</span><br></pre></td></tr></table></figure><p><strong>Solution</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> username; <span class="keyword">do</span></span><br><span class="line">    sudo useradd -m -s /bin/bash <span class="string">&quot;<span class="variable">$username</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;password123&quot;</span> | sudo passwd --stdin <span class="string">&quot;<span class="variable">$username</span>&quot;</span>  <span class="comment"># CentOS/RHEL</span></span><br><span class="line">    <span class="comment"># Or Ubuntu/Debian:</span></span><br><span class="line">    <span class="comment"># echo &quot;$username:password123&quot; | sudo chpasswd</span></span><br><span class="line"><span class="keyword">done</span> &lt; users.txt</span><br></pre></td></tr></table></figure><h2 id="Scenario-4-sudo-Permission-Stratification"><a class="header-anchor" href="#Scenario-4-sudo-Permission-Stratification">¶</a>Scenario 4: sudo Permission Stratification</h2><p><strong>Requirement</strong>:</p><ul><li><code>alice</code> can execute any command</li><li><code>bob</code> can only restart nginx</li><li><code>charlie</code> can only view logs</li></ul><p><strong>Solution</strong>: Edit <code>sudo visudo</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alice ALL=(ALL:ALL) ALL</span><br><span class="line">bob ALL=(ALL) NOPASSWD: /usr/bin/systemctl restart nginx, /usr/bin/systemctl status nginx</span><br><span class="line">charlie ALL=(ALL) NOPASSWD: /usr/bin/tail, /usr/bin/less, /usr/bin/cat</span><br></pre></td></tr></table></figure><hr><h1>Summary and Further Reading</h1><p>This article covers the core content of Linux user management:</p><ol><li>✅ User and group conceptual model (users vs groups, UID/GID boundaries)</li><li>✅ Core system files explained (<code>/etc/passwd</code>, <code>/etc/shadow</code>, <code>/etc/group</code>, <code>/etc/gshadow</code>, <code>/etc/skel</code>)</li><li>✅ User management commands (<code>useradd/usermod/userdel</code>, <code>passwd/chage</code>)</li><li>✅ Group management commands (<code>groupadd/groupmod/groupdel</code>)</li><li>✅ sudo permission configuration (<code>/etc/sudoers</code>, <code>visudo</code>, permission stratification)</li><li>✅ Practical scenarios (shared directories, service accounts, batch creation, sudo stratification)</li></ol><p><strong>Further Reading</strong>:</p><ul><li><code>man useradd</code>: View detailed useradd manual</li><li><code>man sudoers</code>: View detailed sudoers configuration explanation</li><li>PAM (Pluggable Authentication Modules): More advanced authentication framework</li></ul><p><strong>Next Steps</strong>:</p><ul><li><strong>《Linux File Permissions》</strong>: Learn how to manage file/directory permissions (rwx, SUID/SGID, ACL)</li><li><strong>《Linux System Service Management》</strong>: Learn how to manage services, configure auto-start on boot</li></ul><hr><p><strong>By this point, you should have upgraded from “can create users” to “can design reasonable user permission schemes, can configure sudo stratified permissions, can manage password policies.” User management is the foundation of Linux security; mastering it allows you to better protect systems and data.</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;In Linux’s multi-user, multi-task environment, user and group management is not “just admin work”—it directly determines who can log in, which processes run under which identities, how the permission model executes, and how sudo privileges are allocated. This post starts from the conceptual model of users and groups (users vs groups, UID/GID meaning and boundaries), systematically organizes commands you’ll actually use (&lt;code&gt;useradd/usermod/userdel&lt;/code&gt;, &lt;code&gt;groupadd/groupmod/groupdel&lt;/code&gt;, &lt;code&gt;passwd/chage&lt;/code&gt;), fills in security mechanisms (account locking, password policies, sudo configuration, correct &lt;code&gt;/etc/sudoers&lt;/code&gt; syntax), and provides detailed analysis of core system files (&lt;code&gt;/etc/passwd&lt;/code&gt;, &lt;code&gt;/etc/shadow&lt;/code&gt;, &lt;code&gt;/etc/group&lt;/code&gt;, &lt;code&gt;/etc/gshadow&lt;/code&gt;, &lt;code&gt;/etc/skel&lt;/code&gt; field meanings and practical uses). Finally, it uses practical cases (shared project directories, service account configuration, sudo permission stratification, batch user management) to ground “how to design reasonable user permission schemes” in practice, enabling you to independently complete the full workflow from creating users to permission allocation to security hardening.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux 软件包管理</title>
    <link href="https://chenk.top/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-29T16:43:59.789Z</updated>
    
    <content type="html"><![CDATA[<p>软件包管理看起来只是&quot;装/卸/更新&quot;，但真正决定你是否少踩坑的，是两件事：第一，包里到底包含了什么（可执行文件、配置、依赖库、服务脚本），以及它们分别落在系统的哪些位置；第二，发行版的工具链差异（Debian/Ubuntu 的 <code>dpkg/apt</code> vs RHEL/CentOS 的 <code>rpm/yum/dnf</code>）会如何影响依赖解析、版本选择与回滚策略。本文先把软件包与依赖的基本概念讲清楚，再给出一套可复现的常用操作清单（包括高级用法：依赖冲突排查、版本锁定、降级、清理无用包），并补上国内环境最常见的配置（例如替换阿里云源、清华源、验证源是否生效）。最后把&quot;装包&quot;延伸到更贴近生产的两条路径：源码编译（以 Nginx 为例，讲清楚 configure/make/make install 分别干了什么）与二进制免安装配置（以 Java 为例），让你在遇到版本/依赖/网络限制时有可选的落地方案。</p><span id="more"></span><h1>软件包的基本概念：包里有什么、为什么需要包管理器</h1><h2 id="软件包的组成"><a class="header-anchor" href="#软件包的组成">¶</a>软件包的组成</h2><p>软件包是将程序、库文件、配置文件以及文档等打包在一起的文件，方便安装、升级和卸载。一个标准的软件包通常包括以下内容：</p><h3 id="二进制可执行文件（Binary-Executables）"><a class="header-anchor" href="#二进制可执行文件（Binary-Executables）">¶</a>二进制可执行文件（Binary Executables）</h3><p>经过编译的程序源代码，生成的可执行二进制文件。例如：</p><ul><li><code>/usr/bin/vim</code>：文本编辑器</li><li><code>/usr/sbin/nginx</code>：Web 服务器</li><li><code>/usr/bin/gcc</code>：编译器</li></ul><h3 id="配置文件（Configuration-Files）"><a class="header-anchor" href="#配置文件（Configuration-Files）">¶</a>配置文件（Configuration Files）</h3><p>存放应用程序的默认配置，通常位于 <code>/etc/</code> 目录下。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/nginx.conf  <span class="comment"># Nginx 的配置文件</span></span><br><span class="line">/etc/mysql/my.cnf      <span class="comment"># MySQL 的配置文件</span></span><br><span class="line">/etc/ssh/sshd_config   <span class="comment"># SSH 服务端配置</span></span><br></pre></td></tr></table></figure><p><strong>重要特性</strong>：包管理器在升级时通常会<strong>保留你修改过的配置文件</strong>（不会覆盖），避免配置丢失。</p><h3 id="共享库（Shared-Libraries）"><a class="header-anchor" href="#共享库（Shared-Libraries）">¶</a>共享库（Shared Libraries）</h3><p>共享库是可执行文件运行时依赖的动态链接库（类似 Windows 的 <code>.dll</code>），通常存放在 <code>/usr/lib/</code> 或 <code>/lib/</code> 目录下。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/libssl.so             <span class="comment"># OpenSSL 加密库</span></span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6  <span class="comment"># GNU C 标准库</span></span><br></pre></td></tr></table></figure><p><strong>为什么需要共享库？</strong></p><ul><li>节省磁盘空间（多个程序共享同一个库）</li><li>节省内存（同一个库只加载一次）</li><li>方便升级（升级库后，所有依赖这个库的程序都受益）</li></ul><h3 id="数据文件（Data-Files）"><a class="header-anchor" href="#数据文件（Data-Files）">¶</a>数据文件（Data Files）</h3><p>应用程序所需的数据，如数据库文件、默认资源等。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/mysql/   <span class="comment"># MySQL 数据库存放目录</span></span><br><span class="line">/var/www/html/    <span class="comment"># Web 服务器默认站点目录</span></span><br></pre></td></tr></table></figure><h3 id="文档（Documentation）"><a class="header-anchor" href="#文档（Documentation）">¶</a>文档（Documentation）</h3><p>软件的说明文档、手册页（man pages）、版权声明等，通常存放在 <code>/usr/share/doc/</code> 目录。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/doc/nginx/README</span><br><span class="line">/usr/share/man/man1/vim.1.gz  <span class="comment"># vim 的 man 手册</span></span><br></pre></td></tr></table></figure><h3 id="服务单元文件（Service-Units，如果是服务）"><a class="header-anchor" href="#服务单元文件（Service-Units，如果是服务）">¶</a>服务单元文件（Service Units，如果是服务）</h3><p>如果是后台服务，还会包含 systemd unit 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/etc/systemd/system/mysql.service</span><br></pre></td></tr></table></figure><h2 id="为什么需要包管理器"><a class="header-anchor" href="#为什么需要包管理器">¶</a>为什么需要包管理器</h2><p>如果没有包管理器，你需要：</p><ol><li><strong>手动下载软件</strong>（从官网或第三方网站找下载链接）</li><li><strong>手动解决依赖</strong>（A 依赖 B，B 依赖 C，你得一个一个装）</li><li><strong>手动放置文件</strong>（可执行文件放哪、配置文件放哪、库文件放哪）</li><li><strong>手动卸载</strong>（卸载时要记得删除所有文件，包括配置和依赖）</li><li><strong>手动更新</strong>（每个软件都要去官网查有没有新版本）</li></ol><p><strong>包管理器的核心价值</strong>：</p><ul><li><strong>自动解决依赖</strong>：A 依赖 B，装 A 时自动装 B</li><li><strong>统一安装位置</strong>：所有软件都按规范放置，不会乱</li><li><strong>一键卸载</strong>：卸载时自动删除所有相关文件</li><li><strong>一键更新</strong>：<code>apt upgrade</code> 或 <code>dnf upgrade</code> 更新所有软件</li><li><strong>版本管理</strong>：可以查看、锁定、降级软件版本</li><li><strong>安全性</strong>：软件包都经过签名验证，减少恶意软件风险</li></ul><hr><h1>Linux 主流包管理器对比</h1><p>不同的 Linux 发行版使用不同的包管理器：</p><table><thead><tr><th><strong>发行版</strong></th><th><strong>包格式</strong></th><th><strong>底层工具</strong></th><th><strong>高层工具</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong>Debian/Ubuntu</strong></td><td>.deb</td><td>dpkg</td><td>apt, apt-get</td><td>最流行的桌面和云服务器发行版</td></tr><tr><td><strong>RHEL/CentOS/Fedora</strong></td><td>.rpm</td><td>rpm</td><td>yum (旧), dnf (新)</td><td>企业级 Linux，CentOS 8+ 和 Fedora 默认用 dnf</td></tr><tr><td><strong>Arch Linux</strong></td><td>.tar.zst</td><td>pacman</td><td>pacman</td><td>滚动更新，软件版本最新</td></tr><tr><td><strong>Gentoo</strong></td><td>源码包</td><td>emerge</td><td>portage</td><td>完全从源码编译，高度可定制</td></tr><tr><td><strong>openSUSE</strong></td><td>.rpm</td><td>rpm</td><td>zypper</td><td>欧洲企业常用</td></tr></tbody></table><p><strong>本文主要讲 Debian/Ubuntu 的 apt/dpkg 和 RHEL/CentOS 的 yum/dnf/rpm，因为它们是最常用的。</strong></p><hr><h1>Debian/Ubuntu 包管理：apt + dpkg</h1><h2 id="apt-vs-apt-get-vs-dpkg"><a class="header-anchor" href="#apt-vs-apt-get-vs-dpkg">¶</a>apt vs apt-get vs dpkg</h2><table><thead><tr><th>工具</th><th>说明</th><th>推荐度</th></tr></thead><tbody><tr><td><strong>apt</strong></td><td>高层工具，自动处理依赖，用户友好（颜色、进度条），推荐日常使用</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>apt-get</strong></td><td>老版高层工具，功能同 apt 但界面简陋，脚本中常用（输出稳定）</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>dpkg</strong></td><td>底层工具，直接操作 .deb 包，<strong>不会自动处理依赖</strong>（需要手动解决）</td><td>⭐⭐</td></tr></tbody></table><p><strong>推荐</strong>：日常使用 <code>apt</code>，脚本中使用 <code>apt-get</code>（输出格式更稳定）。</p><h2 id="常用操作"><a class="header-anchor" href="#常用操作">¶</a>常用操作</h2><h3 id="更新软件源信息"><a class="header-anchor" href="#更新软件源信息">¶</a>更新软件源信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update  <span class="comment"># 从软件源下载最新的包列表</span></span><br></pre></td></tr></table></figure><p>这个命令只是更新本地的包列表缓存，不会升级任何软件。</p><h3 id="搜索软件包"><a class="header-anchor" href="#搜索软件包">¶</a>搜索软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt search nginx  <span class="comment"># 搜索包含 nginx 的包</span></span><br><span class="line">apt-cache search nginx  <span class="comment"># 同上（老命令）</span></span><br></pre></td></tr></table></figure><h3 id="查看包信息"><a class="header-anchor" href="#查看包信息">¶</a>查看包信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt show nginx  <span class="comment"># 查看 nginx 的详细信息（版本、依赖、描述）</span></span><br><span class="line">apt-cache policy nginx  <span class="comment"># 查看 nginx 的版本和安装状态</span></span><br></pre></td></tr></table></figure><h3 id="安装软件包"><a class="header-anchor" href="#安装软件包">¶</a>安装软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx  <span class="comment"># 安装 nginx</span></span><br><span class="line">sudo apt install nginx=1.18.0-0ubuntu1  <span class="comment"># 安装指定版本</span></span><br><span class="line">sudo apt install nginx -y  <span class="comment"># 自动回答 yes（不询问确认）</span></span><br></pre></td></tr></table></figure><h3 id="卸载软件包"><a class="header-anchor" href="#卸载软件包">¶</a>卸载软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt remove nginx  <span class="comment"># 卸载 nginx（保留配置文件）</span></span><br><span class="line">sudo apt purge nginx   <span class="comment"># 彻底卸载 nginx（删除配置文件）</span></span><br><span class="line">sudo apt autoremove    <span class="comment"># 删除不再需要的依赖包（清理垃圾）</span></span><br></pre></td></tr></table></figure><p><strong>区别</strong>：</p><ul><li><code>remove</code>：只删除程序文件，保留 <code>/etc/</code> 下的配置文件（方便以后重新安装时恢复配置）</li><li><code>purge</code>：连配置文件一起删（彻底卸载）</li></ul><h3 id="升级软件包"><a class="header-anchor" href="#升级软件包">¶</a>升级软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt upgrade  <span class="comment"># 升级所有可升级的包（不删除已安装的包）</span></span><br><span class="line">sudo apt full-upgrade  <span class="comment"># 升级所有包（必要时可以删除旧包）</span></span><br><span class="line">sudo apt dist-upgrade  <span class="comment"># 同 full-upgrade（老命令）</span></span><br></pre></td></tr></table></figure><p><strong>区别</strong>：</p><ul><li><code>upgrade</code>：保守升级，不删除已安装的包</li><li><code>full-upgrade</code>：激进升级，必要时可以删除或安装包（如依赖关系变化）</li></ul><h3 id="查看已安装的包"><a class="header-anchor" href="#查看已安装的包">¶</a>查看已安装的包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dpkg -l  <span class="comment"># 列出所有已安装的包</span></span><br><span class="line">dpkg -l | grep nginx  <span class="comment"># 查看 nginx 是否已安装</span></span><br><span class="line">apt list --installed  <span class="comment"># 同上（apt 命令）</span></span><br></pre></td></tr></table></figure><h3 id="查看包安装的文件"><a class="header-anchor" href="#查看包安装的文件">¶</a>查看包安装的文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -L nginx  <span class="comment"># 查看 nginx 安装了哪些文件</span></span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/nginx</span><br><span class="line">/etc/nginx/nginx.conf</span><br><span class="line">/usr/share/doc/nginx/README</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="查看文件属于哪个包"><a class="header-anchor" href="#查看文件属于哪个包">¶</a>查看文件属于哪个包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -S /usr/sbin/nginx  <span class="comment"># 查看 /usr/sbin/nginx 属于哪个包</span></span><br></pre></td></tr></table></figure><p>输出：<code>nginx-core: /usr/sbin/nginx</code></p><h3 id="手动安装-deb-包"><a class="header-anchor" href="#手动安装-deb-包">¶</a>手动安装 .deb 包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i package.deb  <span class="comment"># 安装 .deb 包（不会自动解决依赖）</span></span><br><span class="line">sudo apt install -f  <span class="comment"># 修复依赖（如果上面报错）</span></span><br></pre></td></tr></table></figure><p><strong>更好的方式</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ./package.deb  <span class="comment"># apt 会自动解决依赖</span></span><br></pre></td></tr></table></figure><h2 id="高级用法-v2"><a class="header-anchor" href="#高级用法-v2">¶</a>高级用法</h2><h3 id="锁定包版本（防止升级）"><a class="header-anchor" href="#锁定包版本（防止升级）">¶</a>锁定包版本（防止升级）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-mark hold nginx  <span class="comment"># 锁定 nginx，prevent upgrade</span></span><br><span class="line">apt-mark showhold  <span class="comment"># 查看被锁定的包</span></span><br><span class="line">sudo apt-mark unhold nginx  <span class="comment"># 解锁</span></span><br></pre></td></tr></table></figure><h3 id="降级包版本"><a class="header-anchor" href="#降级包版本">¶</a>降级包版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查看可用版本</span></span><br><span class="line">apt-cache policy nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装指定版本</span></span><br><span class="line">sudo apt install nginx=1.18.0-0ubuntu1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 锁定版本（防止被升级）</span></span><br><span class="line">sudo apt-mark hold nginx</span><br></pre></td></tr></table></figure><h3 id="清理缓存（释放磁盘空间）"><a class="header-anchor" href="#清理缓存（释放磁盘空间）">¶</a>清理缓存（释放磁盘空间）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt clean  <span class="comment"># 删除所有下载的 .deb 包缓存（在 /var/cache/apt/archives/）</span></span><br><span class="line">sudo apt autoclean  <span class="comment"># 只删除过时的包缓存</span></span><br><span class="line">sudo apt autoremove  <span class="comment"># 删除不再需要的依赖包</span></span><br></pre></td></tr></table></figure><p><strong>组合使用</strong>（清理磁盘空间）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt autoremove &amp;&amp; sudo apt autoclean</span><br></pre></td></tr></table></figure><hr><h1>RHEL/CentOS 包管理：yum/dnf + rpm</h1><h2 id="yum-vs-dnf-vs-rpm"><a class="header-anchor" href="#yum-vs-dnf-vs-rpm">¶</a>yum vs dnf vs rpm</h2><table><thead><tr><th>工具</th><th>说明</th><th>推荐度</th></tr></thead><tbody><tr><td><strong>dnf</strong></td><td>新一代高层工具（CentOS 8+、Fedora），自动处理依赖，速度更快，推荐使用</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>yum</strong></td><td>老版高层工具（CentOS 7 及更早），功能同 dnf 但较慢</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>rpm</strong></td><td>底层工具，直接操作 .rpm 包，<strong>不会自动处理依赖</strong>（需要手动解决）</td><td>⭐⭐</td></tr></tbody></table><p><strong>推荐</strong>：CentOS 8+ 和 Fedora 用 <code>dnf</code>，CentOS 7 用 <code>yum</code>。</p><h2 id="常用操作（以-dnf-为例，yum-命令几乎一样）"><a class="header-anchor" href="#常用操作（以-dnf-为例，yum-命令几乎一样）">¶</a>常用操作（以 dnf 为例，yum 命令几乎一样）</h2><h3 id="更新软件源信息-v2"><a class="header-anchor" href="#更新软件源信息-v2">¶</a>更新软件源信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf makecache  <span class="comment"># 从软件源下载最新的包列表</span></span><br><span class="line">sudo dnf check-update  <span class="comment"># 检查有哪些包可以升级</span></span><br></pre></td></tr></table></figure><h3 id="搜索软件包-v2"><a class="header-anchor" href="#搜索软件包-v2">¶</a>搜索软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf search nginx  <span class="comment"># 搜索包含 nginx 的包</span></span><br></pre></td></tr></table></figure><h3 id="查看包信息-v2"><a class="header-anchor" href="#查看包信息-v2">¶</a>查看包信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf info nginx  <span class="comment"># 查看 nginx 的详细信息（版本、依赖、描述）</span></span><br></pre></td></tr></table></figure><h3 id="安装软件包-v2"><a class="header-anchor" href="#安装软件包-v2">¶</a>安装软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install nginx  <span class="comment"># 安装 nginx</span></span><br><span class="line">sudo dnf install nginx-1.20.1  <span class="comment"># 安装指定版本</span></span><br><span class="line">sudo dnf install nginx -y  <span class="comment"># 自动回答 yes</span></span><br></pre></td></tr></table></figure><h3 id="卸载软件包-v2"><a class="header-anchor" href="#卸载软件包-v2">¶</a>卸载软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf remove nginx  <span class="comment"># 卸载 nginx</span></span><br><span class="line">sudo dnf autoremove  <span class="comment"># 删除不再需要的依赖包</span></span><br></pre></td></tr></table></figure><h3 id="升级软件包-v2"><a class="header-anchor" href="#升级软件包-v2">¶</a>升级软件包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf upgrade  <span class="comment"># 升级所有可升级的包</span></span><br><span class="line">sudo dnf upgrade nginx  <span class="comment"># 只升级 nginx</span></span><br></pre></td></tr></table></figure><h3 id="查看已安装的包-v2"><a class="header-anchor" href="#查看已安装的包-v2">¶</a>查看已安装的包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa  <span class="comment"># 列出所有已安装的包</span></span><br><span class="line">rpm -qa | grep nginx  <span class="comment"># 查看 nginx 是否已安装</span></span><br><span class="line">dnf list installed  <span class="comment"># 同上（dnf 命令）</span></span><br></pre></td></tr></table></figure><h3 id="查看包安装的文件-v2"><a class="header-anchor" href="#查看包安装的文件-v2">¶</a>查看包安装的文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql nginx  <span class="comment"># 查看 nginx 安装了哪些文件</span></span><br></pre></td></tr></table></figure><h3 id="查看文件属于哪个包-v2"><a class="header-anchor" href="#查看文件属于哪个包-v2">¶</a>查看文件属于哪个包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qf /usr/sbin/nginx  <span class="comment"># 查看 /usr/sbin/nginx 属于哪个包</span></span><br></pre></td></tr></table></figure><h3 id="手动安装-rpm-包"><a class="header-anchor" href="#手动安装-rpm-包">¶</a>手动安装 .rpm 包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -ivh package.rpm  <span class="comment"># 安装 .rpm 包（不会自动解决依赖）</span></span><br><span class="line">sudo dnf install package.rpm  <span class="comment"># 更好的方式（会自动解决依赖）</span></span><br></pre></td></tr></table></figure><h2 id="rpm-的常用操作"><a class="header-anchor" href="#rpm-的常用操作">¶</a>rpm 的常用操作</h2><h3 id="查询包信息"><a class="header-anchor" href="#查询包信息">¶</a>查询包信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa  <span class="comment"># 列出所有已安装的包</span></span><br><span class="line">rpm -qa | grep nginx  <span class="comment"># 查看 nginx 是否已安装</span></span><br><span class="line">rpm -qi nginx  <span class="comment"># 查看包的详细信息</span></span><br><span class="line">rpm -ql nginx  <span class="comment"># 查看包安装了哪些文件</span></span><br><span class="line">rpm -qf /usr/sbin/nginx  <span class="comment"># 查看文件属于哪个包</span></span><br><span class="line">rpm -qc nginx  <span class="comment"># 查看包的配置文件</span></span><br><span class="line">rpm -qd nginx  <span class="comment"># 查看包的文档文件</span></span><br></pre></td></tr></table></figure><h3 id="验证包完整性"><a class="header-anchor" href="#验证包完整性">¶</a>验证包完整性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -V nginx  <span class="comment"># 验证包的文件是否被修改</span></span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">S.5....T.  c /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><ul><li><code>S</code>：文件大小改变</li><li><code>5</code>：MD5 校验和改变</li><li><code>T</code>：修改时间改变</li><li><code>c</code>：配置文件</li></ul><h2 id="高级用法-v3"><a class="header-anchor" href="#高级用法-v3">¶</a>高级用法</h2><h3 id="锁定包版本（防止升级）-v2"><a class="header-anchor" href="#锁定包版本（防止升级）-v2">¶</a>锁定包版本（防止升级）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install <span class="string">&#x27;dnf-command(versionlock)&#x27;</span>  <span class="comment"># 安装 versionlock 插件</span></span><br><span class="line">sudo dnf versionlock add nginx  <span class="comment"># 锁定 nginx</span></span><br><span class="line">dnf versionlock list  <span class="comment"># 查看被锁定的包</span></span><br><span class="line">sudo dnf versionlock delete nginx  <span class="comment"># 解锁</span></span><br></pre></td></tr></table></figure><h3 id="降级包版本-v2"><a class="header-anchor" href="#降级包版本-v2">¶</a>降级包版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 查看可用版本</span></span><br><span class="line">dnf list --showduplicates nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 降级到指定版本</span></span><br><span class="line">sudo dnf downgrade nginx-1.18.0</span><br></pre></td></tr></table></figure><h3 id="清理缓存"><a class="header-anchor" href="#清理缓存">¶</a>清理缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf clean all  <span class="comment"># 删除所有缓存</span></span><br><span class="line">sudo dnf autoremove  <span class="comment"># 删除不再需要的依赖包</span></span><br></pre></td></tr></table></figure><hr><h1>配置国内镜像源（加速下载）</h1><h2 id="Debian-Ubuntu-配置阿里云源"><a class="header-anchor" href="#Debian-Ubuntu-配置阿里云源">¶</a>Debian/Ubuntu 配置阿里云源</h2><h3 id="1-备份原始源"><a class="header-anchor" href="#1-备份原始源">¶</a>1. 备份原始源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></table></figure><h3 id="2-替换为阿里云源"><a class="header-anchor" href="#2-替换为阿里云源">¶</a>2. 替换为阿里云源</h3><p><strong>方法 1：自动替换</strong>（推荐）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*archive.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*security.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p><strong>方法 2：手动编辑</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>删除原内容，替换为（以 Ubuntu 22.04 为例）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><p><strong>版本代号</strong>：</p><ul><li>Ubuntu 22.04: <code>jammy</code></li><li>Ubuntu 20.04: <code>focal</code></li><li>Ubuntu 18.04: <code>bionic</code></li></ul><h3 id="3-更新软件源"><a class="header-anchor" href="#3-更新软件源">¶</a>3. 更新软件源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br></pre></td></tr></table></figure><h3 id="4-验证是否生效"><a class="header-anchor" href="#4-验证是否生效">¶</a>4. 验证是否生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/apt/sources.list | grep mirrors.aliyun.com</span><br></pre></td></tr></table></figure><p>如果看到 <code>mirrors.aliyun.com</code>，说明配置成功。</p><h2 id="CentOS-RHEL-配置阿里云源"><a class="header-anchor" href="#CentOS-RHEL-配置阿里云源">¶</a>CentOS/RHEL 配置阿里云源</h2><h3 id="1-备份原始源-v2"><a class="header-anchor" href="#1-备份原始源-v2">¶</a>1. 备份原始源</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</span><br></pre></td></tr></table></figure><h3 id="2-下载阿里云源配置"><a class="header-anchor" href="#2-下载阿里云源配置">¶</a>2. 下载阿里云源配置</h3><p><strong>CentOS 7</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure><p><strong>CentOS 8</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br></pre></td></tr></table></figure><h3 id="3-清理并更新缓存"><a class="header-anchor" href="#3-清理并更新缓存">¶</a>3. 清理并更新缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf clean all</span><br><span class="line">sudo dnf makecache</span><br></pre></td></tr></table></figure><h3 id="4-验证是否生效-v2"><a class="header-anchor" href="#4-验证是否生效-v2">¶</a>4. 验证是否生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf repolist</span><br></pre></td></tr></table></figure><p>如果看到 <code>mirrors.aliyun.com</code>，说明配置成功。</p><h2 id="其他国内镜像源"><a class="header-anchor" href="#其他国内镜像源">¶</a>其他国内镜像源</h2><ul><li><strong>清华大学源</strong>：<a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/">https://mirrors.tuna.tsinghua.edu.cn/<i class="fas fa-external-link-alt"></i></a></li><li><strong>中科大源</strong>：<a class="link" href="https://mirrors.ustc.edu.cn/">https://mirrors.ustc.edu.cn/<i class="fas fa-external-link-alt"></i></a></li><li><strong>网易源</strong>：<a class="link" href="http://mirrors.163.com/">http://mirrors.163.com/<i class="fas fa-external-link-alt"></i></a></li></ul><p><strong>配置方法类似，只需把 URL 换成对应的镜像站即可。</strong></p><hr><h1>源码编译安装：从 configure 到 make install</h1><p>有时候软件源里的版本太旧、或者你需要自定义编译选项（如开启某个模块、优化性能），就需要从源码编译安装。</p><h2 id="编译安装的三步曲"><a class="header-anchor" href="#编译安装的三步曲">¶</a>编译安装的三步曲</h2><ol><li><strong><code>./configure</code></strong>：检查系统环境、生成 Makefile</li><li><strong><code>make</code></strong>：根据 Makefile 编译源代码</li><li><strong><code>make install</code></strong>：把编译好的文件安装到系统</li></ol><h2 id="实战：编译安装-Nginx（Tengine）"><a class="header-anchor" href="#实战：编译安装-Nginx（Tengine）">¶</a>实战：编译安装 Nginx（Tengine）</h2><p><strong>Tengine</strong> 是淘宝开发的 Nginx 分支，增强了性能和功能。</p><h3 id="1-安装编译依赖"><a class="header-anchor" href="#1-安装编译依赖">¶</a>1. 安装编译依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential libpcre3 libpcre3-dev libssl-dev zlib1g-dev  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf install gcc make pcre-devel openssl-devel zlib-devel  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h3 id="2-下载源码"><a class="header-anchor" href="#2-下载源码">¶</a>2. 下载源码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://tengine.taobao.org/download/tengine-2.3.3.tar.gz</span><br><span class="line">tar -zxvf tengine-2.3.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> tengine-2.3.3</span><br></pre></td></tr></table></figure><h3 id="3-配置编译参数（-configure）"><a class="header-anchor" href="#3-配置编译参数（-configure）">¶</a>3. 配置编译参数（<code>./configure</code>）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">  --prefix=/usr/local/nginx \</span><br><span class="line">  --with-http_ssl_module \</span><br><span class="line">  --with-http_v2_module \</span><br><span class="line">  --with-http_realip_module \</span><br><span class="line">  --with-http_gzip_static_module</span><br></pre></td></tr></table></figure><p><strong>常用参数</strong>：</p><ul><li><code>--prefix=PATH</code>：安装路径（默认 <code>/usr/local/nginx</code>）</li><li><code>--with-http_ssl_module</code>：启用 HTTPS 支持</li><li><code>--with-http_v2_module</code>：启用 HTTP/2 支持</li><li><code>--with-http_realip_module</code>：获取真实客户端 IP（适用于反向代理）</li></ul><p><strong><code>./configure</code> 干了什么？</strong></p><ul><li>检查系统是否有必需的库（如 OpenSSL、PCRE、zlib）</li><li>根据你的参数生成 <code>Makefile</code>（编译配置文件）</li><li>如果缺少依赖，会报错并提示安装</li></ul><h3 id="4-编译（make）"><a class="header-anchor" href="#4-编译（make）">¶</a>4. 编译（<code>make</code>）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j$(<span class="built_in">nproc</span>)  <span class="comment"># 使用所有 CPU 核心并行编译（加速）</span></span><br></pre></td></tr></table></figure><p><strong><code>make</code> 干了什么？</strong></p><ul><li>读取 <code>Makefile</code>，按顺序编译源代码</li><li>生成可执行文件（如 <code>objs/nginx</code>）</li><li>如果编译失败，检查是否缺少依赖或参数错误</li></ul><h3 id="5-安装（make-install）"><a class="header-anchor" href="#5-安装（make-install）">¶</a>5. 安装（<code>make install</code>）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p><strong><code>make install</code> 干了什么？</strong></p><ul><li>把编译好的文件复制到 <code>--prefix</code> 指定的目录（如 <code>/usr/local/nginx</code>）</li><li>创建必要的目录结构（<code>conf/</code>、<code>logs/</code>、<code>html/</code>、<code>sbin/</code>）</li><li>不会创建 systemd service 文件（需要手动创建）</li></ul><h3 id="6-启动-Nginx"><a class="header-anchor" href="#6-启动-Nginx">¶</a>6. 启动 Nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx  <span class="comment"># 启动</span></span><br><span class="line">/usr/local/nginx/sbin/nginx -s stop  <span class="comment"># 停止</span></span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload  <span class="comment"># 重新加载配置</span></span><br></pre></td></tr></table></figure><h3 id="7-创建-systemd-service（可选）"><a class="header-anchor" href="#7-创建-systemd-service（可选）">¶</a>7. 创建 systemd service（可选）</h3><p>创建 <code>/etc/systemd/system/nginx.service</code>：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Nginx HTTP Server</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="attr">ExecReload</span>=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><p>然后启用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">sudo systemctl start nginx</span><br></pre></td></tr></table></figure><hr><h1>二进制免安装配置：以 Java 为例</h1><p>有些软件（如 Java、Go、Node.js）提供预编译的二进制包，解压即用，不需要安装。</p><h2 id="实战：配置-Java-环境"><a class="header-anchor" href="#实战：配置-Java-环境">¶</a>实战：配置 Java 环境</h2><h3 id="1-下载-JDK"><a class="header-anchor" href="#1-下载-JDK">¶</a>1. 下载 JDK</h3><p>从 Oracle 官网或开源镜像下载 JDK（如 <code>jdk-17_linux-x64_bin.tar.gz</code>）。</p><h3 id="2-解压到-opt"><a class="header-anchor" href="#2-解压到-opt">¶</a>2. 解压到 <code>/opt</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf jdk-17_linux-x64_bin.tar.gz -C /opt</span><br><span class="line">sudo <span class="built_in">mv</span> /opt/jdk-17* /opt/jdk-17  <span class="comment"># 重命名为简短路径</span></span><br></pre></td></tr></table></figure><h3 id="3-配置环境变量"><a class="header-anchor" href="#3-配置环境变量">¶</a>3. 配置环境变量</h3><p>编辑 <code>~/.bashrc</code>（或 <code>/etc/profile</code> 对所有用户生效）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/jdk-17</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><h3 id="4-使配置生效"><a class="header-anchor" href="#4-使配置生效">¶</a>4. 使配置生效</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="5-验证"><a class="header-anchor" href="#5-验证">¶</a>5. 验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br><span class="line">javac -version</span><br></pre></td></tr></table></figure><p>如果显示版本号，说明配置成功。</p><hr><h1>包管理最佳实践</h1><h2 id="1-定期更新系统"><a class="header-anchor" href="#1-定期更新系统">¶</a>1. 定期更新系统</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf upgrade -y  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><p><strong>频率</strong>：建议每周或每月更新一次，及时修复安全漏洞。</p><h2 id="2-清理无用包和缓存"><a class="header-anchor" href="#2-清理无用包和缓存">¶</a>2. 清理无用包和缓存</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt autoremove &amp;&amp; sudo apt autoclean  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf autoremove &amp;&amp; sudo dnf clean all  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><p><strong>磁盘空间不足时的排查</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看哪个目录占用最大</span></span><br><span class="line"><span class="built_in">du</span> -sh /* 2&gt;/dev/null | <span class="built_in">sort</span> -hr | <span class="built_in">head</span> -10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看包缓存占用</span></span><br><span class="line"><span class="built_in">du</span> -sh /var/cache/apt/archives  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line"><span class="built_in">du</span> -sh /var/cache/dnf  <span class="comment"># CentOS/RHEL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理后再检查</span></span><br><span class="line">sudo apt clean &amp;&amp; <span class="built_in">du</span> -sh /var/cache/apt/archives</span><br></pre></td></tr></table></figure><h2 id="3-锁定关键软件版本"><a class="header-anchor" href="#3-锁定关键软件版本">¶</a>3. 锁定关键软件版本</h2><p>如果某个软件升级后可能导致兼容性问题（如数据库、内核），建议锁定版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-mark hold mysql-server  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf versionlock add mysql-server  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h2 id="4-不要混用包管理器和编译安装"><a class="header-anchor" href="#4-不要混用包管理器和编译安装">¶</a>4. 不要混用包管理器和编译安装</h2><p><strong>问题</strong>：如果你用 apt 装了 nginx，又用源码编译装了 nginx，会导致冲突（两个 nginx 可能监听同一个端口、配置文件位置不同）。</p><p><strong>建议</strong>：</p><ul><li>优先用包管理器（apt/dnf）安装（方便更新和卸载）</li><li>只有在包管理器的版本太旧或缺少功能时，才编译安装</li><li>如果编译安装，建议装到 <code>/opt</code> 或 <code>/usr/local</code>（不要和包管理器的路径冲突）</li></ul><h2 id="5-备份重要配置"><a class="header-anchor" href="#5-备份重要配置">¶</a>5. 备份重要配置</h2><p>修改配置文件前先备份：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak</span><br></pre></td></tr></table></figure><h2 id="6-使用虚拟环境（Python-Node-js）"><a class="header-anchor" href="#6-使用虚拟环境（Python-Node-js）">¶</a>6. 使用虚拟环境（Python/Node.js）</h2><p>Python 和 Node.js 有自己的包管理器（pip/npm），建议使用虚拟环境隔离项目依赖：</p><ul><li><strong>Python</strong>：<code>python3 -m venv venv</code></li><li><strong>Node.js</strong>：<code>nvm</code> 或 <code>n</code> 管理 Node.js 版本</li></ul><hr><h1>总结与扩展阅读</h1><p>这篇文章涵盖了 Linux 软件包管理的核心内容：</p><ol><li>✅ 软件包的基本概念（包里有什么、为什么需要包管理器）</li><li>✅ Debian/Ubuntu 包管理（apt/dpkg 常用操作和高级用法）</li><li>✅ RHEL/CentOS 包管理（yum/dnf/rpm 常用操作和高级用法）</li><li>✅ 配置国内镜像源（阿里云源、清华源）</li><li>✅ 源码编译安装（以 Nginx 为例，讲清楚 configure/make/make install）</li><li>✅ 二进制免安装配置（以 Java 为例）</li><li>✅ 包管理最佳实践（清理、锁定版本、避免冲突）</li></ol><p><strong>扩展阅读</strong>：</p><ul><li>Debian 包管理手册：<a class="link" href="https://www.debian.org/doc/manuals/debian-reference/ch02">https://www.debian.org/doc/manuals/debian-reference/ch02<i class="fas fa-external-link-alt"></i></a></li><li>RPM 包管理手册：<a class="link" href="https://rpm-packaging-guide.github.io/">https://rpm-packaging-guide.github.io/<i class="fas fa-external-link-alt"></i></a></li><li>DNF 官方文档：<a class="link" href="https://dnf.readthedocs.io/">https://dnf.readthedocs.io/<i class="fas fa-external-link-alt"></i></a></li></ul><p><strong>下一步</strong>：</p><ul><li><strong>《Linux 进程与资源管理》</strong>：学习如何监控和限制进程的 CPU/内存使用</li><li><strong>《Linux 用户管理》</strong>：学习如何管理用户/组/权限</li></ul><hr><p><strong>到这里，你应该已经从&quot;会装包&quot;升级到&quot;能配置源、能编译安装、能排查依赖冲突&quot;。包管理是 Linux 日常运维的基础技能，掌握了它，你就能更好地管理服务器。</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;软件包管理看起来只是&amp;quot;装/卸/更新&amp;quot;，但真正决定你是否少踩坑的，是两件事：第一，包里到底包含了什么（可执行文件、配置、依赖库、服务脚本），以及它们分别落在系统的哪些位置；第二，发行版的工具链差异（Debian/Ubuntu 的 &lt;code&gt;dpkg/apt&lt;/code&gt; vs RHEL/CentOS 的 &lt;code&gt;rpm/yum/dnf&lt;/code&gt;）会如何影响依赖解析、版本选择与回滚策略。本文先把软件包与依赖的基本概念讲清楚，再给出一套可复现的常用操作清单（包括高级用法：依赖冲突排查、版本锁定、降级、清理无用包），并补上国内环境最常见的配置（例如替换阿里云源、清华源、验证源是否生效）。最后把&amp;quot;装包&amp;quot;延伸到更贴近生产的两条路径：源码编译（以 Nginx 为例，讲清楚 configure/make/make install 分别干了什么）与二进制免安装配置（以 Java 为例），让你在遇到版本/依赖/网络限制时有可选的落地方案。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 进程与资源管理</title>
    <link href="https://chenk.top/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-29T16:22:58.050Z</updated>
    
    <content type="html"><![CDATA[<p>线上排障时，最关键的能力不是&quot;会背命令&quot;，而是能把现象快速映射到资源与进程：CPU 是不是被打满、内存是不是被 cache 吃掉、磁盘 I/O 在不在等、到底是哪一个进程/文件/端口在拖慢系统。本文从进程/线程与父子关系的基本概念出发，解释 Linux 的资源视角（尤其是 buffer/cache 的含义与&quot;内存不够用&quot;的误判），然后系统梳理一套常用监控与定位工具链（<code>top/htop/ps/pstree/lsof</code>、端口/网络、I/O、负载与压力测试）。接着补齐&quot;把进程控住&quot;的操作：信号与后台任务、<code>nice/renice</code> 优先级、孤儿/僵尸进程的成因与处理；最后用一个完整的排障案例（Nginx 日志文件被误删怎么办）把&quot;资源视角&quot;落到实战层面，方便你把一次完整排障流程跑通。如果你是运维人员或需要排查性能问题，这篇文章会让你从&quot;会看 top&quot;升级到&quot;能快速定位资源瓶颈、能优化进程优先级、能处理异常进程状态&quot;。</p><span id="more"></span><h1>进程与程序的基本概念</h1><h2 id="进程-vs-程序-vs-线程"><a class="header-anchor" href="#进程-vs-程序-vs-线程">¶</a>进程 vs 程序 vs 线程</h2><p>这三个概念经常混淆，但理解它们的区别对理解 Linux 系统很重要：</p><table><thead><tr><th>概念</th><th>定义</th><th>比喻</th></tr></thead><tbody><tr><td><strong>程序</strong></td><td>存储在硬盘上的静态可执行文件（如 <code>/usr/bin/vim</code>）</td><td>建筑设计图纸</td></tr><tr><td><strong>进程</strong></td><td>程序加载到内存后运行的实例（有 PID、内存空间、打开的文件）</td><td>正在施工的建筑工地（包工头）</td></tr><tr><td><strong>线程</strong></td><td>进程内的执行单元（共享进程的内存空间，但有独立的执行流程）</td><td>工地上干活的工人</td></tr></tbody></table><p><strong>示例</strong>：</p><ul><li>当你运行 <code>vim myfile.txt</code> 时，<code>vim</code> 程序从硬盘加载到内存，产生一个进程，该进程负责编辑 <code>myfile.txt</code>。</li><li>同一个程序可以同时启动多个进程，例如浏览器中打开多个标签页时，每个标签页可能对应一个独立的进程（或多个线程）。</li><li>一个进程可以包含多个线程，例如网易云音乐进程可能包含两个线程：一个下载音乐，一个播放音乐。</li></ul><p><strong>为什么要有线程？</strong></p><ul><li>线程比进程更轻量（创建和销毁开销小）</li><li>线程共享进程的内存空间（通信方便）</li><li>多线程可以充分利用多核 CPU（并行计算）</li></ul><h2 id="进程的五大特性"><a class="header-anchor" href="#进程的五大特性">¶</a>进程的五大特性</h2><ol><li><strong>独立性</strong>：每个进程都有自己的内存空间和系统资源，彼此隔离（进程 A 的变量不会影响进程 B）</li><li><strong>并发性</strong>：操作系统允许多个进程同时运行，通过多任务调度实现并发处理</li><li><strong>动态性</strong>：进程不断创建、执行、终止，状态实时变化（操作系统的运行就是不断创建和销毁进程）</li><li><strong>父子关系</strong>：进程由父进程通过 <code>fork()</code> 调用创建，形成父子结构（PPID 字段指明父进程）</li><li><strong>调度性</strong>：操作系统使用调度算法（如时间片轮转、优先级调度）决定进程执行顺序</li></ol><h2 id="进程的父子关系（PID-和-PPID）"><a class="header-anchor" href="#进程的父子关系（PID-和-PPID）">¶</a>进程的父子关系（PID 和 PPID）</h2><p>每个进程都有两个重要的 ID：</p><ul><li><strong>PID</strong>（Process ID）：进程 ID，唯一标识一个进程</li><li><strong>PPID</strong>（Parent Process ID）：父进程 ID，标识创建这个进程的父进程</li></ul><p><strong>示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep bash</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UID   PID  PPID  C STIME TTY      TIME CMD</span><br><span class="line">root  1234 1     0 12:00 ?        00:00:00 /bin/bash /usr/local/bin/startup.sh</span><br><span class="line">user  5678 1234  0 12:05 pts/0    00:00:00 bash</span><br></pre></td></tr></table></figure><ul><li>PID 5678 的进程是 <code>bash</code>，它的 PPID 是 1234（父进程是 <code>/bin/bash /usr/local/bin/startup.sh</code>）</li><li>所有进程最终都能追溯到 PID 1（systemd 或 init）</li></ul><p><strong>查看进程树</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree -p  <span class="comment"># 以树状结构显示进程父子关系（-p 显示 PID）</span></span><br></pre></td></tr></table></figure><hr><h1>Linux 资源管理概述：CPU/内存/磁盘/网络</h1><p>运维工作围绕硬件和软件资源展开，合理管理这些资源可确保系统高效稳定运行。</p><h2 id="硬件资源的四大类"><a class="header-anchor" href="#硬件资源的四大类">¶</a>硬件资源的四大类</h2><h3 id="1-CPU-资源"><a class="header-anchor" href="#1-CPU-资源">¶</a>1. CPU 资源</h3><ul><li><strong>核心数</strong>：现代 CPU 通常是多核（如 4 核、8 核、16 核）</li><li><strong>负载</strong>：等待执行的进程数（load average）</li><li><strong>占用率</strong>：进程对 CPU 的占用百分比</li></ul><p><strong>查看 CPU 核心数</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lscpu | grep <span class="string">&#x27;^CPU(s)&#x27;</span>  <span class="comment"># 输出：CPU(s): 4</span></span><br><span class="line"><span class="built_in">nproc</span>  <span class="comment"># 输出核心数：4</span></span><br></pre></td></tr></table></figure><p><strong>查看 CPU 负载</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uptime</span>  <span class="comment"># 输出：06:56:12 up 12 days, 3:45, 3 users, load average: 0.22, 0.45, 0.56</span></span><br></pre></td></tr></table></figure><p><strong>load average 解读</strong>（以 4 核 CPU 为例）：</p><ul><li><code>load average: 0.22, 0.45, 0.56</code>：分别是 1 分钟、5 分钟、15 分钟的平均负载</li><li>负载值 &lt; 核心数（如 4 核时 load &lt; 4）：系统空闲</li><li>负载值 = 核心数（如 4 核时 load = 4）：系统满载</li><li>负载值 &gt; 核心数（如 4 核时 load &gt; 4）：系统过载（有进程在等待 CPU）</li></ul><p>**负载高但 CPU 使用率低？**这通常表示进程在等待 I/O（磁盘读写、网络等），不是 CPU 瓶颈。</p><h3 id="2-内存资源"><a class="header-anchor" href="#2-内存资源">¶</a>2. 内存资源</h3><ul><li><strong>总内存</strong>（Total）：物理内存总量</li><li><strong>已用内存</strong>（Used）：已分配的内存</li><li><strong>可用内存</strong>（Available）：实际可用的内存（包括可回收的 buffer/cache）</li><li><strong>Swap</strong>：交换空间（硬盘上的虚拟内存，速度慢）</li></ul><p><strong>查看内存使用</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -h  <span class="comment"># -h 人性化显示（MB/GB）</span></span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           15Gi       2.5Gi       8.0Gi       100Mi       4.5Gi        12Gi</span><br><span class="line">Swap:         2.0Gi          0B       2.0Gi</span><br></pre></td></tr></table></figure><p><strong>重要概念：buffer 和 cache</strong>（下一节详细讲）</p><h3 id="3-磁盘资源"><a class="header-anchor" href="#3-磁盘资源">¶</a>3. 磁盘资源</h3><ul><li><strong>容量</strong>：硬盘或 SSD 提供的总存储空间</li><li><strong>读写性能</strong>：<ul><li><strong>机械硬盘（HDD）</strong>：容量大、价格低、速度慢（100-200 MB/s）</li><li><strong>固态硬盘（SSD）</strong>：速度快、价格高、容量相对小（500-3000 MB/s）</li><li><strong>NVMe SSD</strong>：更快（3000-7000 MB/s）</li></ul></li></ul><p><strong>查看磁盘使用</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h  <span class="comment"># 查看分区使用情况</span></span><br><span class="line">lsblk  <span class="comment"># 列出块设备及挂载点</span></span><br><span class="line"><span class="built_in">du</span> -sh /*  <span class="comment"># 查看根目录下各目录占用空间</span></span><br></pre></td></tr></table></figure><p><strong>查看磁盘 I/O</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iostat -x 1  <span class="comment"># 每秒刷新一次（需要 sysstat 包）</span></span><br><span class="line">iotop  <span class="comment"># 实时查看各进程的磁盘 I/O（需要 root 权限）</span></span><br></pre></td></tr></table></figure><h3 id="4-网络资源"><a class="header-anchor" href="#4-网络资源">¶</a>4. 网络资源</h3><ul><li><strong>带宽</strong>：网络接口的最大传输速率（如 1 Gbps、10 Gbps）</li><li><strong>吞吐量</strong>：实际传输速率</li><li><strong>延迟</strong>：数据包往返时间（RTT）</li></ul><p><strong>查看网络流量</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iftop -i eth0  <span class="comment"># 实时显示网络流量（需要安装 iftop）</span></span><br><span class="line">ip -s <span class="built_in">link</span>  <span class="comment"># 查看接口统计信息（收发包数、丢包数）</span></span><br></pre></td></tr></table></figure><p><strong>查看网络连接</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp  <span class="comment"># 查看监听的端口和连接（替代 netstat）</span></span><br><span class="line">lsof -i :80  <span class="comment"># 查看 80 端口被哪个进程占用</span></span><br></pre></td></tr></table></figure><hr><h1>Buffer 和 Cache 详解：为什么&quot;内存不够用&quot;经常是误判</h1><p>Linux 的内存管理很激进：<strong>尽可能多地使用内存来缓存数据，提高性能</strong>。所以你会发现 <code>free</code> 显示的 <code>free</code> 很小，但这<strong>不代表内存不够用</strong>。</p><h2 id="Buffer-vs-Cache"><a class="header-anchor" href="#Buffer-vs-Cache">¶</a>Buffer vs Cache</h2><table><thead><tr><th>类型</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><strong>Buffer</strong></td><td>写入数据时的缓冲区（数据从内存写入磁盘前的临时存储）</td><td>写文件时，数据先存在 buffer，批量写入磁盘</td></tr><tr><td><strong>Cache</strong></td><td>读取数据时的缓存（从磁盘读取的数据缓存在内存，下次直接从内存读）</td><td>读文件时，内容缓存在 cache，下次秒读</td></tr></tbody></table><p><strong>为什么要这么设计？</strong></p><ul><li><strong>Buffer</strong>：减少磁盘写入次数。如果每次写入都直接写磁盘，太慢了（尤其是大量零碎文件）。先攒一批数据，再一次性写入磁盘，快很多。</li><li><strong>Cache</strong>：减少磁盘读取次数。频繁访问的文件缓存在内存里，读取速度快几百倍。</li></ul><p><strong>重要</strong>：<strong>Buffer 和 Cache 是可回收的</strong>。当程序需要更多内存时，内核会自动释放 buffer/cache 给程序用。所以你看到 <code>free</code> 显示的 <code>available</code> 才是真正可用的内存（包括可回收的 buffer/cache）。</p><p><strong>误判示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           15Gi       2.5Gi       1.0Gi       100Mi      11.5Gi        12Gi</span><br></pre></td></tr></table></figure><p>新手看到 <code>free</code> 只有 1.0Gi，会觉得内存不够用了。但实际 <code>available</code> 有 12Gi（因为 11.5Gi 的 buff/cache 是可回收的）。</p><p><strong>什么时候内存真的不够用？</strong></p><ul><li><code>available</code> 接近 0</li><li>Swap 使用率很高（说明内存不够，开始用硬盘当内存）</li><li>进程被 OOM killer 杀掉（内核的内存不足杀手）</li></ul><hr><h1>进程监控工具链：从整体到细节</h1><h2 id="1-top：实时监控的-万能工具"><a class="header-anchor" href="#1-top：实时监控的-万能工具">¶</a>1. top：实时监控的&quot;万能工具&quot;</h2><p><code>top</code> 是最常用的实时监控工具，显示 CPU、内存、进程等信息。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top</span><br></pre></td></tr></table></figure><p><strong>界面解读</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">top - 12:00:00 up 10 days,  3:45,  2 users,  load average: 1.23, 0.87, 0.45</span><br><span class="line">Tasks: 150 total,   2 running, 148 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  5.2 us,  2.1 sy,  0.0 ni, 92.3 id,  0.3 wa,  0.0 hi,  0.1 si,  0.0 st</span><br><span class="line">MiB Mem :  15872.0 total,   8234.5 free,   3456.2 used,   4181.3 buff/cache</span><br><span class="line">MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.  11234.5 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line"> 1234 root      20   0  123456  12345   1234 R  50.0   0.8   1:23.45 python3</span><br><span class="line"> 5678 www-data  20   0  234567  23456   2345 S  10.0   1.5   0:12.34 nginx</span><br></pre></td></tr></table></figure><p><strong>关键指标</strong>：</p><ul><li><strong>load average</strong>：1/5/15 分钟的平均负载（接近 CPU 核心数说明系统满载）</li><li><strong>Tasks</strong>：总进程数、运行/睡眠/停止/僵尸进程数</li><li><strong>%Cpu(s)</strong>：<ul><li><code>us</code>（user）：用户空间 CPU 占用</li><li><code>sy</code>（system）：内核空间 CPU 占用</li><li><code>ni</code>（nice）：低优先级进程 CPU 占用</li><li><code>id</code>（idle）：空闲 CPU（越高越好）</li><li><code>wa</code>（wait）：等待 I/O 的 CPU 时间（高说明磁盘/网络慢）</li></ul></li><li><strong>Mem/Swap</strong>：内存和交换空间使用情况</li></ul><p><strong>常用快捷键</strong>：</p><ul><li><code>P</code>：按 CPU 占用排序</li><li><code>M</code>：按内存占用排序</li><li><code>k</code>：输入 PID 发送信号终止进程</li><li><code>1</code>：显示每个 CPU 核心的使用率</li><li><code>q</code>：退出</li></ul><h2 id="2-htop：top-的增强版"><a class="header-anchor" href="#2-htop：top-的增强版">¶</a>2. htop：top 的增强版</h2><p><code>htop</code> 是 <code>top</code> 的彩色增强版，支持鼠标操作、树状视图、直接终止进程。</p><p><strong>安装与使用</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install htop  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf install htop  <span class="comment"># CentOS/RHEL</span></span><br><span class="line">htop</span><br></pre></td></tr></table></figure><p><strong>优点</strong>：</p><ul><li>彩色界面，更直观</li><li>支持鼠标点击选择进程</li><li>显示进程树（F5 切换树状视图）</li><li>可以直接选择并终止进程（F9 发送信号）</li></ul><h2 id="3-ps：静态进程快照"><a class="header-anchor" href="#3-ps：静态进程快照">¶</a>3. ps：静态进程快照</h2><p><code>ps</code> 提供当前进程的静态快照（不像 top 那样实时刷新）。</p><p><strong>常用用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef  <span class="comment"># Unix 风格，显示所有进程（-e）的完整信息（-f）</span></span><br><span class="line">ps aux  <span class="comment"># BSD 风格，显示所有进程（a）的用户信息（u）和后台进程（x）</span></span><br></pre></td></tr></table></figure><p><strong>输出字段解释</strong>（<code>ps aux</code>）：</p><ul><li><strong>USER</strong>：进程所属用户</li><li><strong>PID</strong>：进程 ID</li><li><strong>%CPU</strong>：CPU 占用率</li><li><strong>%MEM</strong>：内存占用率</li><li><strong>VSZ</strong>：虚拟内存大小（进程申请的总内存）</li><li><strong>RSS</strong>：常驻内存大小（实际占用的物理内存）</li><li><strong>STAT</strong>：进程状态<ul><li><code>R</code>：运行中（Running）</li><li><code>S</code>：睡眠中（Sleeping，等待事件）</li><li><code>D</code>：不可中断睡眠（通常在等待磁盘 I/O）</li><li><code>Z</code>：僵尸进程（Zombie，已退出但未被父进程回收）</li><li><code>T</code>：停止（Stopped，通常被 Ctrl+Z 暂停）</li></ul></li><li><strong>TIME</strong>：进程累计 CPU 时间</li><li><strong>COMMAND</strong>：进程命令</li></ul><p><strong>高级用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx  <span class="comment"># 查看 nginx 相关的进程</span></span><br><span class="line">ps -ef | grep -v grep  <span class="comment"># 去掉 grep 自己的进程</span></span><br><span class="line">ps -eo pid,ppid,cmd,%cpu,%mem --<span class="built_in">sort</span>=-%cpu | <span class="built_in">head</span> -10  <span class="comment"># 按 CPU 占用排序，显示前 10</span></span><br></pre></td></tr></table></figure><h2 id="4-pstree：进程树"><a class="header-anchor" href="#4-pstree：进程树">¶</a>4. pstree：进程树</h2><p><code>pstree</code> 以树状结构展示进程父子关系，帮助理解进程层级。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pstree -p  <span class="comment"># -p 显示 PID</span></span><br><span class="line">pstree -ap  <span class="comment"># -a 显示命令参数</span></span><br></pre></td></tr></table></figure><h2 id="5-lsof：查看打开的文件"><a class="header-anchor" href="#5-lsof：查看打开的文件">¶</a>5. lsof：查看打开的文件</h2><p><code>lsof</code>（List Open Files）用于列出系统中所有打开的文件，包括常规文件、网络连接、设备等。</p><p><strong>为什么要用 lsof？</strong></p><ul><li>查看进程打开了哪些文件（如配置文件、日志文件、数据库文件）</li><li>查看端口被哪个进程占用（如 80 端口被谁占用）</li><li>查看文件被哪个进程占用（如某个文件删不掉，可能被进程占用）</li><li>恢复被误删的文件（如果进程还在运行，文件句柄还在，可以通过 <code>/proc/&lt;pid&gt;/fd/</code> 恢复）</li></ul><p><strong>常用用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lsof  <span class="comment"># 列出所有打开的文件（输出很长）</span></span><br><span class="line">lsof -p &lt;PID&gt;  <span class="comment"># 查看指定进程打开的文件</span></span><br><span class="line">lsof -u &lt;user&gt;  <span class="comment"># 查看指定用户打开的文件</span></span><br><span class="line">lsof -c &lt;<span class="built_in">command</span>&gt;  <span class="comment"># 查看指定命令打开的文件</span></span><br><span class="line">lsof -i :80  <span class="comment"># 查看 80 端口被哪个进程占用</span></span><br><span class="line">lsof -i tcp  <span class="comment"># 查看所有 TCP 连接</span></span><br><span class="line">lsof +D /var/log  <span class="comment"># 查看 /var/log 目录下被打开的文件</span></span><br><span class="line">lsof +L1  <span class="comment"># 查看链接数小于 1 的文件（通常是已删除但仍被进程占用的文件）</span></span><br></pre></td></tr></table></figure><p><strong>示例</strong>：查看 nginx 打开的所有文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -c nginx</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">COMMAND   PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx    1234     root  cwd    DIR    8,1     4096    2 /</span><br><span class="line">nginx    1234     root  txt    REG    8,1   123456  789 /usr/sbin/nginx</span><br><span class="line">nginx    1234     root    1w   REG    8,1    12345 1011 /var/log/nginx/access.log</span><br><span class="line">nginx    1234     root    2w   REG    8,1     6789 1012 /var/log/nginx/error.log</span><br><span class="line">nginx    1234     root    6u  IPv4  12345      0t0  TCP *:80 (LISTEN)</span><br></pre></td></tr></table></figure><ul><li><code>FD</code>：文件描述符（<code>cwd</code> 是当前目录，<code>txt</code> 是程序文件，<code>1w</code> 是 stdout，<code>2w</code> 是 stderr，<code>6u</code> 是打开的套接字）</li><li><code>TYPE</code>：类型（<code>DIR</code> 是目录，<code>REG</code> 是常规文件，<code>IPv4</code> 是网络套接字）</li></ul><h2 id="6-网络端口监控"><a class="header-anchor" href="#6-网络端口监控">¶</a>6. 网络端口监控</h2><h3 id="ss：查看网络连接（替代-netstat）"><a class="header-anchor" href="#ss：查看网络连接（替代-netstat）">¶</a>ss：查看网络连接（替代 netstat）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp  <span class="comment"># 查看监听的端口和连接</span></span><br></pre></td></tr></table></figure><ul><li><code>-t</code>：TCP 连接</li><li><code>-u</code>：UDP 连接</li><li><code>-l</code>：监听端口（LISTEN 状态）</li><li><code>-n</code>：显示数字形式的地址和端口（不解析主机名）</li><li><code>-p</code>：显示进程 PID 和名称</li></ul><p><strong>示例</strong>：查看 80 端口的监听情况</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp | grep :80</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp   LISTEN 0   128   *:80   *:*   users:((&quot;nginx&quot;,pid=1234,fd=6))</span><br></pre></td></tr></table></figure><h3 id="lsof：查看端口占用"><a class="header-anchor" href="#lsof：查看端口占用">¶</a>lsof：查看端口占用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsof -i :80  <span class="comment"># 查看 80 端口被哪个进程占用</span></span><br><span class="line">lsof -i tcp  <span class="comment"># 查看所有 TCP 连接</span></span><br></pre></td></tr></table></figure><h2 id="7-磁盘-I-O-监控"><a class="header-anchor" href="#7-磁盘-I-O-监控">¶</a>7. 磁盘 I/O 监控</h2><h3 id="iostat：磁盘-I-O-统计"><a class="header-anchor" href="#iostat：磁盘-I-O-统计">¶</a>iostat：磁盘 I/O 统计</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iostat -x 1  <span class="comment"># 每秒刷新一次，显示扩展信息</span></span><br></pre></td></tr></table></figure><p><strong>关键指标</strong>：</p><ul><li><strong>%util</strong>：磁盘使用率（接近 100% 说明磁盘很忙）</li><li><strong>await</strong>：平均等待时间（毫秒）</li><li><strong>r/s, w/s</strong>：每秒读写次数</li></ul><h3 id="iotop：实时查看进程磁盘-I-O"><a class="header-anchor" href="#iotop：实时查看进程磁盘-I-O">¶</a>iotop：实时查看进程磁盘 I/O</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iotop -o  <span class="comment"># -o 只显示有 I/O 的进程</span></span><br></pre></td></tr></table></figure><hr><h1>进程控制：信号、后台任务、优先级</h1><h2 id="1-kill：发送信号"><a class="header-anchor" href="#1-kill：发送信号">¶</a>1. kill：发送信号</h2><p><code>kill</code> 不只是&quot;杀进程&quot;，它的本质是<strong>向进程发送信号</strong>。</p><p><strong>常用信号</strong>：</p><table><thead><tr><th>信号编号</th><th>信号名称</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>1</td><td>SIGHUP</td><td>重新加载配置（不终止进程）</td><td><code>kill -1 &lt;PID&gt;</code></td></tr><tr><td>2</td><td>SIGINT</td><td>中断（等同于 Ctrl+C）</td><td><code>kill -2 &lt;PID&gt;</code></td></tr><tr><td>9</td><td>SIGKILL</td><td>强制终止（进程无法捕获，立即终止）</td><td><code>kill -9 &lt;PID&gt;</code></td></tr><tr><td>15</td><td>SIGTERM</td><td>温和终止（进程可以捕获，做清理后退出）</td><td><code>kill &lt;PID&gt;</code>（默认）</td></tr><tr><td>20</td><td>SIGTSTP</td><td>暂停（等同于 Ctrl+Z）</td><td><code>kill -20 &lt;PID&gt;</code></td></tr></tbody></table><p><strong>最佳实践</strong>：</p><ol><li>先用 <code>kill &lt;PID&gt;</code>（SIGTERM），让进程有机会做清理（如保存数据、关闭连接）</li><li>如果进程不响应，再用 <code>kill -9 &lt;PID&gt;</code>（SIGKILL）强制终止</li></ol><p><strong>示例</strong>：重新加载 nginx 配置（不停止服务）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">kill</span> -1 $(pidof nginx | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)  <span class="comment"># 发送 SIGHUP 信号</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">sudo nginx -s reload  <span class="comment"># nginx 提供的便捷命令</span></span><br></pre></td></tr></table></figure><h2 id="2-后台运行任务"><a class="header-anchor" href="#2-后台运行任务">¶</a>2. 后台运行任务</h2><h3 id="方法-1：使用"><a class="header-anchor" href="#方法-1：使用">¶</a>方法 1：使用 <code>&amp;</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./long_task.sh &amp;  <span class="comment"># 在后台运行（但退出 SSH 后会被终止）</span></span><br></pre></td></tr></table></figure><h3 id="方法-2：使用-nohup（推荐）"><a class="header-anchor" href="#方法-2：使用-nohup（推荐）">¶</a>方法 2：使用 <code>nohup</code>（推荐）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ./long_task.sh &amp;  <span class="comment"># 在后台运行，退出 SSH 后仍然继续</span></span><br></pre></td></tr></table></figure><ul><li><code>nohup</code>：No Hangup，忽略 SIGHUP 信号（SSH 断开时发送的信号）</li><li>输出默认重定向到 <code>nohup.out</code></li></ul><p><strong>更好的方式</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ./long_task.sh &gt; /dev/null 2&gt;&amp;1 &amp;  <span class="comment"># 输出丢弃，不保存到文件</span></span><br></pre></td></tr></table></figure><h3 id="方法-3：使用-screen-或-tmux（最佳实践）"><a class="header-anchor" href="#方法-3：使用-screen-或-tmux（最佳实践）">¶</a>方法 3：使用 <code>screen</code> 或 <code>tmux</code>（最佳实践）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">screen -S mysession  <span class="comment"># 创建一个 screen 会话</span></span><br><span class="line">./long_task.sh  <span class="comment"># 在 screen 里运行任务</span></span><br><span class="line"><span class="comment"># 按 Ctrl+A+D 分离会话（任务继续运行）</span></span><br><span class="line"><span class="comment"># 退出 SSH 后，任务仍然运行</span></span><br><span class="line"></span><br><span class="line">screen -r mysession  <span class="comment"># 重新连接会话</span></span><br></pre></td></tr></table></figure><h3 id="管理后台任务"><a class="header-anchor" href="#管理后台任务">¶</a>管理后台任务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">jobs</span>  <span class="comment"># 查看后台任务</span></span><br><span class="line"><span class="built_in">fg</span> %1  <span class="comment"># 把任务 1 调到前台</span></span><br><span class="line"><span class="built_in">bg</span> %1  <span class="comment"># 把任务 1 继续在后台运行（通常在 Ctrl+Z 暂停后使用）</span></span><br></pre></td></tr></table></figure><h2 id="3-调整进程优先级（nice-renice）"><a class="header-anchor" href="#3-调整进程优先级（nice-renice）">¶</a>3. 调整进程优先级（nice/renice）</h2><p>Linux 使用 <strong>nice 值</strong>控制进程优先级：</p><ul><li>nice 值范围：<code>-20</code>（最高优先级）到 <code>19</code>（最低优先级）</li><li>默认 nice 值：<code>0</code></li><li>nice 值越低，优先级越高（更容易抢到 CPU）</li></ul><h3 id="启动时指定优先级（nice）"><a class="header-anchor" href="#启动时指定优先级（nice）">¶</a>启动时指定优先级（nice）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nice</span> -n 10 ./cpu_intensive_task.sh  <span class="comment"># 以 nice 值 10 启动（降低优先级）</span></span><br><span class="line"><span class="built_in">nice</span> -n -10 ./important_task.sh  <span class="comment"># 以 nice 值 -10 启动（提高优先级，需要 root）</span></span><br></pre></td></tr></table></figure><h3 id="调整运行中进程的优先级（renice）"><a class="header-anchor" href="#调整运行中进程的优先级（renice）">¶</a>调整运行中进程的优先级（renice）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">renice -n 10 -p &lt;PID&gt;  <span class="comment"># 把进程 PID 的 nice 值改为 10</span></span><br><span class="line">renice -n -5 -p &lt;PID&gt;  <span class="comment"># 提高优先级（需要 root）</span></span><br></pre></td></tr></table></figure><p><strong>使用场景</strong>：</p><ul><li>后台备份任务：用 <code>nice -n 19</code> 启动，不影响正常业务</li><li>关键业务进程：用 <code>renice -n -10</code> 提高优先级</li></ul><hr><h1>特殊进程状态：孤儿进程和僵尸进程</h1><h2 id="孤儿进程（Orphan-Process）"><a class="header-anchor" href="#孤儿进程（Orphan-Process）">¶</a>孤儿进程（Orphan Process）</h2><p><strong>定义</strong>：父进程退出后，子进程由 PID 1（systemd 或 init）接管。</p><p><strong>示例代码</strong>（Python）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">child_process</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Child: PID=<span class="subst">&#123;os.getpid()&#125;</span>, PPID=<span class="subst">&#123;os.getppid()&#125;</span>&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)  <span class="comment"># 等待父进程退出</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Child after parent exit: PID=<span class="subst">&#123;os.getpid()&#125;</span>, PPID=<span class="subst">&#123;os.getppid()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 父进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Parent: PID=<span class="subst">&#123;os.getpid()&#125;</span>, Child PID=<span class="subst">&#123;pid&#125;</span>&quot;</span>)</span><br><span class="line">        os._exit(<span class="number">0</span>)  <span class="comment"># 父进程立即退出</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 子进程</span></span><br><span class="line">        child_process()</span><br></pre></td></tr></table></figure><p><strong>输出示例</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Parent: PID=1234, Child PID=1235</span><br><span class="line">Child: PID=1235, PPID=1234</span><br><span class="line">Child after parent exit: PID=1235, PPID=1  # PPID 变成 1（被 systemd 接管）</span><br></pre></td></tr></table></figure><p>**孤儿进程有害吗？**不一定。systemd 会接管孤儿进程，正常管理它们。</p><h2 id="僵尸进程（Zombie-Process）"><a class="header-anchor" href="#僵尸进程（Zombie-Process）">¶</a>僵尸进程（Zombie Process）</h2><p><strong>定义</strong>：进程已退出，但父进程未调用 <code>wait()</code> 回收其退出状态，导致进程信息仍保留在进程表中。</p><p><strong>特点</strong>：</p><ul><li>不占用 CPU 和内存（已退出）</li><li>但占用进程表项（过多会耗尽系统进程表）</li><li>状态显示为 <code>Z</code>（Zombie）</li></ul><p><strong>查看僵尸进程</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep <span class="string">&#x27; Z &#x27;</span></span><br></pre></td></tr></table></figure><p><strong>示例代码</strong>（Python）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 父进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Parent: PID=<span class="subst">&#123;os.getpid()&#125;</span>, Child PID=<span class="subst">&#123;pid&#125;</span> (will become zombie)&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">15</span>)  <span class="comment"># 父进程暂停 15 秒，子进程退出但未被回收（僵尸状态）</span></span><br><span class="line">        os.wait()  <span class="comment"># 回收僵尸进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Zombie child has been reaped.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 子进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Child: PID=<span class="subst">&#123;os.getpid()&#125;</span>, PPID=<span class="subst">&#123;os.getppid()&#125;</span>&quot;</span>)</span><br><span class="line">        os._exit(<span class="number">0</span>)  <span class="comment"># 子进程立即退出，进入僵尸状态</span></span><br></pre></td></tr></table></figure><p><strong>如何解决僵尸进程？</strong></p><ol><li>让父进程调用 <code>wait()</code>（如果父进程是你写的程序，修复代码）</li><li>杀掉父进程（父进程退出后，子进程被 systemd 接管并回收）</li><li>重启系统（最后手段）</li></ol><hr><h1>实战：完整的性能排障流程</h1><h2 id="场景：系统变慢了，怎么排查"><a class="header-anchor" href="#场景：系统变慢了，怎么排查">¶</a>场景：系统变慢了，怎么排查</h2><h3 id="1-看整体负载"><a class="header-anchor" href="#1-看整体负载">¶</a>1. 看整体负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uptime</span>  <span class="comment"># 查看 load average</span></span><br><span class="line">top  <span class="comment"># 实时查看 CPU、内存、进程</span></span><br></pre></td></tr></table></figure><p><strong>判断</strong>：</p><ul><li>load average 高？可能 CPU 满载或 I/O 慢</li><li>CPU idle 低？CPU 瓶颈</li><li>CPU wa 高？磁盘 I/O 慢</li></ul><h3 id="2-找出占用资源的进程"><a class="header-anchor" href="#2-找出占用资源的进程">¶</a>2. 找出占用资源的进程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top  <span class="comment"># 按 P 排序 CPU，按 M 排序内存</span></span><br><span class="line">ps aux --<span class="built_in">sort</span>=-%cpu | <span class="built_in">head</span> -10  <span class="comment"># 查看 CPU 占用前 10 的进程</span></span><br><span class="line">ps aux --<span class="built_in">sort</span>=-%mem | <span class="built_in">head</span> -10  <span class="comment"># 查看内存占用前 10 的进程</span></span><br></pre></td></tr></table></figure><h3 id="3-查看进程详情"><a class="header-anchor" href="#3-查看进程详情">¶</a>3. 查看进程详情</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lsof -p &lt;PID&gt;  <span class="comment"># 查看进程打开的文件</span></span><br><span class="line"><span class="built_in">ls</span> -l /proc/&lt;PID&gt;/fd/  <span class="comment"># 查看进程的文件描述符</span></span><br><span class="line"><span class="built_in">cat</span> /proc/&lt;PID&gt;/status  <span class="comment"># 查看进程的详细状态</span></span><br></pre></td></tr></table></figure><h3 id="4-查看磁盘-I-O"><a class="header-anchor" href="#4-查看磁盘-I-O">¶</a>4. 查看磁盘 I/O</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iostat -x 1  <span class="comment"># 查看磁盘 I/O</span></span><br><span class="line">sudo iotop -o  <span class="comment"># 查看哪个进程在读写磁盘</span></span><br></pre></td></tr></table></figure><h3 id="5-查看网络连接"><a class="header-anchor" href="#5-查看网络连接">¶</a>5. 查看网络连接</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp  <span class="comment"># 查看监听的端口</span></span><br><span class="line">lsof -i  <span class="comment"># 查看所有网络连接</span></span><br></pre></td></tr></table></figure><h3 id="6-优化或终止进程"><a class="header-anchor" href="#6-优化或终止进程">¶</a>6. 优化或终止进程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">renice -n 10 -p &lt;PID&gt;  <span class="comment"># 降低进程优先级</span></span><br><span class="line"><span class="built_in">kill</span> &lt;PID&gt;  <span class="comment"># 温和终止</span></span><br><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;  <span class="comment"># 强制终止</span></span><br></pre></td></tr></table></figure><hr><h1>实战案例：Nginx 日志文件被误删怎么办</h1><h2 id="场景"><a class="header-anchor" href="#场景">¶</a>场景</h2><p>运维人员不小心 <code>rm -rf /var/log/nginx/access.log</code>，但 nginx 进程还在运行。</p><h2 id="问题"><a class="header-anchor" href="#问题">¶</a>问题</h2><p>虽然文件被删了，但 nginx 进程仍然持有文件句柄（在 <code>/proc/&lt;pid&gt;/fd/</code> 下），继续往&quot;已删除的文件&quot;写数据。此时：</p><ul><li><code>df -h</code> 显示磁盘占用没有减少（因为文件还在占用空间）</li><li><code>ls /var/log/nginx/</code> 看不到 <code>access.log</code>（因为目录项已删除）</li></ul><h2 id="解决方案"><a class="header-anchor" href="#解决方案">¶</a>解决方案</h2><h3 id="1-找到-nginx-进程的-PID"><a class="header-anchor" href="#1-找到-nginx-进程的-PID">¶</a>1. 找到 nginx 进程的 PID</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pidof nginx  <span class="comment"># 或 ps aux | grep nginx</span></span><br></pre></td></tr></table></figure><p>假设主进程 PID 是 1234。</p><h3 id="2-查看进程打开的文件"><a class="header-anchor" href="#2-查看进程打开的文件">¶</a>2. 查看进程打开的文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p 1234 | grep access.log</span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx  1234 root  6w  REG  8,1  123456789  /var/log/nginx/access.log (deleted)</span><br></pre></td></tr></table></figure><ul><li><code>6w</code>：文件描述符是 6，模式是 <code>w</code>（写）</li><li><code>(deleted)</code>：文件已被删除但进程仍持有句柄</li></ul><h3 id="3-恢复文件"><a class="header-anchor" href="#3-恢复文件">¶</a>3. 恢复文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /proc/1234/fd/6 /var/log/nginx/access.log</span><br></pre></td></tr></table></figure><h3 id="4-重新加载-nginx"><a class="header-anchor" href="#4-重新加载-nginx">¶</a>4. 重新加载 nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload  <span class="comment"># 让 nginx 重新打开日志文件</span></span><br></pre></td></tr></table></figure><p><strong>原理</strong>：</p><ul><li>删除文件只是删除目录项（文件名），inode 和数据块还在（因为进程还在用）</li><li>通过 <code>/proc/&lt;pid&gt;/fd/&lt;fd&gt;</code> 可以访问进程打开的文件（即使已删除）</li><li><code>cp</code> 复制文件后，重新加载 nginx，让它重新打开日志文件</li></ul><hr><h1>总结与扩展阅读</h1><p>这篇文章涵盖了 Linux 进程与资源管理的核心内容：</p><ol><li>✅ 进程与程序的基本概念（进程 vs 程序 vs 线程、父子关系）</li><li>✅ Linux 资源管理概述（CPU/内存/磁盘/网络）</li><li>✅ Buffer 和 Cache 详解（为什么&quot;内存不够用&quot;经常是误判）</li><li>✅ 进程监控工具链（top/htop/ps/pstree/lsof/ss/iostat）</li><li>✅ 进程控制（kill 信号、后台任务、优先级调整）</li><li>✅ 特殊进程状态（孤儿进程、僵尸进程）</li><li>✅ 实战案例（性能排障流程、Nginx 日志恢复）</li></ol><p><strong>扩展阅读</strong>：</p><ul><li>Linux Performance（Brendan Gregg）：<a class="link" href="http://www.brendangregg.com/linuxperf.html">http://www.brendangregg.com/linuxperf.html<i class="fas fa-external-link-alt"></i></a></li><li><code>man proc</code>：查看 <code>/proc</code> 文件系统的详细说明</li><li><code>man 7 signal</code>：查看所有信号的说明</li></ul><p><strong>下一步</strong>：</p><ul><li><strong>《Linux 磁盘管理》</strong>：学习分区、格式化、挂载、LVM、RAID 等</li><li><strong>《Linux 用户管理》</strong>：学习如何管理用户/组/权限</li></ul><hr><p><strong>到这里，你应该已经从&quot;会看 top&quot;升级到&quot;能快速定位资源瓶颈、能优化进程优先级、能处理异常进程状态&quot;。进程与资源管理是 Linux 运维的核心技能，掌握了它，你就能更好地排查性能问题。</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;线上排障时，最关键的能力不是&amp;quot;会背命令&amp;quot;，而是能把现象快速映射到资源与进程：CPU 是不是被打满、内存是不是被 cache 吃掉、磁盘 I/O 在不在等、到底是哪一个进程/文件/端口在拖慢系统。本文从进程/线程与父子关系的基本概念出发，解释 Linux 的资源视角（尤其是 buffer/cache 的含义与&amp;quot;内存不够用&amp;quot;的误判），然后系统梳理一套常用监控与定位工具链（&lt;code&gt;top/htop/ps/pstree/lsof&lt;/code&gt;、端口/网络、I/O、负载与压力测试）。接着补齐&amp;quot;把进程控住&amp;quot;的操作：信号与后台任务、&lt;code&gt;nice/renice&lt;/code&gt; 优先级、孤儿/僵尸进程的成因与处理；最后用一个完整的排障案例（Nginx 日志文件被误删怎么办）把&amp;quot;资源视角&amp;quot;落到实战层面，方便你把一次完整排障流程跑通。如果你是运维人员或需要排查性能问题，这篇文章会让你从&amp;quot;会看 top&amp;quot;升级到&amp;quot;能快速定位资源瓶颈、能优化进程优先级、能处理异常进程状态&amp;quot;。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux Process and Resource Management: Monitoring, Troubleshooting, and Optimization</title>
    <link href="https://chenk.top/en/linux-process-resource-management/"/>
    <id>https://chenk.top/en/linux-process-resource-management/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-29T16:25:52.473Z</updated>
    
    <content type="html"><![CDATA[<p>In production troubleshooting, the most critical skill isn’t “memorizing commands” but quickly mapping symptoms to resources and processes: is CPU maxed out, is memory being consumed by cache, is disk I/O blocking, and exactly which process/file/port is slowing down the system. This post starts from basic concepts of processes/threads and parent-child relationships, explains Linux’s resource perspective (especially the meaning of buffer/cache and the “out of memory” misjudgment), then systematically organizes a commonly used monitoring and locating toolchain (<code>top/htop/ps/pstree/lsof</code>, ports/network, I/O, load and stress testing). Then it fills in the “process control” operations: signals and background tasks, <code>nice/renice</code> priority, orphan/zombie process causes and handling; finally, using a complete troubleshooting case (what to do when Nginx log files are accidentally deleted) to apply the “resource perspective” to practical scenarios, helping you run through a complete troubleshooting workflow. If you’re a sysadmin or need to troubleshoot performance issues, this article will upgrade you from “can view top” to “can quickly locate resource bottlenecks, can optimize process priorities, can handle abnormal process states.”</p><span id="more"></span><h1>Basic Concepts: Process vs Program vs Thread</h1><h2 id="The-Three-Concepts-Often-Confused"><a class="header-anchor" href="#The-Three-Concepts-Often-Confused">¶</a>The Three Concepts Often Confused</h2><p>Understanding the differences between these three is important for grasping Linux systems:</p><table><thead><tr><th>Concept</th><th>Definition</th><th>Metaphor</th></tr></thead><tbody><tr><td><strong>Program</strong></td><td>Static executable file stored on disk (like <code>/usr/bin/vim</code>)</td><td>Architectural blueprint</td></tr><tr><td><strong>Process</strong></td><td>Running instance after program is loaded into memory (has PID, memory space, open files)</td><td>Construction site in progress (foreman)</td></tr><tr><td><strong>Thread</strong></td><td>Execution unit within a process (shares process memory but has independent execution flow)</td><td>Workers on site</td></tr></tbody></table><p><strong>Examples</strong>:</p><ul><li>When you run <code>vim myfile.txt</code>, the <code>vim</code> program loads from disk into memory, creating a process responsible for editing <code>myfile.txt</code>.</li><li>The same program can start multiple processes simultaneously; for example, when opening multiple browser tabs, each tab might correspond to an independent process (or multiple threads).</li><li>A process can contain multiple threads; for example, a music player process might have two threads: one downloading music, one playing songs.</li></ul><p><strong>Why have threads?</strong></p><ul><li>Threads are lighter than processes (lower creation/destruction overhead)</li><li>Threads share process memory space (easier communication)</li><li>Multi-threading can fully utilize multi-core CPUs (parallel computing)</li></ul><h2 id="Five-Key-Process-Characteristics"><a class="header-anchor" href="#Five-Key-Process-Characteristics">¶</a>Five Key Process Characteristics</h2><ol><li><strong>Independence</strong>: Each process has its own memory space and system resources, isolated from each other (process A’s variables won’t affect process B)</li><li><strong>Concurrency</strong>: OS allows multiple processes to run simultaneously, achieving concurrent processing through multi-task scheduling</li><li><strong>Dynamism</strong>: Processes continuously create, execute, terminate; state changes in real-time (OS operation is continuously creating and destroying processes)</li><li><strong>Parent-Child Relationship</strong>: Processes are created by parent processes via <code>fork()</code> call, forming parent-child structure (PPID field indicates parent process)</li><li><strong>Schedulability</strong>: OS uses scheduling algorithms (like time-slice rotation, priority scheduling) to determine process execution order</li></ol><h2 id="Process-Parent-Child-Relationship-PID-and-PPID"><a class="header-anchor" href="#Process-Parent-Child-Relationship-PID-and-PPID">¶</a>Process Parent-Child Relationship (PID and PPID)</h2><p>Every process has two important IDs:</p><ul><li><strong>PID</strong> (Process ID): Process ID, uniquely identifies a process</li><li><strong>PPID</strong> (Parent Process ID): Parent process ID, identifies the parent process that created this process</li></ul><p><strong>Example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep bash</span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UID   PID  PPID  C STIME TTY      TIME CMD</span><br><span class="line">root  1234 1     0 12:00 ?        00:00:00 /bin/bash /usr/local/bin/startup.sh</span><br><span class="line">user  5678 1234  0 12:05 pts/0    00:00:00 bash</span><br></pre></td></tr></table></figure><ul><li>PID 5678 process is <code>bash</code>, its PPID is 1234 (parent process is <code>/bin/bash /usr/local/bin/startup.sh</code>)</li><li>All processes can ultimately be traced back to PID 1 (systemd or init)</li></ul><p><strong>View process tree</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree -p  <span class="comment"># Display process parent-child relationships in tree structure (-p shows PID)</span></span><br></pre></td></tr></table></figure><hr><h1>Linux Resource Management Overview: CPU/Memory/Disk/Network</h1><p>Operations work revolves around hardware and software resources; properly managing these resources ensures system runs efficiently and stably.</p><h2 id="Four-Major-Hardware-Resource-Categories"><a class="header-anchor" href="#Four-Major-Hardware-Resource-Categories">¶</a>Four Major Hardware Resource Categories</h2><h3 id="1-CPU-Resources"><a class="header-anchor" href="#1-CPU-Resources">¶</a>1. CPU Resources</h3><ul><li><strong>Core count</strong>: Modern CPUs are typically multi-core (like 4-core, 8-core, 16-core)</li><li><strong>Load</strong>: Number of processes waiting to execute (load average)</li><li><strong>Utilization</strong>: Percentage of CPU occupied by processes</li></ul><p><strong>Check CPU core count</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lscpu | grep <span class="string">&#x27;^CPU(s)&#x27;</span>  <span class="comment"># Output: CPU(s): 4</span></span><br><span class="line"><span class="built_in">nproc</span>  <span class="comment"># Output core count: 4</span></span><br></pre></td></tr></table></figure><p><strong>Check CPU load</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uptime</span>  <span class="comment"># Output: 06:56:12 up 12 days, 3:45, 3 users, load average: 0.22, 0.45, 0.56</span></span><br></pre></td></tr></table></figure><p><strong>load average interpretation</strong> (for 4-core CPU example):</p><ul><li><code>load average: 0.22, 0.45, 0.56</code>: Average loads for 1 minute, 5 minutes, 15 minutes</li><li>Load &lt; core count (like load &lt; 4 for 4-core): System idle</li><li>Load = core count (like load = 4 for 4-core): System at full capacity</li><li>Load &gt; core count (like load &gt; 4 for 4-core): System overloaded (processes waiting for CPU)</li></ul><p><strong>High load but low CPU usage?</strong> This usually indicates processes are waiting for I/O (disk read/write, network), not CPU bottleneck.</p><h3 id="2-Memory-Resources"><a class="header-anchor" href="#2-Memory-Resources">¶</a>2. Memory Resources</h3><ul><li><strong>Total memory</strong>: Total physical memory</li><li><strong>Used memory</strong>: Allocated memory</li><li><strong>Available memory</strong>: Actually available memory (includes reclaimable buffer/cache)</li><li><strong>Swap</strong>: Swap space (virtual memory on hard drive, slow)</li></ul><p><strong>Check memory usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -h  <span class="comment"># -h human-readable display (MB/GB)</span></span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           15Gi       2.5Gi       8.0Gi       100Mi       4.5Gi        12Gi</span><br><span class="line">Swap:         2.0Gi          0B       2.0Gi</span><br></pre></td></tr></table></figure><p><strong>Important concept: buffer and cache</strong> (detailed in next section)</p><h3 id="3-Disk-Resources"><a class="header-anchor" href="#3-Disk-Resources">¶</a>3. Disk Resources</h3><ul><li><strong>Capacity</strong>: Total storage space provided by hard drive or SSD</li><li><strong>Read/Write Performance</strong>:<ul><li><strong>Mechanical Hard Drive (HDD)</strong>: Large capacity, low price, slow speed (100-200 MB/s)</li><li><strong>Solid State Drive (SSD)</strong>: Fast speed, high price, relatively small capacity (500-3000 MB/s)</li><li><strong>NVMe SSD</strong>: Even faster (3000-7000 MB/s)</li></ul></li></ul><p><strong>Check disk usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h  <span class="comment"># View partition usage</span></span><br><span class="line">lsblk  <span class="comment"># List block devices and mount points</span></span><br><span class="line"><span class="built_in">du</span> -sh /*  <span class="comment"># View space occupied by each directory under root</span></span><br></pre></td></tr></table></figure><p><strong>Check disk I/O</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iostat -x 1  <span class="comment"># Refresh every second (requires sysstat package)</span></span><br><span class="line">iotop  <span class="comment"># Real-time view of each process&#x27;s disk I/O (requires root privileges)</span></span><br></pre></td></tr></table></figure><h3 id="4-Network-Resources"><a class="header-anchor" href="#4-Network-Resources">¶</a>4. Network Resources</h3><ul><li><strong>Bandwidth</strong>: Network interface maximum transfer rate (like 1 Gbps, 10 Gbps)</li><li><strong>Throughput</strong>: Actual transfer rate</li><li><strong>Latency</strong>: Packet round-trip time (RTT)</li></ul><p><strong>Check network traffic</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iftop -i eth0  <span class="comment"># Real-time display of network traffic (needs iftop installation)</span></span><br><span class="line">ip -s <span class="built_in">link</span>  <span class="comment"># View interface statistics (sent/received packets, dropped packets)</span></span><br></pre></td></tr></table></figure><p><strong>Check network connections</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp  <span class="comment"># View listening ports and connections (replaces netstat)</span></span><br><span class="line">lsof -i :80  <span class="comment"># See which process is using port 80</span></span><br></pre></td></tr></table></figure><hr><h1>Buffer and Cache Explained: Why “Out of Memory” Is Often a Misjudgment</h1><p>Linux memory management is aggressive: <strong>use as much memory as possible to cache data, improving performance</strong>. So you’ll find <code>free</code> shows very little <code>free</code>, but this <strong>doesn’t mean you’re out of memory</strong>.</p><h2 id="Buffer-vs-Cache-v2"><a class="header-anchor" href="#Buffer-vs-Cache-v2">¶</a>Buffer vs Cache</h2><table><thead><tr><th>Type</th><th>Function</th><th>Example</th></tr></thead><tbody><tr><td><strong>Buffer</strong></td><td>Write buffer (temporary storage before data is written from memory to disk)</td><td>When writing files, data first stored in buffer, then batch-written to disk</td></tr><tr><td><strong>Cache</strong></td><td>Read cache (data read from disk cached in memory, next read directly from memory)</td><td>When reading files, content cached in cache, next read instant</td></tr></tbody></table><p><strong>Why this design?</strong></p><ul><li><strong>Buffer</strong>: Reduces disk write operations. If every write went directly to disk, too slow (especially for lots of small files). First accumulate a batch of data, then write to disk all at once, much faster.</li><li><strong>Cache</strong>: Reduces disk read operations. Frequently accessed files cached in memory, reading speed hundreds of times faster.</li></ul><p><strong>Important</strong>: <strong>Buffer and Cache are reclaimable</strong>. When programs need more memory, the kernel automatically releases buffer/cache to programs. So the <code>available</code> shown in <code>free</code> is the truly available memory (including reclaimable buffer/cache).</p><p><strong>Misjudgment example</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:           15Gi       2.5Gi       1.0Gi       100Mi      11.5Gi        12Gi</span><br></pre></td></tr></table></figure><p>Beginners see <code>free</code> only has 1.0Gi and think memory is running out. But actually <code>available</code> is 12Gi (because the 11.5Gi buff/cache is reclaimable).</p><p><strong>When is memory truly running out?</strong></p><ul><li><code>available</code> approaches 0</li><li>Swap usage is very high (indicates insufficient memory, starting to use hard drive as memory)</li><li>Processes are killed by OOM killer (kernel’s out-of-memory killer)</li></ul><hr><h1>Process Monitoring Toolchain: From Overview to Details</h1><h2 id="1-top-The-“Swiss-Army-Knife”-of-Real-Time-Monitoring"><a class="header-anchor" href="#1-top-The-“Swiss-Army-Knife”-of-Real-Time-Monitoring">¶</a>1. top: The “Swiss Army Knife” of Real-Time Monitoring</h2><p><code>top</code> is the most commonly used real-time monitoring tool, displaying CPU, memory, process info, etc.</p><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top</span><br></pre></td></tr></table></figure><p><strong>Interface interpretation</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">top - 12:00:00 up 10 days,  3:45,  2 users,  load average: 1.23, 0.87, 0.45</span><br><span class="line">Tasks: 150 total,   2 running, 148 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  5.2 us,  2.1 sy,  0.0 ni, 92.3 id,  0.3 wa,  0.0 hi,  0.1 si,  0.0 st</span><br><span class="line">MiB Mem :  15872.0 total,   8234.5 free,   3456.2 used,   4181.3 buff/cache</span><br><span class="line">MiB Swap:   2048.0 total,   2048.0 free,      0.0 used.  11234.5 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line"> 1234 root      20   0  123456  12345   1234 R  50.0   0.8   1:23.45 python3</span><br><span class="line"> 5678 www-data  20   0  234567  23456   2345 S  10.0   1.5   0:12.34 nginx</span><br></pre></td></tr></table></figure><p><strong>Key metrics</strong>:</p><ul><li><strong>load average</strong>: 1/5/15-minute average load (approaching CPU core count means system at full capacity)</li><li><strong>Tasks</strong>: Total processes, running/sleeping/stopped/zombie process counts</li><li><strong>%Cpu(s)</strong>:<ul><li><code>us</code> (user): User-space CPU usage</li><li><code>sy</code> (system): Kernel-space CPU usage</li><li><code>ni</code> (nice): Low-priority process CPU usage</li><li><code>id</code> (idle): Idle CPU (higher is better)</li><li><code>wa</code> (wait): CPU time waiting for I/O (high indicates slow disk/network)</li></ul></li><li><strong>Mem/Swap</strong>: Memory and swap space usage</li></ul><p><strong>Common hotkeys</strong>:</p><ul><li><code>P</code>: Sort by CPU usage</li><li><code>M</code>: Sort by memory usage</li><li><code>k</code>: Enter PID to send signal to terminate process</li><li><code>1</code>: Show each CPU core’s usage rate</li><li><code>q</code>: Quit</li></ul><h2 id="2-htop-Enhanced-Version-of-top"><a class="header-anchor" href="#2-htop-Enhanced-Version-of-top">¶</a>2. htop: Enhanced Version of top</h2><p><code>htop</code> is a colorful enhanced version of <code>top</code>, supporting mouse operations, tree view, direct process termination.</p><p><strong>Install and use</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install htop  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf install htop  <span class="comment"># CentOS/RHEL</span></span><br><span class="line">htop</span><br></pre></td></tr></table></figure><p><strong>Advantages</strong>:</p><ul><li>Colorful interface, more intuitive</li><li>Supports mouse clicking to select processes</li><li>Displays process tree (F5 to toggle tree view)</li><li>Can directly select and terminate processes (F9 to send signal)</li></ul><h2 id="3-ps-Static-Process-Snapshot"><a class="header-anchor" href="#3-ps-Static-Process-Snapshot">¶</a>3. ps: Static Process Snapshot</h2><p><code>ps</code> provides a static snapshot of current processes (doesn’t refresh in real-time like top).</p><p><strong>Common usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ps -ef  <span class="comment"># Unix style, show all processes (-e) with full info (-f)</span></span><br><span class="line">ps aux  <span class="comment"># BSD style, show all processes (a) with user info (u) and background processes (x)</span></span><br></pre></td></tr></table></figure><p><strong>Output field interpretation</strong> (<code>ps aux</code>):</p><ul><li><strong>USER</strong>: Process owner</li><li><strong>PID</strong>: Process ID</li><li><strong>%CPU</strong>: CPU usage</li><li><strong>%MEM</strong>: Memory usage</li><li><strong>VSZ</strong>: Virtual memory size (total memory requested by process)</li><li><strong>RSS</strong>: Resident memory size (actual physical memory occupied)</li><li><strong>STAT</strong>: Process state<ul><li><code>R</code>: Running</li><li><code>S</code>: Sleeping (waiting for event)</li><li><code>D</code>: Uninterruptible sleep (usually waiting for disk I/O)</li><li><code>Z</code>: Zombie (exited but not reaped by parent)</li><li><code>T</code>: Stopped (usually paused by Ctrl+Z)</li></ul></li><li><strong>TIME</strong>: Process cumulative CPU time</li><li><strong>COMMAND</strong>: Process command</li></ul><p><strong>Advanced usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep nginx  <span class="comment"># View nginx-related processes</span></span><br><span class="line">ps -ef | grep -v grep  <span class="comment"># Remove grep&#x27;s own process</span></span><br><span class="line">ps -eo pid,ppid,cmd,%cpu,%mem --<span class="built_in">sort</span>=-%cpu | <span class="built_in">head</span> -10  <span class="comment"># Sort by CPU usage, show top 10</span></span><br></pre></td></tr></table></figure><h2 id="4-pstree-Process-Tree"><a class="header-anchor" href="#4-pstree-Process-Tree">¶</a>4. pstree: Process Tree</h2><p><code>pstree</code> displays process parent-child relationships in tree structure, helping understand process hierarchy.</p><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pstree -p  <span class="comment"># -p displays PID</span></span><br><span class="line">pstree -ap  <span class="comment"># -a displays command parameters</span></span><br></pre></td></tr></table></figure><h2 id="5-lsof-View-Open-Files"><a class="header-anchor" href="#5-lsof-View-Open-Files">¶</a>5. lsof: View Open Files</h2><p><code>lsof</code> (List Open Files) lists all open files in the system, including regular files, network connections, devices, etc.</p><p><strong>Why use lsof?</strong></p><ul><li>View which files a process has opened (like config files, log files, database files)</li><li>View which process is using a port (like who’s using port 80)</li><li>View which process is using a file (like if a file can’t be deleted, might be in use by a process)</li><li>Recover accidentally deleted files (if process is still running, file handle still exists, can recover via <code>/proc/&lt;pid&gt;/fd/</code>)</li></ul><p><strong>Common usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lsof  <span class="comment"># List all open files (very long output)</span></span><br><span class="line">lsof -p &lt;PID&gt;  <span class="comment"># View files opened by specified process</span></span><br><span class="line">lsof -u &lt;user&gt;  <span class="comment"># View files opened by specified user</span></span><br><span class="line">lsof -c &lt;<span class="built_in">command</span>&gt;  <span class="comment"># View files opened by specified command</span></span><br><span class="line">lsof -i :80  <span class="comment"># See which process is using port 80</span></span><br><span class="line">lsof -i tcp  <span class="comment"># View all TCP connections</span></span><br><span class="line">lsof +D /var/log  <span class="comment"># View files opened under /var/log directory</span></span><br><span class="line">lsof +L1  <span class="comment"># View files with link count &lt; 1 (usually deleted but still occupied by process)</span></span><br></pre></td></tr></table></figure><p><strong>Example</strong>: View all files opened by nginx</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -c nginx</span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">COMMAND   PID     USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">nginx    1234     root  cwd    DIR    8,1     4096    2 /</span><br><span class="line">nginx    1234     root  txt    REG    8,1   123456  789 /usr/sbin/nginx</span><br><span class="line">nginx    1234     root    1w   REG    8,1    12345 1011 /var/log/nginx/access.log</span><br><span class="line">nginx    1234     root    2w   REG    8,1     6789 1012 /var/log/nginx/error.log</span><br><span class="line">nginx    1234     root    6u  IPv4  12345      0t0  TCP *:80 (LISTEN)</span><br></pre></td></tr></table></figure><ul><li><code>FD</code>: File descriptor (<code>cwd</code> is current directory, <code>txt</code> is program file, <code>1w</code> is stdout, <code>2w</code> is stderr, <code>6u</code> is open socket)</li><li><code>TYPE</code>: Type (<code>DIR</code> is directory, <code>REG</code> is regular file, <code>IPv4</code> is network socket)</li></ul><h2 id="6-Network-Port-Monitoring"><a class="header-anchor" href="#6-Network-Port-Monitoring">¶</a>6. Network Port Monitoring</h2><h3 id="ss-View-Network-Connections-Replaces-netstat"><a class="header-anchor" href="#ss-View-Network-Connections-Replaces-netstat">¶</a>ss: View Network Connections (Replaces netstat)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp  <span class="comment"># View listening ports and connections</span></span><br></pre></td></tr></table></figure><ul><li><code>-t</code>: TCP connections</li><li><code>-u</code>: UDP connections</li><li><code>-l</code>: Listening ports (LISTEN state)</li><li><code>-n</code>: Display numeric addresses and ports (don’t resolve hostnames)</li><li><code>-p</code>: Display process PID and name</li></ul><p><strong>Example</strong>: Check port 80 listening status</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp | grep :80</span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp   LISTEN 0   128   *:80   *:*   users:((&quot;nginx&quot;,pid=1234,fd=6))</span><br></pre></td></tr></table></figure><h3 id="lsof-View-Port-Usage"><a class="header-anchor" href="#lsof-View-Port-Usage">¶</a>lsof: View Port Usage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsof -i :80  <span class="comment"># See which process is using port 80</span></span><br><span class="line">lsof -i tcp  <span class="comment"># View all TCP connections</span></span><br></pre></td></tr></table></figure><h2 id="7-Disk-I-O-Monitoring"><a class="header-anchor" href="#7-Disk-I-O-Monitoring">¶</a>7. Disk I/O Monitoring</h2><h3 id="iostat-Disk-I-O-Statistics"><a class="header-anchor" href="#iostat-Disk-I-O-Statistics">¶</a>iostat: Disk I/O Statistics</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iostat -x 1  <span class="comment"># Refresh every second, show extended info</span></span><br></pre></td></tr></table></figure><p><strong>Key metrics</strong>:</p><ul><li><strong>%util</strong>: Disk utilization (approaching 100% means disk is very busy)</li><li><strong>await</strong>: Average wait time (milliseconds)</li><li><strong>r/s, w/s</strong>: Read/write operations per second</li></ul><h3 id="iotop-Real-Time-View-of-Process-Disk-I-O"><a class="header-anchor" href="#iotop-Real-Time-View-of-Process-Disk-I-O">¶</a>iotop: Real-Time View of Process Disk I/O</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo iotop -o  <span class="comment"># -o only shows processes with I/O</span></span><br></pre></td></tr></table></figure><hr><h1>Process Control: Signals, Background Tasks, Priorities</h1><h2 id="1-kill-Send-Signals"><a class="header-anchor" href="#1-kill-Send-Signals">¶</a>1. kill: Send Signals</h2><p><code>kill</code> isn’t just “kill process”; its essence is <strong>sending signals to processes</strong>.</p><p><strong>Common signals</strong>:</p><table><thead><tr><th>Signal Number</th><th>Signal Name</th><th>Function</th><th>Example</th></tr></thead><tbody><tr><td>1</td><td>SIGHUP</td><td>Reload config (don’t terminate process)</td><td><code>kill -1 &lt;PID&gt;</code></td></tr><tr><td>2</td><td>SIGINT</td><td>Interrupt (equivalent to Ctrl+C)</td><td><code>kill -2 &lt;PID&gt;</code></td></tr><tr><td>9</td><td>SIGKILL</td><td>Force terminate (process can’t catch, immediate termination)</td><td><code>kill -9 &lt;PID&gt;</code></td></tr><tr><td>15</td><td>SIGTERM</td><td>Gentle terminate (process can catch, cleanup then exit)</td><td><code>kill &lt;PID&gt;</code> (default)</td></tr><tr><td>20</td><td>SIGTSTP</td><td>Pause (equivalent to Ctrl+Z)</td><td><code>kill -20 &lt;PID&gt;</code></td></tr></tbody></table><p><strong>Best practices</strong>:</p><ol><li>First use <code>kill &lt;PID&gt;</code> (SIGTERM), give process chance to cleanup (like saving data, closing connections)</li><li>If process doesn’t respond, then use <code>kill -9 &lt;PID&gt;</code> (SIGKILL) to force terminate</li></ol><p><strong>Example</strong>: Reload nginx config (without stopping service)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">kill</span> -1 $(pidof nginx | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)  <span class="comment"># Send SIGHUP signal</span></span><br><span class="line"><span class="comment"># Or</span></span><br><span class="line">sudo nginx -s reload  <span class="comment"># Nginx&#x27;s convenient command</span></span><br></pre></td></tr></table></figure><h2 id="2-Background-Task-Running"><a class="header-anchor" href="#2-Background-Task-Running">¶</a>2. Background Task Running</h2><h3 id="Method-1-Use"><a class="header-anchor" href="#Method-1-Use">¶</a>Method 1: Use <code>&amp;</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./long_task.sh &amp;  <span class="comment"># Run in background (but will be terminated after exiting SSH)</span></span><br></pre></td></tr></table></figure><h3 id="Method-2-Use-nohup-Recommended"><a class="header-anchor" href="#Method-2-Use-nohup-Recommended">¶</a>Method 2: Use <code>nohup</code> (Recommended)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ./long_task.sh &amp;  <span class="comment"># Run in background, continues after exiting SSH</span></span><br></pre></td></tr></table></figure><ul><li><code>nohup</code>: No Hangup, ignores SIGHUP signal (signal sent when SSH disconnects)</li><li>Output defaults to redirecting to <code>nohup.out</code></li></ul><p><strong>Better way</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ./long_task.sh &gt; /dev/null 2&gt;&amp;1 &amp;  <span class="comment"># Discard output, don&#x27;t save to file</span></span><br></pre></td></tr></table></figure><h3 id="Method-3-Use-screen-or-tmux-Best-Practice"><a class="header-anchor" href="#Method-3-Use-screen-or-tmux-Best-Practice">¶</a>Method 3: Use <code>screen</code> or <code>tmux</code> (Best Practice)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">screen -S mysession  <span class="comment"># Create a screen session</span></span><br><span class="line">./long_task.sh  <span class="comment"># Run task in screen</span></span><br><span class="line"><span class="comment"># Press Ctrl+A+D to detach session (task continues running)</span></span><br><span class="line"><span class="comment"># After exiting SSH, task still runs</span></span><br><span class="line"></span><br><span class="line">screen -r mysession  <span class="comment"># Reconnect to session</span></span><br></pre></td></tr></table></figure><h3 id="Manage-Background-Tasks"><a class="header-anchor" href="#Manage-Background-Tasks">¶</a>Manage Background Tasks</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">jobs</span>  <span class="comment"># View background tasks</span></span><br><span class="line"><span class="built_in">fg</span> %1  <span class="comment"># Bring task 1 to foreground</span></span><br><span class="line"><span class="built_in">bg</span> %1  <span class="comment"># Continue task 1 in background (usually used after Ctrl+Z pause)</span></span><br></pre></td></tr></table></figure><h2 id="3-Adjust-Process-Priority-nice-renice"><a class="header-anchor" href="#3-Adjust-Process-Priority-nice-renice">¶</a>3. Adjust Process Priority (nice/renice)</h2><p>Linux uses <strong>nice values</strong> to control process priority:</p><ul><li>nice value range: <code>-20</code> (highest priority) to <code>19</code> (lowest priority)</li><li>Default nice value: <code>0</code></li><li>Lower nice value = higher priority (easier to grab CPU)</li></ul><h3 id="Specify-Priority-at-Startup-nice"><a class="header-anchor" href="#Specify-Priority-at-Startup-nice">¶</a>Specify Priority at Startup (nice)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nice</span> -n 10 ./cpu_intensive_task.sh  <span class="comment"># Start with nice value 10 (lower priority)</span></span><br><span class="line"><span class="built_in">nice</span> -n -10 ./important_task.sh  <span class="comment"># Start with nice value -10 (higher priority, needs root)</span></span><br></pre></td></tr></table></figure><h3 id="Adjust-Running-Process-Priority-renice"><a class="header-anchor" href="#Adjust-Running-Process-Priority-renice">¶</a>Adjust Running Process Priority (renice)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">renice -n 10 -p &lt;PID&gt;  <span class="comment"># Change process PID&#x27;s nice value to 10</span></span><br><span class="line">renice -n -5 -p &lt;PID&gt;  <span class="comment"># Increase priority (needs root)</span></span><br></pre></td></tr></table></figure><p><strong>Use cases</strong>:</p><ul><li>Background backup tasks: Start with <code>nice -n 19</code>, don’t affect normal business</li><li>Critical business processes: Use <code>renice -n -10</code> to increase priority</li></ul><hr><h1>Special Process States: Orphan and Zombie Processes</h1><h2 id="Orphan-Process"><a class="header-anchor" href="#Orphan-Process">¶</a>Orphan Process</h2><p><strong>Definition</strong>: After parent process exits, child process is adopted by PID 1 (systemd or init).</p><p><strong>Example code</strong> (Python):</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">child_process</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Child: PID=<span class="subst">&#123;os.getpid()&#125;</span>, PPID=<span class="subst">&#123;os.getppid()&#125;</span>&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">3</span>)  <span class="comment"># Wait for parent to exit</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Child after parent exit: PID=<span class="subst">&#123;os.getpid()&#125;</span>, PPID=<span class="subst">&#123;os.getppid()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># Parent process</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Parent: PID=<span class="subst">&#123;os.getpid()&#125;</span>, Child PID=<span class="subst">&#123;pid&#125;</span>&quot;</span>)</span><br><span class="line">        os._exit(<span class="number">0</span>)  <span class="comment"># Parent exits immediately</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Child process</span></span><br><span class="line">        child_process()</span><br></pre></td></tr></table></figure><p><strong>Example output</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Parent: PID=1234, Child PID=1235</span><br><span class="line">Child: PID=1235, PPID=1234</span><br><span class="line">Child after parent exit: PID=1235, PPID=1  # PPID becomes 1 (adopted by systemd)</span><br></pre></td></tr></table></figure><p><strong>Are orphan processes harmful?</strong> Not necessarily. systemd adopts orphan processes and manages them normally.</p><h2 id="Zombie-Process"><a class="header-anchor" href="#Zombie-Process">¶</a>Zombie Process</h2><p><strong>Definition</strong>: Process has exited, but parent hasn’t called <code>wait()</code> to reap its exit status, causing process info to remain in process table.</p><p><strong>Characteristics</strong>:</p><ul><li>Doesn’t occupy CPU or memory (already exited)</li><li>But occupies process table entry (too many can exhaust system process table)</li><li>State shows as <code>Z</code> (Zombie)</li></ul><p><strong>View zombie processes</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep <span class="string">&#x27; Z &#x27;</span></span><br></pre></td></tr></table></figure><p><strong>Example code</strong> (Python):</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># Parent process</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Parent: PID=<span class="subst">&#123;os.getpid()&#125;</span>, Child PID=<span class="subst">&#123;pid&#125;</span> (will become zombie)&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">15</span>)  <span class="comment"># Parent pauses 15 seconds, child exits but not reaped (zombie state)</span></span><br><span class="line">        os.wait()  <span class="comment"># Reap zombie process</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Zombie child has been reaped.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Child process</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Child: PID=<span class="subst">&#123;os.getpid()&#125;</span>, PPID=<span class="subst">&#123;os.getppid()&#125;</span>&quot;</span>)</span><br><span class="line">        os._exit(<span class="number">0</span>)  <span class="comment"># Child exits immediately, enters zombie state</span></span><br></pre></td></tr></table></figure><p><strong>How to resolve zombie processes?</strong></p><ol><li>Make parent call <code>wait()</code> (if parent is your program, fix the code)</li><li>Kill parent process (after parent exits, child is adopted by systemd and reaped)</li><li>Reboot system (last resort)</li></ol><hr><h1>Hands-On: Complete Performance Troubleshooting Workflow</h1><h2 id="Scenario-System-Slowed-Down-How-to-Troubleshoot"><a class="header-anchor" href="#Scenario-System-Slowed-Down-How-to-Troubleshoot">¶</a>Scenario: System Slowed Down, How to Troubleshoot</h2><h3 id="1-Check-Overall-Load"><a class="header-anchor" href="#1-Check-Overall-Load">¶</a>1. Check Overall Load</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uptime</span>  <span class="comment"># Check load average</span></span><br><span class="line">top  <span class="comment"># Real-time view of CPU, memory, processes</span></span><br></pre></td></tr></table></figure><p><strong>Diagnosis</strong>:</p><ul><li>load average high? Possibly CPU maxed or I/O slow</li><li>CPU idle low? CPU bottleneck</li><li>CPU wa high? Disk I/O slow</li></ul><h3 id="2-Find-Resource-Consuming-Processes"><a class="header-anchor" href="#2-Find-Resource-Consuming-Processes">¶</a>2. Find Resource-Consuming Processes</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top  <span class="comment"># Press P to sort by CPU, M to sort by memory</span></span><br><span class="line">ps aux --<span class="built_in">sort</span>=-%cpu | <span class="built_in">head</span> -10  <span class="comment"># View top 10 CPU-consuming processes</span></span><br><span class="line">ps aux --<span class="built_in">sort</span>=-%mem | <span class="built_in">head</span> -10  <span class="comment"># View top 10 memory-consuming processes</span></span><br></pre></td></tr></table></figure><h3 id="3-View-Process-Details"><a class="header-anchor" href="#3-View-Process-Details">¶</a>3. View Process Details</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lsof -p &lt;PID&gt;  <span class="comment"># View files opened by process</span></span><br><span class="line"><span class="built_in">ls</span> -l /proc/&lt;PID&gt;/fd/  <span class="comment"># View process file descriptors</span></span><br><span class="line"><span class="built_in">cat</span> /proc/&lt;PID&gt;/status  <span class="comment"># View detailed process status</span></span><br></pre></td></tr></table></figure><h3 id="4-Check-Disk-I-O"><a class="header-anchor" href="#4-Check-Disk-I-O">¶</a>4. Check Disk I/O</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iostat -x 1  <span class="comment"># View disk I/O</span></span><br><span class="line">sudo iotop -o  <span class="comment"># See which process is reading/writing disk</span></span><br></pre></td></tr></table></figure><h3 id="5-Check-Network-Connections"><a class="header-anchor" href="#5-Check-Network-Connections">¶</a>5. Check Network Connections</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ss -tulnp  <span class="comment"># View listening ports</span></span><br><span class="line">lsof -i  <span class="comment"># View all network connections</span></span><br></pre></td></tr></table></figure><h3 id="6-Optimize-or-Terminate-Process"><a class="header-anchor" href="#6-Optimize-or-Terminate-Process">¶</a>6. Optimize or Terminate Process</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">renice -n 10 -p &lt;PID&gt;  <span class="comment"># Lower process priority</span></span><br><span class="line"><span class="built_in">kill</span> &lt;PID&gt;  <span class="comment"># Gentle terminate</span></span><br><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;  <span class="comment"># Force terminate</span></span><br></pre></td></tr></table></figure><hr><h1>Real Case: What to Do When Nginx Log File Is Accidentally Deleted</h1><h2 id="Scenario"><a class="header-anchor" href="#Scenario">¶</a>Scenario</h2><p>An ops person accidentally ran <code>rm -rf /var/log/nginx/access.log</code>, but nginx process is still running.</p><h2 id="Problem"><a class="header-anchor" href="#Problem">¶</a>Problem</h2><p>Although file was deleted, nginx process still holds file handle (under <code>/proc/&lt;pid&gt;/fd/</code>), continues writing data to “deleted file”. At this point:</p><ul><li><code>df -h</code> shows disk usage hasn’t decreased (because file still occupies space)</li><li><code>ls /var/log/nginx/</code> doesn’t show <code>access.log</code> (because directory entry was deleted)</li></ul><h2 id="Solution"><a class="header-anchor" href="#Solution">¶</a>Solution</h2><h3 id="1-Find-nginx-Process-PID"><a class="header-anchor" href="#1-Find-nginx-Process-PID">¶</a>1. Find nginx Process PID</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pidof nginx  <span class="comment"># Or ps aux | grep nginx</span></span><br></pre></td></tr></table></figure><p>Suppose main process PID is 1234.</p><h3 id="2-View-Files-Opened-by-Process"><a class="header-anchor" href="#2-View-Files-Opened-by-Process">¶</a>2. View Files Opened by Process</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -p 1234 | grep access.log</span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx  1234 root  6w  REG  8,1  123456789  /var/log/nginx/access.log (deleted)</span><br></pre></td></tr></table></figure><ul><li><code>6w</code>: File descriptor is 6, mode is <code>w</code> (write)</li><li><code>(deleted)</code>: File was deleted but process still holds handle</li></ul><h3 id="3-Recover-File"><a class="header-anchor" href="#3-Recover-File">¶</a>3. Recover File</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /proc/1234/fd/6 /var/log/nginx/access.log</span><br></pre></td></tr></table></figure><h3 id="4-Reload-nginx"><a class="header-anchor" href="#4-Reload-nginx">¶</a>4. Reload nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload  <span class="comment"># Make nginx reopen log file</span></span><br></pre></td></tr></table></figure><p><strong>Principle</strong>:</p><ul><li>Deleting file only deletes directory entry (filename); inode and data blocks remain (because process is still using it)</li><li>Via <code>/proc/&lt;pid&gt;/fd/&lt;fd&gt;</code> you can access files opened by process (even if deleted)</li><li>After <code>cp</code> copying file, reload nginx to make it reopen log file</li></ul><hr><h1>Summary and Further Reading</h1><p>This article covers the core content of Linux process and resource management:</p><ol><li>✅ Basic concepts of processes and programs (process vs program vs thread, parent-child relationships)</li><li>✅ Linux resource management overview (CPU/memory/disk/network)</li><li>✅ Buffer and Cache explained (why “out of memory” is often a misjudgment)</li><li>✅ Process monitoring toolchain (top/htop/ps/pstree/lsof/ss/iostat)</li><li>✅ Process control (kill signals, background tasks, priority adjustment)</li><li>✅ Special process states (orphan processes, zombie processes)</li><li>✅ Real cases (performance troubleshooting workflow, Nginx log recovery)</li></ol><p><strong>Further Reading</strong>:</p><ul><li>Linux Performance (Brendan Gregg): <a class="link" href="http://www.brendangregg.com/linuxperf.html">http://www.brendangregg.com/linuxperf.html<i class="fas fa-external-link-alt"></i></a></li><li><code>man proc</code>: View detailed explanation of <code>/proc</code> filesystem</li><li><code>man 7 signal</code>: View explanation of all signals</li></ul><p><strong>Next Steps</strong>:</p><ul><li><strong>《Linux Disk Management》</strong>: Learn partitioning, formatting, mounting, LVM, RAID, etc.</li><li><strong>《Linux User Management》</strong>: Learn how to manage users/groups/permissions</li></ul><hr><p><strong>By this point, you should have upgraded from “can view top” to “can quickly locate resource bottlenecks, can optimize process priorities, can handle abnormal process states.” Process and resource management is a core Linux ops skill; mastering it allows you to better troubleshoot performance issues.</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;In production troubleshooting, the most critical skill isn’t “memorizing commands” but quickly mapping symptoms to resources and processes: is CPU maxed out, is memory being consumed by cache, is disk I/O blocking, and exactly which process/file/port is slowing down the system. This post starts from basic concepts of processes/threads and parent-child relationships, explains Linux’s resource perspective (especially the meaning of buffer/cache and the “out of memory” misjudgment), then systematically organizes a commonly used monitoring and locating toolchain (&lt;code&gt;top/htop/ps/pstree/lsof&lt;/code&gt;, ports/network, I/O, load and stress testing). Then it fills in the “process control” operations: signals and background tasks, &lt;code&gt;nice/renice&lt;/code&gt; priority, orphan/zombie process causes and handling; finally, using a complete troubleshooting case (what to do when Nginx log files are accidentally deleted) to apply the “resource perspective” to practical scenarios, helping you run through a complete troubleshooting workflow. If you’re a sysadmin or need to troubleshoot performance issues, this article will upgrade you from “can view top” to “can quickly locate resource bottlenecks, can optimize process priorities, can handle abnormal process states.”&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux Package Management: apt/dpkg, yum/dnf/rpm, Building from Source</title>
    <link href="https://chenk.top/en/linux-package-management/"/>
    <id>https://chenk.top/en/linux-package-management/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-29T16:18:14.992Z</updated>
    
    <content type="html"><![CDATA[<p>Package management appears to be just “install / remove / update,” but what truly determines whether you avoid pitfalls comes down to two things: First, what exactly is in a package (executables, config, dependency libraries, service scripts) and where they land in the system; Second, how toolchain differences across distributions (Debian/Ubuntu’s <code>dpkg/apt</code> vs RHEL/CentOS’s <code>rpm/yum/dnf</code>) affect dependency resolution, version selection, and rollback strategies. This post first clarifies the basic concepts of packages and dependencies, then provides a reproducible list of common operations (including advanced usage: dependency conflict troubleshooting, version locking, downgrades, cleanup of unused packages), and adds the most common configurations for domestic environments (like switching to Aliyun mirrors, Tsinghua mirrors, verifying mirror effectiveness). Finally, it extends “installing packages” to two production-relevant paths: building from source (using Nginx as an example, explaining what configure/make/make install each do) and binary portable configuration (using Java as an example), giving you viable deployment options when facing version/dependency/network constraints.</p><span id="more"></span><h1>Basic Package Concepts: What’s Inside, Why We Need Package Managers</h1><h2 id="Package-Composition"><a class="header-anchor" href="#Package-Composition">¶</a>Package Composition</h2><p>A package bundles programs, library files, configuration files, and documentation into a single file, making installation, upgrade, and removal convenient. Packages automatically handle dependencies, simplifying software management. A standard package typically includes:</p><h3 id="1-Binary-Executables"><a class="header-anchor" href="#1-Binary-Executables">¶</a>1. Binary Executables</h3><p>Compiled program source code, generating executable binary files. Examples:</p><ul><li><code>/usr/bin/vim</code>: Text editor</li><li><code>/usr/sbin/nginx</code>: Web server</li><li><code>/usr/bin/gcc</code>: Compiler</li></ul><h3 id="2-Configuration-Files"><a class="header-anchor" href="#2-Configuration-Files">¶</a>2. Configuration Files</h3><p>Store application default configurations, usually located in <code>/etc/</code> directory. Examples:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/nginx.conf  <span class="comment"># Nginx config file</span></span><br><span class="line">/etc/mysql/my.cnf      <span class="comment"># MySQL config file</span></span><br><span class="line">/etc/ssh/sshd_config   <span class="comment"># SSH server config</span></span><br></pre></td></tr></table></figure><p><strong>Important characteristic</strong>: Package managers typically <strong>preserve your modified configuration files</strong> during upgrades (won’t overwrite), avoiding config loss.</p><h3 id="3-Shared-Libraries"><a class="header-anchor" href="#3-Shared-Libraries">¶</a>3. Shared Libraries</h3><p>Shared libraries are dynamically linked libraries that executables depend on at runtime (like Windows <code>.dll</code>), usually stored in <code>/usr/lib/</code> or <code>/lib/</code> directories. Examples:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/libssl.so             <span class="comment"># OpenSSL crypto library</span></span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6  <span class="comment"># GNU C standard library</span></span><br></pre></td></tr></table></figure><p><strong>Why shared libraries?</strong></p><ul><li>Save disk space (multiple programs share the same library)</li><li>Save memory (same library loaded only once)</li><li>Easy upgrades (upgrading library benefits all programs that depend on it)</li></ul><h3 id="4-Data-Files"><a class="header-anchor" href="#4-Data-Files">¶</a>4. Data Files</h3><p>Data required by applications, like database files, default resources, etc. Examples:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/mysql/   <span class="comment"># MySQL database storage directory</span></span><br><span class="line">/var/www/html/    <span class="comment"># Web server default site directory</span></span><br></pre></td></tr></table></figure><h3 id="5-Documentation"><a class="header-anchor" href="#5-Documentation">¶</a>5. Documentation</h3><p>Software documentation, manual pages (man pages), copyright notices, etc., usually stored in <code>/usr/share/doc/</code> directory. Examples:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/doc/nginx/README</span><br><span class="line">/usr/share/man/man1/vim.1.gz  <span class="comment"># vim man page</span></span><br></pre></td></tr></table></figure><h3 id="6-Service-Unit-Files-If-It’s-a-Service"><a class="header-anchor" href="#6-Service-Unit-Files-If-It’s-a-Service">¶</a>6. Service Unit Files (If It’s a Service)</h3><p>If it’s a background service, it will also include systemd unit files:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/systemd/system/nginx.service</span><br><span class="line">/etc/systemd/system/mysql.service</span><br></pre></td></tr></table></figure><h2 id="Why-We-Need-Package-Managers"><a class="header-anchor" href="#Why-We-Need-Package-Managers">¶</a>Why We Need Package Managers</h2><p>Without package managers, you’d need to:</p><ol><li><strong>Manually download software</strong> (find download links from official sites or third-party sites)</li><li><strong>Manually resolve dependencies</strong> (A depends on B, B depends on C, you install one by one)</li><li><strong>Manually place files</strong> (where to put executables, config, libraries)</li><li><strong>Manually uninstall</strong> (remember to delete all files when uninstalling, including config and dependencies)</li><li><strong>Manually update</strong> (check official sites for each software for new versions)</li></ol><p><strong>Core value of package managers</strong>:</p><ul><li><strong>Auto-resolve dependencies</strong>: A depends on B, installing A automatically installs B</li><li><strong>Unified installation locations</strong>: All software placed according to standards, no mess</li><li><strong>One-click uninstall</strong>: Automatically deletes all related files when uninstalling</li><li><strong>One-click update</strong>: <code>apt upgrade</code> or <code>dnf upgrade</code> updates all software</li><li><strong>Version management</strong>: Can view, lock, downgrade software versions</li><li><strong>Security</strong>: Packages are all signature-verified, reducing malicious software risk</li></ul><hr><h1>Mainstream Linux Package Managers Comparison</h1><p>Different Linux distributions use different package managers:</p><table><thead><tr><th><strong>Distribution</strong></th><th><strong>Package Format</strong></th><th><strong>Low-level Tool</strong></th><th><strong>High-level Tool</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td><strong>Debian/Ubuntu</strong></td><td>.deb</td><td>dpkg</td><td>apt, apt-get</td><td>Most popular desktop and cloud server distro</td></tr><tr><td><strong>RHEL/CentOS/Fedora</strong></td><td>.rpm</td><td>rpm</td><td>yum (old), dnf (new)</td><td>Enterprise Linux, CentOS 8+ and Fedora default to dnf</td></tr><tr><td><strong>Arch Linux</strong></td><td>.tar.zst</td><td>pacman</td><td>pacman</td><td>Rolling release, newest software versions</td></tr><tr><td><strong>Gentoo</strong></td><td>source packages</td><td>emerge</td><td>portage</td><td>Completely compiled from source, highly customizable</td></tr><tr><td><strong>openSUSE</strong></td><td>.rpm</td><td>rpm</td><td>zypper</td><td>Common in European enterprises</td></tr></tbody></table><p><strong>This article mainly covers Debian/Ubuntu’s apt/dpkg and RHEL/CentOS’s yum/dnf/rpm, as they are the most commonly used.</strong></p><hr><h1>Debian/Ubuntu Package Management: apt + dpkg</h1><h2 id="apt-vs-apt-get-vs-dpkg-v2"><a class="header-anchor" href="#apt-vs-apt-get-vs-dpkg-v2">¶</a>apt vs apt-get vs dpkg</h2><table><thead><tr><th>Tool</th><th>Description</th><th>Rating</th></tr></thead><tbody><tr><td><strong>apt</strong></td><td>High-level tool, auto-handles dependencies, user-friendly (colors, progress bars), recommended for daily use</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>apt-get</strong></td><td>Old high-level tool, same functionality as apt but plain interface, commonly used in scripts (stable output)</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>dpkg</strong></td><td>Low-level tool, directly operates .deb packages, <strong>won’t auto-handle dependencies</strong> (manual resolution needed)</td><td>⭐⭐</td></tr></tbody></table><p><strong>Recommendation</strong>: Use <code>apt</code> for daily operations, use <code>apt-get</code> in scripts (more stable output format).</p><h2 id="Common-Operations"><a class="header-anchor" href="#Common-Operations">¶</a>Common Operations</h2><h3 id="Update-Package-Source-Information"><a class="header-anchor" href="#Update-Package-Source-Information">¶</a>Update Package Source Information</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update  <span class="comment"># Download latest package list from sources</span></span><br></pre></td></tr></table></figure><p>This command only updates local package list cache, doesn’t upgrade any software.</p><h3 id="Search-for-Packages"><a class="header-anchor" href="#Search-for-Packages">¶</a>Search for Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt search nginx  <span class="comment"># Search for packages containing nginx</span></span><br><span class="line">apt-cache search nginx  <span class="comment"># Same (old command)</span></span><br></pre></td></tr></table></figure><h3 id="View-Package-Information"><a class="header-anchor" href="#View-Package-Information">¶</a>View Package Information</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt show nginx  <span class="comment"># View nginx detailed info (version, dependencies, description)</span></span><br><span class="line">apt-cache policy nginx  <span class="comment"># View nginx version and installation status</span></span><br></pre></td></tr></table></figure><h3 id="Install-Packages"><a class="header-anchor" href="#Install-Packages">¶</a>Install Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx  <span class="comment"># Install nginx</span></span><br><span class="line">sudo apt install nginx=1.18.0-0ubuntu1  <span class="comment"># Install specific version</span></span><br><span class="line">sudo apt install nginx -y  <span class="comment"># Auto-answer yes (no confirmation prompts)</span></span><br></pre></td></tr></table></figure><h3 id="Uninstall-Packages"><a class="header-anchor" href="#Uninstall-Packages">¶</a>Uninstall Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt remove nginx  <span class="comment"># Uninstall nginx (keep config files)</span></span><br><span class="line">sudo apt purge nginx   <span class="comment"># Completely uninstall nginx (delete config files)</span></span><br><span class="line">sudo apt autoremove    <span class="comment"># Delete no-longer-needed dependency packages (cleanup)</span></span><br></pre></td></tr></table></figure><p><strong>Difference</strong>:</p><ul><li><code>remove</code>: Only deletes program files, keeps config files in <code>/etc/</code> (convenient for restoring config when reinstalling later)</li><li><code>purge</code>: Deletes config files too (complete uninstall)</li></ul><h3 id="Upgrade-Packages"><a class="header-anchor" href="#Upgrade-Packages">¶</a>Upgrade Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt upgrade  <span class="comment"># Upgrade all upgradable packages (won&#x27;t remove installed packages)</span></span><br><span class="line">sudo apt full-upgrade  <span class="comment"># Upgrade all packages (can remove old packages if necessary)</span></span><br><span class="line">sudo apt dist-upgrade  <span class="comment"># Same as full-upgrade (old command)</span></span><br></pre></td></tr></table></figure><p><strong>Difference</strong>:</p><ul><li><code>upgrade</code>: Conservative upgrade, won’t remove installed packages</li><li><code>full-upgrade</code>: Aggressive upgrade, can delete or install packages if necessary (like dependency changes)</li></ul><h3 id="View-Installed-Packages"><a class="header-anchor" href="#View-Installed-Packages">¶</a>View Installed Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dpkg -l  <span class="comment"># List all installed packages</span></span><br><span class="line">dpkg -l | grep nginx  <span class="comment"># Check if nginx is installed</span></span><br><span class="line">apt list --installed  <span class="comment"># Same (apt command)</span></span><br></pre></td></tr></table></figure><h3 id="View-Files-Installed-by-Package"><a class="header-anchor" href="#View-Files-Installed-by-Package">¶</a>View Files Installed by Package</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -L nginx  <span class="comment"># See what files nginx installed</span></span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/nginx</span><br><span class="line">/etc/nginx/nginx.conf</span><br><span class="line">/usr/share/doc/nginx/README</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="Find-Which-Package-a-File-Belongs-To"><a class="header-anchor" href="#Find-Which-Package-a-File-Belongs-To">¶</a>Find Which Package a File Belongs To</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -S /usr/sbin/nginx  <span class="comment"># See which package /usr/sbin/nginx belongs to</span></span><br></pre></td></tr></table></figure><p>Output: <code>nginx-core: /usr/sbin/nginx</code></p><h3 id="Manually-Install-deb-Package"><a class="header-anchor" href="#Manually-Install-deb-Package">¶</a>Manually Install .deb Package</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i package.deb  <span class="comment"># Install .deb package (won&#x27;t auto-resolve dependencies)</span></span><br><span class="line">sudo apt install -f  <span class="comment"># Fix dependencies (if above errors)</span></span><br></pre></td></tr></table></figure><p><strong>Better way</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ./package.deb  <span class="comment"># apt will auto-resolve dependencies</span></span><br></pre></td></tr></table></figure><h2 id="Advanced-Usage"><a class="header-anchor" href="#Advanced-Usage">¶</a>Advanced Usage</h2><h3 id="Lock-Package-Version-Prevent-Upgrade"><a class="header-anchor" href="#Lock-Package-Version-Prevent-Upgrade">¶</a>Lock Package Version (Prevent Upgrade)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-mark hold nginx  <span class="comment"># Lock nginx, prevent upgrade</span></span><br><span class="line">apt-mark showhold  <span class="comment"># View locked packages</span></span><br><span class="line">sudo apt-mark unhold nginx  <span class="comment"># Unlock</span></span><br></pre></td></tr></table></figure><h3 id="Downgrade-Package-Version"><a class="header-anchor" href="#Downgrade-Package-Version">¶</a>Downgrade Package Version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. View available versions</span></span><br><span class="line">apt-cache policy nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Install specific version</span></span><br><span class="line">sudo apt install nginx=1.18.0-0ubuntu1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Lock version (prevent upgrade)</span></span><br><span class="line">sudo apt-mark hold nginx</span><br></pre></td></tr></table></figure><h3 id="Clean-Cache-Free-Disk-Space"><a class="header-anchor" href="#Clean-Cache-Free-Disk-Space">¶</a>Clean Cache (Free Disk Space)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt clean  <span class="comment"># Delete all downloaded .deb package cache (in /var/cache/apt/archives/)</span></span><br><span class="line">sudo apt autoclean  <span class="comment"># Only delete outdated package cache</span></span><br><span class="line">sudo apt autoremove  <span class="comment"># Delete no-longer-needed dependency packages</span></span><br></pre></td></tr></table></figure><p><strong>Combined usage</strong> (clean disk space):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt autoremove &amp;&amp; sudo apt autoclean</span><br></pre></td></tr></table></figure><hr><h1>RHEL/CentOS Package Management: yum/dnf + rpm</h1><h2 id="yum-vs-dnf-vs-rpm-v2"><a class="header-anchor" href="#yum-vs-dnf-vs-rpm-v2">¶</a>yum vs dnf vs rpm</h2><table><thead><tr><th>Tool</th><th>Description</th><th>Rating</th></tr></thead><tbody><tr><td><strong>dnf</strong></td><td>New generation high-level tool (CentOS 8+, Fedora), auto-handles dependencies, faster, recommended</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>yum</strong></td><td>Old high-level tool (CentOS 7 and earlier), same functionality as dnf but slower</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>rpm</strong></td><td>Low-level tool, directly operates .rpm packages, <strong>won’t auto-handle dependencies</strong> (manual resolution needed)</td><td>⭐⭐</td></tr></tbody></table><p><strong>Recommendation</strong>: Use <code>dnf</code> for CentOS 8+ and Fedora, use <code>yum</code> for CentOS 7.</p><h2 id="Common-Operations-Using-dnf-as-Example-yum-Commands-Are-Almost-Identical"><a class="header-anchor" href="#Common-Operations-Using-dnf-as-Example-yum-Commands-Are-Almost-Identical">¶</a>Common Operations (Using dnf as Example, yum Commands Are Almost Identical)</h2><h3 id="Update-Package-Source-Information-v2"><a class="header-anchor" href="#Update-Package-Source-Information-v2">¶</a>Update Package Source Information</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf makecache  <span class="comment"># Download latest package list from sources</span></span><br><span class="line">sudo dnf check-update  <span class="comment"># Check which packages can be upgraded</span></span><br></pre></td></tr></table></figure><h3 id="Search-for-Packages-v2"><a class="header-anchor" href="#Search-for-Packages-v2">¶</a>Search for Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf search nginx  <span class="comment"># Search for packages containing nginx</span></span><br></pre></td></tr></table></figure><h3 id="View-Package-Information-v2"><a class="header-anchor" href="#View-Package-Information-v2">¶</a>View Package Information</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf info nginx  <span class="comment"># View nginx detailed info (version, dependencies, description)</span></span><br></pre></td></tr></table></figure><h3 id="Install-Packages-v2"><a class="header-anchor" href="#Install-Packages-v2">¶</a>Install Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install nginx  <span class="comment"># Install nginx</span></span><br><span class="line">sudo dnf install nginx-1.20.1  <span class="comment"># Install specific version</span></span><br><span class="line">sudo dnf install nginx -y  <span class="comment"># Auto-answer yes</span></span><br></pre></td></tr></table></figure><h3 id="Uninstall-Packages-v2"><a class="header-anchor" href="#Uninstall-Packages-v2">¶</a>Uninstall Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf remove nginx  <span class="comment"># Uninstall nginx</span></span><br><span class="line">sudo dnf autoremove  <span class="comment"># Delete no-longer-needed dependency packages</span></span><br></pre></td></tr></table></figure><h3 id="Upgrade-Packages-v2"><a class="header-anchor" href="#Upgrade-Packages-v2">¶</a>Upgrade Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf upgrade  <span class="comment"># Upgrade all upgradable packages</span></span><br><span class="line">sudo dnf upgrade nginx  <span class="comment"># Only upgrade nginx</span></span><br></pre></td></tr></table></figure><h3 id="View-Installed-Packages-v2"><a class="header-anchor" href="#View-Installed-Packages-v2">¶</a>View Installed Packages</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa  <span class="comment"># List all installed packages</span></span><br><span class="line">rpm -qa | grep nginx  <span class="comment"># Check if nginx is installed</span></span><br><span class="line">dnf list installed  <span class="comment"># Same (dnf command)</span></span><br></pre></td></tr></table></figure><h3 id="View-Files-Installed-by-Package-v2"><a class="header-anchor" href="#View-Files-Installed-by-Package-v2">¶</a>View Files Installed by Package</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql nginx  <span class="comment"># See what files nginx installed</span></span><br></pre></td></tr></table></figure><h3 id="Find-Which-Package-a-File-Belongs-To-v2"><a class="header-anchor" href="#Find-Which-Package-a-File-Belongs-To-v2">¶</a>Find Which Package a File Belongs To</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qf /usr/sbin/nginx  <span class="comment"># See which package /usr/sbin/nginx belongs to</span></span><br></pre></td></tr></table></figure><h3 id="Manually-Install-rpm-Package"><a class="header-anchor" href="#Manually-Install-rpm-Package">¶</a>Manually Install .rpm Package</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo rpm -ivh package.rpm  <span class="comment"># Install .rpm package (won&#x27;t auto-resolve dependencies)</span></span><br><span class="line">sudo dnf install package.rpm  <span class="comment"># Better way (will auto-resolve dependencies)</span></span><br></pre></td></tr></table></figure><h2 id="Advanced-Usage-v2"><a class="header-anchor" href="#Advanced-Usage-v2">¶</a>Advanced Usage</h2><h3 id="Lock-Package-Version-Prevent-Upgrade-v2"><a class="header-anchor" href="#Lock-Package-Version-Prevent-Upgrade-v2">¶</a>Lock Package Version (Prevent Upgrade)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install <span class="string">&#x27;dnf-command(versionlock)&#x27;</span>  <span class="comment"># Install versionlock plugin</span></span><br><span class="line">sudo dnf versionlock add nginx  <span class="comment"># Lock nginx</span></span><br><span class="line">dnf versionlock list  <span class="comment"># View locked packages</span></span><br><span class="line">sudo dnf versionlock delete nginx  <span class="comment"># Unlock</span></span><br></pre></td></tr></table></figure><h3 id="Downgrade-Package-Version-v2"><a class="header-anchor" href="#Downgrade-Package-Version-v2">¶</a>Downgrade Package Version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. View available versions</span></span><br><span class="line">dnf list --showduplicates nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Downgrade to specific version</span></span><br><span class="line">sudo dnf downgrade nginx-1.18.0</span><br></pre></td></tr></table></figure><h3 id="Clean-Cache"><a class="header-anchor" href="#Clean-Cache">¶</a>Clean Cache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf clean all  <span class="comment"># Delete all cache</span></span><br><span class="line">sudo dnf autoremove  <span class="comment"># Delete no-longer-needed dependency packages</span></span><br></pre></td></tr></table></figure><hr><h1>Configure Domestic Mirrors (Speed Up Downloads)</h1><h2 id="Debian-Ubuntu-Configure-Aliyun-Mirror"><a class="header-anchor" href="#Debian-Ubuntu-Configure-Aliyun-Mirror">¶</a>Debian/Ubuntu Configure Aliyun Mirror</h2><h3 id="1-Backup-Original-Sources"><a class="header-anchor" href="#1-Backup-Original-Sources">¶</a>1. Backup Original Sources</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></table></figure><h3 id="2-Replace-with-Aliyun-Mirror"><a class="header-anchor" href="#2-Replace-with-Aliyun-Mirror">¶</a>2. Replace with Aliyun Mirror</h3><p><strong>Method 1: Auto-replace</strong> (Recommended)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*archive.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*security.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p><strong>Method 2: Manual edit</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>Delete original content, replace with (Ubuntu 22.04 example):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><p><strong>Version codenames</strong>:</p><ul><li>Ubuntu 22.04: <code>jammy</code></li><li>Ubuntu 20.04: <code>focal</code></li><li>Ubuntu 18.04: <code>bionic</code></li></ul><h3 id="3-Update-Package-Sources"><a class="header-anchor" href="#3-Update-Package-Sources">¶</a>3. Update Package Sources</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br></pre></td></tr></table></figure><h3 id="4-Verify-Effectiveness"><a class="header-anchor" href="#4-Verify-Effectiveness">¶</a>4. Verify Effectiveness</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/apt/sources.list | grep mirrors.aliyun.com</span><br></pre></td></tr></table></figure><p>If you see <code>mirrors.aliyun.com</code>, configuration succeeded.</p><h2 id="CentOS-RHEL-Configure-Aliyun-Mirror"><a class="header-anchor" href="#CentOS-RHEL-Configure-Aliyun-Mirror">¶</a>CentOS/RHEL Configure Aliyun Mirror</h2><h3 id="1-Backup-Original-Sources-v2"><a class="header-anchor" href="#1-Backup-Original-Sources-v2">¶</a>1. Backup Original Sources</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</span><br></pre></td></tr></table></figure><h3 id="2-Download-Aliyun-Mirror-Config"><a class="header-anchor" href="#2-Download-Aliyun-Mirror-Config">¶</a>2. Download Aliyun Mirror Config</h3><p><strong>CentOS 7</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br></pre></td></tr></table></figure><p><strong>CentOS 8</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo</span><br></pre></td></tr></table></figure><h3 id="3-Clean-and-Update-Cache"><a class="header-anchor" href="#3-Clean-and-Update-Cache">¶</a>3. Clean and Update Cache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf clean all</span><br><span class="line">sudo dnf makecache</span><br></pre></td></tr></table></figure><h3 id="4-Verify-Effectiveness-v2"><a class="header-anchor" href="#4-Verify-Effectiveness-v2">¶</a>4. Verify Effectiveness</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf repolist</span><br></pre></td></tr></table></figure><p>If you see <code>mirrors.aliyun.com</code>, configuration succeeded.</p><h2 id="Other-Domestic-Mirrors"><a class="header-anchor" href="#Other-Domestic-Mirrors">¶</a>Other Domestic Mirrors</h2><ul><li><strong>Tsinghua University Mirror</strong>: <a class="link" href="https://mirrors.tuna.tsinghua.edu.cn/">https://mirrors.tuna.tsinghua.edu.cn/<i class="fas fa-external-link-alt"></i></a></li><li><strong>USTC Mirror</strong>: <a class="link" href="https://mirrors.ustc.edu.cn/">https://mirrors.ustc.edu.cn/<i class="fas fa-external-link-alt"></i></a></li><li><strong>NetEase Mirror</strong>: <a class="link" href="http://mirrors.163.com/">http://mirrors.163.com/<i class="fas fa-external-link-alt"></i></a></li></ul><p><strong>Configuration method is similar, just replace URLs with corresponding mirror sites.</strong></p><hr><h1>Building from Source: From configure to make install</h1><p>Sometimes package repository versions are too old, or you need custom compilation options (like enabling a module, optimizing performance), requiring building from source.</p><h2 id="The-Three-Step-Build-Process"><a class="header-anchor" href="#The-Three-Step-Build-Process">¶</a>The Three-Step Build Process</h2><ol><li><strong><code>./configure</code></strong>: Check system environment, generate Makefile</li><li><strong><code>make</code></strong>: Compile source code according to Makefile</li><li><strong><code>make install</code></strong>: Install compiled files to system</li></ol><h2 id="Hands-On-Compiling-Nginx-Tengine"><a class="header-anchor" href="#Hands-On-Compiling-Nginx-Tengine">¶</a>Hands-On: Compiling Nginx (Tengine)</h2><p><strong>Tengine</strong> is Taobao’s Nginx fork with enhanced performance and features.</p><h3 id="1-Install-Build-Dependencies"><a class="header-anchor" href="#1-Install-Build-Dependencies">¶</a>1. Install Build Dependencies</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install build-essential libpcre3 libpcre3-dev libssl-dev zlib1g-dev  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf install gcc make pcre-devel openssl-devel zlib-devel  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h3 id="2-Download-Source-Code"><a class="header-anchor" href="#2-Download-Source-Code">¶</a>2. Download Source Code</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://tengine.taobao.org/download/tengine-2.3.3.tar.gz</span><br><span class="line">tar -zxvf tengine-2.3.3.tar.gz</span><br><span class="line"><span class="built_in">cd</span> tengine-2.3.3</span><br></pre></td></tr></table></figure><h3 id="3-Configure-Build-Parameters-configure"><a class="header-anchor" href="#3-Configure-Build-Parameters-configure">¶</a>3. Configure Build Parameters (<code>./configure</code>)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">  --prefix=/usr/local/nginx \</span><br><span class="line">  --with-http_ssl_module \</span><br><span class="line">  --with-http_v2_module \</span><br><span class="line">  --with-http_realip_module \</span><br><span class="line">  --with-http_gzip_static_module</span><br></pre></td></tr></table></figure><p><strong>Common parameters</strong>:</p><ul><li><code>--prefix=PATH</code>: Installation path (default <code>/usr/local/nginx</code>)</li><li><code>--with-http_ssl_module</code>: Enable HTTPS support</li><li><code>--with-http_v2_module</code>: Enable HTTP/2 support</li><li><code>--with-http_realip_module</code>: Get real client IP (suitable for reverse proxy)</li></ul><p><strong>What does <code>./configure</code> do?</strong></p><ul><li>Checks if system has required libraries (like OpenSSL, PCRE, zlib)</li><li>Generates <code>Makefile</code> (build configuration file) based on your parameters</li><li>If dependencies are missing, will error and prompt installation</li></ul><h3 id="4-Compile-make"><a class="header-anchor" href="#4-Compile-make">¶</a>4. Compile (<code>make</code>)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j$(<span class="built_in">nproc</span>)  <span class="comment"># Use all CPU cores for parallel compilation (speedup)</span></span><br></pre></td></tr></table></figure><p><strong>What does <code>make</code> do?</strong></p><ul><li>Reads <code>Makefile</code>, compiles source code in order</li><li>Generates executable files (like <code>objs/nginx</code>)</li><li>If compilation fails, check for missing dependencies or incorrect parameters</li></ul><h3 id="5-Install-make-install"><a class="header-anchor" href="#5-Install-make-install">¶</a>5. Install (<code>make install</code>)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p><strong>What does <code>make install</code> do?</strong></p><ul><li>Copies compiled files to directory specified by <code>--prefix</code> (like <code>/usr/local/nginx</code>)</li><li>Creates necessary directory structure (<code>conf/</code>, <code>logs/</code>, <code>html/</code>, <code>sbin/</code>)</li><li>Won’t create systemd service file (needs manual creation)</li></ul><h3 id="6-Start-Nginx"><a class="header-anchor" href="#6-Start-Nginx">¶</a>6. Start Nginx</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx  <span class="comment"># Start</span></span><br><span class="line">/usr/local/nginx/sbin/nginx -s stop  <span class="comment"># Stop</span></span><br><span class="line">/usr/local/nginx/sbin/nginx -s reload  <span class="comment"># Reload config</span></span><br></pre></td></tr></table></figure><h3 id="7-Create-systemd-Service-Optional"><a class="header-anchor" href="#7-Create-systemd-Service-Optional">¶</a>7. Create systemd Service (Optional)</h3><p>Create <code>/etc/systemd/system/nginx.service</code>:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Nginx HTTP Server</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="attr">ExecReload</span>=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><p>Then enable:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br><span class="line">sudo systemctl start nginx</span><br></pre></td></tr></table></figure><hr><h1>Binary Portable Configuration: Java Example</h1><p>Some software (like Java, Go, Node.js) provides pre-compiled binary packages, extract-and-use, no installation needed.</p><h2 id="Hands-On-Configure-Java-Environment"><a class="header-anchor" href="#Hands-On-Configure-Java-Environment">¶</a>Hands-On: Configure Java Environment</h2><h3 id="1-Download-JDK"><a class="header-anchor" href="#1-Download-JDK">¶</a>1. Download JDK</h3><p>Download JDK from Oracle official site or open-source mirrors (like <code>jdk-17_linux-x64_bin.tar.gz</code>).</p><h3 id="2-Extract-to-opt"><a class="header-anchor" href="#2-Extract-to-opt">¶</a>2. Extract to <code>/opt</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo tar -zxvf jdk-17_linux-x64_bin.tar.gz -C /opt</span><br><span class="line">sudo <span class="built_in">mv</span> /opt/jdk-17* /opt/jdk-17  <span class="comment"># Rename to shorter path</span></span><br></pre></td></tr></table></figure><h3 id="3-Configure-Environment-Variables"><a class="header-anchor" href="#3-Configure-Environment-Variables">¶</a>3. Configure Environment Variables</h3><p>Edit <code>~/.bashrc</code> (or <code>/etc/profile</code> for all users):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/jdk-17</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure><h3 id="4-Make-Config-Effective"><a class="header-anchor" href="#4-Make-Config-Effective">¶</a>4. Make Config Effective</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="5-Verify"><a class="header-anchor" href="#5-Verify">¶</a>5. Verify</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -version</span><br><span class="line">javac -version</span><br></pre></td></tr></table></figure><p>If version numbers display, configuration succeeded.</p><hr><h1>Package Management Best Practices</h1><h2 id="1-Regularly-Update-System"><a class="header-anchor" href="#1-Regularly-Update-System">¶</a>1. Regularly Update System</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf upgrade -y  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><p><strong>Frequency</strong>: Recommend updating weekly or monthly to promptly fix security vulnerabilities.</p><h2 id="2-Clean-Unused-Packages-and-Cache"><a class="header-anchor" href="#2-Clean-Unused-Packages-and-Cache">¶</a>2. Clean Unused Packages and Cache</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt autoremove &amp;&amp; sudo apt autoclean  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf autoremove &amp;&amp; sudo dnf clean all  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h2 id="3-Lock-Critical-Software-Versions"><a class="header-anchor" href="#3-Lock-Critical-Software-Versions">¶</a>3. Lock Critical Software Versions</h2><p>If upgrading某个软件 might cause compatibility issues (like databases, kernels), recommend locking version:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-mark hold mysql-server  <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">sudo dnf versionlock add mysql-server  <span class="comment"># CentOS/RHEL</span></span><br></pre></td></tr></table></figure><h2 id="4-Don’t-Mix-Package-Managers-and-Compiled-Installations"><a class="header-anchor" href="#4-Don’t-Mix-Package-Managers-and-Compiled-Installations">¶</a>4. Don’t Mix Package Managers and Compiled Installations</h2><p><strong>Problem</strong>: If you install nginx with apt, then also install nginx compiled from source, conflicts occur (two nginx might listen on same port, config file locations differ).</p><p><strong>Recommendation</strong>:</p><ul><li>Prefer package manager (apt/dnf) installation (easy to update and uninstall)</li><li>Only build from source when package manager version is too old or lacks features</li><li>If building from source, recommend installing to <code>/opt</code> or <code>/usr/local</code> (avoid path conflicts with package manager)</li></ul><h2 id="5-Backup-Important-Configs"><a class="header-anchor" href="#5-Backup-Important-Configs">¶</a>5. Backup Important Configs</h2><p>Backup before modifying config files:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak</span><br></pre></td></tr></table></figure><h2 id="6-Use-Virtual-Environments-Python-Node-js"><a class="header-anchor" href="#6-Use-Virtual-Environments-Python-Node-js">¶</a>6. Use Virtual Environments (Python/Node.js)</h2><p>Python and Node.js have their own package managers (pip/npm), recommend using virtual environments to isolate project dependencies:</p><ul><li><strong>Python</strong>: <code>python3 -m venv venv</code></li><li><strong>Node.js</strong>: <code>nvm</code> or <code>n</code> to manage Node.js versions</li></ul><hr><h1>Summary and Further Reading</h1><p>This article covers the core content of Linux package management:</p><ol><li>✅ Basic package concepts (what’s in a package, why we need package managers)</li><li>✅ Debian/Ubuntu package management (apt/dpkg common operations and advanced usage)</li><li>✅ RHEL/CentOS package management (yum/dnf/rpm common operations and advanced usage)</li><li>✅ Configure domestic mirrors (Aliyun mirror, Tsinghua mirror)</li><li>✅ Building from source (using Nginx as example, explaining configure/make/make install)</li><li>✅ Binary portable configuration (using Java as example)</li><li>✅ Package management best practices (cleanup, version locking, avoiding conflicts)</li></ol><p><strong>Further Reading</strong>:</p><ul><li>Debian Package Management Manual: <a class="link" href="https://www.debian.org/doc/manuals/debian-reference/ch02">https://www.debian.org/doc/manuals/debian-reference/ch02<i class="fas fa-external-link-alt"></i></a></li><li>RPM Packaging Guide: <a class="link" href="https://rpm-packaging-guide.github.io/">https://rpm-packaging-guide.github.io/<i class="fas fa-external-link-alt"></i></a></li><li>DNF Official Documentation: <a class="link" href="https://dnf.readthedocs.io/">https://dnf.readthedocs.io/<i class="fas fa-external-link-alt"></i></a></li></ul><p><strong>Next Steps</strong>:</p><ul><li><strong>《Linux Process and Resource Management》</strong>: Learn how to monitor and limit process CPU/memory usage</li><li><strong>《Linux User Management》</strong>: Learn how to manage users/groups/permissions</li></ul><hr><p><strong>By this point, you should have upgraded from “can install packages” to “can configure mirrors, can build from source, can troubleshoot dependency conflicts.” Package management is a fundamental Linux operations skill; mastering it allows you to better manage servers.</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Package management appears to be just “install / remove / update,” but what truly determines whether you avoid pitfalls comes down to two things: First, what exactly is in a package (executables, config, dependency libraries, service scripts) and where they land in the system; Second, how toolchain differences across distributions (Debian/Ubuntu’s &lt;code&gt;dpkg/apt&lt;/code&gt; vs RHEL/CentOS’s &lt;code&gt;rpm/yum/dnf&lt;/code&gt;) affect dependency resolution, version selection, and rollback strategies. This post first clarifies the basic concepts of packages and dependencies, then provides a reproducible list of common operations (including advanced usage: dependency conflict troubleshooting, version locking, downgrades, cleanup of unused packages), and adds the most common configurations for domestic environments (like switching to Aliyun mirrors, Tsinghua mirrors, verifying mirror effectiveness). Finally, it extends “installing packages” to two production-relevant paths: building from source (using Nginx as an example, explaining what configure/make/make install each do) and binary portable configuration (using Java as an example), giving you viable deployment options when facing version/dependency/network constraints.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux 文件操作深入解析</title>
    <link href="https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/"/>
    <id>https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/</id>
    <published>2025-01-17T16:00:00.000Z</published>
    <updated>2026-01-29T16:43:50.319Z</updated>
    
    <content type="html"><![CDATA[<p>在命令行里真正拉开效率差距的能力，不是会多少命令，而是能不能把命令&quot;拼起来&quot;——把小工具串成一条清晰的数据流。管道符 <code>|</code> 正是 Unix 哲学的核心：让每个小工具只做一件事（grep 只过滤、awk 只提取字段、sort 只排序），然后把它们串成一条可读可调试的流水线。本文从数据流模型（stdin/stdout/stderr）讲起，系统梳理管道与重定向的语义差异（<code>&gt;</code>、<code>&gt;&gt;</code>、<code>2&gt;</code>、<code>2&gt;&amp;1</code>、<code>&lt;</code> 分别干什么），然后补齐日志排查、文本过滤、统计汇总、批量处理里的典型套路（什么时候该用 <code>grep/awk/sed/sort/uniq/wc/cut/tr</code>，怎么逐层缩小范围），并用实战案例（Nginx 日志分析、批量文件操作、安全删除）把&quot;空格与换行&quot;这类坑补上（<code>find -print0</code> + <code>xargs -0</code> 的正确用法）。你读完之后应该能把很多&quot;要写脚本&quot;的小需求，直接用一两行可读的命令解决，并且更容易看懂别人写的 one-liner。</p><span id="more"></span><h1>数据流模型：stdin/stdout/stderr 与文件描述符</h1><h2 id="三个标准流"><a class="header-anchor" href="#三个标准流">¶</a>三个标准流</h2><p>每个 Linux 进程都有三个标准流：</p><table><thead><tr><th>流</th><th>文件描述符</th><th>默认行为</th><th>示例</th></tr></thead><tbody><tr><td><strong>stdin</strong></td><td>0</td><td>从键盘读取输入</td><td><code>cat</code>（不带参数时等待用户输入）</td></tr><tr><td><strong>stdout</strong></td><td>1</td><td>输出到屏幕</td><td><code>echo &quot;hello&quot;</code></td></tr><tr><td><strong>stderr</strong></td><td>2</td><td>错误输出到屏幕</td><td><code>ls /nonexistent 2&gt;&amp;1</code></td></tr></tbody></table><p><strong>为什么要分 stdout 和 stderr？</strong></p><ul><li>正常输出和错误输出可以分别处理（如正常输出保存到文件，错误输出显示在屏幕）</li><li>管道 <code>|</code> 只传递 stdout（不传递 stderr），这样错误信息不会污染数据流</li></ul><p><strong>示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /nonexistent  <span class="comment"># 错误信息输出到 stderr（屏幕）</span></span><br><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt; err.log  <span class="comment"># 错误信息重定向到 err.log</span></span><br><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt;&amp;1  <span class="comment"># stderr 重定向到 stdout（合并到同一个流）</span></span><br></pre></td></tr></table></figure><h2 id="文件描述符（File-Descriptor-FD）"><a class="header-anchor" href="#文件描述符（File-Descriptor-FD）">¶</a>文件描述符（File Descriptor, FD）</h2><p>文件描述符是进程打开文件时的&quot;句柄&quot;，用整数表示：</p><ul><li><code>0</code>：stdin</li><li><code>1</code>：stdout</li><li><code>2</code>：stderr</li><li><code>3+</code>：进程自己打开的文件</li></ul><p><strong>查看进程打开的文件描述符</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /proc/$$/fd  <span class="comment"># $$ 是当前 shell 的 PID</span></span><br></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lrwx------ 1 user user 0 /proc/12345/fd/0 -&gt; /dev/pts/0  # stdin</span><br><span class="line">lrwx------ 1 user user 0 /proc/12345/fd/1 -&gt; /dev/pts/0  # stdout</span><br><span class="line">lrwx------ 1 user user 0 /proc/12345/fd/2 -&gt; /dev/pts/0  # stderr</span><br></pre></td></tr></table></figure><hr><h1>重定向：控制数据流的去向</h1><h2 id="输出重定向（stdout）"><a class="header-anchor" href="#输出重定向（stdout）">¶</a>输出重定向（stdout）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; file.txt  <span class="comment"># 覆盖写入（文件存在会被清空）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;world&quot;</span> &gt;&gt; file.txt  <span class="comment"># 追加写入（在文件末尾追加）</span></span><br></pre></td></tr></table></figure><p><strong>常见用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l &gt; filelist.txt  <span class="comment"># 保存文件列表</span></span><br><span class="line"><span class="built_in">date</span> &gt;&gt; log.txt  <span class="comment"># 追加时间戳到日志</span></span><br></pre></td></tr></table></figure><h2 id="错误输出重定向（stderr）"><a class="header-anchor" href="#错误输出重定向（stderr）">¶</a>错误输出重定向（stderr）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt; err.log  <span class="comment"># 错误输出重定向到 err.log</span></span><br><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt;&gt; err.log  <span class="comment"># 错误输出追加到 err.log</span></span><br></pre></td></tr></table></figure><h2 id="同时重定向-stdout-和-stderr"><a class="header-anchor" href="#同时重定向-stdout-和-stderr">¶</a>同时重定向 stdout 和 stderr</h2><h3 id="方法-1：2-1（传统写法）"><a class="header-anchor" href="#方法-1：2-1（传统写法）">¶</a>方法 1：<code>2&gt;&amp;1</code>（传统写法）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &gt; output.log 2&gt;&amp;1  <span class="comment"># stdout 和 stderr 都重定向到 output.log</span></span><br></pre></td></tr></table></figure><p><strong>顺序很重要</strong>：</p><ul><li><code>&gt; output.log</code> 先把 stdout 重定向到 output.log</li><li><code>2&gt;&amp;1</code> 再把 stderr 重定向到 stdout 的位置（也就是 output.log）</li></ul><p><strong>错误写法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> 2&gt;&amp;1 &gt; output.log  <span class="comment"># 错误！stderr 先重定向到 stdout（屏幕），然后 stdout 再重定向到文件</span></span><br></pre></td></tr></table></figure><h3 id="方法-2：-（现代写法，推荐）"><a class="header-anchor" href="#方法-2：-（现代写法，推荐）">¶</a>方法 2：<code>&amp;&gt;</code>（现代写法，推荐）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &amp;&gt; output.log  <span class="comment"># stdout 和 stderr 都重定向到 output.log</span></span><br><span class="line"><span class="built_in">command</span> &amp;&gt;&gt; output.log  <span class="comment"># 追加模式</span></span><br></pre></td></tr></table></figure><h2 id="丢弃输出（-dev-null）"><a class="header-anchor" href="#丢弃输出（-dev-null）">¶</a>丢弃输出（/dev/null）</h2><p><code>/dev/null</code> 是一个特殊的&quot;黑洞&quot;文件，写入的数据会被丢弃。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &gt; /dev/null  <span class="comment"># 丢弃 stdout</span></span><br><span class="line"><span class="built_in">command</span> 2&gt; /dev/null  <span class="comment"># 丢弃 stderr</span></span><br><span class="line"><span class="built_in">command</span> &amp;&gt; /dev/null  <span class="comment"># 丢弃 stdout 和 stderr</span></span><br></pre></td></tr></table></figure><p><strong>使用场景</strong>：</p><ul><li>不想看到命令的输出（如定时任务里的脚本）</li><li>只关心命令是否成功（通过 <code>$?</code> 判断退出码）</li></ul><h2 id="输入重定向（stdin）"><a class="header-anchor" href="#输入重定向（stdin）">¶</a>输入重定向（stdin）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> &lt; input.txt  <span class="comment"># 从 input.txt 读取输入</span></span><br></pre></td></tr></table></figure><p><strong>Here-document（多行输入）</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; config.txt</span></span><br><span class="line"><span class="string">line 1</span></span><br><span class="line"><span class="string">line 2</span></span><br><span class="line"><span class="string">line 3</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>Here-string（单行输入）</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;error&quot;</span> &lt;&lt;&lt; <span class="string">&quot;ERROR: something bad&quot;</span></span><br></pre></td></tr></table></figure><hr><h1>管道符：把命令串起来</h1><h2 id="管道的核心思想"><a class="header-anchor" href="#管道的核心思想">¶</a>管道的核心思想</h2><p><strong>Unix 哲学</strong>：每个工具只做一件事，做好一件事，然后通过管道组合起来。</p><p><strong>示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> access.log | grep <span class="string">&quot;404&quot;</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><p>拆解：</p><ol><li><code>cat access.log</code>：输出日志内容（stdout）</li><li><code>grep &quot;404&quot;</code>：从 stdin 读取，过滤出包含 “404” 的行（stdout）</li><li><code>wc -l</code>：从 stdin 读取，统计行数（stdout）</li></ol><p><strong>为什么这么设计？</strong></p><ul><li>避免临时文件（数据在内存里流动，不写硬盘）</li><li>可读性强（每个步骤都很清晰）</li><li>易调试（可以逐步加管道，看每一步的输出）</li></ul><h2 id="调试管道：使用-tee"><a class="header-anchor" href="#调试管道：使用-tee">¶</a>调试管道：使用 tee</h2><p><code>tee</code> 可以把数据同时输出到屏幕和文件（类似&quot;三通管&quot;）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> access.log | grep <span class="string">&quot;404&quot;</span> | <span class="built_in">tee</span> filtered.log | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><ul><li><code>tee filtered.log</code>：把 grep 的输出保存到 filtered.log，同时传递给下一个命令</li><li>这样你可以看到中间结果，方便调试</li></ul><hr><h1>文本处理工具链：grep/awk/sed/cut/tr/sort/uniq</h1><h2 id="grep：过滤行"><a class="header-anchor" href="#grep：过滤行">¶</a>grep：过滤行</h2><p><code>grep</code> 是最常用的文本过滤工具，用于查找匹配的行。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;pattern&quot;</span> file  <span class="comment"># 在文件中查找匹配 pattern 的行</span></span><br><span class="line"><span class="built_in">command</span> | grep <span class="string">&quot;pattern&quot;</span>  <span class="comment"># 在命令输出中查找</span></span><br></pre></td></tr></table></figure><p><strong>常用参数</strong>：</p><ul><li><code>-i</code>：忽略大小写</li><li><code>-v</code>：反向匹配（只显示不包含 pattern 的行）</li><li><code>-n</code>：显示行号</li><li><code>-A N</code>：显示匹配行及后面 N 行（After）</li><li><code>-B N</code>：显示匹配行及前面 N 行（Before）</li><li><code>-C N</code>：显示匹配行及前后各 N 行（Context）</li><li><code>-E</code>：扩展正则表达式（支持 <code>|</code>、<code>+</code>、<code>?</code> 等）</li><li><code>-r</code>：递归搜索目录</li></ul><p><strong>实战示例</strong>：</p><h3 id="1-查看日志中的错误"><a class="header-anchor" href="#1-查看日志中的错误">¶</a>1. 查看日志中的错误</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -i <span class="string">&quot;error&quot;</span> /var/log/syslog  <span class="comment"># 忽略大小写查找 error</span></span><br><span class="line">grep -E <span class="string">&quot;error|fail|timeout&quot;</span> /var/log/syslog  <span class="comment"># 查找多个关键词</span></span><br></pre></td></tr></table></figure><h3 id="2-查看错误的上下文"><a class="header-anchor" href="#2-查看错误的上下文">¶</a>2. 查看错误的上下文</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -C 3 <span class="string">&quot;OutOfMemoryError&quot;</span> app.log  <span class="comment"># 显示错误前后各 3 行</span></span><br></pre></td></tr></table></figure><h3 id="3-递归搜索目录"><a class="header-anchor" href="#3-递归搜索目录">¶</a>3. 递归搜索目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -r <span class="string">&quot;TODO&quot;</span> /srv/project  <span class="comment"># 在项目目录中递归查找 TODO</span></span><br><span class="line">grep -rn <span class="string">&quot;import numpy&quot;</span> /srv/project  <span class="comment"># 查找并显示行号</span></span><br></pre></td></tr></table></figure><h3 id="4-统计匹配次数"><a class="header-anchor" href="#4-统计匹配次数">¶</a>4. 统计匹配次数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -c <span class="string">&quot;ERROR&quot;</span> app.log  <span class="comment"># 统计包含 ERROR 的行数</span></span><br><span class="line">grep <span class="string">&quot;ERROR&quot;</span> app.log | <span class="built_in">wc</span> -l  <span class="comment"># 同上（更常用）</span></span><br></pre></td></tr></table></figure><h2 id="awk：提取字段和聚合"><a class="header-anchor" href="#awk：提取字段和聚合">¶</a>awk：提取字段和聚合</h2><p><code>awk</code> 是用于处理列式文本（如日志、CSV、表格）的强大工具。</p><p><strong>基本概念</strong>：</p><ul><li>awk 按行处理文本，每行按空格（或指定分隔符）分成多个字段</li><li><code>$1</code> 是第一个字段，<code>$2</code> 是第二个字段，<code>$0</code> 是整行</li></ul><p><strong>常用示例</strong>：</p><h3 id="1-提取字段"><a class="header-anchor" href="#1-提取字段">¶</a>1. 提取字段</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx 日志格式：IP - - [时间] &quot;GET /path HTTP/1.1&quot; 200 1234</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> access.log  <span class="comment"># 提取 IP 地址（第一列）</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> access.log  <span class="comment"># 提取请求路径（第七列）</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> access.log  <span class="comment"># 提取状态码（第九列）</span></span><br></pre></td></tr></table></figure><h3 id="2-过滤行（类似-grep）"><a class="header-anchor" href="#2-过滤行（类似-grep）">¶</a>2. 过滤行（类似 grep）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;/404/ &#123;print $0&#125;&#x27;</span> access.log  <span class="comment"># 只显示包含 404 的行</span></span><br><span class="line">awk <span class="string">&#x27;$9 &gt;= 400 &#123;print $0&#125;&#x27;</span> access.log  <span class="comment"># 只显示状态码 &gt;= 400 的行</span></span><br></pre></td></tr></table></figure><h3 id="3-统计和聚合"><a class="header-anchor" href="#3-统计和聚合">¶</a>3. 统计和聚合</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统计每个状态码的出现次数</span></span><br><span class="line">awk <span class="string">&#x27;&#123;count[$9]++&#125; END &#123;for (k in count) print k, count[k]&#125;&#x27;</span> access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计每个 IP 的请求次数</span></span><br><span class="line">awk <span class="string">&#x27;&#123;count[$1]++&#125; END &#123;for (k in count) print k, count[k]&#125;&#x27;</span> access.log | <span class="built_in">sort</span> -nr -k2</span><br></pre></td></tr></table></figure><h3 id="4-自定义分隔符"><a class="header-anchor" href="#4-自定义分隔符">¶</a>4. 自定义分隔符</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以逗号分隔的 CSV 文件</span></span><br><span class="line">awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> data.csv  <span class="comment"># -F 指定分隔符</span></span><br></pre></td></tr></table></figure><h3 id="5-awk-的高级应用"><a class="header-anchor" href="#5-awk-的高级应用">¶</a>5. awk 的高级应用</h3><p><strong>条件过滤 + 字段提取</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只显示状态码为 500 的请求的 IP 和路径</span></span><br><span class="line">awk <span class="string">&#x27;$9 == 500 &#123;print $1, $7&#125;&#x27;</span> access.log</span><br></pre></td></tr></table></figure><p><strong>计算平均值</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设第 10 列是响应时间（毫秒），计算平均响应时间</span></span><br><span class="line">awk <span class="string">&#x27;&#123;sum += $10; count++&#125; END &#123;print sum/count&#125;&#x27;</span> access.log</span><br></pre></td></tr></table></figure><p><strong>按条件聚合</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 统计每个 IP 的总流量（假设第 10 列是字节数）</span></span><br><span class="line">awk <span class="string">&#x27;&#123;bytes[$1] += $10&#125; END &#123;for (ip in bytes) print ip, bytes[ip]&#125;&#x27;</span> access.log | <span class="built_in">sort</span> -nr -k2</span><br></pre></td></tr></table></figure><p><strong>处理 CSV 文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取 CSV 文件的第 2 列和第 4 列，并过滤出第 3 列 &gt; 100 的行</span></span><br><span class="line">awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;$3 &gt; 100 &#123;print $2, $4&#125;&#x27;</span> data.csv</span><br></pre></td></tr></table></figure><h2 id="sed：文本替换和编辑"><a class="header-anchor" href="#sed：文本替换和编辑">¶</a>sed：文本替换和编辑</h2><p><code>sed</code> 是流编辑器（Stream Editor），用于文本替换、删除、插入等操作。</p><p><strong>常用示例</strong>：</p><h3 id="1-替换文本"><a class="header-anchor" href="#1-替换文本">¶</a>1. 替换文本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;s/foo/bar/&#x27;</span> file.txt  <span class="comment"># 替换每行第一个 foo 为 bar</span></span><br><span class="line">sed <span class="string">&#x27;s/foo/bar/g&#x27;</span> file.txt  <span class="comment"># 替换每行所有 foo 为 bar（g=global）</span></span><br><span class="line">sed <span class="string">&#x27;s/foo/bar/gi&#x27;</span> file.txt  <span class="comment"># 替换时忽略大小写</span></span><br></pre></td></tr></table></figure><h3 id="2-删除行"><a class="header-anchor" href="#2-删除行">¶</a>2. 删除行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;/pattern/d&#x27;</span> file.txt  <span class="comment"># 删除包含 pattern 的行</span></span><br><span class="line">sed <span class="string">&#x27;/^$/d&#x27;</span> file.txt  <span class="comment"># 删除空行</span></span><br><span class="line">sed <span class="string">&#x27;1,10d&#x27;</span> file.txt  <span class="comment"># 删除前 10 行</span></span><br></pre></td></tr></table></figure><h3 id="3-插入和追加"><a class="header-anchor" href="#3-插入和追加">¶</a>3. 插入和追加</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;1i\First Line&#x27;</span> file.txt  <span class="comment"># 在第一行前插入文本</span></span><br><span class="line">sed <span class="string">&#x27;$a\Last Line&#x27;</span> file.txt  <span class="comment"># 在最后一行后追加文本</span></span><br></pre></td></tr></table></figure><h3 id="4-sed-的高级应用"><a class="header-anchor" href="#4-sed-的高级应用">¶</a>4. sed 的高级应用</h3><p><strong>批量修改配置文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 Nginx 配置中的端口（80 改成 8080）</span></span><br><span class="line">sed -i <span class="string">&#x27;s/listen 80;/listen 8080;/g&#x27;</span> /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><p><strong>提取特定范围的行</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -n <span class="string">&#x27;10,20p&#x27;</span> file.txt  <span class="comment"># 只显示第 10-20 行（-n 不输出其他行，p 打印）</span></span><br></pre></td></tr></table></figure><p><strong>删除注释行和空行</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;/^#/d; /^$/d&#x27;</span> config.conf  <span class="comment"># 删除以 # 开头的行和空行</span></span><br></pre></td></tr></table></figure><p><strong>原地修改文件（-i）</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;s/old/new/g&#x27;</span> file.txt  <span class="comment"># 直接修改文件（不输出到屏幕）</span></span><br><span class="line">sed -i.bak <span class="string">&#x27;s/old/new/g&#x27;</span> file.txt  <span class="comment"># 修改前备份为 file.txt.bak</span></span><br></pre></td></tr></table></figure><h2 id="cut-tr-sort-uniq：简单高效的文本工具"><a class="header-anchor" href="#cut-tr-sort-uniq：简单高效的文本工具">¶</a>cut/tr/sort/uniq：简单高效的文本工具</h2><h3 id="cut：提取字段（简单场景）"><a class="header-anchor" href="#cut：提取字段（简单场景）">¶</a>cut：提取字段（简单场景）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cut</span> -d<span class="string">&#x27;,&#x27;</span> -f1 data.csv  <span class="comment"># 提取逗号分隔的第一列</span></span><br><span class="line"><span class="built_in">cut</span> -d<span class="string">&#x27;:&#x27;</span> -f1,7 /etc/passwd  <span class="comment"># 提取用户名和 shell（第 1 和第 7 列）</span></span><br></pre></td></tr></table></figure><h3 id="tr：字符替换-删除"><a class="header-anchor" href="#tr：字符替换-删除">¶</a>tr：字符替换/删除</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;HELLO&quot;</span> | <span class="built_in">tr</span> <span class="string">&#x27;A-Z&#x27;</span> <span class="string">&#x27;a-z&#x27;</span>  <span class="comment"># 转小写</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;a b c&quot;</span> | <span class="built_in">tr</span> <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;\n&#x27;</span>  <span class="comment"># 把空格替换成换行</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;abc123&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;0-9&#x27;</span>  <span class="comment"># 删除数字</span></span><br></pre></td></tr></table></figure><h3 id="sort：排序"><a class="header-anchor" href="#sort：排序">¶</a>sort：排序</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> file.txt  <span class="comment"># 按字母顺序排序</span></span><br><span class="line"><span class="built_in">sort</span> -n file.txt  <span class="comment"># 按数字排序</span></span><br><span class="line"><span class="built_in">sort</span> -r file.txt  <span class="comment"># 反向排序</span></span><br><span class="line"><span class="built_in">sort</span> -k2 file.txt  <span class="comment"># 按第二列排序</span></span><br><span class="line"><span class="built_in">sort</span> -u file.txt  <span class="comment"># 排序并去重（相当于 sort + uniq）</span></span><br></pre></td></tr></table></figure><h3 id="uniq：去重（只能去除相邻重复）"><a class="header-anchor" href="#uniq：去重（只能去除相邻重复）">¶</a>uniq：去重（只能去除相邻重复）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> file.txt | <span class="built_in">uniq</span>  <span class="comment"># 先排序，再去重</span></span><br><span class="line"><span class="built_in">sort</span> file.txt | <span class="built_in">uniq</span> -c  <span class="comment"># 统计每行出现次数</span></span><br><span class="line"><span class="built_in">sort</span> file.txt | <span class="built_in">uniq</span> -d  <span class="comment"># 只显示重复的行</span></span><br></pre></td></tr></table></figure><p><strong>重要</strong>：<code>uniq</code> 只能去除<strong>相邻</strong>的重复行，所以通常要先 <code>sort</code>。</p><hr><h1>实战案例：Nginx 日志分析</h1><p>假设你有一个 Nginx 日志文件 <code>access.log</code>，每行格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.100 - - [28/Jan/2025:12:00:00 +0000] &quot;GET /api/users HTTP/1.1&quot; 200 1234</span><br><span class="line">192.168.1.101 - - [28/Jan/2025:12:00:01 +0000] &quot;POST /api/login HTTP/1.1&quot; 404 567</span><br></pre></td></tr></table></figure><h2 id="1-统计访问最多的-IP"><a class="header-anchor" href="#1-统计访问最多的-IP">¶</a>1. 统计访问最多的 IP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure><p>拆解：</p><ol><li><code>awk '&#123;print $1&#125;'</code>：提取 IP 地址（第一列）</li><li><code>sort</code>：排序（让相同的 IP 相邻）</li><li><code>uniq -c</code>：去重并统计次数</li><li><code>sort -nr</code>：按次数倒序排序（-n 数字排序，-r 反向）</li><li><code>head -10</code>：只显示前 10 个</li></ol><h2 id="2-统计访问最多的-URL"><a class="header-anchor" href="#2-统计访问最多的-URL">¶</a>2. 统计访问最多的 URL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure><ul><li><code>$7</code> 是请求路径（如 <code>/api/users</code>）</li></ul><h2 id="3-统计各状态码的出现次数"><a class="header-anchor" href="#3-统计各状态码的出现次数">¶</a>3. 统计各状态码的出现次数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br></pre></td></tr></table></figure><ul><li><code>$9</code> 是状态码（如 200、404、500）</li></ul><p>输出示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1234 200</span><br><span class="line"> 567 404</span><br><span class="line"> 123 500</span><br></pre></td></tr></table></figure><h2 id="4-查找最近1小时的错误"><a class="header-anchor" href="#4-查找最近1小时的错误">¶</a>4. 查找最近1小时的错误</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;28/Jan/2025:12:&quot;</span> access.log | grep -E <span class="string">&quot; (4|5)[0-9]&#123;2&#125; &quot;</span> | <span class="built_in">tail</span> -n 100</span><br></pre></td></tr></table></figure><ul><li>第一个 <code>grep</code> 过滤时间</li><li>第二个 <code>grep</code> 过滤 4xx 和 5xx 状态码</li><li><code>tail -n 100</code> 只显示最后 100 行</li></ul><hr><h1>xargs：批量处理文件</h1><p><code>xargs</code> 用于把前一个命令的输出（通常是文件列表）转换成参数，传递给下一个命令。</p><h2 id="为什么需要-xargs"><a class="header-anchor" href="#为什么需要-xargs">¶</a>为什么需要 xargs</h2><p><strong>问题</strong>：有些命令（如 <code>rm</code>、<code>cp</code>、<code>mv</code>）不支持从 stdin 读取参数。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span>  <span class="comment"># 输出文件列表</span></span><br><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> | <span class="built_in">rm</span>  <span class="comment"># ❌ 错误！rm 不从 stdin 读取参数</span></span><br></pre></td></tr></table></figure><p><strong>解决</strong>：用 <code>xargs</code> 把文件列表转成参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> | xargs <span class="built_in">rm</span>  <span class="comment"># ✅ 正确</span></span><br></pre></td></tr></table></figure><h2 id="基本用法-v2"><a class="header-anchor" href="#基本用法-v2">¶</a>基本用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;file1 file2 file3&quot;</span> | xargs <span class="built_in">rm</span>  <span class="comment"># 删除三个文件</span></span><br></pre></td></tr></table></figure><h2 id="高级用法：-i-和替换符"><a class="header-anchor" href="#高级用法：-i-和替换符">¶</a>高级用法：<code>-i</code> 和替换符 <code>&#123;&#125;</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.log&quot;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; &#123;&#125;.bak  <span class="comment"># 给每个文件复制一个 .bak 备份</span></span><br></pre></td></tr></table></figure><ul><li><code>-i</code>：启用替换符 <code>&#123;&#125;</code></li><li><code>&#123;&#125;</code>：代表每个输入的文件名</li><li><code>&#123;&#125;.bak</code>：在文件名后加 <code>.bak</code></li></ul><h2 id="处理包含空格的文件名（重要！）"><a class="header-anchor" href="#处理包含空格的文件名（重要！）">¶</a>处理包含空格的文件名（重要！）</h2><p><strong>问题</strong>：文件名包含空格时，<code>xargs</code> 会把它当成多个参数。</p><p><strong>错误示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.txt&quot;</span> | xargs <span class="built_in">rm</span>  <span class="comment"># 如果有文件名是 &quot;my file.txt&quot;，会被当成 &quot;my&quot; 和 &quot;file.txt&quot; 两个文件</span></span><br></pre></td></tr></table></figure><p><strong>正确做法</strong>：使用 <code>find -print0</code> + <code>xargs -0</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.txt&quot;</span> -print0 | xargs -0 <span class="built_in">rm</span></span><br></pre></td></tr></table></figure><ul><li><code>-print0</code>：用 null 字符（<code>\0</code>）分隔文件名（而不是换行）</li><li><code>-0</code>：xargs 用 null 字符作为分隔符</li></ul><p><strong>或者用 <code>find -exec</code></strong>（更简单）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.txt&quot;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; +</span><br></pre></td></tr></table></figure><h2 id="并行处理（xargs-P）"><a class="header-anchor" href="#并行处理（xargs-P）">¶</a>并行处理（xargs -P）</h2><p>如果有多个 CPU 核心，可以并行处理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.json&quot;</span> -print0 | xargs -0 -P 4 -n 1 jq -c . &gt; /dev/null</span><br></pre></td></tr></table></figure><ul><li><code>-P 4</code>：最多同时运行 4 个进程</li><li><code>-n 1</code>：每次传递 1 个参数</li></ul><p><strong>适用场景</strong>：</p><ul><li>批量处理大量文件（如图片压缩、视频转码、JSON 验证）</li><li>充分利用多核 CPU，加快处理速度</li></ul><hr><h1>find 命令与管道的结合</h1><p><code>find</code> 是查找文件的强大工具，结合管道可以实现复杂的批量操作。</p><h2 id="find-的基本用法"><a class="header-anchor" href="#find-的基本用法">¶</a>find 的基本用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find /path -name <span class="string">&quot;pattern&quot;</span>  <span class="comment"># 查找文件名匹配 pattern 的文件</span></span><br><span class="line">find /path -<span class="built_in">type</span> f  <span class="comment"># 只查找文件（f=file）</span></span><br><span class="line">find /path -<span class="built_in">type</span> d  <span class="comment"># 只查找目录（d=directory）</span></span><br><span class="line">find /path -mtime +7  <span class="comment"># 查找 7 天前修改的文件</span></span><br><span class="line">find /path -size +100M  <span class="comment"># 查找大于 100MB 的文件</span></span><br></pre></td></tr></table></figure><h2 id="find-grep：在文件内容中搜索"><a class="header-anchor" href="#find-grep：在文件内容中搜索">¶</a>find + grep：在文件内容中搜索</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /srv/project -name <span class="string">&quot;*.py&quot;</span> -<span class="built_in">exec</span> grep -Hn <span class="string">&quot;TODO&quot;</span> &#123;&#125; +</span><br></pre></td></tr></table></figure><ul><li>查找所有 <code>.py</code> 文件</li><li>在文件内容中搜索 “TODO”</li><li><code>-H</code> 显示文件名，<code>-n</code> 显示行号</li></ul><h2 id="find-xargs：批量操作"><a class="header-anchor" href="#find-xargs：批量操作">¶</a>find + xargs：批量操作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log -name <span class="string">&quot;*.log&quot;</span> -mtime +30 -print0 | xargs -0 gzip</span><br></pre></td></tr></table></figure><ul><li>查找 30 天前的日志文件</li><li>批量压缩</li></ul><h2 id="find-sed：批量替换"><a class="header-anchor" href="#find-sed：批量替换">¶</a>find + sed：批量替换</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /srv -name <span class="string">&quot;*.conf&quot;</span> -print0 | xargs -0 sed -i <span class="string">&#x27;s/old_domain/new_domain/g&#x27;</span></span><br></pre></td></tr></table></figure><ul><li>查找所有 <code>.conf</code> 文件</li><li>批量替换域名</li></ul><hr><h1>实战案例：批量文件操作</h1><h2 id="案例-1：批量重命名文件"><a class="header-anchor" href="#案例-1：批量重命名文件">¶</a>案例 1：批量重命名文件</h2><p>假设有一批文件 <code>img_001.jpg</code>、<code>img_002.jpg</code>，想改成 <code>photo_001.jpg</code>、<code>photo_002.jpg</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> img_*.jpg; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">mv</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;file/img/photo&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>或者用 <code>rename</code> 命令（需要安装）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="string">&#x27;s/img/photo/&#x27;</span> img_*.jpg</span><br></pre></td></tr></table></figure><h2 id="案例-2：批量修改文件权限"><a class="header-anchor" href="#案例-2：批量修改文件权限">¶</a>案例 2：批量修改文件权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find /var/www/html -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; +  <span class="comment"># 文件改成 644</span></span><br><span class="line">find /var/www/html -<span class="built_in">type</span> d -<span class="built_in">exec</span> <span class="built_in">chmod</span> 755 &#123;&#125; +  <span class="comment"># 目录改成 755</span></span><br></pre></td></tr></table></figure><h2 id="案例-3：批量删除空文件"><a class="header-anchor" href="#案例-3：批量删除空文件">¶</a>案例 3：批量删除空文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /tmp -<span class="built_in">type</span> f -empty -delete  <span class="comment"># 删除所有空文件</span></span><br></pre></td></tr></table></figure><h2 id="案例-4：批量压缩日志文件"><a class="header-anchor" href="#案例-4：批量压缩日志文件">¶</a>案例 4：批量压缩日志文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log -name <span class="string">&quot;*.log&quot;</span> -mtime +7 -<span class="built_in">exec</span> gzip &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li><code>-mtime +7</code>：7 天前修改的文件</li><li><code>-exec gzip &#123;&#125; \;</code>：对每个文件执行 gzip 压缩</li></ul><hr><h1>高级技巧</h1><h2 id="进程替换（Process-Substitution）"><a class="header-anchor" href="#进程替换（Process-Substitution）">¶</a>进程替换（Process Substitution）</h2><p><strong>语法</strong>：<code>&lt;(command)</code></p><p><strong>用途</strong>：把命令的输出当作临时文件使用。</p><p><strong>示例</strong>：比较两个排序后的文件（不生成临时文件）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff &lt;(<span class="built_in">sort</span> file1.txt) &lt;(<span class="built_in">sort</span> file2.txt)</span><br></pre></td></tr></table></figure><p>等价于：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> file1.txt &gt; /tmp/sorted1</span><br><span class="line"><span class="built_in">sort</span> file2.txt &gt; /tmp/sorted2</span><br><span class="line">diff /tmp/sorted1 /tmp/sorted2</span><br><span class="line"><span class="built_in">rm</span> /tmp/sorted1 /tmp/sorted2</span><br></pre></td></tr></table></figure><h2 id="并行处理（xargs-P）-v2"><a class="header-anchor" href="#并行处理（xargs-P）-v2">¶</a>并行处理（xargs -P）</h2><p>如果有多个 CPU 核心，可以并行处理多个文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.json&quot;</span> -print0 | xargs -0 -P 8 -n 1 jq -c . &gt; /dev/null</span><br></pre></td></tr></table></figure><ul><li><code>-P 8</code>：最多同时运行 8 个进程</li><li><code>-n 1</code>：每次传递 1 个参数给命令</li></ul><hr><h1>安全与最佳实践</h1><h2 id="1-永远不要解析-ls-的输出"><a class="header-anchor" href="#1-永远不要解析-ls-的输出">¶</a>1. 永远不要解析 <code>ls</code> 的输出</h2><p><strong>错误示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> | xargs <span class="built_in">rm</span>  <span class="comment"># ❌ 文件名包含空格会出错</span></span><br></pre></td></tr></table></figure><p><strong>正确做法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -maxdepth 1 -<span class="built_in">type</span> f -print0 | xargs -0 <span class="built_in">rm</span></span><br></pre></td></tr></table></figure><h2 id="2-删除前先预览"><a class="header-anchor" href="#2-删除前先预览">¶</a>2. 删除前先预览</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> -<span class="built_in">print</span>  <span class="comment"># 先看看要删除哪些文件</span></span><br><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> -delete  <span class="comment"># 确认无误后再删除</span></span><br></pre></td></tr></table></figure><h2 id="3-使用-set-e-和-set-o-pipefail（在脚本里）"><a class="header-anchor" href="#3-使用-set-e-和-set-o-pipefail（在脚本里）">¶</a>3. 使用 <code>set -e</code> 和 <code>set -o pipefail</code>（在脚本里）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e  <span class="comment"># 任何命令失败就退出</span></span><br><span class="line"><span class="built_in">set</span> -o pipefail  <span class="comment"># 管道中任何命令失败就退出</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 现在如果任何步骤失败，脚本会立即退出</span></span><br><span class="line"><span class="built_in">cat</span> file.log | grep <span class="string">&quot;error&quot;</span> | process_errors.sh</span><br></pre></td></tr></table></figure><h2 id="4-引号的重要性"><a class="header-anchor" href="#4-引号的重要性">¶</a>4. 引号的重要性</h2><p><strong>错误示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span>=<span class="string">&quot;my documents&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$dir</span>  <span class="comment"># ❌ 会删除 &quot;my&quot; 和 &quot;documents&quot; 两个目录</span></span><br></pre></td></tr></table></figure><p><strong>正确做法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf <span class="string">&quot;<span class="variable">$dir</span>&quot;</span>  <span class="comment"># ✅ 正确删除 &quot;my documents&quot; 目录</span></span><br></pre></td></tr></table></figure><h2 id="5-避免命令注入（在脚本里处理用户输入）"><a class="header-anchor" href="#5-避免命令注入（在脚本里处理用户输入）">¶</a>5. 避免命令注入（在脚本里处理用户输入）</h2><p><strong>危险示例</strong>（永远不要这样写）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户输入：filename; rm -rf /</span></span><br><span class="line">filename=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">cat</span> <span class="variable">$filename</span>  <span class="comment"># ❌ 命令注入！</span></span><br></pre></td></tr></table></figure><p><strong>安全做法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filename=<span class="variable">$1</span></span><br><span class="line"><span class="comment"># 验证输入（只允许字母、数字、下划线、点、横杠）</span></span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="string">&quot;<span class="variable">$filename</span>&quot;</span> =~ ^[a-zA-Z0-9._-]+$ ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Invalid filename&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$filename</span>&quot;</span>  <span class="comment"># ✅ 安全</span></span><br></pre></td></tr></table></figure><hr><h1>更多实战案例</h1><h2 id="案例：生成服务器监控报告"><a class="header-anchor" href="#案例：生成服务器监控报告">¶</a>案例：生成服务器监控报告</h2><p>假设你需要生成每日的服务器监控报告，包含 CPU、内存、磁盘、网络等信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">REPORT=<span class="string">&quot;/tmp/daily-report-<span class="subst">$(date +%Y%m%d)</span>.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 服务器监控报告 ===&quot;</span> &gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;生成时间：<span class="subst">$(date)</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== CPU 负载 ===&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">uptime</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 内存使用 ===&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line">free -h &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 磁盘使用 ===&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">df</span> -h &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 占用CPU最多的10个进程 ===&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line">ps aux --<span class="built_in">sort</span>=-%cpu | <span class="built_in">head</span> -11 &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;=== 占用内存最多的10个进程 ===&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line">ps aux --<span class="built_in">sort</span>=-%mem | <span class="built_in">head</span> -11 &gt;&gt; <span class="string">&quot;<span class="variable">$REPORT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;报告已生成：<span class="variable">$REPORT</span>&quot;</span></span><br></pre></td></tr></table></figure><h2 id="案例：清理旧日志文件"><a class="header-anchor" href="#案例：清理旧日志文件">¶</a>案例：清理旧日志文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 查找并删除 30 天前的日志文件</span></span><br><span class="line">find /var/log -name <span class="string">&quot;*.log&quot;</span> -mtime +30 -print0 | xargs -0 <span class="built_in">rm</span> -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找并压缩 7 天前的日志文件</span></span><br><span class="line">find /var/log -name <span class="string">&quot;*.log&quot;</span> -mtime +7 -mtime -30 -print0 | xargs -0 gzip</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;清理完成&quot;</span></span><br></pre></td></tr></table></figure><h2 id="案例：批量处理-CSV-文件"><a class="header-anchor" href="#案例：批量处理-CSV-文件">¶</a>案例：批量处理 CSV 文件</h2><p>假设你有一个 <code>data.csv</code> 文件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">name,age,city,salary</span><br><span class="line">Alice,30,Beijing,10000</span><br><span class="line">Bob,25,Shanghai,8000</span><br><span class="line">Charlie,35,Guangzhou,12000</span><br></pre></td></tr></table></figure><p><strong>提取所有工资大于 9000 的员工</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;NR&gt;1 &amp;&amp; $4 &gt; 9000 &#123;print $1, $4&#125;&#x27;</span> data.csv</span><br></pre></td></tr></table></figure><ul><li><code>NR&gt;1</code>：跳过标题行（NR 是行号）</li><li><code>$4 &gt; 9000</code>：第 4 列（工资）大于 9000</li><li><code>print $1, $4</code>：打印姓名和工资</li></ul><p><strong>计算平均工资</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;NR&gt;1 &#123;sum += $4; count++&#125; END &#123;print sum/count&#125;&#x27;</span> data.csv</span><br></pre></td></tr></table></figure><p><strong>按城市统计人数</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;NR&gt;1 &#123;count[$3]++&#125; END &#123;for (city in count) print city, count[city]&#125;&#x27;</span> data.csv</span><br></pre></td></tr></table></figure><h2 id="案例：分析-Apache-Nginx-错误日志"><a class="header-anchor" href="#案例：分析-Apache-Nginx-错误日志">¶</a>案例：分析 Apache/Nginx 错误日志</h2><p>假设你的错误日志 <code>error.log</code> 格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2025/01/28 12:00:00 [error] 1234#0: *567 connect() failed (111: Connection refused) while connecting to upstream</span><br><span class="line">2025/01/28 12:00:01 [warn] 1234#0: *568 upstream server temporarily disabled</span><br></pre></td></tr></table></figure><p><strong>提取所有错误级别的日志</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&#x27;\[error\]&#x27;</span> error.log</span><br></pre></td></tr></table></figure><p><strong>统计每种错误的出现次数</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&#x27;\[error\]&#x27;</span> error.log | awk <span class="string">&#x27;&#123;print $8, $9, $10&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br></pre></td></tr></table></figure><p><strong>查找最近 1 小时的错误</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;2025/01/28 <span class="subst">$(date -d &#x27;1 hour ago&#x27; +%H)</span>:&quot;</span> error.log | grep <span class="string">&#x27;\[error\]&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="案例：处理系统日志（syslog）"><a class="header-anchor" href="#案例：处理系统日志（syslog）">¶</a>案例：处理系统日志（syslog）</h2><p><strong>查找所有 SSH 登录失败记录</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;Failed password&quot;</span> /var/log/auth.log | awk <span class="string">&#x27;&#123;print $1, $2, $3, $11&#125;&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c</span><br></pre></td></tr></table></figure><ul><li>提取日期、时间、IP 地址</li><li>统计每个 IP 的失败次数</li></ul><p><strong>查找占用磁盘最多的目录</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">du</span> -sh /* 2&gt;/dev/null | <span class="built_in">sort</span> -hr | <span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure><ul><li><code>du -sh /*</code>：查看根目录下各目录占用空间</li><li><code>2&gt;/dev/null</code>：丢弃错误信息（如权限不足）</li><li><code>sort -hr</code>：按人性化大小倒序排序</li><li><code>head -10</code>：只显示前 10 个</li></ul><hr><h1>命令行技巧与效率提升</h1><h2 id="使用命令历史（history）"><a class="header-anchor" href="#使用命令历史（history）">¶</a>使用命令历史（history）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">history</span>  <span class="comment"># 查看命令历史</span></span><br><span class="line">!123  <span class="comment"># 执行历史中第 123 条命令</span></span><br><span class="line">!!  <span class="comment"># 执行上一条命令</span></span><br><span class="line">!$  <span class="comment"># 引用上一条命令的最后一个参数</span></span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /tmp/mydir  <span class="comment"># 创建目录</span></span><br><span class="line"><span class="built_in">cd</span> !$  <span class="comment"># 相当于 cd /tmp/mydir</span></span><br></pre></td></tr></table></figure><h2 id="使用别名（alias）"><a class="header-anchor" href="#使用别名（alias）">¶</a>使用别名（alias）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -lah&#x27;</span>  <span class="comment"># 创建别名</span></span><br><span class="line"><span class="built_in">alias</span> grep=<span class="string">&#x27;grep --color=auto&#x27;</span>  <span class="comment"># grep 默认高亮</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">rm</span>=<span class="string">&#x27;rm -i&#x27;</span>  <span class="comment"># rm 默认询问（防止误删）</span></span><br></pre></td></tr></table></figure><p><strong>永久保存别名</strong>（编辑 <code>~/.bashrc</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;alias ll=&#x27;ls -lah&#x27;&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h2 id="使用-Ctrl-快捷键"><a class="header-anchor" href="#使用-Ctrl-快捷键">¶</a>使用 Ctrl 快捷键</h2><ul><li><code>Ctrl+C</code>：中断当前命令</li><li><code>Ctrl+Z</code>：暂停当前命令（放到后台）</li><li><code>Ctrl+D</code>：退出当前 shell（或结束输入）</li><li><code>Ctrl+L</code>：清屏（相当于 <code>clear</code>）</li><li><code>Ctrl+A</code>：光标移到行首</li><li><code>Ctrl+E</code>：光标移到行尾</li><li><code>Ctrl+U</code>：删除光标前的所有内容</li><li><code>Ctrl+K</code>：删除光标后的所有内容</li><li><code>Ctrl+R</code>：搜索命令历史（增量搜索）</li></ul><h2 id="使用命令替换（Command-Substitution）"><a class="header-anchor" href="#使用命令替换（Command-Substitution）">¶</a>使用命令替换（Command Substitution）</h2><p><strong>语法</strong>：<code>$(command)</code> 或 <code>`command`</code></p><p><strong>示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;当前时间：<span class="subst">$(date)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;当前目录：<span class="subst">$(pwd)</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;CPU 核心数：<span class="subst">$(nproc)</span>&quot;</span></span><br></pre></td></tr></table></figure><p><strong>在脚本里的应用</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份文件时加上时间戳</span></span><br><span class="line"><span class="built_in">cp</span> config.conf config.conf.$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统计日志文件行数并写入报告</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;今日日志行数：<span class="subst">$(wc -l &lt; today.log)</span>&quot;</span> &gt; report.txt</span><br></pre></td></tr></table></figure><h2 id="Shell-脚本中的错误处理"><a class="header-anchor" href="#Shell-脚本中的错误处理">¶</a>Shell 脚本中的错误处理</h2><p><strong>检查命令是否成功</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> grep <span class="string">&quot;error&quot;</span> app.log &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;发现错误！&quot;</span></span><br><span class="line">    <span class="comment"># 发送告警邮件或其他操作</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><p><strong>使用 <code>||</code> 和 <code>&amp;&amp;</code> 简化条件判断</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;成功&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;失败&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /tmp/test || &#123; <span class="built_in">echo</span> <span class="string">&quot;创建目录失败&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br></pre></td></tr></table></figure><p><strong>安全的脚本模板</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail  <span class="comment"># -e: 任何命令失败就退出; -u: 使用未定义变量就退出; -o pipefail: 管道中任何命令失败就退出</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 你的脚本逻辑</span></span><br><span class="line"><span class="built_in">cat</span> file.log | grep <span class="string">&quot;error&quot;</span> | process_errors.sh</span><br></pre></td></tr></table></figure><hr><h1>总结与扩展阅读</h1><p>这篇文章涵盖了 Linux 文件操作和管道的核心内容：</p><ol><li>✅ 数据流模型（stdin/stdout/stderr、文件描述符）</li><li>✅ 重定向（<code>&gt;</code>、<code>&gt;&gt;</code>、<code>2&gt;</code>、<code>2&gt;&amp;1</code>、<code>&lt;</code>）</li><li>✅ 管道符（<code>|</code> 的原理和调试技巧）</li><li>✅ 文本处理工具链（grep/awk/sed/cut/tr/sort/uniq）</li><li>✅ 实战案例（Nginx 日志分析、批量文件操作）</li><li>✅ xargs 的正确用法（处理空格、并行处理）</li><li>✅ 安全与最佳实践（不解析 ls、删除前预览、正确引号）</li></ol><p><strong>扩展阅读</strong>：</p><ul><li><a class="link" href="https://github.com/jlevy/the-art-of-command-line">The Art of Command Line<i class="fas fa-external-link-alt"></i></a>：命令行技巧大全</li><li><code>man bash</code>：查看 Bash 的详细手册（重定向、管道等）</li><li><code>man 1 awk</code>：查看 awk 的详细手册</li></ul><p><strong>下一步</strong>：</p><ul><li><strong>《Linux 用户管理》</strong>：学习如何管理用户/组、<code>/etc/passwd</code>、<code>/etc/shadow</code>、sudo 配置</li></ul><hr><p><strong>到这里，你应该已经从&quot;会用管道&quot;升级到&quot;能写可读可调试的 one-liner、能快速分析日志、能安全批量处理文件&quot;。管道和文本处理是 Linux 的核心能力，掌握了它，你就能更高效地完成运维任务。</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在命令行里真正拉开效率差距的能力，不是会多少命令，而是能不能把命令&amp;quot;拼起来&amp;quot;——把小工具串成一条清晰的数据流。管道符 &lt;code&gt;|&lt;/code&gt; 正是 Unix 哲学的核心：让每个小工具只做一件事（grep 只过滤、awk 只提取字段、sort 只排序），然后把它们串成一条可读可调试的流水线。本文从数据流模型（stdin/stdout/stderr）讲起，系统梳理管道与重定向的语义差异（&lt;code&gt;&amp;gt;&lt;/code&gt;、&lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt;、&lt;code&gt;2&amp;gt;&lt;/code&gt;、&lt;code&gt;2&amp;gt;&amp;amp;1&lt;/code&gt;、&lt;code&gt;&amp;lt;&lt;/code&gt; 分别干什么），然后补齐日志排查、文本过滤、统计汇总、批量处理里的典型套路（什么时候该用 &lt;code&gt;grep/awk/sed/sort/uniq/wc/cut/tr&lt;/code&gt;，怎么逐层缩小范围），并用实战案例（Nginx 日志分析、批量文件操作、安全删除）把&amp;quot;空格与换行&amp;quot;这类坑补上（&lt;code&gt;find -print0&lt;/code&gt; + &lt;code&gt;xargs -0&lt;/code&gt; 的正确用法）。你读完之后应该能把很多&amp;quot;要写脚本&amp;quot;的小需求，直接用一两行可读的命令解决，并且更容易看懂别人写的 one-liner。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux Pipelines and Text Processing: Composing Tools into Data Flows</title>
    <link href="https://chenk.top/en/linux-pipelines/"/>
    <id>https://chenk.top/en/linux-pipelines/</id>
    <published>2025-01-17T16:00:00.000Z</published>
    <updated>2026-01-29T16:36:06.185Z</updated>
    
    <content type="html"><![CDATA[<p>The real productivity jump on Linux isn’t memorizing more commands—it’s learning how to <strong>compose small tools</strong> into clear data flows. The pipe operator <code>|</code> embodies the core Unix philosophy: make each small tool do one thing (grep only filters, awk only extracts fields, sort only sorts), then chain them into a readable, debuggable pipeline. This post starts from the data flow model (stdin/stdout/stderr), systematically explains semantic differences between pipes and redirection (<code>&gt;</code>, <code>&gt;&gt;</code>, <code>2&gt;</code>, <code>2&gt;&amp;1</code>, <code>&lt;</code> each do what), then fills in typical patterns for log triage, text filtering, statistical aggregation, and batch processing (when to use <code>grep/awk/sed/sort/uniq/wc/cut/tr</code>, how to progressively narrow scope), and uses practical cases (Nginx log analysis, batch file operations, safe deletion) to cover pitfalls like “spaces and newlines” (correct usage of <code>find -print0</code> + <code>xargs -0</code>). After reading, you should be able to replace many “need to write a script” small tasks with one or two readable command lines and more easily understand others’ one-liners.</p><span id="more"></span><h1>Data Flow Model: stdin/stdout/stderr and File Descriptors</h1><h2 id="Three-Standard-Streams"><a class="header-anchor" href="#Three-Standard-Streams">¶</a>Three Standard Streams</h2><p>Every Linux process has three standard streams:</p><table><thead><tr><th>Stream</th><th>File Descriptor</th><th>Default Behavior</th><th>Example</th></tr></thead><tbody><tr><td><strong>stdin</strong></td><td>0</td><td>Read input from keyboard</td><td><code>cat</code> (waits for user input when no args)</td></tr><tr><td><strong>stdout</strong></td><td>1</td><td>Output to screen</td><td><code>echo &quot;hello&quot;</code></td></tr><tr><td><strong>stderr</strong></td><td>2</td><td>Error output to screen</td><td><code>ls /nonexistent 2&gt;&amp;1</code></td></tr></tbody></table><p><strong>Why separate stdout and stderr?</strong></p><ul><li>Normal output and error output can be handled separately (like normal output saved to file, error output displayed on screen)</li><li>Pipe <code>|</code> only passes stdout (doesn’t pass stderr), so error messages don’t pollute data flow</li></ul><p><strong>Example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /nonexistent  <span class="comment"># Error message outputs to stderr (screen)</span></span><br><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt; err.log  <span class="comment"># Error message redirected to err.log</span></span><br><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt;&amp;1  <span class="comment"># stderr redirected to stdout (merged into same stream)</span></span><br></pre></td></tr></table></figure><h2 id="File-Descriptors-FD"><a class="header-anchor" href="#File-Descriptors-FD">¶</a>File Descriptors (FD)</h2><p>File descriptors are process’s “handles” for opened files, represented by integers:</p><ul><li><code>0</code>: stdin</li><li><code>1</code>: stdout</li><li><code>2</code>: stderr</li><li><code>3+</code>: Files opened by process itself</li></ul><p><strong>View process’s open file descriptors</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /proc/$$/fd  <span class="comment"># $$ is current shell&#x27;s PID</span></span><br></pre></td></tr></table></figure><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lrwx------ 1 user user 0 /proc/12345/fd/0 -&gt; /dev/pts/0  # stdin</span><br><span class="line">lrwx------ 1 user user 0 /proc/12345/fd/1 -&gt; /dev/pts/0  # stdout</span><br><span class="line">lrwx------ 1 user user 0 /proc/12345/fd/2 -&gt; /dev/pts/0  # stderr</span><br></pre></td></tr></table></figure><hr><h1>Redirection: Controlling Data Flow Direction</h1><h2 id="Output-Redirection-stdout"><a class="header-anchor" href="#Output-Redirection-stdout">¶</a>Output Redirection (stdout)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; file.txt  <span class="comment"># Overwrite (file cleared if exists)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;world&quot;</span> &gt;&gt; file.txt  <span class="comment"># Append (add to end of file)</span></span><br></pre></td></tr></table></figure><p><strong>Common usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l &gt; filelist.txt  <span class="comment"># Save file list</span></span><br><span class="line"><span class="built_in">date</span> &gt;&gt; log.txt  <span class="comment"># Append timestamp to log</span></span><br></pre></td></tr></table></figure><h2 id="Error-Output-Redirection-stderr"><a class="header-anchor" href="#Error-Output-Redirection-stderr">¶</a>Error Output Redirection (stderr)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt; err.log  <span class="comment"># Error output redirected to err.log</span></span><br><span class="line"><span class="built_in">ls</span> /nonexistent 2&gt;&gt; err.log  <span class="comment"># Error output appended to err.log</span></span><br></pre></td></tr></table></figure><h2 id="Redirect-Both-stdout-and-stderr"><a class="header-anchor" href="#Redirect-Both-stdout-and-stderr">¶</a>Redirect Both stdout and stderr</h2><h3 id="Method-1-2-1-Traditional"><a class="header-anchor" href="#Method-1-2-1-Traditional">¶</a>Method 1: <code>2&gt;&amp;1</code> (Traditional)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &gt; output.log 2&gt;&amp;1  <span class="comment"># Both stdout and stderr redirected to output.log</span></span><br></pre></td></tr></table></figure><p><strong>Order matters</strong>:</p><ul><li><code>&gt; output.log</code> first redirects stdout to output.log</li><li><code>2&gt;&amp;1</code> then redirects stderr to stdout’s location (also output.log)</li></ul><p><strong>Wrong way</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> 2&gt;&amp;1 &gt; output.log  <span class="comment"># Wrong! stderr first redirects to stdout (screen), then stdout redirects to file</span></span><br></pre></td></tr></table></figure><h3 id="Method-2-Modern-Recommended"><a class="header-anchor" href="#Method-2-Modern-Recommended">¶</a>Method 2: <code>&amp;&gt;</code> (Modern, Recommended)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &amp;&gt; output.log  <span class="comment"># Both stdout and stderr redirected to output.log</span></span><br><span class="line"><span class="built_in">command</span> &amp;&gt;&gt; output.log  <span class="comment"># Append mode</span></span><br></pre></td></tr></table></figure><h2 id="Discard-Output-dev-null"><a class="header-anchor" href="#Discard-Output-dev-null">¶</a>Discard Output (/dev/null)</h2><p><code>/dev/null</code> is a special “black hole” file; data written to it is discarded.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &gt; /dev/null  <span class="comment"># Discard stdout</span></span><br><span class="line"><span class="built_in">command</span> 2&gt; /dev/null  <span class="comment"># Discard stderr</span></span><br><span class="line"><span class="built_in">command</span> &amp;&gt; /dev/null  <span class="comment"># Discard both stdout and stderr</span></span><br></pre></td></tr></table></figure><p><strong>Use cases</strong>:</p><ul><li>Don’t want to see command output (like scripts in cron jobs)</li><li>Only care if command succeeded (check exit code via <code>$?</code>)</li></ul><h2 id="Input-Redirection-stdin"><a class="header-anchor" href="#Input-Redirection-stdin">¶</a>Input Redirection (stdin)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> &lt; input.txt  <span class="comment"># Read input from input.txt</span></span><br></pre></td></tr></table></figure><p><strong>Here-document (multi-line input)</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; config.txt</span></span><br><span class="line"><span class="string">line 1</span></span><br><span class="line"><span class="string">line 2</span></span><br><span class="line"><span class="string">line 3</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p><strong>Here-string (single-line input)</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;error&quot;</span> &lt;&lt;&lt; <span class="string">&quot;ERROR: something bad&quot;</span></span><br></pre></td></tr></table></figure><hr><h1>Pipe Operator: Chaining Commands</h1><h2 id="Core-Concept-of-Pipes"><a class="header-anchor" href="#Core-Concept-of-Pipes">¶</a>Core Concept of Pipes</h2><p><strong>Unix Philosophy</strong>: Each tool does one thing, does it well, then combine them via pipes.</p><p><strong>Example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> access.log | grep <span class="string">&quot;404&quot;</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><p>Breakdown:</p><ol><li><code>cat access.log</code>: Output log content (stdout)</li><li><code>grep &quot;404&quot;</code>: Read from stdin, filter lines containing “404” (stdout)</li><li><code>wc -l</code>: Read from stdin, count lines (stdout)</li></ol><p><strong>Why this design?</strong></p><ul><li>Avoids temporary files (data flows in memory, not written to disk)</li><li>Strong readability (each step is clear)</li><li>Easy debugging (can add pipes step by step, see each step’s output)</li></ul><h2 id="Debugging-Pipes-Using-tee"><a class="header-anchor" href="#Debugging-Pipes-Using-tee">¶</a>Debugging Pipes: Using tee</h2><p><code>tee</code> can output data to both screen and file simultaneously (like a “T-junction pipe”).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> access.log | grep <span class="string">&quot;404&quot;</span> | <span class="built_in">tee</span> filtered.log | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><ul><li><code>tee filtered.log</code>: Saves grep output to filtered.log, while passing to next command</li><li>This lets you see intermediate results, helpful for debugging</li></ul><hr><h1>Text Processing Toolchain: grep/awk/sed/cut/tr/sort/uniq</h1><h2 id="grep-Filter-Lines"><a class="header-anchor" href="#grep-Filter-Lines">¶</a>grep: Filter Lines</h2><p><code>grep</code> is the most commonly used text filtering tool for finding matching lines.</p><p><strong>Basic usage</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;pattern&quot;</span> file  <span class="comment"># Find lines matching pattern in file</span></span><br><span class="line"><span class="built_in">command</span> | grep <span class="string">&quot;pattern&quot;</span>  <span class="comment"># Find in command output</span></span><br></pre></td></tr></table></figure><p><strong>Common parameters</strong>:</p><ul><li><code>-i</code>: Ignore case</li><li><code>-v</code>: Invert match (only show lines NOT containing pattern)</li><li><code>-n</code>: Show line numbers</li><li><code>-A N</code>: Show N lines after match (After)</li><li><code>-B N</code>: Show N lines before match (Before)</li><li><code>-C N</code>: Show N lines before and after match (Context)</li><li><code>-E</code>: Extended regex (supports <code>|</code>, <code>+</code>, <code>?</code>, etc.)</li><li><code>-r</code>: Recursively search directory</li></ul><p><strong>Practical examples</strong>:</p><h3 id="1-View-Errors-in-Logs"><a class="header-anchor" href="#1-View-Errors-in-Logs">¶</a>1. View Errors in Logs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -i <span class="string">&quot;error&quot;</span> /var/log/syslog  <span class="comment"># Case-insensitive search for error</span></span><br><span class="line">grep -E <span class="string">&quot;error|fail|timeout&quot;</span> /var/log/syslog  <span class="comment"># Search multiple keywords</span></span><br></pre></td></tr></table></figure><h3 id="2-View-Error-Context"><a class="header-anchor" href="#2-View-Error-Context">¶</a>2. View Error Context</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -C 3 <span class="string">&quot;OutOfMemoryError&quot;</span> app.log  <span class="comment"># Show 3 lines before and after error</span></span><br></pre></td></tr></table></figure><h3 id="3-Recursively-Search-Directory"><a class="header-anchor" href="#3-Recursively-Search-Directory">¶</a>3. Recursively Search Directory</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -r <span class="string">&quot;TODO&quot;</span> /srv/project  <span class="comment"># Recursively find TODO in project directory</span></span><br><span class="line">grep -rn <span class="string">&quot;import numpy&quot;</span> /srv/project  <span class="comment"># Find and show line numbers</span></span><br></pre></td></tr></table></figure><h3 id="4-Count-Matches"><a class="header-anchor" href="#4-Count-Matches">¶</a>4. Count Matches</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep -c <span class="string">&quot;ERROR&quot;</span> app.log  <span class="comment"># Count lines containing ERROR</span></span><br><span class="line">grep <span class="string">&quot;ERROR&quot;</span> app.log | <span class="built_in">wc</span> -l  <span class="comment"># Same (more common)</span></span><br></pre></td></tr></table></figure><h2 id="awk-Extract-Fields-and-Aggregate"><a class="header-anchor" href="#awk-Extract-Fields-and-Aggregate">¶</a>awk: Extract Fields and Aggregate</h2><p><code>awk</code> is a powerful tool for processing columnar text (like logs, CSV, tables).</p><p><strong>Basic concepts</strong>:</p><ul><li>awk processes text line by line, splitting each line by whitespace (or specified delimiter) into fields</li><li><code>$1</code> is first field, <code>$2</code> is second field, <code>$0</code> is entire line</li></ul><p><strong>Common examples</strong>:</p><h3 id="1-Extract-Fields"><a class="header-anchor" href="#1-Extract-Fields">¶</a>1. Extract Fields</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Nginx log format: IP - - [time] &quot;GET /path HTTP/1.1&quot; 200 1234</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> access.log  <span class="comment"># Extract IP address (column 1)</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> access.log  <span class="comment"># Extract request path (column 7)</span></span><br><span class="line">awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> access.log  <span class="comment"># Extract status code (column 9)</span></span><br></pre></td></tr></table></figure><h3 id="2-Filter-Lines-Like-grep"><a class="header-anchor" href="#2-Filter-Lines-Like-grep">¶</a>2. Filter Lines (Like grep)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;/404/ &#123;print $0&#125;&#x27;</span> access.log  <span class="comment"># Only show lines containing 404</span></span><br><span class="line">awk <span class="string">&#x27;$9 &gt;= 400 &#123;print $0&#125;&#x27;</span> access.log  <span class="comment"># Only show lines with status code &gt;= 400</span></span><br></pre></td></tr></table></figure><h3 id="3-Statistics-and-Aggregation"><a class="header-anchor" href="#3-Statistics-and-Aggregation">¶</a>3. Statistics and Aggregation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Count occurrences of each status code</span></span><br><span class="line">awk <span class="string">&#x27;&#123;count[$9]++&#125; END &#123;for (k in count) print k, count[k]&#125;&#x27;</span> access.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># Count requests per IP</span></span><br><span class="line">awk <span class="string">&#x27;&#123;count[$1]++&#125; END &#123;for (k in count) print k, count[k]&#125;&#x27;</span> access.log | <span class="built_in">sort</span> -nr -k2</span><br></pre></td></tr></table></figure><h3 id="4-Custom-Delimiter"><a class="header-anchor" href="#4-Custom-Delimiter">¶</a>4. Custom Delimiter</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Comma-separated CSV file</span></span><br><span class="line">awk -F<span class="string">&#x27;,&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> data.csv  <span class="comment"># -F specifies delimiter</span></span><br></pre></td></tr></table></figure><h2 id="sed-Text-Replacement-and-Editing"><a class="header-anchor" href="#sed-Text-Replacement-and-Editing">¶</a>sed: Text Replacement and Editing</h2><p><code>sed</code> is a stream editor for text replacement, deletion, insertion, etc.</p><p><strong>Common examples</strong>:</p><h3 id="1-Replace-Text"><a class="header-anchor" href="#1-Replace-Text">¶</a>1. Replace Text</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;s/foo/bar/&#x27;</span> file.txt  <span class="comment"># Replace first foo with bar on each line</span></span><br><span class="line">sed <span class="string">&#x27;s/foo/bar/g&#x27;</span> file.txt  <span class="comment"># Replace all foo with bar on each line (g=global)</span></span><br><span class="line">sed <span class="string">&#x27;s/foo/bar/gi&#x27;</span> file.txt  <span class="comment"># Replace ignoring case</span></span><br></pre></td></tr></table></figure><h3 id="2-Delete-Lines"><a class="header-anchor" href="#2-Delete-Lines">¶</a>2. Delete Lines</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;/pattern/d&#x27;</span> file.txt  <span class="comment"># Delete lines containing pattern</span></span><br><span class="line">sed <span class="string">&#x27;/^$/d&#x27;</span> file.txt  <span class="comment"># Delete empty lines</span></span><br><span class="line">sed <span class="string">&#x27;1,10d&#x27;</span> file.txt  <span class="comment"># Delete first 10 lines</span></span><br></pre></td></tr></table></figure><h3 id="3-Insert-and-Append"><a class="header-anchor" href="#3-Insert-and-Append">¶</a>3. Insert and Append</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">&#x27;1i\First Line&#x27;</span> file.txt  <span class="comment"># Insert text before first line</span></span><br><span class="line">sed <span class="string">&#x27;$a\Last Line&#x27;</span> file.txt  <span class="comment"># Append text after last line</span></span><br></pre></td></tr></table></figure><h2 id="cut-tr-sort-uniq-Simple-Efficient-Text-Tools"><a class="header-anchor" href="#cut-tr-sort-uniq-Simple-Efficient-Text-Tools">¶</a>cut/tr/sort/uniq: Simple Efficient Text Tools</h2><h3 id="cut-Extract-Fields-Simple-Cases"><a class="header-anchor" href="#cut-Extract-Fields-Simple-Cases">¶</a>cut: Extract Fields (Simple Cases)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cut</span> -d<span class="string">&#x27;,&#x27;</span> -f1 data.csv  <span class="comment"># Extract comma-separated first column</span></span><br><span class="line"><span class="built_in">cut</span> -d<span class="string">&#x27;:&#x27;</span> -f1,7 /etc/passwd  <span class="comment"># Extract username and shell (columns 1 and 7)</span></span><br></pre></td></tr></table></figure><h3 id="tr-Character-Replacement-Deletion"><a class="header-anchor" href="#tr-Character-Replacement-Deletion">¶</a>tr: Character Replacement/Deletion</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;HELLO&quot;</span> | <span class="built_in">tr</span> <span class="string">&#x27;A-Z&#x27;</span> <span class="string">&#x27;a-z&#x27;</span>  <span class="comment"># Convert to lowercase</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;a b c&quot;</span> | <span class="built_in">tr</span> <span class="string">&#x27; &#x27;</span> <span class="string">&#x27;\n&#x27;</span>  <span class="comment"># Replace spaces with newlines</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;abc123&quot;</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;0-9&#x27;</span>  <span class="comment"># Delete numbers</span></span><br></pre></td></tr></table></figure><h3 id="sort-Sorting"><a class="header-anchor" href="#sort-Sorting">¶</a>sort: Sorting</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> file.txt  <span class="comment"># Sort alphabetically</span></span><br><span class="line"><span class="built_in">sort</span> -n file.txt  <span class="comment"># Sort numerically</span></span><br><span class="line"><span class="built_in">sort</span> -r file.txt  <span class="comment"># Reverse sort</span></span><br><span class="line"><span class="built_in">sort</span> -k2 file.txt  <span class="comment"># Sort by second column</span></span><br><span class="line"><span class="built_in">sort</span> -u file.txt  <span class="comment"># Sort and remove duplicates (equivalent to sort + uniq)</span></span><br></pre></td></tr></table></figure><h3 id="uniq-Remove-Duplicates-Only-Adjacent-Duplicates"><a class="header-anchor" href="#uniq-Remove-Duplicates-Only-Adjacent-Duplicates">¶</a>uniq: Remove Duplicates (Only Adjacent Duplicates)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> file.txt | <span class="built_in">uniq</span>  <span class="comment"># Sort first, then remove duplicates</span></span><br><span class="line"><span class="built_in">sort</span> file.txt | <span class="built_in">uniq</span> -c  <span class="comment"># Count occurrences of each line</span></span><br><span class="line"><span class="built_in">sort</span> file.txt | <span class="built_in">uniq</span> -d  <span class="comment"># Only show duplicate lines</span></span><br></pre></td></tr></table></figure><p><strong>Important</strong>: <code>uniq</code> can only remove <strong>adjacent</strong> duplicate lines, so usually need to <code>sort</code> first.</p><hr><h1>Practical Case: Nginx Log Analysis</h1><p>Suppose you have an Nginx log file <code>access.log</code>, each line formatted like:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.100 - - [28/Jan/2025:12:00:00 +0000] &quot;GET /api/users HTTP/1.1&quot; 200 1234</span><br><span class="line">192.168.1.101 - - [28/Jan/2025:12:00:01 +0000] &quot;POST /api/login HTTP/1.1&quot; 404 567</span><br></pre></td></tr></table></figure><h2 id="1-Count-Top-Visiting-IPs"><a class="header-anchor" href="#1-Count-Top-Visiting-IPs">¶</a>1. Count Top Visiting IPs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure><p>Breakdown:</p><ol><li><code>awk '&#123;print $1&#125;'</code>: Extract IP address (column 1)</li><li><code>sort</code>: Sort (make identical IPs adjacent)</li><li><code>uniq -c</code>: Remove duplicates and count occurrences</li><li><code>sort -nr</code>: Sort by count in reverse order (-n numeric, -r reverse)</li><li><code>head -10</code>: Show only top 10</li></ol><h2 id="2-Count-Most-Visited-URLs"><a class="header-anchor" href="#2-Count-Most-Visited-URLs">¶</a>2. Count Most Visited URLs</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;print $7&#125;&#x27;</span> access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr | <span class="built_in">head</span> -10</span><br></pre></td></tr></table></figure><ul><li><code>$7</code> is request path (like <code>/api/users</code>)</li></ul><h2 id="3-Count-Each-Status-Code’s-Occurrences"><a class="header-anchor" href="#3-Count-Each-Status-Code’s-Occurrences">¶</a>3. Count Each Status Code’s Occurrences</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">&#x27;&#123;print $9&#125;&#x27;</span> access.log | <span class="built_in">sort</span> | <span class="built_in">uniq</span> -c | <span class="built_in">sort</span> -nr</span><br></pre></td></tr></table></figure><ul><li><code>$9</code> is status code (like 200, 404, 500)</li></ul><p>Example output:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1234 200</span><br><span class="line"> 567 404</span><br><span class="line"> 123 500</span><br></pre></td></tr></table></figure><h2 id="4-Find-Errors-in-Last-Hour"><a class="header-anchor" href="#4-Find-Errors-in-Last-Hour">¶</a>4. Find Errors in Last Hour</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;28/Jan/2025:12:&quot;</span> access.log | grep -E <span class="string">&quot; (4|5)[0-9]&#123;2&#125; &quot;</span> | <span class="built_in">tail</span> -n 100</span><br></pre></td></tr></table></figure><ul><li>First <code>grep</code> filters time</li><li>Second <code>grep</code> filters 4xx and 5xx status codes</li><li><code>tail -n 100</code> shows only last 100 lines</li></ul><hr><h1>xargs: Batch File Processing</h1><p><code>xargs</code> converts previous command’s output (usually file list) into arguments, passing to next command.</p><h2 id="Why-xargs-Is-Needed"><a class="header-anchor" href="#Why-xargs-Is-Needed">¶</a>Why xargs Is Needed</h2><p><strong>Problem</strong>: Some commands (like <code>rm</code>, <code>cp</code>, <code>mv</code>) don’t support reading arguments from stdin.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span>  <span class="comment"># Outputs file list</span></span><br><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> | <span class="built_in">rm</span>  <span class="comment"># ❌ Wrong! rm doesn&#x27;t read from stdin</span></span><br></pre></td></tr></table></figure><p><strong>Solution</strong>: Use <code>xargs</code> to convert file list to arguments</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> | xargs <span class="built_in">rm</span>  <span class="comment"># ✅ Correct</span></span><br></pre></td></tr></table></figure><h2 id="Basic-Usage"><a class="header-anchor" href="#Basic-Usage">¶</a>Basic Usage</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;file1 file2 file3&quot;</span> | xargs <span class="built_in">rm</span>  <span class="comment"># Delete three files</span></span><br></pre></td></tr></table></figure><h2 id="Advanced-Usage-i-and-Placeholder"><a class="header-anchor" href="#Advanced-Usage-i-and-Placeholder">¶</a>Advanced Usage: <code>-i</code> and Placeholder <code>&#123;&#125;</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.log&quot;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; &#123;&#125;.bak  <span class="comment"># Copy each file with .bak backup</span></span><br></pre></td></tr></table></figure><ul><li><code>-i</code>: Enable placeholder <code>&#123;&#125;</code></li><li><code>&#123;&#125;</code>: Represents each input filename</li><li><code>&#123;&#125;.bak</code>: Add <code>.bak</code> to filename</li></ul><h2 id="Handle-Filenames-with-Spaces-Important"><a class="header-anchor" href="#Handle-Filenames-with-Spaces-Important">¶</a>Handle Filenames with Spaces (Important!)</h2><p><strong>Problem</strong>: Filenames with spaces cause <code>xargs</code> to treat them as multiple arguments.</p><p><strong>Wrong example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.txt&quot;</span> | xargs <span class="built_in">rm</span>  <span class="comment"># If filename is &quot;my file.txt&quot;, treated as &quot;my&quot; and &quot;file.txt&quot;</span></span><br></pre></td></tr></table></figure><p><strong>Correct approach</strong>: Use <code>find -print0</code> + <code>xargs -0</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.txt&quot;</span> -print0 | xargs -0 <span class="built_in">rm</span></span><br></pre></td></tr></table></figure><ul><li><code>-print0</code>: Use null character (<code>\0</code>) to separate filenames (instead of newline)</li><li><code>-0</code>: xargs uses null character as delimiter</li></ul><p><strong>Or use <code>find -exec</code></strong> (simpler):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.txt&quot;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; +</span><br></pre></td></tr></table></figure><hr><h1>Practical Cases: Batch File Operations</h1><h2 id="Case-1-Batch-Rename-Files"><a class="header-anchor" href="#Case-1-Batch-Rename-Files">¶</a>Case 1: Batch Rename Files</h2><p>Suppose you have files <code>img_001.jpg</code>, <code>img_002.jpg</code>, want to rename to <code>photo_001.jpg</code>, <code>photo_002.jpg</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> img_*.jpg; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">mv</span> <span class="string">&quot;<span class="variable">$file</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;file/img/photo&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>Or use <code>rename</code> command (needs installation):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rename <span class="string">&#x27;s/img/photo/&#x27;</span> img_*.jpg</span><br></pre></td></tr></table></figure><h2 id="Case-2-Batch-Modify-File-Permissions"><a class="header-anchor" href="#Case-2-Batch-Modify-File-Permissions">¶</a>Case 2: Batch Modify File Permissions</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find /var/www/html -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; +  <span class="comment"># Files to 644</span></span><br><span class="line">find /var/www/html -<span class="built_in">type</span> d -<span class="built_in">exec</span> <span class="built_in">chmod</span> 755 &#123;&#125; +  <span class="comment"># Directories to 755</span></span><br></pre></td></tr></table></figure><h2 id="Case-3-Batch-Delete-Empty-Files"><a class="header-anchor" href="#Case-3-Batch-Delete-Empty-Files">¶</a>Case 3: Batch Delete Empty Files</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /tmp -<span class="built_in">type</span> f -empty -delete  <span class="comment"># Delete all empty files</span></span><br></pre></td></tr></table></figure><h2 id="Case-4-Batch-Compress-Log-Files"><a class="header-anchor" href="#Case-4-Batch-Compress-Log-Files">¶</a>Case 4: Batch Compress Log Files</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log -name <span class="string">&quot;*.log&quot;</span> -mtime +7 -<span class="built_in">exec</span> gzip &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li><code>-mtime +7</code>: Files modified more than 7 days ago</li><li><code>-exec gzip &#123;&#125; \;</code>: Execute gzip compression on each file</li></ul><hr><h1>Advanced Techniques</h1><h2 id="Process-Substitution"><a class="header-anchor" href="#Process-Substitution">¶</a>Process Substitution</h2><p><strong>Syntax</strong>: <code>&lt;(command)</code></p><p><strong>Purpose</strong>: Treat command output as a temporary file.</p><p><strong>Example</strong>: Compare two sorted files (without creating temp files)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff &lt;(<span class="built_in">sort</span> file1.txt) &lt;(<span class="built_in">sort</span> file2.txt)</span><br></pre></td></tr></table></figure><p>Equivalent to:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sort</span> file1.txt &gt; /tmp/sorted1</span><br><span class="line"><span class="built_in">sort</span> file2.txt &gt; /tmp/sorted2</span><br><span class="line">diff /tmp/sorted1 /tmp/sorted2</span><br><span class="line"><span class="built_in">rm</span> /tmp/sorted1 /tmp/sorted2</span><br></pre></td></tr></table></figure><h2 id="Parallel-Processing-xargs-P"><a class="header-anchor" href="#Parallel-Processing-xargs-P">¶</a>Parallel Processing (xargs -P)</h2><p>If you have multiple CPU cores, can process multiple files in parallel.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.json&quot;</span> -print0 | xargs -0 -P 8 -n 1 jq -c . &gt; /dev/null</span><br></pre></td></tr></table></figure><ul><li><code>-P 8</code>: Run max 8 processes simultaneously</li><li><code>-n 1</code>: Pass 1 argument to command each time</li></ul><hr><h1>Safety and Best Practices</h1><h2 id="1-Never-Parse-ls-Output"><a class="header-anchor" href="#1-Never-Parse-ls-Output">¶</a>1. Never Parse <code>ls</code> Output</h2><p><strong>Wrong example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> | xargs <span class="built_in">rm</span>  <span class="comment"># ❌ Filenames with spaces will error</span></span><br></pre></td></tr></table></figure><p><strong>Correct approach</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -maxdepth 1 -<span class="built_in">type</span> f -print0 | xargs -0 <span class="built_in">rm</span></span><br></pre></td></tr></table></figure><h2 id="2-Preview-Before-Deletion"><a class="header-anchor" href="#2-Preview-Before-Deletion">¶</a>2. Preview Before Deletion</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> -<span class="built_in">print</span>  <span class="comment"># First see which files to delete</span></span><br><span class="line">find . -name <span class="string">&quot;*.tmp&quot;</span> -delete  <span class="comment"># Confirm correct then delete</span></span><br></pre></td></tr></table></figure><h2 id="3-Use-set-e-and-set-o-pipefail-In-Scripts"><a class="header-anchor" href="#3-Use-set-e-and-set-o-pipefail-In-Scripts">¶</a>3. Use <code>set -e</code> and <code>set -o pipefail</code> (In Scripts)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -e  <span class="comment"># Exit if any command fails</span></span><br><span class="line"><span class="built_in">set</span> -o pipefail  <span class="comment"># Exit if any command in pipeline fails</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Now if any step fails, script immediately exits</span></span><br><span class="line"><span class="built_in">cat</span> file.log | grep <span class="string">&quot;error&quot;</span> | process_errors.sh</span><br></pre></td></tr></table></figure><h2 id="4-Importance-of-Quotes"><a class="header-anchor" href="#4-Importance-of-Quotes">¶</a>4. Importance of Quotes</h2><p><strong>Wrong example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dir</span>=<span class="string">&quot;my documents&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$dir</span>  <span class="comment"># ❌ Will delete &quot;my&quot; and &quot;documents&quot; two directories</span></span><br></pre></td></tr></table></figure><p><strong>Correct approach</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf <span class="string">&quot;<span class="variable">$dir</span>&quot;</span>  <span class="comment"># ✅ Correctly deletes &quot;my documents&quot; directory</span></span><br></pre></td></tr></table></figure><hr><h1>Summary and Further Reading</h1><p>This article covers the core content of Linux file operations and pipes:</p><ol><li>✅ Data flow model (stdin/stdout/stderr, file descriptors)</li><li>✅ Redirection (<code>&gt;</code>, <code>&gt;&gt;</code>, <code>2&gt;</code>, <code>2&gt;&amp;1</code>, <code>&lt;</code>)</li><li>✅ Pipe operator (<code>|</code> principles and debugging techniques)</li><li>✅ Text processing toolchain (grep/awk/sed/cut/tr/sort/uniq)</li><li>✅ Practical cases (Nginx log analysis, batch file operations)</li><li>✅ Correct xargs usage (handling spaces, parallel processing)</li><li>✅ Safety and best practices (don’t parse ls, preview before delete, correct quoting)</li></ol><p><strong>Further Reading</strong>:</p><ul><li><a class="link" href="https://github.com/jlevy/the-art-of-command-line">The Art of Command Line<i class="fas fa-external-link-alt"></i></a>: Command-line tips encyclopedia</li><li><code>man bash</code>: View detailed Bash manual (redirection, pipes, etc.)</li><li><code>man 1 awk</code>: View detailed awk manual</li></ul><p><strong>Next Steps</strong>:</p><ul><li><strong>《Linux User Management》</strong>: Learn how to manage users/groups, <code>/etc/passwd</code>, <code>/etc/shadow</code>, sudo configuration</li></ul><hr><p><strong>By this point, you should have upgraded from “can use pipes” to “can write readable debuggable one-liners, can quickly analyze logs, can safely batch-process files.” Pipes and text processing are core Linux capabilities; mastering them makes you much more efficient at ops tasks.</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;The real productivity jump on Linux isn’t memorizing more commands—it’s learning how to &lt;strong&gt;compose small tools&lt;/strong&gt; into clear data flows. The pipe operator &lt;code&gt;|&lt;/code&gt; embodies the core Unix philosophy: make each small tool do one thing (grep only filters, awk only extracts fields, sort only sorts), then chain them into a readable, debuggable pipeline. This post starts from the data flow model (stdin/stdout/stderr), systematically explains semantic differences between pipes and redirection (&lt;code&gt;&amp;gt;&lt;/code&gt;, &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt;, &lt;code&gt;2&amp;gt;&lt;/code&gt;, &lt;code&gt;2&amp;gt;&amp;amp;1&lt;/code&gt;, &lt;code&gt;&amp;lt;&lt;/code&gt; each do what), then fills in typical patterns for log triage, text filtering, statistical aggregation, and batch processing (when to use &lt;code&gt;grep/awk/sed/sort/uniq/wc/cut/tr&lt;/code&gt;, how to progressively narrow scope), and uses practical cases (Nginx log analysis, batch file operations, safe deletion) to cover pitfalls like “spaces and newlines” (correct usage of &lt;code&gt;find -print0&lt;/code&gt; + &lt;code&gt;xargs -0&lt;/code&gt;). After reading, you should be able to replace many “need to write a script” small tasks with one or two readable command lines and more easily understand others’ one-liners.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux Vim 解析</title>
    <link href="https://chenk.top/Linux-Vim-%E8%A7%A3%E6%9E%90/"/>
    <id>https://chenk.top/Linux-Vim-%E8%A7%A3%E6%9E%90/</id>
    <published>2025-01-11T16:00:00.000Z</published>
    <updated>2026-01-30T01:42:06.363Z</updated>
    
    <content type="html"><![CDATA[<p>很多人学 Vim 的挫败感，来自“记了很多快捷键，但不知道该怎么组成一套顺手的编辑流程”。Vim 的核心其实只有一件事：<strong>模式化编辑</strong>——用少量的模式 + 可组合的动作（motion）与操作符（operator），把“移动—选择—修改”变成可重复、可迁移的肌肉记忆。本文会从最常用的几种模式开始，讲清楚每种模式负责什么、该什么时候切换；再把高频的移动、删除/复制/粘贴、撤销/重做、搜索/替换、块编辑等整理成一套能直接上手的练习路径。读完你应该能用 Vim 完成日常写代码/改配置的 80% 操作，并且知道剩下 20% 该去哪里查、怎么组合出来。</p><span id="more"></span><h1>Vim 常用模式与操作</h1><p>Vim 的精髓在于“模式化编辑”，不同模式下按键功能不同，组合操作可以极大提升编辑效率。下列是几个核心模式：</p><ol><li><strong>普通模式（Normal Mode）</strong>：Vim 启动后默认进入的模式，用于导航、删除、复制等操作。</li><li><strong>插入模式（Insert Mode）</strong>：按 <code>i</code>、<code>a</code>、<code>o</code> 等键进入，可进行正常的文本输入。</li><li><strong>可视模式（Visual Mode）</strong>：按 <code>v</code>（字符可视模式）、<code>V</code>（行可视模式）或 <code>Ctrl + v</code>（块可视模式）进入，用于批量选定文本后再执行批量操作。</li><li><strong>命令模式（Command Mode）</strong>：在普通模式下按 <code>:</code> 进入，执行如保存、替换等命令。</li><li><strong>替换模式（Replace Mode）</strong>：按 <code>R</code> 进入，输入的新字符将覆盖光标后的文本。</li></ol><p>退出回到普通模式只需按 <code>Esc</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如，在普通模式下执行删除操作：</span></span><br><span class="line"><span class="comment"># dd  -&gt; 删除当前行</span></span><br><span class="line"><span class="comment"># dw  -&gt; 删除一个单词</span></span><br><span class="line"><span class="comment"># x   -&gt; 删除当前字符</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 在可视模式下快速选中多行：</span></span><br><span class="line"><span class="comment"># v   -&gt; 进入字符可视模式</span></span><br><span class="line"><span class="comment"># j   -&gt; 向下移动选中多行</span></span><br><span class="line"><span class="comment"># d   -&gt; 删除选中的所有行</span></span><br></pre></td></tr></table></figure><h2 id="1-文件操作"><a class="header-anchor" href="#1-文件操作">¶</a>1. 文件操作</h2><ul><li><code>:w</code>：保存文件（Write）。</li><li><code>:q</code>：退出（Quit）。</li><li><code>:wq</code> 或 <code>:x</code>：保存并退出。</li><li><code>:q!</code>：强制退出，不保存更改。</li><li><code>:e filename</code>：打开或编辑新的文件。</li><li><code>:saveas filename</code>：另存为指定文件。（或者 <code>:w 文件路径</code>）</li></ul><p>这些命令都需要先进入命令模式（在普通模式下按 <code>:</code>）。</p><h2 id="2-光标移动与翻屏"><a class="header-anchor" href="#2-光标移动与翻屏">¶</a>2. 光标移动与翻屏</h2><ul><li><code>h / j / k / l</code>：分别向左、下、上、右移动一个字符。</li><li><code>0</code>：移动到行首，<code>^</code>：移动到本行第一个非空字符。</li><li><code>$</code>：移动到行尾。</li><li><code>w / b</code>：向后/向前移动一个单词。</li><li><code>Ctrl + f</code> / <code>Ctrl + b</code>：向下/向上翻一屏。</li><li><code>gg</code>：移动到文件开头，<code>G</code>：移动到文件末尾。</li><li><code>&#123;number&#125;G</code>：移动到指定行号。</li></ul><h2 id="3-删除、复制、粘贴与撤销"><a class="header-anchor" href="#3-删除、复制、粘贴与撤销">¶</a>3. 删除、复制、粘贴与撤销</h2><ul><li><strong>删除</strong><ul><li><code>x</code>：删除当前光标字符。</li><li><code>dd</code>：删除当前行。</li><li><code>d&#123;motion&#125;</code>：配合移动指令一次性删除，比如 <code>dw</code> 删至下个单词开头、<code>d$</code> 删至行尾。</li><li><code>G</code>：删除当前行的该位置到最后的所有内容</li></ul></li><li><strong>复制（yank）</strong><ul><li><code>yy</code>：复制当前行。</li><li><code>y&#123;motion&#125;</code>：配合移动指令复制一定范围（如 <code>yw</code> 复制一个单词）。</li></ul></li><li><strong>粘贴</strong><ul><li><code>p</code>：在光标后粘贴（粘贴到下一行或光标右侧）。</li><li><code>P</code>：在光标前粘贴（粘贴到上一行或光标左侧）。</li><li>要粘贴大量代码或者配置文件，可能会被自动注释，建议先进入 <code>:set paste</code> 模式。</li></ul></li><li><strong>撤销与重做</strong><ul><li><code>u</code>：撤销最近一次操作。</li><li><code>Ctrl + r</code>：重做被撤销的操作。</li></ul></li></ul><h2 id="4-剪切（移动文本）"><a class="header-anchor" href="#4-剪切（移动文本）">¶</a>4. 剪切（移动文本）</h2><ul><li><code>dd</code>：删除当前行，也可视为剪切当前行。</li><li>复制并删除原位置的组合，等效于剪切后粘贴到目标位置。例如：<ol><li><code>dd</code>（剪切一行）</li><li>移动光标到目标行</li><li><code>p</code>（粘贴）</li></ol></li></ul><h2 id="5-命令模式下常用命令"><a class="header-anchor" href="#5-命令模式下常用命令">¶</a>5. 命令模式下常用命令</h2><ul><li><code>:set number</code>：显示行号。</li><li><code>:noh</code>：取消搜索高亮。</li><li><code>:maps</code> / <code>:verbose map</code> 等：查看当前映射（可用于排查快捷键冲突）。</li><li><code>:!命令</code>：执行外部命令，如 <code>:!ls</code> 列出当前目录。</li></ul><h1>Vim 高级应用</h1><h2 id="1-多窗口与分屏"><a class="header-anchor" href="#1-多窗口与分屏">¶</a>1. 多窗口与分屏</h2><p>对于大文件或多文件协同查看，Vim 提供了强大的分屏与多窗口功能：</p><ul><li><p><code>:split</code> 或 <code>:sp</code>：水平分割当前窗口。</p></li><li><p><code>:vsplit</code> 或 <code>:vsp</code>：垂直分割当前窗口。</p></li><li><p><code>Ctrl + w</code> 后跟 <code>h/j/k/l</code>：在分割窗口之间移动光标。</p></li><li><p><code>:close</code>：关闭当前分割窗口。</p></li><li><p><code>:only</code>：保留当前窗口并关闭其他所有分屏。</p></li><li><p><code>:tabnew</code>：新建标签页，类似浏览器多标签模式。</p></li><li><p><code>gt</code> / <code>gT</code>：在标签页之间切换。</p></li><li><p>多人打开一个文件，会有一个 <code>swp</code> 文件，<code>vim</code> 该文件会提示你可以进行的操作：继续、不管、退出等。</p><p><img src="/Linux-Vim-%E8%A7%A3%E6%9E%90/image-20250113231311535.png" alt="image-20250113231311535"></p><p>或者没有正常退出也会出现这个问题，不要数据的话直接删掉 <code>swp</code> 文件就行，要数据的话 <code>vim</code> 原始的文件，进行命令选择，之后再删除 <code>swp</code> 文件。</p></li></ul><p>灵活运用分屏和多标签，可以同时查看多个文件或多个部分，提高编辑与对比效率。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以试试在同一文件中查看不同位置：</span></span><br><span class="line"><span class="comment"># :split</span></span><br><span class="line"><span class="comment"># :vsplit</span></span><br><span class="line"><span class="comment"># 然后使用 Ctrl + w + h/j/k/l 在各窗口之间切换</span></span><br></pre></td></tr></table></figure><h2 id="2-宏录制与应用"><a class="header-anchor" href="#2-宏录制与应用">¶</a>2. 宏录制与应用</h2><p>在处理重复性操作时，Vim 的宏功能特别高效。可以将一系列操作录制下来，然后对其他文本执行相同操作。</p><ul><li><code>q&#123;register&#125;</code>：开始录制宏到指定寄存器（如 <code>q a</code> 录制到 <code>a</code> 寄存器）。</li><li>任意编辑操作（如移动、删除、插入文本）。</li><li><code>q</code>：停止录制。</li><li><code>@&#123;register&#125;</code>：调用宏（执行刚才录制的步骤）。</li><li><code>@@</code>：重复上一次调用的宏。</li></ul><p>若需多次重复，只需在普通模式下输入 <code>&#123;number&#125;@&#123;register&#125;</code>，就能批量执行宏。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 宏录制实例：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1. 在普通模式下输入：qa （开始录制到寄存器 a）</span></span><br><span class="line"><span class="comment"># 2. 进行一系列操作，如 dd（删除行），p（粘贴），j（下移一行）</span></span><br><span class="line"><span class="comment"># 3. 输入 q 结束录制</span></span><br><span class="line"><span class="comment"># 4. @a  -&gt; 执行宏</span></span><br><span class="line"><span class="comment"># 5. 10@a -&gt; 执行宏 10 次</span></span><br></pre></td></tr></table></figure><h2 id="3-代码折叠"><a class="header-anchor" href="#3-代码折叠">¶</a>3. 代码折叠</h2><p>当你需要在大文件中专注于某个代码块或区域时，可以使用折叠功能隐藏不关心的部分：</p><ul><li><code>zR</code>：展开所有折叠。</li><li><code>zM</code>：折叠所有。</li><li><code>za</code>：切换当前块折叠/展开状态。</li><li><code>zc</code>：折叠当前代码块。</li><li><code>zo</code>：展开当前代码块。</li></ul><p>这在查看函数、类或配置文件的片段时尤为实用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若有一个大函数，可以在函数块内键入：</span></span><br><span class="line"><span class="comment"># zc -&gt; 折叠当前块</span></span><br><span class="line"><span class="comment"># za -&gt; 切换当前块折叠状态</span></span><br></pre></td></tr></table></figure><h2 id="4-批量替换"><a class="header-anchor" href="#4-批量替换">¶</a>4. 批量替换</h2><p>Vim 支持非常灵活的替换和正则匹配。基本格式为：</p><p><code>:s/旧内容/新内容/g</code><br>仅替换当前行所有匹配，不加 <code>g</code> 就只会匹配第一个。</p><p><code>:%s/旧内容/新内容/g</code><br>替换整个文件所有匹配。</p><p>需要更精细的范围时，可以在命令前加行号或选中可视模式后输入 <code>:s</code> 命令。</p><ul><li><code>:10,20s/foo/bar/g</code>：仅在第 10~20 行执行替换。</li><li>正则表达式可极大增强替换能力，例如匹配复杂模式并加入分组。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如，将所有 &quot;TODO&quot; 替换为 &quot;DONE&quot;：</span></span><br><span class="line"><span class="comment"># :%s/TODO/DONE/g</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 将 10 行到 20 行之间的 &quot;abc&quot; 替换为 &quot;xyz&quot;：</span></span><br><span class="line"><span class="comment"># :10,20s/abc/xyz/g</span></span><br></pre></td></tr></table></figure><h2 id="5-自定义与配置"><a class="header-anchor" href="#5-自定义与配置">¶</a>5. 自定义与配置</h2><p>Vim 可以高度定制，通过修改 <code>~/.vimrc</code>（或 <code>~/.config/nvim/init.vim</code> 在 Neovim 中）实现个性化配置：</p><ul><li><code>set number</code>：显示行号。</li><li><code>set expandtab</code>、<code>set tabstop=4</code>、<code>set shiftwidth=4</code>：控制 Tab 与缩进。</li><li><code>syntax on</code>：开启语法高亮。高亮的两种方式：<ul><li>修改文件后缀</li><li>加文件头，例如：<ul><li><code>#! /bin/bash</code></li><li><code>#! /usr/bin/python</code>，加完之后退出重进</li></ul></li></ul></li><li><code>set relativenumber</code>：相对行号，方便行距离计算。</li><li>使用 <strong>autocmd</strong> 设置自动命令，如保存前自动去除行尾空白等。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 典型 .vimrc 示例如下：</span></span><br><span class="line"><span class="built_in">set</span> number</span><br><span class="line"><span class="built_in">set</span> expandtab</span><br><span class="line"><span class="built_in">set</span> tabstop=4</span><br><span class="line"><span class="built_in">set</span> shiftwidth=4</span><br><span class="line">syntax on</span><br><span class="line"><span class="built_in">set</span> cursorline</span><br><span class="line">autocmd BufWritePre * :%s/\s\+$//e</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;很多人学 Vim 的挫败感，来自“记了很多快捷键，但不知道该怎么组成一套顺手的编辑流程”。Vim 的核心其实只有一件事：&lt;strong&gt;模式化编辑&lt;/strong&gt;——用少量的模式 + 可组合的动作（motion）与操作符（operator），把“移动—选择—修改”变成可重复、可迁移的肌肉记忆。本文会从最常用的几种模式开始，讲清楚每种模式负责什么、该什么时候切换；再把高频的移动、删除/复制/粘贴、撤销/重做、搜索/替换、块编辑等整理成一套能直接上手的练习路径。读完你应该能用 Vim 完成日常写代码/改配置的 80% 操作，并且知道剩下 20% 该去哪里查、怎么组合出来。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Vim Essentials: Modal Editing, Motions, and a Repeatable Workflow</title>
    <link href="https://chenk.top/en/vim-essentials/"/>
    <id>https://chenk.top/en/vim-essentials/</id>
    <published>2025-01-11T16:00:00.000Z</published>
    <updated>2026-01-29T17:08:22.492Z</updated>
    
    <content type="html"><![CDATA[<p>Many people bounce off Vim because they try to <strong>memorize shortcuts</strong> without learning the underlying composition rules. Vim is not “a bag of hotkeys”; it’s <strong>modal editing</strong> + a small set of <strong>motions</strong> and <strong>operators</strong> that combine into a workflow you can repeat across files, languages, and machines. This post focuses on the 80% you’ll actually use daily, then shows you how to scale to the remaining 20% by composing patterns rather than hunting for one-off commands.</p><span id="more"></span><h2 id="The-core-idea-modes-composable-operations"><a class="header-anchor" href="#The-core-idea-modes-composable-operations">¶</a>The core idea: modes + composable operations</h2><p>Vim is built around a simple loop:</p><ol><li>Move to what you want to change (<strong>motion</strong>)</li><li>Select the scope (implicitly by the motion, or explicitly via Visual mode)</li><li>Apply an action (<strong>operator</strong>) like delete/change/yank</li></ol><p>If you learn the grammar, you stop “remembering keys” and start “speaking Vim”.</p><h3 id="The-essential-modes"><a class="header-anchor" href="#The-essential-modes">¶</a>The essential modes</h3><ul><li><strong>Normal mode</strong>: navigation and commands (default when Vim starts)</li><li><strong>Insert mode</strong>: typing text</li><li><strong>Visual mode</strong>: selecting text (character/line/block)</li><li><strong>Command-line mode</strong>: <code>:</code> commands (save, search/replace, settings, etc.)</li><li><strong>Replace mode</strong>: overwrite characters (<code>R</code>)</li></ul><p>Rule of thumb: spend most time in <strong>Normal mode</strong>; treat Insert as a temporary detour.</p><p>To return to Normal mode from anywhere: press <code>Esc</code>.</p><h3 id="Operators-and-motions-the-“Vim-grammar”"><a class="header-anchor" href="#Operators-and-motions-the-“Vim-grammar”">¶</a>Operators and motions (the “Vim grammar”)</h3><p>Common operators:</p><ul><li><code>d</code> delete</li><li><code>c</code> change (delete + enter Insert)</li><li><code>y</code> yank (copy)</li></ul><p>Motions / text objects define “how much”:</p><ul><li><code>w</code> next word, <code>b</code> previous word</li><li><code>0</code> start of line, <code>^</code> first non-blank, <code>$</code> end of line</li><li><code>gg</code> top of file, <code>G</code> end of file, <code>&#123;number&#125;G</code> go to line</li><li>text objects: <code>iw</code> inner word, <code>ip</code> inner paragraph, <code>i&quot;</code> inside quotes, etc.</li></ul><p>Examples you should internalize:</p><ul><li><code>dw</code> delete word</li><li><code>d$</code> delete to end of line</li><li><code>ciw</code> change inner word</li><li><code>yip</code> yank paragraph</li></ul><h2 id="File-operations-save-quit-open"><a class="header-anchor" href="#File-operations-save-quit-open">¶</a>File operations (save, quit, open)</h2><p>These are command-line mode (<code>:</code>) commands:</p><ul><li><code>:w</code> save (write)</li><li><code>:q</code> quit</li><li><code>:wq</code> / <code>:x</code> save and quit</li><li><code>:q!</code> quit without saving</li><li><code>:e filename</code> open/edit another file</li><li><code>:saveas filename</code> save as a new file (similar to <code>:w &lt;path&gt;</code>)</li></ul><h2 id="Movement-and-scrolling-fast-navigation"><a class="header-anchor" href="#Movement-and-scrolling-fast-navigation">¶</a>Movement and scrolling (fast navigation)</h2><p>Basic cursor movement:</p><ul><li><code>h/j/k/l</code>: left/down/up/right (use this only when learning)</li><li><code>w/b</code>: next/previous word</li><li><code>0</code>, <code>^</code>, <code>$</code>: line start / first non-blank / line end</li><li><code>gg</code>, <code>G</code>, <code>&#123;number&#125;G</code>: top / bottom / go to line</li></ul><p>Screen/page movement:</p><ul><li><code>Ctrl+f</code> / <code>Ctrl+b</code>: page forward/back</li><li><code>Ctrl+d</code> / <code>Ctrl+u</code>: half-page down/up</li></ul><p>Practical tip: combine search with motion. Most movement should be “jump” not “crawl”.</p><h2 id="Delete-yank-paste-undo-redo"><a class="header-anchor" href="#Delete-yank-paste-undo-redo">¶</a>Delete, yank, paste, undo/redo</h2><h3 id="Delete"><a class="header-anchor" href="#Delete">¶</a>Delete</h3><ul><li><code>x</code> delete character under cursor</li><li><code>dd</code> delete current line</li><li><code>d&#123;motion&#125;</code> delete a range defined by a motion (<code>dw</code>, <code>d$</code>, <code>dG</code>, etc.)</li></ul><h3 id="Yank-copy"><a class="header-anchor" href="#Yank-copy">¶</a>Yank (copy)</h3><ul><li><code>yy</code> yank current line</li><li><code>y&#123;motion&#125;</code> yank a motion-defined range (<code>yw</code>, <code>y$</code>, etc.)</li></ul><h3 id="Paste"><a class="header-anchor" href="#Paste">¶</a>Paste</h3><ul><li><code>p</code> paste <strong>after</strong> cursor (or below the line)</li><li><code>P</code> paste <strong>before</strong> cursor (or above the line)</li></ul><p>If you paste large blocks and auto-indentation/comments get in the way, consider temporarily enabling paste mode:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> paste</span><br></pre></td></tr></table></figure><p>Turn it off after:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> nopaste</span><br></pre></td></tr></table></figure><h3 id="Undo-redo"><a class="header-anchor" href="#Undo-redo">¶</a>Undo/redo</h3><ul><li><code>u</code> undo</li><li><code>Ctrl+r</code> redo</li></ul><h2 id="Cut-move-text-as-“delete-then-paste”"><a class="header-anchor" href="#Cut-move-text-as-“delete-then-paste”">¶</a>Cut (move text) as “delete then paste”</h2><p>There is no separate “cut” command: it’s just delete + paste.</p><p>Example: move a line elsewhere:</p><ol><li><code>dd</code> (delete the line — it goes into a register)</li><li>move cursor</li><li><code>p</code> to paste</li></ol><h2 id="Useful-command-line-mode-settings"><a class="header-anchor" href="#Useful-command-line-mode-settings">¶</a>Useful command-line mode settings</h2><p>These help daily use and debugging:</p><ul><li><code>:set number</code> show line numbers</li><li><code>:set relativenumber</code> relative numbers (great for <code>5j</code>, <code>10k</code>)</li><li><code>:noh</code> clear search highlight</li><li><code>:map</code> / <code>:verbose map</code> inspect key mappings (useful for conflicts)</li><li><code>:!&lt;cmd&gt;</code> run a shell command (e.g., <code>:!ls</code>)</li></ul><h2 id="Windows-splits-and-tabs-work-on-multiple-views"><a class="header-anchor" href="#Windows-splits-and-tabs-work-on-multiple-views">¶</a>Windows, splits, and tabs (work on multiple views)</h2><p>Splits:</p><ul><li><code>:split</code> / <code>:sp</code> horizontal split</li><li><code>:vsplit</code> / <code>:vsp</code> vertical split</li><li>move between windows: <code>Ctrl+w</code> then <code>h/j/k/l</code></li><li><code>:close</code> close current split</li><li><code>:only</code> close all other splits</li></ul><p>Tabs:</p><ul><li><code>:tabnew</code> open a new tab</li><li><code>gt</code> / <code>gT</code> next/previous tab</li></ul><h3 id="The-swap-file-swp-warning"><a class="header-anchor" href="#The-swap-file-swp-warning">¶</a>The swap file (<code>.swp</code>) warning</h3><p>If Vim detects that a file is already open (or the last session crashed), it may warn you about a swap file. You can choose to recover, open read-only, or abort.</p><p><img src="/en/vim-essentials/image-20250113231311535.png" alt="swap file warning"></p><p>If you don’t need recovery, deleting the <code>.swp</code> file resolves the warning; if you do, follow Vim’s recovery prompt first, then clean up the swap file.</p><h2 id="Macros-automate-repetitive-edits"><a class="header-anchor" href="#Macros-automate-repetitive-edits">¶</a>Macros: automate repetitive edits</h2><p>Macros are the highest-ROI “advanced” feature because they turn repetition into a one-time recording.</p><ul><li><code>q&#123;register&#125;</code> start recording (e.g. <code>qa</code> records into register <code>a</code>)</li><li>perform edits (moves, deletes, inserts, etc.)</li><li><code>q</code> stop recording</li><li><code>@&#123;register&#125;</code> replay (e.g. <code>@a</code>)</li><li><code>@@</code> repeat the last macro</li><li><code>&#123;number&#125;@&#123;register&#125;</code> repeat N times (e.g. <code>10@a</code>)</li></ul><p>Example workflow:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">qa        (start recording)</span><br><span class="line">...       (do your edits)</span><br><span class="line">q         (stop)</span><br><span class="line">10@a      (apply to next 10 lines/blocks)</span><br></pre></td></tr></table></figure><h2 id="Code-folding-focus-on-the-part-that-matters"><a class="header-anchor" href="#Code-folding-focus-on-the-part-that-matters">¶</a>Code folding (focus on the part that matters)</h2><p>Fold commands:</p><ul><li><code>zR</code> open all folds</li><li><code>zM</code> close all folds</li><li><code>za</code> toggle fold under cursor</li><li><code>zc</code> close fold</li><li><code>zo</code> open fold</li></ul><p>Folding is extremely useful for large config files or long functions when you want to work locally.</p><h2 id="Search-and-replace-with-ranges"><a class="header-anchor" href="#Search-and-replace-with-ranges">¶</a>Search and replace (with ranges)</h2><p>Basic patterns:</p><ul><li><code>:s/old/new/</code> replace the first match on the current line</li><li><code>:s/old/new/g</code> replace all matches on the current line</li><li><code>:%s/old/new/g</code> replace across the whole file</li></ul><p>Target a line range:</p><ul><li><code>:10,20s/foo/bar/g</code> replace only between lines 10–20</li></ul><p>Tip: start with a narrow range, verify, then expand. Search/replace is powerful and easy to misuse.</p><h2 id="Customization-a-minimal-safe-vimrc"><a class="header-anchor" href="#Customization-a-minimal-safe-vimrc">¶</a>Customization: a minimal, safe <code>.vimrc</code></h2><p>Vim becomes comfortable once you set a few defaults:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">number</span></span><br><span class="line"><span class="keyword">set</span> relativenumber</span><br><span class="line"><span class="keyword">set</span> expandtab</span><br><span class="line"><span class="keyword">set</span> tabstop=<span class="number">4</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">shiftwidth</span>=<span class="number">4</span></span><br><span class="line"><span class="keyword">syntax</span> <span class="keyword">on</span></span><br><span class="line"><span class="keyword">set</span> cursorline</span><br><span class="line"></span><br><span class="line"><span class="comment">&quot; Trim trailing whitespace on save (safe default for many projects)</span></span><br><span class="line"><span class="keyword">autocmd</span> BufWritePre * :%s/\s\+$//<span class="keyword">e</span></span><br></pre></td></tr></table></figure><p>If you use Neovim, the equivalent config often lives at <code>~/.config/nvim/init.vim</code> (or <code>init.lua</code>).</p><h2 id="A-practical-practice-plan-how-to-actually-get-fluent"><a class="header-anchor" href="#A-practical-practice-plan-how-to-actually-get-fluent">¶</a>A practical practice plan (how to actually get fluent)</h2><ol><li>Spend one week using only: <code>hjkl</code>, <code>w/b</code>, <code>0/^/$</code>, <code>dd</code>, <code>dw</code>, <code>ciw</code>, <code>/search</code>, <code>:%s</code>.</li><li>Add macros (<code>qa</code>, <code>@a</code>) for repetitive edits.</li><li>Add a few text objects (<code>iw</code>, <code>ip</code>, <code>i&quot;</code>, <code>i)</code>) to reduce “manual selection”.</li><li>Only then start customizing keymaps—avoid early over-customization.</li></ol><p>Once these are muscle memory, Vim stops feeling “hard” and starts feeling “fast”.</p><hr><h2 id="Advanced-text-objects-precision-editing-without-Visual-mode"><a class="header-anchor" href="#Advanced-text-objects-precision-editing-without-Visual-mode">¶</a>Advanced text objects (precision editing without Visual mode)</h2><p>Text objects let you operate on semantic units (words, sentences, paragraphs, blocks) without manually selecting boundaries.</p><h3 id="Inner-vs-“a”-around"><a class="header-anchor" href="#Inner-vs-“a”-around">¶</a>Inner vs “a” (around)</h3><ul><li><code>i</code> (inner): excludes delimiters</li><li><code>a</code> (around): includes delimiters</li></ul><p>Examples:</p><ul><li><code>ciw</code> change <strong>inner</strong> word (cursor anywhere in the word)</li><li><code>ci&quot;</code> change inside quotes (cursor must be inside <code>&quot;...&quot;</code>)</li><li><code>ca&quot;</code> change <strong>around</strong> quotes (includes the quotes themselves)</li><li><code>dip</code> delete inner paragraph</li><li><code>di(</code> delete inside parentheses</li><li><code>da&#123;</code> delete around braces (includes <code>&#123;</code> and <code>&#125;</code>)</li></ul><h3 id="Common-text-objects"><a class="header-anchor" href="#Common-text-objects">¶</a>Common text objects</h3><table><thead><tr><th>Text object</th><th>Meaning</th><th>Example</th></tr></thead><tbody><tr><td><code>iw</code> / <code>aw</code></td><td>inner/around word</td><td><code>ciw</code> change word</td></tr><tr><td><code>is</code> / <code>as</code></td><td>inner/around sentence</td><td><code>dis</code> delete sentence</td></tr><tr><td><code>ip</code> / <code>ap</code></td><td>inner/around paragraph</td><td><code>yip</code> yank paragraph</td></tr><tr><td><code>i&quot;</code> / <code>a&quot;</code></td><td>inside/around <code>&quot;...&quot;</code></td><td><code>ci&quot;</code> change string</td></tr><tr><td><code>i'</code> / <code>a'</code></td><td>inside/around <code>'...'</code></td><td><code>di'</code> delete single-quoted</td></tr><tr><td><code>i(</code> / <code>a(</code></td><td>inside/around <code>(...)</code></td><td><code>da(</code> delete with parens</td></tr><tr><td><code>i&#123;</code> / <code>a&#123;</code></td><td>inside/around <code>&#123;...&#125;</code></td><td><code>ci&#123;</code> change block</td></tr><tr><td><code>i[</code> / <code>a[</code></td><td>inside/around <code>[...]</code></td><td><code>di[</code> delete array</td></tr><tr><td><code>it</code> / <code>at</code></td><td>inside/around HTML tag</td><td><code>cit</code> change tag content</td></tr></tbody></table><p><strong>Why this matters</strong>: You stop thinking “select then act” and start thinking “act on semantic unit”.</p><hr><h2 id="Registers-where-deleted-yanked-text-goes"><a class="header-anchor" href="#Registers-where-deleted-yanked-text-goes">¶</a>Registers: where deleted/yanked text goes</h2><p>When you delete or yank, the text goes into a <strong>register</strong> (a clipboard-like slot).</p><h3 id="Common-registers"><a class="header-anchor" href="#Common-registers">¶</a>Common registers</h3><ul><li><strong>Unnamed register</strong> (<code>&quot;&quot;</code>): last delete/yank</li><li><strong>Named registers</strong> (<code>&quot;a</code> to <code>&quot;z</code>): manual storage</li><li><strong>Numbered registers</strong> (<code>&quot;0</code> to <code>&quot;9</code>): yank history</li><li><strong>System clipboard</strong> (<code>&quot;+</code> or <code>&quot;*</code> on Linux/Mac, <code>&quot;+</code> on Windows): share with OS</li></ul><h3 id="How-to-use-registers"><a class="header-anchor" href="#How-to-use-registers">¶</a>How to use registers</h3><p><strong>Yank into a named register</strong>:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;ayy    &quot;</span> <span class="keyword">yank</span> <span class="built_in">line</span> into register <span class="keyword">a</span></span><br></pre></td></tr></table></figure><p><strong>Paste from a named register</strong>:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;ap     &quot;</span> paste from register <span class="keyword">a</span></span><br></pre></td></tr></table></figure><p><strong>View all registers</strong>:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">reg</span></span><br></pre></td></tr></table></figure><p><strong>Copy to system clipboard</strong> (if Vim compiled with <code>+clipboard</code>):</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;+yy    &quot;</span> <span class="keyword">yank</span> <span class="built_in">line</span> <span class="keyword">to</span> <span class="built_in">system</span> clipboard</span><br><span class="line"><span class="string">&quot;+p     &quot;</span> paste from <span class="built_in">system</span> clipboard</span><br></pre></td></tr></table></figure><p><strong>Pro tip</strong>: Use named registers to collect multiple snippets before pasting them in sequence.</p><hr><h2 id="Marks-bookmarks-for-fast-jumps"><a class="header-anchor" href="#Marks-bookmarks-for-fast-jumps">¶</a>Marks: bookmarks for fast jumps</h2><p>Marks let you jump back to specific positions in a file (or across files).</p><h3 id="How-to-set-marks"><a class="header-anchor" href="#How-to-set-marks">¶</a>How to set marks</h3><ul><li><code>m&#123;letter&#125;</code> set a mark (e.g., <code>ma</code> sets mark <code>a</code> at current cursor position)</li><li>lowercase (<code>a-z</code>): local to current file</li><li>uppercase (<code>A-Z</code>): global across files</li></ul><h3 id="How-to-jump-to-marks"><a class="header-anchor" href="#How-to-jump-to-marks">¶</a>How to jump to marks</h3><ul><li><code>`&#123;letter&#125;</code> jump to exact position (line and column)</li><li><code>'&#123;letter&#125;</code> jump to line (first non-blank character)</li></ul><p><strong>Example workflow</strong>:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ma</span>          <span class="comment">&quot; mark current position as &#x27;a&#x27;</span></span><br><span class="line">(... navigate elsewhere ...)</span><br><span class="line">`<span class="keyword">a</span>          <span class="comment">&quot; jump back to mark &#x27;a&#x27;</span></span><br></pre></td></tr></table></figure><p><strong>Special marks</strong>:</p><ul><li><code>`.</code> jump to last edit position</li><li><code>`0</code> jump to position when Vim last exited</li><li><code>`&quot;</code> jump to position when last editing this file</li></ul><hr><h2 id="Visual-mode-variants-character-line-block"><a class="header-anchor" href="#Visual-mode-variants-character-line-block">¶</a>Visual mode variants (character, line, block)</h2><p>Visual mode has three variants:</p><ol><li><strong>Character-wise</strong> (<code>v</code>): select characters</li><li><strong>Line-wise</strong> (<code>V</code>): select whole lines</li><li><strong>Block-wise</strong> (<code>Ctrl+v</code>): select rectangular blocks (amazing for columnar edits)</li></ol><h3 id="Block-mode-examples"><a class="header-anchor" href="#Block-mode-examples">¶</a>Block mode examples</h3><p><strong>Use case 1: Comment out multiple lines</strong></p><ol><li><code>Ctrl+v</code> enter block mode</li><li><code>jjj...</code> select lines</li><li><code>I#</code> insert <code>#</code> at the start</li><li><code>Esc</code> apply to all selected lines</li></ol><p><strong>Use case 2: Delete a column</strong></p><ol><li><code>Ctrl+v</code> enter block mode</li><li>Select the column</li><li><code>d</code> delete</li></ol><p><strong>Use case 3: Append to multiple lines</strong></p><ol><li><code>Ctrl+v</code> enter block mode</li><li><code>jjj...</code> select lines</li><li><code>A;</code> append <code>;</code> to the end</li><li><code>Esc</code> apply to all</li></ol><p><strong>Why block mode is powerful</strong>: It solves “edit the same column on 20 lines” problems that would require regex or macros in other editors.</p><hr><h2 id="Buffers-vs-windows-vs-tabs-mental-model"><a class="header-anchor" href="#Buffers-vs-windows-vs-tabs-mental-model">¶</a>Buffers vs windows vs tabs (mental model)</h2><p>Many Vim beginners confuse these three concepts:</p><table><thead><tr><th>Concept</th><th>What it is</th><th>Commands</th></tr></thead><tbody><tr><td><strong>Buffer</strong></td><td>A file loaded into memory</td><td><code>:ls</code>, <code>:b &lt;name&gt;</code>, <code>:bnext</code>, <code>:bprev</code></td></tr><tr><td><strong>Window</strong></td><td>A viewport showing a buffer</td><td><code>:split</code>, <code>:vsplit</code>, <code>Ctrl+w</code> motions</td></tr><tr><td><strong>Tab</strong></td><td>A layout of windows</td><td><code>:tabnew</code>, <code>gt</code>, <code>gT</code></td></tr></tbody></table><p><strong>Mental model</strong>:</p><ul><li>One file = one buffer (even if not visible)</li><li>You can have multiple windows showing the same buffer</li><li>Tabs organize window layouts</li></ul><p><strong>Common workflow</strong>:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">e</span> file1.<span class="keyword">py</span>       <span class="comment">&quot; open file1 in current buffer</span></span><br><span class="line">:<span class="keyword">split</span> file2.<span class="keyword">py</span>   <span class="comment">&quot; open file2 in a new horizontal split</span></span><br><span class="line">:<span class="keyword">vsplit</span> file3.<span class="keyword">py</span>  <span class="comment">&quot; open file3 in a vertical split</span></span><br><span class="line">Ctrl+<span class="keyword">w</span> <span class="keyword">w</span>          <span class="comment">&quot; cycle between windows</span></span><br></pre></td></tr></table></figure><hr><h2 id="Search-patterns-and-flags-find-anything"><a class="header-anchor" href="#Search-patterns-and-flags-find-anything">¶</a>Search patterns and flags (find anything)</h2><p>Basic search uses <code>/</code> (forward) or <code>?</code> (backward):</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/pattern   <span class="comment">&quot; search forward</span></span><br><span class="line">?pattern   <span class="comment">&quot; search backward</span></span><br><span class="line">n          <span class="comment">&quot; next match</span></span><br><span class="line"><span class="keyword">N</span>          <span class="comment">&quot; previous match</span></span><br></pre></td></tr></table></figure><h3 id="Search-flags"><a class="header-anchor" href="#Search-flags">¶</a>Search flags</h3><ul><li><code>\c</code> case-insensitive (e.g., <code>/foo\c</code>)</li><li><code>\C</code> case-sensitive</li><li><code>\&lt;</code> word boundary start (e.g., <code>/\&lt;foo\&gt;</code> matches <code>foo</code> but not <code>foobar</code>)</li><li><code>\&gt;</code> word boundary end</li></ul><h3 id="Highlight-search-results"><a class="header-anchor" href="#Highlight-search-results">¶</a>Highlight search results</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> hlsearch    <span class="comment">&quot; highlight matches</span></span><br><span class="line">:<span class="keyword">noh</span>             <span class="comment">&quot; clear highlights</span></span><br></pre></td></tr></table></figure><h3 id="Search-and-replace-with-confirmation"><a class="header-anchor" href="#Search-and-replace-with-confirmation">¶</a>Search and replace with confirmation</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%s/old/<span class="keyword">new</span>/gc   <span class="comment">&quot; replace all with confirmation (y/n/a/q)</span></span><br></pre></td></tr></table></figure><p><strong>Tips</strong>:</p><ul><li>Start with <code>/pattern</code> to verify what you’re matching</li><li>Then run <code>:%s//new/g</code> (empty pattern reuses last search)</li></ul><hr><h2 id="Common-pitfalls-and-how-to-fix-them"><a class="header-anchor" href="#Common-pitfalls-and-how-to-fix-them">¶</a>Common pitfalls and how to fix them</h2><h3 id="Pitfall-1-Auto-indentation-breaks-paste"><a class="header-anchor" href="#Pitfall-1-Auto-indentation-breaks-paste">¶</a>Pitfall 1: Auto-indentation breaks paste</h3><p><strong>Symptom</strong>: Pasted code gets progressively indented.</p><p><strong>Fix</strong>: Use paste mode:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> paste</span><br><span class="line">(paste your code)</span><br><span class="line">:<span class="keyword">set</span> nopaste</span><br></pre></td></tr></table></figure><p>Or use <code>&quot;+p</code> (system clipboard) which auto-detects.</p><h3 id="Pitfall-2-Accidentally-enter-Replace-mode"><a class="header-anchor" href="#Pitfall-2-Accidentally-enter-Replace-mode">¶</a>Pitfall 2: Accidentally enter Replace mode</h3><p><strong>Symptom</strong>: Typing overwrites characters instead of inserting.</p><p><strong>Cause</strong>: Pressed <code>R</code> or <code>Insert</code> key.</p><p><strong>Fix</strong>: Press <code>Esc</code> to return to Normal mode.</p><h3 id="Pitfall-3-Swap-file-warning-on-every-open"><a class="header-anchor" href="#Pitfall-3-Swap-file-warning-on-every-open">¶</a>Pitfall 3: Swap file warning on every open</h3><p><strong>Symptom</strong>: Vim always warns about <code>.swp</code> files.</p><p><strong>Cause</strong>: Previous session didn’t exit cleanly.</p><p><strong>Fix</strong>: Delete orphaned swap files:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -name <span class="string">&quot;*.swp&quot;</span> -delete</span><br></pre></td></tr></table></figure><p>Or disable swap files (not recommended for large edits):</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">set</span> noswapfile</span><br></pre></td></tr></table></figure><h3 id="Pitfall-4-Lost-in-a-deep-undo-tree"><a class="header-anchor" href="#Pitfall-4-Lost-in-a-deep-undo-tree">¶</a>Pitfall 4: Lost in a deep undo tree</h3><p><strong>Symptom</strong>: <code>u</code> doesn’t undo what you expect.</p><p><strong>Cause</strong>: Vim has a tree-based undo, not linear.</p><p><strong>Fix</strong>: Use <code>:earlier</code> / <code>:later</code> to travel through time:</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:<span class="keyword">earlier</span> <span class="number">5</span><span class="keyword">m</span>    <span class="comment">&quot; go back 5 minutes</span></span><br><span class="line">:<span class="keyword">later</span> <span class="number">10</span>s     <span class="comment">&quot; go forward 10 seconds</span></span><br></pre></td></tr></table></figure><hr><h2 id="Vim-vs-Neovim-should-you-switch"><a class="header-anchor" href="#Vim-vs-Neovim-should-you-switch">¶</a>Vim vs Neovim: should you switch?</h2><p><strong>Neovim</strong> is a fork of Vim with:</p><ul><li>Modern architecture (better plugin API, async support)</li><li>Built-in LSP (Language Server Protocol) client</li><li>Lua configuration (in addition to Vimscript)</li><li>Active development and community</li></ul><p><strong>When to use Neovim</strong>:</p><ul><li>You want built-in LSP (autocomplete, go-to-definition, diagnostics)</li><li>You prefer Lua over Vimscript for config</li><li>You want the latest features</li></ul><p><strong>When to stick with Vim</strong>:</p><ul><li>Your system already has Vim (servers, containers)</li><li>You prefer stable, widely-deployed software</li><li>You don’t need advanced features</li></ul><p><strong>Bottom line</strong>: Both are excellent. Start with Vim (it’s everywhere), switch to Neovim if you need LSP or modern plugin ecosystems.</p><hr><h2 id="Learning-resources-curated"><a class="header-anchor" href="#Learning-resources-curated">¶</a>Learning resources (curated)</h2><ol><li><p><strong><code>vimtutor</code></strong>: Run this command in your terminal. It’s a 30-minute interactive tutorial built into Vim.</p></li><li><p><strong>Vim Adventures</strong> (<a class="link" href="http://vim-adventures.com">vim-adventures.com<i class="fas fa-external-link-alt"></i></a>): A game that teaches Vim motions.</p></li><li><p><strong>Practical Vim</strong> (book by Drew Neil): The best book for intermediate users.</p></li><li><p><strong>Vim Golf</strong> (<a class="link" href="http://vimgolf.com">vimgolf.com<i class="fas fa-external-link-alt"></i></a>): Optimize keystrokes for specific editing tasks (great for learning advanced tricks).</p></li><li><p><strong>ThePrimeagen</strong> (YouTube): Advanced Vim/Neovim tutorials and workflows.</p></li></ol><hr><h2 id="Summary-Vim-in-10-principles"><a class="header-anchor" href="#Summary-Vim-in-10-principles">¶</a>Summary: Vim in 10 principles</h2><ol><li><strong>Modes are your friend</strong>: Normal mode is home base, Insert is temporary.</li><li><strong>Think “operator + motion”</strong>: <code>d</code> + <code>w</code> = delete word.</li><li><strong>Use text objects</strong>: <code>ciw</code>, <code>di&quot;</code>, <code>yip</code> beat manual selection.</li><li><strong>Search first, then act</strong>: <code>/pattern</code> + <code>n</code> + <code>cw</code> is faster than scrolling.</li><li><strong>Repeat with <code>.</code></strong>: For simple edits, <code>.</code> is the fastest macro.</li><li><strong>Record macros for complex repetition</strong>: <code>qa</code> + edits + <code>q</code> + <code>10@a</code>.</li><li><strong>Master a few motions deeply</strong>: <code>w/b</code>, <code>0/$</code>, <code>gg/G</code>, <code>&#123;/&#125;</code> cover 90% of navigation.</li><li><strong>Don’t over-customize early</strong>: Learn the defaults first, then add keymaps.</li><li><strong>Use splits and buffers</strong>: Don’t open 10 terminal tabs; use <code>:split</code> and <code>:bnext</code>.</li><li><strong>Practice deliberately</strong>: Spend 1 week forcing yourself to use only Vim for all editing.</li></ol><p>Once you internalize the grammar, Vim becomes a <strong>text-editing language</strong> you speak fluently, not a tool you “operate”.</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Many people bounce off Vim because they try to &lt;strong&gt;memorize shortcuts&lt;/strong&gt; without learning the underlying composition rules. Vim is not “a bag of hotkeys”; it’s &lt;strong&gt;modal editing&lt;/strong&gt; + a small set of &lt;strong&gt;motions&lt;/strong&gt; and &lt;strong&gt;operators&lt;/strong&gt; that combine into a workflow you can repeat across files, languages, and machines. This post focuses on the 80% you’ll actually use daily, then shows you how to scale to the remaining 20% by composing patterns rather than hunting for one-off commands.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux 使用基础</title>
    <link href="https://chenk.top/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/"/>
    <id>https://chenk.top/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/</id>
    <published>2025-01-09T16:00:00.000Z</published>
    <updated>2026-01-29T16:03:06.356Z</updated>
    
    <content type="html"><![CDATA[<p>Linux 的&quot;难&quot;往往不在命令本身，而在于你是否有一张清晰的系统地图：它为什么适合服务器、它的多用户多任务与权限模型在日常运维里意味着什么、不同发行版的包管理与目录布局有哪些共性与差异、第一次登录之后应该做什么。本篇是整个 Linux 系列的<strong>入口导览</strong>，会先把核心理念搭起来，然后用一组最常用的命令带你走过&quot;文件导航—查看与编辑—远程连接—权限与用户基础&quot;的基础操作链路。目标不是堆一堆指令表，而是让你从&quot;会登录&quot;走到&quot;有基本方向感&quot;——每个主题都<strong>点到为止</strong>，然后引导你去看对应的专题深入文章（磁盘管理、文件权限、用户管理、服务管理、进程管理、软件包管理、文件操作深入解析），后续再学任何细分主题都会顺很多。</p><span id="more"></span><h1>Linux 核心理念：为什么要学、为什么这么设计</h1><h2 id="为什么选择-Linux（尤其是服务器场景）"><a class="header-anchor" href="#为什么选择-Linux（尤其是服务器场景）">¶</a>为什么选择 Linux（尤其是服务器场景）</h2><ul><li><strong>高可定制</strong>：开源、可免费使用，所有组件都能根据需要进行修改或定制。如果你需要精简系统、定制内核、或者针对特定硬件优化，Linux 是最灵活的选择。</li><li><strong>稳定可靠</strong>：Linux 在服务器、嵌入式等场合使用广泛，拥有较强的稳定性和容错能力。很多关键系统（金融、电信、云平台）跑的都是 Linux，uptime 可以达到数年不重启。</li><li><strong>强大生态</strong>：内置强大的包管理器，丰富的开源软件资源，如常见的 <code>apt</code>（Debian/Ubuntu）、<code>yum</code>/<code>dnf</code>（RHEL/CentOS）等。你需要的大部分工具（数据库、Web 服务器、监控工具、开发语言）都能直接通过包管理器安装，不需要到处下载安装包。</li><li><strong>一切皆文件</strong>：文件系统抽象了各种设备，可以统一方式访问硬盘、网络设备、外设。这个设计理念让 Linux 的接口非常一致：无论是读取磁盘数据、查看进程信息、还是配置网络，都是在&quot;读写文件&quot;。这种一致性让自动化脚本变得很简单。</li><li><strong>命令行优先，但图形界面也有</strong>：大量操作更习惯于 CLI（Command Line Interface）完成，这让远程管理和批量操作非常高效。服务器环境多以命令行为主，但如果你想要图形界面（比如桌面 Linux），很多发行版也提供开箱即用的 GNOME/KDE 桌面。</li></ul><h2 id="常见发行版简要对比（选哪个？）"><a class="header-anchor" href="#常见发行版简要对比（选哪个？）">¶</a>常见发行版简要对比（选哪个？）</h2><ul><li><strong>Ubuntu/Debian 系</strong>：软件包管理器为 <code>apt</code>，社区活跃，文档丰富，适合初学者和开发者。Ubuntu LTS（长期支持版）是云服务器的常见选择。</li><li><strong>CentOS/RHEL 系</strong>：软件包管理器为 <code>yum</code> 或 <code>dnf</code>（CentOS 8+ / RHEL 8+），适合生产环境，稳定性好，企业支持强。CentOS Stream 是 RHEL 的上游，AlmaLinux / Rocky Linux 是 CentOS 的社区替代品。</li><li><strong>SUSE 系</strong>：使用 <code>zypper</code>，在企业级环境及 SAP 相关部署中常见，欧洲企业用得比较多。</li><li><strong>Arch Linux</strong>：滚动更新模型，软件版本最新，但对运维人员要求更高（需要手动配置很多东西）。适合喜欢折腾、追求最新软件的用户。</li></ul><p><strong>实际选择建议</strong>：</p><ul><li>如果是学习或开发，推荐 <strong>Ubuntu LTS</strong>（文档多、社区活跃）。</li><li>如果是企业生产环境，推荐 <strong>RHEL 系</strong>（RHEL / AlmaLinux / Rocky Linux，稳定且有商业支持）。</li><li>如果是云服务器，看云厂商推荐什么（AWS 推 Amazon Linux，阿里云推 Alibaba Cloud Linux，但 Ubuntu 和 CentOS 系也都支持得很好）。</li></ul><h2 id="Linux-的三大核心理念（理解了这三点，很多设计就不会觉得奇怪）"><a class="header-anchor" href="#Linux-的三大核心理念（理解了这三点，很多设计就不会觉得奇怪）">¶</a>Linux 的三大核心理念（理解了这三点，很多设计就不会觉得奇怪）</h2><h3 id="1-多用户、多任务"><a class="header-anchor" href="#1-多用户、多任务">¶</a>1. 多用户、多任务</h3><p>同一时间允许多个用户同时登录（通过 SSH、tty 等），每个用户可并行运行多个任务（进程）。这与 Windows 的&quot;一般只有一个用户在用&quot;的场景不同——Linux 服务器上可能同时有几十个用户在跑不同的任务，系统需要隔离他们的权限、资源、和文件。</p><p>这就是为什么 Linux 的权限模型这么严格：你不能随便看别人的文件，也不能随便杀别人的进程。</p><h3 id="2-权限机制：以文件为核心"><a class="header-anchor" href="#2-权限机制：以文件为核心">¶</a>2. 权限机制：以文件为核心</h3><p>Linux 的权限管理以**文件（含目录）<strong>为核心，通过</strong>读（r）、写（w）、执行（x）<strong>三种权限和</strong>所有者（owner）/ 用户组（group）/ 其他人（others）**的组合来管理访问控制。</p><p>每个文件都有三组权限（owner / group / others），每组权限都有 rwx 三个位，决定了&quot;谁能干什么&quot;。比如：</p><ul><li><code>rwxr-xr-x</code>：owner 可读写执行，group 和 others 可读可执行但不能写。</li><li><code>rw-------</code>：owner 可读写，group 和 others 什么都不能做（常见于私钥文件 <code>~/.ssh/id_rsa</code>）。</li></ul><p>**为什么要这么设计？**因为 Linux 是多用户系统，如果没有权限控制，任何人都能删除别人的文件、修改系统配置，那就乱套了。</p><blockquote><p>权限的深入内容（如 SUID/SGID/Sticky bit、ACL、umask 等）会在 <strong>《Linux 文件权限》</strong> 专题里详细讲，这里只需要知道基本概念。</p></blockquote><h3 id="3-一切皆文件（统一的抽象接口）"><a class="header-anchor" href="#3-一切皆文件（统一的抽象接口）">¶</a>3. 一切皆文件（统一的抽象接口）</h3><p>在 Linux 里，几乎所有东西都被抽象成&quot;文件&quot;，包括：</p><ul><li>普通文件（文本、二进制、脚本）</li><li>目录（也是一种特殊文件）</li><li>设备（<code>/dev/sda</code> 是第一块硬盘，<code>/dev/tty</code> 是终端）</li><li>进程信息（<code>/proc/&lt;pid&gt;/</code> 目录下能看到进程的各种信息）</li><li>系统信息（<code>/sys/</code> 目录下能看到硬件设备树）</li><li>管道、套接字（进程间通信也可以通过&quot;文件&quot;）</li></ul><p><strong>好处</strong>：接口一致。你可以用同样的命令（<code>cat</code>、<code>echo</code>、<code>&gt;</code>、<code>&lt;</code> 等）来操作文件、设备、进程信息。比如：</p><ul><li><code>cat /proc/cpuinfo</code> 查看 CPU 信息</li><li><code>echo 1 &gt; /sys/class/leds/led0/brightness</code> 控制 LED 灯亮度</li><li><code>cat /dev/urandom | head -c 16 &gt; random.bin</code> 生成随机数</li></ul><p>这种一致性让 Linux 的自动化脚本非常强大。</p><hr><h1>第一次登录：你应该先做什么</h1><p>假设你拿到了一台 Linux 服务器的 SSH 登录信息（IP、用户名、密码），第一次登录之后，你应该：</p><h2 id="1-确认你的身份和权限"><a class="header-anchor" href="#1-确认你的身份和权限">¶</a>1. 确认你的身份和权限</h2><p>登录后，看看命令提示符：</p><ul><li><code>root@hostname ~ #</code>：你是 root 用户（超级用户，权限无限大），提示符是 <code>#</code>。</li><li><code>user@hostname ~ $</code>：你是普通用户，提示符是 <code>$</code>。</li></ul><p><strong>安全建议</strong>：不要直接用 root 登录做日常操作。应该用普通用户登录，需要权限时再用 <code>sudo</code>。原因：</p><ul><li>root 权限太大，一个 <code>rm -rf /</code> 就能删光整个系统（虽然现在很多系统会拦截这种危险命令，但仍然风险很高）。</li><li>日志里能看到是哪个用户执行了哪个 <code>sudo</code> 命令，但如果都用 root 登录，就分不清是谁干的。</li></ul><h2 id="2-看看你在哪里（pwd-ls）"><a class="header-anchor" href="#2-看看你在哪里（pwd-ls）">¶</a>2. 看看你在哪里（pwd / ls）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span>  <span class="comment"># 显示当前目录（Print Working Directory）</span></span><br><span class="line"><span class="built_in">ls</span>   <span class="comment"># 列出当前目录下的文件和目录</span></span><br><span class="line"><span class="built_in">ls</span> -lah  <span class="comment"># -l 显示详细信息，-a 包括隐藏文件（以 . 开头），-h 人性化显示大小</span></span><br></pre></td></tr></table></figure><h2 id="3-看看系统信息"><a class="header-anchor" href="#3-看看系统信息">¶</a>3. 看看系统信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uname</span> -a  <span class="comment"># 查看内核版本、主机名、硬件架构</span></span><br><span class="line"><span class="built_in">cat</span> /etc/os-release  <span class="comment"># 查看操作系统发行版信息</span></span><br><span class="line">hostnamectl  <span class="comment"># 查看/设置主机名、OS 类型、内核等（Systemd 时代的命令）</span></span><br><span class="line"><span class="built_in">df</span> -h  <span class="comment"># 查看磁盘使用情况（Disk Free）</span></span><br><span class="line">free -h  <span class="comment"># 查看内存使用情况</span></span><br></pre></td></tr></table></figure><h2 id="4-看看网络配置"><a class="header-anchor" href="#4-看看网络配置">¶</a>4. 看看网络配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip addr show  <span class="comment"># 查看网卡 IP、MAC、子网掩码（替代老的 ifconfig）</span></span><br><span class="line">ip route show  <span class="comment"># 查看路由表</span></span><br><span class="line">ping -c 4 8.8.8.8  <span class="comment"># 测试外网连通性（发送 4 个 ICMP 包）</span></span><br></pre></td></tr></table></figure><h2 id="5-看看有哪些用户、哪些进程在跑"><a class="header-anchor" href="#5-看看有哪些用户、哪些进程在跑">¶</a>5. 看看有哪些用户、哪些进程在跑</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">who</span>  <span class="comment"># 查看当前登录的用户</span></span><br><span class="line">w    <span class="comment"># 更详细的版本（who + uptime + 每个用户在干什么）</span></span><br><span class="line">ps aux  <span class="comment"># 查看所有进程（a=all users, u=user format, x=包括没有终端的进程）</span></span><br><span class="line">top  <span class="comment"># 实时查看进程、CPU、内存占用（按 q 退出）</span></span><br></pre></td></tr></table></figure><p><strong>第一次登录的核心目标</strong>：搞清楚&quot;我在哪、我是谁、系统状态如何、网络通不通、有哪些进程在跑&quot;。</p><hr><h1>最基础的文件与目录操作（日常必备）</h1><p>这部分是&quot;肌肉记忆&quot;级别的命令，用得最频繁。<strong>深入的文件操作（管道、重定向、高级过滤）会在《Linux 文件操作深入解析》专题里讲，这里只保留最基础的部分。</strong></p><h2 id="1-导航（在目录间移动）"><a class="header-anchor" href="#1-导航（在目录间移动）">¶</a>1. 导航（在目录间移动）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span>  <span class="comment"># 显示当前目录</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/dir  <span class="comment"># 切换到指定目录</span></span><br><span class="line"><span class="built_in">cd</span> ~  <span class="comment"># 回到家目录（等价于 cd /home/username 或 cd /root）</span></span><br><span class="line"><span class="built_in">cd</span> ..  <span class="comment"># 回到上一级目录</span></span><br><span class="line"><span class="built_in">cd</span> -  <span class="comment"># 回到上一次所在的目录（类似&quot;后退&quot;）</span></span><br></pre></td></tr></table></figure><h2 id="2-查看目录内容"><a class="header-anchor" href="#2-查看目录内容">¶</a>2. 查看目录内容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span>  <span class="comment"># 列出当前目录下的文件和目录</span></span><br><span class="line"><span class="built_in">ls</span> -l  <span class="comment"># 详细列表（权限、所有者、大小、修改时间）</span></span><br><span class="line"><span class="built_in">ls</span> -lh  <span class="comment"># -h 让大小显示更友好（1K, 2M, 3G）</span></span><br><span class="line"><span class="built_in">ls</span> -a  <span class="comment"># 包括隐藏文件（以 . 开头的文件，如 .bashrc）</span></span><br><span class="line"><span class="built_in">ls</span> -lah  <span class="comment"># 组合以上所有选项（最常用）</span></span><br><span class="line">ll  <span class="comment"># 很多系统里 ll 是 ls -l 的别名</span></span><br></pre></td></tr></table></figure><p><strong>权限列解读</strong>（以 <code>drwxr-xr-x</code> 为例）：</p><ul><li>第一位 <code>d</code> 表示目录；<code>-</code> 表示普通文件；<code>l</code> 表示软链接</li><li>后面 9 位分三组（owner / group / others），每组 3 位（rwx）<ul><li><code>rwx</code>：owner 可读写执行</li><li><code>r-x</code>：group 可读可执行，不可写</li><li><code>r-x</code>：others 可读可执行，不可写</li></ul></li></ul><blockquote><p>权限的详细解读、数字表示法（如 <code>chmod 755</code>）、SUID/SGID 等高级内容，请看 <strong>《Linux 文件权限》</strong> 专题。</p></blockquote><h2 id="3-创建与删除"><a class="header-anchor" href="#3-创建与删除">¶</a>3. 创建与删除</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> mydir  <span class="comment"># 创建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -p a/b/c  <span class="comment"># 递归创建多级目录（如果父目录不存在会自动创建）</span></span><br><span class="line"><span class="built_in">touch</span> file.txt  <span class="comment"># 创建空文件（如果文件存在，只更新时间戳）</span></span><br><span class="line"><span class="built_in">rm</span> file.txt  <span class="comment"># 删除文件</span></span><br><span class="line"><span class="built_in">rm</span> -r mydir  <span class="comment"># 删除目录（-r 表示递归删除目录及其内容）</span></span><br><span class="line"><span class="built_in">rm</span> -rf mydir  <span class="comment"># 强制删除（-f 表示 force，不询问）</span></span><br></pre></td></tr></table></figure><p><strong>安全提示</strong>：<code>rm -rf</code> 是危险命令，尤其是 <code>rm -rf /</code>（删除整个系统根目录）。现代 Linux 会拦截这种命令，但仍然要小心。<strong>删除前先 <code>ls</code> 确认一下删除的是什么。</strong></p><blockquote><p>注意：<code>rm</code> 删除的文件其实可以恢复（文件系统是日志型的，有备份和恢复机制）。如果要彻底粉碎文件（随机写入数据覆盖），可以用 <code>shred filename</code>，但这很危险，不推荐日常使用。</p></blockquote><h2 id="4-复制与移动"><a class="header-anchor" href="#4-复制与移动">¶</a>4. 复制与移动</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> source.txt dest.txt  <span class="comment"># 复制文件</span></span><br><span class="line"><span class="built_in">cp</span> -r srcdir dstdir  <span class="comment"># 复制目录（-r 表示递归）</span></span><br><span class="line"><span class="built_in">mv</span> old.txt new.txt  <span class="comment"># 重命名文件（或移动到其他目录）</span></span><br><span class="line"><span class="built_in">mv</span> file.txt /tmp/  <span class="comment"># 移动文件到 /tmp 目录</span></span><br></pre></td></tr></table></figure><p><strong>Tips</strong>：</p><ul><li>复制文件夹到目标路径时，如果目标路径不存在该文件夹，会给原文件夹改名复制过去；如果存在该文件夹，则将原文件夹复制到目标路径文件夹下。</li><li><code>mv</code> 相当于 Windows 的&quot;剪切粘贴&quot;。</li></ul><h2 id="5-查看文件内容"><a class="header-anchor" href="#5-查看文件内容">¶</a>5. 查看文件内容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> file.txt  <span class="comment"># 输出整个文件到屏幕（适合短文件）</span></span><br><span class="line">less file.txt  <span class="comment"># 分页查看（按空格翻页，按 q 退出）</span></span><br><span class="line">more file.txt  <span class="comment"># 类似 less，但功能更少（less 更推荐）</span></span><br><span class="line"><span class="built_in">head</span> -n 20 file.txt  <span class="comment"># 查看前 20 行</span></span><br><span class="line"><span class="built_in">tail</span> -n 20 file.txt  <span class="comment"># 查看后 20 行</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/syslog  <span class="comment"># 实时查看日志滚动输出（常用于监控日志）</span></span><br></pre></td></tr></table></figure><p><strong>Tips</strong>：</p><ul><li><code>cat</code> 适合短文件；长文件用 <code>less</code>（可以上下翻页、搜索）。</li><li><code>tail -f</code> 是运维必备技能，用于实时监控日志（比如 Web 服务器访问日志、应用日志）。</li></ul><h2 id="6-创建-编辑文件（快速写入内容）"><a class="header-anchor" href="#6-创建-编辑文件（快速写入内容）">¶</a>6. 创建/编辑文件（快速写入内容）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello World&quot;</span> &gt; file.txt  <span class="comment"># 覆盖写入（文件存在会被清空）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Second line&quot;</span> &gt;&gt; file.txt  <span class="comment"># 追加写入（在文件末尾追加）</span></span><br><span class="line"><span class="built_in">cat</span> &gt; file.txt &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">Line 1</span></span><br><span class="line"><span class="string">Line 2</span></span><br><span class="line"><span class="string">Line 3</span></span><br><span class="line"><span class="string">EOF</span>  <span class="comment"># 多行写入（输入 EOF 结束）</span></span><br></pre></td></tr></table></figure><p><strong>重定向符说明</strong>：</p><ul><li><code>&gt;</code>：覆盖写入（相当于&quot;新建或清空文件，然后写入&quot;）</li><li><code>&gt;&gt;</code>：追加写入（在文件末尾追加，不清空原内容）</li></ul><blockquote><p>更复杂的重定向、管道、stdin/stdout/stderr 的深入用法，请看 <strong>《Linux 文件操作深入解析》</strong> 专题。</p></blockquote><h2 id="7-文件信息查看"><a class="header-anchor" href="#7-文件信息查看">¶</a>7. 文件信息查看</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stat</span> file.txt  <span class="comment"># 查看文件的详细信息（时间戳、inode、权限等）</span></span><br><span class="line">file file.txt  <span class="comment"># 查看文件的真实类型（不依赖后缀名）</span></span><br><span class="line"><span class="built_in">wc</span> -l file.txt  <span class="comment"># 统计文件行数（-w 统计单词数，-c 统计字节数）</span></span><br><span class="line"><span class="built_in">du</span> -sh mydir  <span class="comment"># 查看目录占用的磁盘空间（-s 汇总，-h 人性化显示）</span></span><br></pre></td></tr></table></figure><p><strong><code>stat</code> vs <code>ls</code></strong>：<code>ls -l</code> 只显示基本信息（权限、大小、修改时间），<code>stat</code> 显示更详细的信息（访问时间 atime、修改时间 mtime、状态改变时间 ctime、inode 号等）。</p><hr><h1>远程连接入门：SSH 是怎么用的</h1><p>SSH（Secure Shell）是远程登录 Linux 服务器的标准方式，通过加密的方式传输数据，默认端口 <code>22</code>。</p><h2 id="1-基本用法"><a class="header-anchor" href="#1-基本用法">¶</a>1. 基本用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host  <span class="comment"># 用 user 账号登录到 host（IP 或域名）</span></span><br><span class="line">ssh -p 2222 user@host  <span class="comment"># 指定非默认端口（如果 SSH 端口改了）</span></span><br></pre></td></tr></table></figure><p><strong>示例</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.1.100  <span class="comment"># 用 root 登录到 192.168.1.100</span></span><br><span class="line">ssh -p 22222 admin@example.com  <span class="comment"># 用 admin 登录到 example.com，端口 22222</span></span><br></pre></td></tr></table></figure><h2 id="2-退出连接"><a class="header-anchor" href="#2-退出连接">¶</a>2. 退出连接</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span>  <span class="comment"># 退出当前会话（或直接关闭 SSH 客户端窗口）</span></span><br><span class="line"><span class="built_in">logout</span>  <span class="comment"># 也可以用 logout</span></span><br></pre></td></tr></table></figure><p><strong>Tips</strong>：</p><ul><li>如果你在 SSH 会话里又 <code>ssh</code> 到了另一台机器（嵌套 SSH），<code>exit</code> 只退出当前层级，需要多次 <code>exit</code> 才能退到本地。</li><li>如果网络断了，SSH 会话会挂起，可以用 <code>~.</code>（波浪号 + 点）强制断开（需要在新行开头输入）。</li></ul><h2 id="3-免密登录（密钥认证）"><a class="header-anchor" href="#3-免密登录（密钥认证）">¶</a>3. 免密登录（密钥认证）</h2><p><strong>为什么要用密钥登录？</strong></p><ul><li>更安全（密钥长度通常 2048 位或 4096 位，比密码难破解得多）</li><li>更方便（不用每次输密码）</li><li>可以配合自动化脚本（如 Ansible、Fabric）</li></ul><p><strong>步骤</strong>：</p><ol><li><p>在本地生成密钥对（公钥 + 私钥）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096  <span class="comment"># 生成 4096 位 RSA 密钥对</span></span><br></pre></td></tr></table></figure><p>默认会生成 <code>~/.ssh/id_rsa</code>（私钥）和 <code>~/.ssh/id_rsa.pub</code>（公钥）。</p></li><li><p>把公钥复制到服务器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id user@host  <span class="comment"># 自动把公钥追加到服务器的 ~/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure><p>或者手动复制：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub | ssh user@host <span class="string">&quot;mkdir -p ~/.ssh &amp;&amp; cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>下次登录就不需要密码了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host  <span class="comment"># 直接用密钥认证，不需要输密码</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="4-常见-SSH-客户端工具"><a class="header-anchor" href="#4-常见-SSH-客户端工具">¶</a>4. 常见 SSH 客户端工具</h2><ul><li><strong>命令行</strong>：<code>ssh</code> 命令（Linux / macOS 自带）</li><li><strong>Windows</strong>：<ul><li><strong>PuTTY</strong>（老牌，但界面比较简陋）</li><li><strong>Xshell</strong>（功能强大，但免费版有限制）</li><li><strong>MobaXterm</strong>（自带 X11 转发、SFTP、串口等功能）</li><li><strong>Windows Terminal + OpenSSH</strong>（Windows 10/11 自带 OpenSSH 客户端）</li></ul></li></ul><h2 id="5-修改-SSH-端口（安全加固）"><a class="header-anchor" href="#5-修改-SSH-端口（安全加固）">¶</a>5. 修改 SSH 端口（安全加固）</h2><p>默认端口 <code>22</code> 是黑客扫描的重点目标，改端口可以减少被扫描的概率（但不是绝对安全）。</p><p><strong>步骤</strong>：</p><ol><li>编辑配置文件：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure></li><li>找到 <code>#Port 22</code>，取消注释并改成其他端口（如 <code>Port 22222</code>）</li><li>重启 SSH 服务：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart sshd  <span class="comment"># Systemd 系统</span></span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">sudo service sshd restart  <span class="comment"># SysV 系统</span></span><br></pre></td></tr></table></figure></li><li>下次登录时需要指定端口：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22222 user@host</span><br></pre></td></tr></table></figure></li></ol><p><strong>安全建议</strong>：</p><ul><li>改端口只能减少被扫描的概率，不能防止有针对性的攻击。</li><li>更重要的安全措施：<strong>禁用密码登录，只允许密钥登录</strong>、<strong>配置防火墙（只允许特定 IP 连接 SSH）</strong>、<strong>安装 fail2ban（自动封禁暴力破解的 IP）</strong>。</li></ul><hr><h1>权限与用户基础（点到为止，深入看专题）</h1><h2 id="1-权限基础：rwx-是什么意思"><a class="header-anchor" href="#1-权限基础：rwx-是什么意思">¶</a>1. 权限基础：rwx 是什么意思</h2><p>每个文件/目录都有三组权限（owner / group / others），每组权限有三个位（rwx）：</p><ul><li><strong>r（read）</strong>：可读</li><li><strong>w（write）</strong>：可写</li><li><strong>x（execute）</strong>：可执行（对目录来说，x 表示可以进入该目录）</li></ul><p><strong>示例</strong>：<code>-rw-r--r--</code></p><ul><li>第一位 <code>-</code> 表示普通文件（<code>d</code> 表示目录，<code>l</code> 表示符号链接）</li><li><code>rw-</code>：owner 可读可写，不可执行</li><li><code>r--</code>：group 可读，不可写不可执行</li><li><code>r--</code>：others 可读，不可写不可执行</li></ul><h2 id="2-修改权限（chmod）"><a class="header-anchor" href="#2-修改权限（chmod）">¶</a>2. 修改权限（chmod）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 755 script.sh  <span class="comment"># 用数字表示法修改权限</span></span><br><span class="line"><span class="built_in">chmod</span> u+x script.sh  <span class="comment"># 给 owner 加上执行权限（u=user, g=group, o=others, a=all）</span></span><br><span class="line"><span class="built_in">chmod</span> g-w file.txt  <span class="comment"># 去掉 group 的写权限</span></span><br><span class="line"><span class="built_in">chmod</span> o=r file.txt  <span class="comment"># 设置 others 只有读权限</span></span><br></pre></td></tr></table></figure><p><strong>数字表示法</strong>（最常用）：</p><ul><li><code>7 = rwx</code>（4+2+1）</li><li><code>6 = rw-</code>（4+2）</li><li><code>5 = r-x</code>（4+1）</li><li><code>4 = r--</code></li><li><code>0 = ---</code></li></ul><p>所以 <code>chmod 755 script.sh</code> 表示：owner=rwx, group=r-x, others=r-x。</p><blockquote><p><strong>深入内容</strong>（SUID/SGID/Sticky bit、ACL、umask 等）请看 <strong>《Linux 文件权限》</strong> 专题。</p></blockquote><h2 id="3-切换用户（su-sudo）"><a class="header-anchor" href="#3-切换用户（su-sudo）">¶</a>3. 切换用户（su / sudo）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">su  <span class="comment"># 切换到 root（需要 root 密码）</span></span><br><span class="line">su - root  <span class="comment"># 完整切换到 root（加载 root 的环境变量）</span></span><br><span class="line">su - user  <span class="comment"># 切换到其他用户（加载该用户的环境）</span></span><br><span class="line">sudo <span class="built_in">command</span>  <span class="comment"># 用 root 权限执行 command（需要当前用户有 sudo 权限）</span></span><br></pre></td></tr></table></figure><p><strong><code>su</code> vs <code>sudo</code></strong>：</p><ul><li><code>su</code>：切换用户（Switch User），需要目标用户的密码。</li><li><code>sudo</code>：以 root 身份执行命令（Super User Do），只需要当前用户的密码（前提是当前用户在 sudo 组里）。</li></ul><p><strong>安全建议</strong>：日常操作用普通用户，需要权限时用 <code>sudo</code>，不要直接用 root 登录。</p><blockquote><p><strong>深入内容</strong>（用户管理、组管理、<code>/etc/passwd</code>、<code>/etc/shadow</code>、<code>useradd/usermod/userdel</code> 等）请看 <strong>《Linux 用户管理》</strong> 专题。</p></blockquote><hr><h1>常用目录结构（Linux 的&quot;地图&quot;）</h1><p>Linux 的目录结构是固定的（FHS 标准），不像 Windows 有 <code>C:\</code>、<code>D:\</code> 等盘符。所有东西都挂在根目录 <code>/</code> 下。</p><h2 id="核心目录及其作用"><a class="header-anchor" href="#核心目录及其作用">¶</a>核心目录及其作用</h2><ul><li><strong><code>/</code></strong>：根目录，所有东西的起点</li><li><strong><code>/etc</code></strong>：系统配置文件主目录。几乎所有服务的配置都在这里（如 <code>/etc/ssh/sshd_config</code>、<code>/etc/fstab</code>、<code>/etc/hosts</code>）</li><li><strong><code>/var</code></strong>：可变数据目录<ul><li><code>/var/log</code>：系统和服务的日志文件（如 <code>/var/log/syslog</code>、<code>/var/log/auth.log</code>）</li><li><code>/var/www</code>：Web 服务器的网站根目录（Apache/Nginx 默认）</li></ul></li><li><strong><code>/home</code></strong>：普通用户的家目录（如 <code>/home/alice</code>、<code>/home/bob</code>）</li><li><strong><code>/root</code></strong>：root 用户的家目录（不在 <code>/home</code> 下）</li><li><strong><code>/usr</code></strong>：系统软件和库文件（User Software Resources）<ul><li><code>/usr/bin</code>：大部分命令的二进制文件</li><li><code>/usr/lib</code>：库文件</li><li><code>/usr/local</code>：用户手动编译安装的软件（不被包管理器管理）</li></ul></li><li><strong><code>/opt</code></strong>：第三方大型软件包（如 Oracle、Google Chrome）</li><li><strong><code>/tmp</code></strong>：临时文件（重启后会被清空）</li><li><strong><code>/dev</code></strong>：设备文件（如 <code>/dev/sda</code> 是第一块硬盘，<code>/dev/tty</code> 是终端）</li><li><strong><code>/proc</code></strong>：虚拟文件系统，提供进程和内核信息（如 <code>/proc/cpuinfo</code>、<code>/proc/meminfo</code>）</li><li><strong><code>/sys</code></strong>：虚拟文件系统，提供硬件设备信息（如 <code>/sys/class/net/eth0</code>）</li><li><strong><code>/boot</code></strong>：启动相关文件（内核、引导加载程序）</li><li><strong><code>/lib</code></strong>：系统库文件（如动态链接库 <code>.so</code>）</li><li><strong><code>/mnt</code></strong>：临时挂载点（如挂载 U 盘、移动硬盘）</li><li><strong><code>/media</code></strong>：可移动设备的自动挂载点（如光盘、U 盘）</li></ul><p><strong>记住这些目录，以后定位问题会很快</strong>：</p><ul><li>配置出问题了？去 <code>/etc</code> 找配置文件。</li><li>服务起不来？去 <code>/var/log</code> 看日志。</li><li>磁盘满了？用 <code>du -sh /*</code> 看哪个目录占用最大。</li></ul><hr><h1>包管理入门（点到为止，深入看专题）</h1><p>Linux 的软件安装不像 Windows 那样下载 <code>.exe</code> 安装包，而是通过<strong>包管理器</strong>统一管理。</p><h2 id="常见包管理器"><a class="header-anchor" href="#常见包管理器">¶</a>常见包管理器</h2><ul><li><p><strong>Debian/Ubuntu 系</strong>：<code>apt</code>（或老版本的 <code>apt-get</code>）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update  <span class="comment"># 更新软件源信息</span></span><br><span class="line">sudo apt install nginx  <span class="comment"># 安装 nginx</span></span><br><span class="line">sudo apt remove nginx  <span class="comment"># 卸载 nginx</span></span><br><span class="line">sudo apt search keyword  <span class="comment"># 搜索软件包</span></span><br></pre></td></tr></table></figure></li><li><p><strong>RHEL/CentOS 系</strong>：<code>yum</code>（CentOS 7）或 <code>dnf</code>（CentOS 8+ / RHEL 8+）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update  <span class="comment"># 更新软件源信息</span></span><br><span class="line">sudo yum install nginx  <span class="comment"># 安装 nginx</span></span><br><span class="line">sudo yum remove nginx  <span class="comment"># 卸载 nginx</span></span><br><span class="line">sudo yum search keyword  <span class="comment"># 搜索软件包</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Arch Linux</strong>：<code>pacman</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -Syu  <span class="comment"># 更新系统</span></span><br><span class="line">sudo pacman -S nginx  <span class="comment"># 安装 nginx</span></span><br><span class="line">sudo pacman -R nginx  <span class="comment"># 卸载 nginx</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>优点</strong>：</p><ul><li>依赖关系自动解决（A 依赖 B，B 依赖 C，安装 A 时会自动安装 B 和 C）</li><li>版本统一管理（一个命令更新所有软件）</li><li>安全性高（软件包都经过签名验证）</li></ul><blockquote><p><strong>深入内容</strong>（编译安装、<code>.rpm</code> / <code>.deb</code> 手动安装、<code>snap</code> / <code>flatpak</code>、软件源配置等）请看 <strong>《Linux 软件包管理》</strong> 专题。</p></blockquote><hr><h1>进程与资源管理基础（点到为止，深入看专题）</h1><h2 id="1-查看进程"><a class="header-anchor" href="#1-查看进程">¶</a>1. 查看进程</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps aux  <span class="comment"># 查看所有进程（a=all users, u=user format, x=包括没有终端的进程）</span></span><br><span class="line">ps aux | grep nginx  <span class="comment"># 查看 nginx 相关的进程</span></span><br><span class="line">top  <span class="comment"># 实时查看进程、CPU、内存占用（按 q 退出）</span></span><br><span class="line">htop  <span class="comment"># top 的增强版（需要安装，更直观）</span></span><br></pre></td></tr></table></figure><h2 id="2-结束进程"><a class="header-anchor" href="#2-结束进程">¶</a>2. 结束进程</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> &lt;PID&gt;  <span class="comment"># 发送 SIGTERM 信号（温和地结束进程）</span></span><br><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;  <span class="comment"># 发送 SIGKILL 信号（强制结束进程）</span></span><br><span class="line">killall nginx  <span class="comment"># 结束所有名为 nginx 的进程</span></span><br><span class="line">pkill nginx  <span class="comment"># 按名字结束进程（支持正则）</span></span><br></pre></td></tr></table></figure><p><strong><code>kill</code> vs <code>kill -9</code></strong>：</p><ul><li><code>kill</code>：发送 <code>SIGTERM</code> 信号，进程可以捕获这个信号，做一些清理工作（如保存数据、关闭连接）再退出。</li><li><code>kill -9</code>：发送 <code>SIGKILL</code> 信号，进程无法捕获，立即被强制结束（可能导致数据丢失或资源泄漏）。</li></ul><p><strong>建议</strong>：先用 <code>kill</code>，如果进程不响应再用 <code>kill -9</code>。</p><h2 id="3-后台运行"><a class="header-anchor" href="#3-后台运行">¶</a>3. 后台运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &amp;  <span class="comment"># 在后台运行 command</span></span><br><span class="line"><span class="built_in">nohup</span> <span class="built_in">command</span> &amp;  <span class="comment"># 在后台运行，且退出 SSH 后进程不会被杀掉</span></span><br><span class="line"><span class="built_in">jobs</span>  <span class="comment"># 查看后台任务</span></span><br><span class="line"><span class="built_in">fg</span> %1  <span class="comment"># 把任务 1 调到前台</span></span><br><span class="line"><span class="built_in">bg</span> %1  <span class="comment"># 把任务 1 继续在后台运行</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>深入内容</strong>（CPU/内存/磁盘 IO 监控、<code>cgroup</code>、<code>nice</code>/<code>renice</code>、<code>systemd</code> 服务管理等）请看 <strong>《Linux 进程与资源管理》</strong> 和 <strong>《Linux 系统服务管理》</strong> 专题。</p></blockquote><hr><h1>安全运维基础习惯（新手容易踩的坑）</h1><h2 id="1-修改关键配置前先备份"><a class="header-anchor" href="#1-修改关键配置前先备份">¶</a>1. 修改关键配置前先备份</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/ssh/sshd_config /etc/ssh/sshd_config.bak  <span class="comment"># 备份配置文件</span></span><br></pre></td></tr></table></figure><p>如果改错了，可以 <code>sudo cp /etc/ssh/sshd_config.bak /etc/ssh/sshd_config</code> 恢复。</p><h2 id="2-修改网络-SSH-配置时保持一个备用连接"><a class="header-anchor" href="#2-修改网络-SSH-配置时保持一个备用连接">¶</a>2. 修改网络/SSH 配置时保持一个备用连接</h2><p>如果你在 SSH 会话里修改了网络配置或 SSH 配置，改错了可能会把自己锁在外面。<strong>正确做法</strong>：</p><ul><li>保持一个 SSH 会话不关闭（用来恢复配置）</li><li>开一个新的 SSH 会话测试修改是否生效</li><li>如果新会话连不上，立刻在旧会话里恢复配置</li></ul><h2 id="3-危险命令三思而后行"><a class="header-anchor" href="#3-危险命令三思而后行">¶</a>3. 危险命令三思而后行</h2><ul><li><code>rm -rf /</code>：删除整个系统根目录（现代 Linux 会拦截，但仍要小心）</li><li><code>dd if=/dev/zero of=/dev/sda</code>：把硬盘全部写入零（数据无法恢复）</li><li><code>chmod -R 777 /</code>：把整个系统的权限改成任何人可读可写可执行（安全灾难）</li></ul><p><strong>建议</strong>：</p><ul><li>删除前先 <code>ls</code> 确认要删的是什么</li><li>涉及磁盘操作（<code>dd</code>、<code>fdisk</code>、<code>mkfs</code>）前先确认设备名（<code>lsblk</code>）</li><li>修改权限前先想清楚为什么要改、改成什么</li></ul><h2 id="4-日志是你的朋友"><a class="header-anchor" href="#4-日志是你的朋友">¶</a>4. 日志是你的朋友</h2><p>出问题了先看日志：</p><ul><li><code>/var/log/syslog</code>（Debian/Ubuntu）或 <code>/var/log/messages</code>（RHEL/CentOS）：系统日志</li><li><code>/var/log/auth.log</code>（Debian/Ubuntu）或 <code>/var/log/secure</code>（RHEL/CentOS）：认证日志（SSH 登录、sudo 操作）</li><li><code>/var/log/&lt;服务名&gt;/</code>：各个服务的日志（如 <code>/var/log/nginx/</code>、<code>/var/log/mysql/</code>）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tail</span> -f /var/log/syslog  <span class="comment"># 实时查看系统日志</span></span><br><span class="line">sudo grep <span class="string">&quot;Failed password&quot;</span> /var/log/auth.log  <span class="comment"># 查看 SSH 登录失败记录</span></span><br></pre></td></tr></table></figure><hr><h1>下一步：去哪里深入学习</h1><p>这篇文章是整个 Linux 系列的<strong>入口导览</strong>，每个主题都只是&quot;点到为止&quot;。如果你想深入学习某个主题，可以看对应的专题文章：</p><ul><li><strong>《Linux 文件权限》</strong>：SUID/SGID/Sticky bit、ACL、umask、权限继承等</li><li><strong>《Linux 用户管理》</strong>：<code>useradd/usermod/userdel</code>、组管理、<code>/etc/passwd</code>、<code>/etc/shadow</code>、sudo 配置等</li><li><strong>《Linux 磁盘管理》</strong>：分区（MBR/GPT、<code>fdisk</code>/<code>gdisk</code>）、格式化（<code>mkfs</code>）、挂载（<code>mount</code>、<code>/etc/fstab</code>）、LVM、RAID 等</li><li><strong>《Linux 系统服务管理》</strong>：Systemd（<code>systemctl</code>）、SysV（<code>service</code>、<code>chkconfig</code>）、自定义服务、开机自启等</li><li><strong>《Linux 软件包管理》</strong>：<code>apt</code>/<code>yum</code>/<code>dnf</code> 深入用法、编译安装、<code>.rpm</code>/<code>.deb</code> 手动安装、软件源配置等</li><li><strong>《Linux 进程与资源管理》</strong>：CPU/内存/磁盘 IO 监控、<code>top</code>/<code>htop</code>/<code>iotop</code>、<code>nice</code>/<code>renice</code>、<code>cgroup</code>、OOM killer 等</li><li><strong>《Linux 文件操作深入解析》</strong>：管道（<code>|</code>）、重定向（<code>&gt;</code>、<code>&gt;&gt;</code>、<code>&lt;</code>、<code>2&gt;</code>）、stdin/stdout/stderr、<code>xargs</code>、<code>tee</code> 等</li></ul><p><strong>学习建议</strong>：</p><ol><li>先把这篇&quot;使用基础&quot;看完，建立整体认知。</li><li>根据你的实际需求，选择对应的专题深入学习（比如你要配磁盘就看《磁盘管理》，要配服务就看《系统服务管理》）。</li><li>边学边做，最好有一台虚拟机或云服务器练手（推荐 VirtualBox + Ubuntu 或 阿里云/腾讯云的学生机）。</li></ol><hr><h1>参考资料与扩展阅读</h1><ul><li><a class="link" href="https://tldp.org/">Linux Documentation Project<i class="fas fa-external-link-alt"></i></a>：经典的 Linux 文档库</li><li><a class="link" href="https://wiki.archlinux.org/">Arch Linux Wiki<i class="fas fa-external-link-alt"></i></a>：质量极高的 Linux 文档（不只适用于 Arch）</li><li><a class="link" href="http://linuxcommand.org/tlcl.php">The Linux Command Line (书)<i class="fas fa-external-link-alt"></i></a>：免费的 Linux 命令行入门书</li><li><a class="link" href="https://www.brendangregg.com/linuxperf.html">Linux Performance<i class="fas fa-external-link-alt"></i></a>：性能分析大师 Brendan Gregg 的资源页</li></ul><hr><p><strong>到这里，你应该已经从&quot;会登录&quot;走到了&quot;有基本方向感&quot;。接下来就是根据实际需求，选择对应的专题深入学习。记住：Linux 不是一次性学完的，而是在实践中不断积累的。</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linux 的&amp;quot;难&amp;quot;往往不在命令本身，而在于你是否有一张清晰的系统地图：它为什么适合服务器、它的多用户多任务与权限模型在日常运维里意味着什么、不同发行版的包管理与目录布局有哪些共性与差异、第一次登录之后应该做什么。本篇是整个 Linux 系列的&lt;strong&gt;入口导览&lt;/strong&gt;，会先把核心理念搭起来，然后用一组最常用的命令带你走过&amp;quot;文件导航—查看与编辑—远程连接—权限与用户基础&amp;quot;的基础操作链路。目标不是堆一堆指令表，而是让你从&amp;quot;会登录&amp;quot;走到&amp;quot;有基本方向感&amp;quot;——每个主题都&lt;strong&gt;点到为止&lt;/strong&gt;，然后引导你去看对应的专题深入文章（磁盘管理、文件权限、用户管理、服务管理、进程管理、软件包管理、文件操作深入解析），后续再学任何细分主题都会顺很多。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux Basics: Core Concepts and Essential Commands</title>
    <link href="https://chenk.top/en/linux-basics/"/>
    <id>https://chenk.top/en/linux-basics/</id>
    <published>2025-01-09T16:00:00.000Z</published>
    <updated>2026-01-29T16:06:05.093Z</updated>
    
    <content type="html"><![CDATA[<p>The “difficulty” of Linux often lies not in the commands themselves but in whether you have a clear system map: why it’s suited for servers, what its multi-user/multi-task and permission models mean in daily operations, what commonalities and differences exist across distributions in package management and directory layout, and what to do after your first login. This post serves as the <strong>entry guide</strong> for the entire Linux series. I’ll first establish core concepts, then walk you through the most commonly used commands covering “file navigation—viewing and editing—remote connections—basic permissions and users.” The goal is not to pile up a command reference but to take you from “able to log in” to “having a basic sense of direction”—each topic is <strong>introduced briefly</strong>, then you’re guided to corresponding deep-dive articles (Disk Management, File Permissions, User Management, Service Management, Process Management, Package Management, Advanced File Operations). Afterward, learning any specialized topic will be much smoother.</p><span id="more"></span><h1>Core Linux Philosophy: Why Learn It, Why It’s Designed This Way</h1><h2 id="Why-Choose-Linux-Especially-for-Servers"><a class="header-anchor" href="#Why-Choose-Linux-Especially-for-Servers">¶</a>Why Choose Linux (Especially for Servers)</h2><ul><li><strong>Highly Customizable</strong>: Open-source and free to use; all components can be modified or customized as needed. If you need to slim down a system, customize the kernel, or optimize for specific hardware, Linux is the most flexible choice.</li><li><strong>Stable and Reliable</strong>: Linux is widely used in servers, embedded systems, and more, with strong stability and fault tolerance. Many critical systems (finance, telecommunications, cloud platforms) run Linux, with uptime reaching years without reboots.</li><li><strong>Powerful Ecosystem</strong>: Built-in powerful package managers and rich open-source software resources, such as <code>apt</code> (Debian/Ubuntu), <code>yum</code>/<code>dnf</code> (RHEL/CentOS). Most tools you need (databases, web servers, monitoring tools, development languages) can be installed directly via package managers without hunting down installers.</li><li><strong>Everything is a File</strong>: The filesystem abstracts various devices, allowing unified access to disks, network devices, and peripherals. This design philosophy makes Linux interfaces very consistent: whether reading disk data, viewing process information, or configuring networks, you’re “reading and writing files.” This consistency makes automation scripts very simple.</li><li><strong>Command-Line First, but GUIs Exist</strong>: Many operations are more efficient via CLI (Command Line Interface), making remote management and batch operations highly effective. Server environments predominantly use command lines, but if you want a graphical interface (like desktop Linux), many distributions provide out-of-the-box GNOME/KDE desktops.</li></ul><h2 id="Common-Distributions-A-Brief-Comparison-Which-to-Choose"><a class="header-anchor" href="#Common-Distributions-A-Brief-Comparison-Which-to-Choose">¶</a>Common Distributions: A Brief Comparison (Which to Choose?)</h2><ul><li><strong>Ubuntu/Debian Family</strong>: Package manager is <code>apt</code>, active community, rich documentation, suitable for beginners and developers. Ubuntu LTS (Long Term Support) is a common choice for cloud servers.</li><li><strong>CentOS/RHEL Family</strong>: Package manager is <code>yum</code> or <code>dnf</code> (CentOS 8+ / RHEL 8+), suitable for production environments, good stability, strong enterprise support. CentOS Stream is upstream of RHEL; AlmaLinux / Rocky Linux are community alternatives to CentOS.</li><li><strong>SUSE Family</strong>: Uses <code>zypper</code>, common in enterprise environments and SAP-related deployments, popular in European enterprises.</li><li><strong>Arch Linux</strong>: Rolling release model, newest software versions, but higher requirements for operators (needs manual configuration of many things). Suitable for users who enjoy tinkering and pursuing the latest software.</li></ul><p><strong>Practical Selection Advice</strong>:</p><ul><li>For learning or development, recommend <strong>Ubuntu LTS</strong> (abundant docs, active community).</li><li>For enterprise production environments, recommend <strong>RHEL family</strong> (RHEL / AlmaLinux / Rocky Linux, stable with commercial support).</li><li>For cloud servers, check cloud provider recommendations (AWS recommends Amazon Linux, Alibaba Cloud recommends Alibaba Cloud Linux, but Ubuntu and CentOS families are also well-supported).</li></ul><h2 id="Three-Core-Linux-Principles-Understanding-These-Makes-Many-Design-Choices-Less-Strange"><a class="header-anchor" href="#Three-Core-Linux-Principles-Understanding-These-Makes-Many-Design-Choices-Less-Strange">¶</a>Three Core Linux Principles (Understanding These Makes Many Design Choices Less Strange)</h2><h3 id="1-Multi-User-Multi-Task"><a class="header-anchor" href="#1-Multi-User-Multi-Task">¶</a>1. Multi-User, Multi-Task</h3><p>Multiple users can log in simultaneously (via SSH, tty, etc.), and each user can run multiple tasks (processes) in parallel. This differs from Windows’ typical “only one user at a time” scenario—on a Linux server, dozens of users might be running different tasks simultaneously, and the system needs to isolate their permissions, resources, and files.</p><p>This is why Linux’s permission model is so strict: you can’t casually view others’ files or kill their processes.</p><h3 id="2-Permission-Mechanism-File-Centric"><a class="header-anchor" href="#2-Permission-Mechanism-File-Centric">¶</a>2. Permission Mechanism: File-Centric</h3><p>Linux permission management centers on <strong>files (including directories)</strong>, using <strong>read ®, write (w), execute (x)</strong> permissions and combinations of <strong>owner / group / others</strong> to manage access control.</p><p>Each file has three permission groups (owner / group / others), each with rwx three bits, determining “who can do what.” For example:</p><ul><li><code>rwxr-xr-x</code>: owner can read/write/execute, group and others can read/execute but not write.</li><li><code>rw-------</code>: owner can read/write, group and others can’t do anything (common for private key files like <code>~/.ssh/id_rsa</code>).</li></ul><p><strong>Why this design?</strong> Because Linux is a multi-user system; without permission control, anyone could delete others’ files or modify system configurations, causing chaos.</p><blockquote><p>In-depth content on permissions (SUID/SGID/Sticky bit, ACL, umask, etc.) is covered in the <strong>《Linux File Permissions》</strong> specialized article; here you only need to know the basics.</p></blockquote><h3 id="3-Everything-is-a-File-Unified-Abstraction-Interface"><a class="header-anchor" href="#3-Everything-is-a-File-Unified-Abstraction-Interface">¶</a>3. Everything is a File (Unified Abstraction Interface)</h3><p>In Linux, almost everything is abstracted as a “file,” including:</p><ul><li>Regular files (text, binary, scripts)</li><li>Directories (also a special kind of file)</li><li>Devices (<code>/dev/sda</code> is the first SCSI/SATA hard drive, <code>/dev/tty</code> is terminal)</li><li>Process information (under <code>/proc/&lt;pid&gt;/</code> you can see various process info)</li><li>System information (under <code>/sys/</code> you can see hardware device tree)</li><li>Pipes, sockets (inter-process communication can also be through “files”)</li></ul><p><strong>Benefit</strong>: Consistent interface. You can use the same commands (<code>cat</code>, <code>echo</code>, <code>&gt;</code>, <code>&lt;</code>, etc.) to operate on files, devices, and process information. For example:</p><ul><li><code>cat /proc/cpuinfo</code> to view CPU info</li><li><code>echo 1 &gt; /sys/class/leds/led0/brightness</code> to control LED brightness</li><li><code>cat /dev/urandom | head -c 16 &gt; random.bin</code> to generate random numbers</li></ul><p>This consistency makes Linux automation scripts very powerful.</p><hr><h1>First Login: What Should You Do</h1><p>Suppose you’ve received SSH login info for a Linux server (IP, username, password). After your first login, you should:</p><h2 id="1-Confirm-Your-Identity-and-Permissions"><a class="header-anchor" href="#1-Confirm-Your-Identity-and-Permissions">¶</a>1. Confirm Your Identity and Permissions</h2><p>After logging in, look at the command prompt:</p><ul><li><code>root@hostname ~ #</code>: You’re the root user (superuser, unlimited permissions), prompt is <code>#</code>.</li><li><code>user@hostname ~ $</code>: You’re a regular user, prompt is <code>$</code>.</li></ul><p><strong>Security Recommendation</strong>: Don’t log in directly as root for daily operations. Use a regular user account and use <code>sudo</code> when permissions are needed. Reasons:</p><ul><li>Root permissions are too broad; one <code>rm -rf /</code> can delete the entire system (although many modern systems block such dangerous commands, the risk is still high).</li><li>Logs show which user executed which <code>sudo</code> command, but if everyone logs in as root, you can’t tell who did what.</li></ul><h2 id="2-See-Where-You-Are-pwd-ls"><a class="header-anchor" href="#2-See-Where-You-Are-pwd-ls">¶</a>2. See Where You Are (pwd / ls)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span>  <span class="comment"># Display current directory (Print Working Directory)</span></span><br><span class="line"><span class="built_in">ls</span>   <span class="comment"># List files and directories in current directory</span></span><br><span class="line"><span class="built_in">ls</span> -lah  <span class="comment"># -l shows details, -a includes hidden files (starting with .), -h human-readable sizes</span></span><br></pre></td></tr></table></figure><h2 id="3-Check-System-Information"><a class="header-anchor" href="#3-Check-System-Information">¶</a>3. Check System Information</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uname</span> -a  <span class="comment"># Check kernel version, hostname, hardware architecture</span></span><br><span class="line"><span class="built_in">cat</span> /etc/os-release  <span class="comment"># Check OS distribution info</span></span><br><span class="line">hostnamectl  <span class="comment"># View/set hostname, OS type, kernel, etc. (Systemd era command)</span></span><br><span class="line"><span class="built_in">df</span> -h  <span class="comment"># Check disk usage (Disk Free)</span></span><br><span class="line">free -h  <span class="comment"># Check memory usage</span></span><br></pre></td></tr></table></figure><h2 id="4-Check-Network-Configuration"><a class="header-anchor" href="#4-Check-Network-Configuration">¶</a>4. Check Network Configuration</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip addr show  <span class="comment"># Check network card IP, MAC, subnet mask (replaces old ifconfig)</span></span><br><span class="line">ip route show  <span class="comment"># Check routing table</span></span><br><span class="line">ping -c 4 8.8.8.8  <span class="comment"># Test external network connectivity (send 4 ICMP packets)</span></span><br></pre></td></tr></table></figure><h2 id="5-See-Which-Users-and-Processes-Are-Running"><a class="header-anchor" href="#5-See-Which-Users-and-Processes-Are-Running">¶</a>5. See Which Users and Processes Are Running</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">who</span>  <span class="comment"># Show currently logged-in users</span></span><br><span class="line">w    <span class="comment"># More detailed version (who + uptime + what each user is doing)</span></span><br><span class="line">ps aux  <span class="comment"># View all processes (a=all users, u=user format, x=including processes without terminals)</span></span><br><span class="line">top  <span class="comment"># Real-time view of processes, CPU, memory usage (press q to exit)</span></span><br></pre></td></tr></table></figure><p><strong>Core Goal of First Login</strong>: Figure out “where am I, who am I, what’s the system status, is the network working, what processes are running.”</p><hr><h1>Most Basic File and Directory Operations (Daily Essentials)</h1><p>This section covers “muscle memory” level commands, used most frequently. <strong>In-depth file operations (pipes, redirection, advanced filtering) are covered in the 《Linux Advanced File Operations》 specialized article; here we only keep the basics.</strong></p><h2 id="1-Navigation-Moving-Between-Directories"><a class="header-anchor" href="#1-Navigation-Moving-Between-Directories">¶</a>1. Navigation (Moving Between Directories)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">pwd</span>  <span class="comment"># Display current directory</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/dir  <span class="comment"># Change to specified directory</span></span><br><span class="line"><span class="built_in">cd</span> ~  <span class="comment"># Return to home directory (equivalent to cd /home/username or cd /root)</span></span><br><span class="line"><span class="built_in">cd</span> ..  <span class="comment"># Go up one directory level</span></span><br><span class="line"><span class="built_in">cd</span> -  <span class="comment"># Go back to previous directory (like &quot;back&quot; button)</span></span><br></pre></td></tr></table></figure><h2 id="2-Viewing-Directory-Contents"><a class="header-anchor" href="#2-Viewing-Directory-Contents">¶</a>2. Viewing Directory Contents</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span>  <span class="comment"># List files and directories in current directory</span></span><br><span class="line"><span class="built_in">ls</span> -l  <span class="comment"># Detailed list (permissions, owner, size, modification time)</span></span><br><span class="line"><span class="built_in">ls</span> -lh  <span class="comment"># -h makes size display friendlier (1K, 2M, 3G)</span></span><br><span class="line"><span class="built_in">ls</span> -a  <span class="comment"># Include hidden files (starting with ., like .bashrc)</span></span><br><span class="line"><span class="built_in">ls</span> -lah  <span class="comment"># Combine all above options (most commonly used)</span></span><br><span class="line">ll  <span class="comment"># On many systems, ll is an alias for ls -l</span></span><br></pre></td></tr></table></figure><p><strong>Permission Column Interpretation</strong> (using <code>drwxr-xr-x</code> as example):</p><ul><li>First character <code>d</code> indicates directory; <code>-</code> indicates regular file; <code>l</code> indicates symbolic link</li><li>Next 9 characters in three groups (owner / group / others), each group 3 characters (rwx)<ul><li><code>rwx</code>: owner can read, write, execute</li><li><code>r-x</code>: group can read, execute, but not write</li><li><code>r-x</code>: others can read, execute, but not write</li></ul></li></ul><blockquote><p>Detailed interpretation of permissions, numeric notation (like <code>chmod 755</code>), SUID/SGID and other advanced content is covered in the <strong>《Linux File Permissions》</strong> specialized article.</p></blockquote><h2 id="3-Creating-and-Deleting"><a class="header-anchor" href="#3-Creating-and-Deleting">¶</a>3. Creating and Deleting</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> mydir  <span class="comment"># Create directory</span></span><br><span class="line"><span class="built_in">mkdir</span> -p a/b/c  <span class="comment"># Recursively create multi-level directories (automatically creates parent dirs if they don&#x27;t exist)</span></span><br><span class="line"><span class="built_in">touch</span> file.txt  <span class="comment"># Create empty file (if file exists, only updates timestamp)</span></span><br><span class="line"><span class="built_in">rm</span> file.txt  <span class="comment"># Delete file</span></span><br><span class="line"><span class="built_in">rm</span> -r mydir  <span class="comment"># Delete directory (-r means recursively delete directory and its contents)</span></span><br><span class="line"><span class="built_in">rm</span> -rf mydir  <span class="comment"># Force delete (-f means force, no prompts)</span></span><br></pre></td></tr></table></figure><p><strong>Safety Tip</strong>: <code>rm -rf</code> is a dangerous command, especially <code>rm -rf /</code> (deletes entire system root directory). Modern Linux blocks such commands, but still be careful. <strong>Before deleting, use <code>ls</code> to confirm what you’re deleting.</strong></p><blockquote><p>Note: Files deleted by <code>rm</code> can actually be recovered (filesystems are journaled, with backup and recovery mechanisms). To thoroughly shred a file (overwrite with random data), use <code>shred filename</code>, but this is dangerous and not recommended for daily use.</p></blockquote><h2 id="4-Copying-and-Moving"><a class="header-anchor" href="#4-Copying-and-Moving">¶</a>4. Copying and Moving</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> source.txt dest.txt  <span class="comment"># Copy file</span></span><br><span class="line"><span class="built_in">cp</span> -r srcdir dstdir  <span class="comment"># Copy directory (-r means recursive)</span></span><br><span class="line"><span class="built_in">mv</span> old.txt new.txt  <span class="comment"># Rename file (or move to another directory)</span></span><br><span class="line"><span class="built_in">mv</span> file.txt /tmp/  <span class="comment"># Move file to /tmp directory</span></span><br></pre></td></tr></table></figure><p><strong>Tips</strong>:</p><ul><li>When copying folders to a target path, if the target folder doesn’t exist, the source folder is renamed and copied there; if it exists, the source folder is copied into the target folder.</li><li><code>mv</code> is equivalent to Windows’ “cut and paste.”</li></ul><h2 id="5-Viewing-File-Contents"><a class="header-anchor" href="#5-Viewing-File-Contents">¶</a>5. Viewing File Contents</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> file.txt  <span class="comment"># Output entire file to screen (suitable for short files)</span></span><br><span class="line">less file.txt  <span class="comment"># Paginated viewing (press space to scroll, q to exit)</span></span><br><span class="line">more file.txt  <span class="comment"># Similar to less but with fewer features (less is more recommended)</span></span><br><span class="line"><span class="built_in">head</span> -n 20 file.txt  <span class="comment"># View first 20 lines</span></span><br><span class="line"><span class="built_in">tail</span> -n 20 file.txt  <span class="comment"># View last 20 lines</span></span><br><span class="line"><span class="built_in">tail</span> -f /var/log/syslog  <span class="comment"># Real-time view of log rolling output (commonly used for monitoring logs)</span></span><br></pre></td></tr></table></figure><p><strong>Tips</strong>:</p><ul><li><code>cat</code> is suitable for short files; for long files use <code>less</code> (can scroll up/down, search).</li><li><code>tail -f</code> is an essential operations skill, used for real-time log monitoring (like web server access logs, application logs).</li></ul><h2 id="6-Creating-Editing-Files-Quick-Content-Writing"><a class="header-anchor" href="#6-Creating-Editing-Files-Quick-Content-Writing">¶</a>6. Creating/Editing Files (Quick Content Writing)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello World&quot;</span> &gt; file.txt  <span class="comment"># Overwrite (file is cleared if it exists)</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Second line&quot;</span> &gt;&gt; file.txt  <span class="comment"># Append (add to end of file)</span></span><br><span class="line"><span class="built_in">cat</span> &gt; file.txt &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">Line 1</span></span><br><span class="line"><span class="string">Line 2</span></span><br><span class="line"><span class="string">Line 3</span></span><br><span class="line"><span class="string">EOF</span>  <span class="comment"># Multi-line write (input EOF to finish)</span></span><br></pre></td></tr></table></figure><p><strong>Redirection Operators Explained</strong>:</p><ul><li><code>&gt;</code>: Overwrite (equivalent to “create or clear file, then write”)</li><li><code>&gt;&gt;</code>: Append (add to end of file without clearing original content)</li></ul><blockquote><p>More complex redirection, pipes, and in-depth usage of stdin/stdout/stderr is covered in the <strong>《Linux Advanced File Operations》</strong> specialized article.</p></blockquote><h2 id="7-File-Information-Viewing"><a class="header-anchor" href="#7-File-Information-Viewing">¶</a>7. File Information Viewing</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stat</span> file.txt  <span class="comment"># View detailed file information (timestamps, inode, permissions, etc.)</span></span><br><span class="line">file file.txt  <span class="comment"># View file&#x27;s true type (not dependent on extension)</span></span><br><span class="line"><span class="built_in">wc</span> -l file.txt  <span class="comment"># Count file lines (-w counts words, -c counts bytes)</span></span><br><span class="line"><span class="built_in">du</span> -sh mydir  <span class="comment"># View directory disk usage (-s summarizes, -h human-readable)</span></span><br></pre></td></tr></table></figure><p><strong><code>stat</code> vs <code>ls</code></strong>: <code>ls -l</code> only shows basic info (permissions, size, modification time), <code>stat</code> shows more detailed info (access time atime, modification time mtime, status change time ctime, inode number, etc.).</p><hr><h1>Remote Connection Basics: How to Use SSH</h1><p>SSH (Secure Shell) is the standard way to remotely log into Linux servers, transmitting data through encryption, default port <code>22</code>.</p><h2 id="1-Basic-Usage"><a class="header-anchor" href="#1-Basic-Usage">¶</a>1. Basic Usage</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host  <span class="comment"># Log into host with user account (IP or domain name)</span></span><br><span class="line">ssh -p 2222 user@host  <span class="comment"># Specify non-default port (if SSH port has changed)</span></span><br></pre></td></tr></table></figure><p><strong>Example</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.1.100  <span class="comment"># Log into 192.168.1.100 as root</span></span><br><span class="line">ssh -p 22222 admin@example.com  <span class="comment"># Log into example.com as admin, port 22222</span></span><br></pre></td></tr></table></figure><h2 id="2-Exiting-Connection"><a class="header-anchor" href="#2-Exiting-Connection">¶</a>2. Exiting Connection</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span>  <span class="comment"># Exit current session (or directly close SSH client window)</span></span><br><span class="line"><span class="built_in">logout</span>  <span class="comment"># Can also use logout</span></span><br></pre></td></tr></table></figure><p><strong>Tips</strong>:</p><ul><li>If you <code>ssh</code> to another machine within an SSH session (nested SSH), <code>exit</code> only exits the current level; you need multiple <code>exit</code> to get back to local.</li><li>If network drops, SSH session will hang; you can use <code>~.</code> (tilde + dot) to force disconnect (must be entered at the start of a new line).</li></ul><h2 id="3-Password-Free-Login-Key-Authentication"><a class="header-anchor" href="#3-Password-Free-Login-Key-Authentication">¶</a>3. Password-Free Login (Key Authentication)</h2><p><strong>Why use key login?</strong></p><ul><li>More secure (key length typically 2048 or 4096 bits, much harder to crack than passwords)</li><li>More convenient (don’t need to enter password every time)</li><li>Can be paired with automation scripts (like Ansible, Fabric)</li></ul><p><strong>Steps</strong>:</p><ol><li><p>Generate key pair locally (public key + private key):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096  <span class="comment"># Generate 4096-bit RSA key pair</span></span><br></pre></td></tr></table></figure><p>By default generates <code>~/.ssh/id_rsa</code> (private key) and <code>~/.ssh/id_rsa.pub</code> (public key).</p></li><li><p>Copy public key to server:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id user@host  <span class="comment"># Automatically appends public key to server&#x27;s ~/.ssh/authorized_keys</span></span><br></pre></td></tr></table></figure><p>Or manual copy:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> ~/.ssh/id_rsa.pub | ssh user@host <span class="string">&quot;mkdir -p ~/.ssh &amp;&amp; cat &gt;&gt; ~/.ssh/authorized_keys&quot;</span></span><br></pre></td></tr></table></figure></li><li><p>Next login won’t need password:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh user@host  <span class="comment"># Directly uses key authentication, no password needed</span></span><br></pre></td></tr></table></figure></li></ol><h2 id="4-Common-SSH-Client-Tools"><a class="header-anchor" href="#4-Common-SSH-Client-Tools">¶</a>4. Common SSH Client Tools</h2><ul><li><strong>Command Line</strong>: <code>ssh</code> command (built-in on Linux / macOS)</li><li><strong>Windows</strong>:<ul><li><strong>PuTTY</strong> (old-school, but interface is simple)</li><li><strong>Xshell</strong> (powerful, but free version has limitations)</li><li><strong>MobaXterm</strong> (includes X11 forwarding, SFTP, serial port, etc.)</li><li><strong>Windows Terminal + OpenSSH</strong> (Windows 10/11 come with OpenSSH client)</li></ul></li></ul><h2 id="5-Changing-SSH-Port-Security-Hardening"><a class="header-anchor" href="#5-Changing-SSH-Port-Security-Hardening">¶</a>5. Changing SSH Port (Security Hardening)</h2><p>Default port <code>22</code> is a prime target for hacker scans; changing the port reduces scan probability (but isn’t absolute security).</p><p><strong>Steps</strong>:</p><ol><li>Edit config file:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure></li><li>Find <code>#Port 22</code>, uncomment and change to another port (like <code>Port 22222</code>)</li><li>Restart SSH service:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart sshd  <span class="comment"># Systemd systems</span></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">sudo service sshd restart  <span class="comment"># SysV systems</span></span><br></pre></td></tr></table></figure></li><li>Next login needs to specify port:<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 22222 user@host</span><br></pre></td></tr></table></figure></li></ol><p><strong>Security Recommendations</strong>:</p><ul><li>Changing port only reduces scan probability; doesn’t prevent targeted attacks.</li><li>More important security measures: <strong>disable password login, only allow key login</strong>, <strong>configure firewall (only allow specific IPs to connect to SSH)</strong>, <strong>install fail2ban (automatically ban brute-force attack IPs)</strong>.</li></ul><hr><h1>Permission and User Basics (Brief Introduction, See Specialized Articles for Deep Dive)</h1><h2 id="1-Permission-Basics-What-Does-rwx-Mean"><a class="header-anchor" href="#1-Permission-Basics-What-Does-rwx-Mean">¶</a>1. Permission Basics: What Does rwx Mean</h2><p>Each file/directory has three permission groups (owner / group / others), each with three bits (rwx):</p><ul><li><strong>r (read)</strong>: Can read</li><li><strong>w (write)</strong>: Can write</li><li><strong>x (execute)</strong>: Can execute (for directories, x means can enter that directory)</li></ul><p><strong>Example</strong>: <code>-rw-r--r--</code></p><ul><li>First character <code>-</code> indicates regular file (<code>d</code> indicates directory, <code>l</code> indicates symbolic link)</li><li><code>rw-</code>: owner can read and write, not execute</li><li><code>r--</code>: group can read, not write or execute</li><li><code>r--</code>: others can read, not write or execute</li></ul><h2 id="2-Modifying-Permissions-chmod"><a class="header-anchor" href="#2-Modifying-Permissions-chmod">¶</a>2. Modifying Permissions (chmod)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 755 script.sh  <span class="comment"># Use numeric notation to modify permissions</span></span><br><span class="line"><span class="built_in">chmod</span> u+x script.sh  <span class="comment"># Add execute permission for owner (u=user, g=group, o=others, a=all)</span></span><br><span class="line"><span class="built_in">chmod</span> g-w file.txt  <span class="comment"># Remove write permission for group</span></span><br><span class="line"><span class="built_in">chmod</span> o=r file.txt  <span class="comment"># Set others to only read permission</span></span><br></pre></td></tr></table></figure><p><strong>Numeric Notation</strong> (most commonly used):</p><ul><li><code>7 = rwx</code> (4+2+1)</li><li><code>6 = rw-</code> (4+2)</li><li><code>5 = r-x</code> (4+1)</li><li><code>4 = r--</code></li><li><code>0 = ---</code></li></ul><p>So <code>chmod 755 script.sh</code> means: owner=rwx, group=r-x, others=r-x.</p><blockquote><p><strong>In-depth content</strong> (SUID/SGID/Sticky bit, ACL, umask, etc.) is covered in the <strong>《Linux File Permissions》</strong> specialized article.</p></blockquote><h2 id="3-Switching-Users-su-sudo"><a class="header-anchor" href="#3-Switching-Users-su-sudo">¶</a>3. Switching Users (su / sudo)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">su  <span class="comment"># Switch to root (needs root password)</span></span><br><span class="line">su - root  <span class="comment"># Complete switch to root (loads root&#x27;s environment variables)</span></span><br><span class="line">su - user  <span class="comment"># Switch to another user (loads that user&#x27;s environment)</span></span><br><span class="line">sudo <span class="built_in">command</span>  <span class="comment"># Execute command with root permissions (requires current user to have sudo permissions)</span></span><br></pre></td></tr></table></figure><p><strong><code>su</code> vs <code>sudo</code></strong>:</p><ul><li><code>su</code>: Switch User, needs target user’s password.</li><li><code>sudo</code>: Super User Do, execute command as root, only needs current user’s password (prerequisite: current user is in sudo group).</li></ul><p><strong>Security Recommendation</strong>: Use regular user for daily operations, use <code>sudo</code> when permissions are needed, don’t log in directly as root.</p><blockquote><p><strong>In-depth content</strong> (user management, group management, <code>/etc/passwd</code>, <code>/etc/shadow</code>, <code>useradd/usermod/userdel</code>, etc.) is covered in the <strong>《Linux User Management》</strong> specialized article.</p></blockquote><hr><h1>Common Directory Structure (Linux’s “Map”)</h1><p>Linux’s directory structure is fixed (FHS standard), unlike Windows with <code>C:\</code>, <code>D:\</code>, etc. drive letters. Everything hangs under root directory <code>/</code>.</p><h2 id="Core-Directories-and-Their-Functions"><a class="header-anchor" href="#Core-Directories-and-Their-Functions">¶</a>Core Directories and Their Functions</h2><ul><li><strong><code>/</code></strong>: Root directory, starting point for everything</li><li><strong><code>/etc</code></strong>: Main system configuration file directory. Almost all service configs are here (like <code>/etc/ssh/sshd_config</code>, <code>/etc/fstab</code>, <code>/etc/hosts</code>)</li><li><strong><code>/var</code></strong>: Variable data directory<ul><li><code>/var/log</code>: System and service log files (like <code>/var/log/syslog</code>, <code>/var/log/auth.log</code>)</li><li><code>/var/www</code>: Web server website root directory (Apache/Nginx default)</li></ul></li><li><strong><code>/home</code></strong>: Regular users’ home directories (like <code>/home/alice</code>, <code>/home/bob</code>)</li><li><strong><code>/root</code></strong>: Root user’s home directory (not under <code>/home</code>)</li><li><strong><code>/usr</code></strong>: System software and library files (User Software Resources)<ul><li><code>/usr/bin</code>: Most command binary files</li><li><code>/usr/lib</code>: Library files</li><li><code>/usr/local</code>: User manually compiled/installed software (not managed by package manager)</li></ul></li><li><strong><code>/opt</code></strong>: Third-party large software packages (like Oracle, Google Chrome)</li><li><strong><code>/tmp</code></strong>: Temporary files (cleared after reboot)</li><li><strong><code>/dev</code></strong>: Device files (like <code>/dev/sda</code> is first hard drive, <code>/dev/tty</code> is terminal)</li><li><strong><code>/proc</code></strong>: Virtual filesystem providing process and kernel info (like <code>/proc/cpuinfo</code>, <code>/proc/meminfo</code>)</li><li><strong><code>/sys</code></strong>: Virtual filesystem providing hardware device info (like <code>/sys/class/net/eth0</code>)</li><li><strong><code>/boot</code></strong>: Boot-related files (kernel, bootloader)</li><li><strong><code>/lib</code></strong>: System library files (like dynamic link libraries <code>.so</code>)</li><li><strong><code>/mnt</code></strong>: Temporary mount point (like mounting USB drives, mobile hard drives)</li><li><strong><code>/media</code></strong>: Auto-mount point for removable devices (like CD, USB drive)</li></ul><p><strong>Remember these directories; troubleshooting will be faster</strong>:</p><ul><li>Configuration problem? Go to <code>/etc</code> for config files.</li><li>Service won’t start? Go to <code>/var/log</code> to check logs.</li><li>Disk full? Use <code>du -sh /*</code> to see which directory uses most space.</li></ul><hr><h1>Package Management Basics (Brief Introduction, See Specialized Article for Deep Dive)</h1><p>Linux software installation isn’t like Windows downloading <code>.exe</code> installers; it’s managed uniformly through <strong>package managers</strong>.</p><h2 id="Common-Package-Managers"><a class="header-anchor" href="#Common-Package-Managers">¶</a>Common Package Managers</h2><ul><li><p><strong>Debian/Ubuntu Family</strong>: <code>apt</code> (or older <code>apt-get</code>)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update  <span class="comment"># Update software source info</span></span><br><span class="line">sudo apt install nginx  <span class="comment"># Install nginx</span></span><br><span class="line">sudo apt remove nginx  <span class="comment"># Uninstall nginx</span></span><br><span class="line">sudo apt search keyword  <span class="comment"># Search for packages</span></span><br></pre></td></tr></table></figure></li><li><p><strong>RHEL/CentOS Family</strong>: <code>yum</code> (CentOS 7) or <code>dnf</code> (CentOS 8+ / RHEL 8+)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update  <span class="comment"># Update software source info</span></span><br><span class="line">sudo yum install nginx  <span class="comment"># Install nginx</span></span><br><span class="line">sudo yum remove nginx  <span class="comment"># Uninstall nginx</span></span><br><span class="line">sudo yum search keyword  <span class="comment"># Search for packages</span></span><br></pre></td></tr></table></figure></li><li><p><strong>Arch Linux</strong>: <code>pacman</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -Syu  <span class="comment"># Update system</span></span><br><span class="line">sudo pacman -S nginx  <span class="comment"># Install nginx</span></span><br><span class="line">sudo pacman -R nginx  <span class="comment"># Uninstall nginx</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>Advantages</strong>:</p><ul><li>Dependency resolution is automatic (A depends on B, B depends on C; installing A automatically installs B and C)</li><li>Unified version management (one command updates all software)</li><li>High security (packages are all signature-verified)</li></ul><blockquote><p><strong>In-depth content</strong> (compilation installation, <code>.rpm</code> / <code>.deb</code> manual installation, <code>snap</code> / <code>flatpak</code>, software source configuration, etc.) is covered in the <strong>《Linux Package Management》</strong> specialized article.</p></blockquote><hr><h1>Process and Resource Management Basics (Brief Introduction, See Specialized Article for Deep Dive)</h1><h2 id="1-Viewing-Processes"><a class="header-anchor" href="#1-Viewing-Processes">¶</a>1. Viewing Processes</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ps aux  <span class="comment"># View all processes (a=all users, u=user format, x=including processes without terminals)</span></span><br><span class="line">ps aux | grep nginx  <span class="comment"># View nginx-related processes</span></span><br><span class="line">top  <span class="comment"># Real-time view of processes, CPU, memory usage (press q to exit)</span></span><br><span class="line">htop  <span class="comment"># Enhanced version of top (needs installation, more intuitive)</span></span><br></pre></td></tr></table></figure><h2 id="2-Terminating-Processes"><a class="header-anchor" href="#2-Terminating-Processes">¶</a>2. Terminating Processes</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> &lt;PID&gt;  <span class="comment"># Send SIGTERM signal (gracefully terminate process)</span></span><br><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;  <span class="comment"># Send SIGKILL signal (forcefully terminate process)</span></span><br><span class="line">killall nginx  <span class="comment"># Terminate all processes named nginx</span></span><br><span class="line">pkill nginx  <span class="comment"># Terminate processes by name (supports regex)</span></span><br></pre></td></tr></table></figure><p><strong><code>kill</code> vs <code>kill -9</code></strong>:</p><ul><li><code>kill</code>: Sends <code>SIGTERM</code> signal; process can catch this signal, do some cleanup (like saving data, closing connections) before exiting.</li><li><code>kill -9</code>: Sends <code>SIGKILL</code> signal; process cannot catch it, immediately forcefully terminated (may cause data loss or resource leaks).</li></ul><p><strong>Recommendation</strong>: First use <code>kill</code>; if process doesn’t respond, then use <code>kill -9</code>.</p><h2 id="3-Background-Running"><a class="header-anchor" href="#3-Background-Running">¶</a>3. Background Running</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &amp;  <span class="comment"># Run command in background</span></span><br><span class="line"><span class="built_in">nohup</span> <span class="built_in">command</span> &amp;  <span class="comment"># Run in background, process won&#x27;t be killed after exiting SSH</span></span><br><span class="line"><span class="built_in">jobs</span>  <span class="comment"># View background jobs</span></span><br><span class="line"><span class="built_in">fg</span> %1  <span class="comment"># Bring job 1 to foreground</span></span><br><span class="line"><span class="built_in">bg</span> %1  <span class="comment"># Continue job 1 in background</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>In-depth content</strong> (CPU/memory/disk IO monitoring, <code>cgroup</code>, <code>nice</code>/<code>renice</code>, <code>systemd</code> service management, etc.) is covered in the <strong>《Linux Process and Resource Management》</strong> and <strong>《Linux System Service Management》</strong> specialized articles.</p></blockquote><hr><h1>Basic Safe Operations Habits (Pitfalls Beginners Easily Fall Into)</h1><h2 id="1-Back-Up-Before-Modifying-Critical-Configurations"><a class="header-anchor" href="#1-Back-Up-Before-Modifying-Critical-Configurations">¶</a>1. Back Up Before Modifying Critical Configurations</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/ssh/sshd_config /etc/ssh/sshd_config.bak  <span class="comment"># Back up config file</span></span><br></pre></td></tr></table></figure><p>If you mess up, you can restore with <code>sudo cp /etc/ssh/sshd_config.bak /etc/ssh/sshd_config</code>.</p><h2 id="2-Keep-a-Backup-Connection-When-Modifying-Network-SSH-Config"><a class="header-anchor" href="#2-Keep-a-Backup-Connection-When-Modifying-Network-SSH-Config">¶</a>2. Keep a Backup Connection When Modifying Network/SSH Config</h2><p>If you modify network or SSH config within an SSH session, messing up might lock yourself out. <strong>Correct approach</strong>:</p><ul><li>Keep one SSH session open (to restore config)</li><li>Open a new SSH session to test if modification works</li><li>If new session can’t connect, immediately restore config in old session</li></ul><h2 id="3-Think-Thrice-Before-Executing-Dangerous-Commands"><a class="header-anchor" href="#3-Think-Thrice-Before-Executing-Dangerous-Commands">¶</a>3. Think Thrice Before Executing Dangerous Commands</h2><ul><li><code>rm -rf /</code>: Delete entire system root directory (modern Linux blocks this, but still be careful)</li><li><code>dd if=/dev/zero of=/dev/sda</code>: Write zeros to entire hard drive (data unrecoverable)</li><li><code>chmod -R 777 /</code>: Change entire system permissions to anyone can read/write/execute (security disaster)</li></ul><p><strong>Recommendations</strong>:</p><ul><li>Before deleting, use <code>ls</code> to confirm what you’re deleting</li><li>Before disk operations (<code>dd</code>, <code>fdisk</code>, <code>mkfs</code>), first confirm device name (<code>lsblk</code>)</li><li>Before modifying permissions, think through why and what to change to</li></ul><h2 id="4-Logs-Are-Your-Friend"><a class="header-anchor" href="#4-Logs-Are-Your-Friend">¶</a>4. Logs Are Your Friend</h2><p>When problems arise, check logs first:</p><ul><li><code>/var/log/syslog</code> (Debian/Ubuntu) or <code>/var/log/messages</code> (RHEL/CentOS): System log</li><li><code>/var/log/auth.log</code> (Debian/Ubuntu) or <code>/var/log/secure</code> (RHEL/CentOS): Authentication log (SSH logins, sudo operations)</li><li><code>/var/log/&lt;service-name&gt;/</code>: Individual service logs (like <code>/var/log/nginx/</code>, <code>/var/log/mysql/</code>)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tail</span> -f /var/log/syslog  <span class="comment"># Real-time view system log</span></span><br><span class="line">sudo grep <span class="string">&quot;Failed password&quot;</span> /var/log/auth.log  <span class="comment"># Check SSH login failures</span></span><br></pre></td></tr></table></figure><hr><h1>Next Steps: Where to Deep Dive</h1><p>This article is the <strong>entry guide</strong> for the entire Linux series; each topic is just “briefly introduced.” If you want to dive deeper into any topic, check the corresponding specialized article:</p><ul><li><strong>《Linux File Permissions》</strong>: SUID/SGID/Sticky bit, ACL, umask, permission inheritance, etc.</li><li><strong>《Linux User Management》</strong>: <code>useradd/usermod/userdel</code>, group management, <code>/etc/passwd</code>, <code>/etc/shadow</code>, sudo configuration, etc.</li><li><strong>《Linux Disk Management》</strong>: Partitioning (MBR/GPT, <code>fdisk</code>/<code>gdisk</code>), formatting (<code>mkfs</code>), mounting (<code>mount</code>, <code>/etc/fstab</code>), LVM, RAID, etc.</li><li><strong>《Linux System Service Management》</strong>: Systemd (<code>systemctl</code>), SysV (<code>service</code>, <code>chkconfig</code>), custom services, auto-start on boot, etc.</li><li><strong>《Linux Package Management》</strong>: <code>apt</code>/<code>yum</code>/<code>dnf</code> in-depth usage, compilation installation, <code>.rpm</code>/<code>.deb</code> manual installation, software source configuration, etc.</li><li><strong>《Linux Process and Resource Management》</strong>: CPU/memory/disk IO monitoring, <code>top</code>/<code>htop</code>/<code>iotop</code>, <code>nice</code>/<code>renice</code>, <code>cgroup</code>, OOM killer, etc.</li><li><strong>《Linux Advanced File Operations》</strong>: Pipes (<code>|</code>), redirection (<code>&gt;</code>, <code>&gt;&gt;</code>, <code>&lt;</code>, <code>2&gt;</code>), stdin/stdout/stderr, <code>xargs</code>, <code>tee</code>, etc.</li></ul><p><strong>Learning Recommendations</strong>:</p><ol><li>First read through this “Basics” article to establish overall awareness.</li><li>Based on your actual needs, choose corresponding specialized topics for deep learning (for example, if you need to configure disks, see 《Disk Management》; if you need to configure services, see 《System Service Management》).</li><li>Learn by doing; best to have a virtual machine or cloud server for practice (recommend VirtualBox + Ubuntu or Alibaba Cloud/Tencent Cloud student instances).</li></ol><hr><h1>References and Further Reading</h1><ul><li><a class="link" href="https://tldp.org/">Linux Documentation Project<i class="fas fa-external-link-alt"></i></a>: Classic Linux documentation library</li><li><a class="link" href="https://wiki.archlinux.org/">Arch Linux Wiki<i class="fas fa-external-link-alt"></i></a>: Extremely high-quality Linux documentation (not just for Arch)</li><li><a class="link" href="http://linuxcommand.org/tlcl.php">The Linux Command Line (book)<i class="fas fa-external-link-alt"></i></a>: Free Linux command-line introductory book</li><li><a class="link" href="https://www.brendangregg.com/linuxperf.html">Linux Performance<i class="fas fa-external-link-alt"></i></a>: Performance analysis master Brendan Gregg’s resource page</li></ul><hr><p><strong>By this point, you should have progressed from “able to log in” to “having a basic sense of direction.” Next is to choose corresponding specialized topics for deep learning based on actual needs. Remember: Linux isn’t learned all at once but accumulated continuously through practice.</strong></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;The “difficulty” of Linux often lies not in the commands themselves but in whether you have a clear system map: why it’s suited for servers, what its multi-user/multi-task and permission models mean in daily operations, what commonalities and differences exist across distributions in package management and directory layout, and what to do after your first login. This post serves as the &lt;strong&gt;entry guide&lt;/strong&gt; for the entire Linux series. I’ll first establish core concepts, then walk you through the most commonly used commands covering “file navigation—viewing and editing—remote connections—basic permissions and users.” The goal is not to pile up a command reference but to take you from “able to log in” to “having a basic sense of direction”—each topic is &lt;strong&gt;introduced briefly&lt;/strong&gt;, then you’re guided to corresponding deep-dive articles (Disk Management, File Permissions, User Management, Service Management, Process Management, Package Management, Advanced File Operations). Afterward, learning any specialized topic will be much smoother.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
</feed>
