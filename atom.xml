<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Chen Kai Blog</title>
  
  
  <link href="https://chenk.top/atom.xml" rel="self"/>
  
  <link href="https://chenk.top/"/>
  <updated>2026-01-27T16:26:16.773Z</updated>
  <id>https://chenk.top/</id>
  
  <author>
    <name>Chen Kai</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>学习率：从入门到大模型训练的终极指南</title>
    <link href="https://chenk.top/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/"/>
    <id>https://chenk.top/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/</id>
    <published>2026-01-26T16:00:00.000Z</published>
    <updated>2026-01-27T16:26:16.773Z</updated>
    
    <content type="html"><![CDATA[<p>学习率（Learning Rate,LR）是深度学习里<strong>最重要、也最容易“看起来像玄学”的超参数</strong>。它既像汽车的油门（决定你每一步走多快），也像方向盘的灵敏度（太敏感会蛇形走位甚至翻车，太迟钝又永远到不了目的地）。</p><p>这篇文章会从最简单的二次函数出发，把“学习率为什么会影响稳定性、为什么训练后期要降学习率、为什么warmup 常见”讲清楚。</p><span id="more"></span><hr><h1 id="一句话把学习率讲清楚">一句话把学习率讲清楚</h1><p>把训练想象成“在雾里下山”：</p><ul><li><strong>参数 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.061ex" height="1.618ex" role="img" focusable="false" viewbox="0 -705 469 715"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g></g></g></svg></mjx-container></span></strong>是你的位置；</li><li><strong>损失 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.362ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 1928 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span></strong>是海拔（越低越好）；</li><li><strong>梯度 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.247ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2761 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(1514,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1903,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(2372,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span></strong> 是“坡度方向提示”；</li><li><strong>学习率 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span></strong>是“你每一步迈多大”。</li></ul><p>你每一步大致按下面走：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="15.592ex" height="2.084ex" role="img" focusable="false" viewbox="0 -705 6891.7 921"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(5074.2,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mstyle" transform="translate(5909.5,0)"><g data-mml-node="mspace"/></g><g data-mml-node="msub" transform="translate(6076.5,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span></p><p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.844ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 815.3 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span>是你看到的梯度（通常是小批量 mini-batch 的随机梯度）。</p><p>学习率的核心矛盾就一句话：</p><blockquote><p><strong><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>越大越快，但越容易不稳定；<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>越小越稳，但越慢、也可能卡住。</strong></p></blockquote><p>接下来我们用“从最简单的二次函数”开始，把这句话拆开讲透。</p><hr><h1 id="最小可用数学为什么太大就炸太小就慢">最小可用数学：为什么“太大就炸，太小就慢”</h1><h2 id="从一维抛物线开始最重要的直觉">从一维抛物线开始（最重要的直觉）</h2><p>考虑最简单的损失：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="21.365ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 9443.3 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2205.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(3261.6,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mi" transform="translate(4201.6,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="msup" transform="translate(4730.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mn" transform="translate(502,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(5636.1,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(5914.1,0)"><g data-mml-node="mspace"/></g><g data-mml-node="mi" transform="translate(7080.8,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(7887.6,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"/></g><g data-mml-node="mn" transform="translate(8943.3,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g></svg></mjx-container></span></p><p>梯度是：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.522ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 5092.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(833,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(1514,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1903,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(2372,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(3038.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(4094.6,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(4623.6,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g></g></g></svg></mjx-container></span></p><p>做梯度下降：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="28.827ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 12741.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(5074.2,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mstyle" transform="translate(5571.2,0)"><g data-mml-node="mspace"/></g><g data-mml-node="mi" transform="translate(5738.2,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="msub" transform="translate(6267.2,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(7352.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mo" transform="translate(8408,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(8797,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(9519.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(10519.5,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(11016.5,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(11545.5,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msub" transform="translate(11934.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span></p><p>你看到一个关键系数：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="7.978ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3526.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1111.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(2111.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(2608.4,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(3137.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span>。它决定了收敛还是发散：</p><ul><li>若 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.564ex;" xmlns="http://www.w3.org/2000/svg" width="11.624ex" height="2.26ex" role="img" focusable="false" viewbox="0 -749.5 5138 999"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mn" transform="translate(278,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1000.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(2000.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(2497.4,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(3026.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mo" transform="translate(3582.2,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mn" transform="translate(4638,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></svg></mjx-container></span>，会收敛；</li><li>若 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.564ex;" xmlns="http://www.w3.org/2000/svg" width="11.624ex" height="2.26ex" role="img" focusable="false" viewbox="0 -749.5 5138 999"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mn" transform="translate(278,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1000.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(2000.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(2497.4,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mo" transform="translate(3026.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mo" transform="translate(3582.2,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"/></g><g data-mml-node="mn" transform="translate(4638,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></svg></mjx-container></span>，会发散（来回跳并越跳越大）。</li></ul><p>于是得到稳定条件：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.575ex;" xmlns="http://www.w3.org/2000/svg" width="10.482ex" height="4.611ex" role="img" focusable="false" viewbox="0 -1342 4633.1 2038"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(234.5,676)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="729" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span></p><p><strong>类比</strong>：你下山时每一步都按“坡度”迈。如果坡太陡（<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container></span> 大），同样的步幅（<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>）更容易跨过谷底到另一边再反弹；坡越缓（<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container></span> 小），你可以迈更大步仍然不翻车。</p><h2 id="多维情况下最陡的方向决定是否爆炸">多维情况下，“最陡的方向”决定是否爆炸</h2><p>把 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container></span> 推广到多维二次型：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="15.069ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 6660.7 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2205.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(3261.6,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="msup" transform="translate(4201.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,413) scale(0.707)"><path data-c="22A4" d="M55 642T55 648T59 659T66 666T71 668H708Q723 660 723 648T708 628H409V15Q402 2 391 0Q387 0 384 1T379 3T375 6T373 9T371 13T369 16V628H71Q70 628 67 630T59 637Z"/></g></g><g data-mml-node="mi" transform="translate(5303.7,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mi" transform="translate(6191.7,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g></g></g></svg></mjx-container></span></p><p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></span> 是Hessian（曲率矩阵）。稳定性由最大特征值 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.253ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3647.9 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="TeXAtom" transform="translate(616,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(1981.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2370.9,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3258.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span> 主导：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.172ex;" xmlns="http://www.w3.org/2000/svg" width="17.539ex" height="5.208ex" role="img" focusable="false" viewbox="0 -1342 7752 2302"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(1794,676)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mrow" transform="translate(220,-710)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="TeXAtom" transform="translate(616,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(1981.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2370.9,0)"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3258.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g><rect width="3847.9" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span></p><p><strong>一句话</strong>：训练是否会炸，往往由“最陡那条方向”决定。</p><p><strong>类比</strong>：你在山谷里走路，整体看起来很平缓，但某一条方向上突然很陡（比如悬崖边）。你迈步时只要有分量朝那条方向，就可能摔下去。</p><h2 id="gif二维椭圆谷底里为什么会走成之字">GIF：二维“椭圆谷底”里为什么会走成“之”字</h2><p>二维二次函数是理解“曲率不均匀导致震荡”的最佳玩具模型。考虑：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="24.929ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 11018.7 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mo" transform="translate(550,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(939,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(1511,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(1955.7,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2445.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(3112.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(4168.2,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(5108.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(5497.2,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g><g data-mml-node="msup" transform="translate(6513.7,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mn" transform="translate(605,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(7744.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(8744.7,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="msup" transform="translate(9703.2,0)"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(523,413) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(10629.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span></p><p>当 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.667ex;" xmlns="http://www.w3.org/2000/svg" width="7.988ex" height="1.95ex" role="img" focusable="false" viewbox="0 -567 3530.5 862"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(1236.3,0)"><path data-c="226B" d="M55 539T55 547T60 561T74 567Q81 567 207 498Q297 449 365 412Q633 265 636 261Q639 255 639 250Q639 241 626 232Q614 224 365 88Q83 -65 79 -66Q76 -67 73 -67Q65 -67 60 -61T55 -47Q55 -39 61 -33Q62 -33 95 -15T193 39T320 109L321 110H322L323 111H324L325 112L326 113H327L329 114H330L331 115H332L333 116L334 117H335L336 118H337L338 119H339L340 120L341 121H342L343 122H344L345 123H346L347 124L348 125H349L351 126H352L353 127H354L355 128L356 129H357L358 130H359L360 131H361L362 132L363 133H364L365 134H366L367 135H368L369 136H370L371 137L372 138H373L374 139H375L376 140L378 141L576 251Q63 530 62 533Q55 539 55 547ZM360 539T360 547T365 561T379 567Q386 567 512 498Q602 449 670 412Q938 265 941 261Q944 255 944 250Q944 241 931 232Q919 224 670 88Q388 -65 384 -66Q381 -67 378 -67Q370 -67 365 -61T360 -47Q360 -39 366 -33Q367 -33 400 -15T498 39T625 109L626 110H627L628 111H629L630 112L631 113H632L634 114H635L636 115H637L638 116L639 117H640L641 118H642L643 119H644L645 120L646 121H647L648 122H649L650 123H651L652 124L653 125H654L656 126H657L658 127H659L660 128L661 129H662L663 130H664L665 131H666L667 132L668 133H669L670 134H671L672 135H673L674 136H675L676 137L677 138H678L679 139H680L681 140L683 141L881 251Q368 530 367 533Q360 539 360 547Z"/></g><g data-mml-node="msub" transform="translate(2514,0)"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="mi" transform="translate(562,-150) scale(0.707)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></g></svg></mjx-container></span> 时，<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.109ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 490 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span> 方向更“陡”，同一个学习率 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span> 会在 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.109ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 490 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>方向产生更强的回弹，于是轨迹常常呈现“之”字形（尤其是没加动量时）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">ax, ay = <span class="number">1.0</span>, <span class="number">12.0</span></span><br><span class="line">eta = <span class="number">0.12</span></span><br><span class="line">x = np.array([<span class="number">2.0</span>, <span class="number">1.5</span>])</span><br><span class="line"></span><br><span class="line">path = [x.copy()]</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">45</span>):</span><br><span class="line">    g = np.array([ax * x[<span class="number">0</span>], ay * x[<span class="number">1</span>]])</span><br><span class="line">    x = x - eta * g</span><br><span class="line">    path.append(x.copy())</span><br></pre></td></tr></table></figure><figure><img src="/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/gd_path_2d.gif" alt="2D 二次函数上的梯度下降轨迹（GIF）"><figcaption aria-hidden="true">2D二次函数上的梯度下降轨迹（GIF）</figcaption></figure><h2 id="为什么深度网络更难曲率在训练中会变">为什么深度网络更难：曲率在训练中会变</h2><p>真实神经网络不是二次函数，<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></span>会随训练变化；更麻烦的是：</p><ul><li>梯度是随机的（mini-batch）；</li><li>不同层/不同参数的“有效尺度”差异巨大；</li><li>还会有动量、归一化、权重衰减、裁剪等“附加物理”。</li></ul><p>所以现代训练几乎不会只用一个常数学习率跑到底，而是用<strong>学习率调度（schedule）</strong>：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.89ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 835.3 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span> 随时间变化。</p><h2 id="更进一步l-光滑l-smooth告诉你学习率上限从哪来">更进一步：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></span>-光滑（L-smooth）告诉你“学习率上限”从哪来</h2><p>上面的二次函数例子有个隐藏前提：曲率 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.023ex;" xmlns="http://www.w3.org/2000/svg" width="1.197ex" height="1.02ex" role="img" focusable="false" viewbox="0 -441 529 451"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g></g></g></svg></mjx-container></span>固定不变。更一般地，优化里常见一个假设叫 <strong><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></span>-光滑</strong>：</p><blockquote><p>梯度不会变化得太快（损失曲线不会突然“折成直角”）。</p></blockquote><p>一种常见表述是：对任意 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="3.409ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 1506.7 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(572,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(1016.7,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>，有</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="29.198ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 12905.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"/></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(1333,0)"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mo" transform="translate(1883,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2272,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(2844,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(3455.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(4455.4,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(5288.4,0)"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mo" transform="translate(5838.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(6227.4,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(6717.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(7106.4,0)"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"/></g><g data-mml-node="mo" transform="translate(7884.2,0)"><path data-c="2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"/></g><g data-mml-node="mi" transform="translate(8940,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(9621,0)"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"/></g><g data-mml-node="mi" transform="translate(10121,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(10915.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(11915.4,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(12405.4,0)"><path data-c="2225" d="M133 736Q138 750 153 750Q164 750 170 739Q172 735 172 250T170 -239Q164 -250 152 -250Q144 -250 138 -244L137 -243Q133 -241 133 -179T132 250Q132 731 133 736ZM329 739Q334 750 346 750Q353 750 361 744L362 743Q366 741 366 679T367 250T367 -178T362 -243L361 -244Q355 -250 347 -250Q335 -250 329 -239Q327 -235 327 250T329 739Z"/></g></g></g></svg></mjx-container></span></p><p>这意味着“局部曲率”不会超过某个上界 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></span>（你可以把 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></span>理解为“最陡的最大程度”）。在这种情况下，梯度下降取</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="10.826ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 4785.1 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="2264" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM84 -118Q84 -108 99 -98H678Q694 -104 694 -118Q694 -130 679 -138H98Q84 -131 84 -118Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(310.5,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><rect width="881" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span></p><p>通常就能保证每步不至于把损失抬高（直观上是“别一步跨太大”）。</p><p><strong>类比</strong>：你在一个城市里开车，<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.541ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 681 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></span>像“这座城市里最陡的下坡路的坡度上限”。如果你把油门踩到超过这个城市道路条件能承受的程度，你迟早会在某个最陡路段失控。</p><h2 id="强凸strongly-convex与为什么后期需要降低学习率">强凸（stronglyconvex）与“为什么后期需要降低学习率”</h2><p>如果函数在最优点附近像一个“碗”，并且碗的曲率不会太小（<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.364ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 603 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D707" d="M58 -216Q44 -216 34 -208T23 -186Q23 -176 96 116T173 414Q186 442 219 442Q231 441 239 435T249 423T251 413Q251 401 220 279T187 142Q185 131 185 107V99Q185 26 252 26Q261 26 270 27T287 31T302 38T315 45T327 55T338 65T348 77T356 88T365 100L372 110L408 253Q444 395 448 404Q461 431 491 431Q504 431 512 424T523 412T525 402L449 84Q448 79 448 68Q448 43 455 35T476 26Q485 27 496 35Q517 55 537 131Q543 151 547 152Q549 153 557 153H561Q580 153 580 144Q580 138 575 117T555 63T523 13Q510 0 491 -8Q483 -10 467 -10Q446 -10 429 -4T402 11T385 29T376 44T374 51L368 45Q362 39 350 30T324 12T288 -4T246 -11Q199 -11 153 12L129 -85Q108 -167 104 -180T92 -202Q76 -216 58 -216Z"/></g></g></g></svg></mjx-container></span>-强凸），那么会有更快的收敛性质。你可以把这理解成：</p><ul><li>碗太浅：你靠近最低点后，坡度很小，继续用大步长会来回晃；</li><li>碗够“硬”：你能更快被拉回最低点附近。</li></ul><p>很多理论告诉我们：在随机梯度（有噪声）下，学习率通常需要逐步变小，才能把“最后那点抖动”压下去。这就是schedule 后期 decay/cooldown的一个根源：<strong>让你从“探索”切换到“精修”。</strong></p><h2 id="一维二次函数里稳定-临界-发散长什么样">一维二次函数里“稳定 / 临界/ 发散”长什么样</h2><p>用 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.781ex;" xmlns="http://www.w3.org/2000/svg" width="12.42ex" height="2.737ex" role="img" focusable="false" viewbox="0 -864.9 5489.7 1209.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(681,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1070,0)"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mo" transform="translate(1539,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2205.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(3261.6,0)"><g data-mml-node="mn" transform="translate(220,394) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-345) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="553.6" height="60" x="120" y="220"/></g><g data-mml-node="mi" transform="translate(4055.1,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><g data-mml-node="msup" transform="translate(4584.1,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mn" transform="translate(502,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g></g></g></svg></mjx-container></span>这个最简单模型，你可以用一小段代码亲眼看到：</p><ul><li><strong>稳定</strong>：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.797ex;" xmlns="http://www.w3.org/2000/svg" width="10.132ex" height="2.753ex" role="img" focusable="false" viewbox="0 -864.9 4478.2 1217"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(777.8,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mi" transform="translate(1833.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2608.3,0)"><path data-c="3C" d="M694 -11T694 -19T688 -33T678 -40Q671 -40 524 29T234 166L90 235Q83 240 83 250Q83 261 91 266Q664 540 678 540Q681 540 687 534T694 519T687 505Q686 504 417 376L151 250L417 124Q686 -4 687 -5Q694 -11 694 -19Z"/></g><g data-mml-node="mfrac" transform="translate(3664.1,0)"><g data-mml-node="mn" transform="translate(230.3,394) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-345) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="574.1" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span>，参数与 loss都会快速衰减；\</li><li><strong>临界</strong>：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.797ex;" xmlns="http://www.w3.org/2000/svg" width="5.983ex" height="2.753ex" role="img" focusable="false" viewbox="0 -864.9 2644.6 1217"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(774.8,0)"><path data-c="2248" d="M55 319Q55 360 72 393T114 444T163 472T205 482Q207 482 213 482T223 483Q262 483 296 468T393 413L443 381Q502 346 553 346Q609 346 649 375T694 454Q694 465 698 474T708 483Q722 483 722 452Q722 386 675 338T555 289Q514 289 468 310T388 357T308 404T224 426Q164 426 125 393T83 318Q81 289 69 289Q55 289 55 319ZM55 85Q55 126 72 159T114 210T163 238T205 248Q207 248 213 248T223 249Q262 249 296 234T393 179L443 147Q502 112 553 112Q609 112 649 141T694 220Q694 249 708 249T722 217Q722 153 675 104T555 55Q514 55 468 76T388 123T308 170T224 192Q164 192 125 159T83 84Q80 55 69 55Q55 55 55 85Z"/></g><g data-mml-node="mfrac" transform="translate(1830.6,0)"><g data-mml-node="mn" transform="translate(230.3,394) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-345) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="574.1" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span>，会在谷底两侧来回“弹跳”，loss 降得很慢；\</li><li><strong>发散</strong>：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.797ex;" xmlns="http://www.w3.org/2000/svg" width="5.983ex" height="2.753ex" role="img" focusable="false" viewbox="0 -864.9 2644.6 1217"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(774.8,0)"><path data-c="3E" d="M84 520Q84 528 88 533T96 539L99 540Q106 540 253 471T544 334L687 265Q694 260 694 250T687 235Q685 233 395 96L107 -40H101Q83 -38 83 -20Q83 -19 83 -17Q82 -10 98 -1Q117 9 248 71Q326 108 378 132L626 250L378 368Q90 504 86 509Q84 513 84 520Z"/></g><g data-mml-node="mfrac" transform="translate(1830.6,0)"><g data-mml-node="mn" transform="translate(230.3,394) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(220,-345) scale(0.707)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"/></g><rect width="574.1" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span>，振幅越来越大，loss直接爆炸。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = <span class="number">4.0</span></span><br><span class="line">steps = <span class="number">60</span></span><br><span class="line">theta0 = <span class="number">2.0</span></span><br><span class="line">etas = [<span class="number">0.3</span>, <span class="number">2.0</span> / a, <span class="number">0.7</span>]  <span class="comment"># stable / borderline / unstable</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">eta: <span class="built_in">float</span></span>):</span><br><span class="line">    theta = theta0</span><br><span class="line">    thetas, losses = [], []</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(steps):</span><br><span class="line">        g = a * theta</span><br><span class="line">        theta = theta - eta * g</span><br><span class="line">        thetas.append(theta)</span><br><span class="line">        losses.append(<span class="number">0.5</span> * a * theta * theta)</span><br><span class="line">    <span class="keyword">return</span> np.array(thetas), np.array(losses)</span><br><span class="line"></span><br><span class="line">ths1, l1 = run(etas[<span class="number">0</span>])</span><br><span class="line">ths2, l2 = run(etas[<span class="number">1</span>])</span><br><span class="line">ths3, l3 = run(etas[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">plt.figure(figsize=(<span class="number">9</span>, <span class="number">4.5</span>), dpi=<span class="number">160</span>)</span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">plt.plot(ths1, label=<span class="string">f"stable eta=<span class="subst">{etas[<span class="number">0</span>]:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line">plt.plot(ths2, label=<span class="string">f"borderline eta=<span class="subst">{etas[<span class="number">1</span>]:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line">plt.plot(ths3, label=<span class="string">f"unstable eta=<span class="subst">{etas[<span class="number">2</span>]:<span class="number">.2</span>f}</span>"</span>)</span><br><span class="line">plt.title(<span class="string">"Parameter trajectory $\\theta_t$"</span>)</span><br><span class="line">plt.xlabel(<span class="string">"step"</span>)</span><br><span class="line">plt.ylabel(<span class="string">"$\\theta$"</span>)</span><br><span class="line">plt.legend(frameon=<span class="literal">False</span>, fontsize=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)</span><br><span class="line">plt.semilogy(l1 + <span class="number">1e-18</span>, label=<span class="string">"stable"</span>)</span><br><span class="line">plt.semilogy(l2 + <span class="number">1e-18</span>, label=<span class="string">"borderline"</span>)</span><br><span class="line">plt.semilogy(l3 + <span class="number">1e-18</span>, label=<span class="string">"unstable"</span>)</span><br><span class="line">plt.title(<span class="string">"Loss trajectory (log scale)"</span>)</span><br><span class="line">plt.xlabel(<span class="string">"step"</span>)</span><br><span class="line">plt.ylabel(<span class="string">"$L(\\theta)$"</span>)</span><br><span class="line">plt.legend(frameon=<span class="literal">False</span>, fontsize=<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">plt.tight_layout()</span><br><span class="line">plt.savefig(<span class="string">"gd_stability_1d.png"</span>)</span><br><span class="line">plt.close()</span><br></pre></td></tr></table></figure><figure><img src="/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/gd_stability_1d.png" alt="一维二次函数：学习率太大为什么会炸"><figcaption aria-hidden="true">一维二次函数：学习率太大为什么会炸</figcaption></figure><hr><h1 id="学习率与噪声为什么-batch-size-会影响学习率">学习率与“噪声”：为什么batch size 会影响学习率</h1><h2 id="随机梯度的两张脸方向有用噪声也很大">随机梯度的两张脸：方向有用，噪声也很大</h2><p>mini-batch 梯度可以看成：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="16.395ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 7246.8 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1093,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(2148.8,0)"><path data-c="2207" d="M46 676Q46 679 51 683H781Q786 679 786 676Q786 674 617 326T444 -26Q439 -33 416 -33T388 -26Q385 -22 216 326T46 676ZM697 596Q697 597 445 597T193 596Q195 591 319 336T445 80L697 596Z"/></g><g data-mml-node="mi" transform="translate(2981.8,0)"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mo" transform="translate(3662.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(4051.8,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4859.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(5470.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(6470.5,0)"><g data-mml-node="mi"><path data-c="1D709" d="M268 632Q268 704 296 704Q314 704 314 687Q314 682 311 664T308 635T309 620V616H315Q342 619 360 619Q443 619 443 586Q439 548 358 546H344Q326 546 317 549T290 566Q257 550 226 505T195 405Q195 381 201 364T211 342T218 337Q266 347 298 347Q375 347 375 314Q374 297 359 288T327 277T280 275Q234 275 208 283L195 286Q149 260 119 214T88 130Q88 116 90 108Q101 79 129 63T229 20Q238 17 243 15Q337 -21 354 -33Q383 -53 383 -94Q383 -137 351 -171T273 -205Q240 -205 202 -190T158 -167Q156 -163 156 -159Q156 -151 161 -146T176 -140Q182 -140 189 -143Q232 -168 274 -168Q286 -168 292 -165Q313 -151 313 -129Q313 -112 301 -104T232 -75Q214 -68 204 -64Q198 -62 171 -52T136 -38T107 -24T78 -8T56 12T36 37T26 66T21 103Q21 149 55 206T145 301L154 307L148 313Q141 319 136 323T124 338T111 358T103 382T99 413Q99 471 143 524T259 602L271 607Q268 618 268 632Z"/></g><g data-mml-node="mi" transform="translate(471,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span></p><p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.756ex" height="2.057ex" role="img" focusable="false" viewbox="0 -704 776.3 909"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D709" d="M268 632Q268 704 296 704Q314 704 314 687Q314 682 311 664T308 635T309 620V616H315Q342 619 360 619Q443 619 443 586Q439 548 358 546H344Q326 546 317 549T290 566Q257 550 226 505T195 405Q195 381 201 364T211 342T218 337Q266 347 298 347Q375 347 375 314Q374 297 359 288T327 277T280 275Q234 275 208 283L195 286Q149 260 119 214T88 130Q88 116 90 108Q101 79 129 63T229 20Q238 17 243 15Q337 -21 354 -33Q383 -53 383 -94Q383 -137 351 -171T273 -205Q240 -205 202 -190T158 -167Q156 -163 156 -159Q156 -151 161 -146T176 -140Q182 -140 189 -143Q232 -168 274 -168Q286 -168 292 -165Q313 -151 313 -129Q313 -112 301 -104T232 -75Q214 -68 204 -64Q198 -62 171 -52T136 -38T107 -24T78 -8T56 12T36 37T26 66T21 103Q21 149 55 206T145 301L154 307L148 313Q141 319 136 323T124 338T111 358T103 382T99 413Q99 471 143 524T259 602L271 607Q268 618 268 632Z"/></g><g data-mml-node="mi" transform="translate(471,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span>是噪声（随机性）。这件事带来两种效应：</p><ul><li>好处：噪声让你不容易困在“很尖的坏坑”，像在地形里加了点抖动；</li><li>坏处：噪声让大步长更容易“抖飞”，训练不稳定。</li></ul><p><strong>类比</strong>：你蒙眼下山，手里拿指南针（梯度方向），但指南针会抖（噪声）。你走得越快（学习率大），抖动造成的偏差越大。</p><h2 id="经典经验线性缩放法则与-warmup大-batch-训练">经典经验：线性缩放法则与warmup（大 batch 训练）</h2><p>很多设置里，增大 batch size 可以减少梯度噪声，因此人们常用经验：</p><ul><li>batch 变大 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container></span> 倍，学习率也乘<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container></span>（线性缩放）；</li><li>但训练初期“系统还没稳定”，所以先用 warmup把学习率从小慢慢升到目标值。</li></ul><p>warmup 的典型形式（线性 warmup）：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.909ex;" xmlns="http://www.w3.org/2000/svg" width="31.539ex" height="4.855ex" role="img" focusable="false" viewbox="0 -1302 13940.1 2145.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(278,0)"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(834,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1112,0)"/></g></g></g><g data-mml-node="mo" transform="translate(4032.4,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(5032.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(5421.6,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(389,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(889,0)"/><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(1281,0)"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1781,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2225,0)"/></g></g></g><g data-mml-node="mo" transform="translate(8072.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9072.5,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(278,0)"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(834,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1112,0)"/></g></g></g><g data-mml-node="mo" transform="translate(10713.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mfrac" transform="translate(11102.8,0)"><g data-mml-node="mi" transform="translate(1238.1,676)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="msub" transform="translate(220,-686)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><g data-mml-node="TeXAtom" transform="translate(617,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(722,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1222,0)"/><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1614,0)"/></g></g></g><rect width="2597.3" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span></p><p>近年的研究进一步解释了 warmup 的作用：它往往不是“为了收集 Adam的统计量”这么简单，而是<strong>帮助模型进入更“好条件”的区域，从而能承受更大的目标学习率</strong>（见后文“最新进展”部分）。</p><hr><h1 id="动量学习率的隐形放大器">动量：学习率的“隐形放大器”</h1><h2 id="sgd-momentum-的更新与直觉">SGD + Momentum 的更新与直觉</h2><p>动量（以经典形式为例）：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="32.413ex" height="2.084ex" role="img" focusable="false" viewbox="0 -705 14326.6 921"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1101,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(2156.8,0)"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="msub" transform="translate(2722.8,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="TeXAtom" transform="translate(518,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(4672,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="msub" transform="translate(5672.2,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(6487.5,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(6765.5,0)"><g data-mml-node="mspace"/></g><g data-mml-node="msub" transform="translate(7932.1,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(9920.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(10976.6,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(12006.1,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(13006.4,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msub" transform="translate(13503.4,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span></p><p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.075ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4011.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mo" transform="translate(843.8,0)"><path data-c="2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"/></g><g data-mml-node="mo" transform="translate(1788.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(2177.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(2677.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(3122.2,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(3622.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span> 常取0.9。</p><p><strong>类比</strong>：你推一个很重的购物车下坡：</p><ul><li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.844ex" height="1.464ex" role="img" focusable="false" viewbox="0 -442 815.3 647"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span> 是你当下看到的坡度；</li><li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="1.863ex" height="1.359ex" role="img" focusable="false" viewbox="0 -443 823.3 600.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span> 是车的速度（带惯性）；</li><li><span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.281ex" height="2.034ex" role="img" focusable="false" viewbox="0 -705 566 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g></g></g></svg></mjx-container></span>越大，车越“刹不住”，但也越能穿过小坑洼；</li><li>学习率 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>相当于“你给速度换算成位移的比例”。</li></ul><h2 id="为什么动量会让你更容易过冲">为什么动量会让你更容易“过冲”</h2><p>直觉上，动量会把一段时间内的梯度方向叠加起来，相当于“长期沿一个方向加速”。因此：</p><ul><li>同样的 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>，加动量后等效步长更大；</li><li>所以很多时候 <strong>SGD+momentum的可用学习率上限会更低</strong>，否则会更容易震荡。</li></ul><p>这也是为什么一些训练 recipe 会写：</p><ul><li>SGD 的 base LR 比 AdamW 大；</li><li>但 SGD + momentum 需要更谨慎的 warmup/decay；</li><li>或者配合更强的正则化（weight decay、label smoothing 等）稳住。</li></ul><hr><h1 id="自适应优化器学习率变成一组学习率">自适应优化器：学习率“变成一组学习率”</h1><p>如果说 SGD 的学习率是一把锤子（全局同一个 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>），那么 Adam类方法像是一套“带扭矩控制的电动螺丝刀”：不同参数会自动用不同的步长。</p><h2 id="adam-的核心公式一定要看懂">Adam 的核心公式（一定要看懂）</h2><p>Adam（省略一些细节，只保留关键结构）：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="25.369ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 11213 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1494,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2549.8,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="msub" transform="translate(3552.4,0)"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(911,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(5894.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(6894.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(7283.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(8006,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9006.2,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="mo" transform="translate(10008.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msub" transform="translate(10397.8,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="mi" transform="translate(510,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.625ex;" xmlns="http://www.w3.org/2000/svg" width="25.058ex" height="2.625ex" role="img" focusable="false" viewbox="0 -883.9 11075.4 1160"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1101,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2156.8,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="msub" transform="translate(3159.4,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="TeXAtom" transform="translate(518,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(5108.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mo" transform="translate(6108.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(6497.8,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(7220,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(8220.2,0)"><g data-mml-node="mi"><path data-c="1D6FD" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"/></g><g data-mml-node="mn" transform="translate(599,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(9222.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="msubsup" transform="translate(9611.8,0)"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="TeXAtom" transform="translate(510,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2299" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM682 250Q682 322 649 387T546 497T381 542Q272 542 184 459T95 250Q95 132 178 45T389 -42Q515 -42 598 45T682 250ZM311 250Q311 285 332 304T375 328Q376 328 382 328T392 329Q424 326 445 305T466 250Q466 217 445 195T389 172Q354 172 333 195T311 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mi" transform="translate(510,-268.3) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span></p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.76ex;" xmlns="http://www.w3.org/2000/svg" width="21.455ex" height="6.122ex" role="img" focusable="false" viewbox="0 -1486 9482.9 2706"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="TeXAtom" transform="translate(502,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(361,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1139,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(1988.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3044.5,0)"><g data-mml-node="mi"><path data-c="1D703" d="M35 200Q35 302 74 415T180 610T319 704Q320 704 327 704T339 705Q393 701 423 656Q462 596 462 495Q462 380 417 261T302 66T168 -10H161Q125 -10 99 10T60 63T41 130T35 200ZM383 566Q383 668 330 668Q294 668 260 623T204 521T170 421T157 371Q206 370 254 370L351 371Q352 372 359 404T375 484T383 566ZM113 132Q113 26 166 26Q181 26 198 36T239 74T287 161T335 307L340 324H145Q145 321 136 286T120 208T113 132Z"/></g><g data-mml-node="mi" transform="translate(502,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(4074,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(5074.2,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mfrac" transform="translate(5571.2,0)"><g data-mml-node="msub" transform="translate(1347.7,676)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(439,16) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mrow" transform="translate(220,-1014.1)"><g data-mml-node="msqrt"><g transform="translate(1020,0)"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g><g data-mml-node="mo" transform="translate(0,144.1)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="823.3" height="60" x="1020" y="934.1"/></g><g data-mml-node="mo" transform="translate(2065.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(3065.7,0)"><path data-c="1D716" d="M227 -11Q149 -11 95 41T40 174Q40 262 87 322Q121 367 173 396T287 430Q289 431 329 431H367Q382 426 382 411Q382 385 341 385H325H312Q191 385 154 277L150 265H327Q340 256 340 246Q340 228 320 219H138V217Q128 187 128 143Q128 77 160 52T231 26Q258 26 284 36T326 57T343 68Q350 68 354 58T358 39Q358 36 357 35Q354 31 337 21T289 0T227 -11Z"/></g></g><rect width="3671.7" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span></p><p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.626ex;" xmlns="http://www.w3.org/2000/svg" width="3.311ex" height="2.625ex" role="img" focusable="false" viewbox="0 -883.2 1463.7 1160"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"/></g><g data-mml-node="TeXAtom" transform="translate(510,412.3) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2299" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM682 250Q682 322 649 387T546 497T381 542Q272 542 184 459T95 250Q95 132 178 45T389 -42Q515 -42 598 45T682 250ZM311 250Q311 285 332 304T375 328Q376 328 382 328T392 329Q424 326 445 305T466 250Q466 217 445 195T389 172Q354 172 333 195T311 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mi" transform="translate(510,-269) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span>表示逐元素平方；<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="5.62ex" height="2.274ex" role="img" focusable="false" viewbox="0 -811 2484.2 1005"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(439,16) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(911,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1216.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="msub" transform="translate(1660.9,0)"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span>是偏置修正后的估计。</p><p>你应该抓住一句话：</p><blockquote><p><strong>Adam 的“有效学习率”大致是 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.87ex" height="2.95ex" role="img" focusable="false" viewbox="0 -1054.1 5246.7 1304.1"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(497,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mo" transform="translate(997,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msqrt" transform="translate(1386,0)"><g transform="translate(1020,0)"><g data-mml-node="msub"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mover"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mo" transform="translate(270.3,17) translate(-250 0)"><path data-c="5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"/></g></g></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g><g data-mml-node="mo" transform="translate(0,144.1)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="823.3" height="60" x="1020" y="934.1"/></g><g data-mml-node="mo" transform="translate(3451.5,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(4451.7,0)"><path data-c="1D716" d="M227 -11Q149 -11 95 41T40 174Q40 262 87 322Q121 367 173 396T287 430Q289 431 329 431H367Q382 426 382 411Q382 385 341 385H325H312Q191 385 154 277L150 265H327Q340 256 340 246Q340 228 320 219H138V217Q128 187 128 143Q128 77 160 52T231 26Q258 26 284 36T326 57T343 68Q350 68 354 58T358 39Q358 36 357 35Q354 31 337 21T289 0T227 -11Z"/></g><g data-mml-node="mo" transform="translate(4857.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span></strong>，所以每个参数的步长会随其梯度尺度自动缩放。</p></blockquote><p><strong>类比</strong>：同一辆车在不同路面（不同参数维度）行驶。路面越颠（梯度方差越大），系统自动把那一侧轮子的扭矩（步长）调小，避免打滑。</p><h2 id="为什么-adam-仍然需要-warmup而且经常更需要">为什么 Adam 仍然需要warmup（而且经常更需要）</h2><p>很多人以为：Adam 都自适应了，为什么还要 warmup？</p><p>一个关键原因：<strong>训练初期的统计量不稳定 +某些方向的“预条件化曲率”很大</strong>，导致你如果一上来就用目标学习率，容易出现大幅抖动（lossspike）甚至训练失败。</p><p>这也是近年关于 warmup 的理论解释里经常出现的关键词：<strong>sharpness/ preconditioned sharpness</strong>（可理解为“有效曲率”）。</p><hr><h1 id="学习率调度schedule大全从老办法到大模型默认">学习率调度（schedule）大全：从老办法到大模型默认</h1><p>把 schedule 看成“训练过程的配速策略”：</p><ul><li>前期：探索更大范围（跑得快）</li><li>中期：稳定推进（匀速）</li><li>后期：精细收敛（减速、微调）</li></ul><p>先看一张“最常用曲线”对比图（同样由 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="13.359ex" height="2.034ex" role="img" focusable="false" viewbox="0 -694 5904.6 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mspace"/><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(361,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"/></g><g data-mml-node="mi" transform="translate(827,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mi" transform="translate(1399,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(1760,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(2121,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2482,0)"><g data-mml-node="mi"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"/></g><g data-mml-node="msub" transform="translate(298,0)"><g data-mml-node="mi"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(484,-150) scale(0.707)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g></g><g data-mml-node="mi" transform="translate(1174.9,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(1519.9,0)"><path data-c="1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"/></g><g data-mml-node="mo" transform="translate(1984.9,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"/></g><g data-mml-node="mi" transform="translate(2429.6,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g><g data-mml-node="mi" transform="translate(2932.6,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></g></svg></mjx-container></span> 生成）：</p><figure><img src="/%E5%AD%A6%E4%B9%A0%E7%8E%87%EF%BC%9A%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E7%9A%84%E7%BB%88%E6%9E%81%E6%8C%87%E5%8D%97%EF%BC%882026%EF%BC%89/lr_schedules.png" alt="三种常见学习率曲线：Constant / Warmup+Cosine / WSD"><figcaption aria-hidden="true">三种常见学习率曲线：Constant /Warmup+Cosine / WSD</figcaption></figure><h2 id="常数学习率constant">常数学习率（Constant）</h2><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="7.019ex" height="1.808ex" role="img" focusable="false" viewbox="0 -583 3102.4 799"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(530,-150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g></g></svg></mjx-container></span></p><p>优点：简单。</p><p>缺点：几乎总会在“速度 vs稳定”之间两难：要么前期太慢，要么后期太抖。</p><h2 id="step-decay台阶式">Step decay（台阶式）</h2><p>例如每到某些 epoch 乘以 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.229ex" height="1.486ex" role="img" focusable="false" viewbox="0 -441 543 657"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g></g></g></svg></mjx-container></span>：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.288ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 8525.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(774.8,0)"><path data-c="2190" d="M944 261T944 250T929 230H165Q167 228 182 216T211 189T244 152T277 96T303 25Q308 7 308 0Q308 -11 288 -11Q281 -11 278 -11T272 -7T267 2T263 21Q245 94 195 151T73 236Q58 242 55 247Q55 254 59 257T73 264Q121 283 158 314T215 375T247 434T264 480L267 497Q269 503 270 505T275 509T288 511Q308 511 308 500Q308 493 303 475Q293 438 278 406T246 352T215 315T185 287T165 270H929Q944 261 944 250Z"/></g><g data-mml-node="mi" transform="translate(2052.6,0)"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g><g data-mml-node="mi" transform="translate(2595.6,0)"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(3092.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mstyle" transform="translate(3370.6,0)"><g data-mml-node="mspace"/></g><g data-mml-node="mi" transform="translate(4537.2,0)"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g><g data-mml-node="mo" transform="translate(5358,0)"><path data-c="2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"/></g><g data-mml-node="mo" transform="translate(6302.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(6691.8,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(7191.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(7636.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(8136.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span></p><p>类比：跑步时每过一段路程突然把速度降一档。</p><p>优点：实现简单。</p><p>缺点：变化不平滑，可能造成训练指标突然波动。</p><h2 id="exponential-decay指数衰减">Exponential decay（指数衰减）</h2><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="10.763ex" height="2.425ex" role="img" focusable="false" viewbox="0 -855.6 4757.3 1071.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(530,-150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g><g data-mml-node="mo" transform="translate(3324.6,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/></g><g data-mml-node="msup" transform="translate(3824.8,0)"><g data-mml-node="mi"><path data-c="1D6FE" d="M31 249Q11 249 11 258Q11 275 26 304T66 365T129 418T206 441Q233 441 239 440Q287 429 318 386T371 255Q385 195 385 170Q385 166 386 166L398 193Q418 244 443 300T486 391T508 430Q510 431 524 431H537Q543 425 543 422Q543 418 522 378T463 251T391 71Q385 55 378 6T357 -100Q341 -165 330 -190T303 -216Q286 -216 286 -188Q286 -138 340 32L346 51L347 69Q348 79 348 100Q348 257 291 317Q251 355 196 355Q148 355 108 329T51 260Q49 251 47 251Q45 249 31 249Z"/></g><g data-mml-node="mi" transform="translate(627.3,413) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g></g></g></svg></mjx-container></span></p><p>优点：平滑。</p><p>缺点：后期可能衰得太快，等效“刹车过早”，尤其在长训练中。</p><h2 id="cosine-decay余弦退火深度学习最常用之一">Cosinedecay（余弦退火，深度学习最常用之一）</h2><p>（最常见版本：从峰值衰到一个最小值）</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.148ex;" xmlns="http://www.w3.org/2000/svg" width="44.789ex" height="5.428ex" role="img" focusable="false" viewbox="0 -1449.5 19796.9 2399"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2168.8,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(4149.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mfrac" transform="translate(5150,0)"><g data-mml-node="mn" transform="translate(220,676)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mn" transform="translate(220,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="700" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(6090,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(6479,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g><g data-mml-node="mo" transform="translate(8597.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="msub" transform="translate(9597.4,0)"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g><g data-mml-node="mo" transform="translate(11356.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mrow" transform="translate(11911.8,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mn" transform="translate(736,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1458.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(2458.4,0)"><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z"/><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(444,0)"/><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z" transform="translate(944,0)"/></g><g data-mml-node="mo" transform="translate(3796.4,0)"><path data-c="2061" d=""/></g><g data-mml-node="mrow" transform="translate(3963.1,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M701 -940Q701 -943 695 -949H664Q662 -947 636 -922T591 -879T537 -818T475 -737T412 -636T350 -511T295 -362T250 -186T221 17T209 251Q209 962 573 1361Q596 1386 616 1405T649 1437T664 1450H695Q701 1444 701 1441Q701 1436 681 1415T629 1356T557 1261T476 1118T400 927T340 675T308 359Q306 321 306 250Q306 -139 400 -430T690 -924Q701 -936 701 -940Z"/></g><g data-mml-node="mi" transform="translate(736,0)"><path data-c="1D70B" d="M132 -11Q98 -11 98 22V33L111 61Q186 219 220 334L228 358H196Q158 358 142 355T103 336Q92 329 81 318T62 297T53 285Q51 284 38 284Q19 284 19 294Q19 300 38 329T93 391T164 429Q171 431 389 431Q549 431 553 430Q573 423 573 402Q573 371 541 360Q535 358 472 358H408L405 341Q393 269 393 222Q393 170 402 129T421 65T431 37Q431 20 417 5T381 -10Q370 -10 363 -7T347 17T331 77Q330 86 330 121Q330 170 339 226T357 318T367 358H269L268 354Q268 351 249 275T206 114T175 17Q164 -11 132 -11Z"/></g><g data-mml-node="mfrac" transform="translate(1306,0)"><g data-mml-node="mi" transform="translate(391.5,676)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(220,-686)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><rect width="904" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(2450,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g><g data-mml-node="mo" transform="translate(7149.1,0) translate(0 -0.5)"><path data-c="29" d="M34 1438Q34 1446 37 1448T50 1450H56H71Q73 1448 99 1423T144 1380T198 1319T260 1238T323 1137T385 1013T440 864T485 688T514 485T526 251Q526 134 519 53Q472 -519 162 -860Q139 -885 119 -904T86 -936T71 -949H56Q43 -949 39 -947T34 -937Q88 -883 140 -813Q428 -430 428 251Q428 453 402 628T338 922T245 1146T145 1309T46 1425Q44 1427 42 1429T39 1433T36 1436L34 1438Z"/></g></g></g></g></svg></mjx-container></span></p><p><strong>直觉</strong>：一开始减速慢（保持探索），后面减速快（冲向收敛）。</p><p>大模型训练中常见结构是：</p><ul><li>warmup：线性升到 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span></li><li>cosine：从 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span> 退到<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="3.979ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1758.7 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g></g></g></svg></mjx-container></span></li></ul><h2 id="cosine-warm-restartssgdr">Cosine warm restarts（SGDR）</h2><p>余弦衰到低点后又“重启”到高学习率，再衰一次。</p><p>直觉：像周期性“冲坡”，有时能跳出局部坏盆地。</p><p>在现代大模型预训练中，<strong>不如纯一次性 cosine / WSD常见</strong>，但在一些中小模型与某些任务上仍有价值。</p><h2 id="one-cycle超级收敛思想">One-cycle（超级收敛思想）</h2><p>核心：学习率先升后降（并配合动量反向变化）。</p><p>直觉：前期把学习率推到接近稳定边界，加速探索；后期快速降下来收敛。</p><p>很适合“训练步数较短、希望快速到一个不错解”的场景。</p><h2 id="逆平方根transformer-经典-schedule">逆平方根（Transformer 经典schedule）</h2><p>在 Transformer 早期训练 recipe 中很常见的一类形式（示意）：</p><p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -1.469ex;" xmlns="http://www.w3.org/2000/svg" width="25.414ex" height="4.07ex" role="img" focusable="false" viewbox="0 -1149.5 11233.2 1799"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(530,-150) scale(0.707)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g></g><g data-mml-node="mo" transform="translate(1113,0)"><path data-c="221D" d="M56 124T56 216T107 375T238 442Q260 442 280 438T319 425T352 407T382 385T406 361T427 336T442 315T455 297T462 285L469 297Q555 442 679 442Q687 442 722 437V398H718Q710 400 694 400Q657 400 623 383T567 343T527 294T503 253T495 235Q495 231 520 192T554 143Q625 44 696 44Q717 44 719 46H722V-5Q695 -11 678 -11Q552 -11 457 141Q455 145 454 146L447 134Q362 -11 235 -11Q157 -11 107 56ZM93 213Q93 143 126 87T220 31Q258 31 292 48T349 88T389 137T413 178T421 196Q421 200 396 239T362 288Q322 345 288 366T213 387Q163 387 128 337T93 213Z"/></g><g data-mml-node="mo" transform="translate(2168.8,0)"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g><g data-mml-node="mrow" transform="translate(4002.5,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="28" d="M180 96T180 250T205 541T266 770T353 944T444 1069T527 1150H555Q561 1144 561 1141Q561 1137 545 1120T504 1072T447 995T386 878T330 721T288 513T272 251Q272 133 280 56Q293 -87 326 -209T399 -405T475 -531T536 -609T561 -640Q561 -643 555 -649H527Q483 -612 443 -568T353 -443T266 -270T205 -41Z"/></g><g data-mml-node="msup" transform="translate(597,0)"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="TeXAtom" transform="translate(394,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1278,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mn" transform="translate(1778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g></g><g data-mml-node="mo" transform="translate(2651.8,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(3096.5,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mo" transform="translate(3679.7,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/></g><g data-mml-node="msubsup" transform="translate(4179.9,0)"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><g data-mml-node="TeXAtom" transform="translate(793,530.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1278,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mn" transform="translate(1778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="TeXAtom" transform="translate(617,-143.2) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="77" d="M90 368Q84 378 76 380T40 385H18V431H24L43 430Q62 430 84 429T116 428Q206 428 221 431H229V385H215Q177 383 177 368Q177 367 221 239L265 113L339 328L333 345Q323 374 316 379Q308 384 278 385H258V431H264Q270 428 348 428Q439 428 454 431H461V385H452Q404 385 404 369Q404 366 418 324T449 234T481 143L496 100L537 219Q579 341 579 347Q579 363 564 373T530 385H522V431H529Q541 428 624 428Q692 428 698 431H703V385H697Q696 385 691 385T682 384Q635 377 619 334L559 161Q546 124 528 71Q508 12 503 1T487 -11H479Q460 -11 456 -4Q455 -3 407 133L361 267Q359 263 266 -4Q261 -11 243 -11H238Q225 -11 220 -3L90 368Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(722,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(1222,0)"/><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1614,0)"/></g></g></g><g data-mml-node="mo" transform="translate(6633.7,0) translate(0 -0.5)"><path data-c="29" d="M35 1138Q35 1150 51 1150H56H69Q113 1113 153 1069T243 944T330 771T391 541T416 250T391 -40T330 -270T243 -443T152 -568T69 -649H56Q43 -649 39 -647T35 -637Q65 -607 110 -548Q283 -316 316 56Q324 133 324 251Q324 368 316 445Q278 877 48 1123Q36 1137 35 1138Z"/></g></g></g></g></svg></mjx-container></span></p><p>直觉：warmup 后开始按 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="4.649ex" height="2.046ex" role="img" focusable="false" viewbox="0 -893.3 2054.8 904.3"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="TeXAtom" transform="translate(394,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1278,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"/></g></g><g data-mml-node="mn" transform="translate(1778,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g></g></g></g></svg></mjx-container></span>缓慢衰减。</p><p>这类 schedule 的精神是：<strong>长期训练别衰太快</strong>。</p><h2 id="wsdwarmupstabledecay近年大模型训练的重要趋势">WSD（Warmup–Stable–Decay）：近年大模型训练的重要趋势</h2><p>WSD 的核心形状：</p><ul><li>warmup：上升</li><li>stable：长时间保持常数学习率</li><li>decay/cooldown：最后线性（或其他形式）降到很小</li></ul><p>直觉：中段“匀速巡航”，最后“进站刹车”。</p><p>为什么它近年很受欢迎？</p><ul><li>它比 cosine更“可复用”：你可以先训练一段稳定期，后面想延长训练时不必从头设计一个依赖总步数的半周期cosine。</li><li>很多工作观察到 cooldown开始时损失会出现“明显下降”，像模型终于被允许“精细贴合”盆地。</li></ul><p>（后文会结合 2025 的理论解释更详细讲。）</p><hr><h1 id="从能跑到跑得好一套可操作的学习率调参流程">从“能跑”到“跑得好”：一套可操作的学习率调参流程</h1><p>下面给一套你可以在绝大多数任务里复用的流程（从小白视角写，但足够深）。</p><h2 id="先搞清楚你训练失败到底是哪种失败">先搞清楚：你训练失败到底是哪种失败？</h2><p>训练“坏掉”常见有三类：</p><ol type="1"><li><strong>直接发散</strong>：loss 变成 NaN/inf，或者几步内冲天。</li><li><strong>抖动不收敛</strong>：loss 在高位大幅波动，指标上不去。</li><li><strong>看似稳定但学不动</strong>：loss缓慢下降甚至平台期很早出现。</li></ol><p>对应的学习率结论通常是：</p><ul><li>(1)(2)：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>太大（或动量太大、或缺少 warmup、或裁剪/正则不够）</li><li>(3)：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span> 太小（或 schedule衰减太快、或 batch 太小噪声太大）</li></ul><h2 id="用-lr-range-test-快速找可行区间强烈推荐">用 “LR range test”快速找可行区间（强烈推荐）</h2><p>经典做法：在很短的训练里，让学习率从很小指数增长到很大，观察 loss什么时候开始明显上升/发散。</p><p>直觉：你在“试探油门”，找到“刚好不翻车”的上限。</p><p>简化版伪代码（PyTorch）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lr_range_test</span>(<span class="params">model, loader, loss_fn, optimizer, lr_min=<span class="number">1e-7</span>, lr_max=<span class="number">10</span>, num_steps=<span class="number">200</span></span>):</span><br><span class="line">    model.train()</span><br><span class="line">    <span class="comment"># 指数增长</span></span><br><span class="line">    mult = (lr_max / lr_min) ** (<span class="number">1</span> / (num_steps - <span class="number">1</span>))</span><br><span class="line">    lr = lr_min</span><br><span class="line">    <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">        g[<span class="string">"lr"</span>] = lr</span><br><span class="line"></span><br><span class="line">    losses = []</span><br><span class="line">    lrs = []</span><br><span class="line">    it = <span class="built_in">iter</span>(loader)</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(num_steps):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            x, y = <span class="built_in">next</span>(it)</span><br><span class="line">        <span class="keyword">except</span> StopIteration:</span><br><span class="line">            it = <span class="built_in">iter</span>(loader)</span><br><span class="line">            x, y = <span class="built_in">next</span>(it)</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        pred = model(x)</span><br><span class="line">        loss = loss_fn(pred, y)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        losses.append(loss.item())</span><br><span class="line">        lrs.append(lr)</span><br><span class="line"></span><br><span class="line">        lr *= mult</span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            g[<span class="string">"lr"</span>] = lr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lrs, losses</span><br></pre></td></tr></table></figure><p>你会得到一个曲线：</p><ul><li>初期 loss 下降（学习开始）</li><li>到某个点开始抖动甚至上升（接近稳定边界）</li></ul><p>经验：把“刚开始明显变差前”的学习率当作 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span> 的量级，然后正式训练用它的0.3～1 倍（按任务调整）。</p><h2 id="选择-schedule小模型-vs-大模型的经验差异">选择 schedule：小模型vs 大模型的经验差异</h2><ul><li><strong>中小模型（训练步数不算特别长）</strong>：cosine / one-cycle往往很稳妥。</li><li><strong>大模型预训练（训练极长、可能要多次续训）</strong>：WSD 或schedule-free 值得优先考虑。</li></ul><p>一个很实用的默认（尤其是 AdamW）：</p><ul><li>warmup：1%～5% steps（大 batch 或很深模型倾向更长）</li><li>stable：大部分训练保持 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span></li><li>cooldown：最后 10%～20% steps 线性降到 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="3.979ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1758.7 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(833,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1111,0)"/></g></g></g></g></g></svg></mjx-container></span>（比如 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span> 的 0.1 倍或更小）</li></ul><h2 id="学习率batch权重衰减三者要一起看">“学习率、batch、权重衰减”三者要一起看</h2><p>很多人只调学习率，然后觉得“怎么总是不稳”。实际上这三者高度耦合：</p><ul><li>batch 影响梯度噪声；</li><li>weight decay 影响参数尺度（等价于持续把参数往 0 拉）；</li><li>学习率决定你每一步“顺着梯度走多远”。</li></ul><p><strong>类比</strong>：你驾驶一辆车：</p><ul><li>learning rate 是油门；</li><li>batch size 是路面摩擦/风噪（稳定性）；</li><li>weight decay 像一直有个刹车在轻踩（让车别越跑越飘）。</li></ul><p>不稳定时不要只想着“降学习率”，很多时候：</p><ul><li>加一点梯度裁剪（clip norm）</li><li>适当加 weight decay</li><li>或者延长 warmup</li></ul><p>会比一味降 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span>更好，因为降 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span>往往会牺牲最终效果或训练效率。</p><hr><h1 id="代码从零实现常用-schedulepytorch">代码：从零实现常用schedule（PyTorch）</h1><p>下面给一个“够用且清晰”的实现：warmup + cosine / warmup +WSD（cooldown 线性）。</p><h2 id="warmup-cosine">Warmup + Cosine</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lr_warmup_cosine</span>(<span class="params">step, total_steps, warmup_steps, lr_max, lr_min=<span class="number">0.0</span></span>):</span><br><span class="line">    <span class="keyword">if</span> step &lt; warmup_steps:</span><br><span class="line">        <span class="comment"># 线性 warmup</span></span><br><span class="line">        <span class="keyword">return</span> lr_max * (step + <span class="number">1</span>) / <span class="built_in">max</span>(<span class="number">1</span>, warmup_steps)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># cosine decay</span></span><br><span class="line">    t = step - warmup_steps</span><br><span class="line">    T = <span class="built_in">max</span>(<span class="number">1</span>, total_steps - warmup_steps)</span><br><span class="line">    cos = <span class="number">0.5</span> * (<span class="number">1.0</span> + math.cos(math.pi * t / T))</span><br><span class="line">    <span class="keyword">return</span> lr_min + (lr_max - lr_min) * cos</span><br></pre></td></tr></table></figure><h2 id="warmup-stable-decaywsd">Warmup + Stable + Decay（WSD）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">lr_wsd</span>(<span class="params">step, total_steps, warmup_steps, cooldown_steps, lr_max, lr_min=<span class="number">0.0</span></span>):</span><br><span class="line">    <span class="comment"># warmup</span></span><br><span class="line">    <span class="keyword">if</span> step &lt; warmup_steps:</span><br><span class="line">        <span class="keyword">return</span> lr_max * (step + <span class="number">1</span>) / <span class="built_in">max</span>(<span class="number">1</span>, warmup_steps)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># stable</span></span><br><span class="line">    stable_end = total_steps - cooldown_steps</span><br><span class="line">    <span class="keyword">if</span> step &lt; stable_end:</span><br><span class="line">        <span class="keyword">return</span> lr_max</span><br><span class="line"></span><br><span class="line">    <span class="comment"># cooldown: 线性衰减到 lr_min</span></span><br><span class="line">    t = step - stable_end</span><br><span class="line">    T = <span class="built_in">max</span>(<span class="number">1</span>, cooldown_steps)</span><br><span class="line">    frac = <span class="built_in">min</span>(<span class="number">1.0</span>, (t + <span class="number">1</span>) / T)</span><br><span class="line">    <span class="keyword">return</span> lr_max + (lr_min - lr_max) * frac</span><br></pre></td></tr></table></figure><h2 id="把它接到-optimizer-上训练循环骨架">把它接到 optimizer上（训练循环骨架）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train_one_epoch</span>(<span class="params">model, loader, optimizer, step_offset, total_steps, schedule_fn, device=<span class="string">"cuda"</span></span>):</span><br><span class="line">    model.train()</span><br><span class="line">    step = step_offset</span><br><span class="line">    <span class="keyword">for</span> x, y <span class="keyword">in</span> loader:</span><br><span class="line">        x, y = x.to(device), y.to(device)</span><br><span class="line"></span><br><span class="line">        lr = schedule_fn(step, total_steps)</span><br><span class="line">        <span class="keyword">for</span> g <span class="keyword">in</span> optimizer.param_groups:</span><br><span class="line">            g[<span class="string">"lr"</span>] = lr</span><br><span class="line"></span><br><span class="line">        optimizer.zero_grad(set_to_none=<span class="literal">True</span>)</span><br><span class="line">        pred = model(x)</span><br><span class="line">        loss = torch.nn.functional.cross_entropy(pred, y)</span><br><span class="line">        loss.backward()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 可选：梯度裁剪，常用于大模型稳定性</span></span><br><span class="line">        torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm=<span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">        optimizer.step()</span><br><span class="line">        step += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> step</span><br></pre></td></tr></table></figure><p>你可以像这样传入 schedule：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">schedule_fn = <span class="keyword">lambda</span> step, total_steps: lr_wsd(</span><br><span class="line">    step=step,</span><br><span class="line">    total_steps=total_steps,</span><br><span class="line">    warmup_steps=<span class="built_in">int</span>(<span class="number">0.02</span> * total_steps),</span><br><span class="line">    cooldown_steps=<span class="built_in">int</span>(<span class="number">0.10</span> * total_steps),</span><br><span class="line">    lr_max=<span class="number">3e-4</span>,</span><br><span class="line">    lr_min=<span class="number">3e-5</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure><hr><h1 id="最新研究进展大家在学学习率什么">最新研究进展：大家在“学学习率”什么？</h1><p>如果你把学习率看成“油门曲线”，那么近年的研究大致沿着三条路在推进：</p><ol type="1"><li><strong>更好的油门曲线</strong>：cosine 之外，WSD、power-lawfamily、token/batch agnostic schedule。</li><li><strong>把油门交给系统</strong>：schedule-free（不需要指定总步数的schedule）、甚至 learning-rate-free（让算法自动估计合适步长）。</li><li><strong>解释为什么有效</strong>：warmup、cooldown的机制解释，稳定边界、曲率/尖锐度（sharpness）视角，和大模型不稳定的预测。</li></ol><p>下面按时间线串起来。</p><h2 id="learning-rate-free-的代表d-adaptation">2023：Learning-rate-free的代表——D-Adaptation</h2><p>一句话：<strong>尽量不让你手动调 base learning rate</strong>。</p><p>D-Adaptation（2023，Meta）提出用一种理论驱动的方式自动估计步长尺度，使得在很多任务上能接近手调学习率的效果。</p><p>你可以把它理解成：传统方法需要你告诉系统“从起点到终点大概有多远”（步长尺度），而D-Adaptation试图在训练过程中估计这个“距离尺度”，从而自动设定合适的步长。</p><p>参考：<a class="link" href="https://ai.meta.com/research/publications/learning-rate-free-learning-by-d-adaptation/">LearningRate-Free Learning by D-Adaptation (Meta, 2023)<i class="fas fa-external-link-alt"></i></a></p><h2 id="schedule-free-adamwthe-road-less-scheduled">2024：Schedule-FreeAdamW（The Road Less Scheduled）</h2><p>经典痛点：很多 schedule 需要你提前知道总训练步数 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewbox="0 -677 704 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g></g></svg></mjx-container></span>（例如 cosine的半周期要对齐训练长度）。但现实中你经常会：</p><ul><li>训练到一半发现还想继续；</li><li>或者想做不同训练预算的对比；</li><li>或者数据/算力不确定。</li></ul><p>Schedule-Free AdamW（2024）提出一种做法：<strong>干脆不显式做schedule，但性能能与有 schedule 的方法竞争</strong>。</p><p>直觉理解：它把“调度”和“迭代平均”等思想统一起来，让算法在不需要知道停止时间<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.593ex" height="1.532ex" role="img" focusable="false" viewbox="0 -677 704 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g></g></svg></mjx-container></span>的情况下，仍能走出类似“先快后慢”的有效轨迹。</p><p>参考：<a class="link" href="https://arxiv.org/abs/2405.15682">Schedule-Free AdamW(arXiv:2405.15682)<i class="fas fa-external-link-alt"></i></a></p><h2 id="why-warmupwarmup-机制被更系统地解释">2024：Why Warmup?——warmup机制被更系统地解释</h2><p>2024 的一条重要结论是：warmup的主要收益往往是<strong>让网络能承受更大的目标学习率</strong>，而不是仅仅“让Adam 统计量更准”。</p><p>这会改变你调参的思路：</p><ul><li>你不是在问“warmup 要不要”</li><li>而是在问“我希望最终的 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.669ex;" xmlns="http://www.w3.org/2000/svg" width="5.494ex" height="1.669ex" role="img" focusable="false" viewbox="0 -442 2428.4 737.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(389,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(889,0)"/><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(1281,0)"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1781,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2225,0)"/></g></g></g></g></g></svg></mjx-container></span>能有多大、稳定边界在哪，warmup 帮我把边界推到哪里”</li></ul><p>参考：<a class="link" href="https://arxiv.org/abs/2406.09405">Why Warmup theLearning Rate? (arXiv:2406.09405)<i class="fas fa-external-link-alt"></i></a></p><h2 id="power-scheduler对-batch-size-与-token-数不敏感">2024：PowerScheduler——对 batch size 与 token 数不敏感</h2><p>大模型预训练的现实痛点是：你经常会换 batch size、换训练tokens（预算变化），而最优学习率也会跟着漂移。</p><p>Power Scheduler（2024）发现并利用一种 <strong>学习率、batchsize、训练 tokens 的幂律关系</strong>，构建出对 batch/token更“免调”的调度方式，并强调与 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.364ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 603 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D707" d="M58 -216Q44 -216 34 -208T23 -186Q23 -176 96 116T173 414Q186 442 219 442Q231 441 239 435T249 423T251 413Q251 401 220 279T187 142Q185 131 185 107V99Q185 26 252 26Q261 26 270 27T287 31T302 38T315 45T327 55T338 65T348 77T356 88T365 100L372 110L408 253Q444 395 448 404Q461 431 491 431Q504 431 512 424T523 412T525 402L449 84Q448 79 448 68Q448 43 455 35T476 26Q485 27 496 35Q517 55 537 131Q543 151 547 152Q549 153 557 153H561Q580 153 580 144Q580 138 575 117T555 63T523 13Q510 0 491 -8Q483 -10 467 -10Q446 -10 429 -4T402 11T385 29T376 44T374 51L368 45Q362 39 350 30T324 12T288 -4T246 -11Q199 -11 153 12L129 -85Q108 -167 104 -180T92 -202Q76 -216 58 -216Z"/></g></g></g></svg></mjx-container></span>P等参数化结合的可迁移性。</p><p>参考：<a class="link" href="https://arxiv.org/abs/2408.13359">Power Scheduler(arXiv:2408.13359)<i class="fas fa-external-link-alt"></i></a></p><h2 id="用小模型复现大模型不稳定学习率稳定性研究">2023–2024：用“小模型复现大模型不稳定”——学习率稳定性研究</h2><p>大模型训练常见“同样超参，小模型没事，大模型炸了”的现象。Wortsman等工作提出：很多不稳定性其实能在小模型里通过更高学习率复现，从而可以用更低成本研究：</p><ul><li>哪些干预能降低对学习率的敏感性（warmup、weightdecay、参数化等）；</li><li>能否在训练早期通过某些信号预测后续不稳定。</li></ul><p>参考：<a class="link" href="https://arxiv.org/abs/2309.14322">Small-scale proxiesfor large-scale Transformer instabilities (arXiv:2309.14322)<i class="fas fa-external-link-alt"></i></a></p><h2 id="no-more-adam把关键放回学习率尺度">2024：No MoreAdam?——把关键放回“学习率尺度”</h2><p>一条很“反直觉但很有启发”的路线是：也许 Adam的优势很大部分来自“不同参数组的有效学习率尺度被自动调平”。</p><p>2024 的 SGD-SaI 提出在初始化时基于某种信号（例如g-SNR）对不同参数组做学习率缩放，从而用更接近 SGD 的方法获得接近 AdamW的效果，并且显著减少优化器状态的显存占用。</p><p>这对学习率研究的意义是：<strong>学习率不只是一个数，而是一个“与参数尺度/信噪比耦合的系统设计问题”。</strong></p><p>参考：<a class="link" href="https://arxiv.org/abs/2412.11768">No More Adam /SGD-SaI (arXiv:2412.11768)<i class="fas fa-external-link-alt"></i></a></p><h2 id="cosine-vs-wsd-的理论联系凸优化视角">2025：cosine vs WSD的理论联系（凸优化视角）</h2><p>2025 的一条很有意思的观察是：一些大模型训练中的学习率曲线（尤其是 WSD的 cooldown）在形状上和某些凸优化理论界非常接近，并且 cooldown的收益在界里体现为“去掉了对数项”等。</p><p>你不需要完全理解那套界，但你可以记住结论：</p><ul><li>WSD 的 cooldown不是“玄学的最后一脚刹车”，它能在一些理论模型中被解释为更好的收敛项；</li><li>这也提供了在不同 schedule 间迁移 base learning rate 的思路。</li></ul><p>参考：<a class="link" href="https://arxiv.org/abs/2501.18965">Convex theory viewof WSD cooldown (arXiv:2501.18965)<i class="fas fa-external-link-alt"></i></a></p><hr><h1 id="faq最常见的学习率问题小白高频">FAQ：最常见的学习率问题（小白高频）</h1><h2 id="我该用-adamw-还是-sgd">“我该用 AdamW 还是 SGD？”</h2><p>如果你是小白并且目标是“先跑通、稳定产出”：</p><ul><li>默认：AdamW + warmup + cosine/WSD。</li></ul><p>如果你追求更低显存、更强可解释性、或在某些视觉任务上想追极致：</p><ul><li>SGD（通常配动量）仍然很强，但更依赖调参经验。</li></ul><h2 id="loss-一开始就炸怎么办">“loss 一开始就炸怎么办？”</h2><p>按优先级排查（从最有效到次要）：</p><ul><li>把 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="4.289ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 1895.9 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(530,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/></g></g></g></g></g></svg></mjx-container></span>降一个数量级试试；</li><li>增加 warmup（或把 warmup 起点设得更小）；</li><li>打开梯度裁剪；</li><li>检查混合精度（loss scaling）与数值稳定；</li><li>适当增加 weight decay（尤其是大模型）。</li></ul><h2 id="loss-不炸但不怎么降怎么办">“loss 不炸但不怎么降怎么办？”</h2><p>常见原因：</p><ul><li>学习率太小；</li><li>衰减太快（过早进入小学习率阶段）；</li><li>batch 太小导致噪声很大，模型“原地抖动”；</li><li>数据/标签问题（这不是学习率能救的）。</li></ul><p>策略：</p><ul><li>做 LR range test 找上限；</li><li>让中段更长时间保持在较大 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>（WSD 的 stable 部分很适合）。</li></ul><hr><h1 id="一页速查表把怎么选学习率落地">一页速查表（把“怎么选学习率”落地）</h1><h2 id="adamw-常见起手式通用">AdamW 常见起手式（通用）</h2><ul><li><strong>schedule</strong>：warmup + cosine 或 warmup + WSD</li><li><strong>warmup</strong>：1%～5%</li><li><strong>cooldown（若用 WSD）</strong>：10%～20%</li><li><strong>梯度裁剪</strong>：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="16.411ex" height="1.692ex" role="img" focusable="false" viewbox="0 -666 7253.6 748"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(833,0)"/><path data-c="78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z" transform="translate(1333,0)"/><path data-c="5F" d="M0 -62V-25H499V-62H0Z" transform="translate(1861,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(2361,0)"/><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(2917,0)"/><path data-c="72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z" transform="translate(3417,0)"/><path data-c="6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(3809,0)"/></g><g data-mml-node="mo" transform="translate(4919.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(5975.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(778,0)"/></g></g></g></svg></mjx-container></span>（大模型常用）</li></ul><h2 id="你应该关注的-3-个指标比看-loss更直接">你应该关注的 3个指标（比“看 loss”更直接）</h2><ul><li><strong>训练是否接近稳定边界</strong>：是否出现持续的 loss spike /梯度范数爆炸迹象</li><li><strong>有效步长是否过小</strong>：学习太慢、长期平台</li><li><strong>对学习率的敏感性</strong>：轻微改动 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.489ex;" xmlns="http://www.w3.org/2000/svg" width="1.124ex" height="1.489ex" role="img" focusable="false" viewbox="0 -442 497 658"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D702" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q156 442 175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336V326Q503 302 439 53Q381 -182 377 -189Q364 -216 332 -216Q319 -216 310 -208T299 -186Q299 -177 358 57L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container></span>是否导致结果大幅变化（越敏感越说明你在边界附近/系统不稳）</li></ul><h2 id="当你不知道选-cosine-还是-wsd">当你不知道选 cosine 还是 WSD</h2><ul><li>训练长度固定、不会续训：cosine 很稳妥；</li><li>训练长度可能变化、需要续训/多预算对比：优先 WSD；</li><li>想尽量少调 schedule：可以关注 schedule-free / learning-rate-free方向（但要看你代码栈是否方便接入）。</li></ul><hr><h1 id="参考资料按本文提到的关键脉络">参考资料（按本文提到的关键脉络）</h1><ul><li><a class="link" href="https://ai.meta.com/research/publications/learning-rate-free-learning-by-d-adaptation/">LearningRate-Free Learning by D-Adaptation (Meta, 2023)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2405.15682">Schedule-Free AdamW(arXiv:2405.15682)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2406.09405">Why Warmup the LearningRate? (arXiv:2406.09405)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2408.13359">Power Scheduler(arXiv:2408.13359)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2309.14322">Small-scale proxies forlarge-scale Transformer instabilities (arXiv:2309.14322)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2501.18965">Convex theory view of WSDcooldown (arXiv:2501.18965)<i class="fas fa-external-link-alt"></i></a></li><li><a class="link" href="https://arxiv.org/abs/2412.11768">No More Adam / SGD-SaI(arXiv:2412.11768)<i class="fas fa-external-link-alt"></i></a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;学习率（Learning Rate,
LR）是深度学习里&lt;strong&gt;最重要、也最容易“看起来像玄学”的超参数&lt;/strong&gt;。它既像汽车的油门（决定你每一步走多快），也像方向盘的灵敏度（太敏感会蛇形走位甚至翻车，太迟钝又永远到不了目的地）。&lt;/p&gt;
&lt;p&gt;这篇文章会从最简单的二次函数出发，把“学习率为什么会影响稳定性、为什么训练后期要降学习率、为什么
warmup 常见”讲清楚。&lt;/p&gt;</summary>
    
    
    
    
    <category term="LLM" scheme="https://chenk.top/tags/LLM/"/>
    
    <category term="Optimization" scheme="https://chenk.top/tags/Optimization/"/>
    
    <category term="ML-Basics" scheme="https://chenk.top/tags/ML-Basics/"/>
    
    <category term="深度学习" scheme="https://chenk.top/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Linux 磁盘管理</title>
    <link href="https://chenk.top/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-17T16:00:00.000Z</published>
    <updated>2026-01-28T01:07:25.472Z</updated>
    
    <content type="html"><![CDATA[<p>磁盘相关的问题，很多时候不是“记几个命令”就能解决：分区表怎么选、文件系统怎么挂、扩容怎么尽量少停机、删文件为什么空间不立刻回来，背后都有明确的机制约束。本文从热/冷存储与磁盘结构切入，串起RAID 与 LVM 的落地用法、MBR/GPT 分区与<code>fdisk</code>/<code>gdisk</code>的实际操作、格式化与挂载的完整流程，并补上 <code>/dev</code>特殊设备、inode与硬/软链接、文件删除原理这些最容易踩坑但又最“救命”的细节。读完你应该能按步骤把一块新盘从“识别—分区—格式化—挂载—扩容—排障”走通。</p><span id="more"></span><h1 id="一网站存储">一、网站存储</h1><p>数据存储是网站架构的一大重点，关于存储方案我们通常需要考虑硬件角度和软件角度，本文我们只关注硬件角度。</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/20210701123415976-1024x556.png" alt="img"><figcaption aria-hidden="true">img</figcaption></figure><h2 id="存储层的设计">1. 存储层的设计</h2><p><strong>热存储（HotStorage）</strong>：存储需要频繁访问的数据。通常使用SSD（固态硬盘），例如数据库存储。</p><ul><li>SSD 基于 NAND 闪存技术，具有更快的读写速度和更高的耐用性。</li><li>通过电子电荷存储数据，每个单元存储一个或多个比特的数据。</li><li>和顺序读写比起来，固态硬盘的随机读写慢不了多少，随件写入效率略微降低，随机读取能力也就下降一半左右。</li><li>固态硬盘写入数据前要对齐，所以有独特的 <code>trim</code>指令。文件删除以后，操作系统会挑选空余时间自动执行<code>trim</code>，而不是下次使用的时候再对齐，机械硬盘不需要对齐，直接覆盖就行了。所以机械硬盘的数据在没有覆盖之前都是可以恢复了，固态硬盘一般在回收站里面删除以后很快就执行了<code>trim</code> 命令，几乎不能再恢复数据了。</li></ul><p><strong><a class="link" href="https://www.cnblogs.com/cxygg/p/16389505.html">冷存储<i class="fas fa-external-link-alt"></i></a>（ColdStorage）</strong>：用于长期存储访问频率低的数据。可以使用HDD（机械硬盘）或分布式存储系统。</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/4f588e4702ddcda3b22aa8b231cbbc47.png" alt="机械硬盘结构"><figcaption aria-hidden="true">机械硬盘结构</figcaption></figure><ul><li><p>HDD通过磁性盘片和磁头来读取和写入数据，硬盘存储设备和电磁有关因此也被称为磁盘：磁头在盘片上移动，通过磁性变化来写入和读取数据。机械硬盘里有很多张磁盘。</p></li><li><p>数据存储分为多个<strong>扇区</strong>和<strong>轨道</strong>。</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/1435314-20220619000212007-1461023647.webp" alt="img"><figcaption aria-hidden="true">img</figcaption></figure><ul><li><p>一个磁盘里面有一到多个盘片，盘片可以可以单面或者双面的。单面盘片只有一个面有磁头，双面盘片两个面都有磁头。多盘片，双盘面的磁盘，是协同工作的，这时候他们机械臂的位置相同，盘面相对位置恒定，理论上多盘片之间可以相互配合共同读写，多盘片的硬盘，也并不会成倍的提升读写性能，大概只能归结于工艺原因，并不能做到多盘片协同工作。</p></li><li><p>一个扇区模默认大小是512字节，也就是0.5KB。如下图，我们格式化硬盘的时候，可以指定分配单元大小，理论上一个分配单元最小值就是一个扇区。</p><figure><img src="https://img2022.cnblogs.com/blog/1435314/202206/1435314-20220619000532622-448669195.png" alt="img"><figcaption aria-hidden="true">img</figcaption></figure></li><li><p>操作系统的分配单元大小叫做簇（或者块block），一个簇由一到多个连续扇区组成，一个文件只能被连续的存储在一个或者多个簇里面。比如我4K对齐(操作系统指定1个簇由8个扇区构成)，那么我即便有的文件只有1个字节，那么它也会占用4K的存储空间。</p></li><li><p>有时候我们文件显示存储空间是0，这是操作系统优化的结果，太小的文件，占用一个簇太浪费，我们可以公用区域存放，这个文件如果再大一点，或者公共区域放不下了，就会直接分配单独的一个簇存储。</p></li></ul></li><li><p>对机械硬盘而言，转速和缓存是高性能的指标</p><ul><li>常见的是 7200 rpm（转每分钟）+ 64 MB 的缓存配置</li><li>一些需要高负载和大型数据传输的高性能服务器会配置 10000 或 15000 rpm+ 128 MB 甚至更高的缓存</li></ul></li><li><p>磁盘读写过程：</p><ul><li>通过地址确定需要读取的数据所在的磁道，和扇区。</li><li>机械摆臂移动磁头到指定磁道位置（等待机械结构移动）</li><li>等到磁盘扇区转到到磁头位置开始读取（等待机械结构转动）</li><li>如果数数据是在相邻扇区，或者相邻的蔟，那么就能连续的读取，这种叫做顺序读取</li><li>如果所需数据位于不同扇区，不同磁道，那么需要不断移动机械臂，和等待磁盘转动到指定扇区，这种就是随机读写。</li></ul><p>机械硬盘随机读写慢的原因主要就是两次等待机械机构移动到指定位置。摆臂移动时间大概是6-8毫秒，7200转的硬盘一秒钟转120圈，每圈时间8.3毫秒，平均半圈是4毫秒的样子。所以7200转的机械银盘随机读取的平均延时在10多毫秒。机械硬盘顺序读写速度比随机读写快80倍以上，差异巨大。</p></li></ul><p><strong>对象存储</strong>：如 AWS S3、阿里云OSS，用于存储大量不常访问的文件和数据。</p><ul><li>在 Hadoop分布式文件系统（HDFS）中使用对象存储来处理大规模数据。</li></ul><h2 id="存储的数据备份raid磁盘阵列技术">2.存储的数据备份（RAID磁盘阵列技术）</h2><p>使用 <code>raid</code>磁盘阵列技术进行磁盘备份，以保证数据安全性。</p><h3 id="raid-的基本概念">RAID 的基本概念</h3><ul><li><strong>RAID（Redundant Array of IndependentDisks）</strong>：将多个硬盘组合在一起形成一个逻辑单元，以提高数据冗余和/或性能。</li><li><strong>RAID 级别</strong>：<ul><li><strong>RAID0</strong>：数据条带化，分布到多个磁盘上，提高读写性能，但没有冗余，单个磁盘故障将导致数据丢失。</li><li><strong>RAID1</strong>：镜像，数据在两个磁盘上完全复制，提高数据安全性，但存储空间减半。</li><li><strong>RAID5</strong>：条带化+奇偶校验，至少需要三块磁盘，具有数据冗余和较好的性能平衡。</li><li><strong>RAID 6</strong>：类似 RAID5，但使用双重奇偶校验，可以容忍两块磁盘同时故障。</li><li><strong>RAID 10</strong>：结合 RAID 0 和 RAID1，先进行镜像再条带化，提供高性能和冗余，但成本较高。</li></ul></li></ul><h3 id="软件-raid软-raid">软件 RAID（软 RAID）</h3><p>软件 RAID 是由操作系统通过软件实现 RAID 功能，而不是依赖硬件 RAID控制器。常见工具包括 Linux 下的 <code>mdadm</code>。优点是：</p><ul><li>成本低，无需专用硬件。</li><li>灵活性高，可动态调整 RAID 配置。</li></ul><p>对应的缺点是占用 CPU 资源，对系统性能有一定影响（现代 CPU通常能很好地应对）。</p><h3 id="软件-raid-命令实践">软件 RAID 命令实践</h3><ul><li><p><strong>创建 RAID</strong>：例如，创建一个 RAID 1 镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1</span><br></pre></td></tr></table></figure><ul><li><code>/dev/md0</code>：新创建的 RAID 设备</li><li><code>--level=1</code>：指定 RAID 1（镜像）</li><li><code>--raid-devices=2</code>：使用两个磁盘分区</li><li><code>/dev/sda1 /dev/sdb1</code>：参与 RAID 的设备</li></ul></li><li><p><strong>查看 RAID 状态</strong>：使用如下命令检查 RAID设备状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/mdstat</span><br></pre></td></tr></table></figure></li><li><p><strong>管理 RAID</strong>：添加、移除、重建等操作都可以使用<code>mdadm</code> 进行管理。例如：</p><ul><li><p><strong>停止 RAID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --stop /dev/md0</span><br></pre></td></tr></table></figure></li><li><p><strong>移除设备</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm /dev/md0 --fail /dev/sda1 --remove /dev/sda1</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>配置文件</strong>：将 RAID 配置信息写入配置文件（如<code>/etc/mdadm.conf</code>），以便系统启动时自动组装 RAID 设备：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --detail --scan &gt;&gt; /etc/mdadm.conf</span><br></pre></td></tr></table></figure></li></ul><h2 id="存储的数据扩容">3. 存储的数据扩容</h2><p>磁盘的数据满了怎么办，需要涉及存储的设备扩容</p><ol type="1"><li>保证数据库数据完整的情况下，将用户数据迁移到另一个硬盘中</li><li>考虑到用户数据会不断增长，新磁盘采用 <code>lvm</code>逻辑卷管理，方便日后动态扩容</li></ol><h3 id="扩容业务整体流程">扩容业务整体流程</h3><ol type="1"><li>需要一块新硬盘（虚拟机可添加）</li><li>新硬盘需要做 <code>lvm</code> 管理</li><li>数据库迁移（夜间停机维护，凌晨 2 点）<ul><li>停止数据库监控</li><li>停止前端（关闭前端数据入口，比如停用博客发表功能）：<code>systemctl stop apache</code></li><li>停止后端（可选）</li><li>停止 MySQL 数据库（防止数据还在写入，或者锁表）</li><li>备份数据库（全备）</li><li>迁移数据到新硬盘（使用 <code>rsync</code>【比 <code>cp</code>命令更强大】），新硬盘已经做好了 <code>lvm</code>，且挂载好了</li><li>启动数据库</li><li>启动前端入口</li><li>测试数据读写</li><li>博客功能重新恢复上线</li><li>开启数据库监控</li></ul></li></ol><h3 id="lvm-技术"><code>lvm</code> 技术</h3><p>LVM（逻辑卷管理器，Logical VolumeManager）是一种将物理存储设备抽象为逻辑存储单元的技术，允许系统管理员更加灵活地管理存储设备。与传统的分区方式（如直接将磁盘划分为固定大小的分区）不同，LVM提供了更高的灵活性，能够在系统运行时动态地调整存储空间。</p><p>LVM 技术包括以下几个核心概念：</p><p><strong>物理卷（Physical Volume, PV）</strong></p><p>物理卷是 LVM 中的最底层存储单元，通常是磁盘或者磁盘分区。LVM会将一个或多个物理卷组织在一起，形成一个“卷组”（VolumeGroup，VG）。物理卷不一定是整个磁盘，可以是磁盘的一个分区，也可以是整个磁盘。</p><p>创建物理卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/sdb1  <span class="comment"># 创建一个物理卷</span></span><br></pre></td></tr></table></figure><p><strong>卷组（Volume Group, VG）</strong></p><p>卷组是由多个物理卷组成的逻辑容器。它可以将多个物理卷中的存储空间汇聚到一起，形成一个大的池，供逻辑卷使用。一个卷组可以包含多个物理卷，也可以只有一个物理卷。</p><p>创建卷组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgcreate my_volume_group /dev/sdb1 /dev/sdc1  <span class="comment"># 创建一个卷组，包含 /dev/sdb1 和 /dev/sdc1</span></span><br></pre></td></tr></table></figure><p><strong>逻辑卷（Logical Volume, LV）</strong></p><p>逻辑卷是实际存储数据的地方，它类似于传统分区。逻辑卷是从卷组中分配的存储空间，可以根据需要进行扩展或缩减。LVM提供了动态创建、删除和调整逻辑卷大小的能力。</p><p>创建逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 10G -n my_logical_volume my_volume_group  <span class="comment"># 创建一个大小为10GB的逻辑卷</span></span><br></pre></td></tr></table></figure><p><strong>逻辑卷的扩展与收缩</strong></p><p>LVM允许在逻辑卷中增加或减少存储空间。对于增加存储空间，可以将新的物理卷加入到卷组中，并扩展逻辑卷的大小；对于减少存储空间，需要先对文件系统进行缩减，确保数据的安全。</p><p>扩展逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvextend -L +5G /dev/my_volume_group/my_logical_volume  <span class="comment"># 将逻辑卷扩展5GB</span></span><br><span class="line">resize2fs /dev/my_volume_group/my_logical_volume  <span class="comment"># 调整文件系统的大小</span></span><br></pre></td></tr></table></figure><p>缩小逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e2fsck -f /dev/my_volume_group/my_logical_volume  <span class="comment"># 检查文件系统</span></span><br><span class="line">resize2fs /dev/my_volume_group/my_logical_volume 5G  <span class="comment"># 调整文件系统大小到5GB</span></span><br><span class="line">lvreduce -L 5G /dev/my_volume_group/my_logical_volume  <span class="comment"># 缩小逻辑卷</span></span><br></pre></td></tr></table></figure><p><strong>快照（Snapshot）</strong></p><p>LVM还支持创建快照。快照是某个逻辑卷的时间点副本，可以用于数据备份或在对逻辑卷进行修改之前进行保护。快照是增量的，仅记录自创建快照以来的变化。</p><p>创建和删除快照：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 1G -s -n my_snapshot /dev/my_volume_group/my_logical_volume  <span class="comment"># 创建快照</span></span><br><span class="line">lvremove /dev/my_volume_group/my_snapshot  <span class="comment"># 删除快照</span></span><br></pre></td></tr></table></figure><p><strong>LVM 的优点</strong></p><ul><li><strong>灵活性</strong>：可以动态增加、缩小卷的大小，无需重新分区和格式化磁盘。</li><li><strong>卷扩展性</strong>：可以将多个物理卷合并为一个卷组，增加存储池的空间。</li><li><strong>数据保护</strong>：通过快照功能，可以在修改数据之前创建数据副本，保护数据不被误删。</li><li><strong>性能优化</strong>：LVM支持多种策略，如镜像（Mirroring）、条带化（Striping）等，来提高性能或容错性。</li></ul><p><strong>LVM 的常用命令</strong></p><p>查看物理卷、卷组、逻辑卷的状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pvs  <span class="comment"># 查看物理卷</span></span><br><span class="line">vgs  <span class="comment"># 查看卷组</span></span><br><span class="line">lvs  <span class="comment"># 查看逻辑卷</span></span><br></pre></td></tr></table></figure><p>删除物理卷、卷组、逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lvremove /dev/my_volume_group/my_logical_volume  <span class="comment"># 删除逻辑卷</span></span><br><span class="line">vgremove my_volume_group  <span class="comment"># 删除卷组</span></span><br><span class="line">pvremove /dev/sdb1  <span class="comment"># 删除物理卷</span></span><br></pre></td></tr></table></figure><p>将物理卷加入卷组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgextend my_volume_group /dev/sdd1  <span class="comment"># 向卷组添加物理卷</span></span><br></pre></td></tr></table></figure><p>移除物理卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgreduce my_volume_group /dev/sdb1  <span class="comment"># 从卷组中移除物理卷</span></span><br></pre></td></tr></table></figure><hr><p>举个例子，在 Mac系统上，<strong>硬盘空间的增加</strong>会被自动识别为新的分区或逻辑卷（LVM），而不需要手动进行分区。</p><p>我们可以首先进行硬盘空间分配来验证之（注意这里的硬盘空间分配了之后，主机的硬盘空间不会立刻少这么多，而是慢慢减少直到用满了这新增的空间）。</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250214204528744.png" alt="image-20250214204528744"><figcaption aria-hidden="true">image-20250214204528744</figcaption></figure><p>然后我们查看 <code>lablk</code>：</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250218010311167.png" alt="image-20250218010311167"><figcaption aria-hidden="true">image-20250218010311167</figcaption></figure><p><strong>nvme0n1 硬盘</strong>是我的物理硬盘，大小为50GB。这个硬盘上有三个分区：</p><ul><li>/dev/nvme0n1p1：EFI 系统分区，大小 953MB。</li><li>/dev/nvme0n1p2：启动分区，大小 1.8GB。</li><li>/dev/nvme0n1p3：剩余的分区，大小 45.3GB。<ul><li>在 /dev/nvme0n1p3 上，系统使用了 LVM，具体来说是<strong>ubuntu--vg-ubuntu--lv</strong> 这个逻辑卷，大小为 45.3GB，挂载在/（根目录）下。</li><li>当我们增加硬盘空间时，<strong>LVM</strong>（逻辑卷管理）在已经有的物理分区（如/dev/nvme0n1p3）上自动扩展了空间。因此我们无需手动分区，LVM可以动态调整卷的大小以适应新加入的空间。</li><li><strong>LVM</strong>使得我们可以动态管理存储，不需要像传统的分区方式那样手动分区。</li></ul></li></ul><p>进一步地，我们可以通过 lvdisplay命令查看逻辑卷的详细信息，确认新的硬盘空间是否已正确分配给逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lvdisplay</span></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ubuntu-vg/ubuntu-lv</span><br><span class="line">  LV Name                ubuntu-lv</span><br><span class="line">  VG Name                ubuntu-vg</span><br><span class="line">  LV UUID                ZtYUOm-9g6w-j6i3-fnJu-Bqly-BtYQ-s3dRWH</span><br><span class="line">  LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line">  LV Creation host, time ubuntu-server, 2025-01-12 03:55:17 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  <span class="comment"># open                 1</span></span><br><span class="line">  LV Size                &lt;45.32 GiB</span><br><span class="line">  Current LE             11601</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently <span class="built_in">set</span> to     256</span><br><span class="line">  Block device           252:0</span><br></pre></td></tr></table></figure><h1 id="二磁盘管理业务背景与流程">二、磁盘管理业务背景与流程</h1><p>磁盘管理确保硬件存储的健康和可靠性。磁盘的使用涉及到磁盘健康监控、备份、恢复等多个方面。我们可以与Windows 的磁盘管理做一个对比，在 Windows系统中，磁盘的管理包括分区、格式化、磁盘检查等。</p><ul><li><strong>磁盘分区</strong>：可以通过“磁盘管理”工具创建、删除、格式化磁盘分区。</li><li><strong>磁盘碎片整理</strong>：Windows 提供磁盘碎片整理工具。</li><li><strong>查看磁盘信息：</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">diskpart  <span class="comment"># 启动磁盘管理工具</span></span><br><span class="line">list disk  <span class="comment"># 列出所有磁盘</span></span><br></pre></td></tr></table></figure><p>在 Linux 下，具体的内容为：</p><ol type="1"><li><p><strong>硬盘健康检查</strong>：定期运行 <code>smartctl</code>检查硬盘状态，提前发现潜在问题，如坏道、读写错误等。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smartctl -a /dev/sda  <span class="comment"># 查看硬盘健康状态</span></span><br><span class="line">   <span class="built_in">df</span> -h  <span class="comment"># 显示磁盘空间使用情况</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250213152728125.png" alt="image-20250213152728125"><figcaption aria-hidden="true">image-20250213152728125</figcaption></figure></li><li><p><strong>磁盘碎片整理</strong>：对于机械硬盘（HDD），我们可以使用工具如<code>bleachbit</code> 或 <code>ncdu</code>进行磁盘清理，释放磁盘空间。并使用 <code>e4defrag</code>碎片整理工具进行整理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e4defrag /dev/sda  <span class="comment"># 对 /dev/sda 分区进行碎片整理</span></span><br></pre></td></tr></table></figure></li><li><p><strong>数据备份与恢复</strong>：使用工具如 <code>rsync</code> 或<code>tar</code> 进行定期备份。</p></li></ol><h1 id="三磁盘使用流程">三、磁盘使用流程</h1><p>磁盘在计算机中是用来存储数据的设备，磁盘的使用包括挂载、分区以及对文件系统的访问。Linux系统中的磁盘挂载是磁盘和文件系统连接的过程，Linux系统通过挂载将磁盘分区与文件系统连接，使得用户可以通过路径访问磁盘上的文件。</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/3baffb6c16dc43cc92b87baad5700594.png" alt="关于Linux中卷/分区等知识的一些总结-云社区-华为云"><figcaption aria-hidden="true">关于Linux中卷/分区等知识的一些总结-云社区-华为云</figcaption></figure><p>我们可以将磁盘从被识别到可以使用的过程与实际生活中房子类比：</p><ol type="1"><li><strong>磁盘准备存储数据</strong>：类比为人盖房子。磁盘需要在计算机系统中准备好，才能进行数据存储。</li><li><strong>磁盘分区</strong>：类比为房子改好后需要隔断。磁盘需要分区，才能将磁盘空间划分为不同的区域（例如：卧室、厨房、卫生间等），不同区域用于存储不同类型的数据。</li><li><strong>磁盘格式化与创建文件系统</strong>：类比为房子装修。分区后，磁盘还需要格式化并创建文件系统，不同的文件系统有不同的功能和用途，就像房子的装修风格（欧式、中式等）决定了居住体验。</li><li><strong>磁盘挂载到文件夹</strong>：类比为安装门窗，确保进出。格式化并创建文件系统后，磁盘需要挂载到系统的文件夹中，才能通过操作系统进行数据存储和读取，就像房子需要安装门窗才能与外界沟通。</li></ol><h2 id="磁盘分区">1. 磁盘分区</h2><p>分区方案指的是磁盘布局的特定基础结构、分区的实际排列方式、功能以及限制。</p><table><colgroup><col style="width: 15%"><col style="width: 42%"><col style="width: 41%"></colgroup><thead><tr><th>特性</th><th>MBR（主引导记录）</th><th>GPT（GUID 分区表）</th></tr></thead><tbody><tr><td><strong>最大存储空间</strong></td><td>最大支持 2TB</td><td>支持大于 2TB，最大支持 9.4ZB（远超当前硬盘技术）</td></tr><tr><td><strong>最大分区数量</strong></td><td>最多支持 4 个主分区，或 3 个主分区 + 1 个扩展分区</td><td>最多支持 128 个主分区</td></tr><tr><td><strong>分区表大小</strong></td><td>固定为 512 字节</td><td>可自定义，支持更大规模的分区表</td></tr><tr><td><strong>冗余与备份</strong></td><td>无冗余备份，一旦损坏可能导致数据丢失</td><td>提供冗余备份，分区表存储在磁盘的开始和结尾部分</td></tr><tr><td><strong>支持的引导模式</strong></td><td>传统 BIOS 引导模式</td><td>与 UEFI 配合使用，支持更现代的引导方式</td></tr><tr><td><strong>操作系统兼容性</strong></td><td>支持所有 32 位和 64 位 Windows 操作系统</td><td>支持大多数 Windows 版本，但需要 UEFI 支持</td></tr><tr><td><strong>使用场景</strong></td><td>适用于小容量磁盘（2TB 以下）和老旧系统</td><td>适用于大容量磁盘（2TB 以上）和现代系统</td></tr><tr><td><strong>系统安装和维护</strong></td><td>适合传统的磁盘管理方式</td><td>支持多重操作系统安装和复杂的硬件配置</td></tr></tbody></table><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/Difference-between-MBR-and-GPT.png" alt="Difference between MBR and GPTMustBeGeek"><figcaption aria-hidden="true">Difference between MBR andGPTMustBeGeek</figcaption></figure><h3 id="mbr">MBR</h3><p>MBR （master boot record - 主引导记录）支持最多 4 个主分区（3个主分区+1 个扩展分区），最大支持 2 TB 的磁盘。</p><figure><img src="https://i-blog.csdnimg.cn/blog_migrate/d17d97002fe76459d24b269d44c4c9e8.png" alt="MBR、主引导扇区，主分区、扩展分区、逻辑分区，活动分区、引导分区、系统分区、启动分区_活动分区和引导分区-CSDN博客"><figcaption aria-hidden="true">MBR、主引导扇区，主分区、扩展分区、逻辑分区，活动分区、引导分区、系统分区、启动分区_活动分区和引导分区-CSDN博客</figcaption></figure><ul><li>简单来说，MBR是磁盘里的第一个扇区，作用是告诉操作系统怎么加载磁盘顺序，如何开机</li><li>优点是兼容性好，缺点是不支持管理大硬盘结构。对于大于 2TB 的硬盘，MBR会无法识别，导致硬盘空间浪费。这是因为 MBR 使用 32位寻址方式，限制了可寻址的空间。</li><li>主引导扇区位于整个磁盘的 0 磁头 0 柱头 1 扇面，包括硬盘主引导记录MBR 和分区表 DPT（Disk PartitionTable）。主引导记录用于检查分区表是否正确以及哪个分区为引导分区，也就是操作系统引导扇区调入内存加以执行。</li></ul><p>从原理上说：</p><ol type="1"><li>MBR分区方案使用硬盘的第一个物理扇区中的 64个字节作为分区表的空间保存硬盘分区信息，每个分区的信息要占 16个字节。所以，MBR分区表最多只能保存4个分区的分区信息。</li><li>MBR分区方案中，有三种类型的分区，主分区、扩展分区和逻辑分区。扩展分区与逻辑分区是为了突破分区表中只能保存4 个分区的限制而出现的</li><li>MBR分区表中保存的分区信息都是主分区与扩展分区的分区信息，扩展分区不能直接使用，需要在扩展分区内划分一个或多个逻辑分区后才能使用，逻辑分区的分区信息保存在扩展分区内，而不是保存在MBR 分区表内，这样就可以突破 MBR 分区表只能保存 4 个分区的限制。</li><li>16个字节的分区信息保存有分区活动状态标志、文件系统标识、起止柱面号、磁头号、扇区号、起始扇区位置（4个字节）、分区总扇区数目（4个字节）等内容。这里最重要的是：分区的起始扇区位置与分区的总扇区数，都是用4 个字节表示的。一般每个廓区的容量是 512 字节，4个字节的扇区能表示的最大容量是 2 TB，由此可知，在 MBR分区表中，分区的起始位置不能大于 2 TB，分区的最大容量，也不能大于 2TB，所以，对 2 TB 以上容量的物理硬盘，不适合使用MBR分区方案。</li></ol><h3 id="gpt">GPT</h3><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/gpt-partition.png" alt="2.6. GUID 分区表| Red Hat Product Documentation"><figcaption aria-hidden="true">2.6. GUID 分区表| Red Hat ProductDocumentation</figcaption></figure><p>GPT（GUID 分区表）可以给超过 2 TB 的硬盘使用，支持更多分区（最多 128个），且没有大小限制。GPT 使用 64 位寻址方式，支持最大9.4ZB（zettabytes）的硬盘空间，远超当前硬盘技术的需求。</p><p><strong>新购电脑的主板类型</strong>：</p><ul><li>如果电脑使用传统的 <strong>BIOS</strong> 主板，建议使用<strong>MBR</strong> 格式。</li><li>如果电脑使用现代的 <strong>UEFI</strong> 主板，建议使用<strong>GPT</strong> 格式。UEFI 模式可以更好地支持GPT，提供更快速、更安全的启动过程。</li></ul><p><strong>重装操作系统时的兼容性</strong>：</p><ul><li>在重装操作系统前，了解所安装的操作系统版本是否支持 MBR 或者 UEFI模式（即 GPT 格式）。大多数操作系统，特别是 Windows 7及以后的版本，都支持 GPT 格式，但老旧版本的 Windows（如 XP）可能不支持GPT。</li><li><strong>注意</strong>：虽然 MBR格式支持大部分操作系统版本，但并非所有 Windows 版本都兼容 GPT格式。例如，Windows XP 不支持 GPT，而 Windows 10 和 Windows 11则完全支持 GPT 格式，尤其是在 UEFI 启动模式下。</li></ul><p><strong>磁盘类型选择</strong>：</p><ul><li>对于传统硬盘（HDD）和容量较小（2TB 以下）的硬盘，使用 MBR可以满足基本需求。</li><li>对于大容量硬盘（大于2TB），SSD，以及希望获得更高可靠性和灵活性的用户，使用 GPT是更优的选择。</li></ul><p><strong>系统安装和维护</strong>：</p><ul><li>如果计划使用 RAID、加密、或者多重操作系统的安装，GPT格式会提供更多的优势，尤其是在支持 UEFI 的系统上。</li><li>由于 GPT格式支持更多的分区，它适合多重操作系统的安装或大型磁盘的管理。</li></ul><h3 id="fdisk-和-gdisk"><code>fdisk</code> 和 <code>gdisk</code></h3><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221115341740.png" alt="image-20250221115341740"><figcaption aria-hidden="true">image-20250221115341740</figcaption></figure><p><code>fdisk</code> 是管理 MBR分区表的命令行工具，常用来创建、删除和修改分区。常见操作是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新分区</span></span><br><span class="line">fdisk /dev/sda  <span class="comment"># 对 /dev/sda 硬盘进行操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前分区</span></span><br><span class="line">fdisk -l  <span class="comment"># 列出所有磁盘和分区</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250218233923991.png" alt="image-20250218233923991"><figcaption aria-hidden="true">image-20250218233923991</figcaption></figure><p>我的系统显示是 <code>GPT</code> 类型，因此不支持 <code>fdisk</code>分区，需要用到 <code>gdisk</code>。<code>gdisk</code> 是一个用于 GPT分区表的工具，适用于支持 UEFI 启动的系统。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新分区</span></span><br><span class="line">gdisk /dev/sda  <span class="comment"># 对 /dev/sda 硬盘进行 GPT 分区操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前分区</span></span><br><span class="line">gdisk -l /dev/sda  <span class="comment"># 列出 GPT 分区表</span></span><br></pre></td></tr></table></figure><p>要将分区类型做修改，可以参考如下操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mbr ----&gt; gpt</span></span><br><span class="line">parted /dev/sdc1</span><br><span class="line">mktable gpt</span><br><span class="line"></span><br><span class="line"><span class="comment"># gpt -----&gt; mbr</span></span><br><span class="line">parted /dev/sdc1</span><br><span class="line">mktable msdos</span><br></pre></td></tr></table></figure><h3 id="硬盘接口与命名规则">硬盘接口与命名规则</h3><p>在 Linux 系统中，磁盘设备的命名规则通常采用 <code>/dev/sdX</code> 或<code>/dev/nvmeX</code> 的格式。</p><p><strong>常见命名规则：</strong></p><ul><li><strong>/dev/sda</strong>：第一个 SATA 硬盘</li><li><strong>/dev/nvme0n1</strong>：第一个 NVMe 固态硬盘</li><li><strong>/dev/sr0</strong>：光盘驱动器</li></ul><p>更具体一点的命名规则其实得追溯到硬盘接口</p><p>硬盘接口主要分为以下几种：</p><ul><li><strong>SATA</strong>：常见的消费级接口，速度适中，广泛使用。</li><li><strong>SAS</strong>：企业级接口，速度较快且稳定性好，常用于服务器。SAS比 SATA 多了一个金手指。</li><li><strong>NVMe</strong>：最现代的存储接口，专为固态硬盘设计，提供超高速数据传输。</li><li><strong>PCIe</strong>：不仅适用于硬盘，还用于显卡等高性能设备，是一个高速的通用接口。</li><li><strong>IDE</strong>：老旧的接口，现已几乎完全被 SATA 替代。</li><li><strong>U.2 和 M.2</strong>：适用于现代高性能固态硬盘，M.2更适合笔记本，U.2 多用于企业级 SSD。</li></ul><figure><img src="https://picx.zhimg.com/80/v2-0b265dff6192f6bbeef41084d8e55da3.png" alt="固态硬盘接口有哪几种如何选择合适的SSD接口-墨铺"><figcaption aria-hidden="true">固态硬盘接口有哪几种如何选择合适的SSD接口-墨铺</figcaption></figure><table><colgroup><col style="width: 27%"><col style="width: 22%"><col style="width: 31%"><col style="width: 18%"></colgroup><thead><tr><th>接口类型</th><th>数据传输速度</th><th>主要特点</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>SATA (Serial ATA)</strong></td><td>最高 6Gb/s</td><td>- 最常见的硬盘接口，适用于台式机和笔记本<br>-适合机械硬盘和一些固态硬盘</td><td>适用于大多数消费级硬盘，兼容性好</td></tr><tr><td><strong>SAS (Serial Attached SCSI)</strong></td><td>最高 12Gb/s</td><td>- 专为企业级存储设计，支持多设备连接<br>-提供更高的稳定性和可靠性</td><td>企业级存储，服务器，数据中心</td></tr><tr><td><strong>NVMe (Non-Volatile Memory Express)</strong></td><td>最高 32Gb/s</td><td>- 基于 PCIe，总线速度更快<br>- 主要用于固态硬盘，低延迟</td><td>高性能计算、大型数据应用、游戏</td></tr><tr><td><strong>PCIe (Peripheral Component InterconnectExpress)</strong></td><td>取决于版本，最大可达 64Gb/s（PCIe 4.0 x16）</td><td>- 高速数据传输接口，用于显卡、存储设备等<br>-非常适合高性能存储设备</td><td>高端工作站、服务器、快速 SSD 存储</td></tr><tr><td><strong>IDE (Integrated Drive Electronics)</strong></td><td>最高 133MB/s</td><td>- 较老的硬盘接口，速度较慢<br>- 现已被 SATA 取代</td><td>主要用于老旧设备，不推荐用于现代系统</td></tr><tr><td><strong>U.2 (previously SFF-8639)</strong></td><td>最高 32Gb/s</td><td>- 连接方式类似于 SATA，但基于 PCIe 协议<br>-用于高性能企业级固态硬盘</td><td>企业级 SSD，数据中心、高端服务器</td></tr><tr><td><strong>M.2</strong></td><td>最高 32Gb/s (取决于协议，如 SATA 或 PCIe)</td><td>- 小型接口，用于笔记本、主板上<br>- 支持 SATA 和 NVMe 协议</td><td>笔记本电脑、主板上的固态硬盘</td></tr></tbody></table><p>硬盘在不同操作系统和不同接口类型中有不同的命名规则，主要依赖于硬盘的接口类型、顺序以及分区情况。以下是一些常见的命名规则和详细说明。</p><table><colgroup><col style="width: 11%"><col style="width: 44%"><col style="width: 44%"></colgroup><thead><tr><th>操作系统</th><th>硬盘命名规则</th><th>描述</th></tr></thead><tbody><tr><td><strong>Linux (RHEL)</strong></td><td><code>/dev/hda</code>, <code>/dev/sda</code></td><td>- <strong>/dev/hda</strong>：IDE 接口硬盘（早期版本）<br>-<strong>/dev/sda</strong>：SATA 或 SCSI 接口硬盘</td></tr><tr><td><strong>IDE 接口</strong></td><td><code>/dev/hda</code></td><td>IDE 接口的硬盘，较旧的命名方式</td></tr><tr><td><strong>SATA 接口</strong></td><td><code>/dev/sda</code>, <code>/dev/sdb</code></td><td>SATA 接口硬盘命名规则，<code>a</code> 为第一块硬盘，<code>b</code>为第二块硬盘</td></tr><tr><td><strong>SCSI 接口</strong></td><td><code>/dev/sda</code>, <code>/dev/sdb</code></td><td>SCSI 接口硬盘命名，类似 SATA，但在服务器环境中常见</td></tr><tr><td><strong>多块硬盘</strong></td><td><code>/dev/sda1</code>, <code>/dev/sdb1</code></td><td>多块硬盘时，根据硬盘顺序命名，如第一块硬盘为<code>/dev/sda</code>，第二块为<code>/dev/sdb</code>，每个硬盘的分区由数字表示，<code>/dev/sda1</code>表示第一块硬盘的第一个分区</td></tr><tr><td>惠普服务器硬盘</td><td><code>/dev/cciss/c0d0</code>,<br><code>/dev/cciss/c0d0p1</code>,<br><code>/dev/cciss/c0d0p2</code></td><td></td></tr><tr><td>虚拟硬盘</td><td><code>/dev/vd</code></td><td>阿里云服务器等可能会用</td></tr></tbody></table><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250214114911032.png" alt="image-20250214114911032"><figcaption aria-hidden="true">image-20250214114911032</figcaption></figure><p>总结来说：</p><ul><li><strong>硬盘命名</strong>：硬盘的名字通常由接口类型（如SATA、SCSI）、硬盘的顺序（<code>a</code>, <code>b</code>, <code>c</code>等）以及分区编号组成。<ul><li><code>/dev/sda</code>：第一块硬盘。</li><li><code>/dev/sdb</code>：第二块硬盘。</li><li><code>/dev/sdc</code>：第三块硬盘。</li><li>以此类推，字母递增。</li></ul></li><li><strong>分区命名</strong>：每个硬盘上的分区通过数字表示：<ul><li><code>/dev/sda1</code>：第一块硬盘的第一个分区。</li><li><code>/dev/sda2</code>：第一块硬盘的第二个分区。</li><li><code>/dev/sda3</code>：第一块硬盘的第三个分区。</li><li><code>/dev/sda4</code>：第一块硬盘的第四个分区。</li></ul></li></ul><blockquote><p>虚拟硬盘格式：</p><table><colgroup><col style="width: 10%"><col style="width: 66%"><col style="width: 23%"></colgroup><thead><tr><th>格式</th><th>描述</th><th>主要应用</th></tr></thead><tbody><tr><td><strong>VMDK</strong></td><td>VMware 使用的虚拟硬盘格式。它能够模拟物理硬盘的特性，用于 VMware虚拟机中。</td><td>VMware 虚拟化平台</td></tr><tr><td><strong>VHD</strong></td><td>Microsoft 的虚拟硬盘格式，支持微软 Hyper-V 虚拟化平台。</td><td>Hyper-V 虚拟化平台</td></tr><tr><td><strong>VHDX</strong></td><td>VHD 的增强版本，支持更大的虚拟硬盘和更高的可靠性。</td><td>Hyper-V 虚拟化平台</td></tr><tr><td><strong>QCOW2</strong></td><td>QEMU 的虚拟硬盘格式，支持快照和压缩，适用于 KVM 和 QEMU虚拟机。</td><td>QEMU/KVM 虚拟化平台</td></tr><tr><td><strong>VDI</strong></td><td>VirtualBox 使用的虚拟硬盘格式。</td><td>VirtualBox 虚拟化平台</td></tr></tbody></table></blockquote><p>在 Windows 中，硬盘分区命名类似： - <strong>C:</strong>代表硬盘的第一个分区（通常是操作系统分区）。 - <strong>D:</strong>代表第二个分区。 - <strong>E:</strong> 代表第三个分区。 -<strong>F:</strong> 代表第四个分区。</p><p>这和 Linux 中的硬盘命名规则 <code>/dev/sda1</code>,<code>/dev/sda2</code> 等相对应。</p><h2 id="格式化文件系统">2. 格式化文件系统</h2><p>常见的文件系统有 EXT4、XFS 和 NTFS等，可以对分区在格式化的时候进行选择：</p><ul><li><strong>EXT4</strong>：Linux常用的文件系统，支持大文件和较高的性能。</li><li><strong>XFS</strong>：高性能文件系统，常用于大型数据库和大规模存储。</li><li><strong>NTFS</strong>：Windows操作系统的标准文件系统，支持文件压缩、加密等功能。</li><li><strong>ExFAT</strong>：MacOS下的文件系统，在MacOS和Windows之间都可以读写</li></ul><table><colgroup><col style="width: 5%"><col style="width: 21%"><col style="width: 7%"><col style="width: 26%"><col style="width: 39%"></colgroup><thead><tr><th>文件系统</th><th>最大分区</th><th>最大文件</th><th>支持的操作系统</th><th>备注</th></tr></thead><tbody><tr><td>FAT32</td><td>128GB</td><td>4GB</td><td>Windows, Linux, Mac, 其他</td><td>适用于U盘和老旧设备，不支持大文件和大分区</td></tr><tr><td>NTFS</td><td>2TB</td><td>2TB</td><td>Windows, Linux (通过第三方软件支持)</td><td>常用于Windows操作系统，支持较大的文件和分区</td></tr><tr><td>FAT16</td><td>2GB</td><td>2GB</td><td>Windows, Linux, 其他</td><td>较老的文件系统，适合小容量设备，常见于早期的Windows版本</td></tr><tr><td>HPFS</td><td>2TB</td><td>2GB</td><td>OS/2</td><td>主要用于OS/2系统，适合较大的分区和文件</td></tr><tr><td>EXT2</td><td>4TB</td><td>2GB</td><td>Linux</td><td>早期Linux的标准文件系统，支持大文件，但没有日志功能</td></tr><tr><td>EXT3</td><td>4TB</td><td>2GB</td><td>Linux</td><td>EXT2的升级版，加入了日志功能，提高了可靠性</td></tr><tr><td>JFS</td><td>4PB</td><td>4PB</td><td>AIX</td><td>高性能文件系统，常用于大型企业级服务器，支持极大分区和文件大小</td></tr><tr><td>XFS</td><td>9EB（2^63）</td><td>9EB（2^63）</td><td>IRIX, Linux</td><td>64位文件系统，支持非常大的分区和文件，常用于高性能和大数据场景</td></tr><tr><td>exFAT</td><td>无限制（但实际应用中通常为256TB）</td><td>16EB</td><td>Windows, Mac, Linux (通过第三方软件支持)</td><td>适合闪存和移动存储设备，克服了FAT32的文件大小限制，不适合磁盘存储</td></tr></tbody></table><p>CentOS 4/5/6 都采用 Ext 2/3/4 文件系统，到了 CentOS 7 采用了 XFS系统，因为 CentOS 7 是容器的时代，docker不支持原来的文件系统。但都支持日志系统，日志系统指的是不会因为突然断电造成磁盘数据损坏，能够通过日志恢复磁盘文件。</p><p>Windows 10 使用NTFS，支持加密、压缩、权限控制等等，且还支持日志保持数据一致性，主流硬盘都是NTFS，专门给闪存使用的 ExFAT 属于是 FAT32 和 NTFS 的折中，同时支持Windows 和 Mac。</p><p>不同的文件系统区别在于</p><ul><li>兼容性：不同系统平台不一定识别，可能无法进行读写操作。例如 Windows上可能无法读取 XFS 文件系统的 U 盘；</li><li>容量大小：不同的文件系统对分区容量的支持以及文件数量及单个文件的容量支持有区别。例如以前的Windows 机械硬盘使用 FAT32 文件系统，该文件系统不支持单个文件超过4G。</li></ul><p>可以通过 <code>mkfs</code> 然后 TAB查看当前支持什么操作系统（实际上这个是进行分区文件系统格式化的命令）：</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221234934355.png" alt="image-20250221234934355"><figcaption aria-hidden="true">image-20250221234934355</figcaption></figure><p>以 <code>mkfs.xfs</code> 为例：</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221235819691.png" alt="image-20250221235819691"><figcaption aria-hidden="true">image-20250221235819691</figcaption></figure><h2 id="挂载目录到分区">3. 挂载目录到分区</h2><h4 id="什么是挂载mount">什么是挂载（Mount）？</h4><p>想象你的电脑是一个大房子，房子里有很多房间（文件夹），比如<code>/home</code>（你的卧室）、<code>/etc</code>（工具箱）等。但房子里原本没有连接外部设备（比如U盘、硬盘、光盘）。<strong>挂载</strong>就像是在墙上开一扇门，把外部设备（比如U盘）连接到房子的某个房间（比如<code>/mnt/usb</code>），这样你就能通过这个房间访问外部设备的内容。</p><ul><li><strong>设备</strong>：U盘、硬盘、光盘等（物理存储介质）。</li><li><strong>挂载点</strong>：房子里的一扇门（比如 <code>/mnt/usb</code>这个空文件夹）。</li><li><strong>挂载操作</strong>：把设备通过这扇门连接到房子。</li></ul><h4 id="挂载的基本操作"><strong>挂载的基本操作</strong></h4><p>假设你插入一个U盘，系统识别它为<code>/dev/sdb1</code>（设备名可能不同）。你要把它挂载到<code>/mnt/usb</code> 这个空文件夹：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb1 /mnt/usb</span><br></pre></td></tr></table></figure><p>其结果就是我们进入 <code>/mnt/usb</code>就能看到U盘里的文件。但要注意，当我们挂载后，<code>/mnt/usb</code>不再是普通文件夹，而是U盘的“入口”。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo umount /mnt/usb</span><br></pre></td></tr></table></figure><p>卸载后，<code>/mnt/usb</code>恢复成普通空文件夹，U盘可以安全拔出。</p><h4 id="挂载后新建的文件在哪"><strong>挂载后新建的文件在哪？</strong></h4><p><strong>场景1：挂载后创建文件</strong></p><ol type="1"><li>挂载U盘到 <code>/mnt/usb</code>。</li><li>在 <code>/mnt/usb</code> 新建文件 <code>test.txt</code>。</li><li>卸载U盘。</li></ol><p><strong>问题</strong>：<code>test.txt</code> 存在哪里？<strong>答案</strong>：文件实际保存在U盘中！卸载后，文件依然在U盘里，下次挂载还能看到。</p><p><strong>场景2：换一个挂载点</strong></p><ol type="1"><li>将U盘挂载到 <code>/mnt/usb</code>，创建文件<code>test.txt</code>。</li><li>卸载后，重新挂载到 <code>/media/myusb</code>。</li><li>进入 <code>/media/myusb</code>，依然能看到<code>test.txt</code>。</li></ol><p><strong>结论</strong>：文件存储在设备（U盘）中，和挂载点无关。换挂载点只是换了一个“入口”。</p><h4 id="挂载点原有内容会怎样"><strong>挂载点原有内容会怎样？</strong></h4><p><strong>场景：挂载到非空文件夹</strong></p><p>假设 <code>/mnt/usb</code> 原本有一个文件 <code>old.txt</code>：</p><ol type="1"><li>挂载U盘到 <code>/mnt/usb</code>。</li><li>此时访问<code>/mnt/usb</code>，只能看到U盘的内容，<code>old.txt</code>被“隐藏”。</li><li>卸载后，<code>old.txt</code> 重新出现。</li></ol><p><strong>结论</strong>：挂载到非空文件夹时，原内容会被临时隐藏（但不会被删除！）。</p><h4 id="常见挂载类型"><strong>常见挂载类型</strong></h4><p><strong>挂载光盘</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/cdrom /mnt/cd</span><br></pre></td></tr></table></figure><p>光盘内容会出现在 <code>/mnt/cd</code>。</p><p><strong>挂载硬盘分区</strong></p><p>假设硬盘分区是 <code>/dev/sda2</code>，挂载到<code>/data</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sda2 /data</span><br></pre></td></tr></table></figure><p>所有存到 <code>/data</code> 的文件实际保存在硬盘分区中。</p><p><strong>挂载网络存储</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs 192.168.1.100:/shared /mnt/nfs</span><br></pre></td></tr></table></figure><p>通过网络访问远程文件夹。</p><h4 id="自动挂载开机自动挂载"><strong>自动挂载（开机自动挂载）</strong></h4><p>编辑 <code>/etc/fstab</code> 文件，添加一行配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1  /mnt/usb  ext4  defaults  0  0</span><br></pre></td></tr></table></figure><p>系统启动时会自动挂载设备到指定位置。另外还有一种方法，通过<code>blkid</code> 获取要挂载设备的 <code>UUID</code>，然后使用<code>UUID</code> 挂载。</p><h2 id="取消挂载">4. 取消挂载</h2><p>取消挂载使用 <code>umount</code>命令，需要注意的是，要取消挂载需要退出挂载点所在的目录，我们结合报错例子来学习，例如在执行下面的取消挂载命令时：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /data</span><br></pre></td></tr></table></figure></p><p>可能会出现下面的报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">umount: target is busy</span><br><span class="line">(In some cases useful info about processes that use</span><br><span class="line">the device is found by lsof(8) or fuser(1))</span><br></pre></td></tr></table></figure><h3 id="原因解析">原因解析</h3><ol type="1"><li><strong>文件系统被占用</strong><ul><li><strong>打开文件</strong>：有进程正在 <code>/data</code>目录下打开文件（例如日志文件、数据文件等），导致文件系统处于“忙”状态。</li><li><strong>当前工作目录</strong>：某个用户或服务的当前工作目录设置在<code>/data</code> 下。如果用户的 shell或程序正处于该目录，也会阻止卸载。</li></ul></li><li><strong>多用户环境的影响</strong><ul><li><strong>多用户使用</strong>：在多用户系统中，不同用户可能同时在<code>/data</code>挂载点下运行应用程序或脚本。即使你自己不在使用，其他用户的进程也可能占用该目录。</li><li><strong>服务使用</strong>：某些服务（如数据库、Web服务器或其他网络服务）可能将<code>/data</code>用作数据存储目录，并且这些服务可能由不同用户启动。</li></ul></li><li><strong>后台进程和网络端口</strong><ul><li>某些后台进程或守护进程可能绑定了特定端口，并且其配置文件或数据存放在<code>/data</code> 下。使用 <code>ps -ef | grep &lt;端口号&gt;</code>可帮助定位这些进程。</li></ul></li></ol><h3 id="解决方法">解决方法</h3><ol type="1"><li><p><strong>使用 lsof 命令查看占用情况</strong></p><ul><li><p>运行以下命令，查看哪些进程正在访问 <code>/data</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof /data</span><br></pre></td></tr></table></figure></li><li><p>此命令会列出所有打开 <code>/data</code>下文件的进程及其详细信息。</p></li></ul></li><li><p><strong>使用 fuser 命令确认进程</strong></p><ul><li><p>通过 fuser 命令可以直接看到占用挂载点的进程ID：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fuser -m /data</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>使用 ps 命令查找特定端口进程（如有需要）</strong></p><ul><li><p>如果怀疑某个服务在使用特定端口（例如数据库或 Web服务），可以使用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep &lt;端口号&gt;</span><br></pre></td></tr></table></figure></li><li><p>这样可以帮助你定位使用该端口的进程，从而确认它们是否涉及到<code>/data</code> 目录的使用。</p></li></ul></li><li><p><strong>停止或终止相关进程</strong></p><ul><li><p>根据上面的命令输出，确认占用 <code>/data</code></p><p>的进程后，可以采取以下措施：</p><ul><li><p><strong>通知用户</strong>：在多用户环境中，先通知使用者退出或切换工作目录，确保不再访问<code>/data</code>。</p></li><li><p><strong>终止进程</strong>：如果确认进程可以安全终止，使用以下命令（注意要谨慎操作）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p><strong>使用延迟卸载（Lazy Unmount）</strong></p><ul><li><p>如果确定暂时无法中止所有进程，也可以采用延迟卸载的方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount -l /data</span><br></pre></td></tr></table></figure></li><li><p>此方法会立即断开挂载点，但会在进程不再使用时真正卸载。但需注意，这种方式可能会导致数据同步问题。</p></li></ul></li></ol><h1 id="四特殊设备文件">四、特殊设备文件</h1><h2 id="devnull-空设备黑洞">1. <code>/dev/null</code> ——空设备（黑洞）</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时总是返回 EOF（End of File）。</li><li>写入的数据会被直接丢弃，不占用存储空间。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>丢弃输出：常用于忽略命令的标准输出（<code>stdout</code>）或错误输出（<code>stderr</code>）。</p></li><li><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> &gt; /dev/null   <span class="comment"># 丢弃 ls 命令的标准输出</span></span><br><span class="line"><span class="built_in">ls</span> 2&gt; /dev/null  <span class="comment"># 丢弃 ls 命令的错误输出</span></span><br><span class="line"><span class="built_in">ls</span> &gt; /dev/null 2&gt;&amp;1  <span class="comment"># 同时丢弃标准输出和错误输出</span></span><br></pre></td></tr></table></figure></li><li><p>作为空文件输入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /dev/null &gt; file.txt  <span class="comment"># 清空 file.txt</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><hr><h2 id="devzero-无限输出零字节">2. <code>/dev/zero</code> ——无限输出零字节</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时会不断返回 <code>0x00</code>（空字节）。</li><li>适用于生成填充数据（例如创建大文件）。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>创建特定大小的文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=file.bin bs=1M count=100</span><br></pre></td></tr></table></figure><p>该命令创建一个 100MB 的全零文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file.bin</span><br></pre></td></tr></table></figure></li><li><p>初始化文件系统：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/zero  <span class="comment"># 格式化磁盘时用于填充数据</span></span><br></pre></td></tr></table></figure></li><li><p>用于共享内存（如 <code>mmap</code>）或虚拟内存文件系统（如<code>tmpfs</code>）。</p></li></ul></li></ul><h2 id="devrandom-高质量随机数生成器">3. <code>/dev/random</code> ——高质量随机数生成器</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时返回加密安全的随机数据（由环境噪声等熵源提供）。</li><li>如果熵池（entropypool）不足，读取可能会阻塞（等待更多随机熵）。</li><li>适用于生成高质量的加密密钥。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>生成安全随机数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">head</span> -c 16 /dev/random | <span class="built_in">base64</span>  <span class="comment"># 生成 16 字节的随机数据并编码</span></span><br></pre></td></tr></table></figure></li><li><p>生成随机密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /dev/random | <span class="built_in">tr</span> -dc <span class="string">&#x27;A-Za-z0-9&#x27;</span> | <span class="built_in">head</span> -c 12</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="devurandom-非阻塞随机数生成器">4. <code>/dev/urandom</code> ——非阻塞随机数生成器</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时返回伪随机数，熵不足时不会阻塞（不同于<code>/dev/random</code>）。</li><li>适用于大多数非极端安全需求的随机数生成场景。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>生成随机文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/urandom of=random.bin bs=1M count=10</span><br></pre></td></tr></table></figure><p>生成一个 10MB 的随机文件。</p></li><li><p>生成随机密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">base64</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong><code>/dev/random</code> vs<code>/dev/urandom</code></strong></p><table><colgroup><col style="width: 10%"><col style="width: 38%"><col style="width: 50%"></colgroup><thead><tr><th>特性</th><th><code>/dev/random</code></th><th><code>/dev/urandom</code></th></tr></thead><tbody><tr><td>是否阻塞</td><td>是（熵池不足时）</td><td>否</td></tr><tr><td>安全性</td><td>高（适用于加密密钥）</td><td>较高（但不适用于极端安全需求）</td></tr><tr><td>适用场景</td><td>需要高质量随机数，如密钥生成</td><td>普通随机需求，如随机 ID、随机测试数据</td></tr></tbody></table><p><strong>结论：</strong></p><ul><li><code>/dev/random</code> 适用于生成高安全性密钥（如 GPG/SSH密钥）。</li><li><code>/dev/urandom</code> 适用于一般随机数需求（如 sessionID）。</li></ul><h1 id="五文件系统链接与-raid-技术详解">五、文件系统、链接与 RAID技术详解</h1><p>下面将详细介绍inode、块（block）、硬链接、文件删除原理、软链接、硬链接。</p><h2 id="inode-与文件系统">1. inode 与文件系统</h2><p><strong>inode（Index Node）</strong>：是 Unix/Linux文件系统中用于存储文件元数据（metadata）的数据结构。它记录了文件的所有属性信息（如所有者、权限、时间戳、文件大小、数据块指针等），但不包含文件名。换句话说，Linux的文件内容其实是包含了文件名和元数据两个部分的，元数据可以通过<code>stat</code>命令查看得到。一个新的磁盘在格式化文件系统后存在两个存储空间，一个叫做<code>inode</code> 存储空间（存储元数据），一个叫做 <code>block</code>存储空间（存储文件数据），创建文件系统之后 <code>inode</code> 和<code>block</code> 的数量就会固定下来。Linux 读取文件内容是通过<code>文件名 &gt; inode 编号 &gt; block 的顺序</code> 来读取的。</p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311223710806.png" alt="image-20250311223710806"><figcaption aria-hidden="true">image-20250311223710806</figcaption></figure><h3 id="文件与-inode-的关系">文件与 inode 的关系</h3><ul><li><strong>文件数据与 inode</strong>：<ul><li>每个文件在创建时都会分配一个 inode，inode 存储文件的元数据。</li><li>文件的数据实际存放在数据块中，而 inode中包含指向这些数据块的指针。</li></ul></li><li><strong>目录与 inode</strong>：<ul><li>目录本身也是一个特殊类型的文件，其内容是文件名和对应 inode编号的映射表。</li><li>当你通过文件名访问文件时，系统实际上先通过目录查找对应的 inode编号，再根据 inode 获取文件的相关信息和数据。</li></ul></li></ul><h3 id="块block">块（block）</h3><ul><li><strong>块的概念</strong>：<ul><li>硬盘上的数据以块为单位存储。块是文件系统读写的基本单位，其大小通常在512 字节到 4KB 之间，具体取决于文件系统的设置。</li><li>inode 中的指针正是指向这些块的位置。</li></ul></li><li><strong>块在性能上的影响</strong>：<ul><li>块的大小会影响文件存储的效率与性能。过小可能导致大量索引；过大则可能浪费存储空间（内部碎片）。</li></ul></li></ul><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311235850437.png" alt="image-20250311235850437"><figcaption aria-hidden="true">image-20250311235850437</figcaption></figure><h2 id="链接link硬链接与软链接">2. 链接（Link）：硬链接与软链接</h2><h3 id="硬链接hard-link">硬链接（Hard Link）</h3><p>硬链接是多个目录项（文件名）指向同一个inode。也就是说，同一个文件的多个名字都指向同一组数据和属性，其特点是：</p><ul><li>共享 inode：硬链接和原始文件共享同一个inode，所以它们是完全等价的。</li><li>不能跨文件系统：硬链接只能在同一个文件系统内建立。</li><li>不能对目录建立硬链接（防止循环引用）。</li><li>当删除一个硬链接时，只是删除了目录中的一个引用。如果该 inode的链接计数不为 0，则文件数据仍然保留。</li><li>只有当所有指向该 inode 的硬链接都被删除后，系统才真正回收 inode和数据块。</li></ul><h3 id="软链接符号链接symbolic-link">软链接（符号链接，SymbolicLink）</h3><p>软链接是一个特殊类型的文件，其中存储了另一个文件或目录的路径，其特点是：</p><ul><li>不共享 inode：软链接有自己的 inode，其内容指向目标文件的路径。</li><li>可以跨文件系统：软链接可以引用其他文件系统上的文件或目录。</li><li>如果目标文件被删除，软链接就会变成“悬挂链接”（danglinglink），即指向不存在的目标。</li></ul><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311234336552.png" alt="image-20250311234336552"><figcaption aria-hidden="true">image-20250311234336552</figcaption></figure><h2 id="目录的链接数"><strong>3. 目录的链接数</strong></h2><p>在 Linux 中，<strong>目录的链接数</strong>（linkcount）表示有多少个硬链接指向该目录。可以通过 <code>ls -ld</code>来查看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld 目录名</span><br></pre></td></tr></table></figure><h3 id="目录的硬链接数">目录的硬链接数</h3><ul><li><p>普通目录</p><p>（非空目录）：硬链接数 = 2 + 该目录下的子目录个数</p><ul><li><code>.</code> 指向自身（1 个链接）</li><li><code>..</code> 存在于每个子目录（父目录的链接数 +1）</li><li>目录下的每个子目录都会在父目录中创建一个<code>..</code>，增加父目录的链接数。</li></ul></li><li><p><strong>根目录 <code>/</code></strong>：其硬链接数等于 2 +<code>/</code> 下的一级子目录数量。</p></li></ul><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> test_dir</span><br><span class="line"><span class="built_in">ls</span> -ld test_dir</span><br><span class="line"><span class="comment"># 输出类似：</span></span><br><span class="line"><span class="comment"># drwxr-xr-x 2 user user 4096 Sep 26 12:00 test_dir</span></span><br><span class="line"><span class="comment"># 其中 `2` 表示当前目录有 2 个硬链接（自身 `.` 和父目录 `..`）</span></span><br></pre></td></tr></table></figure><h3 id="子目录的影响">子目录的影响</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> test_dir/sub_dir</span><br><span class="line"><span class="built_in">ls</span> -ld test_dir</span><br><span class="line"><span class="comment"># 硬链接数增加到 3，因为 `sub_dir` 内部有 `..` 指向 `test_dir`</span></span><br></pre></td></tr></table></figure><p><strong>总结：</strong></p><ul><li><strong>空目录的硬链接数是 2</strong>（自身 <code>.</code> +父目录的 <code>..</code>）。</li><li><strong>每增加一个子目录，父目录的硬链接数增加 1</strong>。</li></ul><h2 id="文件删除原理">4. 文件删除原理</h2><ul><li><p><strong>目录项删除</strong>：当删除文件时，实际上是从目录中移除了对该文件inode 的引用（即减少了 inode 的链接计数）。</p></li><li><p><strong>数据实际删除</strong>：只有当 inode的链接计数归零时，操作系统才会将该 inode和对应的数据块标记为可回收，从而真正释放磁盘空间。</p></li><li><p><strong>缓存与文件句柄</strong>：如果某个进程已打开文件，即使目录项被删除，该文件仍可被进程读取或写入，直到文件描述符关闭后，数据才会最终释放。</p></li><li><p><strong>移动和删除文件对软硬链接的影响：</strong></p><figure><img src="/Linux-%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311235231646.png" alt="image-20250311235231646"><figcaption aria-hidden="true">image-20250311235231646</figcaption></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;磁盘相关的问题，很多时候不是“记几个命令”就能解决：分区表怎么选、文件系统怎么挂、扩容怎么尽量少停机、删文件为什么空间不立刻回来，背后都有明确的机制约束。本文从热/冷存储与磁盘结构切入，串起
RAID 与 LVM 的落地用法、MBR/GPT 分区与
&lt;code&gt;fdisk&lt;/code&gt;/&lt;code&gt;gdisk&lt;/code&gt;
的实际操作、格式化与挂载的完整流程，并补上 &lt;code&gt;/dev&lt;/code&gt;
特殊设备、inode
与硬/软链接、文件删除原理这些最容易踩坑但又最“救命”的细节。读完你应该能按步骤把一块新盘从“识别—分区—格式化—挂载—扩容—排障”走通。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 磁盘管理</title>
    <link href="https://chenk.top/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-17T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.326Z</updated>
    
    <content type="html"><![CDATA[<p>Disk issues are rarely “just one command”: partition tables (MBR vs.GPT), filesystems and mounting, capacity expansion (often via LVM), andeven “why space doesn’t come back after deleting files” are all governedby concrete mechanics. This post connects the full operational path—fromidentifying a new disk, partitioning, formatting, mounting, andexpanding, to troubleshooting common failures—while also covering theunderlying concepts that save you in production (RAID basics, specialdevices under <code>/dev</code>, inode and hard/soft links, and deletionsemantics). The goal is to make you comfortable running the end-to-endworkflow on a real machine and understanding what the system is doing ateach step.</p><span id="more"></span><h1 id="一网站存储">一、网站存储</h1><p>数据存储是网站架构的一大重点，关于存储方案我们通常需要考虑硬件角度和软件角度，本文我们只关注硬件角度。</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/20210701123415976-1024x556.png" alt="img"><figcaption aria-hidden="true">img</figcaption></figure><h2 id="存储层的设计">1. 存储层的设计</h2><p><strong>热存储（HotStorage）</strong>：存储需要频繁访问的数据。通常使用SSD（固态硬盘），例如数据库存储。</p><ul><li>SSD 基于 NAND 闪存技术，具有更快的读写速度和更高的耐用性。</li><li>通过电子电荷存储数据，每个单元存储一个或多个比特的数据。</li><li>和顺序读写比起来，固态硬盘的随机读写慢不了多少，随件写入效率略微降低，随机读取能力也就下降一半左右。</li><li>固态硬盘写入数据前要对齐，所以有独特的 <code>trim</code>指令。文件删除以后，操作系统会挑选空余时间自动执行<code>trim</code>，而不是下次使用的时候再对齐，机械硬盘不需要对齐，直接覆盖就行了。所以机械硬盘的数据在没有覆盖之前都是可以恢复了，固态硬盘一般在回收站里面删除以后很快就执行了<code>trim</code> 命令，几乎不能再恢复数据了。</li></ul><p><strong><a class="link" href="https://www.cnblogs.com/cxygg/p/16389505.html">冷存储<i class="fas fa-external-link-alt"></i></a>（ColdStorage）</strong>：用于长期存储访问频率低的数据。可以使用HDD（机械硬盘）或分布式存储系统。</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/4f588e4702ddcda3b22aa8b231cbbc47.png" alt="机械硬盘结构"><figcaption aria-hidden="true">机械硬盘结构</figcaption></figure><ul><li><p>HDD通过磁性盘片和磁头来读取和写入数据，硬盘存储设备和电磁有关因此也被称为磁盘：磁头在盘片上移动，通过磁性变化来写入和读取数据。机械硬盘里有很多张磁盘。</p></li><li><p>数据存储分为多个<strong>扇区</strong>和<strong>轨道</strong>。</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/1435314-20220619000212007-1461023647.webp" alt="img"><figcaption aria-hidden="true">img</figcaption></figure><ul><li><p>一个磁盘里面有一到多个盘片，盘片可以可以单面或者双面的。单面盘片只有一个面有磁头，双面盘片两个面都有磁头。多盘片，双盘面的磁盘，是协同工作的，这时候他们机械臂的位置相同，盘面相对位置恒定，理论上多盘片之间可以相互配合共同读写，多盘片的硬盘，也并不会成倍的提升读写性能，大概只能归结于工艺原因，并不能做到多盘片协同工作。</p></li><li><p>一个扇区模默认大小是512字节，也就是0.5KB。如下图，我们格式化硬盘的时候，可以指定分配单元大小，理论上一个分配单元最小值就是一个扇区。</p><figure><img src="https://img2022.cnblogs.com/blog/1435314/202206/1435314-20220619000532622-448669195.png" alt="img"><figcaption aria-hidden="true">img</figcaption></figure></li><li><p>操作系统的分配单元大小叫做簇（或者块block），一个簇由一到多个连续扇区组成，一个文件只能被连续的存储在一个或者多个簇里面。比如我4K对齐(操作系统指定1个簇由8个扇区构成)，那么我即便有的文件只有1个字节，那么它也会占用4K的存储空间。</p></li><li><p>有时候我们文件显示存储空间是0，这是操作系统优化的结果，太小的文件，占用一个簇太浪费，我们可以公用区域存放，这个文件如果再大一点，或者公共区域放不下了，就会直接分配单独的一个簇存储。</p></li></ul></li><li><p>对机械硬盘而言，转速和缓存是高性能的指标</p><ul><li>常见的是 7200 rpm（转每分钟）+ 64 MB 的缓存配置</li><li>一些需要高负载和大型数据传输的高性能服务器会配置 10000 或 15000 rpm+ 128 MB 甚至更高的缓存</li></ul></li><li><p>磁盘读写过程：</p><ul><li>通过地址确定需要读取的数据所在的磁道，和扇区。</li><li>机械摆臂移动磁头到指定磁道位置（等待机械结构移动）</li><li>等到磁盘扇区转到到磁头位置开始读取（等待机械结构转动）</li><li>如果数数据是在相邻扇区，或者相邻的蔟，那么就能连续的读取，这种叫做顺序读取</li><li>如果所需数据位于不同扇区，不同磁道，那么需要不断移动机械臂，和等待磁盘转动到指定扇区，这种就是随机读写。</li></ul><p>机械硬盘随机读写慢的原因主要就是两次等待机械机构移动到指定位置。摆臂移动时间大概是6-8毫秒，7200转的硬盘一秒钟转120圈，每圈时间8.3毫秒，平均半圈是4毫秒的样子。所以7200转的机械银盘随机读取的平均延时在10多毫秒。机械硬盘顺序读写速度比随机读写快80倍以上，差异巨大。</p></li></ul><p><strong>对象存储</strong>：如 AWS S3、阿里云OSS，用于存储大量不常访问的文件和数据。</p><ul><li>在 Hadoop分布式文件系统（HDFS）中使用对象存储来处理大规模数据。</li></ul><h2 id="存储的数据备份raid磁盘阵列技术">2.存储的数据备份（RAID磁盘阵列技术）</h2><p>使用 <code>raid</code>磁盘阵列技术进行磁盘备份，以保证数据安全性。</p><h3 id="raid-的基本概念">RAID 的基本概念</h3><ul><li><strong>RAID（Redundant Array of IndependentDisks）</strong>：将多个硬盘组合在一起形成一个逻辑单元，以提高数据冗余和/或性能。</li><li><strong>RAID 级别</strong>：<ul><li><strong>RAID0</strong>：数据条带化，分布到多个磁盘上，提高读写性能，但没有冗余，单个磁盘故障将导致数据丢失。</li><li><strong>RAID1</strong>：镜像，数据在两个磁盘上完全复制，提高数据安全性，但存储空间减半。</li><li><strong>RAID5</strong>：条带化+奇偶校验，至少需要三块磁盘，具有数据冗余和较好的性能平衡。</li><li><strong>RAID 6</strong>：类似 RAID5，但使用双重奇偶校验，可以容忍两块磁盘同时故障。</li><li><strong>RAID 10</strong>：结合 RAID 0 和 RAID1，先进行镜像再条带化，提供高性能和冗余，但成本较高。</li></ul></li></ul><h3 id="软件-raid软-raid">软件 RAID（软 RAID）</h3><p>软件 RAID 是由操作系统通过软件实现 RAID 功能，而不是依赖硬件 RAID控制器。常见工具包括 Linux 下的 <code>mdadm</code>。优点是：</p><ul><li>成本低，无需专用硬件。</li><li>灵活性高，可动态调整 RAID 配置。</li></ul><p>对应的缺点是占用 CPU 资源，对系统性能有一定影响（现代 CPU通常能很好地应对）。</p><h3 id="软件-raid-命令实践">软件 RAID 命令实践</h3><ul><li><p><strong>创建 RAID</strong>：例如，创建一个 RAID 1 镜像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sda1 /dev/sdb1</span><br></pre></td></tr></table></figure><ul><li><code>/dev/md0</code>：新创建的 RAID 设备</li><li><code>--level=1</code>：指定 RAID 1（镜像）</li><li><code>--raid-devices=2</code>：使用两个磁盘分区</li><li><code>/dev/sda1 /dev/sdb1</code>：参与 RAID 的设备</li></ul></li><li><p><strong>查看 RAID 状态</strong>：使用如下命令检查 RAID设备状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/mdstat</span><br></pre></td></tr></table></figure></li><li><p><strong>管理 RAID</strong>：添加、移除、重建等操作都可以使用<code>mdadm</code> 进行管理。例如：</p><ul><li><p><strong>停止 RAID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --stop /dev/md0</span><br></pre></td></tr></table></figure></li><li><p><strong>移除设备</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm /dev/md0 --fail /dev/sda1 --remove /dev/sda1</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>配置文件</strong>：将 RAID 配置信息写入配置文件（如<code>/etc/mdadm.conf</code>），以便系统启动时自动组装 RAID 设备：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdadm --detail --scan &gt;&gt; /etc/mdadm.conf</span><br></pre></td></tr></table></figure></li></ul><h2 id="存储的数据扩容">3. 存储的数据扩容</h2><p>磁盘的数据满了怎么办，需要涉及存储的设备扩容</p><ol type="1"><li>保证数据库数据完整的情况下，将用户数据迁移到另一个硬盘中</li><li>考虑到用户数据会不断增长，新磁盘采用 <code>lvm</code>逻辑卷管理，方便日后动态扩容</li></ol><h3 id="扩容业务整体流程">扩容业务整体流程</h3><ol type="1"><li>需要一块新硬盘（虚拟机可添加）</li><li>新硬盘需要做 <code>lvm</code> 管理</li><li>数据库迁移（夜间停机维护，凌晨 2 点）<ul><li>停止数据库监控</li><li>停止前端（关闭前端数据入口，比如停用博客发表功能）：<code>systemctl stop apache</code></li><li>停止后端（可选）</li><li>停止 MySQL 数据库（防止数据还在写入，或者锁表）</li><li>备份数据库（全备）</li><li>迁移数据到新硬盘（使用 <code>rsync</code>【比 <code>cp</code>命令更强大】），新硬盘已经做好了 <code>lvm</code>，且挂载好了</li><li>启动数据库</li><li>启动前端入口</li><li>测试数据读写</li><li>博客功能重新恢复上线</li><li>开启数据库监控</li></ul></li></ol><h3 id="lvm-技术"><code>lvm</code> 技术</h3><p>LVM（逻辑卷管理器，Logical VolumeManager）是一种将物理存储设备抽象为逻辑存储单元的技术，允许系统管理员更加灵活地管理存储设备。与传统的分区方式（如直接将磁盘划分为固定大小的分区）不同，LVM提供了更高的灵活性，能够在系统运行时动态地调整存储空间。</p><p>LVM 技术包括以下几个核心概念：</p><p><strong>物理卷（Physical Volume, PV）</strong></p><p>物理卷是 LVM 中的最底层存储单元，通常是磁盘或者磁盘分区。LVM会将一个或多个物理卷组织在一起，形成一个“卷组”（VolumeGroup，VG）。物理卷不一定是整个磁盘，可以是磁盘的一个分区，也可以是整个磁盘。</p><p>创建物理卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/sdb1  <span class="comment"># 创建一个物理卷</span></span><br></pre></td></tr></table></figure><p><strong>卷组（Volume Group, VG）</strong></p><p>卷组是由多个物理卷组成的逻辑容器。它可以将多个物理卷中的存储空间汇聚到一起，形成一个大的池，供逻辑卷使用。一个卷组可以包含多个物理卷，也可以只有一个物理卷。</p><p>创建卷组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgcreate my_volume_group /dev/sdb1 /dev/sdc1  <span class="comment"># 创建一个卷组，包含 /dev/sdb1 和 /dev/sdc1</span></span><br></pre></td></tr></table></figure><p><strong>逻辑卷（Logical Volume, LV）</strong></p><p>逻辑卷是实际存储数据的地方，它类似于传统分区。逻辑卷是从卷组中分配的存储空间，可以根据需要进行扩展或缩减。LVM提供了动态创建、删除和调整逻辑卷大小的能力。</p><p>创建逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 10G -n my_logical_volume my_volume_group  <span class="comment"># 创建一个大小为10GB的逻辑卷</span></span><br></pre></td></tr></table></figure><p><strong>逻辑卷的扩展与收缩</strong></p><p>LVM允许在逻辑卷中增加或减少存储空间。对于增加存储空间，可以将新的物理卷加入到卷组中，并扩展逻辑卷的大小；对于减少存储空间，需要先对文件系统进行缩减，确保数据的安全。</p><p>扩展逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvextend -L +5G /dev/my_volume_group/my_logical_volume  <span class="comment"># 将逻辑卷扩展5GB</span></span><br><span class="line">resize2fs /dev/my_volume_group/my_logical_volume  <span class="comment"># 调整文件系统的大小</span></span><br></pre></td></tr></table></figure><p>缩小逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e2fsck -f /dev/my_volume_group/my_logical_volume  <span class="comment"># 检查文件系统</span></span><br><span class="line">resize2fs /dev/my_volume_group/my_logical_volume 5G  <span class="comment"># 调整文件系统大小到5GB</span></span><br><span class="line">lvreduce -L 5G /dev/my_volume_group/my_logical_volume  <span class="comment"># 缩小逻辑卷</span></span><br></pre></td></tr></table></figure><p><strong>快照（Snapshot）</strong></p><p>LVM还支持创建快照。快照是某个逻辑卷的时间点副本，可以用于数据备份或在对逻辑卷进行修改之前进行保护。快照是增量的，仅记录自创建快照以来的变化。</p><p>创建和删除快照：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 1G -s -n my_snapshot /dev/my_volume_group/my_logical_volume  <span class="comment"># 创建快照</span></span><br><span class="line">lvremove /dev/my_volume_group/my_snapshot  <span class="comment"># 删除快照</span></span><br></pre></td></tr></table></figure><p><strong>LVM 的优点</strong></p><ul><li><strong>灵活性</strong>：可以动态增加、缩小卷的大小，无需重新分区和格式化磁盘。</li><li><strong>卷扩展性</strong>：可以将多个物理卷合并为一个卷组，增加存储池的空间。</li><li><strong>数据保护</strong>：通过快照功能，可以在修改数据之前创建数据副本，保护数据不被误删。</li><li><strong>性能优化</strong>：LVM支持多种策略，如镜像（Mirroring）、条带化（Striping）等，来提高性能或容错性。</li></ul><p><strong>LVM 的常用命令</strong></p><p>查看物理卷、卷组、逻辑卷的状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pvs  <span class="comment"># 查看物理卷</span></span><br><span class="line">vgs  <span class="comment"># 查看卷组</span></span><br><span class="line">lvs  <span class="comment"># 查看逻辑卷</span></span><br></pre></td></tr></table></figure><p>删除物理卷、卷组、逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lvremove /dev/my_volume_group/my_logical_volume  <span class="comment"># 删除逻辑卷</span></span><br><span class="line">vgremove my_volume_group  <span class="comment"># 删除卷组</span></span><br><span class="line">pvremove /dev/sdb1  <span class="comment"># 删除物理卷</span></span><br></pre></td></tr></table></figure><p>将物理卷加入卷组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgextend my_volume_group /dev/sdd1  <span class="comment"># 向卷组添加物理卷</span></span><br></pre></td></tr></table></figure><p>移除物理卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgreduce my_volume_group /dev/sdb1  <span class="comment"># 从卷组中移除物理卷</span></span><br></pre></td></tr></table></figure><hr><p>举个例子，在 Mac系统上，<strong>硬盘空间的增加</strong>会被自动识别为新的分区或逻辑卷（LVM），而不需要手动进行分区。</p><p>我们可以首先进行硬盘空间分配来验证之（注意这里的硬盘空间分配了之后，主机的硬盘空间不会立刻少这么多，而是慢慢减少直到用满了这新增的空间）。</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250214204528744.png" alt="image-20250214204528744"><figcaption aria-hidden="true">image-20250214204528744</figcaption></figure><p>然后我们查看 <code>lablk</code>：</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250218010311167.png" alt="image-20250218010311167"><figcaption aria-hidden="true">image-20250218010311167</figcaption></figure><p><strong>nvme0n1 硬盘</strong>是我的物理硬盘，大小为50GB。这个硬盘上有三个分区：</p><ul><li>/dev/nvme0n1p1：EFI 系统分区，大小 953MB。</li><li>/dev/nvme0n1p2：启动分区，大小 1.8GB。</li><li>/dev/nvme0n1p3：剩余的分区，大小 45.3GB。<ul><li>在 /dev/nvme0n1p3 上，系统使用了 LVM，具体来说是<strong>ubuntu--vg-ubuntu--lv</strong> 这个逻辑卷，大小为 45.3GB，挂载在/（根目录）下。</li><li>当我们增加硬盘空间时，<strong>LVM</strong>（逻辑卷管理）在已经有的物理分区（如/dev/nvme0n1p3）上自动扩展了空间。因此我们无需手动分区，LVM可以动态调整卷的大小以适应新加入的空间。</li><li><strong>LVM</strong>使得我们可以动态管理存储，不需要像传统的分区方式那样手动分区。</li></ul></li></ul><p>进一步地，我们可以通过 lvdisplay命令查看逻辑卷的详细信息，确认新的硬盘空间是否已正确分配给逻辑卷：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lvdisplay</span></span><br><span class="line">  --- Logical volume ---</span><br><span class="line">  LV Path                /dev/ubuntu-vg/ubuntu-lv</span><br><span class="line">  LV Name                ubuntu-lv</span><br><span class="line">  VG Name                ubuntu-vg</span><br><span class="line">  LV UUID                ZtYUOm-9g6w-j6i3-fnJu-Bqly-BtYQ-s3dRWH</span><br><span class="line">  LV Write Access        <span class="built_in">read</span>/write</span><br><span class="line">  LV Creation host, time ubuntu-server, 2025-01-12 03:55:17 +0800</span><br><span class="line">  LV Status              available</span><br><span class="line">  <span class="comment"># open                 1</span></span><br><span class="line">  LV Size                &lt;45.32 GiB</span><br><span class="line">  Current LE             11601</span><br><span class="line">  Segments               1</span><br><span class="line">  Allocation             inherit</span><br><span class="line">  Read ahead sectors     auto</span><br><span class="line">  - currently <span class="built_in">set</span> to     256</span><br><span class="line">  Block device           252:0</span><br></pre></td></tr></table></figure><h1 id="二磁盘管理业务背景与流程">二、磁盘管理业务背景与流程</h1><p>磁盘管理确保硬件存储的健康和可靠性。磁盘的使用涉及到磁盘健康监控、备份、恢复等多个方面。我们可以与Windows 的磁盘管理做一个对比，在 Windows系统中，磁盘的管理包括分区、格式化、磁盘检查等。</p><ul><li><strong>磁盘分区</strong>：可以通过“磁盘管理”工具创建、删除、格式化磁盘分区。</li><li><strong>磁盘碎片整理</strong>：Windows 提供磁盘碎片整理工具。</li><li><strong>查看磁盘信息：</strong></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">diskpart  <span class="comment"># 启动磁盘管理工具</span></span><br><span class="line">list disk  <span class="comment"># 列出所有磁盘</span></span><br></pre></td></tr></table></figure><p>在 Linux 下，具体的内容为：</p><ol type="1"><li><p><strong>硬盘健康检查</strong>：定期运行 <code>smartctl</code>检查硬盘状态，提前发现潜在问题，如坏道、读写错误等。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smartctl -a /dev/sda  <span class="comment"># 查看硬盘健康状态</span></span><br><span class="line">   <span class="built_in">df</span> -h  <span class="comment"># 显示磁盘空间使用情况</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250213152728125.png" alt="image-20250213152728125"><figcaption aria-hidden="true">image-20250213152728125</figcaption></figure></li><li><p><strong>磁盘碎片整理</strong>：对于机械硬盘（HDD），我们可以使用工具如<code>bleachbit</code> 或 <code>ncdu</code>进行磁盘清理，释放磁盘空间。并使用 <code>e4defrag</code>碎片整理工具进行整理：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e4defrag /dev/sda  <span class="comment"># 对 /dev/sda 分区进行碎片整理</span></span><br></pre></td></tr></table></figure></li><li><p><strong>数据备份与恢复</strong>：使用工具如 <code>rsync</code> 或<code>tar</code> 进行定期备份。</p></li></ol><h1 id="三磁盘使用流程">三、磁盘使用流程</h1><p>磁盘在计算机中是用来存储数据的设备，磁盘的使用包括挂载、分区以及对文件系统的访问。Linux系统中的磁盘挂载是磁盘和文件系统连接的过程，Linux系统通过挂载将磁盘分区与文件系统连接，使得用户可以通过路径访问磁盘上的文件。</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/3baffb6c16dc43cc92b87baad5700594.png" alt="关于Linux中卷/分区等知识的一些总结-云社区-华为云"><figcaption aria-hidden="true">关于Linux中卷/分区等知识的一些总结-云社区-华为云</figcaption></figure><p>我们可以将磁盘从被识别到可以使用的过程与实际生活中房子类比：</p><ol type="1"><li><strong>磁盘准备存储数据</strong>：类比为人盖房子。磁盘需要在计算机系统中准备好，才能进行数据存储。</li><li><strong>磁盘分区</strong>：类比为房子改好后需要隔断。磁盘需要分区，才能将磁盘空间划分为不同的区域（例如：卧室、厨房、卫生间等），不同区域用于存储不同类型的数据。</li><li><strong>磁盘格式化与创建文件系统</strong>：类比为房子装修。分区后，磁盘还需要格式化并创建文件系统，不同的文件系统有不同的功能和用途，就像房子的装修风格（欧式、中式等）决定了居住体验。</li><li><strong>磁盘挂载到文件夹</strong>：类比为安装门窗，确保进出。格式化并创建文件系统后，磁盘需要挂载到系统的文件夹中，才能通过操作系统进行数据存储和读取，就像房子需要安装门窗才能与外界沟通。</li></ol><h2 id="磁盘分区">1. 磁盘分区</h2><p>分区方案指的是磁盘布局的特定基础结构、分区的实际排列方式、功能以及限制。</p><table><colgroup><col style="width: 15%"><col style="width: 42%"><col style="width: 41%"></colgroup><thead><tr><th>特性</th><th>MBR（主引导记录）</th><th>GPT（GUID 分区表）</th></tr></thead><tbody><tr><td><strong>最大存储空间</strong></td><td>最大支持 2TB</td><td>支持大于 2TB，最大支持 9.4ZB（远超当前硬盘技术）</td></tr><tr><td><strong>最大分区数量</strong></td><td>最多支持 4 个主分区，或 3 个主分区 + 1 个扩展分区</td><td>最多支持 128 个主分区</td></tr><tr><td><strong>分区表大小</strong></td><td>固定为 512 字节</td><td>可自定义，支持更大规模的分区表</td></tr><tr><td><strong>冗余与备份</strong></td><td>无冗余备份，一旦损坏可能导致数据丢失</td><td>提供冗余备份，分区表存储在磁盘的开始和结尾部分</td></tr><tr><td><strong>支持的引导模式</strong></td><td>传统 BIOS 引导模式</td><td>与 UEFI 配合使用，支持更现代的引导方式</td></tr><tr><td><strong>操作系统兼容性</strong></td><td>支持所有 32 位和 64 位 Windows 操作系统</td><td>支持大多数 Windows 版本，但需要 UEFI 支持</td></tr><tr><td><strong>使用场景</strong></td><td>适用于小容量磁盘（2TB 以下）和老旧系统</td><td>适用于大容量磁盘（2TB 以上）和现代系统</td></tr><tr><td><strong>系统安装和维护</strong></td><td>适合传统的磁盘管理方式</td><td>支持多重操作系统安装和复杂的硬件配置</td></tr></tbody></table><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/Difference-between-MBR-and-GPT.png" alt="Difference between MBR and GPTMustBeGeek"><figcaption aria-hidden="true">Difference between MBR andGPTMustBeGeek</figcaption></figure><h3 id="mbr">MBR</h3><p>MBR （master boot record - 主引导记录）支持最多 4 个主分区（3个主分区+1 个扩展分区），最大支持 2 TB 的磁盘。</p><figure><img src="https://i-blog.csdnimg.cn/blog_migrate/d17d97002fe76459d24b269d44c4c9e8.png" alt="MBR、主引导扇区，主分区、扩展分区、逻辑分区，活动分区、引导分区、系统分区、启动分区_活动分区和引导分区-CSDN博客"><figcaption aria-hidden="true">MBR、主引导扇区，主分区、扩展分区、逻辑分区，活动分区、引导分区、系统分区、启动分区_活动分区和引导分区-CSDN博客</figcaption></figure><ul><li>简单来说，MBR是磁盘里的第一个扇区，作用是告诉操作系统怎么加载磁盘顺序，如何开机</li><li>优点是兼容性好，缺点是不支持管理大硬盘结构。对于大于 2TB 的硬盘，MBR会无法识别，导致硬盘空间浪费。这是因为 MBR 使用 32位寻址方式，限制了可寻址的空间。</li><li>主引导扇区位于整个磁盘的 0 磁头 0 柱头 1 扇面，包括硬盘主引导记录MBR 和分区表 DPT（Disk PartitionTable）。主引导记录用于检查分区表是否正确以及哪个分区为引导分区，也就是操作系统引导扇区调入内存加以执行。</li></ul><p>从原理上说：</p><ol type="1"><li>MBR分区方案使用硬盘的第一个物理扇区中的 64个字节作为分区表的空间保存硬盘分区信息，每个分区的信息要占 16个字节。所以，MBR分区表最多只能保存4个分区的分区信息。</li><li>MBR分区方案中，有三种类型的分区，主分区、扩展分区和逻辑分区。扩展分区与逻辑分区是为了突破分区表中只能保存4 个分区的限制而出现的</li><li>MBR分区表中保存的分区信息都是主分区与扩展分区的分区信息，扩展分区不能直接使用，需要在扩展分区内划分一个或多个逻辑分区后才能使用，逻辑分区的分区信息保存在扩展分区内，而不是保存在MBR 分区表内，这样就可以突破 MBR 分区表只能保存 4 个分区的限制。</li><li>16个字节的分区信息保存有分区活动状态标志、文件系统标识、起止柱面号、磁头号、扇区号、起始扇区位置（4个字节）、分区总扇区数目（4个字节）等内容。这里最重要的是：分区的起始扇区位置与分区的总扇区数，都是用4 个字节表示的。一般每个廓区的容量是 512 字节，4个字节的扇区能表示的最大容量是 2 TB，由此可知，在 MBR分区表中，分区的起始位置不能大于 2 TB，分区的最大容量，也不能大于 2TB，所以，对 2 TB 以上容量的物理硬盘，不适合使用MBR分区方案。</li></ol><h3 id="gpt">GPT</h3><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/gpt-partition.png" alt="2.6. GUID 分区表| Red Hat Product Documentation"><figcaption aria-hidden="true">2.6. GUID 分区表| Red Hat ProductDocumentation</figcaption></figure><p>GPT（GUID 分区表）可以给超过 2 TB 的硬盘使用，支持更多分区（最多 128个），且没有大小限制。GPT 使用 64 位寻址方式，支持最大9.4ZB（zettabytes）的硬盘空间，远超当前硬盘技术的需求。</p><p><strong>新购电脑的主板类型</strong>：</p><ul><li>如果电脑使用传统的 <strong>BIOS</strong> 主板，建议使用<strong>MBR</strong> 格式。</li><li>如果电脑使用现代的 <strong>UEFI</strong> 主板，建议使用<strong>GPT</strong> 格式。UEFI 模式可以更好地支持GPT，提供更快速、更安全的启动过程。</li></ul><p><strong>重装操作系统时的兼容性</strong>：</p><ul><li>在重装操作系统前，了解所安装的操作系统版本是否支持 MBR 或者 UEFI模式（即 GPT 格式）。大多数操作系统，特别是 Windows 7及以后的版本，都支持 GPT 格式，但老旧版本的 Windows（如 XP）可能不支持GPT。</li><li><strong>注意</strong>：虽然 MBR格式支持大部分操作系统版本，但并非所有 Windows 版本都兼容 GPT格式。例如，Windows XP 不支持 GPT，而 Windows 10 和 Windows 11则完全支持 GPT 格式，尤其是在 UEFI 启动模式下。</li></ul><p><strong>磁盘类型选择</strong>：</p><ul><li>对于传统硬盘（HDD）和容量较小（2TB 以下）的硬盘，使用 MBR可以满足基本需求。</li><li>对于大容量硬盘（大于2TB），SSD，以及希望获得更高可靠性和灵活性的用户，使用 GPT是更优的选择。</li></ul><p><strong>系统安装和维护</strong>：</p><ul><li>如果计划使用 RAID、加密、或者多重操作系统的安装，GPT格式会提供更多的优势，尤其是在支持 UEFI 的系统上。</li><li>由于 GPT格式支持更多的分区，它适合多重操作系统的安装或大型磁盘的管理。</li></ul><h3 id="fdisk-和-gdisk"><code>fdisk</code> 和 <code>gdisk</code></h3><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221115341740.png" alt="image-20250221115341740"><figcaption aria-hidden="true">image-20250221115341740</figcaption></figure><p><code>fdisk</code> 是管理 MBR分区表的命令行工具，常用来创建、删除和修改分区。常见操作是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新分区</span></span><br><span class="line">fdisk /dev/sda  <span class="comment"># 对 /dev/sda 硬盘进行操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前分区</span></span><br><span class="line">fdisk -l  <span class="comment"># 列出所有磁盘和分区</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250218233923991.png" alt="image-20250218233923991"><figcaption aria-hidden="true">image-20250218233923991</figcaption></figure><p>我的系统显示是 <code>GPT</code> 类型，因此不支持 <code>fdisk</code>分区，需要用到 <code>gdisk</code>。<code>gdisk</code> 是一个用于 GPT分区表的工具，适用于支持 UEFI 启动的系统。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建新分区</span></span><br><span class="line">gdisk /dev/sda  <span class="comment"># 对 /dev/sda 硬盘进行 GPT 分区操作</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前分区</span></span><br><span class="line">gdisk -l /dev/sda  <span class="comment"># 列出 GPT 分区表</span></span><br></pre></td></tr></table></figure><p>要将分区类型做修改，可以参考如下操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mbr ----&gt; gpt</span></span><br><span class="line">parted /dev/sdc1</span><br><span class="line">mktable gpt</span><br><span class="line"></span><br><span class="line"><span class="comment"># gpt -----&gt; mbr</span></span><br><span class="line">parted /dev/sdc1</span><br><span class="line">mktable msdos</span><br></pre></td></tr></table></figure><h3 id="硬盘接口与命名规则">硬盘接口与命名规则</h3><p>在 Linux 系统中，磁盘设备的命名规则通常采用 <code>/dev/sdX</code> 或<code>/dev/nvmeX</code> 的格式。</p><p><strong>常见命名规则：</strong></p><ul><li><strong>/dev/sda</strong>：第一个 SATA 硬盘</li><li><strong>/dev/nvme0n1</strong>：第一个 NVMe 固态硬盘</li><li><strong>/dev/sr0</strong>：光盘驱动器</li></ul><p>更具体一点的命名规则其实得追溯到硬盘接口</p><p>硬盘接口主要分为以下几种：</p><ul><li><strong>SATA</strong>：常见的消费级接口，速度适中，广泛使用。</li><li><strong>SAS</strong>：企业级接口，速度较快且稳定性好，常用于服务器。SAS比 SATA 多了一个金手指。</li><li><strong>NVMe</strong>：最现代的存储接口，专为固态硬盘设计，提供超高速数据传输。</li><li><strong>PCIe</strong>：不仅适用于硬盘，还用于显卡等高性能设备，是一个高速的通用接口。</li><li><strong>IDE</strong>：老旧的接口，现已几乎完全被 SATA 替代。</li><li><strong>U.2 和 M.2</strong>：适用于现代高性能固态硬盘，M.2更适合笔记本，U.2 多用于企业级 SSD。</li></ul><figure><img src="https://picx.zhimg.com/80/v2-0b265dff6192f6bbeef41084d8e55da3.png" alt="固态硬盘接口有哪几种如何选择合适的SSD接口-墨铺"><figcaption aria-hidden="true">固态硬盘接口有哪几种如何选择合适的SSD接口-墨铺</figcaption></figure><table><colgroup><col style="width: 27%"><col style="width: 22%"><col style="width: 31%"><col style="width: 18%"></colgroup><thead><tr><th>接口类型</th><th>数据传输速度</th><th>主要特点</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>SATA (Serial ATA)</strong></td><td>最高 6Gb/s</td><td>- 最常见的硬盘接口，适用于台式机和笔记本<br>-适合机械硬盘和一些固态硬盘</td><td>适用于大多数消费级硬盘，兼容性好</td></tr><tr><td><strong>SAS (Serial Attached SCSI)</strong></td><td>最高 12Gb/s</td><td>- 专为企业级存储设计，支持多设备连接<br>-提供更高的稳定性和可靠性</td><td>企业级存储，服务器，数据中心</td></tr><tr><td><strong>NVMe (Non-Volatile Memory Express)</strong></td><td>最高 32Gb/s</td><td>- 基于 PCIe，总线速度更快<br>- 主要用于固态硬盘，低延迟</td><td>高性能计算、大型数据应用、游戏</td></tr><tr><td><strong>PCIe (Peripheral Component InterconnectExpress)</strong></td><td>取决于版本，最大可达 64Gb/s（PCIe 4.0 x16）</td><td>- 高速数据传输接口，用于显卡、存储设备等<br>-非常适合高性能存储设备</td><td>高端工作站、服务器、快速 SSD 存储</td></tr><tr><td><strong>IDE (Integrated Drive Electronics)</strong></td><td>最高 133MB/s</td><td>- 较老的硬盘接口，速度较慢<br>- 现已被 SATA 取代</td><td>主要用于老旧设备，不推荐用于现代系统</td></tr><tr><td><strong>U.2 (previously SFF-8639)</strong></td><td>最高 32Gb/s</td><td>- 连接方式类似于 SATA，但基于 PCIe 协议<br>-用于高性能企业级固态硬盘</td><td>企业级 SSD，数据中心、高端服务器</td></tr><tr><td><strong>M.2</strong></td><td>最高 32Gb/s (取决于协议，如 SATA 或 PCIe)</td><td>- 小型接口，用于笔记本、主板上<br>- 支持 SATA 和 NVMe 协议</td><td>笔记本电脑、主板上的固态硬盘</td></tr></tbody></table><p>硬盘在不同操作系统和不同接口类型中有不同的命名规则，主要依赖于硬盘的接口类型、顺序以及分区情况。以下是一些常见的命名规则和详细说明。</p><table><colgroup><col style="width: 11%"><col style="width: 44%"><col style="width: 44%"></colgroup><thead><tr><th>操作系统</th><th>硬盘命名规则</th><th>描述</th></tr></thead><tbody><tr><td><strong>Linux (RHEL)</strong></td><td><code>/dev/hda</code>, <code>/dev/sda</code></td><td>- <strong>/dev/hda</strong>：IDE 接口硬盘（早期版本）<br>-<strong>/dev/sda</strong>：SATA 或 SCSI 接口硬盘</td></tr><tr><td><strong>IDE 接口</strong></td><td><code>/dev/hda</code></td><td>IDE 接口的硬盘，较旧的命名方式</td></tr><tr><td><strong>SATA 接口</strong></td><td><code>/dev/sda</code>, <code>/dev/sdb</code></td><td>SATA 接口硬盘命名规则，<code>a</code> 为第一块硬盘，<code>b</code>为第二块硬盘</td></tr><tr><td><strong>SCSI 接口</strong></td><td><code>/dev/sda</code>, <code>/dev/sdb</code></td><td>SCSI 接口硬盘命名，类似 SATA，但在服务器环境中常见</td></tr><tr><td><strong>多块硬盘</strong></td><td><code>/dev/sda1</code>, <code>/dev/sdb1</code></td><td>多块硬盘时，根据硬盘顺序命名，如第一块硬盘为<code>/dev/sda</code>，第二块为<code>/dev/sdb</code>，每个硬盘的分区由数字表示，<code>/dev/sda1</code>表示第一块硬盘的第一个分区</td></tr><tr><td>惠普服务器硬盘</td><td><code>/dev/cciss/c0d0</code>,<br><code>/dev/cciss/c0d0p1</code>,<br><code>/dev/cciss/c0d0p2</code></td><td></td></tr><tr><td>虚拟硬盘</td><td><code>/dev/vd</code></td><td>阿里云服务器等可能会用</td></tr></tbody></table><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250214114911032.png" alt="image-20250214114911032"><figcaption aria-hidden="true">image-20250214114911032</figcaption></figure><p>总结来说：</p><ul><li><strong>硬盘命名</strong>：硬盘的名字通常由接口类型（如SATA、SCSI）、硬盘的顺序（<code>a</code>, <code>b</code>, <code>c</code>等）以及分区编号组成。<ul><li><code>/dev/sda</code>：第一块硬盘。</li><li><code>/dev/sdb</code>：第二块硬盘。</li><li><code>/dev/sdc</code>：第三块硬盘。</li><li>以此类推，字母递增。</li></ul></li><li><strong>分区命名</strong>：每个硬盘上的分区通过数字表示：<ul><li><code>/dev/sda1</code>：第一块硬盘的第一个分区。</li><li><code>/dev/sda2</code>：第一块硬盘的第二个分区。</li><li><code>/dev/sda3</code>：第一块硬盘的第三个分区。</li><li><code>/dev/sda4</code>：第一块硬盘的第四个分区。</li></ul></li></ul><blockquote><p>虚拟硬盘格式：</p><table><colgroup><col style="width: 10%"><col style="width: 66%"><col style="width: 23%"></colgroup><thead><tr><th>格式</th><th>描述</th><th>主要应用</th></tr></thead><tbody><tr><td><strong>VMDK</strong></td><td>VMware 使用的虚拟硬盘格式。它能够模拟物理硬盘的特性，用于 VMware虚拟机中。</td><td>VMware 虚拟化平台</td></tr><tr><td><strong>VHD</strong></td><td>Microsoft 的虚拟硬盘格式，支持微软 Hyper-V 虚拟化平台。</td><td>Hyper-V 虚拟化平台</td></tr><tr><td><strong>VHDX</strong></td><td>VHD 的增强版本，支持更大的虚拟硬盘和更高的可靠性。</td><td>Hyper-V 虚拟化平台</td></tr><tr><td><strong>QCOW2</strong></td><td>QEMU 的虚拟硬盘格式，支持快照和压缩，适用于 KVM 和 QEMU虚拟机。</td><td>QEMU/KVM 虚拟化平台</td></tr><tr><td><strong>VDI</strong></td><td>VirtualBox 使用的虚拟硬盘格式。</td><td>VirtualBox 虚拟化平台</td></tr></tbody></table></blockquote><p>在 Windows 中，硬盘分区命名类似： - <strong>C:</strong>代表硬盘的第一个分区（通常是操作系统分区）。 - <strong>D:</strong>代表第二个分区。 - <strong>E:</strong> 代表第三个分区。 -<strong>F:</strong> 代表第四个分区。</p><p>这和 Linux 中的硬盘命名规则 <code>/dev/sda1</code>,<code>/dev/sda2</code> 等相对应。</p><h2 id="格式化文件系统">2. 格式化文件系统</h2><p>常见的文件系统有 EXT4、XFS 和 NTFS等，可以对分区在格式化的时候进行选择：</p><ul><li><strong>EXT4</strong>：Linux常用的文件系统，支持大文件和较高的性能。</li><li><strong>XFS</strong>：高性能文件系统，常用于大型数据库和大规模存储。</li><li><strong>NTFS</strong>：Windows操作系统的标准文件系统，支持文件压缩、加密等功能。</li><li><strong>ExFAT</strong>：MacOS下的文件系统，在MacOS和Windows之间都可以读写</li></ul><table><colgroup><col style="width: 5%"><col style="width: 21%"><col style="width: 7%"><col style="width: 26%"><col style="width: 39%"></colgroup><thead><tr><th>文件系统</th><th>最大分区</th><th>最大文件</th><th>支持的操作系统</th><th>备注</th></tr></thead><tbody><tr><td>FAT32</td><td>128GB</td><td>4GB</td><td>Windows, Linux, Mac, 其他</td><td>适用于U盘和老旧设备，不支持大文件和大分区</td></tr><tr><td>NTFS</td><td>2TB</td><td>2TB</td><td>Windows, Linux (通过第三方软件支持)</td><td>常用于Windows操作系统，支持较大的文件和分区</td></tr><tr><td>FAT16</td><td>2GB</td><td>2GB</td><td>Windows, Linux, 其他</td><td>较老的文件系统，适合小容量设备，常见于早期的Windows版本</td></tr><tr><td>HPFS</td><td>2TB</td><td>2GB</td><td>OS/2</td><td>主要用于OS/2系统，适合较大的分区和文件</td></tr><tr><td>EXT2</td><td>4TB</td><td>2GB</td><td>Linux</td><td>早期Linux的标准文件系统，支持大文件，但没有日志功能</td></tr><tr><td>EXT3</td><td>4TB</td><td>2GB</td><td>Linux</td><td>EXT2的升级版，加入了日志功能，提高了可靠性</td></tr><tr><td>JFS</td><td>4PB</td><td>4PB</td><td>AIX</td><td>高性能文件系统，常用于大型企业级服务器，支持极大分区和文件大小</td></tr><tr><td>XFS</td><td>9EB（2^63）</td><td>9EB（2^63）</td><td>IRIX, Linux</td><td>64位文件系统，支持非常大的分区和文件，常用于高性能和大数据场景</td></tr><tr><td>exFAT</td><td>无限制（但实际应用中通常为256TB）</td><td>16EB</td><td>Windows, Mac, Linux (通过第三方软件支持)</td><td>适合闪存和移动存储设备，克服了FAT32的文件大小限制，不适合磁盘存储</td></tr></tbody></table><p>CentOS 4/5/6 都采用 Ext 2/3/4 文件系统，到了 CentOS 7 采用了 XFS系统，因为 CentOS 7 是容器的时代，docker不支持原来的文件系统。但都支持日志系统，日志系统指的是不会因为突然断电造成磁盘数据损坏，能够通过日志恢复磁盘文件。</p><p>Windows 10 使用NTFS，支持加密、压缩、权限控制等等，且还支持日志保持数据一致性，主流硬盘都是NTFS，专门给闪存使用的 ExFAT 属于是 FAT32 和 NTFS 的折中，同时支持Windows 和 Mac。</p><p>不同的文件系统区别在于</p><ul><li>兼容性：不同系统平台不一定识别，可能无法进行读写操作。例如 Windows上可能无法读取 XFS 文件系统的 U 盘；</li><li>容量大小：不同的文件系统对分区容量的支持以及文件数量及单个文件的容量支持有区别。例如以前的Windows 机械硬盘使用 FAT32 文件系统，该文件系统不支持单个文件超过4G。</li></ul><p>可以通过 <code>mkfs</code> 然后 TAB查看当前支持什么操作系统（实际上这个是进行分区文件系统格式化的命令）：</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221234934355.png" alt="image-20250221234934355"><figcaption aria-hidden="true">image-20250221234934355</figcaption></figure><p>以 <code>mkfs.xfs</code> 为例：</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250221235819691.png" alt="image-20250221235819691"><figcaption aria-hidden="true">image-20250221235819691</figcaption></figure><h2 id="挂载目录到分区">3. 挂载目录到分区</h2><h4 id="什么是挂载mount">什么是挂载（Mount）？</h4><p>想象你的电脑是一个大房子，房子里有很多房间（文件夹），比如<code>/home</code>（你的卧室）、<code>/etc</code>（工具箱）等。但房子里原本没有连接外部设备（比如U盘、硬盘、光盘）。<strong>挂载</strong>就像是在墙上开一扇门，把外部设备（比如U盘）连接到房子的某个房间（比如<code>/mnt/usb</code>），这样你就能通过这个房间访问外部设备的内容。</p><ul><li><strong>设备</strong>：U盘、硬盘、光盘等（物理存储介质）。</li><li><strong>挂载点</strong>：房子里的一扇门（比如 <code>/mnt/usb</code>这个空文件夹）。</li><li><strong>挂载操作</strong>：把设备通过这扇门连接到房子。</li></ul><h4 id="挂载的基本操作"><strong>挂载的基本操作</strong></h4><p>假设你插入一个U盘，系统识别它为<code>/dev/sdb1</code>（设备名可能不同）。你要把它挂载到<code>/mnt/usb</code> 这个空文件夹：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sdb1 /mnt/usb</span><br></pre></td></tr></table></figure><p>其结果就是我们进入 <code>/mnt/usb</code>就能看到U盘里的文件。但要注意，当我们挂载后，<code>/mnt/usb</code>不再是普通文件夹，而是U盘的“入口”。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo umount /mnt/usb</span><br></pre></td></tr></table></figure><p>卸载后，<code>/mnt/usb</code>恢复成普通空文件夹，U盘可以安全拔出。</p><h4 id="挂载后新建的文件在哪"><strong>挂载后新建的文件在哪？</strong></h4><p><strong>场景1：挂载后创建文件</strong></p><ol type="1"><li>挂载U盘到 <code>/mnt/usb</code>。</li><li>在 <code>/mnt/usb</code> 新建文件 <code>test.txt</code>。</li><li>卸载U盘。</li></ol><p><strong>问题</strong>：<code>test.txt</code> 存在哪里？<strong>答案</strong>：文件实际保存在U盘中！卸载后，文件依然在U盘里，下次挂载还能看到。</p><p><strong>场景2：换一个挂载点</strong></p><ol type="1"><li>将U盘挂载到 <code>/mnt/usb</code>，创建文件<code>test.txt</code>。</li><li>卸载后，重新挂载到 <code>/media/myusb</code>。</li><li>进入 <code>/media/myusb</code>，依然能看到<code>test.txt</code>。</li></ol><p><strong>结论</strong>：文件存储在设备（U盘）中，和挂载点无关。换挂载点只是换了一个“入口”。</p><h4 id="挂载点原有内容会怎样"><strong>挂载点原有内容会怎样？</strong></h4><p><strong>场景：挂载到非空文件夹</strong></p><p>假设 <code>/mnt/usb</code> 原本有一个文件 <code>old.txt</code>：</p><ol type="1"><li>挂载U盘到 <code>/mnt/usb</code>。</li><li>此时访问<code>/mnt/usb</code>，只能看到U盘的内容，<code>old.txt</code>被“隐藏”。</li><li>卸载后，<code>old.txt</code> 重新出现。</li></ol><p><strong>结论</strong>：挂载到非空文件夹时，原内容会被临时隐藏（但不会被删除！）。</p><h4 id="常见挂载类型"><strong>常见挂载类型</strong></h4><p><strong>挂载光盘</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/cdrom /mnt/cd</span><br></pre></td></tr></table></figure><p>光盘内容会出现在 <code>/mnt/cd</code>。</p><p><strong>挂载硬盘分区</strong></p><p>假设硬盘分区是 <code>/dev/sda2</code>，挂载到<code>/data</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/sda2 /data</span><br></pre></td></tr></table></figure><p>所有存到 <code>/data</code> 的文件实际保存在硬盘分区中。</p><p><strong>挂载网络存储</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount -t nfs 192.168.1.100:/shared /mnt/nfs</span><br></pre></td></tr></table></figure><p>通过网络访问远程文件夹。</p><h4 id="自动挂载开机自动挂载"><strong>自动挂载（开机自动挂载）</strong></h4><p>编辑 <code>/etc/fstab</code> 文件，添加一行配置：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1  /mnt/usb  ext4  defaults  0  0</span><br></pre></td></tr></table></figure><p>系统启动时会自动挂载设备到指定位置。另外还有一种方法，通过<code>blkid</code> 获取要挂载设备的 <code>UUID</code>，然后使用<code>UUID</code> 挂载。</p><h2 id="取消挂载">4. 取消挂载</h2><p>取消挂载使用 <code>umount</code>命令，需要注意的是，要取消挂载需要退出挂载点所在的目录，我们结合报错例子来学习，例如在执行下面的取消挂载命令时：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /data</span><br></pre></td></tr></table></figure></p><p>可能会出现下面的报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">umount: target is busy</span><br><span class="line">(In some cases useful info about processes that use</span><br><span class="line">the device is found by lsof(8) or fuser(1))</span><br></pre></td></tr></table></figure><h3 id="原因解析">原因解析</h3><ol type="1"><li><strong>文件系统被占用</strong><ul><li><strong>打开文件</strong>：有进程正在 <code>/data</code>目录下打开文件（例如日志文件、数据文件等），导致文件系统处于“忙”状态。</li><li><strong>当前工作目录</strong>：某个用户或服务的当前工作目录设置在<code>/data</code> 下。如果用户的 shell或程序正处于该目录，也会阻止卸载。</li></ul></li><li><strong>多用户环境的影响</strong><ul><li><strong>多用户使用</strong>：在多用户系统中，不同用户可能同时在<code>/data</code>挂载点下运行应用程序或脚本。即使你自己不在使用，其他用户的进程也可能占用该目录。</li><li><strong>服务使用</strong>：某些服务（如数据库、Web服务器或其他网络服务）可能将<code>/data</code>用作数据存储目录，并且这些服务可能由不同用户启动。</li></ul></li><li><strong>后台进程和网络端口</strong><ul><li>某些后台进程或守护进程可能绑定了特定端口，并且其配置文件或数据存放在<code>/data</code> 下。使用 <code>ps -ef | grep &lt;端口号&gt;</code>可帮助定位这些进程。</li></ul></li></ol><h3 id="解决方法">解决方法</h3><ol type="1"><li><p><strong>使用 lsof 命令查看占用情况</strong></p><ul><li><p>运行以下命令，查看哪些进程正在访问 <code>/data</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof /data</span><br></pre></td></tr></table></figure></li><li><p>此命令会列出所有打开 <code>/data</code>下文件的进程及其详细信息。</p></li></ul></li><li><p><strong>使用 fuser 命令确认进程</strong></p><ul><li><p>通过 fuser 命令可以直接看到占用挂载点的进程ID：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fuser -m /data</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>使用 ps 命令查找特定端口进程（如有需要）</strong></p><ul><li><p>如果怀疑某个服务在使用特定端口（例如数据库或 Web服务），可以使用：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep &lt;端口号&gt;</span><br></pre></td></tr></table></figure></li><li><p>这样可以帮助你定位使用该端口的进程，从而确认它们是否涉及到<code>/data</code> 目录的使用。</p></li></ul></li><li><p><strong>停止或终止相关进程</strong></p><ul><li><p>根据上面的命令输出，确认占用 <code>/data</code></p><p>的进程后，可以采取以下措施：</p><ul><li><p><strong>通知用户</strong>：在多用户环境中，先通知使用者退出或切换工作目录，确保不再访问<code>/data</code>。</p></li><li><p><strong>终止进程</strong>：如果确认进程可以安全终止，使用以下命令（注意要谨慎操作）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p><strong>使用延迟卸载（Lazy Unmount）</strong></p><ul><li><p>如果确定暂时无法中止所有进程，也可以采用延迟卸载的方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount -l /data</span><br></pre></td></tr></table></figure></li><li><p>此方法会立即断开挂载点，但会在进程不再使用时真正卸载。但需注意，这种方式可能会导致数据同步问题。</p></li></ul></li></ol><h1 id="四特殊设备文件">四、特殊设备文件</h1><h2 id="devnull-空设备黑洞">1. <code>/dev/null</code> ——空设备（黑洞）</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时总是返回 EOF（End of File）。</li><li>写入的数据会被直接丢弃，不占用存储空间。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>丢弃输出：常用于忽略命令的标准输出（<code>stdout</code>）或错误输出（<code>stderr</code>）。</p></li><li><p>例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> &gt; /dev/null   <span class="comment"># 丢弃 ls 命令的标准输出</span></span><br><span class="line"><span class="built_in">ls</span> 2&gt; /dev/null  <span class="comment"># 丢弃 ls 命令的错误输出</span></span><br><span class="line"><span class="built_in">ls</span> &gt; /dev/null 2&gt;&amp;1  <span class="comment"># 同时丢弃标准输出和错误输出</span></span><br></pre></td></tr></table></figure></li><li><p>作为空文件输入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /dev/null &gt; file.txt  <span class="comment"># 清空 file.txt</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><hr><h2 id="devzero-无限输出零字节">2. <code>/dev/zero</code> ——无限输出零字节</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时会不断返回 <code>0x00</code>（空字节）。</li><li>适用于生成填充数据（例如创建大文件）。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>创建特定大小的文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=file.bin bs=1M count=100</span><br></pre></td></tr></table></figure><p>该命令创建一个 100MB 的全零文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file.bin</span><br></pre></td></tr></table></figure></li><li><p>初始化文件系统：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.ext4 /dev/zero  <span class="comment"># 格式化磁盘时用于填充数据</span></span><br></pre></td></tr></table></figure></li><li><p>用于共享内存（如 <code>mmap</code>）或虚拟内存文件系统（如<code>tmpfs</code>）。</p></li></ul></li></ul><h2 id="devrandom-高质量随机数生成器">3. <code>/dev/random</code> ——高质量随机数生成器</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时返回加密安全的随机数据（由环境噪声等熵源提供）。</li><li>如果熵池（entropypool）不足，读取可能会阻塞（等待更多随机熵）。</li><li>适用于生成高质量的加密密钥。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>生成安全随机数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">head</span> -c 16 /dev/random | <span class="built_in">base64</span>  <span class="comment"># 生成 16 字节的随机数据并编码</span></span><br></pre></td></tr></table></figure></li><li><p>生成随机密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /dev/random | <span class="built_in">tr</span> -dc <span class="string">&#x27;A-Za-z0-9&#x27;</span> | <span class="built_in">head</span> -c 12</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="devurandom-非阻塞随机数生成器">4. <code>/dev/urandom</code> ——非阻塞随机数生成器</h2><ul><li><p><strong>特点</strong></p><ul><li>读取时返回伪随机数，熵不足时不会阻塞（不同于<code>/dev/random</code>）。</li><li>适用于大多数非极端安全需求的随机数生成场景。</li></ul></li><li><p><strong>应用</strong></p><ul><li><p>生成随机文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/urandom of=random.bin bs=1M count=10</span><br></pre></td></tr></table></figure><p>生成一个 10MB 的随机文件。</p></li><li><p>生成随机密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">base64</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong><code>/dev/random</code> vs<code>/dev/urandom</code></strong></p><table><colgroup><col style="width: 10%"><col style="width: 38%"><col style="width: 50%"></colgroup><thead><tr><th>特性</th><th><code>/dev/random</code></th><th><code>/dev/urandom</code></th></tr></thead><tbody><tr><td>是否阻塞</td><td>是（熵池不足时）</td><td>否</td></tr><tr><td>安全性</td><td>高（适用于加密密钥）</td><td>较高（但不适用于极端安全需求）</td></tr><tr><td>适用场景</td><td>需要高质量随机数，如密钥生成</td><td>普通随机需求，如随机 ID、随机测试数据</td></tr></tbody></table><p><strong>结论：</strong></p><ul><li><code>/dev/random</code> 适用于生成高安全性密钥（如 GPG/SSH密钥）。</li><li><code>/dev/urandom</code> 适用于一般随机数需求（如 sessionID）。</li></ul><h1 id="五文件系统链接与-raid-技术详解">五、文件系统、链接与 RAID技术详解</h1><p>下面将详细介绍inode、块（block）、硬链接、文件删除原理、软链接、硬链接。</p><h2 id="inode-与文件系统">1. inode 与文件系统</h2><p><strong>inode（Index Node）</strong>：是 Unix/Linux文件系统中用于存储文件元数据（metadata）的数据结构。它记录了文件的所有属性信息（如所有者、权限、时间戳、文件大小、数据块指针等），但不包含文件名。换句话说，Linux的文件内容其实是包含了文件名和元数据两个部分的，元数据可以通过<code>stat</code>命令查看得到。一个新的磁盘在格式化文件系统后存在两个存储空间，一个叫做<code>inode</code> 存储空间（存储元数据），一个叫做 <code>block</code>存储空间（存储文件数据），创建文件系统之后 <code>inode</code> 和<code>block</code> 的数量就会固定下来。Linux 读取文件内容是通过<code>文件名 &gt; inode 编号 &gt; block 的顺序</code> 来读取的。</p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311223710806.png" alt="image-20250311223710806"><figcaption aria-hidden="true">image-20250311223710806</figcaption></figure><h3 id="文件与-inode-的关系">文件与 inode 的关系</h3><ul><li><strong>文件数据与 inode</strong>：<ul><li>每个文件在创建时都会分配一个 inode，inode 存储文件的元数据。</li><li>文件的数据实际存放在数据块中，而 inode中包含指向这些数据块的指针。</li></ul></li><li><strong>目录与 inode</strong>：<ul><li>目录本身也是一个特殊类型的文件，其内容是文件名和对应 inode编号的映射表。</li><li>当你通过文件名访问文件时，系统实际上先通过目录查找对应的 inode编号，再根据 inode 获取文件的相关信息和数据。</li></ul></li></ul><h3 id="块block">块（block）</h3><ul><li><strong>块的概念</strong>：<ul><li>硬盘上的数据以块为单位存储。块是文件系统读写的基本单位，其大小通常在512 字节到 4KB 之间，具体取决于文件系统的设置。</li><li>inode 中的指针正是指向这些块的位置。</li></ul></li><li><strong>块在性能上的影响</strong>：<ul><li>块的大小会影响文件存储的效率与性能。过小可能导致大量索引；过大则可能浪费存储空间（内部碎片）。</li></ul></li></ul><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311235850437.png" alt="image-20250311235850437"><figcaption aria-hidden="true">image-20250311235850437</figcaption></figure><h2 id="链接link硬链接与软链接">2. 链接（Link）：硬链接与软链接</h2><h3 id="硬链接hard-link">硬链接（Hard Link）</h3><p>硬链接是多个目录项（文件名）指向同一个inode。也就是说，同一个文件的多个名字都指向同一组数据和属性，其特点是：</p><ul><li>共享 inode：硬链接和原始文件共享同一个inode，所以它们是完全等价的。</li><li>不能跨文件系统：硬链接只能在同一个文件系统内建立。</li><li>不能对目录建立硬链接（防止循环引用）。</li><li>当删除一个硬链接时，只是删除了目录中的一个引用。如果该 inode的链接计数不为 0，则文件数据仍然保留。</li><li>只有当所有指向该 inode 的硬链接都被删除后，系统才真正回收 inode和数据块。</li></ul><h3 id="软链接符号链接symbolic-link">软链接（符号链接，SymbolicLink）</h3><p>软链接是一个特殊类型的文件，其中存储了另一个文件或目录的路径，其特点是：</p><ul><li>不共享 inode：软链接有自己的 inode，其内容指向目标文件的路径。</li><li>可以跨文件系统：软链接可以引用其他文件系统上的文件或目录。</li><li>如果目标文件被删除，软链接就会变成“悬挂链接”（danglinglink），即指向不存在的目标。</li></ul><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311234336552.png" alt="image-20250311234336552"><figcaption aria-hidden="true">image-20250311234336552</figcaption></figure><h2 id="目录的链接数"><strong>3. 目录的链接数</strong></h2><p>在 Linux 中，<strong>目录的链接数</strong>（linkcount）表示有多少个硬链接指向该目录。可以通过 <code>ls -ld</code>来查看：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -ld 目录名</span><br></pre></td></tr></table></figure><h3 id="目录的硬链接数">目录的硬链接数</h3><ul><li><p>普通目录</p><p>（非空目录）：硬链接数 = 2 + 该目录下的子目录个数</p><ul><li><code>.</code> 指向自身（1 个链接）</li><li><code>..</code> 存在于每个子目录（父目录的链接数 +1）</li><li>目录下的每个子目录都会在父目录中创建一个<code>..</code>，增加父目录的链接数。</li></ul></li><li><p><strong>根目录 <code>/</code></strong>：其硬链接数等于 2 +<code>/</code> 下的一级子目录数量。</p></li></ul><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> test_dir</span><br><span class="line"><span class="built_in">ls</span> -ld test_dir</span><br><span class="line"><span class="comment"># 输出类似：</span></span><br><span class="line"><span class="comment"># drwxr-xr-x 2 user user 4096 Sep 26 12:00 test_dir</span></span><br><span class="line"><span class="comment"># 其中 `2` 表示当前目录有 2 个硬链接（自身 `.` 和父目录 `..`）</span></span><br></pre></td></tr></table></figure><h3 id="子目录的影响">子目录的影响</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> test_dir/sub_dir</span><br><span class="line"><span class="built_in">ls</span> -ld test_dir</span><br><span class="line"><span class="comment"># 硬链接数增加到 3，因为 `sub_dir` 内部有 `..` 指向 `test_dir`</span></span><br></pre></td></tr></table></figure><p><strong>总结：</strong></p><ul><li><strong>空目录的硬链接数是 2</strong>（自身 <code>.</code> +父目录的 <code>..</code>）。</li><li><strong>每增加一个子目录，父目录的硬链接数增加 1</strong>。</li></ul><h2 id="文件删除原理">4. 文件删除原理</h2><ul><li><p><strong>目录项删除</strong>：当删除文件时，实际上是从目录中移除了对该文件inode 的引用（即减少了 inode 的链接计数）。</p></li><li><p><strong>数据实际删除</strong>：只有当 inode的链接计数归零时，操作系统才会将该 inode和对应的数据块标记为可回收，从而真正释放磁盘空间。</p></li><li><p><strong>缓存与文件句柄</strong>：如果某个进程已打开文件，即使目录项被删除，该文件仍可被进程读取或写入，直到文件描述符关闭后，数据才会最终释放。</p></li><li><p><strong>移动和删除文件对软硬链接的影响：</strong></p><figure><img src="/Linux%20%E7%A3%81%E7%9B%98%E7%AE%A1%E7%90%86/image-20250311235231646.png" alt="image-20250311235231646"><figcaption aria-hidden="true">image-20250311235231646</figcaption></figure></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;Disk issues are rarely “just one command”: partition tables (MBR vs.
GPT), filesystems and mounting, capacity expansion (often via LVM), and
even “why space doesn’t come back after deleting files” are all governed
by concrete mechanics. This post connects the full operational path—from
identifying a new disk, partitioning, formatting, mounting, and
expanding, to troubleshooting common failures—while also covering the
underlying concepts that save you in production (RAID basics, special
devices under &lt;code&gt;/dev&lt;/code&gt;, inode and hard/soft links, and deletion
semantics). The goal is to make you comfortable running the end-to-end
workflow on a real machine and understanding what the system is doing at
each step.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>LAMP 与阿里云服务器详解</title>
    <link href="https://chenk.top/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/"/>
    <id>https://chenk.top/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/</id>
    <published>2025-02-15T16:00:00.000Z</published>
    <updated>2026-01-28T01:07:35.752Z</updated>
    
    <content type="html"><![CDATA[<p>把一台刚买的阿里云 ECS 从“能 SSH登录”变成“公网可访问、可稳定跑站点”的服务器，中间最容易卡在三件事：网络放行（安全组/防火墙）、服务联动（Apache–PHP–MySQL的请求链路）以及权限与版本（目录权限、PHP版本与扩展）。这篇文章先用架构图把 LAMP的工作流讲清楚，然后按可复现的顺序完成：安全组与端口配置、基础环境安装与验证、Apache/MySQL/PHP的安装与关键配置，最后给出 Discuz部署与源码编译安装的整套流程（含清理旧环境、依赖准备、服务自启与常见排错点），让你从0 到 1 把一套传统 Web 栈在云上真正跑起来。</p><span id="more"></span><p>LAMP 是 Linux 服务器上的一套经典 Web 服务器架构，由<strong>Linux</strong>（操作系统）、<strong>Apache</strong>（Web服务器）、<strong>MySQL</strong>（数据库）和<strong>PHP/Python/Perl</strong>（动态脚本语言）组成。阿里云服务器提供了强大的计算资源，使得用户可以在云环境中搭建LAMP 服务器来部署 Web 应用。</p><hr><h1 id="一lamp-架构概述">一、LAMP 架构概述</h1><p>LAMP 是构建动态网站和 Web应用的主流架构。它的每个组件在架构中发挥特定作用：</p><ul><li><strong>Linux</strong>：作为服务器操作系统，提供稳定的运行环境。</li><li><strong>Apache</strong>：作为 Web 服务器，处理 HTTP请求并将网页内容返回给客户端。</li><li><strong>MySQL</strong>：提供数据库服务，用于存储网站数据。</li><li><strong>PHP、Python、Perl</strong>：用于动态生成网页，与 MySQL交互，处理用户请求。</li></ul><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/420px-LAMP_software_bundle.svg.png" alt="img"><figcaption aria-hidden="true">img</figcaption></figure><p>下图展示了 LAMP 架构的工作流程：</p><ol type="1"><li>用户访问网站，浏览器向 Apache 服务器发送 HTTP 请求。</li><li>Apache 解析请求并调用 PHP 处理逻辑。</li><li>PHP 脚本查询 MySQL 数据库获取数据。</li><li>数据返回给 PHP 处理，并最终由 Apache 服务器返回给用户。</li></ol><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/ee8c173e981c46068d93961c484c43e2.png" alt="LAMP架构_lamp具体结构包括-CSDN博客"><figcaption aria-hidden="true">LAMP架构_lamp具体结构包括-CSDN博客</figcaption></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/992547-20170619140819648-1336856462.png" alt="LAMP架构的详细内容以及通信过程- Nice_keep-going - 博客园"><figcaption aria-hidden="true">LAMP架构的详细内容以及通信过程-Nice_keep-going - 博客园</figcaption></figure><h1 id="二阿里云服务器概述与网络配置">二、阿里云服务器概述与网络配置</h1><p>阿里云服务器（ECS）为用户提供弹性计算资源，并支持多种操作系统（如Ubuntu）。在阿里云环境中，关键的网络配置包括公网 IP与防火墙安全组设置。下面是云服务器控制台的监控界面：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211211700378.png" alt="image-20250211211700378"><figcaption aria-hidden="true">image-20250211211700378</figcaption></figure><h2 id="阿里云服务器基础">1. 阿里云服务器基础</h2><ul><li><p><strong>弹性扩展</strong>：根据实际需求调整CPU、内存、带宽等资源。</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211211940966.png" alt="image-20250211211940966"><figcaption aria-hidden="true">image-20250211211940966</figcaption></figure></li><li><p><strong>公网IP</strong>：使服务器可以被外部访问。你可以在阿里云控制台为 ECS实例分配公网 IP。</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211212019600.png" alt="image-20250211212019600"><figcaption aria-hidden="true">image-20250211212019600</figcaption></figure></li><li><p><strong>安全组（防火墙）</strong>：阿里云提供安全组管理工具，用于配置允许哪些端口和IP 能访问你的服务器。</p></li></ul><h2 id="防火墙与公网-ip-配置">2. 防火墙与公网 IP 配置</h2><h3 id="公网-ip-配置">公网 IP 配置</h3><p>在阿里云 ECS 控制台： - 为实例分配或绑定公网 IP。 -在实例信息中查看公网 IP，并通过浏览器访问测试。</p><h3 id="安全组规则设置">安全组规则设置</h3><p>在 ECS 控制台的安全组配置中，添加以下入站规则： -<strong>SSH</strong>：端口 22（允许远程登录）。 -<strong>HTTP</strong>：端口 80（用于网站访问）。 -<strong>HTTPS</strong>：端口 443（用于安全网站访问）。 - 可根据需要开放MySQL（3306）、FTP 等端口。</p><p>默认安全组配置如下：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211154055070.png" alt="image-20250211154055070"><figcaption aria-hidden="true">image-20250211154055070</figcaption></figure><p>配置方式如下：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221452657.png" alt="image-20250211221452657"><figcaption aria-hidden="true">image-20250211221452657</figcaption></figure><p>配置结果如下：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221531005.png" alt="image-20250211221531005"><figcaption aria-hidden="true">image-20250211221531005</figcaption></figure><p><strong>或在服务器上使用 iptables 命令手动配置：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 允许 HTTP 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"># 允许 HTTPS 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT</span><br><span class="line"># 允许 SSH 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"># 保存规则（Ubuntu 下使用 iptables-persistent）</span><br><span class="line">sudo netfilter-persistent save</span><br></pre></td></tr></table></figure><h1 id="三lamp-环境搭建ubuntu-实例">三、LAMP 环境搭建（Ubuntu实例）</h1><p>在阿里云的 Ubuntu 服务器上，搭建 LAMP 环境主要包括安装 Apache、MySQL和 PHP，并进行简单配置与验证。</p><h2 id="准备工作">0. 准备工作</h2><p>在开始之前，我们一般要关闭所有防火墙（内置防火墙和 Linux的软件防火墙）。</p><p>第一步就是关闭<code>selinux</code>，这是美国航空安全局开发的内置防火墙。我们首先可以通过<code>getenforce</code> 查询 <code>selinux</code> 状态，但基本只有CentOS8 会有比较多的 <code>seinux</code> 的策略，CentOS7不用。我们可以修改其默认配置，永久禁止其开机自启：</p><p>第二步是关闭内置的 <code>firewalld</code> 以及清空<code>iptables</code> 规则：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h2 id="安装-apache-web-服务器">1. 安装 Apache Web 服务器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install apache2 -y</span><br><span class="line"></span><br><span class="line"># 或者在CentOS里</span><br><span class="line">yum install httpd -y</span><br></pre></td></tr></table></figure><p>启动并设置 Apache 开机自启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start apache2</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> apache2</span><br></pre></td></tr></table></figure><p>验证：在浏览器访问 <code>http://&lt;公网_IP&gt;/</code> 应显示 Apache默认欢迎页面。</p><p>⚠️注意，如果之前没有配置安全组通过 80 端口，会显示：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221630066.png" alt="image-20250211221630066"><figcaption aria-hidden="true">image-20250211221630066</figcaption></figure><p>按前面说的配置一下安全组就行，最终会显示如下页面：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221716957.png" alt="image-20250211221716957"><figcaption aria-hidden="true">image-20250211221716957</figcaption></figure><p>下面为 CentOS 下的 Apache 服务器启动以及测试方式：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211220450481.png" alt="image-20250211220450481"><figcaption aria-hidden="true">image-20250211220450481</figcaption></figure><blockquote><p><code>curl ifconfig.me</code> 可以拿到自己的 ip 地址</p></blockquote><h2 id="mysql-数据库">2. MySQL 数据库</h2><h3 id="安装">安装</h3><p>命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mysql-server -y</span><br></pre></td></tr></table></figure><p>运行安全安装向导：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure><p>按照提示设置 MySQL root 密码，移除匿名用户，禁止远程 root 登录。</p><p>验证：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></table></figure><p>在阿里云服务器安装时，默认的阿里云源是没有 <code>mysql</code>的，只有 <code>mariadb</code>：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211222133896.png" alt="image-20250211222133896"><figcaption aria-hidden="true">image-20250211222133896</figcaption></figure><p>我们可以给服务器换源：</p><p>首先进入到 <code>/etc/yum.repos.d</code>，进行如下操作：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211225358267.png" alt="image-20250211225358267"><figcaption aria-hidden="true">image-20250211225358267</figcaption></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm </span><br></pre></td></tr></table></figure><p>查看 <code>mysql-community.repo</code> 文件：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211225836835.png" alt="image-20250211225836835"><figcaption aria-hidden="true">image-20250211225836835</figcaption></figure><p>随后运行以下命令安装即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mysql-community-server</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232057979.png" alt="image-20250211232057979"><figcaption aria-hidden="true">image-20250211232057979</figcaption></figure><p>可以输入 <code>mysql_secure_installation</code> 来进行密码设置：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232544886.png" alt="image-20250211232544886"><figcaption aria-hidden="true">image-20250211232544886</figcaption></figure><p>登录后可以查看一些基本信息如下：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232802711.png" alt="image-20250211232802711"><figcaption aria-hidden="true">image-20250211232802711</figcaption></figure><blockquote><p>当使用源码编译的方式安装 mysql 时如果系统中没有安装 openssl或其开发头文件和库，就会遇到报错<strong>缺少openssl</strong>，这时我们需要做两步：</p><ol type="1"><li><p><strong>删除编译的目录</strong>：编译失败后，通常会有一个部分完成的目录（即使没有完全成功安装），此时需要删除该目录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /path/to/mysql/source/directory</span><br></pre></td></tr></table></figure><p>删除这个目录，确保不会使用到损坏的或不完整的文件。</p></li><li><p><strong>安装 openssl</strong>：确保系统中安装了 openssl和相关的开发工具。如果缺少开发头文件，还需要安装 openssl-devel 包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl openssl-devel</span><br></pre></td></tr></table></figure></li><li><p><strong>重新编译 MySQL</strong>：在安装了 openssl 之后，重新进入MySQL 源代码目录，开始新的编译安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/mysql/source</span><br><span class="line">./configure  <span class="comment"># 配置 MySQL 编译选项</span></span><br><span class="line">make         <span class="comment"># 编译 MySQL</span></span><br><span class="line">make install <span class="comment"># 安装 MySQL</span></span><br></pre></td></tr></table></figure></li></ol></blockquote><h3 id="配置与远程访问">配置与远程访问</h3><p>现在我们可以对 MySQL 数据库进行配置与远程访问</p><p><strong>1. 修改 MySQL 绑定地址</strong></p><p>编辑 MySQL 配置文件： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure></p><p>找到 bind-address 字段，将其改为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind-address = 0.0.0.0</span><br></pre></td></tr></table></figure><p>保存后退出编辑器，然后重启 MySQL 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart mysql</span><br></pre></td></tr></table></figure><p><strong>2. 创建远程访问用户</strong></p><p>登录 MySQL 客户端：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><p>在 MySQL 提示符下，执行以下 SQL 语句：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;yourpassword&#x27;</span>;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>退出 MySQL。</p><p><strong>3. 安全注意</strong></p><p>确保安全组允许 MySQL 端口（3306）的访问，或通过 SSH 隧道访问 MySQL服务。</p><h2 id="php-及相关模块">3. PHP 及相关模块</h2><h3 id="安装-1">安装</h3><p>命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install php libapache2-mod-php php-mysql -y</span><br><span class="line"><span class="comment"># CentOS下</span></span><br><span class="line">yum install php -y</span><br></pre></td></tr></table></figure><p>验证 PHP 安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 5.4.16 (cli) (built: Apr  1 2020 04:07:17) </span></span><br><span class="line"><span class="comment"># Copyright (c) 1997-2013 The PHP Group</span></span><br><span class="line"><span class="comment"># Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies</span></span><br></pre></td></tr></table></figure><h3 id="创建页面">创建页面</h3><p>为了确认 PHP 环境安装成功，我们可以创建一个简单的<code>phpinfo()</code> 页面。</p><p><strong>1. 创建 <code>phpinfo.php</code> 测试页面</strong></p><p>将以下内容写入 <code>/var/www/html/phpinfo.php</code>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;?php phpinfo(); ?&gt;&quot; | sudo tee /var/www/html/phpinfo.php</span><br></pre></td></tr></table></figure></p><p><strong>2. 访问测试页面</strong></p><p>在浏览器中访问：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;公网_IP&gt;/phpinfo.php</span><br></pre></td></tr></table></figure><p>如果页面显示 PHP 的详细配置信息，说明 PHP 安装正确并且与 Apache正常集成。（访问不成功可以尝试<code>systemctl restart httpd</code>）</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212000319587.png" alt="image-20250212000319587"><figcaption aria-hidden="true">image-20250212000319587</figcaption></figure><p>或者可以尝试些别的，我们可以使用 PHP的数组、随机函数以及内置的日期函数生成动态内容</p><ul><li>利用 <code>array_rand()</code> 随机选择名言</li><li>使用 <code>date()</code> 函数显示当前时间</li><li>输出简单的 HTML 页面</li></ul><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212000842498.png" alt="image-20250212000842498"><figcaption aria-hidden="true">image-20250212000842498</figcaption></figure><h1 id="四discuz-论坛部署">四、Discuz! 论坛部署</h1><p>Discuz! 是一个基于 PHP 和 MySQL的开源论坛程序，常用于搭建社区网站。下面介绍如何在 LAMP 环境中部署Discuz!。</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212003942527.png" alt="image-20250212003942527"><figcaption aria-hidden="true">image-20250212003942527</figcaption></figure><h2 id="下载并解压-discuz-安装包">1. 下载并解压 Discuz! 安装包</h2><p>我们要进入 Apache 的默认目录，可以通过 <code>rpm -ql</code>来查找：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211235946415.png" alt="image-20250211235946415"><figcaption aria-hidden="true">image-20250211235946415</figcaption></figure><p>上面那些 <code>share</code>的都可以不用管，只有最后一行数据是有用的，也就是我们要找的 Apache的默认目录，进入 Apache 默认目录并下载：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html</span><br><span class="line">wget https://download.comsenz.com/DiscuzX/3.4/Discuz_X3.4_SC_UTF8.zip</span><br></pre></td></tr></table></figure><p>解压安装包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip Discuz_X3.4_SC_UTF8.zip</span><br></pre></td></tr></table></figure><p>将解压后的内容移动到网站根目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> upload/* /var/www/html/</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005140326.png" alt="image-20250212005140326"><figcaption aria-hidden="true">image-20250212005140326</figcaption></figure><h2 id="安装-discuz">2. 安装 Discuz!</h2><p>在浏览器中访问：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;公网_IP&gt;/install/</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005209279.png" alt="image-20250212005209279"><figcaption aria-hidden="true">image-20250212005209279</figcaption></figure><p>发现报错：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005412101.png" alt="image-20250212005412101"><figcaption aria-hidden="true">image-20250212005412101</figcaption></figure><p>下面开始升级 PHP 版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 更新系统并安装必要的软件包</span></span><br><span class="line">sudo yum update -y  <span class="comment"># 更新系统</span></span><br><span class="line">sudo yum install -y epel-release yum-utils  <span class="comment"># 安装 EPEL 仓库和 yum-utils 工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装 Remi 仓库（CentOS 7 专用）</span></span><br><span class="line">sudo yum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm  <span class="comment"># 添加 Remi 仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启用所需的 PHP 版本</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">enable</span> remi-php81  <span class="comment"># 这里以 PHP 8.1 为例，其他版本请修改对应的数字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 升级或安装 PHP 及其常见扩展</span></span><br><span class="line">sudo yum install -y php php-cli php-common php-mbstring php-xml php-mysqlnd php-fpm php-opcache php-curl php-gd php-zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 验证 PHP 版本是否正确安装</span></span><br><span class="line">php -v  <span class="comment"># 查看 PHP 版本，确认升级是否成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 选择正确的 PHP 版本（如果 `php -v` 仍然是旧版本）</span></span><br><span class="line">sudo alternatives --config php  <span class="comment"># 可能需要手动选择 PHP 版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 重启 Web 服务器以应用新 PHP 版本</span></span><br><span class="line">sudo systemctl restart httpd  <span class="comment"># 如果使用的是 Apache</span></span><br><span class="line">sudo systemctl restart php-fpm  <span class="comment"># 如果使用的是 Nginx+PHP-FPM</span></span><br><span class="line">sudo systemctl restart nginx  <span class="comment"># 如果 Nginx 也需要重启</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 确保 PHP-FPM 正常运行</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> php-fpm  <span class="comment"># 开机自启 PHP-FPM</span></span><br><span class="line">sudo systemctl status php-fpm  <span class="comment"># 检查 PHP-FPM 运行状态</span></span><br></pre></td></tr></table></figure><p>经过一系列猛如虎的操作，PHP升级成功了，环境检查也不再报错了：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010201948.png" alt="image-20250212010201948"><figcaption aria-hidden="true">image-20250212010201948</figcaption></figure><p>但下面又报错了，问题出在了目录权限，下面我们就把目录权限做修改。</p><h2 id="配置-apache-目录权限">3. 配置 Apache 目录权限</h2><p>设置文件所有者为 www-data，并赋予适当权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 ./*</span><br></pre></td></tr></table></figure><h2 id="image-20250212010501483"><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010501483.png" alt="image-20250212010501483"></h2><p>现在终于大功告成：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010528759.png" alt="image-20250212010528759"><figcaption aria-hidden="true">image-20250212010528759</figcaption></figure><p>如果提示少了驱动，我们可以通过 <code>yum install php-mysqli -y</code>安装</p><p>按照安装向导输入数据库信息：</p><ul><li><strong>数据库地址</strong>：localhost</li><li><strong>数据库名称</strong>：discuz</li><li><strong>数据库用户</strong>：admin</li><li><strong>数据库密码</strong>：yourpassword</li></ul><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212011051827.png" alt="image-20250212011051827"><figcaption aria-hidden="true">image-20250212011051827</figcaption></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212011102231.png" alt="image-20250212011102231"><figcaption aria-hidden="true">image-20250212011102231</figcaption></figure><p>完成安装后，即可进入 Discuz! 后台管理，进一步配置论坛设置。</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212013221831.png" alt="image-20250212013221831"><figcaption aria-hidden="true">image-20250212013221831</figcaption></figure><h1 id="五源码编译安装">五、源码编译安装</h1><p>我们现在要搞事情，我们现在准备清空整个 LAMP（Linux + Apache + MySQL +PHP）环境并从头开始重新用源码编译，以下是详细的步骤指南。</p><p>MySQL 5.6.31 + PHP 7.2.17</p><h2 id="清空原有环境">1. 清空原有环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 停止 Apache 和 MySQL 服务</span></span><br><span class="line">sudo systemctl stop httpd</span><br><span class="line">sudo systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 卸载 Apache、MySQL 和 PHP</span></span><br><span class="line">sudo yum remove httpd mysql mysql-server php php-cli php-fpm php-mysqlnd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除 Apache、MySQL 和 PHP 配置文件和数据文件</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/httpd</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/www</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/mysql</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/my.cnf</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 删除 MySQL 和 Apache 用户和组，组可能不存在，会报错，但不用管</span></span><br><span class="line">sudo userdel mysql</span><br><span class="line">sudo groupdel mysql</span><br><span class="line">sudo userdel apache</span><br><span class="line">sudo groupdel apache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 删除残留的依赖和配置文件</span></span><br><span class="line">sudo yum autoremove</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212115847770.png" alt="image-20250212115847770"><figcaption aria-hidden="true">image-20250212115847770</figcaption></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212115742880.png" alt="image-20250212115742880"><figcaption aria-hidden="true">image-20250212115742880</figcaption></figure><h2 id="基础软件运行环境准备">2. 基础软件运行环境准备</h2><p>在重新安装之前，确保系统安装了编译所需的工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum groupinstall <span class="string">&quot;Development Tools&quot;</span></span><br><span class="line">sudo yum install -y gcc-c++ make cmake bison libaio-devel ncurses-devel zlib-devel openssl-devel</span><br></pre></td></tr></table></figure><p>还可以选择安装一些其他的开发包以避免可能存在的错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc patch libffi-devel python-devel bzip2-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel net-tools vim -y</span><br></pre></td></tr></table></figure><p>注意：在开始后续操作之前一定要关闭防火墙（<code>selinux</code> 和<code>firewalld</code>）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z yum.repos.d]<span class="comment"># systemctl status firewalld</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure><blockquote><p>下载太慢可以更换yum源或dns源或换网络环境</p></blockquote><h2 id="编译安装-mysql">3. 编译安装 MySQL</h2><blockquote><p>编译安装顺序：</p><ol type="1"><li>Apache 一定要先于 PHP</li><li>Apache 和 MySQL没有明显的依赖关系，先后无所谓</li><li>在 PHP 3.5 之前，MySQL必须先于 PHP 编译，因为 PHP需要实现连接数据库的功能，它通过 MySQL接口才能实现这一功能；在 3.5 之后PHP 已经集成了一套连接 MySQL 数据库的代码，编译顺序无所谓了</li></ol></blockquote><h3 id="创建-mysql-用户">创建 MySQL 用户</h3><p>用于给 MySQL 的数据、进程设置相关的 user 属主：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin mysql</span><br></pre></td></tr></table></figure><h3 id="下载-mysql">下载 MySQL</h3><p>首先我们要创建一个源码目录用于下载对应软件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> software-mysql</span><br><span class="line"><span class="built_in">cd</span> software-mysql</span><br></pre></td></tr></table></figure><p>我们可以在<a class="link" href="https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/">华为提供的库内<i class="fas fa-external-link-alt"></i></a>下载需要的MySQL 版本：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212171131843.png" alt="image-20250212171131843"><figcaption aria-hidden="true">image-20250212171131843</figcaption></figure><p>选择一个合适的版本：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202606094.png" alt="image-20250214202606094"><figcaption aria-hidden="true">image-20250214202606094</figcaption></figure><p>下载源码并解压缩：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/MySQL-5.6/mysql-5.6.49.tar.gz</span><br><span class="line">tar -xzvf mysql-5.6.49.tar.gz</span><br></pre></td></tr></table></figure><h3 id="编译安装">编译安装</h3><p>进入解压缩后的目录可以发现，这里没有我们之前看到的<code>configure</code>，只有 <code>cmake</code>，我们需要安装<code>cmake</code> 命令。然后我们需要在 MySQL 的源码目录下，执行 cmake命令以配置并生成 Makefile，然后编译源代码。可以将以下命令保存为<code>cmake.sh</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmake . \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">-DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">-DENABLE_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DMYSQL_TCP_PORT=3306 \</span><br><span class="line">-DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>下面是对这些参数的解释：</p><ul><li>-DCMAKE_INSTALL_PREFIX=/usr/local/mysql：指定 MySQL 安装路径</li><li>-DMYSQL_DATADIR=/usr/local/mysql/data：指定 MySQL 数据目录</li><li>-DENABLE_LOCAL_INFILE=1：启用 LOCAL 文件加载</li><li>-DWITH_INNOBASE_STORAGE_ENGINE=1：启用 InnoDB 存储引擎</li><li>-DMYSQL_TCP_PORT=3306：指定 MySQL 使用的 TCP 端口</li><li>-DDEFAULT_CHARSET=utf8mb4：指定默认字符集为 utf8mb4</li><li>-DDEFAULT_COLLATION=utf8mb4_general_ci：指定默认排序规则为utf8mb4_general_ci</li><li>-DWITH_EXTRA_CHARSETS=all：启用所有额外字符集</li><li>-DMYSQL_USER=mysql：指定 MySQL 的默认用户</li></ul><p>然后对文件需要修改权限，加入可执行权限，首先运行<code>cmake.sh</code></p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202711590.png" alt="image-20250214202711590"><figcaption aria-hidden="true">image-20250214202711590</figcaption></figure><p>运行成功如上图后，执行<code>make</code>，因为时间不是太久就直接选择前台执行了：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202440317.png" alt="image-20250214202440317"><figcaption aria-hidden="true">image-20250214202440317</figcaption></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214205348391.png" alt="image-20250214205348391"><figcaption aria-hidden="true">image-20250214205348391</figcaption></figure><p>运行成功后如上图所示，再执行 <code>make install</code>，就会发现<code>/usr/local/</code> 路径下多了 <code>mysql</code>这个文件夹，随后将文件夹里的 <code>bin</code> 目录添加到<code>~/.bashrc</code> 即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/local/mysql/bin</span><br></pre></td></tr></table></figure><p>保存并激活即可。</p><h3 id="删除旧文件残留">删除旧文件残留</h3><p>我们接下来要检查是否有旧的 <code>mysql</code>数据文件残留，发现存在我们将其进行移动备份：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214122846366.png" alt="image-20250214122846366"><figcaption aria-hidden="true">image-20250214122846366</figcaption></figure><h3 id="修改文件属主属组">修改文件属主属组</h3><p>可以看到现在文件的属主和属组都还是<code>root</code>，我们需要将其修改为 <code>mysql</code>：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214213331153.png" alt="image-20250214213331153"><figcaption aria-hidden="true">image-20250214213331153</figcaption></figure><h3 id="初始化-mysql">初始化 <code>mysql</code></h3><p>现在我们开始尝试连接 <code>mysql</code>客户端，但会报错，说无法连接到本地的 <code>mysql</code> 服务端：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214210714681.png" alt="image-20250214210714681"><figcaption aria-hidden="true">image-20250214210714681</figcaption></figure><p>Linux 的软件启动后会有两种形式提供给客户端去访问：</p><ol type="1"><li><code>ip:port</code> 形式，如<code>0.0.0.0:3306</code>，网络连接方式</li><li><code>socket</code> 本地套接字文件形式，本地进程套接字文件，启动<code>mysql</code>，提供它的本地连接进程文件<code>tmp/mysql.sock</code>，只要这个文件存在，<code>mysql</code>就是启动的</li></ol><p>总之就是 <code>mysql</code> 还没启动，因此此时首先要对<code>mysql</code> 数据库初始化，生成一些必备的数据文件，因为<code>mysql</code>要设置账号密码总得有一个库和表可以存储。具体操作如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-5.6.49]<span class="comment"># cd /usr/local/mysql</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql]<span class="comment"># ls ./scripts/</span></span><br><span class="line">mysql_install_db</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql]<span class="comment"># ./scripts/mysql_install_db --user=mysql</span></span><br><span class="line">Installing MySQL system tables...2025-02-14 21:36:08 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="keyword">for</span> more details).</span><br><span class="line">2025-02-14 21:36:08 0 [Note] Ignoring --secure-file-priv value as server is running with --bootstrap.</span><br><span class="line">2025-02-14 21:36:08 0 [Note] ./bin/mysqld (mysqld 5.6.49) starting as process 1270 ...</span><br><span class="line">2025-02-14 21:36:08 1270 [Note] InnoDB: Using atomics to ref count buffer pool pages</span><br><span class="line">2025-02-14 21:36:08 1270 [Note] InnoDB: The InnoDB memory heap is disabled</span><br></pre></td></tr></table></figure><p>运行一长串之后我们会看到两个 OK，这说明初始化成功：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214213731409.png" alt="image-20250214213731409"><figcaption aria-hidden="true">image-20250214213731409</figcaption></figure><h3 id="创建启动脚本">创建启动脚本</h3><p>因为我们是手动编译安装，还需要自己创建启动脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql</span><br></pre></td></tr></table></figure><p>我们可以查看这个文件：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214214619451.png" alt="image-20250214214619451"><figcaption aria-hidden="true">image-20250214214619451</figcaption></figure><p>此时使用 <code>service</code> 命令，会去读取 <code>/etc/init.d</code>下的脚本文件，启动 <code>mysql</code>：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214214835608.png" alt="image-20250214214835608"><figcaption aria-hidden="true">image-20250214214835608</figcaption></figure><h3 id="设置密码与登录">设置密码与登录</h3><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214215614743.png" alt="image-20250214215614743"><figcaption aria-hidden="true">image-20250214215614743</figcaption></figure><h2 id="编译安装-apache">4. 编译安装 Apache</h2><h3 id="安装依赖包-apr">安装依赖包 <code>apr</code></h3><p><code>apr</code>（Apache portable run-time Libraries，Apache可移植运行库），主要是为上层的应用程序提供一个可以跨越多操作系统平台的底层支持接口库。下载地址为：https://archive.apache.org/dist/apr/，进入该地址会有如下内容：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214220544809.png" alt="image-20250214220544809"><figcaption aria-hidden="true">image-20250214220544809</figcaption></figure><p>一直往下拉会有一些可以下载的安装包，具体的地址可以用下面的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/apr/apr-1.5.2.tar.bz2</span><br><span class="line">tar -xf apr-1.5.2.tar.bz2; <span class="built_in">cd</span> apr-1.5.2</span><br></pre></td></tr></table></figure><p>可能由于这个版本的一个 bug，这里我们需要修改一个配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim configure</span><br><span class="line"><span class="comment"># 修改 29605 行    ‘RM’ = &#x27;RM -f&#x27;   添加一个 -f 参数</span></span><br></pre></td></tr></table></figure><p>如果不指定配置参数，就会安装到默认路径<code>/usr/local</code>，一般推荐这些小的依赖库不要修改路径，我们直接<code>./configure</code>：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214221932200.png" alt="image-20250214221932200"><figcaption aria-hidden="true">image-20250214221932200</figcaption></figure><p>然后执行编译三部曲的后两步即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214222220789.png" alt="image-20250214222220789"><figcaption aria-hidden="true">image-20250214222220789</figcaption></figure><h3 id="安装基础库-apr-util">安装基础库 <code>apr-util</code></h3><p>完整的 APR（Apache可移植运行库）实际上包含了三个开发包：<code>apr</code>，<code>apr-util</code>和<code>apr-iconv</code>，每一个包分别独立开发，并拥有自己的版本。<code>apr-util</code>这个库中也是包含了一些常用的开发组件，这些组件与<code>apr</code> 目录下的相比，它们与 Apache的关系更加密切一些，比如存储段和存储段组、加密等。这个包还是在刚刚的https://archive.apache.org/dist/apr/ 下可以找到</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/apr/apr-util-1.5.4.tar.bz2</span><br><span class="line">tar -xf apr-util-1.5.4.tar.bz2; <span class="built_in">cd</span> apr-util-1.5.4</span><br></pre></td></tr></table></figure><p>然后还是三部曲，这里的 configure 要加个参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-apr=/usr/local/apr/bin/apr-1-config</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214224641704.png" alt="image-20250214224641704"><figcaption aria-hidden="true">image-20250214224641704</figcaption></figure><p>此时 <code>apr</code> 和 <code>apr-util</code> 库就生成了一些基础的Linux 文件（动态链接库，和 C 语言相关），我们需要告诉 Linux系统多了一些这些工具，Linux 才能读取到这些信息，才能给 Apache 调用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls /usr/local/apr/lib/</span></span><br><span class="line">apr.exp     aprutil.exp  libapr-1.la  libapr-1.so.0      libaprutil-1.a   libaprutil-1.so    libaprutil-1.so.0.5.4</span><br><span class="line">apr-util-1  libapr-1.a   libapr-1.so  libapr-1.so.0.5.2  libaprutil-1.la  libaprutil-1.so.0  pkgconfig</span><br></pre></td></tr></table></figure><blockquote><p>通常，库文件会被安装到标准的系统目录，如 <code>/lib</code>,<code>/lib64</code>, <code>/usr/lib/</code>, <code>/usr/lib64</code>等地方，这些路径是默认的库文件搜索路径，因此系统和应用程序能够找到它们。</p><p>但是，如果某个软件 <strong>A</strong>将库文件安装到一个非标准目录，例如<code>/usr/local/A/lib</code>，那么你需要将该路径添加到系统的动态链接库搜索路径中。否则，系统和其他程序将无法找到这个库文件。</p><p><code>ldconfig</code>是一个用于动态链接库管理的命令，它的主要作用是搜索系统中的共享动态链接库，并将它们添加到缓存中，以供程序使用。<code>ldconfig</code>会在以下路径中查找共享库：</p><ul><li>默认搜索路径：<code>/lib</code>, <code>/lib64</code>,<code>/usr/lib/</code>, <code>/usr/lib64</code></li><li>动态库配置文件：<code>/etc/ld.so.conf</code> 中列出的路径</li></ul><p>如果你将新的库文件安装到非标准路径（如<code>/usr/local/A/lib</code>），你需要通过以下方式更新搜索路径：</p><ol type="1"><li>编辑 <code>/etc/ld.so.conf</code> 或添加一个新的 <code>.conf</code>文件到 <code>/etc/ld.so.conf.d/</code> 目录。</li><li>运行 <code>ldconfig</code>命令，让系统知道这个新的路径，从而能够找到并使用该路径下的动态库。</li></ol></blockquote><p>具体命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/apr/lib&quot;</span> &gt;&gt; /etc/ld.so.conf</span><br><span class="line"><span class="built_in">cat</span> /etc/ld.so.conf</span><br><span class="line"><span class="comment"># include ld.so.conf.d/*.conf</span></span><br><span class="line"><span class="comment"># /usr/local/apr/lib</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者新建一个 .conf 文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/apr/lib&quot;</span> &gt; /etc/ld.so.conf.d/lamp.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><h3 id="编译-apache步骤">编译 Apache步骤</h3><p>回到刚刚的下载安装包的目录，再上一級找到 <code>httpd</code>获取链接进行 <code>wget</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/httpd/httpd-2.4.37.tar.bz2</span><br><span class="line">tar -xf httpd-2.4.37.tar.bz2; <span class="built_in">cd</span> httpd-2.4.37</span><br></pre></td></tr></table></figure><p>制作配置脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">--enable-modules=all \</span><br><span class="line">--enable-mods-shared=all \</span><br><span class="line">--enable-so \</span><br><span class="line">  --enable-rewrite \</span><br><span class="line">--with-pcre \</span><br><span class="line">--enable-ssl \</span><br><span class="line">--with-mpm=prefork \</span><br><span class="line">--with-apr=/usr/local/apr/bin/apr-1-config \</span><br><span class="line">--with-apr-util=/usr/local/apr/bin/apu-1-config</span><br></pre></td></tr></table></figure><p>添加执行权限并执行脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x apache-configure.sh</span><br><span class="line">./apache-configure.sh</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214233341542.png" alt="image-20250214233341542"><figcaption aria-hidden="true">image-20250214233341542</figcaption></figure><p>直接成功结果如上，最后 <code>make &amp; make install</code>即可，最后安装到了 <code>/usr/local/apache2</code> 下。</p><h3 id="修改配置文件">修改配置文件</h3><h4 id="语言支持">语言支持</h4><p>我们修改 <code>/usr/local/apache2/conf</code> 里的<code>httpd.conf</code> 的参数以获得中文语言支持，我们删除第 159 行以及481 行的注释即可：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215002204065.png" alt="image-20250215002204065"><figcaption aria-hidden="true">image-20250215002204065</figcaption></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215002456908.png" alt="image-20250215002456908"><figcaption aria-hidden="true">image-20250215002456908</figcaption></figure><p>我们会发现如果想要使用一些功能，只需要在这里取消一些功能的对应注释即可～</p><h4 id="php-支持">PHP 支持</h4><p>另外我们还需要开启 PHP 的插件，当有用户访问 PHP 程序时，Apache自动转发给 PHP 去解析，168 和 169 行的意思是以 <code>.php</code>结尾的文件都认为是 PHP 程序文件</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215004856276.png" alt="image-20250215004856276"><figcaption aria-hidden="true">image-20250215004856276</figcaption></figure><p>并且要设置当访问这台机器的时候，当什么都不添加时会访问磁盘上的<code>index.php</code> 文件：</p><p>原本是这样的：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215005511442.png" alt="image-20250215005511442"><figcaption aria-hidden="true">image-20250215005511442</figcaption></figure><p>要改成这样（谁在前面就先解析谁）：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215005537989.png" alt="image-20250215005537989"><figcaption aria-hidden="true">image-20250215005537989</figcaption></figure><p>这行参数的作用就是会让原本只是访问 <code>8.134.207.88</code>自动变成访问 <code>8.134.207.88/index.php</code>。</p><h4 id="html-文件路径">HTML 文件路径</h4><p>关于网站默认的首页 HTML 文件存放的目录路径由以下参数控制：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215010011089.png" alt="image-20250215010011089"><figcaption aria-hidden="true">image-20250215010011089</figcaption></figure><h4 id="修改子配置文件">修改子配置文件</h4><p>要修改该配置文件使得优先支持中文：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache2/conf/extra/httpd-languages.conf</span><br></pre></td></tr></table></figure><p>取消第 19 行的注释，将原本的 <code>DefaultLanguage nl</code> 修改为<code>DefaultLanguage zh-CN</code></p><p>以及调整第 79 行的优先级，将中文的优先级放在第一个：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LanguagePriority zh-CN en ca cs da de el eo es et fr he hr it ja ko ltz <span class="built_in">nl</span> nn no pl pt pt-BR ru sv <span class="built_in">tr</span> zh-TW</span><br></pre></td></tr></table></figure><h4 id="域名设置">域名设置</h4><p>可以在主配置文件的这里添加域名：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215010744599.png" alt="image-20250215010744599"><figcaption aria-hidden="true">image-20250215010744599</figcaption></figure><h2 id="编译安装-php">5. 编译安装 PHP</h2><h3 id="编译与安装">编译与安装</h3><p>这里比较简单，我们直接快速操作了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://museum.php.net/php7/php-7.2.17.tar.xz</span><br><span class="line">tar -xf php-7.2.17.tar.xz</span><br><span class="line"><span class="built_in">cd</span> php-7.2.17</span><br><span class="line">vim configure_php.sh</span><br></pre></td></tr></table></figure><p>在文件中写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">  --with-apxs2=/usr/local/apache2/bin/apxs \</span><br><span class="line">  --with-mysqli \</span><br><span class="line">  --with-pdo-mysql \</span><br><span class="line">  --with-zlib \</span><br><span class="line">  --with-curl \</span><br><span class="line">  --enable-zip \</span><br><span class="line">  --with-gd \</span><br><span class="line">  --with-freetype-dir \</span><br><span class="line">  --with-jpeg-dir \</span><br><span class="line">  --with-png-dir \</span><br><span class="line">  --enable-sockets \</span><br><span class="line">  --with-xmlrpc \</span><br><span class="line">  --enable-soap \</span><br><span class="line">  --enable-opcache \</span><br><span class="line">  --enable-mbstring \</span><br><span class="line">  --enable-mbregex \</span><br><span class="line">  --enable-pcntl \</span><br><span class="line">  --enable-shmop \</span><br><span class="line">  --enable-sysvmsg \</span><br><span class="line">  --enable-sysvsem \</span><br><span class="line">  --enable-sysvshm \</span><br><span class="line">  --enable-calendar \</span><br><span class="line">  --enable-bcmath</span><br></pre></td></tr></table></figure><p>然后依次执行<code>chmod +x configure_php.sh</code>、<code>./configure_php.sh</code> 与<code>make &amp;&amp; make install</code> 即可。</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215014045762.png" alt="image-20250215014045762"><figcaption aria-hidden="true">image-20250215014045762</figcaption></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215014117280.png" alt="image-20250215014117280"><figcaption aria-hidden="true">image-20250215014117280</figcaption></figure><h3 id="检查-apache是否支持php">检查 Apache是否支持PHP</h3><p>进入 Apache 的网页根目录<code>/usr/local/apache2/htdocs</code>，创建一个 PHP文件，查看是否支持：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215011611322.png" alt="image-20250215011611322"><figcaption aria-hidden="true">image-20250215011611322</figcaption></figure><p>启动 Apache：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z php-7.2.17]<span class="comment"># service apache start</span></span><br><span class="line">AH00558: httpd: Could not reliably determine the server<span class="string">&#x27;s fully qualified domain name, using 172.20.53.217. Set the &#x27;</span>ServerName<span class="string">&#x27; directive globally to suppress this message</span></span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215015006688.png" alt="image-20250215015006688"><figcaption aria-hidden="true">image-20250215015006688</figcaption></figure><p>查看对应的 IP 地址，访问正常：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215015140320.png" alt="image-20250215015140320"><figcaption aria-hidden="true">image-20250215015140320</figcaption></figure><p>由于默认端口和默认文件都已经配置好了，就不需要再写端口和<code>index.php</code> 了</p><h2 id="wordpress">6. WordPress</h2><p>下载源码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># wget https://cn.wordpress.org/wordpress-4.7.3-zh_CN.tar.gz</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># mkdir wordpress</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># mv wordpress-4.7.3-zh_CN.tar.gz  wordpress</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># cd wordpress/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># tar -zxf wordpress-4.7.3-zh_CN.tar.gz </span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># ls</span></span><br><span class="line">wordpress  wordpress-4.7.3-zh_CN.tar.gz</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># cp -a wordpress/* ../www/test_wordpress_blog/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># chown -R daemon.daemon ../www/test_wordpress_blog/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># rm -rf /usr/local/apache2/htdocs/*</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># mv ../www/test_wordpress_blog/* /usr/local/apache2/htdocs/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># ls /usr/local/apache2/htdocs/</span></span><br><span class="line">index.php    wp-activate.php     wp-comments-post.php  wp-cron.php        wp-load.php   wp-settings.php   xmlrpc.php</span><br><span class="line">license.txt  wp-admin            wp-config-sample.php  wp-includes        wp-login.php  wp-signup.php</span><br><span class="line">readme.html  wp-blog-header.php  wp-content            wp-links-opml.php  wp-mail.php   wp-trackback.php</span><br></pre></td></tr></table></figure><p>访问网站会有下面的内容：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020259972.png" alt="image-20250215020259972"><figcaption aria-hidden="true">image-20250215020259972</figcaption></figure><p>填写基本信息后发现我们还没有创建这个数据库：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020513590.png" alt="image-20250215020513590"><figcaption aria-hidden="true">image-20250215020513590</figcaption></figure><p>我们进入 MySQL 进行操作：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020803966.png" alt="image-20250215020803966"><figcaption aria-hidden="true">image-20250215020803966</figcaption></figure><p>注意我们需要回到前面修改我们前面创建的数据库名，使得数据库名与我们创建的能对得上：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020903213.png" alt="image-20250215020903213"><figcaption aria-hidden="true">image-20250215020903213</figcaption></figure><p>然后再执行一下傻瓜操作：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020921167.png" alt="image-20250215020921167"><figcaption aria-hidden="true">image-20250215020921167</figcaption></figure><p>然后执行完下面这一步就结束了：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215021153620.png" alt="image-20250215021153620"><figcaption aria-hidden="true">image-20250215021153620</figcaption></figure><p>一个漂亮的博客管理页面就做好啦：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215021254303.png" alt="image-20250215021254303"><figcaption aria-hidden="true">image-20250215021254303</figcaption></figure><hr><h1 id="六debug日志">六、<code>debug</code>日志</h1><h2 id="新版本-mysql-安装凉经">1. 新版本 MySQL 安装凉经</h2><p>这里我们创建文件夹的方式都一样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> software-mysql</span><br><span class="line"><span class="built_in">cd</span> software-mysql</span><br></pre></td></tr></table></figure><p>同样在<a class="link" href="https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/">华为提供的库内<i class="fas fa-external-link-alt"></i></a>下载需要的MySQL 版本，我们选择了较新版的 8.0.25：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212171518515.png" alt="image-20250212171518515"><figcaption aria-hidden="true">image-20250212171518515</figcaption></figure><p>下载源码并解压缩：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/MySQL-8.0/mysql-8.0.25.tar.gz</span><br><span class="line">tar -xzvf mysql-8.0.25.tar.gz</span><br><span class="line"><span class="built_in">du</span> -sh *</span><br></pre></td></tr></table></figure><h3 id="关于-cmake-版本">🧰 关于 cmake 版本</h3><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212175149284.png" alt="image-20250212175149284"><figcaption aria-hidden="true">image-20250212175149284</figcaption></figure><p>在安装 MySQL 的时候我们需要使用 <code>cmake</code>进行编译，首先我遇到了 <code>cmake</code> 的版本问题，我们通过升级<code>cmake</code> 版本修正这个问题：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212200732906.png" alt="image-20250212200732906"><figcaption aria-hidden="true">image-20250212200732906</figcaption></figure><p>修改指令并尝试运行该文件</p><h3 id="gcc-路径">🧰 gcc 路径</h3><p>好的，不出意外地再次报错</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212200925468.png" alt="image-20250212200925468"><figcaption aria-hidden="true">image-20250212200925468</figcaption></figure><p>我们通过 <code>cmak</code><code>命令中的</code>CMAKE_C_COMPILER<code>和</code>CMAKE_CXX_COMPILER`变量来手动指定编译器路径。例如，假设 gcc 和 g++安装在默认路径下，尝试如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 . \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>依然不是很成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-8.0.25]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 4.8.5</span><br><span class="line">-- The CXX compiler identification is GNU 4.8.5</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">CMake Error at CMakeLists.txt:382 (MESSAGE):</span><br><span class="line">  Please <span class="keyword">do</span> not build in-source.  Out-of <span class="built_in">source</span> builds are highly</span><br><span class="line">  recommended: you can have multiple builds <span class="keyword">for</span> the same <span class="built_in">source</span>, and there is</span><br><span class="line">  an easy way to <span class="keyword">do</span> cleanup, simply remove the build directory (note that</span><br><span class="line">  <span class="string">&#x27;make clean&#x27;</span> or <span class="string">&#x27;make distclean&#x27;</span> does *not* work)</span><br><span class="line"></span><br><span class="line">  You *can* force in-source build by invoking cmake with</span><br><span class="line">  -DFORCE_INSOURCE_BUILD=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br></pre></td></tr></table></figure><p>这条报错是在说 CMake强烈建议不要在源代码目录内进行编译，因为这样会造成源代码目录的污染，无法轻松清理。理想的做法是<strong>在源代码外的单独目录中进行构建</strong>。这个还比较好解决，如果我们非要<strong>在源代码目录中构建，可以通过使用-DFORCE_INSOURCE_BUILD=1 强制进行构建，但这不是推荐的做法：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 强制在源代码目录内构建</span></span><br><span class="line">cmake3 . -DFORCE_INSOURCE_BUILD=1</span><br></pre></td></tr></table></figure><p>推荐的做法是：</p><p><strong>2. 在源代码目录之外创建一个新的目录进行构建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回到 /usr/local/software-mysql</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/software-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的构建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> mysql-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入构建目录</span></span><br><span class="line"><span class="built_in">cd</span> mysql-build</span><br></pre></td></tr></table></figure><p>那我们使用后者吧：</p><p>在开始编译之前我们需要清理原来的 <code>builds</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /usr/local/software-mysql/mysql-8.0.25/CMakeFiles</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/local/software-mysql/mysql-8.0.25/CMakeCache.txt</span><br></pre></td></tr></table></figure><p>然后我们修改 <code>cmake.sh</code> 命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 /usr/local/software-mysql/mysql-8.0.25 \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>再运行它一次！我不信还会出错了！</p><p>然而。。。果然又有新的问题了。。。这次是 GCC 版本过低，MySQL 8.0.25需要 GCC 5.3 或更高版本来进行编译：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- Found Git: /usr/bin/git (found version <span class="string">&quot;1.8.3.1&quot;</span>) </span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 4.8.5</span><br><span class="line">-- The CXX compiler identification is GNU 4.8.5</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-build</span><br><span class="line">-- CMAKE_GENERATOR: Unix Makefiles</span><br><span class="line">CMake Error at cmake/os/Linux.cmake:80 (MESSAGE):</span><br><span class="line">  GCC 5.3 or newer is required (-dumpversion says 4.8.5)</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:491 (INCLUDE)</span><br></pre></td></tr></table></figure><h3 id="关于-centos-release-scl-的一个小插曲待解决">🧰 关于<code>centos-release-scl</code> 的一个小插曲（待解决）</h3><p>我试图安装 <code>centos-release-scl</code> 进而安装新版本的<code>gcc</code>，这个软件包提供了 <strong>Software Collections(SCL)</strong> 的支持。SCL是一种在不影响系统默认软件版本的情况下，让用户安装和使用不同版本的软件包的机制。简单来说，它允许用户安装、使用与系统默认版本不同的软件版本，例如最新版本的Python、GCC、Ruby、PHP 等，而不需要更改系统的默认版本。SCL提供了以下优势：</p><ol type="1"><li>你可以同时使用多个版本的相同软件，比如使用系统自带的老版本Python，同时安装并使用新版本的 Python。</li><li>在不同的环境中切换版本变得更加灵活。</li><li>不会影响到系统自带的包，减少了与其他系统包的冲突风险。</li></ol><p>安装命令很简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install centos-release-scl -y</span><br></pre></td></tr></table></figure><p>但安装完之后其他包的安装存在了问题，例如我原本准备执行这个命令安装<code>gcc</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install devtoolset-8-gcc* -y</span><br></pre></td></tr></table></figure><p>然而报了如下的错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># sudo yum install devtoolset-8-gcc* -y</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Could not retrieve mirrorlist http://mirrorlist.centos.org?<span class="built_in">arch</span>=x86_64&amp;release=7&amp;repo=sclo-rh error was</span><br><span class="line">14: curl<span class="comment">#6 - &quot;Could not resolve host: mirrorlist.centos.org; Unknown error&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> One of the configured repositories failed (Unknown),</span><br><span class="line"> and yum doesn<span class="string">&#x27;t have enough cached data to continue. At this point the only</span></span><br><span class="line"><span class="string"> safe thing yum can do is fail. There are a few ways to work &quot;fix&quot; this:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     1. Contact the upstream for the repository and get them to fix the problem.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     2. Reconfigure the baseurl/etc. for the repository, to point to a working</span></span><br><span class="line"><span class="string">        upstream. This is most often useful if you are using a newer</span></span><br><span class="line"><span class="string">        distribution release than is supported by the repository (and the</span></span><br><span class="line"><span class="string">        packages for the previous distribution release still work).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     3. Run the command with the repository temporarily disabled</span></span><br><span class="line"><span class="string">            yum --disablerepo=&lt;repoid&gt; ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     4. Disable the repository permanently, so yum won&#x27;</span>t use it by default. Yum</span><br><span class="line">        will <span class="keyword">then</span> just ignore the repository until you permanently <span class="built_in">enable</span> it</span><br><span class="line">        again or use --enablerepo <span class="keyword">for</span> temporary usage:</span><br><span class="line"></span><br><span class="line">            yum-config-manager --<span class="built_in">disable</span> &lt;repoid&gt;</span><br><span class="line">        or</span><br><span class="line">            subscription-manager repos --<span class="built_in">disable</span>=&lt;repoid&gt;</span><br><span class="line"></span><br><span class="line">     5. Configure the failing repository to be skipped, <span class="keyword">if</span> it is unavailable.</span><br><span class="line">        Note that yum will try to contact the repo. when it runs most commands,</span><br><span class="line">        so will have to try and fail each time (and thus. yum will be be much</span><br><span class="line">        slower). If it is a very temporary problem though, this is often a <span class="built_in">nice</span></span><br><span class="line">        compromise:</span><br><span class="line"></span><br><span class="line">            yum-config-manager --save --<span class="built_in">setopt</span>=&lt;repoid&gt;.skip_if_unavailable=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Cannot find a valid baseurl <span class="keyword">for</span> repo: centos-sclo-rh/x86_64</span><br></pre></td></tr></table></figure><p>显示软件源可以看到多了两条：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># ls /etc/yum.repos.d/</span></span><br><span class="line">CentOS-Base.repo  CentOS-SCLo-scl.repo  CentOS-SCLo-scl-rh.repo  epel.repo  epel.repo.rpmnew  epel-testing.repo</span><br></pre></td></tr></table></figure><p>以 <code>CentOS-SCLo-scl.repo</code> 为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># cat /etc/yum.repos.d/CentOS-SCLo-scl.repo </span></span><br><span class="line"><span class="comment"># CentOS-SCLo-sclo.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see http://wiki.centos.org/SpecialInterestGroup/SCLo for more</span></span><br><span class="line"><span class="comment"># information</span></span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo]</span><br><span class="line">name=CentOS-7 - SCLo sclo</span><br><span class="line"><span class="comment"># baseurl=http://mirror.centos.org/centos/7/sclo/$basearch/sclo/</span></span><br><span class="line">mirrorlist=http://mirrorlist.centos.org?<span class="built_in">arch</span>=<span class="variable">$basearch</span>&amp;release=7&amp;repo=sclo-sclo</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-testing]</span><br><span class="line">name=CentOS-7 - SCLo sclo Testing</span><br><span class="line">baseurl=http://buildlogs.centos.org/centos/7/sclo/<span class="variable">$basearch</span>/sclo/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-source]</span><br><span class="line">name=CentOS-7 - SCLo sclo Sources</span><br><span class="line">baseurl=http://vault.centos.org/centos/7/sclo/Source/sclo/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-debuginfo]</span><br><span class="line">name=CentOS-7 - SCLo sclo Debuginfo</span><br><span class="line">baseurl=http://debuginfo.centos.org/centos/7/sclo/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br></pre></td></tr></table></figure><p>我们只能先禁用他们：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁用 centos-sclo-sclo 仓库</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">disable</span> centos-sclo-sclo</span><br><span class="line">sudo yum-config-manager --<span class="built_in">disable</span> centos-sclo-rh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除缓存</span></span><br><span class="line">sudo yum clean all</span><br><span class="line">sudo yum makecache</span><br></pre></td></tr></table></figure><p>这个限于目前的技术水平，暂时不知道是什么原因，我估计是梯子的问题，留待之后排查</p><h3 id="继续解决前面的-gcc-版本问题">🧰 继续解决前面的 <code>gcc</code>版本问题</h3><p>我们可以尝试直接源码编译</p><p>访问 GCC 的官方网站下载最新版本的源代码，并执行 configure脚本以及编译步骤：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.gnu.org/gnu/gcc/gcc-8.5.0/gcc-8.5.0.tar.gz</span><br><span class="line">tar -xvzf gcc-8.5.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> gcc-8.5.0</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">sudo yum install -y gmp-devel mpfr-devel libmpc-devel</span><br><span class="line"><span class="comment"># 运行 configure 脚本</span></span><br><span class="line">./configure --disable-multilib --enable-languages=c,c++</span><br><span class="line"></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)  <span class="comment"># 使用所有 CPU 核心加速编译</span></span><br><span class="line"><span class="comment"># 通过 make -j 来增加并行任务数，make -j2 表示使用两个并行任务</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>这个编译过程特别耗时，对于 GCC 8.5.0 这种大型项目，单核 CPU编译可能需要 <strong>6-12 小时</strong>，两核 CPU 的情况下，可能需要<strong>3-6 小时</strong> 或更长时间。</p><p>编译完之后，我们还需要把这个<code>gcc</code>的路径加入到环境变量中，特别是 <code>PATH</code> 和<code>LD_LIBRARY_PATH</code>，首先我们查找路径：</p><ol type="1"><li><p>找到新 GCC 的安装路径。通常，<code>make install</code> 会将 GCC安装到 <code>/usr/local/bin</code> 中。</p></li><li><p>通过以下命令检查新 GCC 是否安装在<code>/usr/local/bin</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /usr/local/bin/gcc</span><br></pre></td></tr></table></figure><p>如果文件存在，表示新的 GCC 已安装在该目录。</p></li></ol><p>接下来在 <code>~/.bashrc</code> 文件中添加新 GCC 的路径：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/local/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/local/lib64:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213181357527.png" alt="image-20250213181357527"><figcaption aria-hidden="true">image-20250213181357527</figcaption></figure><p>然后退出并 <code>source ~/.bashrc</code> 即可，我们再次打印<code>gcc --version</code> 会发现版本已经更新了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># vim ~/.bashrc</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># source ~/.bashrc</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># gcc --version</span></span><br><span class="line">gcc (GCC) 8.5.0</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure><h3 id="boost-依赖项">🧰 <code>Boost</code> 依赖项</h3><p>我们需要修改 <code>cmake.sh</code> 文件里的 <code>gcc</code>的路径为最新安装的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 /usr/local/software-mysql/mysql-8.0.25  \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/local/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/local/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>然后清除目录下的 CMakeFiles 和 CMakeCache.txt：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># rm -rf CMakeFiles</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># rm -rf CMakeCache.txt</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh</span></span><br></pre></td></tr></table></figure><p>现在出现了新的报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- Found Git: /usr/bin/git (found version <span class="string">&quot;1.8.3.1&quot;</span>) </span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 8.5.0</span><br><span class="line">-- The CXX compiler identification is GNU 8.5.0</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/local/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/local/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/local/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/local/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-build</span><br><span class="line">-- CMAKE_GENERATOR: Unix Makefiles</span><br><span class="line">-- Looking <span class="keyword">for</span> SHM_HUGETLB</span><br><span class="line">-- Looking <span class="keyword">for</span> SHM_HUGETLB - found</span><br><span class="line">-- Looking <span class="keyword">for</span> sys/types.h</span><br><span class="line">-- Looking <span class="keyword">for</span> sys/types.h - found</span><br><span class="line">-- Looking <span class="keyword">for</span> stdint.h</span><br><span class="line">-- Looking <span class="keyword">for</span> stdint.h - found</span><br><span class="line">-- Looking <span class="keyword">for</span> stddef.h</span><br><span class="line">-- Looking <span class="keyword">for</span> stddef.h - found</span><br><span class="line">-- Check size of void *</span><br><span class="line">-- Check size of void * - <span class="keyword">done</span></span><br><span class="line">-- SIZEOF_VOIDP 8</span><br><span class="line">-- Performing Test HAVE_C_FLOATING_POINT_FUSED_MADD</span><br><span class="line">-- Performing Test HAVE_C_FLOATING_POINT_FUSED_MADD - Failed</span><br><span class="line">-- Performing Test HAVE_CXX_FLOATING_POINT_FUSED_MADD</span><br><span class="line">-- Performing Test HAVE_CXX_FLOATING_POINT_FUSED_MADD - Failed</span><br><span class="line">-- Packaging as: mysql-8.0.25-Linux-x86_64</span><br><span class="line">-- Performing Test C_LD_LLD_RESULT</span><br><span class="line">-- Performing Test C_LD_LLD_RESULT - Failed</span><br><span class="line">-- Performing Test CXX_LD_LLD_RESULT</span><br><span class="line">-- Performing Test CXX_LD_LLD_RESULT - Failed</span><br><span class="line">-- Performing Test C_LD_GOLD_RESULT</span><br><span class="line">-- Performing Test C_LD_GOLD_RESULT - Success</span><br><span class="line">-- Performing Test CXX_LD_GOLD_RESULT</span><br><span class="line">-- Performing Test CXX_LD_GOLD_RESULT - Success</span><br><span class="line">-- Looked <span class="keyword">for</span> boost/version.hpp <span class="keyword">in</span>  and </span><br><span class="line">-- BOOST_INCLUDE_DIR BOOST_INCLUDE_DIR-NOTFOUND</span><br><span class="line">-- LOCAL_BOOST_DIR </span><br><span class="line">-- LOCAL_BOOST_ZIP </span><br><span class="line">-- Could not find (the correct version of) boost.</span><br><span class="line">-- MySQL currently requires boost_1_73_0</span><br><span class="line"></span><br><span class="line">CMake Error at cmake/boost.cmake:107 (MESSAGE):</span><br><span class="line">  You can download it with -DDOWNLOAD_BOOST=1 -DWITH_BOOST=&lt;directory&gt;</span><br><span class="line"></span><br><span class="line">  This CMake script will look <span class="keyword">for</span> boost <span class="keyword">in</span> &lt;directory&gt;.  If it is not there,</span><br><span class="line">  it will download and unpack it (<span class="keyword">in</span> that directory) <span class="keyword">for</span> you.</span><br><span class="line"></span><br><span class="line">  You can also download boost manually, from</span><br><span class="line">  https://dl.bintray.com/boostorg/release/1.73.0/source/boost_1_73_0.tar.gz</span><br><span class="line"></span><br><span class="line">  If you are inside a firewall, you may need to use an https proxy:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> https_proxy=http://example.com:80</span><br><span class="line"></span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  cmake/boost.cmake:276 (COULD_NOT_FIND_BOOST)</span><br><span class="line">  CMakeLists.txt:1147 (INCLUDE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also <span class="string">&quot;/usr/local/software-mysql/mysql-build/CMakeFiles/CMakeOutput.log&quot;</span>.</span><br><span class="line">See also <span class="string">&quot;/usr/local/software-mysql/mysql-build/CMakeFiles/CMakeError.log&quot;</span>.</span><br></pre></td></tr></table></figure><p>当前问题是 <strong>找不到 Boost 1.73.0</strong> 版本，这是 MySQL8.0.25 的一个依赖项。</p><ol type="1"><li><p><strong>下载并安装 Boost 1.73.0</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/software-mysql/mysql-build</span><br><span class="line">wget https://archives.boost.io/release/1.73.0/source/boost_1_73_0.tar.gz</span><br><span class="line">tar -xvzf boost_1_73_0.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>在 <code>cmake.sh</code> 文件最后添加一行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-DWITH_BOOST=/usr/local/software-mysql/mysql-build/boost_1_73_0</span><br></pre></td></tr></table></figure></li><li><p>然后执行 <code>cmake.sh</code> 文件即可：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213191157461.png" alt="image-20250213191157461"><figcaption aria-hidden="true">image-20250213191157461</figcaption></figure></li></ol><p>成功～</p><p>我们将所有 CPU 一起启动在后台安装，并将日志输出到<code>mysql_make_output.log</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> make -j$(<span class="built_in">nproc</span>) &gt; mysql_make_output.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213191603813.png" alt="image-20250213191603813"><figcaption aria-hidden="true">image-20250213191603813</figcaption></figure><p>胜利的曙光就在眼前～让我们拭目以待！！！</p><h3 id="程序被系统终止重新-make">🧰 程序被系统终止（重新<code>make</code>）</h3><p>不出意外的是，又出问题了 👿</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213204627873.png" alt="image-20250213204627873"><figcaption aria-hidden="true">image-20250213204627873</figcaption></figure><blockquote><p>可能的原因如下：</p><p><strong>1. 内存不足</strong></p><p>编译 MySQL 这样的复杂程序时，特别是在使用<code>make -j$(nproc)</code>进行并行编译时，系统可能会耗尽内存。<code>cc1plus</code> 是<code>g++</code>编译器的一个关键部分，当系统的内存不足时，操作系统可能会终止该进程。</p><p><strong>解决方案</strong>：</p><ul><li>增加系统的物理内存。</li><li>如果是虚拟机，考虑增加虚拟内存或增加物理内存。</li><li>如果不能增加内存，可以尝试减少并行任务数，使用 <code>make -j2</code>或者 <code>make -j1</code> 让编译过程使用较少的内存。</li></ul><p><strong>2. SWAP空间不足</strong></p><p>当内存不足时，系统会使用交换空间（SWAP）。如果 SWAP空间不足，也会导致编译失败。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查当前的 SWAP 空间：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon -s</span><br></pre></td></tr></table></figure></li><li><p>如果 SWAP 空间不足，可以通过以下命令增加 SWAP：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1M count=4096  <span class="comment"># 创建一个 4GB 的交换文件</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /swapfile  <span class="comment"># 设置权限</span></span><br><span class="line">sudo mkswap /swapfile  <span class="comment"># 设置交换文件</span></span><br><span class="line">sudo swapon /swapfile  <span class="comment"># 启用交换文件</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>3. CPU 或系统资源被占满</strong></p><p>由于并行编译使用了大量的 CPU核心，系统可能因资源消耗过高导致进程被杀死。</p><p><strong>解决方案</strong>：</p><ul><li>降低 make 命令的并行度，减少 CPU 核心数的使用，尝试 make -j2 或 make-j1。</li></ul><p><strong>4. 硬盘空间不足</strong></p><p>如果磁盘空间不足，编译过程中的临时文件和输出文件可能无法正确写入磁盘，导致编译中断。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查磁盘空间：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure></li><li><p>如果磁盘空间不足，删除一些不必要的文件或扩展磁盘空间。</p></li></ul><p><strong>5. 系统限制</strong></p><p>Linux 系统有时会根据进程的资源使用情况（如内存、CPU时间等）进行限制，可能会在某些情况下杀死进程。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查 ulimit 设置，增加进程允许使用的内存或文件描述符数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -a  <span class="comment"># 查看所有限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -n  <span class="comment"># 查看文件描述符限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -u  <span class="comment"># 查看最大进程数限制</span></span><br></pre></td></tr></table></figure></li></ul></blockquote><p>经过检查猜测大概率是内存不足的问题，现在我们需要使用<code>make clean</code> 命令清理之前的编译结果，这会删除<code>make</code> 过程中生成的所有中间文件和目标文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line"><span class="built_in">rm</span> -rf CMakeCache.txt CMakeFiles</span><br><span class="line">./cmake.sh</span><br></pre></td></tr></table></figure><p>我们对交换空间、虚拟内存与 CPU 核数均做了优化：</p><ol type="1"><li><p>按前面所说流程增加交换空间大小</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1M count=4096  <span class="comment"># 创建一个 4GB 的交换文件</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /swapfile  <span class="comment"># 设置权限</span></span><br><span class="line">sudo mkswap /swapfile  <span class="comment"># 设置交换文件</span></span><br><span class="line">sudo swapon /swapfile  <span class="comment"># 启用交换文件</span></span><br></pre></td></tr></table></figure></li><li><p>为了让交换空间在系统重启后自动生效，编辑 /etc/fstab文件并添加以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/swapfile none swap sw 0 0</span><br></pre></td></tr></table></figure></li><li><p>然后增加操作系统的虚拟内存限制，来避免进程因内存溢出而被杀死：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -v unlimited</span><br></pre></td></tr></table></figure></li><li><p>最后再尝试使用单核 CPU 进行编译：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./cmake.sh</span><br><span class="line"><span class="built_in">nohup</span> make -j1 &gt; mysql_make_output.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 使用下面命令查看日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /usr/local/software-mysql/mysql-build/mysql_make_output.log</span><br></pre></td></tr></table></figure></li></ol><p>下面还是老样子，再次祈祷！</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214105213109.png" alt="image-20250214105213109"><figcaption aria-hidden="true">image-20250214105213109</figcaption></figure><p>经过了漫长的等待，终于迎来了胜利！</p><p>再把这个 <code>bin</code> 的路径保存到 <code>~/.bashrc</code>并激活即可：</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214121526166.png" alt="image-20250214121526166"><figcaption aria-hidden="true">image-20250214121526166</figcaption></figure><h3 id="gcc-版本还是太低">🧰 gcc 版本还是太低</h3><p>看起来一切都很顺利，但在最后的初始化这一步还是凉了～</p><figure><img src="/LAMP-%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214132359514.png" alt="image-20250214132359514"><figcaption aria-hidden="true">image-20250214132359514</figcaption></figure><p>运行以下命令来列出 libstdc++ 的版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># strings /usr/lib64/libstdc++.so.6 | grep GLIBCXX</span></span><br><span class="line">GLIBCXX_3.4</span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line">GLIBCXX_3.4.3</span><br><span class="line">GLIBCXX_3.4.4</span><br><span class="line">GLIBCXX_3.4.5</span><br><span class="line">GLIBCXX_3.4.6</span><br><span class="line">GLIBCXX_3.4.7</span><br><span class="line">GLIBCXX_3.4.8</span><br><span class="line">GLIBCXX_3.4.9</span><br><span class="line">GLIBCXX_3.4.10</span><br><span class="line">GLIBCXX_3.4.11</span><br><span class="line">GLIBCXX_3.4.12</span><br><span class="line">GLIBCXX_3.4.13</span><br><span class="line">GLIBCXX_3.4.14</span><br><span class="line">GLIBCXX_3.4.15</span><br><span class="line">GLIBCXX_3.4.16</span><br><span class="line">GLIBCXX_3.4.17</span><br><span class="line">GLIBCXX_3.4.18</span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># strings /usr/lib64/libstdc++.so.6 | grep CXXABI</span></span><br><span class="line">CXXABI_1.3</span><br><span class="line">CXXABI_1.3.1</span><br><span class="line">CXXABI_1.3.2</span><br><span class="line">CXXABI_1.3.3</span><br><span class="line">CXXABI_1.3.4</span><br><span class="line">CXXABI_1.3.5</span><br><span class="line">CXXABI_1.3.6</span><br><span class="line">CXXABI_1.3.7</span><br><span class="line">CXXABI_TM_1</span><br></pre></td></tr></table></figure><p>还得重新安装 GCC 9才能行得通，886了！下次安装前一定要提前看好适配的包是什么，要去官网先看一遍安装教程，不然又会凉🥹 血的教训！一定要人家写了什么版本就安装什么版本！！</p><h2 id="php-编译">2. PHP 编译</h2><p>如果 <code>configure</code> 的时候遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: libxml2 not found. Please check your libxml2 installation.</span><br></pre></td></tr></table></figure><p>可以执行以下命令补充安装再次 <code>configure</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install libxml2 libxml2-devel -y</span><br></pre></td></tr></table></figure><p>遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checking <span class="keyword">for</span> cURL 7.10.5 or greater... configure: error: cURL version 7.10.5 or later is required to compile php with cURL support</span><br></pre></td></tr></table></figure><p>则升级 <code>cURL</code> 即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install curl curl-devel -y</span><br></pre></td></tr></table></figure><p>遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checking whether to <span class="built_in">enable</span> JIS-mapped Japanese font support <span class="keyword">in</span> GD... no</span><br><span class="line">If configure fails try --with-webp-dir=&lt;DIR&gt;</span><br><span class="line">configure: error: jpeglib.h not found.</span><br></pre></td></tr></table></figure><p>说明在配置 PHP 时，找不到 jpeglib.h 头文件，这是 JPEG图像库的一部分，PHP 在编译时需要它来支持处理 JPEG 图像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install libjpeg-devel -y</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;把一台刚买的阿里云 ECS 从“能 SSH
登录”变成“公网可访问、可稳定跑站点”的服务器，中间最容易卡在三件事：网络放行（安全组/防火墙）、服务联动（Apache–PHP–MySQL
的请求链路）以及权限与版本（目录权限、PHP
版本与扩展）。这篇文章先用架构图把 LAMP
的工作流讲清楚，然后按可复现的顺序完成：安全组与端口配置、基础环境安装与验证、Apache/MySQL/PHP
的安装与关键配置，最后给出 Discuz
部署与源码编译安装的整套流程（含清理旧环境、依赖准备、服务自启与常见排错点），让你从
0 到 1 把一套传统 Web 栈在云上真正跑起来。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>LAMP 与阿里云服务器详解</title>
    <link href="https://chenk.top/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/"/>
    <id>https://chenk.top/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/</id>
    <published>2025-02-15T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.324Z</updated>
    
    <content type="html"><![CDATA[<p>This post is a practical “from zero to running site” walkthrough forsetting up a classic LAMP stack on an Alibaba Cloud ECS instance. Itstarts with the request path and the moving parts (Linux + Apache +MySQL + PHP), then covers the real-world blockers that usually derailfirst-time setups: security groups, firewall rules, service startup,directory permissions, and version/extension mismatches. Beyond thestandard package-based installation, it also includes a more advancedtrack (building components from source and cleaning legacyenvironments), so you can still get a working stack when repositories ordefault versions are not a good fit.</p><span id="more"></span><p>LAMP 是 Linux 服务器上的一套经典 Web 服务器架构，由<strong>Linux</strong>（操作系统）、<strong>Apache</strong>（Web服务器）、<strong>MySQL</strong>（数据库）和<strong>PHP/Python/Perl</strong>（动态脚本语言）组成。阿里云服务器提供了强大的计算资源，使得用户可以在云环境中搭建LAMP 服务器来部署 Web 应用。</p><hr><h1 id="一lamp-架构概述">一、LAMP 架构概述</h1><p>LAMP 是构建动态网站和 Web应用的主流架构。它的每个组件在架构中发挥特定作用：</p><ul><li><strong>Linux</strong>：作为服务器操作系统，提供稳定的运行环境。</li><li><strong>Apache</strong>：作为 Web 服务器，处理 HTTP请求并将网页内容返回给客户端。</li><li><strong>MySQL</strong>：提供数据库服务，用于存储网站数据。</li><li><strong>PHP、Python、Perl</strong>：用于动态生成网页，与 MySQL交互，处理用户请求。</li></ul><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/420px-LAMP_software_bundle.svg.png" alt="img"><figcaption aria-hidden="true">img</figcaption></figure><p>下图展示了 LAMP 架构的工作流程：</p><ol type="1"><li>用户访问网站，浏览器向 Apache 服务器发送 HTTP 请求。</li><li>Apache 解析请求并调用 PHP 处理逻辑。</li><li>PHP 脚本查询 MySQL 数据库获取数据。</li><li>数据返回给 PHP 处理，并最终由 Apache 服务器返回给用户。</li></ol><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/ee8c173e981c46068d93961c484c43e2.png" alt="LAMP架构_lamp具体结构包括-CSDN博客"><figcaption aria-hidden="true">LAMP架构_lamp具体结构包括-CSDN博客</figcaption></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/992547-20170619140819648-1336856462.png" alt="LAMP架构的详细内容以及通信过程- Nice_keep-going - 博客园"><figcaption aria-hidden="true">LAMP架构的详细内容以及通信过程-Nice_keep-going - 博客园</figcaption></figure><h1 id="二阿里云服务器概述与网络配置">二、阿里云服务器概述与网络配置</h1><p>阿里云服务器（ECS）为用户提供弹性计算资源，并支持多种操作系统（如Ubuntu）。在阿里云环境中，关键的网络配置包括公网 IP与防火墙安全组设置。下面是云服务器控制台的监控界面：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211211700378.png" alt="image-20250211211700378"><figcaption aria-hidden="true">image-20250211211700378</figcaption></figure><h2 id="阿里云服务器基础">1. 阿里云服务器基础</h2><ul><li><p><strong>弹性扩展</strong>：根据实际需求调整CPU、内存、带宽等资源。</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211211940966.png" alt="image-20250211211940966"><figcaption aria-hidden="true">image-20250211211940966</figcaption></figure></li><li><p><strong>公网IP</strong>：使服务器可以被外部访问。你可以在阿里云控制台为 ECS实例分配公网 IP。</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211212019600.png" alt="image-20250211212019600"><figcaption aria-hidden="true">image-20250211212019600</figcaption></figure></li><li><p><strong>安全组（防火墙）</strong>：阿里云提供安全组管理工具，用于配置允许哪些端口和IP 能访问你的服务器。</p></li></ul><h2 id="防火墙与公网-ip-配置">2. 防火墙与公网 IP 配置</h2><h3 id="公网-ip-配置">公网 IP 配置</h3><p>在阿里云 ECS 控制台： - 为实例分配或绑定公网 IP。 -在实例信息中查看公网 IP，并通过浏览器访问测试。</p><h3 id="安全组规则设置">安全组规则设置</h3><p>在 ECS 控制台的安全组配置中，添加以下入站规则： -<strong>SSH</strong>：端口 22（允许远程登录）。 -<strong>HTTP</strong>：端口 80（用于网站访问）。 -<strong>HTTPS</strong>：端口 443（用于安全网站访问）。 - 可根据需要开放MySQL（3306）、FTP 等端口。</p><p>默认安全组配置如下：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211154055070.png" alt="image-20250211154055070"><figcaption aria-hidden="true">image-20250211154055070</figcaption></figure><p>配置方式如下：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221452657.png" alt="image-20250211221452657"><figcaption aria-hidden="true">image-20250211221452657</figcaption></figure><p>配置结果如下：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221531005.png" alt="image-20250211221531005"><figcaption aria-hidden="true">image-20250211221531005</figcaption></figure><p><strong>或在服务器上使用 iptables 命令手动配置：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 允许 HTTP 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line"># 允许 HTTPS 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT</span><br><span class="line"># 允许 SSH 访问</span><br><span class="line">sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br><span class="line"># 保存规则（Ubuntu 下使用 iptables-persistent）</span><br><span class="line">sudo netfilter-persistent save</span><br></pre></td></tr></table></figure><h1 id="三lamp-环境搭建ubuntu-实例">三、LAMP 环境搭建（Ubuntu实例）</h1><p>在阿里云的 Ubuntu 服务器上，搭建 LAMP 环境主要包括安装 Apache、MySQL和 PHP，并进行简单配置与验证。</p><h2 id="准备工作">0. 准备工作</h2><p>在开始之前，我们一般要关闭所有防火墙（内置防火墙和 Linux的软件防火墙）。</p><p>第一步就是关闭<code>selinux</code>，这是美国航空安全局开发的内置防火墙。我们首先可以通过<code>getenforce</code> 查询 <code>selinux</code> 状态，但基本只有CentOS8 会有比较多的 <code>seinux</code> 的策略，CentOS7不用。我们可以修改其默认配置，永久禁止其开机自启：</p><p>第二步是关闭内置的 <code>firewalld</code> 以及清空<code>iptables</code> 规则：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h2 id="安装-apache-web-服务器">1. 安装 Apache Web 服务器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install apache2 -y</span><br><span class="line"></span><br><span class="line"># 或者在CentOS里</span><br><span class="line">yum install httpd -y</span><br></pre></td></tr></table></figure><p>启动并设置 Apache 开机自启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start apache2</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> apache2</span><br></pre></td></tr></table></figure><p>验证：在浏览器访问 <code>http://&lt;公网_IP&gt;/</code> 应显示 Apache默认欢迎页面。</p><p>⚠️注意，如果之前没有配置安全组通过 80 端口，会显示：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221630066.png" alt="image-20250211221630066"><figcaption aria-hidden="true">image-20250211221630066</figcaption></figure><p>按前面说的配置一下安全组就行，最终会显示如下页面：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211221716957.png" alt="image-20250211221716957"><figcaption aria-hidden="true">image-20250211221716957</figcaption></figure><p>下面为 CentOS 下的 Apache 服务器启动以及测试方式：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211220450481.png" alt="image-20250211220450481"><figcaption aria-hidden="true">image-20250211220450481</figcaption></figure><blockquote><p><code>curl ifconfig.me</code> 可以拿到自己的 ip 地址</p></blockquote><h2 id="mysql-数据库">2. MySQL 数据库</h2><h3 id="安装">安装</h3><p>命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mysql-server -y</span><br></pre></td></tr></table></figure><p>运行安全安装向导：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure><p>按照提示设置 MySQL root 密码，移除匿名用户，禁止远程 root 登录。</p><p>验证：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status mysql</span><br></pre></td></tr></table></figure><p>在阿里云服务器安装时，默认的阿里云源是没有 <code>mysql</code>的，只有 <code>mariadb</code>：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211222133896.png" alt="image-20250211222133896"><figcaption aria-hidden="true">image-20250211222133896</figcaption></figure><p>我们可以给服务器换源：</p><p>首先进入到 <code>/etc/yum.repos.d</code>，进行如下操作：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211225358267.png" alt="image-20250211225358267"><figcaption aria-hidden="true">image-20250211225358267</figcaption></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://dev.mysql.com/get/mysql-community-release-el7-5.noarch.rpm</span><br><span class="line">rpm -ivh mysql-community-release-el7-5.noarch.rpm </span><br></pre></td></tr></table></figure><p>查看 <code>mysql-community.repo</code> 文件：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211225836835.png" alt="image-20250211225836835"><figcaption aria-hidden="true">image-20250211225836835</figcaption></figure><p>随后运行以下命令安装即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mysql-community-server</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232057979.png" alt="image-20250211232057979"><figcaption aria-hidden="true">image-20250211232057979</figcaption></figure><p>可以输入 <code>mysql_secure_installation</code> 来进行密码设置：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232544886.png" alt="image-20250211232544886"><figcaption aria-hidden="true">image-20250211232544886</figcaption></figure><p>登录后可以查看一些基本信息如下：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211232802711.png" alt="image-20250211232802711"><figcaption aria-hidden="true">image-20250211232802711</figcaption></figure><blockquote><p>当使用源码编译的方式安装 mysql 时如果系统中没有安装 openssl或其开发头文件和库，就会遇到报错<strong>缺少openssl</strong>，这时我们需要做两步：</p><ol type="1"><li><p><strong>删除编译的目录</strong>：编译失败后，通常会有一个部分完成的目录（即使没有完全成功安装），此时需要删除该目录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /path/to/mysql/source/directory</span><br></pre></td></tr></table></figure><p>删除这个目录，确保不会使用到损坏的或不完整的文件。</p></li><li><p><strong>安装 openssl</strong>：确保系统中安装了 openssl和相关的开发工具。如果缺少开发头文件，还需要安装 openssl-devel 包。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install openssl openssl-devel</span><br></pre></td></tr></table></figure></li><li><p><strong>重新编译 MySQL</strong>：在安装了 openssl 之后，重新进入MySQL 源代码目录，开始新的编译安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/mysql/source</span><br><span class="line">./configure  <span class="comment"># 配置 MySQL 编译选项</span></span><br><span class="line">make         <span class="comment"># 编译 MySQL</span></span><br><span class="line">make install <span class="comment"># 安装 MySQL</span></span><br></pre></td></tr></table></figure></li></ol></blockquote><h3 id="配置与远程访问">配置与远程访问</h3><p>现在我们可以对 MySQL 数据库进行配置与远程访问</p><p><strong>1. 修改 MySQL 绑定地址</strong></p><p>编辑 MySQL 配置文件： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure></p><p>找到 bind-address 字段，将其改为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind-address = 0.0.0.0</span><br></pre></td></tr></table></figure><p>保存后退出编辑器，然后重启 MySQL 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart mysql</span><br></pre></td></tr></table></figure><p><strong>2. 创建远程访问用户</strong></p><p>登录 MySQL 客户端：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql -u root -p</span><br></pre></td></tr></table></figure><p>在 MySQL 提示符下，执行以下 SQL 语句：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED BY <span class="string">&#x27;yourpassword&#x27;</span>;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;admin&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><p>退出 MySQL。</p><p><strong>3. 安全注意</strong></p><p>确保安全组允许 MySQL 端口（3306）的访问，或通过 SSH 隧道访问 MySQL服务。</p><h2 id="php-及相关模块">3. PHP 及相关模块</h2><h3 id="安装-1">安装</h3><p>命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install php libapache2-mod-php php-mysql -y</span><br><span class="line"><span class="comment"># CentOS下</span></span><br><span class="line">yum install php -y</span><br></pre></td></tr></table></figure><p>验证 PHP 安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 5.4.16 (cli) (built: Apr  1 2020 04:07:17) </span></span><br><span class="line"><span class="comment"># Copyright (c) 1997-2013 The PHP Group</span></span><br><span class="line"><span class="comment"># Zend Engine v2.4.0, Copyright (c) 1998-2013 Zend Technologies</span></span><br></pre></td></tr></table></figure><h3 id="创建页面">创建页面</h3><p>为了确认 PHP 环境安装成功，我们可以创建一个简单的<code>phpinfo()</code> 页面。</p><p><strong>1. 创建 <code>phpinfo.php</code> 测试页面</strong></p><p>将以下内容写入 <code>/var/www/html/phpinfo.php</code>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;&lt;?php phpinfo(); ?&gt;&quot; | sudo tee /var/www/html/phpinfo.php</span><br></pre></td></tr></table></figure></p><p><strong>2. 访问测试页面</strong></p><p>在浏览器中访问：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;公网_IP&gt;/phpinfo.php</span><br></pre></td></tr></table></figure><p>如果页面显示 PHP 的详细配置信息，说明 PHP 安装正确并且与 Apache正常集成。（访问不成功可以尝试<code>systemctl restart httpd</code>）</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212000319587.png" alt="image-20250212000319587"><figcaption aria-hidden="true">image-20250212000319587</figcaption></figure><p>或者可以尝试些别的，我们可以使用 PHP的数组、随机函数以及内置的日期函数生成动态内容</p><ul><li>利用 <code>array_rand()</code> 随机选择名言</li><li>使用 <code>date()</code> 函数显示当前时间</li><li>输出简单的 HTML 页面</li></ul><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212000842498.png" alt="image-20250212000842498"><figcaption aria-hidden="true">image-20250212000842498</figcaption></figure><h1 id="四discuz-论坛部署">四、Discuz! 论坛部署</h1><p>Discuz! 是一个基于 PHP 和 MySQL的开源论坛程序，常用于搭建社区网站。下面介绍如何在 LAMP 环境中部署Discuz!。</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212003942527.png" alt="image-20250212003942527"><figcaption aria-hidden="true">image-20250212003942527</figcaption></figure><h2 id="下载并解压-discuz-安装包">1. 下载并解压 Discuz! 安装包</h2><p>我们要进入 Apache 的默认目录，可以通过 <code>rpm -ql</code>来查找：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250211235946415.png" alt="image-20250211235946415"><figcaption aria-hidden="true">image-20250211235946415</figcaption></figure><p>上面那些 <code>share</code>的都可以不用管，只有最后一行数据是有用的，也就是我们要找的 Apache的默认目录，进入 Apache 默认目录并下载：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html</span><br><span class="line">wget https://download.comsenz.com/DiscuzX/3.4/Discuz_X3.4_SC_UTF8.zip</span><br></pre></td></tr></table></figure><p>解压安装包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip Discuz_X3.4_SC_UTF8.zip</span><br></pre></td></tr></table></figure><p>将解压后的内容移动到网站根目录：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> upload/* /var/www/html/</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005140326.png" alt="image-20250212005140326"><figcaption aria-hidden="true">image-20250212005140326</figcaption></figure><h2 id="安装-discuz">2. 安装 Discuz!</h2><p>在浏览器中访问：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://&lt;公网_IP&gt;/install/</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005209279.png" alt="image-20250212005209279"><figcaption aria-hidden="true">image-20250212005209279</figcaption></figure><p>发现报错：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212005412101.png" alt="image-20250212005412101"><figcaption aria-hidden="true">image-20250212005412101</figcaption></figure><p>下面开始升级 PHP 版本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 更新系统并安装必要的软件包</span></span><br><span class="line">sudo yum update -y  <span class="comment"># 更新系统</span></span><br><span class="line">sudo yum install -y epel-release yum-utils  <span class="comment"># 安装 EPEL 仓库和 yum-utils 工具</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 安装 Remi 仓库（CentOS 7 专用）</span></span><br><span class="line">sudo yum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm  <span class="comment"># 添加 Remi 仓库</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启用所需的 PHP 版本</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">enable</span> remi-php81  <span class="comment"># 这里以 PHP 8.1 为例，其他版本请修改对应的数字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 升级或安装 PHP 及其常见扩展</span></span><br><span class="line">sudo yum install -y php php-cli php-common php-mbstring php-xml php-mysqlnd php-fpm php-opcache php-curl php-gd php-zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 验证 PHP 版本是否正确安装</span></span><br><span class="line">php -v  <span class="comment"># 查看 PHP 版本，确认升级是否成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 选择正确的 PHP 版本（如果 `php -v` 仍然是旧版本）</span></span><br><span class="line">sudo alternatives --config php  <span class="comment"># 可能需要手动选择 PHP 版本</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 重启 Web 服务器以应用新 PHP 版本</span></span><br><span class="line">sudo systemctl restart httpd  <span class="comment"># 如果使用的是 Apache</span></span><br><span class="line">sudo systemctl restart php-fpm  <span class="comment"># 如果使用的是 Nginx+PHP-FPM</span></span><br><span class="line">sudo systemctl restart nginx  <span class="comment"># 如果 Nginx 也需要重启</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 确保 PHP-FPM 正常运行</span></span><br><span class="line">sudo systemctl <span class="built_in">enable</span> php-fpm  <span class="comment"># 开机自启 PHP-FPM</span></span><br><span class="line">sudo systemctl status php-fpm  <span class="comment"># 检查 PHP-FPM 运行状态</span></span><br></pre></td></tr></table></figure><p>经过一系列猛如虎的操作，PHP升级成功了，环境检查也不再报错了：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010201948.png" alt="image-20250212010201948"><figcaption aria-hidden="true">image-20250212010201948</figcaption></figure><p>但下面又报错了，问题出在了目录权限，下面我们就把目录权限做修改。</p><h2 id="配置-apache-目录权限">3. 配置 Apache 目录权限</h2><p>设置文件所有者为 www-data，并赋予适当权限：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R 777 ./*</span><br></pre></td></tr></table></figure><h2 id="image-20250212010501483"><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010501483.png" alt="image-20250212010501483"></h2><p>现在终于大功告成：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212010528759.png" alt="image-20250212010528759"><figcaption aria-hidden="true">image-20250212010528759</figcaption></figure><p>如果提示少了驱动，我们可以通过 <code>yum install php-mysqli -y</code>安装</p><p>按照安装向导输入数据库信息：</p><ul><li><strong>数据库地址</strong>：localhost</li><li><strong>数据库名称</strong>：discuz</li><li><strong>数据库用户</strong>：admin</li><li><strong>数据库密码</strong>：yourpassword</li></ul><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212011051827.png" alt="image-20250212011051827"><figcaption aria-hidden="true">image-20250212011051827</figcaption></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212011102231.png" alt="image-20250212011102231"><figcaption aria-hidden="true">image-20250212011102231</figcaption></figure><p>完成安装后，即可进入 Discuz! 后台管理，进一步配置论坛设置。</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212013221831.png" alt="image-20250212013221831"><figcaption aria-hidden="true">image-20250212013221831</figcaption></figure><h1 id="五源码编译安装">五、源码编译安装</h1><p>我们现在要搞事情，我们现在准备清空整个 LAMP（Linux + Apache + MySQL +PHP）环境并从头开始重新用源码编译，以下是详细的步骤指南。</p><p>MySQL 5.6.31 + PHP 7.2.17</p><h2 id="清空原有环境">1. 清空原有环境</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 停止 Apache 和 MySQL 服务</span></span><br><span class="line">sudo systemctl stop httpd</span><br><span class="line">sudo systemctl stop mysqld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 卸载 Apache、MySQL 和 PHP</span></span><br><span class="line">sudo yum remove httpd mysql mysql-server php php-cli php-fpm php-mysqlnd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除 Apache、MySQL 和 PHP 配置文件和数据文件</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/httpd</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/www</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/mysql</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/my.cnf</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/php</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 删除 MySQL 和 Apache 用户和组，组可能不存在，会报错，但不用管</span></span><br><span class="line">sudo userdel mysql</span><br><span class="line">sudo groupdel mysql</span><br><span class="line">sudo userdel apache</span><br><span class="line">sudo groupdel apache</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 删除残留的依赖和配置文件</span></span><br><span class="line">sudo yum autoremove</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212115847770.png" alt="image-20250212115847770"><figcaption aria-hidden="true">image-20250212115847770</figcaption></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212115742880.png" alt="image-20250212115742880"><figcaption aria-hidden="true">image-20250212115742880</figcaption></figure><h2 id="基础软件运行环境准备">2. 基础软件运行环境准备</h2><p>在重新安装之前，确保系统安装了编译所需的工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum groupinstall <span class="string">&quot;Development Tools&quot;</span></span><br><span class="line">sudo yum install -y gcc-c++ make cmake bison libaio-devel ncurses-devel zlib-devel openssl-devel</span><br></pre></td></tr></table></figure><p>还可以选择安装一些其他的开发包以避免可能存在的错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc patch libffi-devel python-devel bzip2-devel sqlite-devel readline-devel tk-devel gdbm-devel db4-devel libpcap-devel xz-devel net-tools vim -y</span><br></pre></td></tr></table></figure><p>注意：在开始后续操作之前一定要关闭防火墙（<code>selinux</code> 和<code>firewalld</code>）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z yum.repos.d]<span class="comment"># systemctl status firewalld</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)</span><br><span class="line">   Active: inactive (dead)</span><br><span class="line">     Docs: man:firewalld(1)</span><br></pre></td></tr></table></figure><blockquote><p>下载太慢可以更换yum源或dns源或换网络环境</p></blockquote><h2 id="编译安装-mysql">3. 编译安装 MySQL</h2><blockquote><p>编译安装顺序：</p><ol type="1"><li>Apache 一定要先于 PHP</li><li>Apache 和 MySQL没有明显的依赖关系，先后无所谓</li><li>在 PHP 3.5 之前，MySQL必须先于 PHP 编译，因为 PHP需要实现连接数据库的功能，它通过 MySQL接口才能实现这一功能；在 3.5 之后PHP 已经集成了一套连接 MySQL 数据库的代码，编译顺序无所谓了</li></ol></blockquote><h3 id="创建-mysql-用户">创建 MySQL 用户</h3><p>用于给 MySQL 的数据、进程设置相关的 user 属主：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -r -s /sbin/nologin mysql</span><br></pre></td></tr></table></figure><h3 id="下载-mysql">下载 MySQL</h3><p>首先我们要创建一个源码目录用于下载对应软件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> software-mysql</span><br><span class="line"><span class="built_in">cd</span> software-mysql</span><br></pre></td></tr></table></figure><p>我们可以在<a class="link" href="https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/">华为提供的库内<i class="fas fa-external-link-alt"></i></a>下载需要的MySQL 版本：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212171131843.png" alt="image-20250212171131843"><figcaption aria-hidden="true">image-20250212171131843</figcaption></figure><p>选择一个合适的版本：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202606094.png" alt="image-20250214202606094"><figcaption aria-hidden="true">image-20250214202606094</figcaption></figure><p>下载源码并解压缩：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/MySQL-5.6/mysql-5.6.49.tar.gz</span><br><span class="line">tar -xzvf mysql-5.6.49.tar.gz</span><br></pre></td></tr></table></figure><h3 id="编译安装">编译安装</h3><p>进入解压缩后的目录可以发现，这里没有我们之前看到的<code>configure</code>，只有 <code>cmake</code>，我们需要安装<code>cmake</code> 命令。然后我们需要在 MySQL 的源码目录下，执行 cmake命令以配置并生成 Makefile，然后编译源代码。可以将以下命令保存为<code>cmake.sh</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cmake . \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">-DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">-DENABLE_LOCAL_INFILE=1 \</span><br><span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">-DMYSQL_TCP_PORT=3306 \</span><br><span class="line">-DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">-DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">-DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">-DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>下面是对这些参数的解释：</p><ul><li>-DCMAKE_INSTALL_PREFIX=/usr/local/mysql：指定 MySQL 安装路径</li><li>-DMYSQL_DATADIR=/usr/local/mysql/data：指定 MySQL 数据目录</li><li>-DENABLE_LOCAL_INFILE=1：启用 LOCAL 文件加载</li><li>-DWITH_INNOBASE_STORAGE_ENGINE=1：启用 InnoDB 存储引擎</li><li>-DMYSQL_TCP_PORT=3306：指定 MySQL 使用的 TCP 端口</li><li>-DDEFAULT_CHARSET=utf8mb4：指定默认字符集为 utf8mb4</li><li>-DDEFAULT_COLLATION=utf8mb4_general_ci：指定默认排序规则为utf8mb4_general_ci</li><li>-DWITH_EXTRA_CHARSETS=all：启用所有额外字符集</li><li>-DMYSQL_USER=mysql：指定 MySQL 的默认用户</li></ul><p>然后对文件需要修改权限，加入可执行权限，首先运行<code>cmake.sh</code></p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202711590.png" alt="image-20250214202711590"><figcaption aria-hidden="true">image-20250214202711590</figcaption></figure><p>运行成功如上图后，执行<code>make</code>，因为时间不是太久就直接选择前台执行了：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214202440317.png" alt="image-20250214202440317"><figcaption aria-hidden="true">image-20250214202440317</figcaption></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214205348391.png" alt="image-20250214205348391"><figcaption aria-hidden="true">image-20250214205348391</figcaption></figure><p>运行成功后如上图所示，再执行 <code>make install</code>，就会发现<code>/usr/local/</code> 路径下多了 <code>mysql</code>这个文件夹，随后将文件夹里的 <code>bin</code> 目录添加到<code>~/.bashrc</code> 即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/usr/local/mysql/bin</span><br></pre></td></tr></table></figure><p>保存并激活即可。</p><h3 id="删除旧文件残留">删除旧文件残留</h3><p>我们接下来要检查是否有旧的 <code>mysql</code>数据文件残留，发现存在我们将其进行移动备份：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214122846366.png" alt="image-20250214122846366"><figcaption aria-hidden="true">image-20250214122846366</figcaption></figure><h3 id="修改文件属主属组">修改文件属主属组</h3><p>可以看到现在文件的属主和属组都还是<code>root</code>，我们需要将其修改为 <code>mysql</code>：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214213331153.png" alt="image-20250214213331153"><figcaption aria-hidden="true">image-20250214213331153</figcaption></figure><h3 id="初始化-mysql">初始化 <code>mysql</code></h3><p>现在我们开始尝试连接 <code>mysql</code>客户端，但会报错，说无法连接到本地的 <code>mysql</code> 服务端：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214210714681.png" alt="image-20250214210714681"><figcaption aria-hidden="true">image-20250214210714681</figcaption></figure><p>Linux 的软件启动后会有两种形式提供给客户端去访问：</p><ol type="1"><li><code>ip:port</code> 形式，如<code>0.0.0.0:3306</code>，网络连接方式</li><li><code>socket</code> 本地套接字文件形式，本地进程套接字文件，启动<code>mysql</code>，提供它的本地连接进程文件<code>tmp/mysql.sock</code>，只要这个文件存在，<code>mysql</code>就是启动的</li></ol><p>总之就是 <code>mysql</code> 还没启动，因此此时首先要对<code>mysql</code> 数据库初始化，生成一些必备的数据文件，因为<code>mysql</code>要设置账号密码总得有一个库和表可以存储。具体操作如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-5.6.49]<span class="comment"># cd /usr/local/mysql</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql]<span class="comment"># ls ./scripts/</span></span><br><span class="line">mysql_install_db</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql]<span class="comment"># ./scripts/mysql_install_db --user=mysql</span></span><br><span class="line">Installing MySQL system tables...2025-02-14 21:36:08 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation <span class="keyword">for</span> more details).</span><br><span class="line">2025-02-14 21:36:08 0 [Note] Ignoring --secure-file-priv value as server is running with --bootstrap.</span><br><span class="line">2025-02-14 21:36:08 0 [Note] ./bin/mysqld (mysqld 5.6.49) starting as process 1270 ...</span><br><span class="line">2025-02-14 21:36:08 1270 [Note] InnoDB: Using atomics to ref count buffer pool pages</span><br><span class="line">2025-02-14 21:36:08 1270 [Note] InnoDB: The InnoDB memory heap is disabled</span><br></pre></td></tr></table></figure><p>运行一长串之后我们会看到两个 OK，这说明初始化成功：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214213731409.png" alt="image-20250214213731409"><figcaption aria-hidden="true">image-20250214213731409</figcaption></figure><h3 id="创建启动脚本">创建启动脚本</h3><p>因为我们是手动编译安装，还需要自己创建启动脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql</span><br></pre></td></tr></table></figure><p>我们可以查看这个文件：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214214619451.png" alt="image-20250214214619451"><figcaption aria-hidden="true">image-20250214214619451</figcaption></figure><p>此时使用 <code>service</code> 命令，会去读取 <code>/etc/init.d</code>下的脚本文件，启动 <code>mysql</code>：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214214835608.png" alt="image-20250214214835608"><figcaption aria-hidden="true">image-20250214214835608</figcaption></figure><h3 id="设置密码与登录">设置密码与登录</h3><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214215614743.png" alt="image-20250214215614743"><figcaption aria-hidden="true">image-20250214215614743</figcaption></figure><h2 id="编译安装-apache">4. 编译安装 Apache</h2><h3 id="安装依赖包-apr">安装依赖包 <code>apr</code></h3><p><code>apr</code>（Apache portable run-time Libraries，Apache可移植运行库），主要是为上层的应用程序提供一个可以跨越多操作系统平台的底层支持接口库。下载地址为：https://archive.apache.org/dist/apr/，进入该地址会有如下内容：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214220544809.png" alt="image-20250214220544809"><figcaption aria-hidden="true">image-20250214220544809</figcaption></figure><p>一直往下拉会有一些可以下载的安装包，具体的地址可以用下面的：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/apr/apr-1.5.2.tar.bz2</span><br><span class="line">tar -xf apr-1.5.2.tar.bz2; <span class="built_in">cd</span> apr-1.5.2</span><br></pre></td></tr></table></figure><p>可能由于这个版本的一个 bug，这里我们需要修改一个配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim configure</span><br><span class="line"><span class="comment"># 修改 29605 行    ‘RM’ = &#x27;RM -f&#x27;   添加一个 -f 参数</span></span><br></pre></td></tr></table></figure><p>如果不指定配置参数，就会安装到默认路径<code>/usr/local</code>，一般推荐这些小的依赖库不要修改路径，我们直接<code>./configure</code>：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214221932200.png" alt="image-20250214221932200"><figcaption aria-hidden="true">image-20250214221932200</figcaption></figure><p>然后执行编译三部曲的后两步即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214222220789.png" alt="image-20250214222220789"><figcaption aria-hidden="true">image-20250214222220789</figcaption></figure><h3 id="安装基础库-apr-util">安装基础库 <code>apr-util</code></h3><p>完整的 APR（Apache可移植运行库）实际上包含了三个开发包：<code>apr</code>，<code>apr-util</code>和<code>apr-iconv</code>，每一个包分别独立开发，并拥有自己的版本。<code>apr-util</code>这个库中也是包含了一些常用的开发组件，这些组件与<code>apr</code> 目录下的相比，它们与 Apache的关系更加密切一些，比如存储段和存储段组、加密等。这个包还是在刚刚的https://archive.apache.org/dist/apr/ 下可以找到</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/apr/apr-util-1.5.4.tar.bz2</span><br><span class="line">tar -xf apr-util-1.5.4.tar.bz2; <span class="built_in">cd</span> apr-util-1.5.4</span><br></pre></td></tr></table></figure><p>然后还是三部曲，这里的 configure 要加个参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-apr=/usr/local/apr/bin/apr-1-config</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214224641704.png" alt="image-20250214224641704"><figcaption aria-hidden="true">image-20250214224641704</figcaption></figure><p>此时 <code>apr</code> 和 <code>apr-util</code> 库就生成了一些基础的Linux 文件（动态链接库，和 C 语言相关），我们需要告诉 Linux系统多了一些这些工具，Linux 才能读取到这些信息，才能给 Apache 调用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls /usr/local/apr/lib/</span></span><br><span class="line">apr.exp     aprutil.exp  libapr-1.la  libapr-1.so.0      libaprutil-1.a   libaprutil-1.so    libaprutil-1.so.0.5.4</span><br><span class="line">apr-util-1  libapr-1.a   libapr-1.so  libapr-1.so.0.5.2  libaprutil-1.la  libaprutil-1.so.0  pkgconfig</span><br></pre></td></tr></table></figure><blockquote><p>通常，库文件会被安装到标准的系统目录，如 <code>/lib</code>,<code>/lib64</code>, <code>/usr/lib/</code>, <code>/usr/lib64</code>等地方，这些路径是默认的库文件搜索路径，因此系统和应用程序能够找到它们。</p><p>但是，如果某个软件 <strong>A</strong>将库文件安装到一个非标准目录，例如<code>/usr/local/A/lib</code>，那么你需要将该路径添加到系统的动态链接库搜索路径中。否则，系统和其他程序将无法找到这个库文件。</p><p><code>ldconfig</code>是一个用于动态链接库管理的命令，它的主要作用是搜索系统中的共享动态链接库，并将它们添加到缓存中，以供程序使用。<code>ldconfig</code>会在以下路径中查找共享库：</p><ul><li>默认搜索路径：<code>/lib</code>, <code>/lib64</code>,<code>/usr/lib/</code>, <code>/usr/lib64</code></li><li>动态库配置文件：<code>/etc/ld.so.conf</code> 中列出的路径</li></ul><p>如果你将新的库文件安装到非标准路径（如<code>/usr/local/A/lib</code>），你需要通过以下方式更新搜索路径：</p><ol type="1"><li>编辑 <code>/etc/ld.so.conf</code> 或添加一个新的 <code>.conf</code>文件到 <code>/etc/ld.so.conf.d/</code> 目录。</li><li>运行 <code>ldconfig</code>命令，让系统知道这个新的路径，从而能够找到并使用该路径下的动态库。</li></ol></blockquote><p>具体命令如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/apr/lib&quot;</span> &gt;&gt; /etc/ld.so.conf</span><br><span class="line"><span class="built_in">cat</span> /etc/ld.so.conf</span><br><span class="line"><span class="comment"># include ld.so.conf.d/*.conf</span></span><br><span class="line"><span class="comment"># /usr/local/apr/lib</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者新建一个 .conf 文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/usr/local/apr/lib&quot;</span> &gt; /etc/ld.so.conf.d/lamp.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ldconfig</span><br></pre></td></tr></table></figure><h3 id="编译-apache步骤">编译 Apache步骤</h3><p>回到刚刚的下载安装包的目录，再上一級找到 <code>httpd</code>获取链接进行 <code>wget</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://archive.apache.org/dist/httpd/httpd-2.4.37.tar.bz2</span><br><span class="line">tar -xf httpd-2.4.37.tar.bz2; <span class="built_in">cd</span> httpd-2.4.37</span><br></pre></td></tr></table></figure><p>制作配置脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">--enable-modules=all \</span><br><span class="line">--enable-mods-shared=all \</span><br><span class="line">--enable-so \</span><br><span class="line">  --enable-rewrite \</span><br><span class="line">--with-pcre \</span><br><span class="line">--enable-ssl \</span><br><span class="line">--with-mpm=prefork \</span><br><span class="line">--with-apr=/usr/local/apr/bin/apr-1-config \</span><br><span class="line">--with-apr-util=/usr/local/apr/bin/apu-1-config</span><br></pre></td></tr></table></figure><p>添加执行权限并执行脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x apache-configure.sh</span><br><span class="line">./apache-configure.sh</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214233341542.png" alt="image-20250214233341542"><figcaption aria-hidden="true">image-20250214233341542</figcaption></figure><p>直接成功结果如上，最后 <code>make &amp; make install</code>即可，最后安装到了 <code>/usr/local/apache2</code> 下。</p><h3 id="修改配置文件">修改配置文件</h3><h4 id="语言支持">语言支持</h4><p>我们修改 <code>/usr/local/apache2/conf</code> 里的<code>httpd.conf</code> 的参数以获得中文语言支持，我们删除第 159 行以及481 行的注释即可：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215002204065.png" alt="image-20250215002204065"><figcaption aria-hidden="true">image-20250215002204065</figcaption></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215002456908.png" alt="image-20250215002456908"><figcaption aria-hidden="true">image-20250215002456908</figcaption></figure><p>我们会发现如果想要使用一些功能，只需要在这里取消一些功能的对应注释即可～</p><h4 id="php-支持">PHP 支持</h4><p>另外我们还需要开启 PHP 的插件，当有用户访问 PHP 程序时，Apache自动转发给 PHP 去解析，168 和 169 行的意思是以 <code>.php</code>结尾的文件都认为是 PHP 程序文件</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215004856276.png" alt="image-20250215004856276"><figcaption aria-hidden="true">image-20250215004856276</figcaption></figure><p>并且要设置当访问这台机器的时候，当什么都不添加时会访问磁盘上的<code>index.php</code> 文件：</p><p>原本是这样的：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215005511442.png" alt="image-20250215005511442"><figcaption aria-hidden="true">image-20250215005511442</figcaption></figure><p>要改成这样（谁在前面就先解析谁）：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215005537989.png" alt="image-20250215005537989"><figcaption aria-hidden="true">image-20250215005537989</figcaption></figure><p>这行参数的作用就是会让原本只是访问 <code>8.134.207.88</code>自动变成访问 <code>8.134.207.88/index.php</code>。</p><h4 id="html-文件路径">HTML 文件路径</h4><p>关于网站默认的首页 HTML 文件存放的目录路径由以下参数控制：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215010011089.png" alt="image-20250215010011089"><figcaption aria-hidden="true">image-20250215010011089</figcaption></figure><h4 id="修改子配置文件">修改子配置文件</h4><p>要修改该配置文件使得优先支持中文：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/apache2/conf/extra/httpd-languages.conf</span><br></pre></td></tr></table></figure><p>取消第 19 行的注释，将原本的 <code>DefaultLanguage nl</code> 修改为<code>DefaultLanguage zh-CN</code></p><p>以及调整第 79 行的优先级，将中文的优先级放在第一个：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LanguagePriority zh-CN en ca cs da de el eo es et fr he hr it ja ko ltz <span class="built_in">nl</span> nn no pl pt pt-BR ru sv <span class="built_in">tr</span> zh-TW</span><br></pre></td></tr></table></figure><h4 id="域名设置">域名设置</h4><p>可以在主配置文件的这里添加域名：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215010744599.png" alt="image-20250215010744599"><figcaption aria-hidden="true">image-20250215010744599</figcaption></figure><h2 id="编译安装-php">5. 编译安装 PHP</h2><h3 id="编译与安装">编译与安装</h3><p>这里比较简单，我们直接快速操作了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://museum.php.net/php7/php-7.2.17.tar.xz</span><br><span class="line">tar -xf php-7.2.17.tar.xz</span><br><span class="line"><span class="built_in">cd</span> php-7.2.17</span><br><span class="line">vim configure_php.sh</span><br></pre></td></tr></table></figure><p>在文件中写入：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">  --with-apxs2=/usr/local/apache2/bin/apxs \</span><br><span class="line">  --with-mysqli \</span><br><span class="line">  --with-pdo-mysql \</span><br><span class="line">  --with-zlib \</span><br><span class="line">  --with-curl \</span><br><span class="line">  --enable-zip \</span><br><span class="line">  --with-gd \</span><br><span class="line">  --with-freetype-dir \</span><br><span class="line">  --with-jpeg-dir \</span><br><span class="line">  --with-png-dir \</span><br><span class="line">  --enable-sockets \</span><br><span class="line">  --with-xmlrpc \</span><br><span class="line">  --enable-soap \</span><br><span class="line">  --enable-opcache \</span><br><span class="line">  --enable-mbstring \</span><br><span class="line">  --enable-mbregex \</span><br><span class="line">  --enable-pcntl \</span><br><span class="line">  --enable-shmop \</span><br><span class="line">  --enable-sysvmsg \</span><br><span class="line">  --enable-sysvsem \</span><br><span class="line">  --enable-sysvshm \</span><br><span class="line">  --enable-calendar \</span><br><span class="line">  --enable-bcmath</span><br></pre></td></tr></table></figure><p>然后依次执行<code>chmod +x configure_php.sh</code>、<code>./configure_php.sh</code> 与<code>make &amp;&amp; make install</code> 即可。</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215014045762.png" alt="image-20250215014045762"><figcaption aria-hidden="true">image-20250215014045762</figcaption></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215014117280.png" alt="image-20250215014117280"><figcaption aria-hidden="true">image-20250215014117280</figcaption></figure><h3 id="检查-apache是否支持php">检查 Apache是否支持PHP</h3><p>进入 Apache 的网页根目录<code>/usr/local/apache2/htdocs</code>，创建一个 PHP文件，查看是否支持：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215011611322.png" alt="image-20250215011611322"><figcaption aria-hidden="true">image-20250215011611322</figcaption></figure><p>启动 Apache：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z php-7.2.17]<span class="comment"># service apache start</span></span><br><span class="line">AH00558: httpd: Could not reliably determine the server<span class="string">&#x27;s fully qualified domain name, using 172.20.53.217. Set the &#x27;</span>ServerName<span class="string">&#x27; directive globally to suppress this message</span></span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215015006688.png" alt="image-20250215015006688"><figcaption aria-hidden="true">image-20250215015006688</figcaption></figure><p>查看对应的 IP 地址，访问正常：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215015140320.png" alt="image-20250215015140320"><figcaption aria-hidden="true">image-20250215015140320</figcaption></figure><p>由于默认端口和默认文件都已经配置好了，就不需要再写端口和<code>index.php</code> 了</p><h2 id="wordpress">6. WordPress</h2><p>下载源码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># wget https://cn.wordpress.org/wordpress-4.7.3-zh_CN.tar.gz</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># mkdir wordpress</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># mv wordpress-4.7.3-zh_CN.tar.gz  wordpress</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z source-code]<span class="comment"># cd wordpress/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># tar -zxf wordpress-4.7.3-zh_CN.tar.gz </span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># ls</span></span><br><span class="line">wordpress  wordpress-4.7.3-zh_CN.tar.gz</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># cp -a wordpress/* ../www/test_wordpress_blog/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># chown -R daemon.daemon ../www/test_wordpress_blog/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># rm -rf /usr/local/apache2/htdocs/*</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># mv ../www/test_wordpress_blog/* /usr/local/apache2/htdocs/</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z wordpress]<span class="comment"># ls /usr/local/apache2/htdocs/</span></span><br><span class="line">index.php    wp-activate.php     wp-comments-post.php  wp-cron.php        wp-load.php   wp-settings.php   xmlrpc.php</span><br><span class="line">license.txt  wp-admin            wp-config-sample.php  wp-includes        wp-login.php  wp-signup.php</span><br><span class="line">readme.html  wp-blog-header.php  wp-content            wp-links-opml.php  wp-mail.php   wp-trackback.php</span><br></pre></td></tr></table></figure><p>访问网站会有下面的内容：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020259972.png" alt="image-20250215020259972"><figcaption aria-hidden="true">image-20250215020259972</figcaption></figure><p>填写基本信息后发现我们还没有创建这个数据库：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020513590.png" alt="image-20250215020513590"><figcaption aria-hidden="true">image-20250215020513590</figcaption></figure><p>我们进入 MySQL 进行操作：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020803966.png" alt="image-20250215020803966"><figcaption aria-hidden="true">image-20250215020803966</figcaption></figure><p>注意我们需要回到前面修改我们前面创建的数据库名，使得数据库名与我们创建的能对得上：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020903213.png" alt="image-20250215020903213"><figcaption aria-hidden="true">image-20250215020903213</figcaption></figure><p>然后再执行一下傻瓜操作：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215020921167.png" alt="image-20250215020921167"><figcaption aria-hidden="true">image-20250215020921167</figcaption></figure><p>然后执行完下面这一步就结束了：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215021153620.png" alt="image-20250215021153620"><figcaption aria-hidden="true">image-20250215021153620</figcaption></figure><p>一个漂亮的博客管理页面就做好啦：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250215021254303.png" alt="image-20250215021254303"><figcaption aria-hidden="true">image-20250215021254303</figcaption></figure><hr><h1 id="六debug日志">六、<code>debug</code>日志</h1><h2 id="新版本-mysql-安装凉经">1. 新版本 MySQL 安装凉经</h2><p>这里我们创建文件夹的方式都一样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local</span><br><span class="line"><span class="built_in">mkdir</span> software-mysql</span><br><span class="line"><span class="built_in">cd</span> software-mysql</span><br></pre></td></tr></table></figure><p>同样在<a class="link" href="https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/">华为提供的库内<i class="fas fa-external-link-alt"></i></a>下载需要的MySQL 版本，我们选择了较新版的 8.0.25：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212171518515.png" alt="image-20250212171518515"><figcaption aria-hidden="true">image-20250212171518515</figcaption></figure><p>下载源码并解压缩：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo.huaweicloud.com:8443/artifactory/mysql-local/Downloads/MySQL-8.0/mysql-8.0.25.tar.gz</span><br><span class="line">tar -xzvf mysql-8.0.25.tar.gz</span><br><span class="line"><span class="built_in">du</span> -sh *</span><br></pre></td></tr></table></figure><h3 id="关于-cmake-版本">🧰 关于 cmake 版本</h3><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212175149284.png" alt="image-20250212175149284"><figcaption aria-hidden="true">image-20250212175149284</figcaption></figure><p>在安装 MySQL 的时候我们需要使用 <code>cmake</code>进行编译，首先我遇到了 <code>cmake</code> 的版本问题，我们通过升级<code>cmake</code> 版本修正这个问题：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212200732906.png" alt="image-20250212200732906"><figcaption aria-hidden="true">image-20250212200732906</figcaption></figure><p>修改指令并尝试运行该文件</p><h3 id="gcc-路径">🧰 gcc 路径</h3><p>好的，不出意外地再次报错</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250212200925468.png" alt="image-20250212200925468"><figcaption aria-hidden="true">image-20250212200925468</figcaption></figure><p>我们通过 <code>cmak</code><code>命令中的</code>CMAKE_C_COMPILER<code>和</code>CMAKE_CXX_COMPILER`变量来手动指定编译器路径。例如，假设 gcc 和 g++安装在默认路径下，尝试如下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 . \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>依然不是很成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-8.0.25]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 4.8.5</span><br><span class="line">-- The CXX compiler identification is GNU 4.8.5</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">CMake Error at CMakeLists.txt:382 (MESSAGE):</span><br><span class="line">  Please <span class="keyword">do</span> not build in-source.  Out-of <span class="built_in">source</span> builds are highly</span><br><span class="line">  recommended: you can have multiple builds <span class="keyword">for</span> the same <span class="built_in">source</span>, and there is</span><br><span class="line">  an easy way to <span class="keyword">do</span> cleanup, simply remove the build directory (note that</span><br><span class="line">  <span class="string">&#x27;make clean&#x27;</span> or <span class="string">&#x27;make distclean&#x27;</span> does *not* work)</span><br><span class="line"></span><br><span class="line">  You *can* force in-source build by invoking cmake with</span><br><span class="line">  -DFORCE_INSOURCE_BUILD=1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br></pre></td></tr></table></figure><p>这条报错是在说 CMake强烈建议不要在源代码目录内进行编译，因为这样会造成源代码目录的污染，无法轻松清理。理想的做法是<strong>在源代码外的单独目录中进行构建</strong>。这个还比较好解决，如果我们非要<strong>在源代码目录中构建，可以通过使用-DFORCE_INSOURCE_BUILD=1 强制进行构建，但这不是推荐的做法：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 强制在源代码目录内构建</span></span><br><span class="line">cmake3 . -DFORCE_INSOURCE_BUILD=1</span><br></pre></td></tr></table></figure><p>推荐的做法是：</p><p><strong>2. 在源代码目录之外创建一个新的目录进行构建</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 返回到 /usr/local/software-mysql</span></span><br><span class="line"><span class="built_in">cd</span> /usr/local/software-mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个新的构建目录</span></span><br><span class="line"><span class="built_in">mkdir</span> mysql-build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入构建目录</span></span><br><span class="line"><span class="built_in">cd</span> mysql-build</span><br></pre></td></tr></table></figure><p>那我们使用后者吧：</p><p>在开始编译之前我们需要清理原来的 <code>builds</code> 文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">rm</span> -rf /usr/local/software-mysql/mysql-8.0.25/CMakeFiles</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/local/software-mysql/mysql-8.0.25/CMakeCache.txt</span><br></pre></td></tr></table></figure><p>然后我们修改 <code>cmake.sh</code> 命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 /usr/local/software-mysql/mysql-8.0.25 \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>再运行它一次！我不信还会出错了！</p><p>然而。。。果然又有新的问题了。。。这次是 GCC 版本过低，MySQL 8.0.25需要 GCC 5.3 或更高版本来进行编译：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- Found Git: /usr/bin/git (found version <span class="string">&quot;1.8.3.1&quot;</span>) </span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 4.8.5</span><br><span class="line">-- The CXX compiler identification is GNU 4.8.5</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-build</span><br><span class="line">-- CMAKE_GENERATOR: Unix Makefiles</span><br><span class="line">CMake Error at cmake/os/Linux.cmake:80 (MESSAGE):</span><br><span class="line">  GCC 5.3 or newer is required (-dumpversion says 4.8.5)</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  CMakeLists.txt:491 (INCLUDE)</span><br></pre></td></tr></table></figure><h3 id="关于-centos-release-scl-的一个小插曲待解决">🧰 关于<code>centos-release-scl</code> 的一个小插曲（待解决）</h3><p>我试图安装 <code>centos-release-scl</code> 进而安装新版本的<code>gcc</code>，这个软件包提供了 <strong>Software Collections(SCL)</strong> 的支持。SCL是一种在不影响系统默认软件版本的情况下，让用户安装和使用不同版本的软件包的机制。简单来说，它允许用户安装、使用与系统默认版本不同的软件版本，例如最新版本的Python、GCC、Ruby、PHP 等，而不需要更改系统的默认版本。SCL提供了以下优势：</p><ol type="1"><li>你可以同时使用多个版本的相同软件，比如使用系统自带的老版本Python，同时安装并使用新版本的 Python。</li><li>在不同的环境中切换版本变得更加灵活。</li><li>不会影响到系统自带的包，减少了与其他系统包的冲突风险。</li></ol><p>安装命令很简单：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install centos-release-scl -y</span><br></pre></td></tr></table></figure><p>但安装完之后其他包的安装存在了问题，例如我原本准备执行这个命令安装<code>gcc</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install devtoolset-8-gcc* -y</span><br></pre></td></tr></table></figure><p>然而报了如下的错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># sudo yum install devtoolset-8-gcc* -y</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Could not retrieve mirrorlist http://mirrorlist.centos.org?<span class="built_in">arch</span>=x86_64&amp;release=7&amp;repo=sclo-rh error was</span><br><span class="line">14: curl<span class="comment">#6 - &quot;Could not resolve host: mirrorlist.centos.org; Unknown error&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> One of the configured repositories failed (Unknown),</span><br><span class="line"> and yum doesn<span class="string">&#x27;t have enough cached data to continue. At this point the only</span></span><br><span class="line"><span class="string"> safe thing yum can do is fail. There are a few ways to work &quot;fix&quot; this:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     1. Contact the upstream for the repository and get them to fix the problem.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     2. Reconfigure the baseurl/etc. for the repository, to point to a working</span></span><br><span class="line"><span class="string">        upstream. This is most often useful if you are using a newer</span></span><br><span class="line"><span class="string">        distribution release than is supported by the repository (and the</span></span><br><span class="line"><span class="string">        packages for the previous distribution release still work).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     3. Run the command with the repository temporarily disabled</span></span><br><span class="line"><span class="string">            yum --disablerepo=&lt;repoid&gt; ...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">     4. Disable the repository permanently, so yum won&#x27;</span>t use it by default. Yum</span><br><span class="line">        will <span class="keyword">then</span> just ignore the repository until you permanently <span class="built_in">enable</span> it</span><br><span class="line">        again or use --enablerepo <span class="keyword">for</span> temporary usage:</span><br><span class="line"></span><br><span class="line">            yum-config-manager --<span class="built_in">disable</span> &lt;repoid&gt;</span><br><span class="line">        or</span><br><span class="line">            subscription-manager repos --<span class="built_in">disable</span>=&lt;repoid&gt;</span><br><span class="line"></span><br><span class="line">     5. Configure the failing repository to be skipped, <span class="keyword">if</span> it is unavailable.</span><br><span class="line">        Note that yum will try to contact the repo. when it runs most commands,</span><br><span class="line">        so will have to try and fail each time (and thus. yum will be be much</span><br><span class="line">        slower). If it is a very temporary problem though, this is often a <span class="built_in">nice</span></span><br><span class="line">        compromise:</span><br><span class="line"></span><br><span class="line">            yum-config-manager --save --<span class="built_in">setopt</span>=&lt;repoid&gt;.skip_if_unavailable=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Cannot find a valid baseurl <span class="keyword">for</span> repo: centos-sclo-rh/x86_64</span><br></pre></td></tr></table></figure><p>显示软件源可以看到多了两条：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># ls /etc/yum.repos.d/</span></span><br><span class="line">CentOS-Base.repo  CentOS-SCLo-scl.repo  CentOS-SCLo-scl-rh.repo  epel.repo  epel.repo.rpmnew  epel-testing.repo</span><br></pre></td></tr></table></figure><p>以 <code>CentOS-SCLo-scl.repo</code> 为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># cat /etc/yum.repos.d/CentOS-SCLo-scl.repo </span></span><br><span class="line"><span class="comment"># CentOS-SCLo-sclo.repo</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see http://wiki.centos.org/SpecialInterestGroup/SCLo for more</span></span><br><span class="line"><span class="comment"># information</span></span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo]</span><br><span class="line">name=CentOS-7 - SCLo sclo</span><br><span class="line"><span class="comment"># baseurl=http://mirror.centos.org/centos/7/sclo/$basearch/sclo/</span></span><br><span class="line">mirrorlist=http://mirrorlist.centos.org?<span class="built_in">arch</span>=<span class="variable">$basearch</span>&amp;release=7&amp;repo=sclo-sclo</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-testing]</span><br><span class="line">name=CentOS-7 - SCLo sclo Testing</span><br><span class="line">baseurl=http://buildlogs.centos.org/centos/7/sclo/<span class="variable">$basearch</span>/sclo/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-source]</span><br><span class="line">name=CentOS-7 - SCLo sclo Sources</span><br><span class="line">baseurl=http://vault.centos.org/centos/7/sclo/Source/sclo/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br><span class="line"></span><br><span class="line">[centos-sclo-sclo-debuginfo]</span><br><span class="line">name=CentOS-7 - SCLo sclo Debuginfo</span><br><span class="line">baseurl=http://debuginfo.centos.org/centos/7/sclo/<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo</span><br></pre></td></tr></table></figure><p>我们只能先禁用他们：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁用 centos-sclo-sclo 仓库</span></span><br><span class="line">sudo yum-config-manager --<span class="built_in">disable</span> centos-sclo-sclo</span><br><span class="line">sudo yum-config-manager --<span class="built_in">disable</span> centos-sclo-rh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除缓存</span></span><br><span class="line">sudo yum clean all</span><br><span class="line">sudo yum makecache</span><br></pre></td></tr></table></figure><p>这个限于目前的技术水平，暂时不知道是什么原因，我估计是梯子的问题，留待之后排查</p><h3 id="继续解决前面的-gcc-版本问题">🧰 继续解决前面的 <code>gcc</code>版本问题</h3><p>我们可以尝试直接源码编译</p><p>访问 GCC 的官方网站下载最新版本的源代码，并执行 configure脚本以及编译步骤：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftp.gnu.org/gnu/gcc/gcc-8.5.0/gcc-8.5.0.tar.gz</span><br><span class="line">tar -xvzf gcc-8.5.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> gcc-8.5.0</span><br><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">sudo yum install -y gmp-devel mpfr-devel libmpc-devel</span><br><span class="line"><span class="comment"># 运行 configure 脚本</span></span><br><span class="line">./configure --disable-multilib --enable-languages=c,c++</span><br><span class="line"></span><br><span class="line">make -j$(<span class="built_in">nproc</span>)  <span class="comment"># 使用所有 CPU 核心加速编译</span></span><br><span class="line"><span class="comment"># 通过 make -j 来增加并行任务数，make -j2 表示使用两个并行任务</span></span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><p>这个编译过程特别耗时，对于 GCC 8.5.0 这种大型项目，单核 CPU编译可能需要 <strong>6-12 小时</strong>，两核 CPU 的情况下，可能需要<strong>3-6 小时</strong> 或更长时间。</p><p>编译完之后，我们还需要把这个<code>gcc</code>的路径加入到环境变量中，特别是 <code>PATH</code> 和<code>LD_LIBRARY_PATH</code>，首先我们查找路径：</p><ol type="1"><li><p>找到新 GCC 的安装路径。通常，<code>make install</code> 会将 GCC安装到 <code>/usr/local/bin</code> 中。</p></li><li><p>通过以下命令检查新 GCC 是否安装在<code>/usr/local/bin</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /usr/local/bin/gcc</span><br></pre></td></tr></table></figure><p>如果文件存在，表示新的 GCC 已安装在该目录。</p></li></ol><p>接下来在 <code>~/.bashrc</code> 文件中添加新 GCC 的路径：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=/usr/local/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/local/lib64:<span class="variable">$LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213181357527.png" alt="image-20250213181357527"><figcaption aria-hidden="true">image-20250213181357527</figcaption></figure><p>然后退出并 <code>source ~/.bashrc</code> 即可，我们再次打印<code>gcc --version</code> 会发现版本已经更新了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># vim ~/.bashrc</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># source ~/.bashrc</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z gcc-8.5.0]<span class="comment"># gcc --version</span></span><br><span class="line">gcc (GCC) 8.5.0</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure><h3 id="boost-依赖项">🧰 <code>Boost</code> 依赖项</h3><p>我们需要修改 <code>cmake.sh</code> 文件里的 <code>gcc</code>的路径为最新安装的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cmake3 /usr/local/software-mysql/mysql-8.0.25  \</span><br><span class="line">  -DCMAKE_C_COMPILER=/usr/local/bin/gcc \</span><br><span class="line">  -DCMAKE_CXX_COMPILER=/usr/local/bin/g++ \</span><br><span class="line">  -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \</span><br><span class="line">  -DMYSQL_DATADIR=/usr/local/mysql/data \</span><br><span class="line">  -DENABLED_LOCAL_INFILE=1 \</span><br><span class="line">  -DWITH_INNOBASE_STORAGE_ENGINE=1 \</span><br><span class="line">  -DMYSQL_TCP_PORT=3306 \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4 \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci \</span><br><span class="line">  -DWITH_EXTRA_CHARSETS=all \</span><br><span class="line">  -DMYSQL_USER=mysql</span><br></pre></td></tr></table></figure><p>然后清除目录下的 CMakeFiles 和 CMakeCache.txt：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># rm -rf CMakeFiles</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># rm -rf CMakeCache.txt</span></span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh</span></span><br></pre></td></tr></table></figure><p>现在出现了新的报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z mysql-build]<span class="comment"># ./cmake.sh </span></span><br><span class="line">-- Running cmake version 3.17.5</span><br><span class="line">-- Found Git: /usr/bin/git (found version <span class="string">&quot;1.8.3.1&quot;</span>) </span><br><span class="line">-- CMP0073 OLD</span><br><span class="line">-- CMAKE_MODULE_PATH is /usr/local/software-mysql/mysql-8.0.25/cmake</span><br><span class="line">-- MySQL 8.0.25</span><br><span class="line">-- The C compiler identification is GNU 8.5.0</span><br><span class="line">-- The CXX compiler identification is GNU 8.5.0</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/local/bin/gcc</span><br><span class="line">-- Check <span class="keyword">for</span> working C compiler: /usr/local/bin/gcc - works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting C compile features</span><br><span class="line">-- Detecting C compile features - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/local/bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/local/bin/g++ - works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Source directory /usr/local/software-mysql/mysql-8.0.25</span><br><span class="line">-- Binary directory /usr/local/software-mysql/mysql-build</span><br><span class="line">-- CMAKE_GENERATOR: Unix Makefiles</span><br><span class="line">-- Looking <span class="keyword">for</span> SHM_HUGETLB</span><br><span class="line">-- Looking <span class="keyword">for</span> SHM_HUGETLB - found</span><br><span class="line">-- Looking <span class="keyword">for</span> sys/types.h</span><br><span class="line">-- Looking <span class="keyword">for</span> sys/types.h - found</span><br><span class="line">-- Looking <span class="keyword">for</span> stdint.h</span><br><span class="line">-- Looking <span class="keyword">for</span> stdint.h - found</span><br><span class="line">-- Looking <span class="keyword">for</span> stddef.h</span><br><span class="line">-- Looking <span class="keyword">for</span> stddef.h - found</span><br><span class="line">-- Check size of void *</span><br><span class="line">-- Check size of void * - <span class="keyword">done</span></span><br><span class="line">-- SIZEOF_VOIDP 8</span><br><span class="line">-- Performing Test HAVE_C_FLOATING_POINT_FUSED_MADD</span><br><span class="line">-- Performing Test HAVE_C_FLOATING_POINT_FUSED_MADD - Failed</span><br><span class="line">-- Performing Test HAVE_CXX_FLOATING_POINT_FUSED_MADD</span><br><span class="line">-- Performing Test HAVE_CXX_FLOATING_POINT_FUSED_MADD - Failed</span><br><span class="line">-- Packaging as: mysql-8.0.25-Linux-x86_64</span><br><span class="line">-- Performing Test C_LD_LLD_RESULT</span><br><span class="line">-- Performing Test C_LD_LLD_RESULT - Failed</span><br><span class="line">-- Performing Test CXX_LD_LLD_RESULT</span><br><span class="line">-- Performing Test CXX_LD_LLD_RESULT - Failed</span><br><span class="line">-- Performing Test C_LD_GOLD_RESULT</span><br><span class="line">-- Performing Test C_LD_GOLD_RESULT - Success</span><br><span class="line">-- Performing Test CXX_LD_GOLD_RESULT</span><br><span class="line">-- Performing Test CXX_LD_GOLD_RESULT - Success</span><br><span class="line">-- Looked <span class="keyword">for</span> boost/version.hpp <span class="keyword">in</span>  and </span><br><span class="line">-- BOOST_INCLUDE_DIR BOOST_INCLUDE_DIR-NOTFOUND</span><br><span class="line">-- LOCAL_BOOST_DIR </span><br><span class="line">-- LOCAL_BOOST_ZIP </span><br><span class="line">-- Could not find (the correct version of) boost.</span><br><span class="line">-- MySQL currently requires boost_1_73_0</span><br><span class="line"></span><br><span class="line">CMake Error at cmake/boost.cmake:107 (MESSAGE):</span><br><span class="line">  You can download it with -DDOWNLOAD_BOOST=1 -DWITH_BOOST=&lt;directory&gt;</span><br><span class="line"></span><br><span class="line">  This CMake script will look <span class="keyword">for</span> boost <span class="keyword">in</span> &lt;directory&gt;.  If it is not there,</span><br><span class="line">  it will download and unpack it (<span class="keyword">in</span> that directory) <span class="keyword">for</span> you.</span><br><span class="line"></span><br><span class="line">  You can also download boost manually, from</span><br><span class="line">  https://dl.bintray.com/boostorg/release/1.73.0/source/boost_1_73_0.tar.gz</span><br><span class="line"></span><br><span class="line">  If you are inside a firewall, you may need to use an https proxy:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> https_proxy=http://example.com:80</span><br><span class="line"></span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  cmake/boost.cmake:276 (COULD_NOT_FIND_BOOST)</span><br><span class="line">  CMakeLists.txt:1147 (INCLUDE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Configuring incomplete, errors occurred!</span><br><span class="line">See also <span class="string">&quot;/usr/local/software-mysql/mysql-build/CMakeFiles/CMakeOutput.log&quot;</span>.</span><br><span class="line">See also <span class="string">&quot;/usr/local/software-mysql/mysql-build/CMakeFiles/CMakeError.log&quot;</span>.</span><br></pre></td></tr></table></figure><p>当前问题是 <strong>找不到 Boost 1.73.0</strong> 版本，这是 MySQL8.0.25 的一个依赖项。</p><ol type="1"><li><p><strong>下载并安装 Boost 1.73.0</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/local/software-mysql/mysql-build</span><br><span class="line">wget https://archives.boost.io/release/1.73.0/source/boost_1_73_0.tar.gz</span><br><span class="line">tar -xvzf boost_1_73_0.tar.gz</span><br></pre></td></tr></table></figure></li><li><p>在 <code>cmake.sh</code> 文件最后添加一行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-DWITH_BOOST=/usr/local/software-mysql/mysql-build/boost_1_73_0</span><br></pre></td></tr></table></figure></li><li><p>然后执行 <code>cmake.sh</code> 文件即可：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213191157461.png" alt="image-20250213191157461"><figcaption aria-hidden="true">image-20250213191157461</figcaption></figure></li></ol><p>成功～</p><p>我们将所有 CPU 一起启动在后台安装，并将日志输出到<code>mysql_make_output.log</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> make -j$(<span class="built_in">nproc</span>) &gt; mysql_make_output.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213191603813.png" alt="image-20250213191603813"><figcaption aria-hidden="true">image-20250213191603813</figcaption></figure><p>胜利的曙光就在眼前～让我们拭目以待！！！</p><h3 id="程序被系统终止重新-make">🧰 程序被系统终止（重新<code>make</code>）</h3><p>不出意外的是，又出问题了 👿</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250213204627873.png" alt="image-20250213204627873"><figcaption aria-hidden="true">image-20250213204627873</figcaption></figure><blockquote><p>可能的原因如下：</p><p><strong>1. 内存不足</strong></p><p>编译 MySQL 这样的复杂程序时，特别是在使用<code>make -j$(nproc)</code>进行并行编译时，系统可能会耗尽内存。<code>cc1plus</code> 是<code>g++</code>编译器的一个关键部分，当系统的内存不足时，操作系统可能会终止该进程。</p><p><strong>解决方案</strong>：</p><ul><li>增加系统的物理内存。</li><li>如果是虚拟机，考虑增加虚拟内存或增加物理内存。</li><li>如果不能增加内存，可以尝试减少并行任务数，使用 <code>make -j2</code>或者 <code>make -j1</code> 让编译过程使用较少的内存。</li></ul><p><strong>2. SWAP空间不足</strong></p><p>当内存不足时，系统会使用交换空间（SWAP）。如果 SWAP空间不足，也会导致编译失败。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查当前的 SWAP 空间：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">swapon -s</span><br></pre></td></tr></table></figure></li><li><p>如果 SWAP 空间不足，可以通过以下命令增加 SWAP：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1M count=4096  <span class="comment"># 创建一个 4GB 的交换文件</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /swapfile  <span class="comment"># 设置权限</span></span><br><span class="line">sudo mkswap /swapfile  <span class="comment"># 设置交换文件</span></span><br><span class="line">sudo swapon /swapfile  <span class="comment"># 启用交换文件</span></span><br></pre></td></tr></table></figure></li></ul><p><strong>3. CPU 或系统资源被占满</strong></p><p>由于并行编译使用了大量的 CPU核心，系统可能因资源消耗过高导致进程被杀死。</p><p><strong>解决方案</strong>：</p><ul><li>降低 make 命令的并行度，减少 CPU 核心数的使用，尝试 make -j2 或 make-j1。</li></ul><p><strong>4. 硬盘空间不足</strong></p><p>如果磁盘空间不足，编译过程中的临时文件和输出文件可能无法正确写入磁盘，导致编译中断。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查磁盘空间：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure></li><li><p>如果磁盘空间不足，删除一些不必要的文件或扩展磁盘空间。</p></li></ul><p><strong>5. 系统限制</strong></p><p>Linux 系统有时会根据进程的资源使用情况（如内存、CPU时间等）进行限制，可能会在某些情况下杀死进程。</p><p><strong>解决方案</strong>：</p><ul><li><p>检查 ulimit 设置，增加进程允许使用的内存或文件描述符数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -a  <span class="comment"># 查看所有限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -n  <span class="comment"># 查看文件描述符限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -u  <span class="comment"># 查看最大进程数限制</span></span><br></pre></td></tr></table></figure></li></ul></blockquote><p>经过检查猜测大概率是内存不足的问题，现在我们需要使用<code>make clean</code> 命令清理之前的编译结果，这会删除<code>make</code> 过程中生成的所有中间文件和目标文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line"><span class="built_in">rm</span> -rf CMakeCache.txt CMakeFiles</span><br><span class="line">./cmake.sh</span><br></pre></td></tr></table></figure><p>我们对交换空间、虚拟内存与 CPU 核数均做了优化：</p><ol type="1"><li><p>按前面所说流程增加交换空间大小</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/swapfile bs=1M count=4096  <span class="comment"># 创建一个 4GB 的交换文件</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /swapfile  <span class="comment"># 设置权限</span></span><br><span class="line">sudo mkswap /swapfile  <span class="comment"># 设置交换文件</span></span><br><span class="line">sudo swapon /swapfile  <span class="comment"># 启用交换文件</span></span><br></pre></td></tr></table></figure></li><li><p>为了让交换空间在系统重启后自动生效，编辑 /etc/fstab文件并添加以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/swapfile none swap sw 0 0</span><br></pre></td></tr></table></figure></li><li><p>然后增加操作系统的虚拟内存限制，来避免进程因内存溢出而被杀死：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -v unlimited</span><br></pre></td></tr></table></figure></li><li><p>最后再尝试使用单核 CPU 进行编译：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./cmake.sh</span><br><span class="line"><span class="built_in">nohup</span> make -j1 &gt; mysql_make_output.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="comment"># 使用下面命令查看日志</span></span><br><span class="line"><span class="built_in">tail</span> -f /usr/local/software-mysql/mysql-build/mysql_make_output.log</span><br></pre></td></tr></table></figure></li></ol><p>下面还是老样子，再次祈祷！</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214105213109.png" alt="image-20250214105213109"><figcaption aria-hidden="true">image-20250214105213109</figcaption></figure><p>经过了漫长的等待，终于迎来了胜利！</p><p>再把这个 <code>bin</code> 的路径保存到 <code>~/.bashrc</code>并激活即可：</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214121526166.png" alt="image-20250214121526166"><figcaption aria-hidden="true">image-20250214121526166</figcaption></figure><h3 id="gcc-版本还是太低">🧰 gcc 版本还是太低</h3><p>看起来一切都很顺利，但在最后的初始化这一步还是凉了～</p><figure><img src="/LAMP%20%E4%B8%8E%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%A6%E8%A7%A3/image-20250214132359514.png" alt="image-20250214132359514"><figcaption aria-hidden="true">image-20250214132359514</figcaption></figure><p>运行以下命令来列出 libstdc++ 的版本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># strings /usr/lib64/libstdc++.so.6 | grep GLIBCXX</span></span><br><span class="line">GLIBCXX_3.4</span><br><span class="line">GLIBCXX_3.4.1</span><br><span class="line">GLIBCXX_3.4.2</span><br><span class="line">GLIBCXX_3.4.3</span><br><span class="line">GLIBCXX_3.4.4</span><br><span class="line">GLIBCXX_3.4.5</span><br><span class="line">GLIBCXX_3.4.6</span><br><span class="line">GLIBCXX_3.4.7</span><br><span class="line">GLIBCXX_3.4.8</span><br><span class="line">GLIBCXX_3.4.9</span><br><span class="line">GLIBCXX_3.4.10</span><br><span class="line">GLIBCXX_3.4.11</span><br><span class="line">GLIBCXX_3.4.12</span><br><span class="line">GLIBCXX_3.4.13</span><br><span class="line">GLIBCXX_3.4.14</span><br><span class="line">GLIBCXX_3.4.15</span><br><span class="line">GLIBCXX_3.4.16</span><br><span class="line">GLIBCXX_3.4.17</span><br><span class="line">GLIBCXX_3.4.18</span><br><span class="line">GLIBCXX_3.4.19</span><br><span class="line">GLIBCXX_DEBUG_MESSAGE_LENGTH</span><br><span class="line">[root@iZ7xv858yt7ltpn85a6qv8Z ~]<span class="comment"># strings /usr/lib64/libstdc++.so.6 | grep CXXABI</span></span><br><span class="line">CXXABI_1.3</span><br><span class="line">CXXABI_1.3.1</span><br><span class="line">CXXABI_1.3.2</span><br><span class="line">CXXABI_1.3.3</span><br><span class="line">CXXABI_1.3.4</span><br><span class="line">CXXABI_1.3.5</span><br><span class="line">CXXABI_1.3.6</span><br><span class="line">CXXABI_1.3.7</span><br><span class="line">CXXABI_TM_1</span><br></pre></td></tr></table></figure><p>还得重新安装 GCC 9才能行得通，886了！下次安装前一定要提前看好适配的包是什么，要去官网先看一遍安装教程，不然又会凉🥹 血的教训！一定要人家写了什么版本就安装什么版本！！</p><h2 id="php-编译">2. PHP 编译</h2><p>如果 <code>configure</code> 的时候遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configure: error: libxml2 not found. Please check your libxml2 installation.</span><br></pre></td></tr></table></figure><p>可以执行以下命令补充安装再次 <code>configure</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install libxml2 libxml2-devel -y</span><br></pre></td></tr></table></figure><p>遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checking <span class="keyword">for</span> cURL 7.10.5 or greater... configure: error: cURL version 7.10.5 or later is required to compile php with cURL support</span><br></pre></td></tr></table></figure><p>则升级 <code>cURL</code> 即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install curl curl-devel -y</span><br></pre></td></tr></table></figure><p>遇到报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">checking whether to <span class="built_in">enable</span> JIS-mapped Japanese font support <span class="keyword">in</span> GD... no</span><br><span class="line">If configure fails try --with-webp-dir=&lt;DIR&gt;</span><br><span class="line">configure: error: jpeglib.h not found.</span><br></pre></td></tr></table></figure><p>说明在配置 PHP 时，找不到 jpeglib.h 头文件，这是 JPEG图像库的一部分，PHP 在编译时需要它来支持处理 JPEG 图像：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install libjpeg-devel -y</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;This post is a practical “from zero to running site” walkthrough for
setting up a classic LAMP stack on an Alibaba Cloud ECS instance. It
starts with the request path and the moving parts (Linux + Apache +
MySQL + PHP), then covers the real-world blockers that usually derail
first-time setups: security groups, firewall rules, service startup,
directory permissions, and version/extension mismatches. Beyond the
standard package-based installation, it also includes a more advanced
track (building components from source and cleaning legacy
environments), so you can still get a working stack when repositories or
default versions are not a good fit.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 文件权限</title>
    <link href="https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/"/>
    <id>https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/</id>
    <published>2025-02-13T16:00:00.000Z</published>
    <updated>2026-01-28T01:24:18.585Z</updated>
    
    <content type="html"><![CDATA[<p>文件权限是 Linux运维里最“基础但最容易踩坑”的部分：一边是权限不足导致服务起不来、脚本跑不动；另一边是权限给大了带来安全风险。要把它用对，你需要的不只是记住<code>chmod 755</code>，而是理解<strong>权限位在文件与目录上的差异</strong>、属主/属组/其他人的边界、以及<code>umask</code>、SUID/SGID、Sticky Bit这些机制为什么会存在。本篇会从最小概念集出发，系统讲清<code>rwx</code>、数字/符号写法、<code>chmod/chown</code>的典型用法与排错思路，并用常见场景（共享目录、可执行脚本、临时目录、安全加固）解释“该怎么给、给到什么程度”，让你能把权限问题一次性定位并修正确。</p><span id="more"></span><h1 id="一linux-文件权限概述">一、Linux 文件权限概述</h1><h2 id="文件属主与属组">文件属主与属组</h2><ul><li><strong>属主（Owner,u）</strong>：创建或被指定为文件/目录拥有者的用户。</li><li><strong>属组（Group,g）</strong>：多个用户可以同属一个组，在组内具有共享/协同权限。</li><li><strong>其他用户（Others,o）</strong>：不属于该文件属主或属组的所有人。</li></ul><h2 id="基础权限位">基础权限位</h2><ul><li><code>r</code>（读）：对文件可读取内容；对目录可列出文件名。</li><li><code>w</code>（写）：对文件可修改内容；对目录可创建、删除、重命名文件。</li><li><code>x</code>（执行）：对文件可执行程序；对目录可 <code>cd</code>进入、访问子文件。</li></ul><p>示例权限串：<code>rwxr-xr-x</code> 表示： - 属主拥有<code>rwx</code>（4+2+1=7）<br>- 属组拥有 <code>r-x</code>（4+0+1=5）<br>- 其他拥有 <code>r-x</code>（4+0+1=5）</p><hr><h1 id="二常规权限命令">二、常规权限命令</h1><h2 id="chmod-与数字符号表示法">1.<code>chmod</code>与数字/符号表示法</h2><h3 id="数字表示">数字表示</h3><table><thead><tr><th style="text-align: left;">权限位</th><th style="text-align: center;">数字</th></tr></thead><tbody><tr><td style="text-align: left;">r (读)</td><td style="text-align: center;">4</td></tr><tr><td style="text-align: left;">w (写)</td><td style="text-align: center;">2</td></tr><tr><td style="text-align: left;">x (执行)</td><td style="text-align: center;">1</td></tr></tbody></table><p>三种权限相加构成属主、属组、其他三组数，如 <code>754</code> 表示<code>rwx</code> / <code>r-x</code> / <code>r--</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 754 file.sh</span><br></pre></td></tr></table></figure><p>代表让文件对于属主可读写执行，对于属组和其他仅读和执行。</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-37.png" alt="Demystifying SUID and SGID bits"><figcaption aria-hidden="true">Demystifying SUID and SGIDbits</figcaption></figure><h3 id="符号表示">符号表示</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+w file.txt</span><br><span class="line"><span class="built_in">chmod</span> g-x somefile</span><br><span class="line"><span class="built_in">chmod</span> a+r notes.md</span><br></pre></td></tr></table></figure><ul><li><code>u/g/o/a</code>：针对属主/属组/其他/所有。</li><li><code>+ - =</code>：添加、去除、直接赋值权限。</li></ul><h2 id="chown-与所有权变更">2.<code>chown</code> 与所有权变更</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chown</span> newowner file</span><br><span class="line"><span class="built_in">chown</span> newowner.newgroup file</span><br><span class="line"><span class="built_in">chown</span> .newgroup file</span><br></pre></td></tr></table></figure><ul><li>只有 <code>root</code> 或具有特权的用户可执行。</li><li><code>chown</code> 能一次改属主和属组（用 “.” 或 “:”分割），也可只改属组。</li></ul><h2 id="目录权限与区别">3.目录权限与区别</h2><p>对<strong>目录</strong>而言： - <code>r</code>：可用 <code>ls</code>查看目录内容。 - <code>w</code>：可在目录内新增/删除/改名文件。 -<code>x</code>：可 <code>cd</code> 进去或访问该目录里的内容。</p><h2 id="umask">4. <code>umask</code></h2><p><code>umask</code> 是 Linux 和 Unix系统中的一个命令，用于设置文件或目录的默认权限屏蔽值（<strong>User FileCreation Mask</strong>）。它决定了新创建的文件或目录的默认权限。</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/Users_Groups-Umask_Example.png" alt="Umask"><figcaption aria-hidden="true">Umask</figcaption></figure><p><strong>如何计算权限</strong>？</p><ol type="1"><li><strong>默认权限</strong>：<ol type="1"><li>文件默认权限：666（rw-rw-rw-，不包括执行权限）</li><li>目录默认权限：777（rwxrwxrwx，读、写、执行权限）</li></ol></li><li><strong>实际权限</strong>：<ol type="1"><li>实际权限 = 默认权限 - umask 值</li></ol></li></ol><p>例如：umask 为 022，文件默认权限为 666，实际权限为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">666 - 022 = 644 （rw-r--r--）</span><br></pre></td></tr></table></figure><p>同样，目录默认权限为 777，实际权限为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">777 - 022 = 755 （rwxr-xr-x）</span><br></pre></td></tr></table></figure><p><strong>如何查看和设置 umask</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span></span><br></pre></td></tr></table></figure><p><strong>设置新的</strong> umask <strong>值</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027</span><br></pre></td></tr></table></figure><p>这里设置屏蔽值为 027，新创建的文件将具有权限 640，目录权限为750。</p><p><strong>永久设置</strong> umask</p><p>编辑 Shell 配置文件（如 ~/.bashrc 或 ~/.zshrc），添加以下内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027</span><br></pre></td></tr></table></figure><p><strong>常见 umask 值</strong></p><ul><li>022：文件权限 644，目录权限755（常用，保护文件不被其他用户修改）。</li><li>027：文件权限 640，目录权限750（更严格，仅允许同组用户访问，常用于<strong>生产环境</strong>）。</li><li>002：文件权限 664，目录权限775（适合共享环境，允许同组用户修改，常用于<strong>开发环境</strong>）。</li></ul><h2 id="修改文件特殊属性-chattr">5. 修改文件特殊属性<code>chattr</code></h2><p>chattr 是 Linux系统中的一个命令，用于更改文件或目录的属性（<strong>changeattributes</strong>）。通过 chattr设置的属性可以控制文件的某些行为，比如防止文件被删除或修改。可以通过<code>lsattr</code> 查看到对应属性。</p><p><strong>常见用途</strong></p><ol type="1"><li><strong>保护文件不被修改或删除</strong>。</li><li><strong>加速日志文件的追加写入</strong>。</li><li><strong>防止文件被意外覆盖或重命名</strong>。</li></ol><p><strong>语法</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr [选项] [+/-/=][属性] 文件或目录</span><br></pre></td></tr></table></figure><p><strong>常用属性</strong></p><table><thead><tr><th style="text-align: left;"><strong>属性</strong><strong>作用</strong></th><th></th></tr></thead><tbody><tr><td style="text-align: left;">a 仅允许追加写入（append-only）。</td><td></td></tr><tr><td style="text-align: left;">i 不允许修改或删除（immutable）。</td><td></td></tr><tr><td style="text-align: left;">d 在使用 dump备份时，忽略该文件或目录。</td><td></td></tr><tr><td style="text-align: left;">e文件使用扩展格式存储（extents），默认值。</td><td></td></tr><tr><td style="text-align: left;">s 文件被删除时，用 0填充文件数据（安全删除）。</td><td></td></tr><tr><td style="text-align: left;">u文件被删除时，内容会被保存，可以稍后恢复（undelete）。</td><td></td></tr></tbody></table><p><strong>示例</strong></p><ol type="1"><li><p><strong>防止文件被删除或修改</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +i example.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止 /etc/fstab 或 /etc/passwd 等重要系统文件被误修改：</span></span><br><span class="line">sudo chattr +i /etc/fstab</span><br></pre></td></tr></table></figure></li><li><p><strong>日志文件只允许追加写入</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +a logfile.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 防止日志文件被覆盖或意外清空：</span></span><br><span class="line">sudo chattr +a /var/log/syslog</span><br></pre></td></tr></table></figure></li><li><p><strong>备份时忽略某个目录</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +d myfolder</span><br></pre></td></tr></table></figure></li></ol><p><strong>注意事项</strong></p><ol type="1"><li><strong>权限要求</strong>：需要超级用户权限（sudo）才能更改大多数文件的属性。</li><li><strong>支持的文件系统</strong>：chattr 主要适用于 ext2/ext3/ext4文件系统，其他文件系统可能不支持某些属性。</li><li><strong>谨慎使用</strong>：设置 +i属性后，无法删除或修改文件，只有超级用户能解除限制。</li></ol><h2 id="lsattr-查看特殊权限">6. <code>lsattr</code> 查看特殊权限</h2><table><thead><tr><th><strong>选项</strong> <strong>作用</strong></th><th></th></tr></thead><tbody><tr><td>-a 显示包括隐藏文件（以 . 开头的文件）的所有文件属性。</td><td></td></tr><tr><td>-d 显示目录本身的属性，而不是目录中的内容。</td><td></td></tr><tr><td>-R 递归显示目录及其子目录中的文件属性。</td><td></td></tr><tr><td>-v 显示文件的版本号（很少用）。</td><td></td></tr></tbody></table><p><code>lsattr</code> 输出中，每个文件或目录的属性由 10个字符表示，常见的格式如下：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-20250127005208300.png" alt="image-20250127005208300"><figcaption aria-hidden="true">image-20250127005208300</figcaption></figure><h1 id="三进阶特殊权限suid-sgid-sticky-位">三、进阶：特殊权限（SUID /SGID / Sticky 位）</h1><p>特殊权限可赋予可执行文件或目录，使它们具有超出常规 rwx的特殊行为。本节重点分析 <strong>SUID、SGID、Sticky</strong> 三种。</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/FcTez6NWQAYxkr7.jpeg" alt="Linux File Permissions are not only about R+W+X, it&#39;s also about SUID, SGID, and sticky bit"><figcaption aria-hidden="true">Linux File Permissions are not only aboutR+W+X, it's also about SUID, SGID, and sticky bit</figcaption></figure><h2 id="suidset-user-id">1.SUID（Set User ID）</h2><h3 id="原理">1.1 原理</h3><p>当一个可执行文件被赋予 SUID权限后，普通用户执行该文件时，会以<strong>该文件的属主身份</strong>运行程序，而不仅仅是调用者自身的身份。常见示例是<code>/usr/bin/passwd</code>，它的属主为 <code>root</code>，且 SUID生效，让任何用户都能安全地更改自己密码（进而写入<code>/etc/shadow</code>）。</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-20250126231517290.png" alt="image-20250126231517290"><figcaption aria-hidden="true">image-20250126231517290</figcaption></figure><p><strong>Why</strong>：SUID让特定程序能突破调用者权限执行关键操作，但仅限程序内部实现，非给用户全局root 权限。</p><h3 id="查看与设置">1.2 查看与设置</h3><p><code>ls -l</code> 中，如果可执行文件设置了SUID，则属主的执行权限位会显示 <code>s</code> 而非<code>x</code>。例如：<code>-rwsr-xr-x</code>。</p><ul><li><p><strong>设置 SUID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+s myprog</span><br></pre></td></tr></table></figure></li><li><p><strong>去除 SUID</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u-s myprog</span><br></pre></td></tr></table></figure></li><li><p><strong>数字方式</strong>：在原有权限基础上加 <code>4</code>至属主位，比如 <code>chmod 4755 file</code> 表示<code>rwsr-xr-x</code>。</p></li></ul><h3 id="测试示例">1.3 测试示例</h3><p>先编写一个简易 C 程序 <code>myprog.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Real UID=%d, Effective UID=%d\n&quot;</span>, getuid(), geteuid());</span><br><span class="line">  system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li><p>编译生成 myprog：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o myprog myprog.c</span><br></pre></td></tr></table></figure></li><li><p>将属主设为 root 且加 SUID：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> root myprog</span><br><span class="line">sudo <span class="built_in">chmod</span> 4755 myprog</span><br></pre></td></tr></table></figure></li><li><p>普通用户执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./myprog</span><br></pre></td></tr></table></figure></li></ol><p>打印出 <code>Real UID</code> 为当前普通用户，但<code>Effective UID</code> 显示 <code>0</code>（root），从而以 root权限执行 <code>system("id")</code>。</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-20250126231949945.png" alt="image-20250126231949945"><figcaption aria-hidden="true">image-20250126231949945</figcaption></figure><h3 id="安全注意事项">1.4 安全注意事项</h3><ul><li>SUID 程序一旦出现漏洞，可能被恶意利用获取更高权限。</li><li>避免对不可信或不必要的程序设置 SUID。</li><li>检查并最小化系统 SUID程序列表（<code>find / -perm -4000</code>）以降低安全风险。</li></ul><h2 id="sgidset-group-id">2.SGID（Set Group ID）</h2><h3 id="sgid-应用场景">2.1 SGID 应用场景</h3><ol type="1"><li><strong>可执行文件</strong>：进程运行时，其有效组 ID替换为文件的属组。常见于一些特殊组可访问的工具。<br></li><li><strong>目录</strong>：更常用场景：当目录设置SGID，则在此目录中新建的文件或子目录会继承该目录的组，而非创建者的默认组，从而便于同一项目组成员共享文件，类似于共享文件夹的概念。下面创建的文件夹也会有对应的<code>s</code> 权限，实现了递归的效果。</li></ol><h3 id="设置-sgid">2.2 设置 SGID</h3><ul><li>查看：若 sgid 在文件/目录属组执行位，则显示 <code>s</code>，如<code>rwxr-sr-x</code>。</li><li>设置： <code>chmod g+s shared_dir</code> 或数字方式加<code>2</code>，如 <code>chmod 2775 shared_dir</code>。</li></ul><h3 id="案例共享项目组目录">2.3 案例：共享项目组目录</h3><p>假如有 <code>/home/project/</code>目录，需要多个组员共同读写且希望新建文件继承组 <code>dev</code>：</p><ol type="1"><li><p>建目录并属组设为 <code>dev</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /home/project</span><br><span class="line"><span class="built_in">chown</span> :dev /home/project</span><br></pre></td></tr></table></figure></li><li><p>设 SGID：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> g+s /home/project</span><br></pre></td></tr></table></figure></li></ol><p>令各用户都在 <code>dev</code> 组内，这样任何人创建的文件都默认属组为<code>dev</code>，便于组内共享。</p><h2 id="sticky-位粘滞位">3.Sticky 位（粘滞位）</h2><h3 id="作用与机理">3.1 作用与机理</h3><p>Sticky 位最常见于多用户可写的公共目录，如<code>/tmp</code>。当目录设置 Sticky 位后，该目录中文件只能被其属主或root删除或改名，即使其他人对该目录也有写权限，因此作用简单来说就是避免恶意用户删除他人的文件。</p><h3 id="设置方法">3.2 设置方法</h3><ul><li><code>chmod o+t dirname</code></li><li>数字方式加 <code>1</code>：如 <code>chmod 1777 /tmp</code> 表示<code>rwxrwxrwt</code>。</li></ul><h3 id="tmp-目录示例">3.3 <code>/tmp</code> 目录示例</h3><p><code>ls -ld /tmp</code> 常见显示： <code>drwxrwxrwt</code><br>- 说明 <code>/tmp</code> 对所有用户开放读写，但最后一个 <code>t</code>使得只有文件属主能删除自己的文件。</p><hr><h1 id="四应用与案例整合">四、应用与案例整合</h1><h2 id="合并特殊权限数字">1.合并特殊权限数字</h2><p>若一个脚本需要 SUID + rwx (755) 则：<br>- SUID = 4<br>- rwx for owner, r-x for group/others = 755<br>- 合并 → 4755</p><p>同理，如果某目录要 SGID + rwxrwsr-x = 2775:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 2775 some_dir</span><br></pre></td></tr></table></figure><h2 id="检查系统中的-suid-程序">2.检查系统中的 SUID 程序</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 2&gt;/dev/null</span><br></pre></td></tr></table></figure><ul><li>定期审计可避免被不必要的 SUID 程序带来安全隐患。</li></ul><h2 id="安全小结">3.安全小结</h2><ul><li>SUID：常见于 <code>passwd</code>, <code>sudo</code>,<code>mount</code>, <code>umount</code> 等关键程序，需谨慎管理。<br></li><li>SGID：适用于共享目录。<br></li><li>Sticky：防止公共写目录里文件被他人删除。</li></ul><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;文件权限是 Linux
运维里最“基础但最容易踩坑”的部分：一边是权限不足导致服务起不来、脚本跑不动；另一边是权限给大了带来安全风险。要把它用对，你需要的不只是记住
&lt;code&gt;chmod 755&lt;/code&gt;，而是理解&lt;strong&gt;权限位在文件与目录上的差异&lt;/strong&gt;、属主/属组/其他人的边界、以及
&lt;code&gt;umask&lt;/code&gt;、SUID/SGID、Sticky Bit
这些机制为什么会存在。本篇会从最小概念集出发，系统讲清
&lt;code&gt;rwx&lt;/code&gt;、数字/符号写法、&lt;code&gt;chmod/chown&lt;/code&gt;
的典型用法与排错思路，并用常见场景（共享目录、可执行脚本、临时目录、安全加固）解释“该怎么给、给到什么程度”，让你能把权限问题一次性定位并修正确。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux File Permissions (chmod, chown, umask, SUID/SGID/Sticky)</title>
    <link href="https://chenk.top/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/"/>
    <id>https://chenk.top/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/</id>
    <published>2025-02-13T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.325Z</updated>
    
    <content type="html"><![CDATA[<p>Linux permissions are simple on the surface but easy to misuse inpractice: ownership, groups, and “others” determine who can read, write,or execute a file (and directory semantics are often the first trap).This post builds the mental model from the ground up—how to readpermission bits, how <code>chmod</code>/<code>chown</code> changeaccess, and how to apply them safely in real workflows. The goal is thatyou can both fix common permission errors quickly and design reasonableaccess rules instead of trial-and-error.</p><span id="more"></span><h1 id="linux-permission-model">1. Linux permission model</h1><h2 id="ownership-and-groups">Ownership and groups</h2><ul><li><strong>Owner (<code>u</code>)</strong>: the user who owns thefile/directory.<br></li><li><strong>Group (<code>g</code>)</strong>: users can share access viaa common group.<br></li><li><strong>Others (<code>o</code>)</strong>: everyone else who isneither the owner nor in the group.</li></ul><h2 id="permission-bits-rwx">Permission bits (r/w/x)</h2><ul><li><code>r</code> (read): read file contents; for directories, listnames.<br></li><li><code>w</code> (write): modify a file; for directories,create/delete/rename entries.<br></li><li><code>x</code> (execute): execute a file; for directories,<code>cd</code> into it and access entries.</li></ul><p>Example permission string: <code>rwxr-xr-x</code> means: - owner has<code>rwx</code> (4+2+1=7)<br>- group has <code>r-x</code> (4+0+1=5)<br>- others have <code>r-x</code> (4+0+1=5)</p><hr><h1 id="common-permission-commands">2. Common permission commands</h1><h2 id="chmod-octal-and-symbolic">1. <code>chmod</code> (octal andsymbolic)</h2><h3 id="octal-notation">Octal notation</h3><table><thead><tr><th style="text-align: left;">bit</th><th style="text-align: center;">value</th></tr></thead><tbody><tr><td style="text-align: left;">r (read)</td><td style="text-align: center;">4</td></tr><tr><td style="text-align: left;">w (write)</td><td style="text-align: center;">2</td></tr><tr><td style="text-align: left;">x (execute)</td><td style="text-align: center;">1</td></tr></tbody></table><p>Combine the three bits to get an octal digit for each ofowner/group/others. For example, <code>754</code> means <code>rwx</code>/ <code>r-x</code> / <code>r--</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 754 file.sh</span><br></pre></td></tr></table></figure><p>This makes the file readable/writable/executable for the owner,readable/executable for the group, and readable only for others.</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-37.png" alt="Demystifying SUID and SGID bits"><figcaption aria-hidden="true">Demystifying SUID and SGIDbits</figcaption></figure><h3 id="symbolic-notation">Symbolic notation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+w file.txt</span><br><span class="line"><span class="built_in">chmod</span> g-x somefile</span><br><span class="line"><span class="built_in">chmod</span> a+r notes.md</span><br></pre></td></tr></table></figure><ul><li><code>u/g/o/a</code>: owner / group / others / all.<br></li><li><code>+ - =</code>: add / remove / set exactly.</li></ul><h2 id="chown-change-ownership">2. <code>chown</code> (changeownership)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chown</span> newowner file</span><br><span class="line"><span class="built_in">chown</span> newowner.newgroup file</span><br><span class="line"><span class="built_in">chown</span> .newgroup file</span><br></pre></td></tr></table></figure><ul><li>Only <code>root</code> (or a privileged user) can run<code>chown</code> in most cases.<br></li><li><code>chown</code> can change owner and group in one command (using<code>.</code> or <code>:</code>), or change only the group.</li></ul><h2 id="directory-permissions-are-different">3. Directory permissionsare different</h2><p>For <strong>directories</strong>: - <code>r</code>: list names(subject to execute permission).<br>- <code>w</code>: create/delete/rename entries (subject to executepermission).<br>- <code>x</code>: enter the directory (<code>cd</code>) and accessentries.</p><h2 id="umask-default-permission-mask">4. <code>umask</code> (defaultpermission mask)</h2><p><code>umask</code> (User File Creation Mask) controls the defaultpermissions for newly created files and directories by masking outbits.</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/Users_Groups-Umask_Example.png" alt="Umask"><figcaption aria-hidden="true">Umask</figcaption></figure><p><strong>How to compute it</strong></p><ol type="1"><li><strong>Base defaults</strong>:<ol type="1"><li>files: 666 (<code>rw-rw-rw-</code>, no execute bit by default)<br></li><li>directories: 777 (<code>rwxrwxrwx</code>)</li></ol></li><li><strong>Effective permissions</strong>:<ul><li>effective = base default minus the umask bits</li></ul></li></ol><p>Example: if <code>umask</code> is 022, then new files (base 666)become:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">666 - 022 = 644 （rw-r--r--）</span><br></pre></td></tr></table></figure><p>For directories (base 777), you get:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">777 - 022 = 755 （rwxr-xr-x）</span><br></pre></td></tr></table></figure><p><strong>View and set</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span></span><br></pre></td></tr></table></figure><p><strong>Set a new umask</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027</span><br></pre></td></tr></table></figure><p>With <code>umask 027</code>, new files become 640 and new directoriesbecome 750.</p><p><strong>Make it persistent</strong></p><p>Add it to your shell config (e.g. <code>~/.bashrc</code> or<code>~/.zshrc</code>):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">umask</span> 027</span><br></pre></td></tr></table></figure><p><strong>Common umask values</strong></p><ul><li>022: files 644, directories 755 (common default; prevents othersfrom writing).<br></li><li>027: files 640, directories 750 (stricter; good for productionservers).<br></li><li>002: files 664, directories 775 (shared group environments; commonin dev teams).</li></ul><h2 id="chattr-change-file-attributes">5. <code>chattr</code> (changefile attributes)</h2><p><code>chattr</code> changes extra file attributes on Linux (mostly onext2/3/4). These attributes can enforce behaviors such as “immutable”(cannot be modified/deleted) or “append-only” (useful for logs). Use<code>lsattr</code> to view current attributes.</p><p><strong>Common use cases</strong></p><ol type="1"><li><strong>Protect critical files from accidentaledits/deletes</strong>.<br></li><li><strong>Force append-only writes for log files</strong>.<br></li><li><strong>Reduce the risk of accidental overwrites</strong> (dependson attribute and workflow).</li></ol><p><strong>Syntax</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chattr [options] [+/-/=][attr] &lt;file-or-dir&gt;</span><br></pre></td></tr></table></figure><p><strong>Common attributes</strong></p><table><thead><tr><th style="text-align: left;">attribute</th><th>meaning</th></tr></thead><tbody><tr><td style="text-align: left;">a</td><td>append-only</td></tr><tr><td style="text-align: left;">i</td><td>immutable (cannot be modified or deleted)</td></tr><tr><td style="text-align: left;">d</td><td>excluded from <code>dump</code> backups</td></tr><tr><td style="text-align: left;">e</td><td>extents format (default on many ext filesystems)</td></tr><tr><td style="text-align: left;">s</td><td>secure deletion (zero-fill on delete; not always supported)</td></tr><tr><td style="text-align: left;">u</td><td>undelete information kept (not always supported)</td></tr></tbody></table><p><strong>Examples</strong></p><ol type="1"><li><p><strong>Prevent a file from being modified ordeleted</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +i example.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Protect important system files from accidental edits:</span></span><br><span class="line">sudo chattr +i /etc/fstab</span><br></pre></td></tr></table></figure></li><li><p><strong>Make a log file append-only</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +a logfile.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Prevent logs from being overwritten or truncated:</span></span><br><span class="line">sudo chattr +a /var/log/syslog</span><br></pre></td></tr></table></figure></li><li><p><strong>Exclude from <code>dump</code> backups</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chattr +d myfolder</span><br></pre></td></tr></table></figure></li></ol><p><strong>Notes</strong></p><ol type="1"><li><strong>Privileges</strong>: you typically need <code>sudo</code> tochange attributes.<br></li><li><strong>Filesystem support</strong>: mainly ext2/ext3/ext4; otherfilesystems may not support these flags.<br></li><li><strong>Be careful</strong>: <code>+i</code> blocks edits anddeletion; make sure you can revert it when needed.</li></ol><h2 id="lsattr-view-attributes">6. <code>lsattr</code> (viewattributes)</h2><table><thead><tr><th>option</th><th>meaning</th></tr></thead><tbody><tr><td>-a</td><td>include hidden files</td></tr><tr><td>-d</td><td>list the directory itself, not its contents</td></tr><tr><td>-R</td><td>recurse into subdirectories</td></tr><tr><td>-v</td><td>show version (rarely used)</td></tr></tbody></table><p>In <code>lsattr</code> output, each file/dir shows a string ofattribute flags (commonly 10 characters), e.g.:</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-20250127005208300.png" alt="image-20250127005208300"><figcaption aria-hidden="true">image-20250127005208300</figcaption></figure><h1 id="advanced-special-bits-suid-sgid-sticky">3. Advanced: specialbits (SUID / SGID / Sticky)</h1><p>Special bits extend the standard <code>rwx</code> model forexecutables and directories. This section covers <strong>SUID</strong>,<strong>SGID</strong>, and the <strong>sticky bit</strong>: what theydo, how to set them, and why they can be risky.</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/FcTez6NWQAYxkr7.jpeg" alt="Linux File Permissions are not only about R+W+X, it&#39;s also about SUID, SGID, and sticky bit"><figcaption aria-hidden="true">Linux File Permissions are not only aboutR+W+X, it's also about SUID, SGID, and sticky bit</figcaption></figure><h2 id="suid-set-user-id">1. SUID (Set User ID)</h2><h3 id="how-it-works">1.1 How it works</h3><p>When an executable has the SUID bit set, running it will give theprocess an <strong>effective UID equal to the file owner</strong>,rather than the caller. A classic example is<code>/usr/bin/passwd</code>: it is owned by <code>root</code>, and SUIDallows normal users to update their own password (which requires writingto <code>/etc/shadow</code>) without granting them full root access.</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-20250126231517290.png" alt="image-20250126231517290"><figcaption aria-hidden="true">image-20250126231517290</figcaption></figure><p><strong>Why this exists</strong>: it allows a tightly scoped programto perform privileged actions safely, without giving the user a rootshell.</p><h3 id="view-and-set">1.2 View and set</h3><p>In <code>ls -l</code>, when SUID is set, the owner execute bit shows<code>s</code> instead of <code>x</code>, e.g.<code>-rwsr-xr-x</code>.</p><ul><li><p><strong>Set SUID</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u+s myprog</span><br></pre></td></tr></table></figure></li><li><p><strong>Remove SUID</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> u-s myprog</span><br></pre></td></tr></table></figure></li><li><p><strong>Octal form</strong>: add <code>4</code> in front of theusual mode, e.g. <code>chmod 4755 file</code> →<code>rwsr-xr-x</code>.</p></li></ul><h3 id="minimal-demo">1.3 Minimal demo</h3><p>Write a simple C program <code>myprog.c</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Real UID=%d, Effective UID=%d\n&quot;</span>, getuid(), geteuid());</span><br><span class="line">  system(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol type="1"><li><p>Compile:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -o myprog myprog.c</span><br></pre></td></tr></table></figure></li><li><p>Make it owned by root and set SUID:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> root myprog</span><br><span class="line">sudo <span class="built_in">chmod</span> 4755 myprog</span><br></pre></td></tr></table></figure></li><li><p>Run as a normal user:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./myprog</span><br></pre></td></tr></table></figure></li></ol><p>You’ll see <code>Real UID</code> as the normal user, but<code>Effective UID</code> becomes <code>0</code> (root), so<code>system(\"id\")</code> runs with root privileges.</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%9D%83%E9%99%90/image-20250126231949945.png" alt="image-20250126231949945"><figcaption aria-hidden="true">image-20250126231949945</figcaption></figure><h3 id="security-notes">1.4 Security notes</h3><ul><li>A vulnerable SUID program can be exploited for privilegeescalation.<br></li><li>Avoid setting SUID on untrusted or unnecessary binaries.<br></li><li>Audit and minimize SUID binaries regularly (e.g.<code>find / -perm -4000</code>) to reduce risk.</li></ul><h2 id="sgid-set-group-id">2. SGID (Set Group ID)</h2><h3 id="when-to-use-sgid">2.1 When to use SGID</h3><ol type="1"><li><strong>Executables</strong>: the process runs with an effective GIDequal to the file’s group.<br></li><li><strong>Directories (more common)</strong>: new files/subdirectoriesinherit the directory’s group (instead of the creator’s default group),which is ideal for shared project directories.</li></ol><h3 id="view-and-set-1">2.2 View and set</h3><ul><li>In <code>ls -l</code>, SGID shows as <code>s</code> on the groupexecute bit (e.g. <code>rwxr-sr-x</code>).<br></li><li>Set it with <code>chmod g+s shared_dir</code>, or via octal<code>chmod 2775 shared_dir</code>.</li></ul><h3 id="example-shared-project-directory">2.3 Example: shared projectdirectory</h3><p>Suppose <code>/home/project/</code> should be writable by a team, andnew files should inherit group <code>dev</code>:</p><ol type="1"><li><p>Create the directory and set its group to <code>dev</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /home/project</span><br><span class="line"><span class="built_in">chown</span> :dev /home/project</span><br></pre></td></tr></table></figure></li><li><p>Set SGID:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> g+s /home/project</span><br></pre></td></tr></table></figure></li></ol><p>Make sure users are members of <code>dev</code>. Then new filescreated under the directory will default to group <code>dev</code>,which enables clean group-based sharing.</p><h2 id="sticky-bit">3. Sticky bit</h2><h3 id="what-it-does">3.1 What it does</h3><p>The sticky bit is most common on world-writable directories such as<code>/tmp</code>. When set on a directory, files inside can only bedeleted/renamed by the file owner or <code>root</code>, even if otherusers have write access to the directory. This prevents users fromdeleting each other’s files.</p><h3 id="how-to-set-it">3.2 How to set it</h3><ul><li><code>chmod o+t dirname</code></li><li>Or via octal: <code>chmod 1777 /tmp</code> →<code>rwxrwxrwt</code>.</li></ul><h3 id="tmp-example">3.3 <code>/tmp</code> example</h3><p><code>ls -ld /tmp</code> commonly shows<code>drwxrwxrwt</code>.<br>- Everyone can write to <code>/tmp</code>, but the trailing<code>t</code> means only the file owner can delete their own files.</p><hr><h1 id="putting-it-together">4. Putting it together</h1><h2 id="combining-special-bits-in-octal">1. Combining special bits inoctal</h2><p>If an executable needs SUID + 755, then: - SUID = 4<br>- base mode = 755<br>- combined = 4755</p><p>Similarly, a directory with SGID + <code>rwxrwsr-x</code> is2775:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> 2775 some_dir</span><br></pre></td></tr></table></figure><h2 id="audit-suid-binaries">2. Audit SUID binaries</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -4000 2&gt;/dev/null</span><br></pre></td></tr></table></figure><ul><li>Regular audits reduce the attack surface by identifying unnecessarySUID programs.</li></ul><h2 id="security-summary">3. Security summary</h2><ul><li><strong>SUID</strong>: common on critical programs like<code>passwd</code>, <code>sudo</code>, <code>mount</code>,<code>umount</code>; manage carefully.<br></li><li><strong>SGID</strong>: great for shared directories.<br></li><li><strong>Sticky</strong>: prevents file deletion by others inworld-writable directories.</li></ul><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linux permissions are simple on the surface but easy to misuse in
practice: ownership, groups, and “others” determine who can read, write,
or execute a file (and directory semantics are often the first trap).
This post builds the mental model from the ground up—how to read
permission bits, how &lt;code&gt;chmod&lt;/code&gt;/&lt;code&gt;chown&lt;/code&gt; change
access, and how to apply them safely in real workflows. The goal is that
you can both fix common permission errors quickly and design reasonable
access rules instead of trial-and-error.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux 用户管理</title>
    <link href="https://chenk.top/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-09T16:00:00.000Z</published>
    <updated>2026-01-28T01:01:08.142Z</updated>
    
    <content type="html"><![CDATA[<p>在 Linux 多用户、多任务环境中，用户与组的管理非常关键。本篇解析了Linux用户管理的概念、命令与配置文件，让你轻松应对添加、删除、修改用户及组相关操作。</p><span id="more"></span><h1 id="一linux-用户管理概述">一、Linux 用户管理概述</h1><h2 id="用户与组的基本概念">1.用户与组的基本概念</h2><p>Linux系统采用多用户、多任务的设计，每个用户拥有独立的权限与资源配额。用户之间通过分组（Group）来定义共享或隔离的权限：</p><ul><li><code>用户（User）</code>: 指在系统中拥有各自身份信息的账号。<br></li><li><code>组（Group）</code>:多个用户可隶属于同一个组，组定义了某些资源或操作的共享范围。</li></ul><p>典型场景： - 不同用户共同参与同一项目，需要使用同组权限共享文件。</p><ul><li><p>系统管理员（root）是特权用户，几乎拥有对系统的一切控制权。</p></li><li><p>系统会默认生成一些假用户，例如Nginx，是安装软件时自动创建的用户，仅用于完成其份内的工作：</p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250117150536808.png" alt="image-20250117150536808"><figcaption aria-hidden="true">image-20250117150536808</figcaption></figure></li></ul><h2 id="常见配置文件">2.常见配置文件</h2><p>Linux 的用户信息主要分布在如下几个文件：</p><ol type="1"><li><code>/etc/passwd</code><ul><li>记录系统中所有用户的基本信息，如用户名、UID（用户 ID）、GID（用户组ID）等。<br></li><li>每一行代表一个用户，字段间用冒号 <code>:</code> 分割。</li></ul></li><li><code>/etc/shadow</code><ul><li>储存用户的<strong>加密密码</strong>以及密码过期策略等更敏感的信息。<br></li><li>只有 root 用户或具备特权的用户才可读取。</li></ul></li><li><code>/etc/group</code><ul><li>定义系统中的各个组及其成员列表。</li></ul></li><li><code>/etc/gshadow</code><ul><li>类似 <code>/etc/shadow</code>，存放组密码及更详细的组管理信息。</li></ul></li></ol><h1 id="二常用用户管理命令">二、常用用户管理命令</h1><h2 id="useraddpasswduserdel-等">1.<code>useradd</code>、<code>passwd</code>、<code>userdel</code>等</h2><h3 id="useradd"><code>useradd</code></h3><p>用于在系统中创建新用户账号。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd `testuser`</span><br></pre></td></tr></table></figure><p>可选常见参数：</p><ul><li><code>-d</code> 指定用户家目录，例如<code>-d /home/testuser</code>。<br></li><li><code>-m</code> 自动创建家目录。<br></li><li><code>-M</code> 不创建用户的家目录。</li><li><code>-s</code> 指定用户登录 shell，如<code>-s /bin/bash</code>，设置 <code>/sbin/nologin</code>说明用户是无法登录的。</li><li><code>-g</code> 设置用户所属初始组，<code>-G</code>设置附加组（需要有这个组才行）。</li><li><code>-c</code> 设置注释。</li><li><code>-u</code> 设置 uid（1000 开始）。</li></ul><h3 id="passwd"><code>passwd</code></h3><p>为用户设置或修改密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd `testuser`</span><br></pre></td></tr></table></figure><p>若当前用户有权限或是 root，则可以随时更改指定用户的密码。</p><h3 id="userdel"><code>userdel</code></h3><p>用于删除用户账号，常用方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userdel `testuser`</span><br></pre></td></tr></table></figure><p>若要同时移除其家目录，可以加 <code>-r</code> 选项：<br><code>userdel -r testuser</code></p><p>但一般建议直接注释掉 <code>/etc/passwd</code>对应的行，而不是直接删除。</p><h2 id="usermod">2.<code>usermod</code></h2><p><code>usermod</code>修改已存在且未登录的用户的属性，如用户名、组、家目录等：</p><ul><li><code>-l</code>：修改登录名<br></li><li><code>-g</code>：修改初始组<br></li><li><code>-G</code>：修改或追加附加组<br></li><li><code>-d</code>：更换家目录，如同时使用 <code>-m</code>可将原家目录内容迁移到新位置<br></li><li><code>-s</code>：更改用户登录 shell<br></li><li><code>-L</code> / <code>-U</code>：锁定/解锁用户密码</li></ul><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -G `developers` -d `/home/newuser` `olduser`</span><br></pre></td></tr></table></figure><p>这条命令将 <code>olduser</code> 的家目录改为<code>/home/newuser</code> 并把他加入 <code>developers</code> 组。</p><h2 id="其他查看命令">3. 其他查看命令</h2><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250124120244574.png" alt="image-20250124120244574"><figcaption aria-hidden="true">image-20250124120244574</figcaption></figure><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250124120452049.png" alt="image-20250124120452049"><figcaption aria-hidden="true">image-20250124120452049</figcaption></figure><h1 id="三组管理命令">三、组管理命令</h1><h2 id="groupaddgroupdelgroupmod">1.<code>groupadd</code>、<code>groupdel</code>、<code>groupmod</code></h2><ul><li><p><code>groupadd</code> 新建组：<code>groupadd testgroup</code></p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123175003859.png" alt="image-20250123175003859"><figcaption aria-hidden="true">image-20250123175003859</figcaption></figure><p>可以指定组号：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd -g 组号 组名</span><br></pre></td></tr></table></figure></li><li><p><code>groupdel</code>删除组：<code>groupdel testgroup</code></p></li><li><p><code>groupmod</code> 修改组名或GID：<code>groupmod -n newgroupname oldgroupname</code></p></li></ul><h2 id="用户与组的关联操作">2. 用户与组的关联操作</h2><ul><li><p>将用户添加到附加组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -aG `groupname` `username`</span><br></pre></td></tr></table></figure><p>其中 -a 表示追加，避免覆盖用户原有附加组。</p></li><li><p>移除用户与某组的关联：需先编辑 <code>/etc/group</code>或使用一些辅助脚本（如 <code>gpasswd</code>或手动修改组条目）。</p></li></ul><h1 id="四uidgid-与权限关系">四、UID、GID 与权限关系</h1><h2 id="uid用户id">1.UID（用户ID）</h2><ul><li>每个用户在 <code>/etc/passwd</code> 中有唯一的 UID，root 用户 UID通常为 0。<br></li><li>一些系统服务或伪用户 UID 可能小于 1000（或 500），普通用户 UID大多从 1000（或 500）开始。</li></ul><h2 id="gid组id">2.GID（组ID）</h2><ul><li>记录在 <code>/etc/group</code> 中，每个组有唯一的 GID。<br></li><li>/etc/passwd 中的 GID 字段指示该用户的初始组，附加组则在 /etc/group里列出。</li></ul><h2 id="权限模型">3.权限模型</h2><p>Linux 文件权限基于 <strong>User/Group/Other</strong>三个主体，分别有读（r）、写（w）、执行（x）三种权限位： - 若当前访问者的UID 与文件所有者相同，系统使用<strong>所有者权限</strong>。<br>- 否则若访问者所在组与文件组相同，则使用<strong>组权限</strong>。<br>- 否则使用<strong>其他权限</strong>。</p><h1 id="五账号安全及sudo权限">五、账号安全及sudo权限</h1><h2 id="密码安全">1.密码安全</h2><ul><li>修改密码策略（如密码有效期、复杂度）主要在 <code>/etc/shadow</code>里配置或借助 <code>chage</code> 命令。<br></li><li>建议使用 <code>passwd -n</code>、<code>-x</code>等选项强制密码最短/最长使用天数，或通过 <code>chage</code>进行交互配置。</li></ul><h2 id="锁定与解锁用户">2.锁定与解锁用户</h2><ul><li><code>usermod -L username</code> 可锁定用户，<code>-U</code>可解锁。<br></li><li>被锁定后，该用户密码无效，无法登录系统。</li></ul><h2 id="sudoers">3.sudoers</h2><ul><li><p><code>sudo</code> 允许普通用户在不知 root密码的情况下以特权运行命令。</p></li><li><p>sudo 配置文件位于 <code>/etc/sudoers</code>，或在<code>/etc/sudoers.d/</code> 下。</p></li><li><p>可通过 <code>visudo</code> 进行编辑，典型格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure><p>表示该用户可在所有主机、以所有用户和组身份，执行所有命令。</p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250124121720257.png" alt="image-20250124121720257"><figcaption aria-hidden="true">image-20250124121720257</figcaption></figure></li><li><p>也可以通过这行代码添加<code>sudoer</code>：<code>usermod -aG wheel 用户名</code></p></li></ul><h1 id="六系统文件详解">六、系统文件详解</h1><h2 id="etcpasswd-举例">1.<code>/etc/passwd</code> 举例</h2><p><code>/etc/passwd</code> 是存储用户信息文件，一个典型的<code>/etc/passwd</code> 行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testuser:x:1001:1001:用户注释:/home/testuser:/bin/bash</span><br></pre></td></tr></table></figure><ul><li>用户名：<code>testuser</code><br></li><li>密码位：<code>x</code>（表示真正密码在 <code>/etc/shadow</code>中）<br></li><li>UID：1001，如身份证号<ul><li>UID 为 0 是超级用户</li><li>系统用户 UID 为 1-999，Linux安装的服务程序都会创建独有的用户负责运行</li><li>普通用户 UID 从 1000 开始，由管理员创建，最大值 1000-60000 范围</li><li>CentOS6 创建普通用户从 500 开始</li></ul></li><li>GID：1001，group identify，如户口本的家庭编号</li><li>Gecos 信息：留空<br></li><li>家目录：<code>/home/testuser</code><br></li><li>登录 Shell：<code>/bin/bash</code>，这是用户解释器，默认都是bash，若是禁止用户登录机器，改为 <code>/sbin/nologin</code> 即可（ssh连接的时候会报错）</li></ul><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123172223438.png" alt="image-20250123172223438"><figcaption aria-hidden="true">image-20250123172223438</figcaption></figure><h2 id="etcshadow-举例">2.<code>/etc/shadow</code> 举例</h2><p><code>/etc/shadow</code>是存储用户密码信息的文件，该文件默认权限为0，即任何其他用户都不得查看，常见字段如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testuser:$6<span class="variable">$4kTxu1</span>…:19103:0:99999:7:::</span><br></pre></td></tr></table></figure><ul><li><code>$6$</code> 表示使用 SHA-512 加密<br></li><li>19103 表示最后一次修改密码的日期（自 Epoch 起的天数）<br></li><li>0 / 99999 / 7 等表示密码最短/最长使用期限、过期天数等策略</li></ul><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123172315296.png" alt="image-20250123172315296"><figcaption aria-hidden="true">image-20250123172315296</figcaption></figure><h2 id="etcgroup">3. <code>/etc/group</code></h2><p>存储用户组信息</p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123172506138.png" alt="image-20250123172506138"><figcaption aria-hidden="true">image-20250123172506138</figcaption></figure><h2 id="etcgshadow">4. <code>/etc/gshadow</code></h2><p>存储用户组密码信息，在大公司，用户和组数量很大的情况下，需要制定复杂的权限管理，届时会用到组密码</p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123174653405.png" alt="image-20250123174653405"><figcaption aria-hidden="true">image-20250123174653405</figcaption></figure><h2 id="etcskel">5. <code>/etc/skel</code></h2><p><code>skel</code> 是 skeleton的缩写，此目录的作用是在建立新用户时，用于初始化用户根目录，系统会把此目录下的所有文件、目录都复制到新建用户的根目录，并且将用户属主与用户组调整为与此根目录相同</p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123174327446.png" alt="image-20250123174327446"><figcaption aria-hidden="true">image-20250123174327446</figcaption></figure><p>如果之前创建用户的时候没有创建家目录，可以使用<code>cp -r /etc/skel/ /home/用户名</code> 来创建。</p><h2 id="set-和-env-命令">6. <code>set</code> 和 <code>env</code>命令</h2><p>Windows 的用户变量查询相当于 Linux 中的 <code>env</code>命令，而系统变量查询相当于 Linux 中的 <code>set</code> 命令。</p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250126171434330.png" alt="image-20250126171434330"><figcaption aria-hidden="true">image-20250126171434330</figcaption></figure><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250126171605322.png" alt="image-20250126171605322"><figcaption aria-hidden="true">image-20250126171605322</figcaption></figure><p><code>PS1</code> 命令行样式修改（只在当前生效）</p><figure><img src="/Linux-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250126172212498.png" alt="image-20250126172212498"><figcaption aria-hidden="true">image-20250126172212498</figcaption></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">\d ：代表日期，格式为weekday month <span class="built_in">date</span>，例如：<span class="string">&quot;Mon Aug1&quot;</span></span><br><span class="line">\H：完整的主机名称。例如：我的机器名称为：fc4.linux，则这个名称就是fc4.linux</span><br><span class="line">\h ：仅取主机的第一个名字，如上例，则为fc4，.linux则被省略 </span><br><span class="line">\t ：显示时间为24小时格式，如：HH：MM：SS </span><br><span class="line">\T ：显示时间为12小时格式 </span><br><span class="line">\A ：显示时间为24小时格式：HH：MM </span><br><span class="line">\u ：当前用户的账号名称</span><br><span class="line">\v ：BASH的版本信息</span><br><span class="line">\w ：完整的工作目录名称。家目录会以 ~代替</span><br><span class="line">\W ：利用<span class="built_in">basename</span>取得工作目录名称，所以只会列出最后一个目录</span><br><span class="line">\<span class="comment"># ：下达的第几个命令</span></span><br><span class="line">\$ ：提示字符，如果是root时，提示符为：<span class="comment"># ，普通用户则为：$</span></span><br></pre></td></tr></table></figure><blockquote><p>set 设置变量</p><p>unset 取消设置变量</p></blockquote><h1 id="七常用实例场景">七、常用实例场景</h1><h2 id="新建用户并指定家目录shell">1.新建用户并指定家目录、Shell</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd -m -d `/home/jack` -s `/bin/zsh` `jack`</span><br><span class="line">passwd `jack`</span><br></pre></td></tr></table></figure><ul><li><code>-m</code>：自动创建家目录</li><li><code>-d</code>：指定家目录路径</li><li><code>-s</code>：指定默认 <code>shell</code></li></ul><h2 id="为用户指定初始组和附加组">2.为用户指定初始组和附加组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -g `devgroup` -G `testgroup,adm` `alex`</span><br></pre></td></tr></table></figure><p>初始组为 <code>devgroup</code>，附加组有 <code>testgroup</code> 和<code>adm</code>。</p><h2 id="将用户移至新家目录">3.将用户移至新家目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -d `/home/newjack` -m `jack`</span><br></pre></td></tr></table></figure><ul><li><code>d</code>：更新家目录位置</li><li><code>-m</code>：迁移原家目录内容到新位置</li></ul><h2 id="批量删除用户">4.批量删除用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> u <span class="keyword">in</span> `<span class="built_in">cat</span> users.txt`; <span class="keyword">do</span></span><br><span class="line">    userdel -r <span class="variable">$u</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>通过简单脚本循环删除 <code>users.txt</code> 列表中的所有用户，并<code>-r</code> 同时删除家目录。</p><h2 id="用户互传数据">5. 用户互传数据</h2><p>使用 <code>scp 源目录 目标目录</code>可以实现将远程目录传到自己目录或者将自己目录传到远程中，需要注意的是我们需要输入对方密码，如果要发送文件夹需要加<code>-r</code>指令。并且网络需要都改为桥接，需要保证在同一个网段下才能互传，如果之前设置了静态IP 需要设置桥接后重新修改为动态。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;在 Linux 多用户、多任务环境中，用户与组的管理非常关键。本篇解析了
Linux
用户管理的概念、命令与配置文件，让你轻松应对添加、删除、修改用户及组相关操作。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 用户管理</title>
    <link href="https://chenk.top/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-09T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.323Z</updated>
    
    <content type="html"><![CDATA[<p>Linux is a multi-user system by design, so user and group managementis not an “admin-only detail”—it directly affects security, accesscontrol, and day-to-day operations. This post covers the mental model(users, groups, and permission boundaries), the commands you’ll actuallyuse (<code>useradd/usermod/userdel</code>, group management), and thekey configuration files that make changes persistent. After reading, youshould be able to create, modify, and audit accounts and groupsconfidently on a real server.</p><span id="more"></span><h1 id="一linux-用户管理概述">一、Linux 用户管理概述</h1><h2 id="用户与组的基本概念">1.用户与组的基本概念</h2><p>Linux系统采用多用户、多任务的设计，每个用户拥有独立的权限与资源配额。用户之间通过分组（Group）来定义共享或隔离的权限：</p><ul><li><code>用户（User）</code>: 指在系统中拥有各自身份信息的账号。<br></li><li><code>组（Group）</code>:多个用户可隶属于同一个组，组定义了某些资源或操作的共享范围。</li></ul><p>典型场景： - 不同用户共同参与同一项目，需要使用同组权限共享文件。</p><ul><li><p>系统管理员（root）是特权用户，几乎拥有对系统的一切控制权。</p></li><li><p>系统会默认生成一些假用户，例如Nginx，是安装软件时自动创建的用户，仅用于完成其份内的工作：</p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250117150536808.png" alt="image-20250117150536808"><figcaption aria-hidden="true">image-20250117150536808</figcaption></figure></li></ul><h2 id="常见配置文件">2.常见配置文件</h2><p>Linux 的用户信息主要分布在如下几个文件：</p><ol type="1"><li><code>/etc/passwd</code><ul><li>记录系统中所有用户的基本信息，如用户名、UID（用户 ID）、GID（用户组ID）等。<br></li><li>每一行代表一个用户，字段间用冒号 <code>:</code> 分割。</li></ul></li><li><code>/etc/shadow</code><ul><li>储存用户的<strong>加密密码</strong>以及密码过期策略等更敏感的信息。<br></li><li>只有 root 用户或具备特权的用户才可读取。</li></ul></li><li><code>/etc/group</code><ul><li>定义系统中的各个组及其成员列表。</li></ul></li><li><code>/etc/gshadow</code><ul><li>类似 <code>/etc/shadow</code>，存放组密码及更详细的组管理信息。</li></ul></li></ol><h1 id="二常用用户管理命令">二、常用用户管理命令</h1><h2 id="useraddpasswduserdel-等">1.<code>useradd</code>、<code>passwd</code>、<code>userdel</code>等</h2><h3 id="useradd"><code>useradd</code></h3><p>用于在系统中创建新用户账号。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd `testuser`</span><br></pre></td></tr></table></figure><p>可选常见参数：</p><ul><li><code>-d</code> 指定用户家目录，例如<code>-d /home/testuser</code>。<br></li><li><code>-m</code> 自动创建家目录。<br></li><li><code>-M</code> 不创建用户的家目录。</li><li><code>-s</code> 指定用户登录 shell，如<code>-s /bin/bash</code>，设置 <code>/sbin/nologin</code>说明用户是无法登录的。</li><li><code>-g</code> 设置用户所属初始组，<code>-G</code>设置附加组（需要有这个组才行）。</li><li><code>-c</code> 设置注释。</li><li><code>-u</code> 设置 uid（1000 开始）。</li></ul><h3 id="passwd"><code>passwd</code></h3><p>为用户设置或修改密码：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd `testuser`</span><br></pre></td></tr></table></figure><p>若当前用户有权限或是 root，则可以随时更改指定用户的密码。</p><h3 id="userdel"><code>userdel</code></h3><p>用于删除用户账号，常用方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">userdel `testuser`</span><br></pre></td></tr></table></figure><p>若要同时移除其家目录，可以加 <code>-r</code> 选项：<br><code>userdel -r testuser</code></p><p>但一般建议直接注释掉 <code>/etc/passwd</code>对应的行，而不是直接删除。</p><h2 id="usermod">2.<code>usermod</code></h2><p><code>usermod</code>修改已存在且未登录的用户的属性，如用户名、组、家目录等：</p><ul><li><code>-l</code>：修改登录名<br></li><li><code>-g</code>：修改初始组<br></li><li><code>-G</code>：修改或追加附加组<br></li><li><code>-d</code>：更换家目录，如同时使用 <code>-m</code>可将原家目录内容迁移到新位置<br></li><li><code>-s</code>：更改用户登录 shell<br></li><li><code>-L</code> / <code>-U</code>：锁定/解锁用户密码</li></ul><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -G `developers` -d `/home/newuser` `olduser`</span><br></pre></td></tr></table></figure><p>这条命令将 <code>olduser</code> 的家目录改为<code>/home/newuser</code> 并把他加入 <code>developers</code> 组。</p><h2 id="其他查看命令">3. 其他查看命令</h2><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250124120244574.png" alt="image-20250124120244574"><figcaption aria-hidden="true">image-20250124120244574</figcaption></figure><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250124120452049.png" alt="image-20250124120452049"><figcaption aria-hidden="true">image-20250124120452049</figcaption></figure><h1 id="三组管理命令">三、组管理命令</h1><h2 id="groupaddgroupdelgroupmod">1.<code>groupadd</code>、<code>groupdel</code>、<code>groupmod</code></h2><ul><li><p><code>groupadd</code> 新建组：<code>groupadd testgroup</code></p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123175003859.png" alt="image-20250123175003859"><figcaption aria-hidden="true">image-20250123175003859</figcaption></figure><p>可以指定组号：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd -g 组号 组名</span><br></pre></td></tr></table></figure></li><li><p><code>groupdel</code>删除组：<code>groupdel testgroup</code></p></li><li><p><code>groupmod</code> 修改组名或GID：<code>groupmod -n newgroupname oldgroupname</code></p></li></ul><h2 id="用户与组的关联操作">2. 用户与组的关联操作</h2><ul><li><p>将用户添加到附加组：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -aG `groupname` `username`</span><br></pre></td></tr></table></figure><p>其中 -a 表示追加，避免覆盖用户原有附加组。</p></li><li><p>移除用户与某组的关联：需先编辑 <code>/etc/group</code>或使用一些辅助脚本（如 <code>gpasswd</code>或手动修改组条目）。</p></li></ul><h1 id="四uidgid-与权限关系">四、UID、GID 与权限关系</h1><h2 id="uid用户id">1.UID（用户ID）</h2><ul><li>每个用户在 <code>/etc/passwd</code> 中有唯一的 UID，root 用户 UID通常为 0。<br></li><li>一些系统服务或伪用户 UID 可能小于 1000（或 500），普通用户 UID大多从 1000（或 500）开始。</li></ul><h2 id="gid组id">2.GID（组ID）</h2><ul><li>记录在 <code>/etc/group</code> 中，每个组有唯一的 GID。<br></li><li>/etc/passwd 中的 GID 字段指示该用户的初始组，附加组则在 /etc/group里列出。</li></ul><h2 id="权限模型">3.权限模型</h2><p>Linux 文件权限基于 <strong>User/Group/Other</strong>三个主体，分别有读（r）、写（w）、执行（x）三种权限位： - 若当前访问者的UID 与文件所有者相同，系统使用<strong>所有者权限</strong>。<br>- 否则若访问者所在组与文件组相同，则使用<strong>组权限</strong>。<br>- 否则使用<strong>其他权限</strong>。</p><h1 id="五账号安全及sudo权限">五、账号安全及sudo权限</h1><h2 id="密码安全">1.密码安全</h2><ul><li>修改密码策略（如密码有效期、复杂度）主要在 <code>/etc/shadow</code>里配置或借助 <code>chage</code> 命令。<br></li><li>建议使用 <code>passwd -n</code>、<code>-x</code>等选项强制密码最短/最长使用天数，或通过 <code>chage</code>进行交互配置。</li></ul><h2 id="锁定与解锁用户">2.锁定与解锁用户</h2><ul><li><code>usermod -L username</code> 可锁定用户，<code>-U</code>可解锁。<br></li><li>被锁定后，该用户密码无效，无法登录系统。</li></ul><h2 id="sudoers">3.sudoers</h2><ul><li><p><code>sudo</code> 允许普通用户在不知 root密码的情况下以特权运行命令。</p></li><li><p>sudo 配置文件位于 <code>/etc/sudoers</code>，或在<code>/etc/sudoers.d/</code> 下。</p></li><li><p>可通过 <code>visudo</code> 进行编辑，典型格式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username ALL=(ALL:ALL) ALL</span><br></pre></td></tr></table></figure><p>表示该用户可在所有主机、以所有用户和组身份，执行所有命令。</p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250124121720257.png" alt="image-20250124121720257"><figcaption aria-hidden="true">image-20250124121720257</figcaption></figure></li><li><p>也可以通过这行代码添加<code>sudoer</code>：<code>usermod -aG wheel 用户名</code></p></li></ul><h1 id="六系统文件详解">六、系统文件详解</h1><h2 id="etcpasswd-举例">1.<code>/etc/passwd</code> 举例</h2><p><code>/etc/passwd</code> 是存储用户信息文件，一个典型的<code>/etc/passwd</code> 行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testuser:x:1001:1001:用户注释:/home/testuser:/bin/bash</span><br></pre></td></tr></table></figure><ul><li>用户名：<code>testuser</code><br></li><li>密码位：<code>x</code>（表示真正密码在 <code>/etc/shadow</code>中）<br></li><li>UID：1001，如身份证号<ul><li>UID 为 0 是超级用户</li><li>系统用户 UID 为 1-999，Linux安装的服务程序都会创建独有的用户负责运行</li><li>普通用户 UID 从 1000 开始，由管理员创建，最大值 1000-60000 范围</li><li>CentOS6 创建普通用户从 500 开始</li></ul></li><li>GID：1001，group identify，如户口本的家庭编号</li><li>Gecos 信息：留空<br></li><li>家目录：<code>/home/testuser</code><br></li><li>登录 Shell：<code>/bin/bash</code>，这是用户解释器，默认都是bash，若是禁止用户登录机器，改为 <code>/sbin/nologin</code> 即可（ssh连接的时候会报错）</li></ul><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123172223438.png" alt="image-20250123172223438"><figcaption aria-hidden="true">image-20250123172223438</figcaption></figure><h2 id="etcshadow-举例">2.<code>/etc/shadow</code> 举例</h2><p><code>/etc/shadow</code>是存储用户密码信息的文件，该文件默认权限为0，即任何其他用户都不得查看，常见字段如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">testuser:$6<span class="variable">$4kTxu1</span>…:19103:0:99999:7:::</span><br></pre></td></tr></table></figure><ul><li><code>$6$</code> 表示使用 SHA-512 加密<br></li><li>19103 表示最后一次修改密码的日期（自 Epoch 起的天数）<br></li><li>0 / 99999 / 7 等表示密码最短/最长使用期限、过期天数等策略</li></ul><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123172315296.png" alt="image-20250123172315296"><figcaption aria-hidden="true">image-20250123172315296</figcaption></figure><h2 id="etcgroup">3. <code>/etc/group</code></h2><p>存储用户组信息</p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123172506138.png" alt="image-20250123172506138"><figcaption aria-hidden="true">image-20250123172506138</figcaption></figure><h2 id="etcgshadow">4. <code>/etc/gshadow</code></h2><p>存储用户组密码信息，在大公司，用户和组数量很大的情况下，需要制定复杂的权限管理，届时会用到组密码</p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123174653405.png" alt="image-20250123174653405"><figcaption aria-hidden="true">image-20250123174653405</figcaption></figure><h2 id="etcskel">5. <code>/etc/skel</code></h2><p><code>skel</code> 是 skeleton的缩写，此目录的作用是在建立新用户时，用于初始化用户根目录，系统会把此目录下的所有文件、目录都复制到新建用户的根目录，并且将用户属主与用户组调整为与此根目录相同</p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250123174327446.png" alt="image-20250123174327446"><figcaption aria-hidden="true">image-20250123174327446</figcaption></figure><p>如果之前创建用户的时候没有创建家目录，可以使用<code>cp -r /etc/skel/ /home/用户名</code> 来创建。</p><h2 id="set-和-env-命令">6. <code>set</code> 和 <code>env</code>命令</h2><p>Windows 的用户变量查询相当于 Linux 中的 <code>env</code>命令，而系统变量查询相当于 Linux 中的 <code>set</code> 命令。</p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250126171434330.png" alt="image-20250126171434330"><figcaption aria-hidden="true">image-20250126171434330</figcaption></figure><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250126171605322.png" alt="image-20250126171605322"><figcaption aria-hidden="true">image-20250126171605322</figcaption></figure><p><code>PS1</code> 命令行样式修改（只在当前生效）</p><figure><img src="/Linux%20%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86/image-20250126172212498.png" alt="image-20250126172212498"><figcaption aria-hidden="true">image-20250126172212498</figcaption></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">\d ：代表日期，格式为weekday month <span class="built_in">date</span>，例如：<span class="string">&quot;Mon Aug1&quot;</span></span><br><span class="line">\H：完整的主机名称。例如：我的机器名称为：fc4.linux，则这个名称就是fc4.linux</span><br><span class="line">\h ：仅取主机的第一个名字，如上例，则为fc4，.linux则被省略 </span><br><span class="line">\t ：显示时间为24小时格式，如：HH：MM：SS </span><br><span class="line">\T ：显示时间为12小时格式 </span><br><span class="line">\A ：显示时间为24小时格式：HH：MM </span><br><span class="line">\u ：当前用户的账号名称</span><br><span class="line">\v ：BASH的版本信息</span><br><span class="line">\w ：完整的工作目录名称。家目录会以 ~代替</span><br><span class="line">\W ：利用<span class="built_in">basename</span>取得工作目录名称，所以只会列出最后一个目录</span><br><span class="line">\<span class="comment"># ：下达的第几个命令</span></span><br><span class="line">\$ ：提示字符，如果是root时，提示符为：<span class="comment"># ，普通用户则为：$</span></span><br></pre></td></tr></table></figure><blockquote><p>set 设置变量</p><p>unset 取消设置变量</p></blockquote><h1 id="七常用实例场景">七、常用实例场景</h1><h2 id="新建用户并指定家目录shell">1.新建用户并指定家目录、Shell</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">useradd -m -d `/home/jack` -s `/bin/zsh` `jack`</span><br><span class="line">passwd `jack`</span><br></pre></td></tr></table></figure><ul><li><code>-m</code>：自动创建家目录</li><li><code>-d</code>：指定家目录路径</li><li><code>-s</code>：指定默认 <code>shell</code></li></ul><h2 id="为用户指定初始组和附加组">2.为用户指定初始组和附加组</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">useradd -g `devgroup` -G `testgroup,adm` `alex`</span><br></pre></td></tr></table></figure><p>初始组为 <code>devgroup</code>，附加组有 <code>testgroup</code> 和<code>adm</code>。</p><h2 id="将用户移至新家目录">3.将用户移至新家目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">usermod -d `/home/newjack` -m `jack`</span><br></pre></td></tr></table></figure><ul><li><code>d</code>：更新家目录位置</li><li><code>-m</code>：迁移原家目录内容到新位置</li></ul><h2 id="批量删除用户">4.批量删除用户</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> u <span class="keyword">in</span> `<span class="built_in">cat</span> users.txt`; <span class="keyword">do</span></span><br><span class="line">    userdel -r <span class="variable">$u</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>通过简单脚本循环删除 <code>users.txt</code> 列表中的所有用户，并<code>-r</code> 同时删除家目录。</p><h2 id="用户互传数据">5. 用户互传数据</h2><p>使用 <code>scp 源目录 目标目录</code>可以实现将远程目录传到自己目录或者将自己目录传到远程中，需要注意的是我们需要输入对方密码，如果要发送文件夹需要加<code>-r</code>指令。并且网络需要都改为桥接，需要保证在同一个网段下才能互传，如果之前设置了静态IP 需要设置桥接后重新修改为动态。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linux is a multi-user system by design, so user and group management
is not an “admin-only detail”—it directly affects security, access
control, and day-to-day operations. This post covers the mental model
(users, groups, and permission boundaries), the commands you’ll actually
use (&lt;code&gt;useradd/usermod/userdel&lt;/code&gt;, group management), and the
key configuration files that make changes persistent. After reading, you
should be able to create, modify, and audit accounts and groups
confidently on a real server.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 软件包管理</title>
    <link href="https://chenk.top/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-28T01:15:20.313Z</updated>
    
    <content type="html"><![CDATA[<p>软件包管理看起来只是“装/卸/更新”，但真正决定你是否少踩坑的是两件事：第一，包里到底包含了什么（可执行文件、配置、依赖库、服务脚本），以及它们分别落在系统的哪些位置；第二，发行版的工具链差异（Debian/Ubuntu的 <code>dpkg/apt</code> vs CentOS 的<code>rpm/yum/dnf</code>）会如何影响依赖解析、版本选择与回滚策略。本文先把软件包与依赖的基本概念讲清楚，再给出一套可复现的常用操作清单，并补上国内环境最常见的配置（例如替换阿里云源、验证源是否生效）。最后把“装包”延伸到更贴近生产的两条路径：源码编译（以Nginx 为例）与二进制免安装配置（以 Java为例），让你在遇到版本/依赖/网络限制时有可选的落地方案。</p><span id="more"></span><h1 id="一软件包的概念与管理">一、软件包的概念与管理</h1><h2 id="软件包组成">1. 软件包组成</h2><p>软件包是将程序、库文件、配置文件以及文档等打包在一起的文件，方便安装、升级和卸载。软件包能自动处理依赖关系，简化软件管理。一个标准的软件包通常包括以下内容：</p><h3 id="二进制命令可执行文件">二进制命令（可执行文件）</h3><p>经过编译的程序源代码，生成的可执行二进制文件。例如，在 Linux系统中，<code>/usr/bin/</code>目录下的可执行文件通常来自安装的软件包，如<code>vim</code>、<code>gcc</code> 等。</p><h3 id="配置文件configuration-files">配置文件（ConfigurationFiles）</h3><p>存放应用程序的默认配置，通常位于 <code>/etc/</code>目录下。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/nginx.conf  <span class="comment"># Nginx 的配置文件</span></span><br><span class="line">/etc/mysql/my.cnf    <span class="comment"># MySQL 的配置文件</span></span><br></pre></td></tr></table></figure><h3 id="数据文件data-files">数据文件（Data Files）</h3><p>应用程序所需的数据，如数据库文件、默认资源等。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/mysql/   <span class="comment"># MySQL 数据库存放目录</span></span><br><span class="line">/var/www/html/    <span class="comment"># Web 服务器默认站点目录</span></span><br></pre></td></tr></table></figure><h3 id="依赖库shared-libraries">依赖库（Shared Libraries）</h3><p>共享库是可执行文件运行时依赖的动态链接库，通常存放在<code>/usr/lib/</code> 或 <code>/lib/</code> 目录下。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/libssl.so</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6</span><br></pre></td></tr></table></figure><p><strong>（5）文档（Documentation）</strong></p><p>软件的说明文档、手册页、版权声明等，通常存放在<code>/usr/share/doc/</code> 目录。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/doc/nginx/README</span><br><span class="line">/usr/share/man/man1/nginx.1.gz</span><br></pre></td></tr></table></figure><h2 id="linux-软件包">2. Linux 软件包</h2><h3 id="软件包格式对比">软件包格式对比</h3><p>Linux 发行版不同，软件包的格式也有所不同。主要分为以下几类：</p><table><thead><tr><th><strong>发行版</strong></th><th><strong>软件包格式</strong></th><th><strong>包管理工具</strong></th></tr></thead><tbody><tr><td>Debian、Ubuntu</td><td>.deb</td><td>dpkg、apt</td></tr><tr><td>Red Hat、CentOS、Fedora</td><td>.rpm</td><td>rpm、yum、dnf</td></tr><tr><td>Arch Linux</td><td>.tar.xz</td><td>pacman</td></tr><tr><td>Gentoo</td><td>源码包</td><td>portage</td></tr><tr><td>macOS</td><td>.pkg</td><td>brew</td></tr></tbody></table><h3 id="常见操作示例">常见操作示例</h3><p>下面主要介绍 RPM 包的常见操作，RPM（Red Hat Package Manager）用于 RedHat/CentOS 等系统。常见操作包括安装、升级、卸载和查询软件包信息，而 Yum是基于 RPM 包管理的工具。Ubuntu 默认使用 DEB包管理（dpkg/apt），但在某些情况下可能会遇到 RPM 包，使用工具如<code>alien</code> 可将 RPM 包转换为 DEB包进行安装。一些使用示例如下：</p><p><strong>将 RPM 包转换为 DEB 包</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install alien</span><br><span class="line">sudo alien -d package.rpm</span><br><span class="line">sudo dpkg -i package.deb</span><br></pre></td></tr></table></figure><p>RPM 依赖冲突解决：当安装 RPM包遇到依赖问题时，需要手动安装缺少的依赖或使用工具解决依赖冲突。转换为DEB 包后，可借助 apt 的自动依赖解析功能。</p><p><strong>常用 RPM 命令</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh package.rpm    # 安装 RPM 包</span><br><span class="line">rpm -Uvh package.rpm    # 升级 RPM 包</span><br><span class="line">rpm -e packagename      # 卸载软件包</span><br><span class="line">rpm -qa                 # 列出所有已安装 RPM 包</span><br><span class="line">rpm -qi packagename     # 查询某个包的信息</span><br><span class="line">rpm -qf /path/to/file   # 查找某个文件所属的 RPM 包</span><br></pre></td></tr></table></figure><p><strong>光盘获取 RPM包</strong>：如果软件包存放在光盘上，需要先挂载光盘，然后使用 RPM命令进行安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/cdrom /mnt</span><br><span class="line"><span class="built_in">cd</span> /mnt</span><br><span class="line">sudo rpm -ivh package.rpm</span><br></pre></td></tr></table></figure><p><strong><code>yum</code> 安装包</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装软件包：</span></span><br><span class="line">yum install packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载软件包：</span></span><br><span class="line">yum remove packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索软件包：</span></span><br><span class="line">yum search keyword</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看包信息：</span></span><br><span class="line">yum info packagename</span><br></pre></td></tr></table></figure><p><code>apt</code> 与 <code>yum</code>的操作逻辑相似，但底层依赖管理和软件包格式不同。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新软件源：</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件包：</span></span><br><span class="line">sudo apt install packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载软件包：</span></span><br><span class="line">sudo apt remove packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索软件包：</span></span><br><span class="line">apt search keyword</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看包信息：</span></span><br><span class="line">apt show packagename</span><br></pre></td></tr></table></figure><h3 id="dpkg-vs-rpm-命令对比表"><code>dpkg</code> vs <code>rpm</code>命令对比表</h3><table style="width:100%;"><colgroup><col style="width: 29%"><col style="width: 35%"><col style="width: 34%"></colgroup><thead><tr><th><strong>操作</strong></th><th><strong>Debian/Ubuntu (<code>dpkg</code>)</strong></th><th><strong>RHEL/CentOS/Fedora (<code>rpm</code>)</strong></th></tr></thead><tbody><tr><td><strong>安装软件包</strong></td><td><code>dpkg -i package.deb</code></td><td><code>rpm -i package.rpm</code></td></tr><tr><td><strong>升级软件包</strong></td><td><code>dpkg -i package.deb</code></td><td><code>rpm -U package.rpm</code></td></tr><tr><td><strong>删除软件包</strong></td><td><code>dpkg -r package</code></td><td><code>rpm -e package</code></td></tr><tr><td><strong>强制删除（含配置）</strong></td><td><code>dpkg --purge package</code></td><td><code>rpm -e --noscripts package</code></td></tr><tr><td><strong>查询已安装软件包</strong></td><td><code>dpkg -l</code></td><td><code>rpm -qa</code></td></tr><tr><td><strong>查询特定软件包</strong></td><td><code>dpkg -l | grep package</code></td><td><code>rpm -q package</code></td></tr><tr><td><strong>查看文件所属软件包</strong></td><td><code>dpkg -S /path/to/file</code></td><td><code>rpm -qf /path/to/file</code></td></tr><tr><td><strong>列出软件包安装的文件</strong></td><td><code>dpkg -L package</code></td><td><code>rpm -ql package</code></td></tr><tr><td><strong>检查软件包信息</strong></td><td><code>dpkg -I package.deb</code></td><td><code>rpm -qip package.rpm</code></td></tr><tr><td><strong>检查软件包依赖</strong></td><td><code>dpkg -I package.deb | grep Depends</code></td><td><code>rpm -qpR package.rpm</code></td></tr><tr><td><strong>列出某软件包的依赖</strong></td><td><code>dpkg -L package</code></td><td><code>rpm -qR package</code></td></tr><tr><td><strong>检查软件包是否已安装</strong></td><td><code>dpkg -s package</code></td><td><code>rpm -q package</code></td></tr><tr><td><strong>验证已安装的软件包</strong></td><td><code>dpkg --verify package</code></td><td><code>rpm -V package</code></td></tr><tr><td><strong>提取 <code>.deb</code> 或 <code>.rpm</code>文件</strong></td><td><code>dpkg -x package.deb /target/dir</code></td><td><code>rpm2cpio package.rpm | cpio -idmv</code></td></tr></tbody></table><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250210215953126.png" alt="image-20250210215953126"><figcaption aria-hidden="true">image-20250210215953126</figcaption></figure><h2 id="替换为阿里云源">3. 替换为阿里云源</h2><h3 id="备份原始源">📌 备份原始源</h3><p>在修改软件源之前，建议先备份原来的 sources.list 以防万一：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></table></figure><p>这样如果有问题，你可以恢复：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> /etc/apt/sources.list.bak /etc/apt/sources.list</span><br></pre></td></tr></table></figure><h3 id="替换-sources.list-为阿里云源">📌 替换 sources.list为阿里云源</h3><p><strong>✅ 方法 1：手动编辑</strong></p><p>使用 <code>vim</code> 或 <code>nano</code> 编辑 sources.list：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>删除原内容，替换为以下 <strong>阿里云镜像源</strong>（适用于<strong>Ubuntu 22.04、20.04、18.04</strong>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认官方源</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源码仓库（可选）</span></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><p>要注意 <code>bionic</code> 适用于 <strong>Ubuntu18.04</strong>，并且注意结合系统架构。</p><p><strong>✅ 方法 2：自动替换</strong></p><p>如果你不想手动编辑，可以直接运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*archive.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*security.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><h3 id="更新软件仓库">📌 更新软件仓库</h3><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br></pre></td></tr></table></figure><p>这将使用新的 <strong>阿里云镜像源</strong> 下载最新的软件包。</p><h3 id="确认修改成功">📌 确认修改成功</h3><p>你可以运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>如果输出包含 mirrors.aliyun.com，说明修改成功。</p><p>然后尝试安装软件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install vim -y</span><br></pre></td></tr></table></figure><p>如果安装速度明显变快，就说明 <strong>阿里云源生效</strong> 了！🚀</p><h1 id="二程序编译与解释">二、程序编译与解释</h1><ul><li><strong>编译型语言</strong><ul><li><strong>原理</strong>：程序在运行前经过编译器转换为机器语言，再由操作系统执行。<br></li><li><strong>优点</strong>：执行效率高；代码优化较好；通常适合需要高性能计算的场景。<br></li><li><strong>缺点</strong>：编译过程耗时；调试过程较复杂。<br></li><li><strong>实例</strong>：使用 gcc 编译 C 程序： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o hello hello.c</span><br><span class="line">./hello</span><br></pre></td></tr></table></figure></li></ul></li><li><strong>解释型语言</strong><ul><li><strong>原理</strong>：源代码在运行时由解释器逐行解析执行。<br></li><li><strong>优点</strong>：开发周期短，调试方便；跨平台性好。<br></li><li><strong>缺点</strong>：运行速度较慢；需要解释器支持。<br></li><li><strong>实例</strong>：使用 Python 执行脚本： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 hello.py</span><br></pre></td></tr></table></figure></li></ul></li></ul><p>不同语言的应用范围不一样：</p><ul><li>系统级开发：<ul><li>C/C++：httpd、nginx</li><li>golang：docker</li></ul></li><li>应用级开发：<ul><li>Java：Hadoop、Hbase</li><li>Python：openstack</li><li>Pert</li><li>Ruby</li><li>PHP</li></ul></li></ul><p>我们以 Golang 和 Python为例，比较这两种语言在性能、开发效率和生态系统方面的差异：</p><ul><li><p><strong>Golang (Go)</strong></p><ul><li><p><strong>特点</strong>：编译型语言，性能高、并发编程原生支持，适用于网络服务和分布式系统开发。<br></p></li><li><p><strong>缺点</strong>：语法相对严格，生态系统虽然不断发展但相对Python 略小。<br></p></li><li><p><strong>示例</strong>：一个简单的 Go 程序： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &#x27;EOF&#x27; &gt; hello.go</span><br><span class="line">package main</span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line">func main() &#123;</span><br><span class="line">    fmt.Println(&quot;Hello, Golang!&quot;)</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">go run hello.go</span><br></pre></td></tr></table></figure></p><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208153904973.png" alt="image-20250208153904973"><figcaption aria-hidden="true">image-20250208153904973</figcaption></figure><p><code>build</code> 之后就将源码以及相关依赖打包进文件<code>hello</code> 了，一次编译，到处运行（这也是 docker的理念），如果不编译就一定要机器上有对应的编译器。</p></li></ul></li><li><p><strong>Python</strong></p><ul><li><p><strong>特点</strong>：语法简洁、开发速度快、拥有丰富的第三方库，适用于数据分析、Web开发和自动化脚本。</p></li><li><p><strong>缺点</strong>：运行速度相对较慢，不适合极端高性能计算。</p></li><li><p><strong>示例</strong>：一个简单的 Python 脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &#x27;EOF&#x27; &gt; hello.py</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line">print(&quot;Hello, Python!&quot;)</span><br><span class="line">EOF</span><br><span class="line">python3 hello.py</span><br></pre></td></tr></table></figure></li></ul></li></ul><h1 id="三源码编译与二进制配置">三、源码编译与二进制配置</h1><p>在 Linux 中，软件可以通过源码编译或二进制免安装方式进行部署。</p><ul><li><strong>二进制包</strong>：已经编译好的可执行文件及其依赖文件（如Ubuntu 下的 DEB 包）。安装快速、方便，但可定制性较低。<br></li><li><strong>源码包</strong>：包含程序的源代码，需要经过编译生成可执行文件。提供更高的定制化和优化空间，但安装过程较复杂。</li></ul><h2 id="源码编译以淘宝-nginx-为例">1. 源码编译（以淘宝 Nginx 为例）</h2><p><strong>步骤</strong>：</p><ol type="1"><li><p>下载源码：从淘宝镜像或官方源下载 Nginx源码包，可以复制链接地址后去虚拟机 <code>wget</code></p><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235532884.png" alt="image-20250208235532884"><figcaption aria-hidden="true">image-20250208235532884</figcaption></figure></li><li><p>解压源码包： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.xx.tar.gz</span><br></pre></td></tr></table></figure></p></li><li><p>配置编译参数： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.xx</span><br><span class="line">./configure --prefix=/usr/local/nginx --with-http_ssl_module</span><br></pre></td></tr></table></figure></p><p>逐步将需要的包都安装完后，将会返回如下结果说明成功了：</p><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235125749.png" alt="image-20250208235125749"><figcaption aria-hidden="true">image-20250208235125749</figcaption></figure><p>查看当前目录会发现多了个 <code>Makefile</code>：</p><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235736672.png" alt="image-20250208235736672"><figcaption aria-hidden="true">image-20250208235736672</figcaption></figure><p>只有 <code>make install</code> 成功后，才会生成指定的<code>nginx</code> 路径。</p></li><li><p>编译并安装： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">## 或者直接</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>经过一长串的编译，结果如下：</p><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235927988.png" alt="image-20250208235927988"><figcaption aria-hidden="true">image-20250208235927988</figcaption></figure></li><li><p>查看安装的路径，会发现包含这四个文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">conf  html  logs  sbin</span><br></pre></td></tr></table></figure><p>分别对应配置文件、前端 HTML页面、日志文件和可执行的二进制文件。</p></li><li><p>启动 Tengine：</p><p>在 <code>nginx.conf</code> 文件里配置完端口号启动<code>./sbin/nginx</code>：</p><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250209001323246.png" alt="image-20250209001323246"><figcaption aria-hidden="true">image-20250209001323246</figcaption></figure></li></ol><p>编译过程允许你自定义安装路径和模块，适用于需要特定功能或优化的场景。</p><h2 id="二进制免安装配置以-java-为例">2. 二进制免安装配置（以 Java为例）</h2><p><strong>步骤</strong>：</p><ol type="1"><li><p><a class="link" href="https://www.java.com/en/download/manual.jsp">下载 Java二进制包<i class="fas fa-external-link-alt"></i></a>（通常为压缩文件）。</p><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250209004010589.png" alt="image-20250209004010589"><figcaption aria-hidden="true">image-20250209004010589</figcaption></figure></li><li><p>解压文件到指定目录（或者使用SFTP进行主机和虚拟机之间传输）：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk-xx_linux-x64_bin.tar.gz -C /opt</span><br></pre></td></tr></table></figure></p></li><li><p>配置环境变量： 编辑 <code>~/.bashrc</code> 添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/opt/jdk-xx</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250209004248120.png" alt="image-20250209004248120"><figcaption aria-hidden="true">image-20250209004248120</figcaption></figure></li><li><p>使配置生效： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure></p></li></ol><p>这种方式无需安装程序，直接解压配置，便于快速部署和版本切换。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;软件包管理看起来只是“装/卸/更新”，但真正决定你是否少踩坑的是两件事：第一，包里到底包含了什么（可执行文件、配置、依赖库、服务脚本），以及它们分别落在系统的哪些位置；第二，发行版的工具链差异（Debian/Ubuntu
的 &lt;code&gt;dpkg/apt&lt;/code&gt; vs CentOS 的
&lt;code&gt;rpm/yum/dnf&lt;/code&gt;）会如何影响依赖解析、版本选择与回滚策略。本文先把软件包与依赖的基本概念讲清楚，再给出一套可复现的常用操作清单，并补上国内环境最常见的配置（例如替换阿里云源、验证源是否生效）。最后把“装包”延伸到更贴近生产的两条路径：源码编译（以
Nginx 为例）与二进制免安装配置（以 Java
为例），让你在遇到版本/依赖/网络限制时有可选的落地方案。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 进程与资源管理</title>
    <link href="https://chenk.top/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-28T01:15:27.963Z</updated>
    
    <content type="html"><![CDATA[<p>线上排障时，最关键的能力不是“会背命令”，而是能把现象快速映射到资源与进程：CPU是不是被打满、内存是不是被 cache 吃掉、磁盘 I/O在不在等、到底是哪一个进程/文件/端口在拖慢系统。本文从进程/线程与父子关系的基本概念出发，解释Linux 的资源视角（尤其是 buffer/cache的含义），然后系统梳理一套常用监控与定位工具链（<code>top/htop/ps/pstree/lsof</code>、端口/网络、I/O、负载与压力测试）。接着补齐“把进程控住”的操作：信号与后台任务、<code>nice/renice</code>优先级、孤儿/僵尸进程的成因与处理；最后用挂载点的例子把“资源视角”落到文件系统层面，方便你把一次完整排障流程跑通。</p><span id="more"></span><h1 id="一进程与程序管理">一、进程与程序管理</h1><h2 id="进程与程序之间的关系">1. 进程与程序之间的关系</h2><p>在 Linux中，<strong>程序</strong>是存储在硬盘上的静态可执行文件，而<strong>进程</strong>是程序加载到内存中后运行的实例。每次运行程序时，系统都会创建一个或多个进程，每个进程拥有独立的内存空间、进程ID（PID）、父进程ID（PPID）以及各自的运行环境。进程是动态存在的，是源代码和数据的结合体，是一个资源单位，而程序则是静态存储的代码集合。</p><p>线程则是 CPU运行的最小工作单位，例如一个网易云音乐进程可能包含两个线程，一个是下载音乐，一个是播放歌曲。因此进程可以理解为工地上指挥干活的包工头，线程是具体干活的工人。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/program-process-task-thread_1589445704853.jpeg" alt="程序、进程、线程和任务之间关系| iBit程序猿"><figcaption aria-hidden="true">程序、进程、线程和任务之间关系|iBit程序猿</figcaption></figure><p><strong>例子</strong>：<br>- 当你在 Ubuntu 中运行 <code>vim myfile.txt</code> 时，<code>vim</code>程序从硬盘加载到内存中，产生一个进程，该进程负责编辑<code>myfile.txt</code>。<br>-同一个程序可以同时启动多个进程，例如在浏览器中打开多个标签页时，每个标签页可能对应一个独立的进程或线程。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例：启动 vim 进程并查看 PID</span></span><br><span class="line">vim myfile.txt &amp;</span><br><span class="line">ps -ef | grep vim</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206003356484.png" alt="image-20250206003356484"><figcaption aria-hidden="true">image-20250206003356484</figcaption></figure><h2 id="进程的特点">2. 进程的特点</h2><h3 id="进程的独立性与并发性">进程的独立性与并发性</h3><ul><li><strong>独立性</strong>：每个进程都有自己的内存空间和系统资源，彼此相互隔离。</li><li><strong>并发性</strong>：操作系统允许多个进程同时运行，通过多任务调度实现并发处理。</li><li><strong>动态性</strong>：进程不断创建、执行、终止，状态实时变化。【操作系统的运行就是不断的创建进程和销毁进程】</li><li><strong>父子关系</strong>：进程由父进程通过 <code>fork()</code>调用创建，形成父子结构；父进程的 PPID 字段指明了其创建者。</li><li><strong>调度性</strong>：操作系统使用调度算法（如时间片轮转、优先级调度）来决定进程的执行顺序。</li></ul><h3 id="示例">示例</h3><ul><li>使用 <code>ps -ef</code> 查看进程时，可以看到每个进程的 PID 和PPID，帮助理解父子进程关系。</li><li>父进程退出后，子进程成为孤儿进程，由 <code>init</code> 或<code>systemd</code> 接管。</li><li>当子进程结束但父进程未调用 <code>wait()</code>回收时，会产生僵尸进程，其信息仍保留在进程表中。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看进程父子关系示例</span></span><br><span class="line">ps -ef | grep bash</span><br><span class="line">pstree -p</span><br></pre></td></tr></table></figure><h1 id="二linux-系统资源管理概述">二、Linux 系统资源管理概述</h1><p>运维工作围绕硬件和软件资源展开，合理管理这些资源可确保系统高效稳定运行。下面介绍主要硬件与软件资源及常用监控工具。</p><h2 id="硬件资源管理">1. 硬件资源管理</h2><p><strong>磁盘资源</strong></p><ul><li><p><strong>容量</strong>：硬盘或 SSD 提供的总存储空间。</p></li><li><p><strong>读写性能</strong>：</p><ul><li><strong>机械硬盘（HDD）</strong>：容量大、价格低、速度较慢。</li><li><strong>固态硬盘（SSD）</strong>：速度快、价格高、容量相对较小。</li></ul></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h       <span class="comment"># 查看磁盘使用情况</span></span><br><span class="line">lsblk       <span class="comment"># 列出块设备及挂载点</span></span><br><span class="line">iostat      <span class="comment"># 监控磁盘 I/O 性能</span></span><br></pre></td></tr></table></figure></li></ul><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206111508163.png" alt="image-20250206111508163"><figcaption aria-hidden="true">image-20250206111508163</figcaption></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206111526729.png" alt="image-20250206111526729"><figcaption aria-hidden="true">image-20250206111526729</figcaption></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206111544412.png" alt="image-20250206111544412"><figcaption aria-hidden="true">image-20250206111544412</figcaption></figure><ul><li>操作系统 0号进程：0号进程会创建出一堆内核级进程，提供操作系统运行</li><li>用户级别 1 号进程：<ul><li>基于 1 号进程创建子进程 <code>sshd</code> 服务</li><li>基于 <code>sshd</code> 服务产生 <code>ssh</code> 客户端连接进程</li><li>基于 <code>ssh</code> 进程产生用户 <code>bash</code> 进程</li><li>基于 <code>bash</code> 进程产生用户执行的其他进程</li></ul></li></ul><p><strong>内存资源</strong></p><ul><li><p><strong>总内存与剩余内存</strong>：反映系统当前内存占用情况。</p></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free -hfree -h     <span class="comment"># 查看内存和交换空间使用情况</span></span><br><span class="line">vmstat      <span class="comment"># 查看虚拟内存统计信息</span></span><br></pre></td></tr></table></figure></li></ul><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206153209092.png" alt="image-20250206153209092"><figcaption aria-hidden="true">image-20250206153209092</figcaption></figure><p><strong>CPU 资源</strong></p><ul><li><p><strong>核心数与负载</strong>：监控各进程对 CPU的占用情况和系统整体负载。</p></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line">htop</span><br><span class="line">mpstat</span><br></pre></td></tr></table></figure></li></ul><p><strong>网络资源</strong></p><ul><li><p><strong>带宽、吞吐量与延迟</strong>：监控网络接口的数据传输速率和状态。</p></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iftop       <span class="comment"># 实时监控网络流量</span></span><br><span class="line">ip -s <span class="built_in">link</span>  <span class="comment"># 查看接口统计信息</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="软件资源与服务管理">2. 软件资源与服务管理</h2><ul><li><strong>系统服务</strong>：如 <code>sshd</code>, <code>crond</code>,<code>ntpd</code> 等，通过 <code>systemctl</code> 管理。</li><li><strong>日志管理</strong>：利用 <code>rsyslog</code> 或<code>journalctl</code> 分析系统和应用日志。</li><li><strong>计划任务</strong>：使用 <code>crontab</code>配置定时任务，实现自动化运维。</li></ul><p><strong>例子</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl status sshd</span><br><span class="line">systemctl restart ntpd</span><br><span class="line">crontab -e</span><br></pre></td></tr></table></figure><h2 id="buffer-和-cache-讲解">3. Buffer 和 Cache 讲解</h2><p>Linux 系统将内存划分为多个区域，其中 Buffer 和 Cache是两个非常重要的区域。理解这两个概念有助于更好地优化系统性能和排查问题。</p><h3 id="缓存与性能">缓存与性能</h3><ol type="1"><li><strong>高效的内存使用</strong>：内存中的 Buffer 和 Cache提供了数据的快速访问通道。当程序需要读取文件时，Linux 会首先检查 Cache中是否有该文件的数据，如果有，直接从内存中读取，速度非常快；如果没有，则从磁盘读取并缓存到内存。</li><li><strong>提升磁盘 I/O 性能</strong>：Buffer 和 Cache 缓存使得磁盘 I/O变得更加高效，减少了磁盘的访问次数，提高了系统性能。</li></ol><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/maxresdefault.jpg" alt="Buffer Cache"><figcaption aria-hidden="true">Buffer Cache</figcaption></figure><h3 id="buffer写入数据时加速">Buffer（写入数据时加速）</h3><p><strong>定义</strong>：Buffer是操作系统用于存储即将写入磁盘的数据的内存区域。当程序要写入文件时，数据首先会被存储在内存中的Buffer 中，等到合适的时机再分批次写入磁盘。没有 buffer的时候会产生大量的零碎文件，不断的把碎片文件写如此盘，太慢了。</p><p><strong>作用</strong>：它减少了程序直接与磁盘交互的次数，从而提高了I/O 性能。</p><h3 id="cache读取数据时加速">Cache（读取数据时加速）</h3><p><strong>定义</strong>：Cache是用于存储已经读取过的数据，目的是加速后续访问。Cache保存了频繁访问的磁盘数据，以减少磁盘 I/O 操作，提高数据读取速度。</p><p><strong>作用</strong>：缓存是内存中高速存取的数据区域，频繁访问的数据会被缓存在内存中，而不是每次都去磁盘读取。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/2478745-20220518204225587-325292210.png" alt="buff和cached解析- 屯子里唯一的架构师- 博客园"><figcaption aria-hidden="true">buff和cached解析- 屯子里唯一的架构师-博客园</figcaption></figure><h1 id="三进程监控工具详解">三、进程监控工具详解</h1><h2 id="使用-top-动态查看进程信息">1. 使用 <code>top</code>动态查看进程信息</h2><p><code>top</code> 提供实时进程信息，显示CPU、内存使用率、运行时间、命令等信息。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150129592.png" alt="image-20250206150129592"><figcaption aria-hidden="true">image-20250206150129592</figcaption></figure><p>第一行的 <code>load average</code>里，CPU是几核的，数字越接近几压力就越大，例如CPU是4核的，数字越接近4压力就越大</p><p><strong>常用快捷键</strong>：</p><ul><li>P：按 CPU 占用排序</li><li>M：按内存占用排序</li><li>k：输入 PID 发送信号终止进程</li><li>q：退出 top 界面</li></ul><p><strong>补充（glances）</strong>：综合监控工具，实时展示系统各项指标。这个工具是基于Python开发的，可以用Python去改造，同时还提供了Web可视化页面，也就是这个程序部署在云上，可以以Web的形式展示系统资源。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150908037.png" alt="image-20250206150908037"><figcaption aria-hidden="true">image-20250206150908037</figcaption></figure><h2 id="使用-htop-增强监控体验">2. 使用 <code>htop</code>增强监控体验</h2><p><code>htop</code> 是 <code>top</code>的增强版，具有友好的彩色界面和交互式操作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt install htop</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">htop</span><br></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>支持鼠标操作</li><li>显示树状进程视图</li><li>可直接选择并终止进程</li></ul><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150847590.png" alt="image-20250206150847590"><figcaption aria-hidden="true">image-20250206150847590</figcaption></figure><h2 id="使用-ps-静态查看进程信息">3. 使用 <code>ps</code>静态查看进程信息</h2><p>ps 命令提供当前进程快照信息，可通过不同选项显示详细内容。</p><p><strong>常用用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206134925579.png" alt="image-20250206134925579"><figcaption aria-hidden="true">image-20250206134925579</figcaption></figure><p><code>ps</code>看到的进程名字，如果带有中括号，那就是Linux内核自动生成的进程，如果没有中括号（第一行），就是发行版系统，用户生成的各种进程。也就是说，Linux是一个开源内核，而 Ubuntu 则是基于 Linux 内核构建的一个 Linux发行版。</p><ul><li><strong>Linux 内核</strong>：Linux 内核是由 Linus Torvalds 在 1991年首次发布的，它是操作系统的核心，负责硬件管理、内存管理、进程调度、文件系统等基本功能。内核本身不包含用户界面或应用程序，它只是提供了系统资源的抽象层和基本服务。</li><li><strong>Linux 发行版（Distribution）</strong>：Linux 发行版是在Linux内核的基础上，整合了大量软件包、工具和应用程序，形成一个完整的操作系统。发行版会添加图形界面、命令行工具、安装程序和各种预配置的软件，使得普通用户也能方便地使用Linux 系统。Ubuntu 就是众多 Linux发行版之一，它以用户友好、易于安装和良好的社区支持而著称。</li></ul><p>简单来说，Ubuntu 使用 Linux内核，并在其基础上整合了各种软件包和工具，构成一个完整的操作系统。其他知名的发行版还有Debian、Fedora、CentOS 等，它们都共享同一个 Linux内核，但在软件选择、配置和用户体验上有所不同。</p><p><code>ps -ef</code> 是 Unix 风格的命令，有短横线，而<code>ps auf</code> 是 BSD 风格的命令，没有短横线。Unix风格的具体命令格式和其他参数如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef -p &lt;pid_list&gt; -C &lt;<span class="built_in">command</span>&gt; -U &lt;user&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>-e</strong>：显示所有进程（等同于–A），即不限制进程所属的终端、用户等。</li><li><strong>-f</strong>：使用全格式输出（Full-format），会显示额外的信息，例如UID、PID、PPID、C（CPU 占用）、STIME、TTY、TIME、CMD等。输出内容更详细。</li><li><strong>-p</strong>：根据进程 ID（PID）过滤显示，仅列出指定 PID的进程。使用时需要在后面跟上一个或多个 PID 列表，例如<code>-p 1234,5678</code>。</li><li><strong>-C</strong>：根据命令名过滤显示，仅列出指定命令名称对应的进程。例如-C sshd 会显示所有名称为 sshd 的进程。</li><li><strong>-U</strong>：根据实际用户（Realuser）过滤显示，仅显示指定用户拥有的进程。例如 <code>-U root</code>会显示 <code>root</code> 用户的所有进程。</li></ul><p>BSD 风格的命令的各个选项的含义如下：</p><ul><li><strong>a</strong>：显示所有与终端相关的进程，不仅限于当前用户的进程。</li><li><strong>x</strong>：显示所有进程，包括那些没有控制终端（TTY）的进程（例如守护进程或后台进程）。</li><li><strong>u</strong>：以用户导向格式显示进程信息，输出中会包含<code>USER、PID、%CPU、%MEM、VSZ、RSS、TTY、STAT、START、TIME、COMMAND</code>等列，更加直观易读。</li><li><strong>f</strong>：以树状结构（forest）的形式ps显示进程之间的父子关系，有助于理解进程的继承关系。</li><li><strong>o</strong>：允许用户自定义输出格式，可以指定输出哪些列。如果后面没有跟参数，则使用默认格式；通常可以写成<code>ps axu -o pid,ppid,cmd</code> 这种形式来指定需要显示的列。</li><li><strong>k</strong>：用来指定排序关键字，控制输出结果的排序方式。例如可以按PID、CPU占用或内存等排序。如果后面没有跟具体参数，则通常使用默认排序方式。</li></ul><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150048998.png" alt="image-20250206150048998"><figcaption aria-hidden="true">image-20250206150048998</figcaption></figure><p><code>ps</code> 可以去掉 <code>grep</code> 显示的那个进程，方法是使用<code>-v</code> 参数（结果取反）：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206152136083.png" alt="image-20250206152136083"><figcaption aria-hidden="true">image-20250206152136083</figcaption></figure><h2 id="使用-pstree-显示进程树">4. 使用 <code>pstree</code>显示进程树</h2><p><code>pstree</code>以树状结构展示进程父子关系，帮助理解进程层级。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree -p</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206151051241.png" alt="image-20250206151051241"><figcaption aria-hidden="true">image-20250206151051241</figcaption></figure><h2 id="使用-pidof-查找进程-pid">5. 使用 <code>pidof</code> 查找进程PID</h2><p><code>pidof</code> 能查找指定进程的 PID，适合脚本自动化管理。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 pidof sshd 返回所有 SSH 守护进程的 PID。</span></span><br><span class="line">pidof sshd</span><br></pre></td></tr></table></figure><h2 id="使用-lsof-查看打开的文件">6. 使用 <code>lsof</code>查看打开的文件</h2><p><code>lsof</code>（List OpenFiles）用于列出系统中所有打开的文件，包括常见的网络连接、设备和进程占用的文件。以下是一些常用参数及其说明：</p><ul><li><p><strong>-a</strong><br>与其他选项一起使用，表示“与”关系（AND），只显示同时满足所有条件的结果。</p></li><li><p><strong>-c <command></strong><br>按进程名称过滤，显示指定命令名的进程所打开的文件。<br><em>示例：</em> <code>lsof -c ssh</code></p></li><li><p><strong>-d <fd></fd></strong><br>按文件描述符过滤，显示特定文件描述符（如<code>cwd</code>、<code>txt</code>、<code>mem</code>、<code>1</code>、<code>2</code>等）的打开文件。<br><em>示例：</em> <code>lsof -d cwd</code></p></li><li><p><strong>-i [protocol]<span class="citation" data-cites="hostname">[@hostname|hostaddr]</span>[:service|port]</strong><br>显示网络相关的打开文件。</p><ul><li><code>lsof -i</code> 显示所有网络连接<br></li><li><code>lsof -i tcp</code> 显示所有 TCP 连接<br></li><li><code>lsof -i :80</code> 显示所有使用 80 端口的进程<br></li><li><code>lsof -i @192.168.1.100</code> 显示与特定 IP 相关的连接</li></ul></li><li><p><strong>-n</strong><br>禁用主机名解析，直接显示 IP 地址，有助于提高执行速度并避免 DNS查询延迟。</p></li><li><p><strong>-P</strong><br>禁用端口号转换，不把端口号转换为服务名称，直接显示数字端口。</p></li><li><p><strong>-u <user></user></strong><br>按用户过滤，显示指定用户的所有打开文件。<br><em>示例：</em> <code>lsof -u root</code></p></li><li><p><strong>-p <pid></pid></strong><br>按进程 ID 过滤，显示指定进程的所有打开文件。<br><em>示例：</em> <code>lsof -p 1234</code></p></li><li><p><strong>+D <directory></directory></strong><br>列出指定目录（包括子目录）中所有打开的文件。<br><em>示例：</em> <code>lsof +D /var/log</code></p></li><li><p><strong>+L1</strong><br>列出链接计数小于 1 的文件，通常表示文件已删除但仍被进程占用。</p></li><li><p><strong>-r [interval]</strong><br>循环执行<code>lsof</code>，每隔指定秒数刷新一次结果，常用于实时监控。<br><em>示例：</em> <code>lsof -r 2</code> （每 2 秒刷新一次）</p></li><li><p><strong>-V</strong><br>显示 <code>lsof</code> 版本信息。</p></li></ul><p><strong>示例：</strong></p><p>列出所有使用 80 端口的网络连接，不解析主机名和端口名称：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -nlsof -nP -i :80P -i :80</span><br></pre></td></tr></table></figure></p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206173629686.png" alt="image-20250206173629686"><figcaption aria-hidden="true">image-20250206173629686</figcaption></figure><p>其他一些用法：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206152853213.png" alt="image-20250206152853213"><figcaption aria-hidden="true">image-20250206152853213</figcaption></figure><p>查看 Nginx 进程打开了哪些文件，进一步可以从中过滤出日志文件：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206153440327.png" alt="image-20250206153440327"><figcaption aria-hidden="true">image-20250206153440327</figcaption></figure><p>还可以查看占用文件的进程：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206173342247.png" alt="image-20250206173342247"><figcaption aria-hidden="true">image-20250206173342247</figcaption></figure><h2 id="网络流量与端口监控">7. 网络流量与端口监控</h2><ul><li><strong>iftop</strong>：实时显示网络接口数据流量。</li><li><strong>lsof</strong>：查看进程打开的文件或网络端口。</li><li><strong>netstat, ss</strong></li></ul><p><strong>例子：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iftop -i ens160</span><br><span class="line">lsof -i :80</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208013603183.png" alt="image-20250208013603183"><figcaption aria-hidden="true">image-20250208013603183</figcaption></figure><p>也可以使用 <code>netstat</code> 或者具有更快的查询速度的<code>ss</code> 命令查看端口信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -tulnp</span><br><span class="line">ss -tulnp <span class="comment"># 高并发下性能更高</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208013219488.png" alt="image-20250208013219488"><figcaption aria-hidden="true">image-20250208013219488</figcaption></figure><p><code>-t</code> 显示 TCP 连接，<code>-u</code> 显示 UDP连接，<code>-l</code> 显示监听端口（过滤出 State 列中值为 LISTEN的连接），<code>-n</code> 显示数字形式的地址和端口，<code>-p</code>表示显示发起连接的进程 <code>pid</code> 和进程名称。</p><h2 id="磁盘-io-查看">8. 磁盘 I/O 查看</h2><p>磁盘 I/O的性能直接影响到系统的运行效率，特别是在进行大规模数据处理时。</p><p><code>iostat</code> 命令提供了关于 CPU 和 I/O设备的详细统计信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iostat -x</span><br></pre></td></tr></table></figure><p><code>-x</code> 参数显示扩展信息，包括每个设备的 I/O 性能。</p><p>另外也可以使用 <code>iotop</code> 实时查看磁盘 I/O使用情况，但需要管理员权限来运行，实时显示进程的磁盘 I/O 使用情况。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208011840833.png" alt="image-20250208011840833"><figcaption aria-hidden="true">image-20250208011840833</figcaption></figure><p><code>iotop -k</code> 可以动态显示 IO 情况：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208012108808.png" alt="image-20250208012108808"><figcaption aria-hidden="true">image-20250208012108808</figcaption></figure><h2 id="内存资源查看-free">9. 内存资源查看 <code>free</code></h2><p>在 Linux 系统中，查看内存资源的使用情况，可以使用 <code>free</code>命令。该命令提供了有关系统内存使用的汇总信息。</p><ol type="1"><li><p><strong>查看内存使用情况</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -h</span><br></pre></td></tr></table></figure></li></ol><p>​ <code>-h</code> 参数会以人类易读的格式（如MB、GB）显示内存使用情况。</p><ol start="2" type="1"><li><p><strong>输出详细信息</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -m</span><br></pre></td></tr></table></figure><p><code>-m</code> 参数以 MB为单位显示内存使用情况，适用于查看内存总量和剩余空间。</p></li><li><p><strong>查看内存使用变化</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch free -h</span><br></pre></td></tr></table></figure><p>使用 <code>watch</code>命令可以实时监控内存使用情况，自动刷新显示结果。</p></li></ol><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208010259465.png" alt="image-20250208010259465"><figcaption aria-hidden="true">image-20250208010259465</figcaption></figure><blockquote><p>swap是硬件交换分区（虚拟内存），防止内存用完导致系统崩溃，临时拿磁盘的一些空间当做内存使用。</p></blockquote><h2 id="cpu-与负载管理">10. CPU 与负载管理</h2><p>在 Linux 系统中，查看 CPU核心数非常简单，可以使用以下命令来查看当前系统中的 CPU 配置：</p><ul><li><p><strong><code>lscpu</code> 命令</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  lscpu | grep -i <span class="string">&#x27;^cpu(s)&#x27;</span></span><br><span class="line"></span><br><span class="line">​这个命令会输出系统中 CPU 的核心数信息，例如：</span><br><span class="line"></span><br><span class="line">​![image-20250208004559916](./Linux%20进程与资源管理/image-20250208004559916.png)</span><br><span class="line"></span><br><span class="line">* **`top` 命令**：在 `top` 命令的实时监控界面中，按下 1 键可以查看每个 CPU 核心的使用情况。理想情况下，所有 CPU 核心都会有进程在执行，这表示 CPU 被充分利用，系统的运行效率最大化。</span><br><span class="line"></span><br><span class="line">理想的 CPU 利用状态是系统中的每个核心都在处理进程。在高并发编程中，目标是让系统的每个 CPU 核心都得到充分的利用，这样才能在多核 CPU 系统中达到最大的工作效率。例如，如果你有 4 个核心的 CPU，理想情况下，应该有 4 个进程同时运行，每个进程占用一个 CPU 核心。这样系统可以最大化地发挥 CPU 的处理能力。如果你的代码或程序设计不当，导致只有一个核心在执行任务，而其他核心空闲，这样就不能充分利用所有的 CPU 核心，导致系统资源浪费。</span><br><span class="line"></span><br><span class="line">* **<span class="built_in">uptime</span> 命令**：</span><br><span class="line"></span><br><span class="line">  ```bash</span><br><span class="line">   <span class="comment"># 输出示例</span></span><br><span class="line">   06:56:12 up 12 days,  3:45,  3 <span class="built_in">users</span>,  load average: 0.22, 0.45, 0.56</span><br></pre></td></tr></table></figure></p><p>在输出中，load average 后面跟着的是三个数字，分别表示 1 分钟、5分钟和 15 分钟内的平均负载。要如何解读这些负载值呢？</p><ul><li><strong>理想的负载情况</strong>：如果这三个值差不多，说明系统运行平稳，负载是均衡的。</li><li><strong>负载迅速增加</strong>：如果 1 分钟内的负载值远大于 15分钟的负载值，说明系统在短时间内负载突然上升，可能表示系统正在经历某种突发的工作负载。</li><li><strong>负载下降</strong>：如果 1 分钟内的负载值小于 15分钟的负载值，说明系统负载正在下降，负载压力减轻。</li></ul><p>就上面的例子而言：</p><ul><li><p>在过去 1 分钟内，系统的负载平均值为 0.22。</p></li><li><p>在过去 5 分钟内，系统的负载平均值为 0.45。</p></li><li><p>在过去 15 分钟内，系统的负载平均值为 0.56。</p></li></ul><p>这些值相差不大，表明系统负载较为平稳，没有出现过高的负载压力。</p></li></ul><h2 id="stress-负载压力测试">11. Stress 负载压力测试</h2><p><code>stress</code> 是一个常用的负载测试工具，用于模拟CPU、内存、磁盘和 I/O负载等各种场景。它可以帮助你进行性能测试或模拟系统的高负载状态，评估系统的稳定性。</p><ol type="1"><li><p><strong>安装 <code>stress</code></strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install stress</span><br></pre></td></tr></table></figure></li><li><p><strong>进行 CPU 压力测试</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress --cpu 4 --<span class="built_in">timeout</span> 60s</span><br></pre></td></tr></table></figure><p>这条命令会启动 4 个进程，进行 60 秒的 CPU 压力测试。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208005755365.png" alt="image-20250208005755365"><figcaption aria-hidden="true">image-20250208005755365</figcaption></figure><p>其他的还有 <code>pidstat</code> 和 <code>mpstat</code>：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208005952558.png" alt="image-20250208005952558"><figcaption aria-hidden="true">image-20250208005952558</figcaption></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208010015379.png" alt="image-20250208010015379"><figcaption aria-hidden="true">image-20250208010015379</figcaption></figure></li><li><p><strong>内存压力测试</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress --vm 2 --vm-bytes 1G --<span class="built_in">timeout</span> 60s</span><br></pre></td></tr></table></figure><p>启动 2 个虚拟内存进程，每个进程分配 1GB 内存，持续 60 秒。</p></li><li><p><strong>I/O 压力测试</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress --io 4 --<span class="built_in">timeout</span> 60s</span><br></pre></td></tr></table></figure><p>进行 I/O 操作压力测试，启动 4 个 I/O 密集型进程，测试持续 60秒。</p></li></ol><h1 id="四进程信号与后台管理">四、进程信号与后台管理</h1><h2 id="使用-kill-发送信号">1. 使用 <code>kill</code> 发送信号</h2><p><code>kill</code>命令用于向进程发送信号，以请求进程终止或进行其他处理。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> &lt;PID&gt;</span><br></pre></td></tr></table></figure><p>默认发送 <code>SIGTERM</code> 信号（等于加 15信号），通常请求进程正常退出。</p><p><strong>强制终止</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;</span><br></pre></td></tr></table></figure><p>发送 <code>SIGKILL</code> 信号，强制立即终止进程。</p><p><strong>不关闭进程，重新加载其配置文件，如 <code>reload</code> 操作</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -1 &lt;PID&gt;</span><br></pre></td></tr></table></figure><p><code>kill</code> 命令的其他信号参数如下：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206233455373.png" alt="image-20250206233455373"><figcaption aria-hidden="true">image-20250206233455373</figcaption></figure><p>其中 2 信号等于中断（ <code>Ctrl + C</code>）；3信号等于退出（<code>Ctrl + \</code>）；15信号是终止，通常是系统关机时发送；20信号是暂停进程（<code>Ctrl + Z</code>）。下面可以看到我们使用<code>Ctrl + Z</code> 暂停进程后，<code>ping</code> 的进程被挂起了，使用<code>kill</code> 并没有杀掉他，但 <code>ping</code> 并没有响应<code>SIGTERM</code>，我们需要 <code>SIGKILL</code>（信号9）强制终止：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206234327729.png" alt="image-20250206234327729"><figcaption aria-hidden="true">image-20250206234327729</figcaption></figure><p>我们可以再做个实验，在一个终端<code>ping</code>，在另一个终端使用正常的 <code>kill</code>命令，看是否会被杀死：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206234726903.png" alt="image-20250206234726903"><figcaption aria-hidden="true">image-20250206234726903</figcaption></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206234815881.png" alt="image-20250206234815881"><figcaption aria-hidden="true">image-20250206234815881</figcaption></figure><p>可以看到，当 <code>ping</code>不是在暂停状态时，是可以直接被杀死的，不需要强制。</p><p><code>killall</code>可以将所有同名的进程杀死，但不建议用，容易挨揍。</p><h2 id="后台运行命令">2. 后台运行命令</h2><h3 id="使用-将命令放入后台">使用 <code>&amp;</code> 将命令放入后台</h3><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./long_task.sh &amp;</span><br></pre></td></tr></table></figure><h3 id="使用-nohup-保证任务在注销后继续运行">使用 <code>nohup</code>保证任务在注销后继续运行</h3><p>即使非正常退出，<code>nohup + &amp;</code> 的任务也还在，但如果不加<code>nohup</code> 就不在了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ./backup.sh &amp;</span><br></pre></td></tr></table></figure><h3 id="bg-和-fg"><code>bg</code> 和 <code>fg</code></h3><p><code>bg</code> 是在 <code>Ctrl + Z</code>后将后台的程序继续运行起来，<code>fg</code>是将前台运行的程序放到后台运行，后面接查看 <code>jobs</code>后显示的对应进程的 <code>ID</code>号，注意无论是不是后台运行该在终端输出的还是会输出。</p><h1 id="五调整进程优先级">五、调整进程优先级</h1><h2 id="使用-nice-启动进程">1. 使用 <code>nice</code> 启动进程</h2><p><code>nice</code> 命令在启动进程时指定其优先级。<code>nice</code>值越高，进程优先级越低；<code>nice</code> 值范围通常为-20（最高优先级）到 19（最低优先级）。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nice</span> -n 10 ./myscript.sh</span><br></pre></td></tr></table></figure><p><strong>例子</strong>：</p><p>启动脚本 <code>myscript.sh</code> 时以 <code>nice</code> 值 10运行，降低其对 CPU 的抢占。</p><h2 id="使用-renice-调整正在运行进程的优先级">2. 使用<code>renice</code> 调整正在运行进程的优先级</h2><p><code>renice</code> 命令用于修改已运行进程的 <code>nice</code>值。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renice -n -5 -p &lt;PID&gt;</span><br></pre></td></tr></table></figure><p><strong>例子</strong>：</p><p>调整进程 2345 的优先级，将 <code>nice</code> 值设置为-5（提高优先级）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renice -n -5 -p 2345</span><br></pre></td></tr></table></figure><h1 id="六进程父子关系与特殊进程状态">六、进程父子关系与特殊进程状态</h1><h2 id="进程父子关系">1. 进程父子关系</h2><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/copy-on-write.png" alt="Redis数据持久化- Aphasia&#39;s personal blog"><figcaption aria-hidden="true">Redis数据持久化- Aphasia's personalblog</figcaption></figure><ul><li><p>每个进程通过 <code>fork()</code> 调用由父进程创建。</p></li><li><p><strong>父进程</strong>与<strong>子进程</strong>通过 PPID（父进程ID）关联。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206113610023.png" alt="image-20250206113610023"><figcaption aria-hidden="true">image-20250206113610023</figcaption></figure><p>我们登录的 XShell 终端的流程是：</p><ol type="1"><li>系统上运行了 <code>sshd</code> 服务</li><li>通过 <code>ssh</code>客户端命令都是去连接这个服务而产生的一堆子进程</li></ol><p>可以通过 <code>ps -auxf</code> 查看：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206113904636.png" alt="image-20250206113904636"><figcaption aria-hidden="true">image-20250206113904636</figcaption></figure><p>我们可以查看对应进程的父子关系来验证：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206114542373.png" alt="image-20250206114542373"><figcaption aria-hidden="true">image-20250206114542373</figcaption></figure><p><code>sshd</code> 第一行的进程是 <code>sshd</code>服务本身，<code>sshd</code> 第二行的进程是 <code>ssh</code>客户端，远程连接的会话进程。后续的命令都是基于 957499这个进程生成的子进程，在 <code>bash</code>的第三行是用户登录解释器产生的 <code>bash</code> 进程， <code>id</code>是 957500，后续的命令又都是这个 <code>bash</code>进程生成的子进程。</p></li></ul><h2 id="孤儿进程">2. 孤儿进程</h2><p>父进程退出后（因为某些原因挂了），子进程由 <code>init</code> 或<code>systemd</code> 接管（被 1号进程接替，去管理这些孤儿进程的数据）。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/63b77cb276213111b4734938.png" alt="孤儿进程流程图模板_ProcessOn思维导图、流程图"><figcaption aria-hidden="true">孤儿进程流程图模板_ProcessOn思维导图、流程图</figcaption></figure><p>具体可以运行这段代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">child_process</span>():</span><br><span class="line">    <span class="comment"># 第一次输出，可能仍是父进程存在时</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Child process: PID = &#123;&#125;, Parent PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), os.getppid()))</span><br><span class="line">    <span class="comment"># 等待父进程退出（父进程突然退出后，孤儿进程会被 init 领养）</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># 父进程退出后再次输出，此时父进程 PID 应该变为 1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Child process after parent&#x27;s exit: PID = &#123;&#125;, Parent PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), os.getppid()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 父进程分支</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Parent process: PID = &#123;&#125;, Child PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), pid))</span><br><span class="line">        <span class="comment"># 突然退出，父进程立即结束</span></span><br><span class="line">        os._exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 子进程分支</span></span><br><span class="line">        child_process()</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206141429890.png" alt="image-20250206141429890"><figcaption aria-hidden="true">image-20250206141429890</figcaption></figure><p>流程讲解：</p><ol type="1"><li>程序调用 <code>os.fork()</code> 创建子进程。<ol type="1"><li>父进程中，<code>os.fork()</code> 返回子进程的 PID；</li><li>子进程中，返回值为 0。</li></ol></li><li>父进程打印自己的 PID 和子进程 PID 后，使用 <code>os._exit(0)</code>立即退出，使子进程成为孤儿进程。</li><li>子进程先打印初始时的父进程 PID，再等待 3秒（确保父进程已经退出），最后再次打印自己的 PID 和父进程PID。此时，由于父进程已退出，操作系统会将子进程的父进程设置为<code>init</code>（在大多数系统中，其 PID 为 1）。</li></ol><h2 id="僵尸进程">3. 僵尸进程</h2><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/GIqlONjnXBrkuRz4DXxSdr0WBeSmud5olIwsN9w7B3TRy6IBNgaqaRphuj4PB2194l89F9vjp6GHteXc3txRX5SDJMQVgN6m76YejCRl32TfGJQ.png" alt="僵尸进程（Zombie Process） – 常量笔记"><figcaption aria-hidden="true">僵尸进程（Zombie Process） –常量笔记</figcaption></figure><ul><li>进程退出后，内核保留其退出状态，等待父进程回收；</li><li>父进程若不调用 wait()，子进程则成为僵尸；</li><li>僵尸进程不会占用大量资源，但过多会耗尽系统进程表。</li></ul><p><strong>查看方式</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep <span class="string">&#x27; Z &#x27;</span></span><br></pre></td></tr></table></figure><p><strong>具体例子</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 父进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Parent process: PID = &#123;&#125;, Child PID = &#123;&#125; (child will become zombie)&quot;</span>.<span class="built_in">format</span>(os.getpid(), pid))</span><br><span class="line">        <span class="comment"># 父进程暂停 15 秒，在此期间子进程已退出但未被回收，处于僵尸状态</span></span><br><span class="line">        time.sleep(<span class="number">15</span>)</span><br><span class="line">        <span class="comment"># 最后回收僵尸进程</span></span><br><span class="line">        os.wait()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Zombie child has been reaped.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 子进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Child process: PID = &#123;&#125;, Parent PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), os.getppid()))</span><br><span class="line">        <span class="comment"># 子进程立即退出，进入僵尸状态（直到父进程调用 wait()）</span></span><br><span class="line">        os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>在调用 <code>os.fork()</code>后，实际上会产生两个独立的进程：一个是父进程，一个是子进程。这两个进程都会从<code>os.fork()</code>这一行开始继续执行接下来的代码，但它们各自拥有不同的返回值：</p><ul><li><strong>在父进程中</strong>：<code>os.fork()</code> 返回的是子进程的PID（一个正整数），因此条件 <code>if pid &gt; 0</code>为真，父进程会执行 if 分支的代码。</li><li><strong>在子进程中</strong>：<code>os.fork()</code> 返回 0，所以条件<code>if pid &gt; 0</code> 为假，子进程会执行 <code>else</code>分支的代码。<code>os.wait()</code>会使父进程等待任一子进程结束，并收集其退出状态（也称为回收僵尸进程）。当父进程执行到这行代码时，之前已经退出的子进程将被系统正式回收，其“僵尸状态”消失。</li></ul><p>这两个进程是并行运行的，它们共享同一段代码，但各自根据<code>os.fork()</code>返回的不同值来选择不同的执行路径。这样就可以同时看到父进程和子进程的输出，而它们的PID 值分别反映了各自的情况（父进程得到子进程的 PID，子进程得到 0）。</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206142957326.png" alt="image-20250206142957326"><figcaption aria-hidden="true">image-20250206142957326</figcaption></figure><p>上面的代码运行期间，我们可以在另一个窗口通过<code>ps aux | grep Z</code> 观察到子进程变成僵尸进程（状态为“Z”）：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206142932763.png" alt="image-20250206142932763"><figcaption aria-hidden="true">image-20250206142932763</figcaption></figure><h1 id="七挂载点的理解与实例详解">七、挂载点的理解与实例详解</h1><p>在 Linux中，整个文件系统是一个统一的目录树，所有的文件和目录都位于根目录<code>/</code> 下。挂载点（MountPoint）就是在这个目录树中预先创建的一个空目录，用于将其他存储设备（例如硬盘分区、USB驱动器、网络文件系统等）的文件系统“挂载”到这个目录上，从而将这些外部文件系统整合到主文件系统中，实现统一管理和访问。</p><h2 id="挂载点的基本概念">1. 挂载点的基本概念</h2><ul><li><p><strong>统一文件树</strong><br>Linux的设计理念是“一切皆文件”，整个系统都被构造为一个单一的目录树。无论是系统硬盘、外接存储设备，还是网络文件系统，最终都可以通过挂载点呈现在同一个目录结构中。</p></li><li><p><strong>挂载操作</strong><br>挂载就是把一个独立的文件系统连接到现有目录树的某个目录上，使得这个目录成为访问该文件系统的入口。挂载完成后，用户访问该目录时，实际上访问的是挂载的设备中的文件。</p></li><li><p><strong>卸载操作</strong><br>卸载（umount）则是将挂载的设备从目录树中移除。在卸载之前，必须确保没有进程在使用挂载点，否则卸载操作会失败。</p></li></ul><h2 id="常见的挂载点示例">2. 常见的挂载点示例</h2><ul><li><p><strong>根目录 (<code>/</code>)</strong><br>整个系统的根，所有挂载的文件系统最终都挂载在根目录下。例如，系统安装盘通常直接挂载在<code>/</code> 上。</p></li><li><p><strong>临时挂载目录 (<code>/mnt</code> 或<code>/media</code>)</strong><br>用于临时挂载外部设备。例如，当你插入一个 USB驱动器时，系统可能自动将其挂载到 <code>/media/username/USB_DRIVE</code>或你手动将其挂载到 <code>/mnt/usb</code>。</p></li><li><p><strong>自定义挂载点</strong><br>在服务器环境中，经常为不同用途创建专用挂载点，如 <code>/data</code>用于存储用户数据，<code>/backup</code>用于备份文件。这样不仅方便管理，还能根据设备性能合理分配任务（例如将高性能SSD 挂载在数据库目录下，而将大容量 HDD 用于存储日志文件）。</p></li></ul><h2 id="挂载命令与操作示例">3. 挂载命令与操作示例</h2><ul><li><p><strong>挂载设备</strong><br>使用 <code>mount</code> 命令将设备挂载到指定目录。例如，将设备<code>/dev/sdb1</code> 挂载到 <code>/mnt/data</code>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  mount /dev/sdb1 /mnt/data</span><br><span class="line"></span><br><span class="line">​挂载后，访问 /mnt/data 就相当于访问 /dev/sdb1 中的所有文件。</span><br><span class="line"></span><br><span class="line">* **查看当前挂载情况**</span><br><span class="line"></span><br><span class="line">  使用 `mount` 或 `findmnt` 查看当前所有挂载的设备及其挂载点：</span><br><span class="line"></span><br><span class="line">  ```bash</span><br><span class="line">  mount</span><br><span class="line">  findmnt</span><br></pre></td></tr></table></figure></p></li><li><p><strong>卸载设备</strong></p><p>使用 <code>umount</code> 命令卸载挂载的文件系统：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /mnt/data</span><br></pre></td></tr></table></figure><p>注意：在卸载前必须确保没有进程正在使用 /mnt/data。</p></li></ul><h2 id="挂载点在系统管理中的作用">4. 挂载点在系统管理中的作用</h2><ul><li><p><strong>数据整合</strong></p><p>挂载点允许管理员将不同物理设备的文件系统整合到一个统一的目录结构中，便于统一管理。例如，数据库文件可以挂载在一个专用分区（例如/var/lib/mysql），而用户数据则挂载在另一个分区（例如 /data）。</p></li><li><p><strong>性能优化</strong></p><p>将性能要求高的应用挂载到高性能设备上（如固态硬盘），而大容量但速度较慢的设备则用于存储归档数据，合理规划存储策略。</p></li><li><p><strong>备份与恢复</strong></p><p>利用挂载点，可以将外部备份设备挂载到系统中，实现数据的备份与恢复，而无需改变系统的目录结构。</p></li></ul><h1 id="八综合应用">八、综合应用</h1><p>Nginx 日志非常重要，可以帮助我们查看是否有一些异常的 IP在进行非授权的访问，例如访问 admin或者试图访问一些敏感的后台管理文件夹：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206233125034.png" alt="image-20250206233125034"><figcaption aria-hidden="true">image-20250206233125034</figcaption></figure><p>误删除 nginx 日志文件夹后恢复操作：</p><figure><img src="/Linux-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206233055035.png" alt="image-20250206233055035"><figcaption aria-hidden="true">image-20250206233055035</figcaption></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;线上排障时，最关键的能力不是“会背命令”，而是能把现象快速映射到资源与进程：CPU
是不是被打满、内存是不是被 cache 吃掉、磁盘 I/O
在不在等、到底是哪一个进程/文件/端口在拖慢系统。本文从进程/线程与父子关系的基本概念出发，解释
Linux 的资源视角（尤其是 buffer/cache
的含义），然后系统梳理一套常用监控与定位工具链（&lt;code&gt;top/htop/ps/pstree/lsof&lt;/code&gt;、端口/网络、I/O、负载与压力测试）。接着补齐“把进程控住”的操作：信号与后台任务、&lt;code&gt;nice/renice&lt;/code&gt;
优先级、孤儿/僵尸进程的成因与处理；最后用挂载点的例子把“资源视角”落到文件系统层面，方便你把一次完整排障流程跑通。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 软件包管理</title>
    <link href="https://chenk.top/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.327Z</updated>
    
    <content type="html"><![CDATA[<p>Package management is more than “install / upgrade / remove”: whatmatters in practice is understanding what a package actually drops ontoyour system (binaries, config, shared libraries, service units) and howdifferent toolchains handle dependencies and versions (e.g.,<code>dpkg/apt</code> vs <code>rpm/yum/dnf</code>). This post walksthrough the core concepts and the most common workflows you’ll use onreal servers, including mirror setup (e.g., Aliyun mirrors) and quickverification steps. It also extends beyond “just use the packagemanager” by covering two production-grade escape hatches: building fromsource (Nginx as an example) and setting up portable binarydistributions (Java as an example), so you’re not stuck whenrepositories or versions don’t match your constraints.</p><span id="more"></span><h1 id="一软件包的概念与管理">一、软件包的概念与管理</h1><h2 id="软件包组成">1. 软件包组成</h2><p>软件包是将程序、库文件、配置文件以及文档等打包在一起的文件，方便安装、升级和卸载。软件包能自动处理依赖关系，简化软件管理。一个标准的软件包通常包括以下内容：</p><h3 id="二进制命令可执行文件">二进制命令（可执行文件）</h3><p>经过编译的程序源代码，生成的可执行二进制文件。例如，在 Linux系统中，<code>/usr/bin/</code>目录下的可执行文件通常来自安装的软件包，如<code>vim</code>、<code>gcc</code> 等。</p><h3 id="配置文件configuration-files">配置文件（ConfigurationFiles）</h3><p>存放应用程序的默认配置，通常位于 <code>/etc/</code>目录下。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/nginx.conf  <span class="comment"># Nginx 的配置文件</span></span><br><span class="line">/etc/mysql/my.cnf    <span class="comment"># MySQL 的配置文件</span></span><br></pre></td></tr></table></figure><h3 id="数据文件data-files">数据文件（Data Files）</h3><p>应用程序所需的数据，如数据库文件、默认资源等。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/mysql/   <span class="comment"># MySQL 数据库存放目录</span></span><br><span class="line">/var/www/html/    <span class="comment"># Web 服务器默认站点目录</span></span><br></pre></td></tr></table></figure><h3 id="依赖库shared-libraries">依赖库（Shared Libraries）</h3><p>共享库是可执行文件运行时依赖的动态链接库，通常存放在<code>/usr/lib/</code> 或 <code>/lib/</code> 目录下。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/libssl.so</span><br><span class="line">/lib/x86_64-linux-gnu/libc.so.6</span><br></pre></td></tr></table></figure><p><strong>（5）文档（Documentation）</strong></p><p>软件的说明文档、手册页、版权声明等，通常存放在<code>/usr/share/doc/</code> 目录。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/doc/nginx/README</span><br><span class="line">/usr/share/man/man1/nginx.1.gz</span><br></pre></td></tr></table></figure><h2 id="linux-软件包">2. Linux 软件包</h2><h3 id="软件包格式对比">软件包格式对比</h3><p>Linux 发行版不同，软件包的格式也有所不同。主要分为以下几类：</p><table><thead><tr><th><strong>发行版</strong></th><th><strong>软件包格式</strong></th><th><strong>包管理工具</strong></th></tr></thead><tbody><tr><td>Debian、Ubuntu</td><td>.deb</td><td>dpkg、apt</td></tr><tr><td>Red Hat、CentOS、Fedora</td><td>.rpm</td><td>rpm、yum、dnf</td></tr><tr><td>Arch Linux</td><td>.tar.xz</td><td>pacman</td></tr><tr><td>Gentoo</td><td>源码包</td><td>portage</td></tr><tr><td>macOS</td><td>.pkg</td><td>brew</td></tr></tbody></table><h3 id="常见操作示例">常见操作示例</h3><p>下面主要介绍 RPM 包的常见操作，RPM（Red Hat Package Manager）用于 RedHat/CentOS 等系统。常见操作包括安装、升级、卸载和查询软件包信息，而 Yum是基于 RPM 包管理的工具。Ubuntu 默认使用 DEB包管理（dpkg/apt），但在某些情况下可能会遇到 RPM 包，使用工具如<code>alien</code> 可将 RPM 包转换为 DEB包进行安装。一些使用示例如下：</p><p><strong>将 RPM 包转换为 DEB 包</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install alien</span><br><span class="line">sudo alien -d package.rpm</span><br><span class="line">sudo dpkg -i package.deb</span><br></pre></td></tr></table></figure><p>RPM 依赖冲突解决：当安装 RPM包遇到依赖问题时，需要手动安装缺少的依赖或使用工具解决依赖冲突。转换为DEB 包后，可借助 apt 的自动依赖解析功能。</p><p><strong>常用 RPM 命令</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh package.rpm    # 安装 RPM 包</span><br><span class="line">rpm -Uvh package.rpm    # 升级 RPM 包</span><br><span class="line">rpm -e packagename      # 卸载软件包</span><br><span class="line">rpm -qa                 # 列出所有已安装 RPM 包</span><br><span class="line">rpm -qi packagename     # 查询某个包的信息</span><br><span class="line">rpm -qf /path/to/file   # 查找某个文件所属的 RPM 包</span><br></pre></td></tr></table></figure><p><strong>光盘获取 RPM包</strong>：如果软件包存放在光盘上，需要先挂载光盘，然后使用 RPM命令进行安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mount /dev/cdrom /mnt</span><br><span class="line"><span class="built_in">cd</span> /mnt</span><br><span class="line">sudo rpm -ivh package.rpm</span><br></pre></td></tr></table></figure><p><strong><code>yum</code> 安装包</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装软件包：</span></span><br><span class="line">yum install packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载软件包：</span></span><br><span class="line">yum remove packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索软件包：</span></span><br><span class="line">yum search keyword</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看包信息：</span></span><br><span class="line">yum info packagename</span><br></pre></td></tr></table></figure><p><code>apt</code> 与 <code>yum</code>的操作逻辑相似，但底层依赖管理和软件包格式不同。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新软件源：</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装软件包：</span></span><br><span class="line">sudo apt install packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载软件包：</span></span><br><span class="line">sudo apt remove packagename</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索软件包：</span></span><br><span class="line">apt search keyword</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看包信息：</span></span><br><span class="line">apt show packagename</span><br></pre></td></tr></table></figure><h3 id="dpkg-vs-rpm-命令对比表"><code>dpkg</code> vs <code>rpm</code>命令对比表</h3><table style="width:100%;"><colgroup><col style="width: 29%"><col style="width: 35%"><col style="width: 34%"></colgroup><thead><tr><th><strong>操作</strong></th><th><strong>Debian/Ubuntu (<code>dpkg</code>)</strong></th><th><strong>RHEL/CentOS/Fedora (<code>rpm</code>)</strong></th></tr></thead><tbody><tr><td><strong>安装软件包</strong></td><td><code>dpkg -i package.deb</code></td><td><code>rpm -i package.rpm</code></td></tr><tr><td><strong>升级软件包</strong></td><td><code>dpkg -i package.deb</code></td><td><code>rpm -U package.rpm</code></td></tr><tr><td><strong>删除软件包</strong></td><td><code>dpkg -r package</code></td><td><code>rpm -e package</code></td></tr><tr><td><strong>强制删除（含配置）</strong></td><td><code>dpkg --purge package</code></td><td><code>rpm -e --noscripts package</code></td></tr><tr><td><strong>查询已安装软件包</strong></td><td><code>dpkg -l</code></td><td><code>rpm -qa</code></td></tr><tr><td><strong>查询特定软件包</strong></td><td><code>dpkg -l | grep package</code></td><td><code>rpm -q package</code></td></tr><tr><td><strong>查看文件所属软件包</strong></td><td><code>dpkg -S /path/to/file</code></td><td><code>rpm -qf /path/to/file</code></td></tr><tr><td><strong>列出软件包安装的文件</strong></td><td><code>dpkg -L package</code></td><td><code>rpm -ql package</code></td></tr><tr><td><strong>检查软件包信息</strong></td><td><code>dpkg -I package.deb</code></td><td><code>rpm -qip package.rpm</code></td></tr><tr><td><strong>检查软件包依赖</strong></td><td><code>dpkg -I package.deb | grep Depends</code></td><td><code>rpm -qpR package.rpm</code></td></tr><tr><td><strong>列出某软件包的依赖</strong></td><td><code>dpkg -L package</code></td><td><code>rpm -qR package</code></td></tr><tr><td><strong>检查软件包是否已安装</strong></td><td><code>dpkg -s package</code></td><td><code>rpm -q package</code></td></tr><tr><td><strong>验证已安装的软件包</strong></td><td><code>dpkg --verify package</code></td><td><code>rpm -V package</code></td></tr><tr><td><strong>提取 <code>.deb</code> 或 <code>.rpm</code>文件</strong></td><td><code>dpkg -x package.deb /target/dir</code></td><td><code>rpm2cpio package.rpm | cpio -idmv</code></td></tr></tbody></table><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250210215953126.png" alt="image-20250210215953126"><figcaption aria-hidden="true">image-20250210215953126</figcaption></figure><h2 id="替换为阿里云源">3. 替换为阿里云源</h2><h3 id="备份原始源">📌 备份原始源</h3><p>在修改软件源之前，建议先备份原来的 sources.list 以防万一：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br></pre></td></tr></table></figure><p>这样如果有问题，你可以恢复：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mv</span> /etc/apt/sources.list.bak /etc/apt/sources.list</span><br></pre></td></tr></table></figure><h3 id="替换-sources.list-为阿里云源">📌 替换 sources.list为阿里云源</h3><p><strong>✅ 方法 1：手动编辑</strong></p><p>使用 <code>vim</code> 或 <code>nano</code> 编辑 sources.list：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>删除原内容，替换为以下 <strong>阿里云镜像源</strong>（适用于<strong>Ubuntu 22.04、20.04、18.04</strong>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认官方源</span></span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line">deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源码仓库（可选）</span></span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse</span><br><span class="line">deb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure><p>要注意 <code>bionic</code> 适用于 <strong>Ubuntu18.04</strong>，并且注意结合系统架构。</p><p><strong>✅ 方法 2：自动替换</strong></p><p>如果你不想手动编辑，可以直接运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*archive.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br><span class="line">sudo sed -i <span class="string">&#x27;s|http://.*security.ubuntu.com|http://mirrors.aliyun.com|g&#x27;</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><h3 id="更新软件仓库">📌 更新软件仓库</h3><p>执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade -y</span><br></pre></td></tr></table></figure><p>这将使用新的 <strong>阿里云镜像源</strong> 下载最新的软件包。</p><h3 id="确认修改成功">📌 确认修改成功</h3><p>你可以运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><p>如果输出包含 mirrors.aliyun.com，说明修改成功。</p><p>然后尝试安装软件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install vim -y</span><br></pre></td></tr></table></figure><p>如果安装速度明显变快，就说明 <strong>阿里云源生效</strong> 了！🚀</p><h1 id="二程序编译与解释">二、程序编译与解释</h1><ul><li><strong>编译型语言</strong><ul><li><strong>原理</strong>：程序在运行前经过编译器转换为机器语言，再由操作系统执行。<br></li><li><strong>优点</strong>：执行效率高；代码优化较好；通常适合需要高性能计算的场景。<br></li><li><strong>缺点</strong>：编译过程耗时；调试过程较复杂。<br></li><li><strong>实例</strong>：使用 gcc 编译 C 程序： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o hello hello.c</span><br><span class="line">./hello</span><br></pre></td></tr></table></figure></li></ul></li><li><strong>解释型语言</strong><ul><li><strong>原理</strong>：源代码在运行时由解释器逐行解析执行。<br></li><li><strong>优点</strong>：开发周期短，调试方便；跨平台性好。<br></li><li><strong>缺点</strong>：运行速度较慢；需要解释器支持。<br></li><li><strong>实例</strong>：使用 Python 执行脚本： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 hello.py</span><br></pre></td></tr></table></figure></li></ul></li></ul><p>不同语言的应用范围不一样：</p><ul><li>系统级开发：<ul><li>C/C++：httpd、nginx</li><li>golang：docker</li></ul></li><li>应用级开发：<ul><li>Java：Hadoop、Hbase</li><li>Python：openstack</li><li>Pert</li><li>Ruby</li><li>PHP</li></ul></li></ul><p>我们以 Golang 和 Python为例，比较这两种语言在性能、开发效率和生态系统方面的差异：</p><ul><li><p><strong>Golang (Go)</strong></p><ul><li><p><strong>特点</strong>：编译型语言，性能高、并发编程原生支持，适用于网络服务和分布式系统开发。<br></p></li><li><p><strong>缺点</strong>：语法相对严格，生态系统虽然不断发展但相对Python 略小。<br></p></li><li><p><strong>示例</strong>：一个简单的 Go 程序： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &#x27;EOF&#x27; &gt; hello.go</span><br><span class="line">package main</span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line">func main() &#123;</span><br><span class="line">    fmt.Println(&quot;Hello, Golang!&quot;)</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">go run hello.go</span><br></pre></td></tr></table></figure></p><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208153904973.png" alt="image-20250208153904973"><figcaption aria-hidden="true">image-20250208153904973</figcaption></figure><p><code>build</code> 之后就将源码以及相关依赖打包进文件<code>hello</code> 了，一次编译，到处运行（这也是 docker的理念），如果不编译就一定要机器上有对应的编译器。</p></li></ul></li><li><p><strong>Python</strong></p><ul><li><p><strong>特点</strong>：语法简洁、开发速度快、拥有丰富的第三方库，适用于数据分析、Web开发和自动化脚本。</p></li><li><p><strong>缺点</strong>：运行速度相对较慢，不适合极端高性能计算。</p></li><li><p><strong>示例</strong>：一个简单的 Python 脚本：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt; &#x27;EOF&#x27; &gt; hello.py</span><br><span class="line">#!/usr/bin/env python3</span><br><span class="line">print(&quot;Hello, Python!&quot;)</span><br><span class="line">EOF</span><br><span class="line">python3 hello.py</span><br></pre></td></tr></table></figure></li></ul></li></ul><h1 id="三源码编译与二进制配置">三、源码编译与二进制配置</h1><p>在 Linux 中，软件可以通过源码编译或二进制免安装方式进行部署。</p><ul><li><strong>二进制包</strong>：已经编译好的可执行文件及其依赖文件（如Ubuntu 下的 DEB 包）。安装快速、方便，但可定制性较低。<br></li><li><strong>源码包</strong>：包含程序的源代码，需要经过编译生成可执行文件。提供更高的定制化和优化空间，但安装过程较复杂。</li></ul><h2 id="源码编译以淘宝-nginx-为例">1. 源码编译（以淘宝 Nginx 为例）</h2><p><strong>步骤</strong>：</p><ol type="1"><li><p>下载源码：从淘宝镜像或官方源下载 Nginx源码包，可以复制链接地址后去虚拟机 <code>wget</code></p><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235532884.png" alt="image-20250208235532884"><figcaption aria-hidden="true">image-20250208235532884</figcaption></figure></li><li><p>解压源码包： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf nginx-1.xx.tar.gz</span><br></pre></td></tr></table></figure></p></li><li><p>配置编译参数： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nginx-1.xx</span><br><span class="line">./configure --prefix=/usr/local/nginx --with-http_ssl_module</span><br></pre></td></tr></table></figure></p><p>逐步将需要的包都安装完后，将会返回如下结果说明成功了：</p><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235125749.png" alt="image-20250208235125749"><figcaption aria-hidden="true">image-20250208235125749</figcaption></figure><p>查看当前目录会发现多了个 <code>Makefile</code>：</p><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235736672.png" alt="image-20250208235736672"><figcaption aria-hidden="true">image-20250208235736672</figcaption></figure><p>只有 <code>make install</code> 成功后，才会生成指定的<code>nginx</code> 路径。</p></li><li><p>编译并安装： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">## 或者直接</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>经过一长串的编译，结果如下：</p><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250208235927988.png" alt="image-20250208235927988"><figcaption aria-hidden="true">image-20250208235927988</figcaption></figure></li><li><p>查看安装的路径，会发现包含这四个文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line">conf  html  logs  sbin</span><br></pre></td></tr></table></figure><p>分别对应配置文件、前端 HTML页面、日志文件和可执行的二进制文件。</p></li><li><p>启动 Tengine：</p><p>在 <code>nginx.conf</code> 文件里配置完端口号启动<code>./sbin/nginx</code>：</p><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250209001323246.png" alt="image-20250209001323246"><figcaption aria-hidden="true">image-20250209001323246</figcaption></figure></li></ol><p>编译过程允许你自定义安装路径和模块，适用于需要特定功能或优化的场景。</p><h2 id="二进制免安装配置以-java-为例">2. 二进制免安装配置（以 Java为例）</h2><p><strong>步骤</strong>：</p><ol type="1"><li><p><a class="link" href="https://www.java.com/en/download/manual.jsp">下载 Java二进制包<i class="fas fa-external-link-alt"></i></a>（通常为压缩文件）。</p><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250209004010589.png" alt="image-20250209004010589"><figcaption aria-hidden="true">image-20250209004010589</figcaption></figure></li><li><p>解压文件到指定目录（或者使用SFTP进行主机和虚拟机之间传输）：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf jdk-xx_linux-x64_bin.tar.gz -C /opt</span><br></pre></td></tr></table></figure></p></li><li><p>配置环境变量： 编辑 <code>~/.bashrc</code> 添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/opt/jdk-xx</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BD%AF%E4%BB%B6%E5%8C%85%E7%AE%A1%E7%90%86/image-20250209004248120.png" alt="image-20250209004248120"><figcaption aria-hidden="true">image-20250209004248120</figcaption></figure></li><li><p>使配置生效： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure></p></li></ol><p>这种方式无需安装程序，直接解压配置，便于快速部署和版本切换。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Package management is more than “install / upgrade / remove”: what
matters in practice is understanding what a package actually drops onto
your system (binaries, config, shared libraries, service units) and how
different toolchains handle dependencies and versions (e.g.,
&lt;code&gt;dpkg/apt&lt;/code&gt; vs &lt;code&gt;rpm/yum/dnf&lt;/code&gt;). This post walks
through the core concepts and the most common workflows you’ll use on
real servers, including mirror setup (e.g., Aliyun mirrors) and quick
verification steps. It also extends beyond “just use the package
manager” by covering two production-grade escape hatches: building from
source (Nginx as an example) and setting up portable binary
distributions (Java as an example), so you’re not stuck when
repositories or versions don’t match your constraints.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 进程与资源管理</title>
    <link href="https://chenk.top/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/</id>
    <published>2025-02-07T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.326Z</updated>
    
    <content type="html"><![CDATA[<p>Effective Linux troubleshooting is about turning symptoms into aconcrete resource story: which process is consuming CPU, where memory isgoing (and what “buffer/cache” really means), whether you’re blocked ondisk I/O, and which files or ports are involved. This post builds thatmental model from the basics (process vs. program vs. thread,parent/child relationships), then walks through a practical toolbox(<code>top/htop/ps/pstree/lsof</code>, network and I/O inspection, loadand stress testing). It also covers “control levers” you’ll use inproduction—signals, background jobs, <code>nice/renice</code>, anddiagnosing orphan/zombie processes—so you can both locate and fix issuesinstead of just observing them.</p><span id="more"></span><h1 id="一进程与程序管理">一、进程与程序管理</h1><h2 id="进程与程序之间的关系">1. 进程与程序之间的关系</h2><p>在 Linux中，<strong>程序</strong>是存储在硬盘上的静态可执行文件，而<strong>进程</strong>是程序加载到内存中后运行的实例。每次运行程序时，系统都会创建一个或多个进程，每个进程拥有独立的内存空间、进程ID（PID）、父进程ID（PPID）以及各自的运行环境。进程是动态存在的，是源代码和数据的结合体，是一个资源单位，而程序则是静态存储的代码集合。</p><p>线程则是 CPU运行的最小工作单位，例如一个网易云音乐进程可能包含两个线程，一个是下载音乐，一个是播放歌曲。因此进程可以理解为工地上指挥干活的包工头，线程是具体干活的工人。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/program-process-task-thread_1589445704853.jpeg" alt="程序、进程、线程和任务之间关系| iBit程序猿"><figcaption aria-hidden="true">程序、进程、线程和任务之间关系|iBit程序猿</figcaption></figure><p><strong>例子</strong>：<br>- 当你在 Ubuntu 中运行 <code>vim myfile.txt</code> 时，<code>vim</code>程序从硬盘加载到内存中，产生一个进程，该进程负责编辑<code>myfile.txt</code>。<br>-同一个程序可以同时启动多个进程，例如在浏览器中打开多个标签页时，每个标签页可能对应一个独立的进程或线程。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 示例：启动 vim 进程并查看 PID</span></span><br><span class="line">vim myfile.txt &amp;</span><br><span class="line">ps -ef | grep vim</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206003356484.png" alt="image-20250206003356484"><figcaption aria-hidden="true">image-20250206003356484</figcaption></figure><h2 id="进程的特点">2. 进程的特点</h2><h3 id="进程的独立性与并发性">进程的独立性与并发性</h3><ul><li><strong>独立性</strong>：每个进程都有自己的内存空间和系统资源，彼此相互隔离。</li><li><strong>并发性</strong>：操作系统允许多个进程同时运行，通过多任务调度实现并发处理。</li><li><strong>动态性</strong>：进程不断创建、执行、终止，状态实时变化。【操作系统的运行就是不断的创建进程和销毁进程】</li><li><strong>父子关系</strong>：进程由父进程通过 <code>fork()</code>调用创建，形成父子结构；父进程的 PPID 字段指明了其创建者。</li><li><strong>调度性</strong>：操作系统使用调度算法（如时间片轮转、优先级调度）来决定进程的执行顺序。</li></ul><h3 id="示例">示例</h3><ul><li>使用 <code>ps -ef</code> 查看进程时，可以看到每个进程的 PID 和PPID，帮助理解父子进程关系。</li><li>父进程退出后，子进程成为孤儿进程，由 <code>init</code> 或<code>systemd</code> 接管。</li><li>当子进程结束但父进程未调用 <code>wait()</code>回收时，会产生僵尸进程，其信息仍保留在进程表中。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看进程父子关系示例</span></span><br><span class="line">ps -ef | grep bash</span><br><span class="line">pstree -p</span><br></pre></td></tr></table></figure><h1 id="二linux-系统资源管理概述">二、Linux 系统资源管理概述</h1><p>运维工作围绕硬件和软件资源展开，合理管理这些资源可确保系统高效稳定运行。下面介绍主要硬件与软件资源及常用监控工具。</p><h2 id="硬件资源管理">1. 硬件资源管理</h2><p><strong>磁盘资源</strong></p><ul><li><p><strong>容量</strong>：硬盘或 SSD 提供的总存储空间。</p></li><li><p><strong>读写性能</strong>：</p><ul><li><strong>机械硬盘（HDD）</strong>：容量大、价格低、速度较慢。</li><li><strong>固态硬盘（SSD）</strong>：速度快、价格高、容量相对较小。</li></ul></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">df</span> -h       <span class="comment"># 查看磁盘使用情况</span></span><br><span class="line">lsblk       <span class="comment"># 列出块设备及挂载点</span></span><br><span class="line">iostat      <span class="comment"># 监控磁盘 I/O 性能</span></span><br></pre></td></tr></table></figure></li></ul><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206111508163.png" alt="image-20250206111508163"><figcaption aria-hidden="true">image-20250206111508163</figcaption></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206111526729.png" alt="image-20250206111526729"><figcaption aria-hidden="true">image-20250206111526729</figcaption></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206111544412.png" alt="image-20250206111544412"><figcaption aria-hidden="true">image-20250206111544412</figcaption></figure><ul><li>操作系统 0号进程：0号进程会创建出一堆内核级进程，提供操作系统运行</li><li>用户级别 1 号进程：<ul><li>基于 1 号进程创建子进程 <code>sshd</code> 服务</li><li>基于 <code>sshd</code> 服务产生 <code>ssh</code> 客户端连接进程</li><li>基于 <code>ssh</code> 进程产生用户 <code>bash</code> 进程</li><li>基于 <code>bash</code> 进程产生用户执行的其他进程</li></ul></li></ul><p><strong>内存资源</strong></p><ul><li><p><strong>总内存与剩余内存</strong>：反映系统当前内存占用情况。</p></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free -hfree -h     <span class="comment"># 查看内存和交换空间使用情况</span></span><br><span class="line">vmstat      <span class="comment"># 查看虚拟内存统计信息</span></span><br></pre></td></tr></table></figure></li></ul><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206153209092.png" alt="image-20250206153209092"><figcaption aria-hidden="true">image-20250206153209092</figcaption></figure><p><strong>CPU 资源</strong></p><ul><li><p><strong>核心数与负载</strong>：监控各进程对 CPU的占用情况和系统整体负载。</p></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line">htop</span><br><span class="line">mpstat</span><br></pre></td></tr></table></figure></li></ul><p><strong>网络资源</strong></p><ul><li><p><strong>带宽、吞吐量与延迟</strong>：监控网络接口的数据传输速率和状态。</p></li><li><p><strong>常用命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iftop       <span class="comment"># 实时监控网络流量</span></span><br><span class="line">ip -s <span class="built_in">link</span>  <span class="comment"># 查看接口统计信息</span></span><br></pre></td></tr></table></figure></li></ul><h2 id="软件资源与服务管理">2. 软件资源与服务管理</h2><ul><li><strong>系统服务</strong>：如 <code>sshd</code>, <code>crond</code>,<code>ntpd</code> 等，通过 <code>systemctl</code> 管理。</li><li><strong>日志管理</strong>：利用 <code>rsyslog</code> 或<code>journalctl</code> 分析系统和应用日志。</li><li><strong>计划任务</strong>：使用 <code>crontab</code>配置定时任务，实现自动化运维。</li></ul><p><strong>例子</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl status sshd</span><br><span class="line">systemctl restart ntpd</span><br><span class="line">crontab -e</span><br></pre></td></tr></table></figure><h2 id="buffer-和-cache-讲解">3. Buffer 和 Cache 讲解</h2><p>Linux 系统将内存划分为多个区域，其中 Buffer 和 Cache是两个非常重要的区域。理解这两个概念有助于更好地优化系统性能和排查问题。</p><h3 id="缓存与性能">缓存与性能</h3><ol type="1"><li><strong>高效的内存使用</strong>：内存中的 Buffer 和 Cache提供了数据的快速访问通道。当程序需要读取文件时，Linux 会首先检查 Cache中是否有该文件的数据，如果有，直接从内存中读取，速度非常快；如果没有，则从磁盘读取并缓存到内存。</li><li><strong>提升磁盘 I/O 性能</strong>：Buffer 和 Cache 缓存使得磁盘 I/O变得更加高效，减少了磁盘的访问次数，提高了系统性能。</li></ol><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/maxresdefault.jpg" alt="Buffer Cache"><figcaption aria-hidden="true">Buffer Cache</figcaption></figure><h3 id="buffer写入数据时加速">Buffer（写入数据时加速）</h3><p><strong>定义</strong>：Buffer是操作系统用于存储即将写入磁盘的数据的内存区域。当程序要写入文件时，数据首先会被存储在内存中的Buffer 中，等到合适的时机再分批次写入磁盘。没有 buffer的时候会产生大量的零碎文件，不断的把碎片文件写如此盘，太慢了。</p><p><strong>作用</strong>：它减少了程序直接与磁盘交互的次数，从而提高了I/O 性能。</p><h3 id="cache读取数据时加速">Cache（读取数据时加速）</h3><p><strong>定义</strong>：Cache是用于存储已经读取过的数据，目的是加速后续访问。Cache保存了频繁访问的磁盘数据，以减少磁盘 I/O 操作，提高数据读取速度。</p><p><strong>作用</strong>：缓存是内存中高速存取的数据区域，频繁访问的数据会被缓存在内存中，而不是每次都去磁盘读取。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/2478745-20220518204225587-325292210.png" alt="buff和cached解析- 屯子里唯一的架构师- 博客园"><figcaption aria-hidden="true">buff和cached解析- 屯子里唯一的架构师-博客园</figcaption></figure><h1 id="三进程监控工具详解">三、进程监控工具详解</h1><h2 id="使用-top-动态查看进程信息">1. 使用 <code>top</code>动态查看进程信息</h2><p><code>top</code> 提供实时进程信息，显示CPU、内存使用率、运行时间、命令等信息。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150129592.png" alt="image-20250206150129592"><figcaption aria-hidden="true">image-20250206150129592</figcaption></figure><p>第一行的 <code>load average</code>里，CPU是几核的，数字越接近几压力就越大，例如CPU是4核的，数字越接近4压力就越大</p><p><strong>常用快捷键</strong>：</p><ul><li>P：按 CPU 占用排序</li><li>M：按内存占用排序</li><li>k：输入 PID 发送信号终止进程</li><li>q：退出 top 界面</li></ul><p><strong>补充（glances）</strong>：综合监控工具，实时展示系统各项指标。这个工具是基于Python开发的，可以用Python去改造，同时还提供了Web可视化页面，也就是这个程序部署在云上，可以以Web的形式展示系统资源。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150908037.png" alt="image-20250206150908037"><figcaption aria-hidden="true">image-20250206150908037</figcaption></figure><h2 id="使用-htop-增强监控体验">2. 使用 <code>htop</code>增强监控体验</h2><p><code>htop</code> 是 <code>top</code>的增强版，具有友好的彩色界面和交互式操作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">sudo apt install htop</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">htop</span><br></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>支持鼠标操作</li><li>显示树状进程视图</li><li>可直接选择并终止进程</li></ul><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150847590.png" alt="image-20250206150847590"><figcaption aria-hidden="true">image-20250206150847590</figcaption></figure><h2 id="使用-ps-静态查看进程信息">3. 使用 <code>ps</code>静态查看进程信息</h2><p>ps 命令提供当前进程快照信息，可通过不同选项显示详细内容。</p><p><strong>常用用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206134925579.png" alt="image-20250206134925579"><figcaption aria-hidden="true">image-20250206134925579</figcaption></figure><p><code>ps</code>看到的进程名字，如果带有中括号，那就是Linux内核自动生成的进程，如果没有中括号（第一行），就是发行版系统，用户生成的各种进程。也就是说，Linux是一个开源内核，而 Ubuntu 则是基于 Linux 内核构建的一个 Linux发行版。</p><ul><li><strong>Linux 内核</strong>：Linux 内核是由 Linus Torvalds 在 1991年首次发布的，它是操作系统的核心，负责硬件管理、内存管理、进程调度、文件系统等基本功能。内核本身不包含用户界面或应用程序，它只是提供了系统资源的抽象层和基本服务。</li><li><strong>Linux 发行版（Distribution）</strong>：Linux 发行版是在Linux内核的基础上，整合了大量软件包、工具和应用程序，形成一个完整的操作系统。发行版会添加图形界面、命令行工具、安装程序和各种预配置的软件，使得普通用户也能方便地使用Linux 系统。Ubuntu 就是众多 Linux发行版之一，它以用户友好、易于安装和良好的社区支持而著称。</li></ul><p>简单来说，Ubuntu 使用 Linux内核，并在其基础上整合了各种软件包和工具，构成一个完整的操作系统。其他知名的发行版还有Debian、Fedora、CentOS 等，它们都共享同一个 Linux内核，但在软件选择、配置和用户体验上有所不同。</p><p><code>ps -ef</code> 是 Unix 风格的命令，有短横线，而<code>ps auf</code> 是 BSD 风格的命令，没有短横线。Unix风格的具体命令格式和其他参数如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef -p &lt;pid_list&gt; -C &lt;<span class="built_in">command</span>&gt; -U &lt;user&gt;</span><br></pre></td></tr></table></figure><ul><li><strong>-e</strong>：显示所有进程（等同于–A），即不限制进程所属的终端、用户等。</li><li><strong>-f</strong>：使用全格式输出（Full-format），会显示额外的信息，例如UID、PID、PPID、C（CPU 占用）、STIME、TTY、TIME、CMD等。输出内容更详细。</li><li><strong>-p</strong>：根据进程 ID（PID）过滤显示，仅列出指定 PID的进程。使用时需要在后面跟上一个或多个 PID 列表，例如<code>-p 1234,5678</code>。</li><li><strong>-C</strong>：根据命令名过滤显示，仅列出指定命令名称对应的进程。例如-C sshd 会显示所有名称为 sshd 的进程。</li><li><strong>-U</strong>：根据实际用户（Realuser）过滤显示，仅显示指定用户拥有的进程。例如 <code>-U root</code>会显示 <code>root</code> 用户的所有进程。</li></ul><p>BSD 风格的命令的各个选项的含义如下：</p><ul><li><strong>a</strong>：显示所有与终端相关的进程，不仅限于当前用户的进程。</li><li><strong>x</strong>：显示所有进程，包括那些没有控制终端（TTY）的进程（例如守护进程或后台进程）。</li><li><strong>u</strong>：以用户导向格式显示进程信息，输出中会包含<code>USER、PID、%CPU、%MEM、VSZ、RSS、TTY、STAT、START、TIME、COMMAND</code>等列，更加直观易读。</li><li><strong>f</strong>：以树状结构（forest）的形式ps显示进程之间的父子关系，有助于理解进程的继承关系。</li><li><strong>o</strong>：允许用户自定义输出格式，可以指定输出哪些列。如果后面没有跟参数，则使用默认格式；通常可以写成<code>ps axu -o pid,ppid,cmd</code> 这种形式来指定需要显示的列。</li><li><strong>k</strong>：用来指定排序关键字，控制输出结果的排序方式。例如可以按PID、CPU占用或内存等排序。如果后面没有跟具体参数，则通常使用默认排序方式。</li></ul><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206150048998.png" alt="image-20250206150048998"><figcaption aria-hidden="true">image-20250206150048998</figcaption></figure><p><code>ps</code> 可以去掉 <code>grep</code> 显示的那个进程，方法是使用<code>-v</code> 参数（结果取反）：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206152136083.png" alt="image-20250206152136083"><figcaption aria-hidden="true">image-20250206152136083</figcaption></figure><h2 id="使用-pstree-显示进程树">4. 使用 <code>pstree</code>显示进程树</h2><p><code>pstree</code>以树状结构展示进程父子关系，帮助理解进程层级。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree -p</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206151051241.png" alt="image-20250206151051241"><figcaption aria-hidden="true">image-20250206151051241</figcaption></figure><h2 id="使用-pidof-查找进程-pid">5. 使用 <code>pidof</code> 查找进程PID</h2><p><code>pidof</code> 能查找指定进程的 PID，适合脚本自动化管理。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行 pidof sshd 返回所有 SSH 守护进程的 PID。</span></span><br><span class="line">pidof sshd</span><br></pre></td></tr></table></figure><h2 id="使用-lsof-查看打开的文件">6. 使用 <code>lsof</code>查看打开的文件</h2><p><code>lsof</code>（List OpenFiles）用于列出系统中所有打开的文件，包括常见的网络连接、设备和进程占用的文件。以下是一些常用参数及其说明：</p><ul><li><p><strong>-a</strong><br>与其他选项一起使用，表示“与”关系（AND），只显示同时满足所有条件的结果。</p></li><li><p><strong>-c <command></strong><br>按进程名称过滤，显示指定命令名的进程所打开的文件。<br><em>示例：</em> <code>lsof -c ssh</code></p></li><li><p><strong>-d <fd></fd></strong><br>按文件描述符过滤，显示特定文件描述符（如<code>cwd</code>、<code>txt</code>、<code>mem</code>、<code>1</code>、<code>2</code>等）的打开文件。<br><em>示例：</em> <code>lsof -d cwd</code></p></li><li><p><strong>-i [protocol]<span class="citation" data-cites="hostname">[@hostname|hostaddr]</span>[:service|port]</strong><br>显示网络相关的打开文件。</p><ul><li><code>lsof -i</code> 显示所有网络连接<br></li><li><code>lsof -i tcp</code> 显示所有 TCP 连接<br></li><li><code>lsof -i :80</code> 显示所有使用 80 端口的进程<br></li><li><code>lsof -i @192.168.1.100</code> 显示与特定 IP 相关的连接</li></ul></li><li><p><strong>-n</strong><br>禁用主机名解析，直接显示 IP 地址，有助于提高执行速度并避免 DNS查询延迟。</p></li><li><p><strong>-P</strong><br>禁用端口号转换，不把端口号转换为服务名称，直接显示数字端口。</p></li><li><p><strong>-u <user></user></strong><br>按用户过滤，显示指定用户的所有打开文件。<br><em>示例：</em> <code>lsof -u root</code></p></li><li><p><strong>-p <pid></pid></strong><br>按进程 ID 过滤，显示指定进程的所有打开文件。<br><em>示例：</em> <code>lsof -p 1234</code></p></li><li><p><strong>+D <directory></directory></strong><br>列出指定目录（包括子目录）中所有打开的文件。<br><em>示例：</em> <code>lsof +D /var/log</code></p></li><li><p><strong>+L1</strong><br>列出链接计数小于 1 的文件，通常表示文件已删除但仍被进程占用。</p></li><li><p><strong>-r [interval]</strong><br>循环执行<code>lsof</code>，每隔指定秒数刷新一次结果，常用于实时监控。<br><em>示例：</em> <code>lsof -r 2</code> （每 2 秒刷新一次）</p></li><li><p><strong>-V</strong><br>显示 <code>lsof</code> 版本信息。</p></li></ul><p><strong>示例：</strong></p><p>列出所有使用 80 端口的网络连接，不解析主机名和端口名称：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof -nlsof -nP -i :80P -i :80</span><br></pre></td></tr></table></figure></p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206173629686.png" alt="image-20250206173629686"><figcaption aria-hidden="true">image-20250206173629686</figcaption></figure><p>其他一些用法：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206152853213.png" alt="image-20250206152853213"><figcaption aria-hidden="true">image-20250206152853213</figcaption></figure><p>查看 Nginx 进程打开了哪些文件，进一步可以从中过滤出日志文件：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206153440327.png" alt="image-20250206153440327"><figcaption aria-hidden="true">image-20250206153440327</figcaption></figure><p>还可以查看占用文件的进程：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206173342247.png" alt="image-20250206173342247"><figcaption aria-hidden="true">image-20250206173342247</figcaption></figure><h2 id="网络流量与端口监控">7. 网络流量与端口监控</h2><ul><li><strong>iftop</strong>：实时显示网络接口数据流量。</li><li><strong>lsof</strong>：查看进程打开的文件或网络端口。</li><li><strong>netstat, ss</strong></li></ul><p><strong>例子：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo iftop -i ens160</span><br><span class="line">lsof -i :80</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208013603183.png" alt="image-20250208013603183"><figcaption aria-hidden="true">image-20250208013603183</figcaption></figure><p>也可以使用 <code>netstat</code> 或者具有更快的查询速度的<code>ss</code> 命令查看端口信息：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -tulnp</span><br><span class="line">ss -tulnp <span class="comment"># 高并发下性能更高</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208013219488.png" alt="image-20250208013219488"><figcaption aria-hidden="true">image-20250208013219488</figcaption></figure><p><code>-t</code> 显示 TCP 连接，<code>-u</code> 显示 UDP连接，<code>-l</code> 显示监听端口（过滤出 State 列中值为 LISTEN的连接），<code>-n</code> 显示数字形式的地址和端口，<code>-p</code>表示显示发起连接的进程 <code>pid</code> 和进程名称。</p><h2 id="磁盘-io-查看">8. 磁盘 I/O 查看</h2><p>磁盘 I/O的性能直接影响到系统的运行效率，特别是在进行大规模数据处理时。</p><p><code>iostat</code> 命令提供了关于 CPU 和 I/O设备的详细统计信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iostat -x</span><br></pre></td></tr></table></figure><p><code>-x</code> 参数显示扩展信息，包括每个设备的 I/O 性能。</p><p>另外也可以使用 <code>iotop</code> 实时查看磁盘 I/O使用情况，但需要管理员权限来运行，实时显示进程的磁盘 I/O 使用情况。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208011840833.png" alt="image-20250208011840833"><figcaption aria-hidden="true">image-20250208011840833</figcaption></figure><p><code>iotop -k</code> 可以动态显示 IO 情况：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208012108808.png" alt="image-20250208012108808"><figcaption aria-hidden="true">image-20250208012108808</figcaption></figure><h2 id="内存资源查看-free">9. 内存资源查看 <code>free</code></h2><p>在 Linux 系统中，查看内存资源的使用情况，可以使用 <code>free</code>命令。该命令提供了有关系统内存使用的汇总信息。</p><ol type="1"><li><p><strong>查看内存使用情况</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -h</span><br></pre></td></tr></table></figure></li></ol><p>​ <code>-h</code> 参数会以人类易读的格式（如MB、GB）显示内存使用情况。</p><ol start="2" type="1"><li><p><strong>输出详细信息</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free -m</span><br></pre></td></tr></table></figure><p><code>-m</code> 参数以 MB为单位显示内存使用情况，适用于查看内存总量和剩余空间。</p></li><li><p><strong>查看内存使用变化</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch free -h</span><br></pre></td></tr></table></figure><p>使用 <code>watch</code>命令可以实时监控内存使用情况，自动刷新显示结果。</p></li></ol><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208010259465.png" alt="image-20250208010259465"><figcaption aria-hidden="true">image-20250208010259465</figcaption></figure><blockquote><p>swap是硬件交换分区（虚拟内存），防止内存用完导致系统崩溃，临时拿磁盘的一些空间当做内存使用。</p></blockquote><h2 id="cpu-与负载管理">10. CPU 与负载管理</h2><p>在 Linux 系统中，查看 CPU核心数非常简单，可以使用以下命令来查看当前系统中的 CPU 配置：</p><ul><li><p><strong><code>lscpu</code> 命令</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  lscpu | grep -i <span class="string">&#x27;^cpu(s)&#x27;</span></span><br><span class="line"></span><br><span class="line">​这个命令会输出系统中 CPU 的核心数信息，例如：</span><br><span class="line"></span><br><span class="line">​![image-20250208004559916](./Linux%20进程与资源管理/image-20250208004559916.png)</span><br><span class="line"></span><br><span class="line">* **`top` 命令**：在 `top` 命令的实时监控界面中，按下 1 键可以查看每个 CPU 核心的使用情况。理想情况下，所有 CPU 核心都会有进程在执行，这表示 CPU 被充分利用，系统的运行效率最大化。</span><br><span class="line"></span><br><span class="line">理想的 CPU 利用状态是系统中的每个核心都在处理进程。在高并发编程中，目标是让系统的每个 CPU 核心都得到充分的利用，这样才能在多核 CPU 系统中达到最大的工作效率。例如，如果你有 4 个核心的 CPU，理想情况下，应该有 4 个进程同时运行，每个进程占用一个 CPU 核心。这样系统可以最大化地发挥 CPU 的处理能力。如果你的代码或程序设计不当，导致只有一个核心在执行任务，而其他核心空闲，这样就不能充分利用所有的 CPU 核心，导致系统资源浪费。</span><br><span class="line"></span><br><span class="line">* **<span class="built_in">uptime</span> 命令**：</span><br><span class="line"></span><br><span class="line">  ```bash</span><br><span class="line">   <span class="comment"># 输出示例</span></span><br><span class="line">   06:56:12 up 12 days,  3:45,  3 <span class="built_in">users</span>,  load average: 0.22, 0.45, 0.56</span><br></pre></td></tr></table></figure></p><p>在输出中，load average 后面跟着的是三个数字，分别表示 1 分钟、5分钟和 15 分钟内的平均负载。要如何解读这些负载值呢？</p><ul><li><strong>理想的负载情况</strong>：如果这三个值差不多，说明系统运行平稳，负载是均衡的。</li><li><strong>负载迅速增加</strong>：如果 1 分钟内的负载值远大于 15分钟的负载值，说明系统在短时间内负载突然上升，可能表示系统正在经历某种突发的工作负载。</li><li><strong>负载下降</strong>：如果 1 分钟内的负载值小于 15分钟的负载值，说明系统负载正在下降，负载压力减轻。</li></ul><p>就上面的例子而言：</p><ul><li><p>在过去 1 分钟内，系统的负载平均值为 0.22。</p></li><li><p>在过去 5 分钟内，系统的负载平均值为 0.45。</p></li><li><p>在过去 15 分钟内，系统的负载平均值为 0.56。</p></li></ul><p>这些值相差不大，表明系统负载较为平稳，没有出现过高的负载压力。</p></li></ul><h2 id="stress-负载压力测试">11. Stress 负载压力测试</h2><p><code>stress</code> 是一个常用的负载测试工具，用于模拟CPU、内存、磁盘和 I/O负载等各种场景。它可以帮助你进行性能测试或模拟系统的高负载状态，评估系统的稳定性。</p><ol type="1"><li><p><strong>安装 <code>stress</code></strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install stress</span><br></pre></td></tr></table></figure></li><li><p><strong>进行 CPU 压力测试</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress --cpu 4 --<span class="built_in">timeout</span> 60s</span><br></pre></td></tr></table></figure><p>这条命令会启动 4 个进程，进行 60 秒的 CPU 压力测试。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208005755365.png" alt="image-20250208005755365"><figcaption aria-hidden="true">image-20250208005755365</figcaption></figure><p>其他的还有 <code>pidstat</code> 和 <code>mpstat</code>：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208005952558.png" alt="image-20250208005952558"><figcaption aria-hidden="true">image-20250208005952558</figcaption></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250208010015379.png" alt="image-20250208010015379"><figcaption aria-hidden="true">image-20250208010015379</figcaption></figure></li><li><p><strong>内存压力测试</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress --vm 2 --vm-bytes 1G --<span class="built_in">timeout</span> 60s</span><br></pre></td></tr></table></figure><p>启动 2 个虚拟内存进程，每个进程分配 1GB 内存，持续 60 秒。</p></li><li><p><strong>I/O 压力测试</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stress --io 4 --<span class="built_in">timeout</span> 60s</span><br></pre></td></tr></table></figure><p>进行 I/O 操作压力测试，启动 4 个 I/O 密集型进程，测试持续 60秒。</p></li></ol><h1 id="四进程信号与后台管理">四、进程信号与后台管理</h1><h2 id="使用-kill-发送信号">1. 使用 <code>kill</code> 发送信号</h2><p><code>kill</code>命令用于向进程发送信号，以请求进程终止或进行其他处理。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> &lt;PID&gt;</span><br></pre></td></tr></table></figure><p>默认发送 <code>SIGTERM</code> 信号（等于加 15信号），通常请求进程正常退出。</p><p><strong>强制终止</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 &lt;PID&gt;</span><br></pre></td></tr></table></figure><p>发送 <code>SIGKILL</code> 信号，强制立即终止进程。</p><p><strong>不关闭进程，重新加载其配置文件，如 <code>reload</code> 操作</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -1 &lt;PID&gt;</span><br></pre></td></tr></table></figure><p><code>kill</code> 命令的其他信号参数如下：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206233455373.png" alt="image-20250206233455373"><figcaption aria-hidden="true">image-20250206233455373</figcaption></figure><p>其中 2 信号等于中断（ <code>Ctrl + C</code>）；3信号等于退出（<code>Ctrl + \</code>）；15信号是终止，通常是系统关机时发送；20信号是暂停进程（<code>Ctrl + Z</code>）。下面可以看到我们使用<code>Ctrl + Z</code> 暂停进程后，<code>ping</code> 的进程被挂起了，使用<code>kill</code> 并没有杀掉他，但 <code>ping</code> 并没有响应<code>SIGTERM</code>，我们需要 <code>SIGKILL</code>（信号9）强制终止：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206234327729.png" alt="image-20250206234327729"><figcaption aria-hidden="true">image-20250206234327729</figcaption></figure><p>我们可以再做个实验，在一个终端<code>ping</code>，在另一个终端使用正常的 <code>kill</code>命令，看是否会被杀死：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206234726903.png" alt="image-20250206234726903"><figcaption aria-hidden="true">image-20250206234726903</figcaption></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206234815881.png" alt="image-20250206234815881"><figcaption aria-hidden="true">image-20250206234815881</figcaption></figure><p>可以看到，当 <code>ping</code>不是在暂停状态时，是可以直接被杀死的，不需要强制。</p><p><code>killall</code>可以将所有同名的进程杀死，但不建议用，容易挨揍。</p><h2 id="后台运行命令">2. 后台运行命令</h2><h3 id="使用-将命令放入后台">使用 <code>&amp;</code> 将命令放入后台</h3><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./long_task.sh &amp;</span><br></pre></td></tr></table></figure><h3 id="使用-nohup-保证任务在注销后继续运行">使用 <code>nohup</code>保证任务在注销后继续运行</h3><p>即使非正常退出，<code>nohup + &amp;</code> 的任务也还在，但如果不加<code>nohup</code> 就不在了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ./backup.sh &amp;</span><br></pre></td></tr></table></figure><h3 id="bg-和-fg"><code>bg</code> 和 <code>fg</code></h3><p><code>bg</code> 是在 <code>Ctrl + Z</code>后将后台的程序继续运行起来，<code>fg</code>是将前台运行的程序放到后台运行，后面接查看 <code>jobs</code>后显示的对应进程的 <code>ID</code>号，注意无论是不是后台运行该在终端输出的还是会输出。</p><h1 id="五调整进程优先级">五、调整进程优先级</h1><h2 id="使用-nice-启动进程">1. 使用 <code>nice</code> 启动进程</h2><p><code>nice</code> 命令在启动进程时指定其优先级。<code>nice</code>值越高，进程优先级越低；<code>nice</code> 值范围通常为-20（最高优先级）到 19（最低优先级）。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">nice</span> -n 10 ./myscript.sh</span><br></pre></td></tr></table></figure><p><strong>例子</strong>：</p><p>启动脚本 <code>myscript.sh</code> 时以 <code>nice</code> 值 10运行，降低其对 CPU 的抢占。</p><h2 id="使用-renice-调整正在运行进程的优先级">2. 使用<code>renice</code> 调整正在运行进程的优先级</h2><p><code>renice</code> 命令用于修改已运行进程的 <code>nice</code>值。</p><p><strong>基本用法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renice -n -5 -p &lt;PID&gt;</span><br></pre></td></tr></table></figure><p><strong>例子</strong>：</p><p>调整进程 2345 的优先级，将 <code>nice</code> 值设置为-5（提高优先级）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renice -n -5 -p 2345</span><br></pre></td></tr></table></figure><h1 id="六进程父子关系与特殊进程状态">六、进程父子关系与特殊进程状态</h1><h2 id="进程父子关系">1. 进程父子关系</h2><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/copy-on-write.png" alt="Redis数据持久化- Aphasia&#39;s personal blog"><figcaption aria-hidden="true">Redis数据持久化- Aphasia's personalblog</figcaption></figure><ul><li><p>每个进程通过 <code>fork()</code> 调用由父进程创建。</p></li><li><p><strong>父进程</strong>与<strong>子进程</strong>通过 PPID（父进程ID）关联。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206113610023.png" alt="image-20250206113610023"><figcaption aria-hidden="true">image-20250206113610023</figcaption></figure><p>我们登录的 XShell 终端的流程是：</p><ol type="1"><li>系统上运行了 <code>sshd</code> 服务</li><li>通过 <code>ssh</code>客户端命令都是去连接这个服务而产生的一堆子进程</li></ol><p>可以通过 <code>ps -auxf</code> 查看：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206113904636.png" alt="image-20250206113904636"><figcaption aria-hidden="true">image-20250206113904636</figcaption></figure><p>我们可以查看对应进程的父子关系来验证：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206114542373.png" alt="image-20250206114542373"><figcaption aria-hidden="true">image-20250206114542373</figcaption></figure><p><code>sshd</code> 第一行的进程是 <code>sshd</code>服务本身，<code>sshd</code> 第二行的进程是 <code>ssh</code>客户端，远程连接的会话进程。后续的命令都是基于 957499这个进程生成的子进程，在 <code>bash</code>的第三行是用户登录解释器产生的 <code>bash</code> 进程， <code>id</code>是 957500，后续的命令又都是这个 <code>bash</code>进程生成的子进程。</p></li></ul><h2 id="孤儿进程">2. 孤儿进程</h2><p>父进程退出后（因为某些原因挂了），子进程由 <code>init</code> 或<code>systemd</code> 接管（被 1号进程接替，去管理这些孤儿进程的数据）。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/63b77cb276213111b4734938.png" alt="孤儿进程流程图模板_ProcessOn思维导图、流程图"><figcaption aria-hidden="true">孤儿进程流程图模板_ProcessOn思维导图、流程图</figcaption></figure><p>具体可以运行这段代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">child_process</span>():</span><br><span class="line">    <span class="comment"># 第一次输出，可能仍是父进程存在时</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Child process: PID = &#123;&#125;, Parent PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), os.getppid()))</span><br><span class="line">    <span class="comment"># 等待父进程退出（父进程突然退出后，孤儿进程会被 init 领养）</span></span><br><span class="line">    time.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># 父进程退出后再次输出，此时父进程 PID 应该变为 1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Child process after parent&#x27;s exit: PID = &#123;&#125;, Parent PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), os.getppid()))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 父进程分支</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Parent process: PID = &#123;&#125;, Child PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), pid))</span><br><span class="line">        <span class="comment"># 突然退出，父进程立即结束</span></span><br><span class="line">        os._exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 子进程分支</span></span><br><span class="line">        child_process()</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206141429890.png" alt="image-20250206141429890"><figcaption aria-hidden="true">image-20250206141429890</figcaption></figure><p>流程讲解：</p><ol type="1"><li>程序调用 <code>os.fork()</code> 创建子进程。<ol type="1"><li>父进程中，<code>os.fork()</code> 返回子进程的 PID；</li><li>子进程中，返回值为 0。</li></ol></li><li>父进程打印自己的 PID 和子进程 PID 后，使用 <code>os._exit(0)</code>立即退出，使子进程成为孤儿进程。</li><li>子进程先打印初始时的父进程 PID，再等待 3秒（确保父进程已经退出），最后再次打印自己的 PID 和父进程PID。此时，由于父进程已退出，操作系统会将子进程的父进程设置为<code>init</code>（在大多数系统中，其 PID 为 1）。</li></ol><h2 id="僵尸进程">3. 僵尸进程</h2><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/GIqlONjnXBrkuRz4DXxSdr0WBeSmud5olIwsN9w7B3TRy6IBNgaqaRphuj4PB2194l89F9vjp6GHteXc3txRX5SDJMQVgN6m76YejCRl32TfGJQ.png" alt="僵尸进程（Zombie Process） – 常量笔记"><figcaption aria-hidden="true">僵尸进程（Zombie Process） –常量笔记</figcaption></figure><ul><li>进程退出后，内核保留其退出状态，等待父进程回收；</li><li>父进程若不调用 wait()，子进程则成为僵尸；</li><li>僵尸进程不会占用大量资源，但过多会耗尽系统进程表。</li></ul><p><strong>查看方式</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep <span class="string">&#x27; Z &#x27;</span></span><br></pre></td></tr></table></figure><p><strong>具体例子</strong>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    pid = os.fork()</span><br><span class="line">    <span class="keyword">if</span> pid &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="comment"># 父进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Parent process: PID = &#123;&#125;, Child PID = &#123;&#125; (child will become zombie)&quot;</span>.<span class="built_in">format</span>(os.getpid(), pid))</span><br><span class="line">        <span class="comment"># 父进程暂停 15 秒，在此期间子进程已退出但未被回收，处于僵尸状态</span></span><br><span class="line">        time.sleep(<span class="number">15</span>)</span><br><span class="line">        <span class="comment"># 最后回收僵尸进程</span></span><br><span class="line">        os.wait()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Zombie child has been reaped.&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 子进程</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Child process: PID = &#123;&#125;, Parent PID = &#123;&#125;&quot;</span>.<span class="built_in">format</span>(os.getpid(), os.getppid()))</span><br><span class="line">        <span class="comment"># 子进程立即退出，进入僵尸状态（直到父进程调用 wait()）</span></span><br><span class="line">        os._exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>在调用 <code>os.fork()</code>后，实际上会产生两个独立的进程：一个是父进程，一个是子进程。这两个进程都会从<code>os.fork()</code>这一行开始继续执行接下来的代码，但它们各自拥有不同的返回值：</p><ul><li><strong>在父进程中</strong>：<code>os.fork()</code> 返回的是子进程的PID（一个正整数），因此条件 <code>if pid &gt; 0</code>为真，父进程会执行 if 分支的代码。</li><li><strong>在子进程中</strong>：<code>os.fork()</code> 返回 0，所以条件<code>if pid &gt; 0</code> 为假，子进程会执行 <code>else</code>分支的代码。<code>os.wait()</code>会使父进程等待任一子进程结束，并收集其退出状态（也称为回收僵尸进程）。当父进程执行到这行代码时，之前已经退出的子进程将被系统正式回收，其“僵尸状态”消失。</li></ul><p>这两个进程是并行运行的，它们共享同一段代码，但各自根据<code>os.fork()</code>返回的不同值来选择不同的执行路径。这样就可以同时看到父进程和子进程的输出，而它们的PID 值分别反映了各自的情况（父进程得到子进程的 PID，子进程得到 0）。</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206142957326.png" alt="image-20250206142957326"><figcaption aria-hidden="true">image-20250206142957326</figcaption></figure><p>上面的代码运行期间，我们可以在另一个窗口通过<code>ps aux | grep Z</code> 观察到子进程变成僵尸进程（状态为“Z”）：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206142932763.png" alt="image-20250206142932763"><figcaption aria-hidden="true">image-20250206142932763</figcaption></figure><h1 id="七挂载点的理解与实例详解">七、挂载点的理解与实例详解</h1><p>在 Linux中，整个文件系统是一个统一的目录树，所有的文件和目录都位于根目录<code>/</code> 下。挂载点（MountPoint）就是在这个目录树中预先创建的一个空目录，用于将其他存储设备（例如硬盘分区、USB驱动器、网络文件系统等）的文件系统“挂载”到这个目录上，从而将这些外部文件系统整合到主文件系统中，实现统一管理和访问。</p><h2 id="挂载点的基本概念">1. 挂载点的基本概念</h2><ul><li><p><strong>统一文件树</strong><br>Linux的设计理念是“一切皆文件”，整个系统都被构造为一个单一的目录树。无论是系统硬盘、外接存储设备，还是网络文件系统，最终都可以通过挂载点呈现在同一个目录结构中。</p></li><li><p><strong>挂载操作</strong><br>挂载就是把一个独立的文件系统连接到现有目录树的某个目录上，使得这个目录成为访问该文件系统的入口。挂载完成后，用户访问该目录时，实际上访问的是挂载的设备中的文件。</p></li><li><p><strong>卸载操作</strong><br>卸载（umount）则是将挂载的设备从目录树中移除。在卸载之前，必须确保没有进程在使用挂载点，否则卸载操作会失败。</p></li></ul><h2 id="常见的挂载点示例">2. 常见的挂载点示例</h2><ul><li><p><strong>根目录 (<code>/</code>)</strong><br>整个系统的根，所有挂载的文件系统最终都挂载在根目录下。例如，系统安装盘通常直接挂载在<code>/</code> 上。</p></li><li><p><strong>临时挂载目录 (<code>/mnt</code> 或<code>/media</code>)</strong><br>用于临时挂载外部设备。例如，当你插入一个 USB驱动器时，系统可能自动将其挂载到 <code>/media/username/USB_DRIVE</code>或你手动将其挂载到 <code>/mnt/usb</code>。</p></li><li><p><strong>自定义挂载点</strong><br>在服务器环境中，经常为不同用途创建专用挂载点，如 <code>/data</code>用于存储用户数据，<code>/backup</code>用于备份文件。这样不仅方便管理，还能根据设备性能合理分配任务（例如将高性能SSD 挂载在数据库目录下，而将大容量 HDD 用于存储日志文件）。</p></li></ul><h2 id="挂载命令与操作示例">3. 挂载命令与操作示例</h2><ul><li><p><strong>挂载设备</strong><br>使用 <code>mount</code> 命令将设备挂载到指定目录。例如，将设备<code>/dev/sdb1</code> 挂载到 <code>/mnt/data</code>：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  mount /dev/sdb1 /mnt/data</span><br><span class="line"></span><br><span class="line">​挂载后，访问 /mnt/data 就相当于访问 /dev/sdb1 中的所有文件。</span><br><span class="line"></span><br><span class="line">* **查看当前挂载情况**</span><br><span class="line"></span><br><span class="line">  使用 `mount` 或 `findmnt` 查看当前所有挂载的设备及其挂载点：</span><br><span class="line"></span><br><span class="line">  ```bash</span><br><span class="line">  mount</span><br><span class="line">  findmnt</span><br></pre></td></tr></table></figure></p></li><li><p><strong>卸载设备</strong></p><p>使用 <code>umount</code> 命令卸载挂载的文件系统：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /mnt/data</span><br></pre></td></tr></table></figure><p>注意：在卸载前必须确保没有进程正在使用 /mnt/data。</p></li></ul><h2 id="挂载点在系统管理中的作用">4. 挂载点在系统管理中的作用</h2><ul><li><p><strong>数据整合</strong></p><p>挂载点允许管理员将不同物理设备的文件系统整合到一个统一的目录结构中，便于统一管理。例如，数据库文件可以挂载在一个专用分区（例如/var/lib/mysql），而用户数据则挂载在另一个分区（例如 /data）。</p></li><li><p><strong>性能优化</strong></p><p>将性能要求高的应用挂载到高性能设备上（如固态硬盘），而大容量但速度较慢的设备则用于存储归档数据，合理规划存储策略。</p></li><li><p><strong>备份与恢复</strong></p><p>利用挂载点，可以将外部备份设备挂载到系统中，实现数据的备份与恢复，而无需改变系统的目录结构。</p></li></ul><h1 id="八综合应用">八、综合应用</h1><p>Nginx 日志非常重要，可以帮助我们查看是否有一些异常的 IP在进行非授权的访问，例如访问 admin或者试图访问一些敏感的后台管理文件夹：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206233125034.png" alt="image-20250206233125034"><figcaption aria-hidden="true">image-20250206233125034</figcaption></figure><p>误删除 nginx 日志文件夹后恢复操作：</p><figure><img src="/Linux%20%E8%BF%9B%E7%A8%8B%E4%B8%8E%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86/image-20250206233055035.png" alt="image-20250206233055035"><figcaption aria-hidden="true">image-20250206233055035</figcaption></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Effective Linux troubleshooting is about turning symptoms into a
concrete resource story: which process is consuming CPU, where memory is
going (and what “buffer/cache” really means), whether you’re blocked on
disk I/O, and which files or ports are involved. This post builds that
mental model from the basics (process vs. program vs. thread,
parent/child relationships), then walks through a practical toolbox
(&lt;code&gt;top/htop/ps/pstree/lsof&lt;/code&gt;, network and I/O inspection, load
and stress testing). It also covers “control levers” you’ll use in
production—signals, background jobs, &lt;code&gt;nice/renice&lt;/code&gt;, and
diagnosing orphan/zombie processes—so you can both locate and fix issues
instead of just observing them.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 文件操作深入解析</title>
    <link href="https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/"/>
    <id>https://chenk.top/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/</id>
    <published>2025-01-17T16:00:00.000Z</published>
    <updated>2026-01-28T01:24:28.664Z</updated>
    
    <content type="html"><![CDATA[<p>在命令行里真正拉开效率差距的能力，不是会多少命令，而是能不能把命令“拼起来”。管道符<code>|</code> 正是 Unix哲学的核心：让每个小工具只做一件事，然后把它们串成一条清晰的数据流。本文不仅讲<code>|</code>的语法，还会重点解释它在日志排查、文本过滤、统计汇总、批量处理里的典型套路：什么时候该用<code>grep/awk/sort/uniq/wc</code>，怎么逐层缩小范围，如何避免临时文件与重复劳动。你读完之后应该能把很多“要写脚本”的小需求，直接用一两行可读的命令解决，并且更容易看懂别人写的one-liner。</p><span id="more"></span><h1 id="一管道符">一、管道符</h1><h2 id="基本介绍">1. 基本介绍</h2><p>Linux 中，管道符 <code>|</code>的功能是将前一个命令的输出传递给下一个命令作为输入。这样可以把多个小型命令拼装起来，让每个命令只专注做一件事（符合UNIX的哲学：单一命令，简单而强大），通过管道连接成一条完整的处理流程。</p><ul><li><strong>语法</strong>：<code>命令1 | 命令2 [| 命令3 …]</code></li></ul><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/管道命令示意图.drawio.svg" alt="linux-管道pipe与xargs | SurprisedCat"><figcaption aria-hidden="true">linux-管道pipe与xargs |SurprisedCat</figcaption></figure><p>使用管道符的好处如下：</p><ol type="1"><li>避免产生临时文件：数据无需先写入文件再读出。</li><li>提高效率：分步处理可以快速对结果进行再次筛选、统计、过滤等。</li><li>简化语句：一行命令即可串起多个操作。</li></ol><h2 id="示例">2. 示例</h2><ol type="1"><li><p>基本使用示例：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250115232344692.png" alt="image-20250115232344692"><figcaption aria-hidden="true">image-20250115232344692</figcaption></figure><p>从上图可以看到， <code>echo "I love you" | wc -m</code> 返回11；另外当执行 <code>echo "I love you" | cat -E</code> 时，会在行末显示<code>$</code> 符号，说明末尾还有换行符的存在。管道符让我们可以将<code>echo</code> 命令输出，直接交给 <code>wc</code>、<code>cat</code>或其他命令进行统计、格式化、过滤等操作，而无需中间文件。</p></li><li><p><strong>查看日志内容时只取关键行</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/syslog | grep <span class="string">&#x27;error&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>多级管道</strong>：<code>ls -l /etc | grep conf | wc -l</code>（在<code>/etc</code> 下查找带有 <code>conf</code>的配置文件并统计数量）</p></li><li><p><strong>网络连接过滤</strong>：<code>netstat -an | grep LISTEN</code>（查看处于监听状态的端口）</p></li><li><p><strong>循环生成随机数输出到文档里</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..30&#125;; do echo `expr $&#123;RANDOM&#125; / 1000`; done &gt; rand_1000.txt</span><br></pre></td></tr></table></figure><p>可以 <code>cat</code> 一下文档看看内容：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201215547121.png" alt="image-20250201215547121"><figcaption aria-hidden="true">image-20250201215547121</figcaption></figure><p><strong>将随机数进行倒排：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat rand_1000.txt | sort -nr</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201214659228.png" alt="image-20250201214659228"><figcaption aria-hidden="true">image-20250201214659228</figcaption></figure><p>结果为：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201220826340.png" alt="image-20250201220826340"><figcaption aria-hidden="true">image-20250201220826340</figcaption></figure><p><strong>去重排序</strong>：</p><p>将要使用到的命令是 <code>uniq</code></p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201224329721.png" alt="image-20250201224329721"><figcaption aria-hidden="true">image-20250201224329721</figcaption></figure><p>我们需要首先对其排序后才能去重，还可以加 <code>-c</code>参数查看重复了多少次：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201224555475.png" alt="image-20250201224555475"><figcaption aria-hidden="true">image-20250201224555475</figcaption></figure></li></ol><hr><h1 id="二grep-的基本概念与使用">二、grep 的基本概念与使用</h1><h2 id="基本介绍-1">1. 基本介绍</h2><p><code>grep</code> 是 Linux下极常用的文本搜索工具，通过模式匹配（包括正则表达式）筛选出符合条件的行。结合管道符，可以非常便捷地在输出数据中定位关键字。</p><p><strong>grep 基础命令</strong></p><ul><li><code>grep pattern file</code>：在文件中搜索<code>pattern</code>，打印匹配行。</li><li><code>command | grep pattern</code>：在命令输出中筛选包含<code>pattern</code> 的行。</li></ul><p><strong>常用参数</strong></p><ul><li><code>-i</code>：忽略大小写搜索。</li><li><code>-v</code>：反向匹配，只显示不包含关键字的行。</li><li><code>-n</code>：显示匹配结果所在行号。</li><li><code>-E</code> 或 <code>-P</code>：启用扩展正则或 Perl风格正则。</li></ul><hr><h2 id="示例-1">2. 示例</h2><h3 id="基本示例">基本示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在当前文件夹下检索含 &quot;TODO&quot; 的行</span></span><br><span class="line">grep <span class="string">&quot;TODO&quot;</span> *.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在命令输出中搜索：</span></span><br><span class="line"><span class="built_in">ls</span> -l /etc | grep conf</span><br></pre></td></tr></table></figure><p>若要反向匹配：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /etc | grep -v conf</span><br></pre></td></tr></table></figure><p>只显示不包含 conf 的行。</p><h3 id="ps--ef-grep-vim">ps -ef | grep vim</h3><p>在 Linux 下，<code>ps -ef</code>通常用于查看当前所有进程；通过管道连接 <code>grep</code>能快速查找特定的进程名或关键字。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps -ef | grep vim</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 用于检索当前系统上是否有 vim 进程在运行。</span></span><br><span class="line"><span class="comment"># 如果 vim 正在编辑文件，输出会显示vim进程信息，如PID、CMD等。</span></span><br></pre></td></tr></table></figure><p>在某个终端运行 vim 编辑某文件，而在另一个终端使用<code>ps -ef | grep vim</code>，我们可以看到当 vim正在编辑某文件时，对该文件持有句柄，导致文件处于占用状态。当执行<code>:wq!</code> 等命令退出 vim 后，vim会释放对应文件句柄，不再占用系统资源。若一直不退出（不释放句柄），则有可能导致内存或资源泄露。下图示例演示了<code>ps -ef | grep vim</code> 结果，<code>vim</code>进程正在运行中：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250115182224707.png" alt="image-20250115182224707"><figcaption aria-hidden="true">image-20250115182224707</figcaption></figure><p>文件占用示例里，只有在 vim 中执行 <code>:wq!</code>或其他合理退出方式后，文件句柄才正式释放；否则文件会一直处于被 vim进程占用状态。若长期不释放，系统会持续保留资源，占用内存，甚至导致“内存泄露”或类似的资源枯竭问题。</p><p><code>ps -ef</code>的用法遍布各个场景，如日志分析、网络监控、系统排查等等，如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep ssh</span><br></pre></td></tr></table></figure><p>将查找系统中所有进程最后只输出带有 ssh 的进程行。<a href="https://man7.org/linux/man-pages/man1/ps.1.html"><code>ps</code>的其他参数如下</a>：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116221414587.png" alt="image-20250116221414587"><figcaption aria-hidden="true">image-20250116221414587</figcaption></figure><h3 id="查询进程">查询进程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep nginx</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116223538445.png" alt="image-20250116223538445"><figcaption aria-hidden="true">image-20250116223538445</figcaption></figure><p>查找目前运行中的 nginx 进程，以便查看其 PID、运行用户等信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep -v grep | grep vim</span><br></pre></td></tr></table></figure><p>有时 <code>grep vim</code> 本身也会被列入结果，可使用<code>-v grep</code> 排除包含“grep”的行。</p><blockquote><p>补充命令学习：<code>netstat -tunlp</code>是查看系统中的所有端口信息，和<code>ps -ef</code> 类似，都是查看系统中某资源信息的。LISTEN代表监听中，即等待用户连接中。</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116224105131.png" alt="image-20250116224105131"><figcaption aria-hidden="true">image-20250116224105131</figcaption></figure></blockquote><h3 id="过滤日志">过滤日志</h3><p><strong>将系统日志（syslog）中所有包含 error的行筛选出来</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/syslog | grep error</span><br></pre></td></tr></table></figure><p><strong>实时查看日志变化，只显示包含 usb的行，适合监控插拔事件或关键字出现</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /var/log/messages | grep usb</span><br></pre></td></tr></table></figure><p><strong>找出 /var/log 目录下哪些文件含passwd信息</strong></p><p><code>-R</code> 是递归查找的命令</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117113722343.png" alt="image-20250117113722343"><figcaption aria-hidden="true">image-20250117113722343</figcaption></figure><p>如果只想拿到文件名，加 <code>-l</code> 参数：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117114846009.png" alt="image-20250117114846009"><figcaption aria-hidden="true">image-20250117114846009</figcaption></figure><p><strong>找出 /var/log/ 下文件名包含 <code>boot</code> 的文件有哪些</strong></p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117115505355.png" alt="image-20250117115505355"><figcaption aria-hidden="true">image-20250117115505355</figcaption></figure><h3 id="多级筛选">多级筛选</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg | grep <span class="string">&#x27;eth0&#x27;</span> | grep -i <span class="string">&#x27;down&#x27;</span></span><br></pre></td></tr></table></figure><p>使用两次 grep 逐层过滤：先选含 eth0，再选含 down（不区分大小写可用-i）。</p><h3 id="结合-wcsortuniq-等命令">结合 wc、sort、uniq 等命令</h3><ol type="1"><li><p>统计匹配次数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> file.log | grep <span class="string">&quot;ERROR&quot;</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure></li></ol><p>​ 显示 <code>file.log</code> 中包含“ERROR”的行数。</p><ol start="2" type="1"><li><p>去重并统计：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd | grep <span class="string">&#x27;/bin/bash&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><p>找出使用 <code>/bin/bash</code> 作为 shell的用户，去重后统计用户数。</p></li><li><p>灵活组合</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an | grep ESTABLISHED | grep <span class="string">&#x27;:80&#x27;</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><p>显示当前 80 端口处于已建立连接状态的连接数量。</p></li></ol><h2 id="grep-的高级搜索技巧">3. grep 的高级搜索技巧</h2><h3 id="正则表达式">正则表达式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># grep -E (extended regex) 示例</span></span><br><span class="line"><span class="built_in">ls</span> -l | grep -E <span class="string">&#x27;^(d|l)&#x27;</span></span><br></pre></td></tr></table></figure><p>搜索以 d 或 l 开头的行（文件类型为目录 d 或链接l），显示目录或链接。</p><h3 id="显示上下文行">显示上下文行</h3><ul><li><code>-A n</code>：匹配行后面显示 n 行；</li><li><code>-B n</code>：匹配行前面显示 n 行；</li><li><code>-C n</code>：匹配行前后各显示 n 行；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -C 2 <span class="string">&quot;error&quot;</span> syslog</span><br></pre></td></tr></table></figure><p>匹配到 “error” 的行，并显示上下各 2 行上下文，以便快速定位问题。</p><h3 id="反向匹配">反向匹配</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /etc | grep -v conf</span><br></pre></td></tr></table></figure><p>列表中排除包含“conf”的文件行。</p><h1 id="三xargs">三、<code>xargs</code></h1><p>在 Linux/UNIX 环境中，很多命令（如<code>rm</code>、<code>cp</code>、<code>mv</code>等）可以一次接受较多参数，但是有时我们需要先通过<code>grep</code>、<code>find</code>等命令查到很多结果，再把这些结果逐个传给另外的命令去执行；若结果很多，直接把输出用<code>| command</code>有可能出现“参数列表过长”或命令无法正确解析的情况。</p><p><strong>xargs</strong>则是专门设计来解决这个需求的：它能<strong>从标准输入读取一行行或多行数据</strong>，再把它们当作参数传给指定命令。这样我们就能轻松地把“输出流”接给下一个命令，实现批量操作。</p><h2 id="基础用法">1. 基础用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;file1 file2 file3&quot;</span> | xargs <span class="built_in">rm</span></span><br></pre></td></tr></table></figure><p>这代表将 file1 file2 file3 交给 rm 命令，一次删除这些文件。</p><h2 id="i-与替换符">2. -i 与替换符</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">find /tmp/ -name <span class="string">&#x27;*.log&#x27;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; &#123;&#125;.bak</span><br><span class="line"><span class="comment">#   此命令会在 /tmp/ 下查找所有 .log 文件，并对每个文件执行：</span></span><br><span class="line"><span class="comment">#   cp filename filename.bak</span></span><br><span class="line"><span class="comment">#   相当于给每个 .log 文件都复制一份 .bak 结尾的备份。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   find /tmp/ -name &#x27;*.log&#x27; -&gt; /tmp/a.log /tmp/b.log /tmp/subdir/c.log ...</span></span><br><span class="line"><span class="comment">#   这些结果被传给 xargs -i</span></span><br><span class="line"><span class="comment">#   xargs 将每个文件都替换到 &#123;&#125; 上执行:  cp /tmp/a.log /tmp/a.log.bak</span></span><br><span class="line"><span class="comment">#                                   cp /tmp/b.log /tmp/b.log.bak</span></span><br><span class="line"><span class="comment">#                                   cp /tmp/subdir/c.log /tmp/subdir/c.log.bak</span></span><br></pre></td></tr></table></figure><p>在示例 <code>find /tmp/ -name '*.log' | xargs -i cp &#123;&#125; &#123;&#125;.bak</code>中： • <code>-i</code> 选项允许我们使用占位符 <code>&#123;&#125;</code>来表示从上一个命令输出中得到的每一行文本； • <code>cp &#123;&#125; &#123;&#125;.bak</code>表示对于每一个 log 文件，用它自己的文件名作为<code>&#123;&#125;</code>，然后再在后面补 <code>.bak</code>，形成新文件名。</p><p>如果没有 <code>-i</code>，则 <code>xargs</code>默认把所有输出的文件拼成一行一行或多行参数传给命令，不会像替换符 {}这样灵活地组合不同的目标和源路径。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 另一个示例：将所有 .txt 文件复制到 ~/backup/ 下</span></span><br><span class="line">find . -name <span class="string">&#x27;*.txt&#x27;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; backup/</span><br></pre></td></tr></table></figure><h2 id="批量查询文本是否包含某信息">3. 批量查询文本是否包含某信息</h2><p>当我们想要在一堆文件里搜索某字符串、某信息或某正则模式时，最直接的工具往往是<strong><code>grep</code></strong>。如果我们已经有了一份文件列表（如在某个文本文件里，或通过<code>find</code> 找到），也可以配合 <code>xargs</code>来实现批量查询。</p><h3 id="使用-grep-自带的批量搜索">使用 <code>grep</code>自带的批量搜索</h3><p>其实最简单的是，直接在 <code>grep</code> 后面跟多个文件参数，如：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;关键字&quot;</span> file1 file2 file3 ...</span><br></pre></td></tr></table></figure></p><p>或结合 <code>find</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path -name <span class="string">&#x27;*.txt&#x27;</span> -<span class="built_in">exec</span> grep <span class="string">&quot;关键字&quot;</span> &#123;&#125; \; </span><br></pre></td></tr></table></figure><p>这里 <code>-exec</code>命令是跟着shell的命令，结尾必须以分号结束，考虑到系统差异，加上转义符<code>\;</code></p><p>这是 <code>find + grep</code> 直接搭配的一种写法。</p><h3 id="通过-xargs-把文件列表交给-grep">通过 <code>xargs</code>把文件列表交给 <code>grep</code></h3><p>有时我们需要先过滤或组合出文件列表，再进行搜索。如下示例先找所有 .log文件，然后查它们是否包含 “ERROR”：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log/ -name <span class="string">&#x27;*.log&#x27;</span> | xargs grep <span class="string">&quot;ERROR&quot;</span></span><br></pre></td></tr></table></figure><p>若想在搜索结果中显示文件名、行号等信息，可以再加 grep 参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log/ -name <span class="string">&#x27;*.log&#x27;</span> | xargs grep -Hn <span class="string">&quot;ERROR&quot;</span></span><br></pre></td></tr></table></figure><p>其中：</p><ul><li><code>H</code>：显示匹配所在文件名；</li><li><code>-n</code>：显示匹配行号。</li></ul><p><strong>避免 “Argument list too long” 问题</strong></p><p>如果文件特别多，可能出现“Argument list toolong”的报错。<code>xargs</code>默认一次性传递给命令的参数数量是有限的，但 <code>xargs</code>会自动分批提交给命令。另一个常见做法是加 <code>-print0 / -0</code>参数组合，保证文件名中若有空格或特殊字符，也能被安全识别。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 避免空格破坏</span></span><br><span class="line">find /home/user/ -name <span class="string">&#x27;*.txt&#x27;</span> -print0 | xargs -0 grep <span class="string">&quot;something&quot;</span></span><br></pre></td></tr></table></figure><ul><li><code>-print0</code>：让 find 用 NULL 字符做分隔符；</li><li><code>xargs -0</code>：xargs 以 NULL作为分隔符，防止空格或换行导致分割错误。</li></ul><hr><h2 id="更多实用示例">4. 更多实用示例</h2><p><strong>为每个文件创建一个备份</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /data/ -<span class="built_in">type</span> f -name <span class="string">&#x27;*.conf&#x27;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; &#123;&#125;.bak</span><br></pre></td></tr></table></figure><p>为所有 .conf 文件都复制一份 .bak 结尾的备份文件。</p><p><strong>大批量删除指定文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如要删除所有 .tmp 文件</span></span><br><span class="line">find /var/tmp -<span class="built_in">type</span> f -name <span class="string">&#x27;*.tmp&#x27;</span> | xargs <span class="built_in">rm</span> -f</span><br></pre></td></tr></table></figure><p><strong>组合 grep 与 xargs</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示 /etc/ 下所有 .cfg 文件中包含 &quot;port&quot; 的行</span></span><br><span class="line">find /etc/ -<span class="built_in">type</span> f -name <span class="string">&#x27;*.cfg&#x27;</span> | xargs grep -H <span class="string">&quot;port&quot;</span></span><br></pre></td></tr></table></figure><p><code>-H</code> 让 <code>grep</code> 显示匹配所在的文件名。</p><p><strong>查找所有报错的日志文件</strong></p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116232610514.png" alt="image-20250116232610514"><figcaption aria-hidden="true">image-20250116232610514</figcaption></figure><p><strong>找出系统中超过1M的txt，并且显示其文件具体的容量信息</strong></p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117113108624.png" alt="image-20250117113108624"><figcaption aria-hidden="true">image-20250117113108624</figcaption></figure><h1 id="四exec-与-ok">四、<code>exec</code> 与 <code>ok</code></h1><p>在使用 <code>find</code> 命令时，我们常见到<strong><code>-exec</code></strong> 和 <strong><code>-ok</code></strong>这两个选项，均可对匹配到的每一个结果（文件或目录）执行某条命令。它们的区别在于<strong>是否需要交互式确认</strong>。以下是它们的具体用法与示例。</p><h2 id="基本语法">1. 基本语法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find &lt;path&gt; [条件] -<span class="built_in">exec</span> &lt;命令&gt; &#123;&#125; \;</span><br><span class="line">find &lt;path&gt; [条件] -ok &lt;命令&gt; &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li><code>&#123;&#125;</code>：表示当前匹配到的文件或目录的占位符，<code>find</code>会用实际文件名替换它。</li><li><code>\;</code>：语句结尾标识，告诉 <code>find</code>结束当前命令。</li><li><code>-exec</code>：对每个搜索结果直接执行指定命令，无需用户确认。</li><li><code>-ok</code>：与 <code>-exec</code>类似，但在执行命令前会<strong>提示用户确认</strong>，按 y 或 n决定是否对该项执行命令。</li></ul><h2 id="exec-用法示例">2. -exec 用法示例</h2><h3 id="删除匹配的所有文件">删除匹配的所有文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /tmp -<span class="built_in">type</span> f -name <span class="string">&#x27;*.tmp&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> -f &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>在 /tmp 目录下查找所有后缀为 .tmp的文件，并直接删除（<code>rm -f</code>），不需用户确认。</p><h3 id="给所有匹配到的文件改权限">给所有匹配到的文件改权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/www -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; \;</span><br></pre></td></tr></table></figure><h3 id="批量移动复制文件">批量移动/复制文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /home/user -name <span class="string">&#x27;*.jpg&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">mv</span> &#123;&#125; /home/user/pictures/ \;</span><br></pre></td></tr></table></figure><p>将所有 .jpg 文件移动到指定目录 /home/user/pictures/。</p><blockquote><p><strong>注意</strong>：若匹配结果过多，一次执行可能出现“参数列表过长” 的情况，可改用 <code>-exec ... + 语法</code> 或<code>xargs</code> 处理。</p></blockquote><h2 id="ok-用法示例">3. -ok 用法示例</h2><h3 id="交互式删除">交互式删除</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /tmp -<span class="built_in">type</span> f -name <span class="string">&#x27;*.log&#x27;</span> -ok <span class="built_in">rm</span> -i &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li>查找 /tmp 下所有 .log 文件，针对每个文件执行<code>rm -i</code>，删除前会提示“确认是否删除”。</li><li>因为用了 <code>-ok</code>，在执行 <code>rm -i</code>前，<code>find</code> 也会先询问一次：<ul><li>类似于：<code>&lt; rm … ./filename &gt; ? y/n</code></li><li>选择 y 或 n 决定是否对当前匹配文件执行命令。</li></ul></li></ul><h3 id="安全操作">安全操作</h3><p>如果你想对某些关键目录下的文件执行敏感操作又不确定匹配范围是否准确，就可以用<code>-ok</code> 来逐一确认，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /etc -<span class="built_in">type</span> f -name <span class="string">&#x27;*.bak&#x27;</span> -ok <span class="built_in">rm</span> &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>这样在删除每个 .bak 文件之前都会询问，可避免误操作带来的损失。</p><h2 id="其他相关技巧">4. 其他相关技巧</h2><h3 id="用-替代-提升效率">用 <code>+</code> 替代 <code>\;</code>提升效率</h3><p>在较新的 <code>find</code> 版本里，可以使用 <code>-exec / -ok</code>并以 <code>+</code>结尾，将多个匹配结果一次性传给命令，而不是针对每个文件执行一次。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /logs -name <span class="string">&#x27;*.log&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; +</span><br></pre></td></tr></table></figure><p>此时 <code>find</code> 会把所有匹配文件收集后，一次性执行<code>rm file1 file2 file3 …</code>，通常比单次执行效率高。</p><h3 id="与管道符xargs-结合">与管道符、xargs 结合</h3><p>对于极多匹配结果或需要分批处理，可改用管道符及 <code>xargs</code>实现类似效果。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /data -name <span class="string">&#x27;*.tar.gz&#x27;</span> | xargs <span class="built_in">rm</span> -f</span><br></pre></td></tr></table></figure><p>或结合 <code>-ok</code> 功能用<code>xargs -p</code>（交互式询问）也可以实现安全删除等操作。</p><h1 id="五文件时间">五、文件时间</h1><p>我们知道 <code>stat 文件路径</code> 能显示文件的 Access、Modify 和Change 的时间：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117000312926.png" alt="image-20250117000312926"><figcaption aria-hidden="true">image-20250117000312926</figcaption></figure><p>这个时间是可以被修改的，修改方法为：</p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117000531537.png" alt="image-20250117000531537"><figcaption aria-hidden="true">image-20250117000531537</figcaption></figure><p>要查看最近几天 Modify 过的文件时间，可以这么写：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find 文件路径 -name <span class="string">&quot;xxx&quot;</span> -mtime +1 （+n 代表 n 天前，不加代表第 n 天，-n 代表 n 天内）</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117000855402.png" alt="image-20250117000855402"><figcaption aria-hidden="true">image-20250117000855402</figcaption></figure><h1 id="六linux-数据流和重定向">六、Linux 数据流和重定向</h1><p>Linux系统的标准输入、输出和错误输出可以通过文件描述符来管理。数据流通过这三个标准流进行输入和输出，通常我们会将数据流重定向到不同的文件或命令中，以便更好地管理和调试程序。</p><h2 id="标准输入输出与错误输出重定向">1.标准输入输出与错误输出重定向</h2><ul><li><strong>标准输入（stdin）</strong>：通常来自用户的键盘输入，也可以通过重定向从文件或其他命令获取，描述符为0。</li><li><strong>标准输出（stdout）</strong>：程序的输出结果，默认显示在屏幕上，也可以重定向到文件中，描述符为1。</li><li><strong>标准错误输出（stderr）</strong>：程序运行过程产生的错误信息，默认显示在屏幕上，可重定向到文件，描述符为2。</li></ul><h2 id="重定向的常见用法与示例">2. 重定向的常见用法与示例</h2><p><strong>常见用法：</strong></p><table><colgroup><col style="width: 6%"><col style="width: 53%"><col style="width: 40%"></colgroup><thead><tr><th>操作符</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>&gt;</code></td><td>将输出重定向到文件，覆盖原文件内容</td><td><code>echo "Hello, World!" &gt; output.txt</code></td></tr><tr><td><code>&gt;&gt;</code></td><td>将输出重定向到文件，追加内容到文件末尾</td><td><code>echo "Hello again!" &gt;&gt; output.txt</code></td></tr><tr><td><code>2&gt;</code></td><td>将错误输出重定向到文件，覆盖原文件内容</td><td><code>ls non_existent_file 2&gt; error.log</code></td></tr><tr><td><code>2&gt;&gt;</code></td><td>将错误输出重定向到文件，追加内容到文件末尾</td><td><code>ls non_existent_file 2&gt;&gt; error.log</code></td></tr><tr><td><code>&lt;</code></td><td>从文件中读取输入，将文件内容作为标准输入</td><td><code>sort &lt; input.txt</code></td></tr><tr><td><code>&amp;&gt;</code></td><td>同时将标准输出和标准错误输出重定向到文件</td><td><code>command &amp;&gt; output.log</code></td></tr><tr><td><code>2&gt;&amp;1</code></td><td>将标准错误输出重定向到标准输出的位置</td><td><code>command &gt; output.log 2&gt;&amp;1</code></td></tr><tr><td><code>|</code></td><td>管道符，用于将一个命令的输出作为另一个命令的输入</td><td><code>echo "Hello" | grep "Hello"</code></td></tr></tbody></table><p><strong>常见操作：</strong></p><ol type="1"><li><p><strong>将标准输出重定向到文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello, World!&quot;</span> &gt; output.txt</span><br></pre></td></tr></table></figure></li></ol><p>​ 这条命令将 "Hello, World!" 输出到 output.txt 文件中。</p><ol start="2" type="1"><li><p><strong>将标准错误输出重定向到文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> non_existent_file 2&gt; error.log</span><br></pre></td></tr></table></figure><p>如果文件不存在，错误信息会被写入 error.log 文件中。</p></li><li><p><strong>将标准输出和标准错误输出同时重定向到同一文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &gt; output.txt 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>这条命令将标准输出和标准错误输出都重定向到 output.txt 文件。</p></li><li><p><strong>输入重定向</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt; file.txt</span><br></pre></td></tr></table></figure><p>将 file.txt 文件的内容作为标准输入传递给 <code>cat</code>命令。</p></li></ol><p><strong>示例：</strong></p><figure><img src="/Linux-%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250208003322444.png" alt="image-20250208003322444"><figcaption aria-hidden="true">image-20250208003322444</figcaption></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;在命令行里真正拉开效率差距的能力，不是会多少命令，而是能不能把命令“拼起来”。管道符
&lt;code&gt;|&lt;/code&gt; 正是 Unix
哲学的核心：让每个小工具只做一件事，然后把它们串成一条清晰的数据流。本文不仅讲
&lt;code&gt;|&lt;/code&gt;
的语法，还会重点解释它在日志排查、文本过滤、统计汇总、批量处理里的典型套路：什么时候该用
&lt;code&gt;grep/awk/sort/uniq/wc&lt;/code&gt;，怎么逐层缩小范围，如何避免临时文件与重复劳动。你读完之后应该能把很多“要写脚本”的小需求，直接用一两行可读的命令解决，并且更容易看懂别人写的
one-liner。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux 文件操作深入解析</title>
    <link href="https://chenk.top/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/"/>
    <id>https://chenk.top/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/</id>
    <published>2025-01-17T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.325Z</updated>
    
    <content type="html"><![CDATA[<p>The pipe operator (<code>|</code>) is one of the best expressions ofthe Unix philosophy: build powerful workflows by chaining small tools,passing the output of one command into the next. This post explains howpipes actually work and how to use them to process text and logsefficiently—combining commands into reusable “one-liners” withoutwriting scripts. If you often find yourself copy‑pasting output betweencommands, pipes are the skill that will immediately change how you workin the terminal.</p><span id="more"></span><h1 id="一管道符">一、管道符</h1><h2 id="基本介绍">1. 基本介绍</h2><p>Linux 中，管道符 <code>|</code>的功能是将前一个命令的输出传递给下一个命令作为输入。这样可以把多个小型命令拼装起来，让每个命令只专注做一件事（符合UNIX的哲学：单一命令，简单而强大），通过管道连接成一条完整的处理流程。</p><ul><li><strong>语法</strong>：<code>命令1 | 命令2 [| 命令3 …]</code></li></ul><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/管道命令示意图.drawio.svg" alt="linux-管道pipe与xargs | SurprisedCat"><figcaption aria-hidden="true">linux-管道pipe与xargs |SurprisedCat</figcaption></figure><p>使用管道符的好处如下：</p><ol type="1"><li>避免产生临时文件：数据无需先写入文件再读出。</li><li>提高效率：分步处理可以快速对结果进行再次筛选、统计、过滤等。</li><li>简化语句：一行命令即可串起多个操作。</li></ol><h2 id="示例">2. 示例</h2><ol type="1"><li><p>基本使用示例：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250115232344692.png" alt="image-20250115232344692"><figcaption aria-hidden="true">image-20250115232344692</figcaption></figure><p>从上图可以看到， <code>echo "I love you" | wc -m</code> 返回11；另外当执行 <code>echo "I love you" | cat -E</code> 时，会在行末显示<code>$</code> 符号，说明末尾还有换行符的存在。管道符让我们可以将<code>echo</code> 命令输出，直接交给 <code>wc</code>、<code>cat</code>或其他命令进行统计、格式化、过滤等操作，而无需中间文件。</p></li><li><p><strong>查看日志内容时只取关键行</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/syslog | grep <span class="string">&#x27;error&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>多级管道</strong>：<code>ls -l /etc | grep conf | wc -l</code>（在<code>/etc</code> 下查找带有 <code>conf</code>的配置文件并统计数量）</p></li><li><p><strong>网络连接过滤</strong>：<code>netstat -an | grep LISTEN</code>（查看处于监听状态的端口）</p></li><li><p><strong>循环生成随机数输出到文档里</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;1..30&#125;; do echo `expr $&#123;RANDOM&#125; / 1000`; done &gt; rand_1000.txt</span><br></pre></td></tr></table></figure><p>可以 <code>cat</code> 一下文档看看内容：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201215547121.png" alt="image-20250201215547121"><figcaption aria-hidden="true">image-20250201215547121</figcaption></figure><p><strong>将随机数进行倒排：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat rand_1000.txt | sort -nr</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201214659228.png" alt="image-20250201214659228"><figcaption aria-hidden="true">image-20250201214659228</figcaption></figure><p>结果为：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201220826340.png" alt="image-20250201220826340"><figcaption aria-hidden="true">image-20250201220826340</figcaption></figure><p><strong>去重排序</strong>：</p><p>将要使用到的命令是 <code>uniq</code></p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201224329721.png" alt="image-20250201224329721"><figcaption aria-hidden="true">image-20250201224329721</figcaption></figure><p>我们需要首先对其排序后才能去重，还可以加 <code>-c</code>参数查看重复了多少次：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250201224555475.png" alt="image-20250201224555475"><figcaption aria-hidden="true">image-20250201224555475</figcaption></figure></li></ol><hr><h1 id="二grep-的基本概念与使用">二、grep 的基本概念与使用</h1><h2 id="基本介绍-1">1. 基本介绍</h2><p><code>grep</code> 是 Linux下极常用的文本搜索工具，通过模式匹配（包括正则表达式）筛选出符合条件的行。结合管道符，可以非常便捷地在输出数据中定位关键字。</p><p><strong>grep 基础命令</strong></p><ul><li><code>grep pattern file</code>：在文件中搜索<code>pattern</code>，打印匹配行。</li><li><code>command | grep pattern</code>：在命令输出中筛选包含<code>pattern</code> 的行。</li></ul><p><strong>常用参数</strong></p><ul><li><code>-i</code>：忽略大小写搜索。</li><li><code>-v</code>：反向匹配，只显示不包含关键字的行。</li><li><code>-n</code>：显示匹配结果所在行号。</li><li><code>-E</code> 或 <code>-P</code>：启用扩展正则或 Perl风格正则。</li></ul><hr><h2 id="示例-1">2. 示例</h2><h3 id="基本示例">基本示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在当前文件夹下检索含 &quot;TODO&quot; 的行</span></span><br><span class="line">grep <span class="string">&quot;TODO&quot;</span> *.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在命令输出中搜索：</span></span><br><span class="line"><span class="built_in">ls</span> -l /etc | grep conf</span><br></pre></td></tr></table></figure><p>若要反向匹配：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /etc | grep -v conf</span><br></pre></td></tr></table></figure><p>只显示不包含 conf 的行。</p><h3 id="ps--ef-grep-vim">ps -ef | grep vim</h3><p>在 Linux 下，<code>ps -ef</code>通常用于查看当前所有进程；通过管道连接 <code>grep</code>能快速查找特定的进程名或关键字。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps -ef | grep vim</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 用于检索当前系统上是否有 vim 进程在运行。</span></span><br><span class="line"><span class="comment"># 如果 vim 正在编辑文件，输出会显示vim进程信息，如PID、CMD等。</span></span><br></pre></td></tr></table></figure><p>在某个终端运行 vim 编辑某文件，而在另一个终端使用<code>ps -ef | grep vim</code>，我们可以看到当 vim正在编辑某文件时，对该文件持有句柄，导致文件处于占用状态。当执行<code>:wq!</code> 等命令退出 vim 后，vim会释放对应文件句柄，不再占用系统资源。若一直不退出（不释放句柄），则有可能导致内存或资源泄露。下图示例演示了<code>ps -ef | grep vim</code> 结果，<code>vim</code>进程正在运行中：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250115182224707.png" alt="image-20250115182224707"><figcaption aria-hidden="true">image-20250115182224707</figcaption></figure><p>文件占用示例里，只有在 vim 中执行 <code>:wq!</code>或其他合理退出方式后，文件句柄才正式释放；否则文件会一直处于被 vim进程占用状态。若长期不释放，系统会持续保留资源，占用内存，甚至导致“内存泄露”或类似的资源枯竭问题。</p><p><code>ps -ef</code>的用法遍布各个场景，如日志分析、网络监控、系统排查等等，如</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep ssh</span><br></pre></td></tr></table></figure><p>将查找系统中所有进程最后只输出带有 ssh 的进程行。<a href="https://man7.org/linux/man-pages/man1/ps.1.html"><code>ps</code>的其他参数如下</a>：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116221414587.png" alt="image-20250116221414587"><figcaption aria-hidden="true">image-20250116221414587</figcaption></figure><h3 id="查询进程">查询进程</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep nginx</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116223538445.png" alt="image-20250116223538445"><figcaption aria-hidden="true">image-20250116223538445</figcaption></figure><p>查找目前运行中的 nginx 进程，以便查看其 PID、运行用户等信息。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux | grep -v grep | grep vim</span><br></pre></td></tr></table></figure><p>有时 <code>grep vim</code> 本身也会被列入结果，可使用<code>-v grep</code> 排除包含“grep”的行。</p><blockquote><p>补充命令学习：<code>netstat -tunlp</code>是查看系统中的所有端口信息，和<code>ps -ef</code> 类似，都是查看系统中某资源信息的。LISTEN代表监听中，即等待用户连接中。</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116224105131.png" alt="image-20250116224105131"><figcaption aria-hidden="true">image-20250116224105131</figcaption></figure></blockquote><h3 id="过滤日志">过滤日志</h3><p><strong>将系统日志（syslog）中所有包含 error的行筛选出来</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /var/log/syslog | grep error</span><br></pre></td></tr></table></figure><p><strong>实时查看日志变化，只显示包含 usb的行，适合监控插拔事件或关键字出现</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">tail</span> -f /var/log/messages | grep usb</span><br></pre></td></tr></table></figure><p><strong>找出 /var/log 目录下哪些文件含passwd信息</strong></p><p><code>-R</code> 是递归查找的命令</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117113722343.png" alt="image-20250117113722343"><figcaption aria-hidden="true">image-20250117113722343</figcaption></figure><p>如果只想拿到文件名，加 <code>-l</code> 参数：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117114846009.png" alt="image-20250117114846009"><figcaption aria-hidden="true">image-20250117114846009</figcaption></figure><p><strong>找出 /var/log/ 下文件名包含 <code>boot</code> 的文件有哪些</strong></p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117115505355.png" alt="image-20250117115505355"><figcaption aria-hidden="true">image-20250117115505355</figcaption></figure><h3 id="多级筛选">多级筛选</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg | grep <span class="string">&#x27;eth0&#x27;</span> | grep -i <span class="string">&#x27;down&#x27;</span></span><br></pre></td></tr></table></figure><p>使用两次 grep 逐层过滤：先选含 eth0，再选含 down（不区分大小写可用-i）。</p><h3 id="结合-wcsortuniq-等命令">结合 wc、sort、uniq 等命令</h3><ol type="1"><li><p>统计匹配次数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> file.log | grep <span class="string">&quot;ERROR&quot;</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure></li></ol><p>​ 显示 <code>file.log</code> 中包含“ERROR”的行数。</p><ol start="2" type="1"><li><p>去重并统计：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /etc/passwd | grep <span class="string">&#x27;/bin/bash&#x27;</span> | <span class="built_in">sort</span> | <span class="built_in">uniq</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><p>找出使用 <code>/bin/bash</code> 作为 shell的用户，去重后统计用户数。</p></li><li><p>灵活组合</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -an | grep ESTABLISHED | grep <span class="string">&#x27;:80&#x27;</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></table></figure><p>显示当前 80 端口处于已建立连接状态的连接数量。</p></li></ol><h2 id="grep-的高级搜索技巧">3. grep 的高级搜索技巧</h2><h3 id="正则表达式">正则表达式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># grep -E (extended regex) 示例</span></span><br><span class="line"><span class="built_in">ls</span> -l | grep -E <span class="string">&#x27;^(d|l)&#x27;</span></span><br></pre></td></tr></table></figure><p>搜索以 d 或 l 开头的行（文件类型为目录 d 或链接l），显示目录或链接。</p><h3 id="显示上下文行">显示上下文行</h3><ul><li><code>-A n</code>：匹配行后面显示 n 行；</li><li><code>-B n</code>：匹配行前面显示 n 行；</li><li><code>-C n</code>：匹配行前后各显示 n 行；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -C 2 <span class="string">&quot;error&quot;</span> syslog</span><br></pre></td></tr></table></figure><p>匹配到 “error” 的行，并显示上下各 2 行上下文，以便快速定位问题。</p><h3 id="反向匹配">反向匹配</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /etc | grep -v conf</span><br></pre></td></tr></table></figure><p>列表中排除包含“conf”的文件行。</p><h1 id="三xargs">三、<code>xargs</code></h1><p>在 Linux/UNIX 环境中，很多命令（如<code>rm</code>、<code>cp</code>、<code>mv</code>等）可以一次接受较多参数，但是有时我们需要先通过<code>grep</code>、<code>find</code>等命令查到很多结果，再把这些结果逐个传给另外的命令去执行；若结果很多，直接把输出用<code>| command</code>有可能出现“参数列表过长”或命令无法正确解析的情况。</p><p><strong>xargs</strong>则是专门设计来解决这个需求的：它能<strong>从标准输入读取一行行或多行数据</strong>，再把它们当作参数传给指定命令。这样我们就能轻松地把“输出流”接给下一个命令，实现批量操作。</p><h2 id="基础用法">1. 基础用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;file1 file2 file3&quot;</span> | xargs <span class="built_in">rm</span></span><br></pre></td></tr></table></figure><p>这代表将 file1 file2 file3 交给 rm 命令，一次删除这些文件。</p><h2 id="i-与替换符">2. -i 与替换符</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">find /tmp/ -name <span class="string">&#x27;*.log&#x27;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; &#123;&#125;.bak</span><br><span class="line"><span class="comment">#   此命令会在 /tmp/ 下查找所有 .log 文件，并对每个文件执行：</span></span><br><span class="line"><span class="comment">#   cp filename filename.bak</span></span><br><span class="line"><span class="comment">#   相当于给每个 .log 文件都复制一份 .bak 结尾的备份。</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   find /tmp/ -name &#x27;*.log&#x27; -&gt; /tmp/a.log /tmp/b.log /tmp/subdir/c.log ...</span></span><br><span class="line"><span class="comment">#   这些结果被传给 xargs -i</span></span><br><span class="line"><span class="comment">#   xargs 将每个文件都替换到 &#123;&#125; 上执行:  cp /tmp/a.log /tmp/a.log.bak</span></span><br><span class="line"><span class="comment">#                                   cp /tmp/b.log /tmp/b.log.bak</span></span><br><span class="line"><span class="comment">#                                   cp /tmp/subdir/c.log /tmp/subdir/c.log.bak</span></span><br></pre></td></tr></table></figure><p>在示例 <code>find /tmp/ -name '*.log' | xargs -i cp &#123;&#125; &#123;&#125;.bak</code>中： • <code>-i</code> 选项允许我们使用占位符 <code>&#123;&#125;</code>来表示从上一个命令输出中得到的每一行文本； • <code>cp &#123;&#125; &#123;&#125;.bak</code>表示对于每一个 log 文件，用它自己的文件名作为<code>&#123;&#125;</code>，然后再在后面补 <code>.bak</code>，形成新文件名。</p><p>如果没有 <code>-i</code>，则 <code>xargs</code>默认把所有输出的文件拼成一行一行或多行参数传给命令，不会像替换符 {}这样灵活地组合不同的目标和源路径。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 另一个示例：将所有 .txt 文件复制到 ~/backup/ 下</span></span><br><span class="line">find . -name <span class="string">&#x27;*.txt&#x27;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; backup/</span><br></pre></td></tr></table></figure><h2 id="批量查询文本是否包含某信息">3. 批量查询文本是否包含某信息</h2><p>当我们想要在一堆文件里搜索某字符串、某信息或某正则模式时，最直接的工具往往是<strong><code>grep</code></strong>。如果我们已经有了一份文件列表（如在某个文本文件里，或通过<code>find</code> 找到），也可以配合 <code>xargs</code>来实现批量查询。</p><h3 id="使用-grep-自带的批量搜索">使用 <code>grep</code>自带的批量搜索</h3><p>其实最简单的是，直接在 <code>grep</code> 后面跟多个文件参数，如：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;关键字&quot;</span> file1 file2 file3 ...</span><br></pre></td></tr></table></figure></p><p>或结合 <code>find</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path -name <span class="string">&#x27;*.txt&#x27;</span> -<span class="built_in">exec</span> grep <span class="string">&quot;关键字&quot;</span> &#123;&#125; \; </span><br></pre></td></tr></table></figure><p>这里 <code>-exec</code>命令是跟着shell的命令，结尾必须以分号结束，考虑到系统差异，加上转义符<code>\;</code></p><p>这是 <code>find + grep</code> 直接搭配的一种写法。</p><h3 id="通过-xargs-把文件列表交给-grep">通过 <code>xargs</code>把文件列表交给 <code>grep</code></h3><p>有时我们需要先过滤或组合出文件列表，再进行搜索。如下示例先找所有 .log文件，然后查它们是否包含 “ERROR”：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log/ -name <span class="string">&#x27;*.log&#x27;</span> | xargs grep <span class="string">&quot;ERROR&quot;</span></span><br></pre></td></tr></table></figure><p>若想在搜索结果中显示文件名、行号等信息，可以再加 grep 参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/log/ -name <span class="string">&#x27;*.log&#x27;</span> | xargs grep -Hn <span class="string">&quot;ERROR&quot;</span></span><br></pre></td></tr></table></figure><p>其中：</p><ul><li><code>H</code>：显示匹配所在文件名；</li><li><code>-n</code>：显示匹配行号。</li></ul><p><strong>避免 “Argument list too long” 问题</strong></p><p>如果文件特别多，可能出现“Argument list toolong”的报错。<code>xargs</code>默认一次性传递给命令的参数数量是有限的，但 <code>xargs</code>会自动分批提交给命令。另一个常见做法是加 <code>-print0 / -0</code>参数组合，保证文件名中若有空格或特殊字符，也能被安全识别。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 避免空格破坏</span></span><br><span class="line">find /home/user/ -name <span class="string">&#x27;*.txt&#x27;</span> -print0 | xargs -0 grep <span class="string">&quot;something&quot;</span></span><br></pre></td></tr></table></figure><ul><li><code>-print0</code>：让 find 用 NULL 字符做分隔符；</li><li><code>xargs -0</code>：xargs 以 NULL作为分隔符，防止空格或换行导致分割错误。</li></ul><hr><h2 id="更多实用示例">4. 更多实用示例</h2><p><strong>为每个文件创建一个备份</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /data/ -<span class="built_in">type</span> f -name <span class="string">&#x27;*.conf&#x27;</span> | xargs -i <span class="built_in">cp</span> &#123;&#125; &#123;&#125;.bak</span><br></pre></td></tr></table></figure><p>为所有 .conf 文件都复制一份 .bak 结尾的备份文件。</p><p><strong>大批量删除指定文件</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 比如要删除所有 .tmp 文件</span></span><br><span class="line">find /var/tmp -<span class="built_in">type</span> f -name <span class="string">&#x27;*.tmp&#x27;</span> | xargs <span class="built_in">rm</span> -f</span><br></pre></td></tr></table></figure><p><strong>组合 grep 与 xargs</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示 /etc/ 下所有 .cfg 文件中包含 &quot;port&quot; 的行</span></span><br><span class="line">find /etc/ -<span class="built_in">type</span> f -name <span class="string">&#x27;*.cfg&#x27;</span> | xargs grep -H <span class="string">&quot;port&quot;</span></span><br></pre></td></tr></table></figure><p><code>-H</code> 让 <code>grep</code> 显示匹配所在的文件名。</p><p><strong>查找所有报错的日志文件</strong></p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250116232610514.png" alt="image-20250116232610514"><figcaption aria-hidden="true">image-20250116232610514</figcaption></figure><p><strong>找出系统中超过1M的txt，并且显示其文件具体的容量信息</strong></p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117113108624.png" alt="image-20250117113108624"><figcaption aria-hidden="true">image-20250117113108624</figcaption></figure><h1 id="四exec-与-ok">四、<code>exec</code> 与 <code>ok</code></h1><p>在使用 <code>find</code> 命令时，我们常见到<strong><code>-exec</code></strong> 和 <strong><code>-ok</code></strong>这两个选项，均可对匹配到的每一个结果（文件或目录）执行某条命令。它们的区别在于<strong>是否需要交互式确认</strong>。以下是它们的具体用法与示例。</p><h2 id="基本语法">1. 基本语法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find &lt;path&gt; [条件] -<span class="built_in">exec</span> &lt;命令&gt; &#123;&#125; \;</span><br><span class="line">find &lt;path&gt; [条件] -ok &lt;命令&gt; &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>其中：</p><ul><li><code>&#123;&#125;</code>：表示当前匹配到的文件或目录的占位符，<code>find</code>会用实际文件名替换它。</li><li><code>\;</code>：语句结尾标识，告诉 <code>find</code>结束当前命令。</li><li><code>-exec</code>：对每个搜索结果直接执行指定命令，无需用户确认。</li><li><code>-ok</code>：与 <code>-exec</code>类似，但在执行命令前会<strong>提示用户确认</strong>，按 y 或 n决定是否对该项执行命令。</li></ul><h2 id="exec-用法示例">2. -exec 用法示例</h2><h3 id="删除匹配的所有文件">删除匹配的所有文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /tmp -<span class="built_in">type</span> f -name <span class="string">&#x27;*.tmp&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> -f &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>在 /tmp 目录下查找所有后缀为 .tmp的文件，并直接删除（<code>rm -f</code>），不需用户确认。</p><h3 id="给所有匹配到的文件改权限">给所有匹配到的文件改权限</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /var/www -<span class="built_in">type</span> f -<span class="built_in">exec</span> <span class="built_in">chmod</span> 644 &#123;&#125; \;</span><br></pre></td></tr></table></figure><h3 id="批量移动复制文件">批量移动/复制文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /home/user -name <span class="string">&#x27;*.jpg&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">mv</span> &#123;&#125; /home/user/pictures/ \;</span><br></pre></td></tr></table></figure><p>将所有 .jpg 文件移动到指定目录 /home/user/pictures/。</p><blockquote><p><strong>注意</strong>：若匹配结果过多，一次执行可能出现“参数列表过长” 的情况，可改用 <code>-exec ... + 语法</code> 或<code>xargs</code> 处理。</p></blockquote><h2 id="ok-用法示例">3. -ok 用法示例</h2><h3 id="交互式删除">交互式删除</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /tmp -<span class="built_in">type</span> f -name <span class="string">&#x27;*.log&#x27;</span> -ok <span class="built_in">rm</span> -i &#123;&#125; \;</span><br></pre></td></tr></table></figure><ul><li>查找 /tmp 下所有 .log 文件，针对每个文件执行<code>rm -i</code>，删除前会提示“确认是否删除”。</li><li>因为用了 <code>-ok</code>，在执行 <code>rm -i</code>前，<code>find</code> 也会先询问一次：<ul><li>类似于：<code>&lt; rm … ./filename &gt; ? y/n</code></li><li>选择 y 或 n 决定是否对当前匹配文件执行命令。</li></ul></li></ul><h3 id="安全操作">安全操作</h3><p>如果你想对某些关键目录下的文件执行敏感操作又不确定匹配范围是否准确，就可以用<code>-ok</code> 来逐一确认，如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /etc -<span class="built_in">type</span> f -name <span class="string">&#x27;*.bak&#x27;</span> -ok <span class="built_in">rm</span> &#123;&#125; \;</span><br></pre></td></tr></table></figure><p>这样在删除每个 .bak 文件之前都会询问，可避免误操作带来的损失。</p><h2 id="其他相关技巧">4. 其他相关技巧</h2><h3 id="用-替代-提升效率">用 <code>+</code> 替代 <code>\;</code>提升效率</h3><p>在较新的 <code>find</code> 版本里，可以使用 <code>-exec / -ok</code>并以 <code>+</code>结尾，将多个匹配结果一次性传给命令，而不是针对每个文件执行一次。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /logs -name <span class="string">&#x27;*.log&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; +</span><br></pre></td></tr></table></figure><p>此时 <code>find</code> 会把所有匹配文件收集后，一次性执行<code>rm file1 file2 file3 …</code>，通常比单次执行效率高。</p><h3 id="与管道符xargs-结合">与管道符、xargs 结合</h3><p>对于极多匹配结果或需要分批处理，可改用管道符及 <code>xargs</code>实现类似效果。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /data -name <span class="string">&#x27;*.tar.gz&#x27;</span> | xargs <span class="built_in">rm</span> -f</span><br></pre></td></tr></table></figure><p>或结合 <code>-ok</code> 功能用<code>xargs -p</code>（交互式询问）也可以实现安全删除等操作。</p><h1 id="五文件时间">五、文件时间</h1><p>我们知道 <code>stat 文件路径</code> 能显示文件的 Access、Modify 和Change 的时间：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117000312926.png" alt="image-20250117000312926"><figcaption aria-hidden="true">image-20250117000312926</figcaption></figure><p>这个时间是可以被修改的，修改方法为：</p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117000531537.png" alt="image-20250117000531537"><figcaption aria-hidden="true">image-20250117000531537</figcaption></figure><p>要查看最近几天 Modify 过的文件时间，可以这么写：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find 文件路径 -name <span class="string">&quot;xxx&quot;</span> -mtime +1 （+n 代表 n 天前，不加代表第 n 天，-n 代表 n 天内）</span><br></pre></td></tr></table></figure><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250117000855402.png" alt="image-20250117000855402"><figcaption aria-hidden="true">image-20250117000855402</figcaption></figure><h1 id="六linux-数据流和重定向">六、Linux 数据流和重定向</h1><p>Linux系统的标准输入、输出和错误输出可以通过文件描述符来管理。数据流通过这三个标准流进行输入和输出，通常我们会将数据流重定向到不同的文件或命令中，以便更好地管理和调试程序。</p><h2 id="标准输入输出与错误输出重定向">1.标准输入输出与错误输出重定向</h2><ul><li><strong>标准输入（stdin）</strong>：通常来自用户的键盘输入，也可以通过重定向从文件或其他命令获取，描述符为0。</li><li><strong>标准输出（stdout）</strong>：程序的输出结果，默认显示在屏幕上，也可以重定向到文件中，描述符为1。</li><li><strong>标准错误输出（stderr）</strong>：程序运行过程产生的错误信息，默认显示在屏幕上，可重定向到文件，描述符为2。</li></ul><h2 id="重定向的常见用法与示例">2. 重定向的常见用法与示例</h2><p><strong>常见用法：</strong></p><table><colgroup><col style="width: 6%"><col style="width: 53%"><col style="width: 40%"></colgroup><thead><tr><th>操作符</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>&gt;</code></td><td>将输出重定向到文件，覆盖原文件内容</td><td><code>echo "Hello, World!" &gt; output.txt</code></td></tr><tr><td><code>&gt;&gt;</code></td><td>将输出重定向到文件，追加内容到文件末尾</td><td><code>echo "Hello again!" &gt;&gt; output.txt</code></td></tr><tr><td><code>2&gt;</code></td><td>将错误输出重定向到文件，覆盖原文件内容</td><td><code>ls non_existent_file 2&gt; error.log</code></td></tr><tr><td><code>2&gt;&gt;</code></td><td>将错误输出重定向到文件，追加内容到文件末尾</td><td><code>ls non_existent_file 2&gt;&gt; error.log</code></td></tr><tr><td><code>&lt;</code></td><td>从文件中读取输入，将文件内容作为标准输入</td><td><code>sort &lt; input.txt</code></td></tr><tr><td><code>&amp;&gt;</code></td><td>同时将标准输出和标准错误输出重定向到文件</td><td><code>command &amp;&gt; output.log</code></td></tr><tr><td><code>2&gt;&amp;1</code></td><td>将标准错误输出重定向到标准输出的位置</td><td><code>command &gt; output.log 2&gt;&amp;1</code></td></tr><tr><td><code>|</code></td><td>管道符，用于将一个命令的输出作为另一个命令的输入</td><td><code>echo "Hello" | grep "Hello"</code></td></tr></tbody></table><p><strong>常见操作：</strong></p><ol type="1"><li><p><strong>将标准输出重定向到文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello, World!&quot;</span> &gt; output.txt</span><br></pre></td></tr></table></figure></li></ol><p>​ 这条命令将 "Hello, World!" 输出到 output.txt 文件中。</p><ol start="2" type="1"><li><p><strong>将标准错误输出重定向到文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> non_existent_file 2&gt; error.log</span><br></pre></td></tr></table></figure><p>如果文件不存在，错误信息会被写入 error.log 文件中。</p></li><li><p><strong>将标准输出和标准错误输出同时重定向到同一文件</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span> &gt; output.txt 2&gt;&amp;1</span><br></pre></td></tr></table></figure><p>这条命令将标准输出和标准错误输出都重定向到 output.txt 文件。</p></li><li><p><strong>输入重定向</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt; file.txt</span><br></pre></td></tr></table></figure><p>将 file.txt 文件的内容作为标准输入传递给 <code>cat</code>命令。</p></li></ol><p><strong>示例：</strong></p><figure><img src="/Linux%20%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90/image-20250208003322444.png" alt="image-20250208003322444"><figcaption aria-hidden="true">image-20250208003322444</figcaption></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;The pipe operator (&lt;code&gt;|&lt;/code&gt;) is one of the best expressions of
the Unix philosophy: build powerful workflows by chaining small tools,
passing the output of one command into the next. This post explains how
pipes actually work and how to use them to process text and logs
efficiently—combining commands into reusable “one-liners” without
writing scripts. If you often find yourself copy‑pasting output between
commands, pipes are the skill that will immediately change how you work
in the terminal.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux Vim 解析</title>
    <link href="https://chenk.top/Linux-Vim-%E8%A7%A3%E6%9E%90/"/>
    <id>https://chenk.top/Linux-Vim-%E8%A7%A3%E6%9E%90/</id>
    <published>2025-01-11T16:00:00.000Z</published>
    <updated>2026-01-28T01:24:05.434Z</updated>
    
    <content type="html"><![CDATA[<p>很多人学 Vim的挫败感，来自“记了很多快捷键，但不知道该怎么组成一套顺手的编辑流程”。Vim的核心其实只有一件事：<strong>模式化编辑</strong>——用少量的模式 +可组合的动作（motion）与操作符（operator），把“移动—选择—修改”变成可重复、可迁移的肌肉记忆。本文会从最常用的几种模式开始，讲清楚每种模式负责什么、该什么时候切换；再把高频的移动、删除/复制/粘贴、撤销/重做、搜索/替换、块编辑等整理成一套能直接上手的练习路径。读完你应该能用Vim 完成日常写代码/改配置的 80% 操作，并且知道剩下 20%该去哪里查、怎么组合出来。</p><span id="more"></span><h1 id="一vim-常用模式与操作">一、Vim 常用模式与操作</h1><p>Vim的精髓在于“模式化编辑”，不同模式下按键功能不同，组合操作可以极大提升编辑效率。下列是几个核心模式：</p><ol type="1"><li><strong>普通模式（Normal Mode）</strong>：Vim启动后默认进入的模式，用于导航、删除、复制等操作。<br></li><li><strong>插入模式（Insert Mode）</strong>：按<code>i</code>、<code>a</code>、<code>o</code>等键进入，可进行正常的文本输入。<br></li><li><strong>可视模式（Visual Mode）</strong>：按<code>v</code>（字符可视模式）、<code>V</code>（行可视模式）或<code>Ctrl + v</code>（块可视模式）进入，用于批量选定文本后再执行批量操作。<br></li><li><strong>命令模式（Command Mode）</strong>：在普通模式下按<code>:</code> 进入，执行如保存、替换等命令。<br></li><li><strong>替换模式（Replace Mode）</strong>：按 <code>R</code>进入，输入的新字符将覆盖光标后的文本。</li></ol><p>退出回到普通模式只需按 <code>Esc</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如，在普通模式下执行删除操作：</span></span><br><span class="line"><span class="comment"># dd  -&gt; 删除当前行</span></span><br><span class="line"><span class="comment"># dw  -&gt; 删除一个单词</span></span><br><span class="line"><span class="comment"># x   -&gt; 删除当前字符</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 在可视模式下快速选中多行：</span></span><br><span class="line"><span class="comment"># v   -&gt; 进入字符可视模式</span></span><br><span class="line"><span class="comment"># j   -&gt; 向下移动选中多行</span></span><br><span class="line"><span class="comment"># d   -&gt; 删除选中的所有行</span></span><br></pre></td></tr></table></figure><h2 id="文件操作">1. 文件操作</h2><ul><li><code>:w</code>：保存文件（Write）。<br></li><li><code>:q</code>：退出（Quit）。<br></li><li><code>:wq</code> 或 <code>:x</code>：保存并退出。<br></li><li><code>:q!</code>：强制退出，不保存更改。<br></li><li><code>:e filename</code>：打开或编辑新的文件。<br></li><li><code>:saveas filename</code>：另存为指定文件。（或者<code>:w 文件路径</code>）</li></ul><p>这些命令都需要先进入命令模式（在普通模式下按 <code>:</code>）。</p><h2 id="光标移动与翻屏">2. 光标移动与翻屏</h2><ul><li><code>h / j / k / l</code>：分别向左、下、上、右移动一个字符。<br></li><li><code>0</code>：移动到行首，<code>^</code>：移动到本行第一个非空字符。<br></li><li><code>$</code>：移动到行尾。<br></li><li><code>w / b</code>：向后/向前移动一个单词。<br></li><li><code>Ctrl + f</code> /<code>Ctrl + b</code>：向下/向上翻一屏。</li><li><code>gg</code>：移动到文件开头，<code>G</code>：移动到文件末尾。</li><li><code>&#123;number&#125;G</code>：移动到指定行号。</li></ul><h2 id="删除复制粘贴与撤销">3. 删除、复制、粘贴与撤销</h2><ul><li><strong>删除</strong><ul><li><code>x</code>：删除当前光标字符。<br></li><li><code>dd</code>：删除当前行。<br></li><li><code>d&#123;motion&#125;</code>：配合移动指令一次性删除，比如 <code>dw</code>删至下个单词开头、<code>d$</code> 删至行尾。</li><li><code>G</code>：删除当前行的该位置到最后的所有内容</li></ul></li><li><strong>复制（yank）</strong><ul><li><code>yy</code>：复制当前行。<br></li><li><code>y&#123;motion&#125;</code>：配合移动指令复制一定范围（如 <code>yw</code>复制一个单词）。<br></li></ul></li><li><strong>粘贴</strong><ul><li><code>p</code>：在光标后粘贴（粘贴到下一行或光标右侧）。<br></li><li><code>P</code>：在光标前粘贴（粘贴到上一行或光标左侧）。<br></li><li>要粘贴大量代码或者配置文件，可能会被自动注释，建议先进入<code>:set paste</code> 模式。</li></ul></li><li><strong>撤销与重做</strong><ul><li><code>u</code>：撤销最近一次操作。<br></li><li><code>Ctrl + r</code>：重做被撤销的操作。</li></ul></li></ul><h2 id="剪切移动文本">4. 剪切（移动文本）</h2><ul><li><code>dd</code>：删除当前行，也可视为剪切当前行。<br></li><li>复制并删除原位置的组合，等效于剪切后粘贴到目标位置。例如：<ol type="1"><li><code>dd</code>（剪切一行）</li><li>移动光标到目标行</li><li><code>p</code>（粘贴）</li></ol></li></ul><h2 id="命令模式下常用命令">5. 命令模式下常用命令</h2><ul><li><code>:set number</code>：显示行号。<br></li><li><code>:noh</code>：取消搜索高亮。<br></li><li><code>:maps</code> / <code>:verbose map</code>等：查看当前映射（可用于排查快捷键冲突）。<br></li><li><code>:!命令</code>：执行外部命令，如 <code>:!ls</code>列出当前目录。</li></ul><h1 id="二vim-高级应用">二、Vim 高级应用</h1><h2 id="多窗口与分屏">1. 多窗口与分屏</h2><p>对于大文件或多文件协同查看，Vim 提供了强大的分屏与多窗口功能：</p><ul><li><p><code>:split</code> 或<code>:sp</code>：水平分割当前窗口。</p></li><li><p><code>:vsplit</code> 或<code>:vsp</code>：垂直分割当前窗口。</p></li><li><p><code>Ctrl + w</code> 后跟<code>h/j/k/l</code>：在分割窗口之间移动光标。</p></li><li><p><code>:close</code>：关闭当前分割窗口。</p></li><li><p><code>:only</code>：保留当前窗口并关闭其他所有分屏。</p></li><li><p><code>:tabnew</code>：新建标签页，类似浏览器多标签模式。</p></li><li><p><code>gt</code> / <code>gT</code>：在标签页之间切换。</p></li><li><p>多人打开一个文件，会有一个 <code>swp</code>文件，<code>vim</code>该文件会提示你可以进行的操作：继续、不管、退出等。</p><figure><img src="/Linux-Vim-%E8%A7%A3%E6%9E%90/image-20250113231311535.png" alt="image-20250113231311535"><figcaption aria-hidden="true">image-20250113231311535</figcaption></figure><p>或者没有正常退出也会出现这个问题，不要数据的话直接删掉<code>swp</code> 文件就行，要数据的话 <code>vim</code>原始的文件，进行命令选择，之后再删除 <code>swp</code> 文件。</p></li></ul><p>灵活运用分屏和多标签，可以同时查看多个文件或多个部分，提高编辑与对比效率。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以试试在同一文件中查看不同位置：</span></span><br><span class="line"><span class="comment"># :split</span></span><br><span class="line"><span class="comment"># :vsplit</span></span><br><span class="line"><span class="comment"># 然后使用 Ctrl + w + h/j/k/l 在各窗口之间切换</span></span><br></pre></td></tr></table></figure><h2 id="宏录制与应用">2. 宏录制与应用</h2><p>在处理重复性操作时，Vim的宏功能特别高效。可以将一系列操作录制下来，然后对其他文本执行相同操作。</p><ul><li><code>q&#123;register&#125;</code>：开始录制宏到指定寄存器（如<code>q a</code> 录制到 <code>a</code> 寄存器）。</li><li>任意编辑操作（如移动、删除、插入文本）。</li><li><code>q</code>：停止录制。</li><li><code>@&#123;register&#125;</code>：调用宏（执行刚才录制的步骤）。</li><li><code>@@</code>：重复上一次调用的宏。</li></ul><p>若需多次重复，只需在普通模式下输入<code>&#123;number&#125;@&#123;register&#125;</code>，就能批量执行宏。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 宏录制实例：</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1. 在普通模式下输入：qa （开始录制到寄存器 a）</span></span><br><span class="line"><span class="comment"># 2. 进行一系列操作，如 dd（删除行），p（粘贴），j（下移一行）</span></span><br><span class="line"><span class="comment"># 3. 输入 q 结束录制</span></span><br><span class="line"><span class="comment"># 4. @a  -&gt; 执行宏</span></span><br><span class="line"><span class="comment"># 5. 10@a -&gt; 执行宏 10 次</span></span><br></pre></td></tr></table></figure><h2 id="代码折叠">3. 代码折叠</h2><p>当你需要在大文件中专注于某个代码块或区域时，可以使用折叠功能隐藏不关心的部分：</p><ul><li><code>zR</code>：展开所有折叠。</li><li><code>zM</code>：折叠所有。</li><li><code>za</code>：切换当前块折叠/展开状态。</li><li><code>zc</code>：折叠当前代码块。</li><li><code>zo</code>：展开当前代码块。</li></ul><p>这在查看函数、类或配置文件的片段时尤为实用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若有一个大函数，可以在函数块内键入：</span></span><br><span class="line"><span class="comment"># zc -&gt; 折叠当前块</span></span><br><span class="line"><span class="comment"># za -&gt; 切换当前块折叠状态</span></span><br></pre></td></tr></table></figure><h2 id="批量替换">4. 批量替换</h2><p>Vim 支持非常灵活的替换和正则匹配。基本格式为：</p><p><code>:s/旧内容/新内容/g</code><br>仅替换当前行所有匹配，不加 <code>g</code> 就只会匹配第一个。</p><p><code>:%s/旧内容/新内容/g</code> 替换整个文件所有匹配。</p><p>需要更精细的范围时，可以在命令前加行号或选中可视模式后输入<code>:s</code> 命令。</p><ul><li><code>:10,20s/foo/bar/g</code>：仅在第 10~20 行执行替换。</li><li>正则表达式可极大增强替换能力，例如匹配复杂模式并加入分组。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 例如，将所有 &quot;TODO&quot; 替换为 &quot;DONE&quot;：</span></span><br><span class="line"><span class="comment"># :%s/TODO/DONE/g</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 将 10 行到 20 行之间的 &quot;abc&quot; 替换为 &quot;xyz&quot;：</span></span><br><span class="line"><span class="comment"># :10,20s/abc/xyz/g</span></span><br></pre></td></tr></table></figure><h2 id="自定义与配置">5. 自定义与配置</h2><p>Vim 可以高度定制，通过修改 <code>~/.vimrc</code>（或<code>~/.config/nvim/init.vim</code> 在 Neovim 中）实现个性化配置：</p><ul><li><code>set number</code>：显示行号。</li><li><code>set expandtab</code>、<code>set tabstop=4</code>、<code>set shiftwidth=4</code>：控制Tab 与缩进。</li><li><code>syntax on</code>：开启语法高亮。高亮的两种方式：<ul><li>修改文件后缀</li><li>加文件头，例如：<ul><li><code>#! /bin/bash</code></li><li><code>#! /usr/bin/python</code>，加完之后退出重进</li></ul></li></ul></li><li><code>set relativenumber</code>：相对行号，方便行距离计算。</li><li>使用 <strong>autocmd</strong>设置自动命令，如保存前自动去除行尾空白等。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 典型 .vimrc 示例如下：</span></span><br><span class="line"><span class="built_in">set</span> number</span><br><span class="line"><span class="built_in">set</span> expandtab</span><br><span class="line"><span class="built_in">set</span> tabstop=4</span><br><span class="line"><span class="built_in">set</span> shiftwidth=4</span><br><span class="line">syntax on</span><br><span class="line"><span class="built_in">set</span> cursorline</span><br><span class="line">autocmd BufWritePre * :%s/\s\+$//e</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;很多人学 Vim
的挫败感，来自“记了很多快捷键，但不知道该怎么组成一套顺手的编辑流程”。Vim
的核心其实只有一件事：&lt;strong&gt;模式化编辑&lt;/strong&gt;——用少量的模式 +
可组合的动作（motion）与操作符（operator），把“移动—选择—修改”变成可重复、可迁移的肌肉记忆。本文会从最常用的几种模式开始，讲清楚每种模式负责什么、该什么时候切换；再把高频的移动、删除/复制/粘贴、撤销/重做、搜索/替换、块编辑等整理成一套能直接上手的练习路径。读完你应该能用
Vim 完成日常写代码/改配置的 80% 操作，并且知道剩下 20%
该去哪里查、怎么组合出来。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Vim Essentials (Modal Editing in Practice)</title>
    <link href="https://chenk.top/Linux%20Vim%20%E8%A7%A3%E6%9E%90/"/>
    <id>https://chenk.top/Linux%20Vim%20%E8%A7%A3%E6%9E%90/</id>
    <published>2025-01-11T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.326Z</updated>
    
    <content type="html"><![CDATA[<p>Vim’s core idea is <strong>modal editing</strong>: the same keys dodifferent things depending on the mode, which enables extremely fastnavigation and editing once the workflow “clicks.” This post breaks downthe key modes (normal/insert/visual/command-line), the most usefulmotions and text objects, and the handful of patterns that make Vim feelefficient instead of overwhelming. If you want a practical path to“editing at speed” rather than memorizing random shortcuts, starthere.</p><span id="more"></span><h1 id="essential-modes-and-operations">1. Essential modes andoperations</h1><p>Vim is built around <strong>modes</strong>: the same keys dodifferent things depending on the mode. Once you understand how modescombine with motions and operators, editing becomes fast andpredictable. The core modes are:</p><ol type="1"><li><strong>Normal mode</strong>: Vim’s default mode for navigation andediting commands (delete/yank/paste).<br></li><li><strong>Insert mode</strong>: enter with <code>i</code>,<code>a</code>, <code>o</code>, etc. for regular typing.<br></li><li><strong>Visual mode</strong>: <code>v</code> (character),<code>V</code> (line), or <code>Ctrl+v</code> (block) to select text andapply operations in bulk.<br></li><li><strong>Command-line mode</strong>: press <code>:</code> in Normalmode to run Ex commands (save/quit/search/replace, etc.).<br></li><li><strong>Replace mode</strong>: press <code>R</code> to overwritetext as you type.</li></ol><p>Press <code>Esc</code> to return to Normal mode.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Examples (Normal mode):</span></span><br><span class="line"><span class="comment"># dd  -&gt; delete current line</span></span><br><span class="line"><span class="comment"># dw  -&gt; delete a word</span></span><br><span class="line"><span class="comment"># x   -&gt; delete character under cursor</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Visual mode (select multiple lines quickly):</span></span><br><span class="line"><span class="comment"># v   -&gt; enter Visual (character) mode</span></span><br><span class="line"><span class="comment"># j   -&gt; extend selection downward</span></span><br><span class="line"><span class="comment"># d   -&gt; delete the selected text</span></span><br></pre></td></tr></table></figure><h2 id="file-operations">1. File operations</h2><ul><li><code>:w</code>: write (save).<br></li><li><code>:q</code>: quit.<br></li><li><code>:wq</code> or <code>:x</code>: save and quit.<br></li><li><code>:q!</code>: quit without saving.<br></li><li><code>:e filename</code>: open/edit another file.<br></li><li><code>:saveas filename</code>: save as (you can also do<code>:w /path/to/file</code>).</li></ul><p>These are Ex commands, entered after pressing <code>:</code> fromNormal mode.</p><h2 id="cursor-movement-and-paging">2. Cursor movement and paging</h2><ul><li><code>h / j / k / l</code>: left / down / up / right by onecharacter.<br></li><li><code>0</code>: start of line; <code>^</code>: first non-blankcharacter.<br></li><li><code>$</code>: end of line.<br></li><li><code>w / b</code>: next / previous word.<br></li><li><code>Ctrl+f</code> / <code>Ctrl+b</code>: page down / up.</li><li><code>gg</code>: top of file; <code>G</code>: bottom of file.</li><li><code>&#123;number&#125;G</code>: jump to a specific line.</li></ul><h2 id="delete-yank-paste-undo">3. Delete, yank, paste, undo</h2><ul><li><strong>Delete</strong><ul><li><code>x</code>: delete character under cursor.<br></li><li><code>dd</code>: delete current line.<br></li><li><code>d&#123;motion&#125;</code>: delete a range defined by a motion (e.g.<code>dw</code>, <code>d$</code>).</li><li><code>G</code>: from the current line position to end of file(combined with operators like <code>dG</code>).</li></ul></li><li><strong>Yank (copy)</strong><ul><li><code>yy</code>: yank current line.<br></li><li><code>y&#123;motion&#125;</code>: yank a range (e.g. <code>yw</code> for aword).<br></li></ul></li><li><strong>Paste</strong><ul><li><code>p</code>: paste after cursor / below.<br></li><li><code>P</code>: paste before cursor / above.<br></li><li>For large pastes, consider paste mode: <code>:set paste</code> (andlater <code>:set nopaste</code>).</li></ul></li><li><strong>Undo / redo</strong><ul><li><code>u</code>: undo.<br></li><li><code>Ctrl+r</code>: redo.</li></ul></li></ul><h2 id="cut-move-text">4. Cut (move text)</h2><ul><li><code>dd</code> deletes the line and puts it into a register (so itbehaves like “cut”).<br></li><li>A typical move workflow:<ol type="1"><li><code>dd</code> (cut a line)</li><li>move the cursor</li><li><code>p</code> (paste)</li></ol></li></ul><h2 id="handy-command-line-commands">5. Handy command-line commands</h2><ul><li><code>:set number</code>: show line numbers.<br></li><li><code>:noh</code>: clear search highlights.<br></li><li><code>:map</code> / <code>:verbose map</code>: inspect mappings(useful for debugging keybinding conflicts).<br></li><li><code>:!&lt;command&gt;</code>: run a shell command, e.g.<code>:!ls</code>.</li></ul><h1 id="advanced-but-practical-features">2. Advanced but practicalfeatures</h1><h2 id="splits-windows-and-tabs">1. Splits, windows, and tabs</h2><p>For large files or multi-file workflows, splits and tabs areextremely useful:</p><ul><li><p><code>:split</code> / <code>:sp</code>: horizontalsplit.</p></li><li><p><code>:vsplit</code> / <code>:vsp</code>: verticalsplit.</p></li><li><p><code>Ctrl+w</code> then <code>h/j/k/l</code>: move betweensplits.</p></li><li><p><code>:close</code>: close the current split.</p></li><li><p><code>:only</code>: keep the current split, closeothers.</p></li><li><p><code>:tabnew</code>: open a new tab.</p></li><li><p><code>gt</code> / <code>gT</code>: switch between tabs.</p></li><li><p>When the same file is opened by multiple Vim instances (or Vimpreviously crashed), you may see a swap file (<code>.swp</code>)warning.</p><figure><img src="/Linux%20Vim%20%E8%A7%A3%E6%9E%90/image-20250113231311535.png" alt="image-20250113231311535"><figcaption aria-hidden="true">image-20250113231311535</figcaption></figure><p>If you don’t need recovery, delete the swap file. If you do, followVim’s prompt to recover, then clean up the <code>.swp</code>.</p></li></ul><p>Used well, splits and tabs make side-by-side editing and comparisonmuch faster.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># You can try viewing different parts of the same file:</span></span><br><span class="line"><span class="comment"># :split</span></span><br><span class="line"><span class="comment"># :vsplit</span></span><br><span class="line"><span class="comment"># Then use Ctrl+w + h/j/k/l to switch between splits</span></span><br></pre></td></tr></table></figure><h2 id="macros-record-replay">2. Macros (record &amp; replay)</h2><p>Macros are extremely effective for repetitive edits: record asequence once, then replay it on other lines or blocks.</p><ul><li><code>q&#123;register&#125;</code>: start recording into a register (e.g.<code>qa</code> records into register <code>a</code>).<br></li><li>perform any edits (move/delete/insert, etc.)<br></li><li><code>q</code>: stop recording.<br></li><li><code>@&#123;register&#125;</code>: replay the macro.<br></li><li><code>@@</code>: replay the last-used macro again.</li></ul><p>To repeat N times, use <code>&#123;number&#125;@&#123;register&#125;</code> in Normalmode (e.g. <code>10@a</code>).</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Macro example:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1) qa     -&gt; start recording to register a</span></span><br><span class="line"><span class="comment"># 2) do edits, e.g. dd (delete line), p (paste), j (move down)</span></span><br><span class="line"><span class="comment"># 3) q      -&gt; stop recording</span></span><br><span class="line"><span class="comment"># 4) @a     -&gt; replay once</span></span><br><span class="line"><span class="comment"># 5) 10@a   -&gt; replay ten times</span></span><br></pre></td></tr></table></figure><h2 id="code-folding">3. Code folding</h2><p>When working in large files, folding helps you hide what you don’tneed and focus on one block at a time:</p><ul><li><code>zR</code>: open all folds.<br></li><li><code>zM</code>: close all folds.<br></li><li><code>za</code>: toggle the fold under cursor.<br></li><li><code>zc</code>: close current fold.<br></li><li><code>zo</code>: open current fold.</li></ul><p>This is especially useful for functions, classes, or longconfiguration blocks.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Inside a large function:</span></span><br><span class="line"><span class="comment"># zc -&gt; close fold</span></span><br><span class="line"><span class="comment"># za -&gt; toggle fold</span></span><br></pre></td></tr></table></figure><h2 id="search-replace">4. Search &amp; replace</h2><p>Vim supports flexible substitution with regular expressions. Commonpatterns:</p><p><code>:s/old/new/g</code><br>Replace matches in the current line (add/remove <code>g</code> for allvs first match).</p><p><code>:%s/old/new/g</code><br>Replace matches in the whole file.</p><p>For a specific line range, prefix with line numbers:</p><ul><li><code>:10,20s/foo/bar/g</code>: only lines 10–20.<br></li><li>Regex groups and patterns make substitutions much morepowerful.</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Examples:</span></span><br><span class="line"><span class="comment"># :%s/TODO/DONE/g</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Replace \&quot;abc\&quot; with \&quot;xyz\&quot; on lines 10–20:</span></span><br><span class="line"><span class="comment"># :10,20s/abc/xyz/g</span></span><br></pre></td></tr></table></figure><h2 id="customization-configuration">5. Customization &amp;configuration</h2><p>Vim can be customized via <code>~/.vimrc</code> (or<code>~/.config/nvim/init.vim</code> for Neovim). Common settingsinclude:</p><ul><li><code>set number</code>: line numbers.<br></li><li><code>set expandtab</code>, <code>set tabstop=4</code>,<code>set shiftwidth=4</code>: indentation style.<br></li><li><code>syntax on</code>: syntax highlighting (filetype detection alsodepends on extensions and can be helped by shebang lines like<code>#!/bin/bash</code>).<br></li><li><code>set relativenumber</code>: relative line numbers.<br></li><li><code>autocmd ...</code>: automatic commands (e.g., remove trailingwhitespace on save).</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A minimal .vimrc example:</span></span><br><span class="line"><span class="built_in">set</span> number</span><br><span class="line"><span class="built_in">set</span> expandtab</span><br><span class="line"><span class="built_in">set</span> tabstop=4</span><br><span class="line"><span class="built_in">set</span> shiftwidth=4</span><br><span class="line">syntax on</span><br><span class="line"><span class="built_in">set</span> cursorline</span><br><span class="line">autocmd BufWritePre * :%s/\s\+$//e</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">&lt;p&gt;Vim’s core idea is &lt;strong&gt;modal editing&lt;/strong&gt;: the same keys do
different things depending on the mode, which enables extremely fast
navigation and editing once the workflow “clicks.” This post breaks down
the key modes (normal/insert/visual/command-line), the most useful
motions and text objects, and the handful of patterns that make Vim feel
efficient instead of overwhelming. If you want a practical path to
“editing at speed” rather than memorizing random shortcuts, start
here.&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux 使用基础</title>
    <link href="https://chenk.top/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/"/>
    <id>https://chenk.top/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/</id>
    <published>2025-01-09T16:00:00.000Z</published>
    <updated>2026-01-28T01:23:54.615Z</updated>
    
    <content type="html"><![CDATA[<p>Linux的“难”往往不在命令本身，而在于你是否有一张清晰的系统地图：它为什么适合服务器、它的多用户多任务与权限模型在日常运维里意味着什么、不同发行版的包管理与目录布局有哪些共性与差异。本篇会先把这些核心认知搭起来，然后用一组最常用的命令把你带过一遍“文件/目录—查看与编辑—权限与用户—进程与资源”的基础操作链路。目标不是堆一堆指令表，而是让你从“会登录”走到“能独立完成基本管理与排障”，后续再学任何细分主题都会顺很多。</p><span id="more"></span><h1 id="一linux-核心概念与整体认知">一、Linux 核心概念与整体认知</h1><h2 id="为什么选择-linux">1. 为什么选择 Linux</h2><ul><li><strong>高可定制</strong>：开源、可免费使用，所有组件都能根据需要进行修改或定制。<br></li><li><strong>稳定可靠</strong>：Linux在服务器、嵌入式等场合使用广泛，拥有较强的稳定性和容错能力。<br></li><li><strong>强大生态</strong>：内置强大的包管理器，丰富的开源软件资源，如常见的<code>yum</code>（RHEL/CentOS）、<code>apt</code>（Debian/Ubuntu）等。<br></li><li><strong>一切皆文件</strong>：文件系统抽象了各种设备，可以统一方式访问硬盘、网络设备、外设。</li></ul><h2 id="常见发行版简要对比">2. 常见发行版简要对比</h2><ul><li><strong>Ubuntu/Debian 系</strong>：软件包管理器为<code>apt</code>，社区活跃，适合初学者和开发者。<br></li><li><strong>CentOS/RHEL 系</strong>：软件包管理器为 <code>yum</code> 或<code>dnf</code>，适合生产环境，稳定性好。<br></li><li><strong>SUSE 系</strong>：使用 <code>zypper</code>，在企业级环境及SAP 相关部署中常见。<br></li><li><strong>ArchLinux</strong>：滚动更新模型，软件版本最新，但对运维人员要求更高。</li></ul><h2 id="基本理念">3. 基本理念</h2><ul><li><strong>多用户、多任务</strong>：同一时间允许多个用户同时登录，每个用户可并行运行多个任务。<br></li><li><strong>权限机制</strong>：以文件（含目录）为核心，通过读、写、执行（rwx）三种权限和所有者/用户组/其他的组合来管理访问控制。<br></li><li><strong>命令行优先</strong>：大量操作更习惯于 CLI（Command LineInterface）完成，也有许多发行版提供图形化桌面，但服务器环境多以命令行为主。</li></ul><hr><h1 id="二文件与目录操作">二、文件与目录操作</h1><h2 id="创建与删除">1. 创建与删除</h2><ul><li><p><strong>mkdir <目录名></目录名></strong>：创建目录。可以加 <code>-p</code>参数递归创建多级目录。例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /home/test/subdir</span><br></pre></td></tr></table></figure><p>若没有上级目录时自动帮助创建。</p><blockquote><p>注意：Linux 的文件夹和文件名不得重复，因为一切皆文件</p></blockquote></li><li><p><strong>rmdir<目录名></目录名></strong>：只删除<strong>空目录</strong>。若需删除非空目录，一般使用<code>rm -r &lt;目录&gt;</code>。</p><p>但要注意：<code>rm</code>命令其实没有彻底删除，现在的文件系统都是日志型，操作其实都被系统监控、录制了，做了备份，删除文件都是可以恢复的，借助磁盘恢复数据手段即可，<code>shred 文件名</code>能够彻底粉碎文件，具体操作是随机写入一堆二进制数据导致源文件无法使用。比较危险，不推荐使用。</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202234749496.png" alt="image-20250202234749496"><figcaption aria-hidden="true">image-20250202234749496</figcaption></figure></li><li><p><strong>touch<文件></文件></strong>：最常用的用途在于<strong>快速创建新文件</strong>或<strong>修改现有文件的访问时间/修改时间</strong>。</p><ul><li><p>如果文件不存在，则新建空文件；</p></li><li><p>如果文件已存在，则仅更新文件时间戳（默认更新atime、mtime）。</p></li><li><p>创建多个文件的方式是用花括号扩起来，逗号分隔不同文件名，逗号之间不要加空格（<code>mkdir</code>同理）</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250110132947074.png" alt="image-20250110132947074"><figcaption aria-hidden="true">image-20250110132947074</figcaption></figure></li><li><p>批量操作方式为：</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250110220016714.png" alt="image-20250110220016714"><figcaption aria-hidden="true">image-20250110220016714</figcaption></figure></li></ul><blockquote><p>注意：</p><ol type="1"><li>创建文件时文件名除了不能包含斜线（<code>/</code>）都可以，但如果包含其他特殊字符（<code>? * &gt; &lt;</code>）需要使用单引号扩起来，双引号中的特殊符号是会发挥作用的，例如<code>!!</code>代表取得上一次执行的命令。当文件名出现特殊符号，系统会用反斜线进行转义</li><li><code>vi</code>、<code>vim</code> 和 <code>echo</code>也能创建文件， <code>echo</code>需要结合重定向符号输出内容到创建的文件中</li></ol></blockquote></li><li><p><code>stat 文件名</code>这个方法可以查看用户创建改变文件等的时间戳，是<code>ls</code> 的详细版</p><ul><li><p>修改文件名、权限这些信息会导致 change 属性发生时间更新</p></li><li><p>内容数据被修改时 modify 属性会发生时间更新</p></li></ul><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250110090635947.png" alt="image-20250110090635947"><figcaption aria-hidden="true">image-20250110090635947</figcaption></figure></li><li><p><strong>cp <源文件><目标></目标></源文件></strong>：复制文件或目录（如果复制目录需<code>cp -r</code>）。</p><ul><li><p>复制文件夹到目标路径某文件夹时，如果目标路径不存在该文件夹，将给原文件夹改名复制过去；若存在该文件夹，则将原文件夹复制到目标路径文件夹下</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111152537958.png" alt="image-20250111152537958"><figcaption aria-hidden="true">image-20250111152537958</figcaption></figure></li></ul></li><li><p><strong>mv <源> <目标></目标></源></strong>：移动/重命名文件或目录；相当于Windows 的剪切粘贴。</p></li><li><p><strong>zip</strong>：在两个硬盘之间拷贝大量数据会时快时慢，是因为有很多零散文件，打包压缩能将这些文件进行整合在一起再去传输。</p></li></ul><h2 id="查看目录与文件详情">2. 查看目录与文件详情</h2><ul><li><p><strong>ls-l</strong>：列出权限、所有者、大小、修改时间等详细信息，可以简写为<code>ll</code>。</p><ul><li><p><strong>组合参数</strong>：</p><ul><li><p><code>-h</code>：人性化显示大小，如 <code>1K</code>,<code>2M</code></p></li><li><p><code>-a</code>：包括隐藏文件（以 <code>.</code>开头）。</p></li><li><p><code>-d</code>：仅显示文件夹本身的信息，而非其他内部资料。</p></li><li><p><code>-t</code>：按修改时间排序；<code>-r</code>：反向排序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -lha /var/log</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>权限列</strong>：如 <code>drwxr-xr-x</code>：</p><ul><li><code>d</code> 表示目录；若是 <code>-</code>则是普通文件；<code>l</code> 则表示软链接等</li><li>后面 9 位分三组（owner / group / others），分别对应 rwx的权限位</li></ul></li></ul></li><li><p><strong>ls --help / manls</strong>：查看更多可用参数和说明。</p></li><li><p><strong>head -n 文件路径</strong>：查看前 <span class="math inline">\(n\)</span> 行，可以加入多个路径</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115175522240.png" alt="image-20250115175522240"><figcaption aria-hidden="true">image-20250115175522240</figcaption></figure></li><li><p><strong>tree</strong>：<code>tree -NF 文件夹</code>显示中文的文件类型树，<code>-N</code> 是显示中文。</p></li></ul><h2 id="重定向与文件写入">3. 重定向与文件写入</h2><ul><li><p><strong>echo "content"</strong>：将字符串输出到终端，可以使用<code>&gt;</code>、<code>&gt;&gt;</code> 重定向到文件。</p><ul><li><code>&gt;</code>：覆盖写入，若文件存在则会被清空后写入新内容。<br></li><li><code>&gt;&gt;</code>：追加写入，在文件末尾追加一行。</li></ul></li><li><p><strong>重定向符</strong>也可用于将命令输出保存：如<code>ls -l &gt; list.txt</code> 可将 <code>ls -l</code> 的结果保存到<code>list.txt</code> 文件里。</p><blockquote><p>注意：Linux下的单引号表示不做特殊符号转义，只是一个纯字符串；但双引号除了定义字符串还能识别特殊符号</p></blockquote></li></ul><h2 id="更多常见操作">4. 更多常见操作</h2><ul><li><p><strong>rm <文件 目录></文件></strong>：删除文件或目录，若删除目录需加<code>-r</code>。谨慎使用 <code>rm -rf /</code>之类的命令（危险操作）。</p></li><li><p><strong>cat / tac</strong>：输出文件内容到屏幕；<code>tac</code>为反序输出（从尾到头，注意是单词级别的）。</p><ul><li><p><code>cat</code>可以结合重定向符号使用，合并若干文件后输出到指定文件</p></li><li><p><code>cat -n filename</code> 可以输出行号（使用 <code>-b</code>对有内容的行显示行号，空行不显示）</p></li><li><p><code>cat -E filename</code> 可以在行后加 <code>$</code>代表结束</p></li><li><p>可以结合 <code>EOF</code> 及重定向符使用</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115174620452.png" alt="image-20250115174620452"><figcaption aria-hidden="true">image-20250115174620452</figcaption></figure></li></ul></li><li><p><strong>du</strong>：显示文件或文件夹的大小</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115151052789.png" alt="image-20250115151052789"><figcaption aria-hidden="true">image-20250115151052789</figcaption></figure></li><li><p><strong>wc</strong>：统计文件字数</p></li></ul><p>​ <img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115145624026.png" alt="image-20250115145624026"></p><ul><li><p><strong>head / tail</strong>：查看文件开头/结尾几行，常用<code>tail -f</code> 实时查看日志滚动输出。</p><ul><li><p><code>tail -f</code>：跟踪文件内容变化，但需要文件正常退出后才可见；</p></li><li><p><code>tail -F</code>：跟踪文件内容变化，实时的，即使文件不存在也可以</p></li></ul></li><li><p><strong>alias</strong>：起别名，例如 <code>rm = 'rm -i'</code>，简化繁琐的命令+路径。</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111151402312.png" alt="image-20250111151402312"><figcaption aria-hidden="true">image-20250111151402312</figcaption></figure></li><li><p><strong>md5sum</strong>：文件校验。</p></li><li><p>读取文件：</p><ul><li><p><strong>more</strong>：同<code>cat</code>，一次读取所有内容，不方便查看，占内存资源。分屏显示文本内容，可以用空格、回车、翻页查看，但是也很占内存</p></li><li><p><strong>less</strong>：如果文本内容过多的话，不会一次性显示读取完，显示界面有多大就先显示多少。空格翻页，回车下一行</p></li></ul></li><li><p><strong>tar</strong>：打包压缩与解压缩。打包默认是没有压缩功能的，组合之后才能节省磁盘空间，命令为：<code>tar [选项] [归档文件名] [文件或目录]</code></p><ul><li><p>功能性选项</p><ul><li><p>-c：创建归档文件。</p></li><li><p>-x：从归档文件中提取内容。</p></li><li><p>-t：列出归档文件的内容。</p></li><li><p>-r：向现有归档文件中追加文件。</p></li><li><p>-u：只追加比现有归档文件更新的文件。</p></li></ul></li><li><p>压缩相关选项</p><ul><li><p>-z：通过 gzip 压缩或解压缩（生成 .tar.gz 文件）。</p></li><li><p>-j：通过 bzip2 压缩或解压缩（生成 .tar.bz2 文件）。</p></li><li><p>-J：通过 xz 压缩或解压缩（生成 .tar.xz 文件）。</p></li><li><p>--lzma：通过 lzma 压缩或解压缩。</p></li></ul></li><li><p>其他选项</p><ul><li><p>-v：显示详细操作过程。</p></li><li><p>-f：指定归档文件名（要放在最后一个参数）。</p></li><li><p>-C：切换到目标目录进行操作。</p></li><li><p>--exclude=PATTERN：在操作时排除符合特定模式的文件。</p></li></ul></li><li><p>命名规范</p><ul><li>*.tar：仅仅打包了</li><li>*.tar.gz：打包+压缩</li><li>*.tgz：打包+压缩</li></ul></li></ul><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111170645720.png" alt="image-20250111170645720"><figcaption aria-hidden="true">image-20250111170645720</figcaption></figure><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111175602363.png" alt="image-20250111175602363"><figcaption aria-hidden="true">image-20250111175602363</figcaption></figure></li></ul><p>使用 <code>file</code> 命令可以查看真实文件类型：</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250127005513276.png" alt="image-20250127005513276"><figcaption aria-hidden="true">image-20250127005513276</figcaption></figure><hr><h1 id="三远程连接与协议">三、远程连接与协议</h1><h2 id="ssh-与常见客户端">1. SSH 与常见客户端</h2><ul><li><strong>SSH（SecureShell）</strong>：通过加密的方式远程登录与传输文件，是服务器管理的常见手段。默认端口<code>22</code>。<br></li><li><strong>语法</strong>： <code>ssh [-p PORT] user@host</code><ul><li><code>-p PORT</code>：指定非默认端口。<br></li><li><code>user@host</code>：登录名 + 服务器 IP 或域名。<br></li></ul></li><li><strong>密钥登录</strong>：可使用 <code>ssh-keygen</code>生成公私钥，配置到服务器的 <code>~/.ssh/authorized_keys</code>中，免密码登录。<br></li><li><strong>常见 SSH 客户端工具</strong>：Xshell, SecureCRT, PuTTY,或直接在 Linux 终端使用 <code>ssh</code> 命令。</li></ul><h2 id="退出连接">2. 退出连接</h2><ul><li><strong>exit / logout</strong>：退出当前会话。<br></li><li>当使用 Xshell 或其他 SSH 工具时，关闭窗口或 <code>exit</code>即可断开。</li></ul><h2 id="协议概念扩充">3. 协议概念扩充</h2><ul><li><strong>协议</strong>本质上是一套约定，用于在两端之间确立通信规范；包括数据格式、握手流程、加密方式等。<br></li><li><strong>常见协议</strong>：<ul><li>HTTP/HTTPS：浏览器与网站交互；<br></li><li>FTP/SFTP：文件传输协议（SFTP 基于 SSH 加密）；<br></li><li>SMTP/POP3/IMAP：邮件相关协议；<br></li><li>TCP/UDP：传输层协议，TCP 面向连接，UDP 面向无连接。</li></ul></li></ul><h2 id="修改-ssh-端口与安全性">4. 修改 SSH 端口与安全性</h2><ul><li>可编辑 <code>/etc/ssh/sshd_config</code> 中的 <code>Port</code>字段；修改后 <code>systemctl restart sshd</code> 生效。<br></li><li>改端口能减少被恶意扫描的概率，但并非绝对安全；结合防火墙、fail2ban、密钥登录等措施才能增强安全性。</li></ul><hr><h1 id="四linux-与-windows-命令对比">四、Linux 与 Windows 命令对比</h1><h2 id="基本差异">1. 基本差异</h2><ul><li><strong>命令行 vs. GUI</strong>：Windows 常以图形界面操作为主；Linux多在终端里敲命令。<br></li><li><strong>驱动方式</strong>：Windows驱动需厂商签名或驱动管理器更新；Linux下多内置模块或通过发行版仓库安装。<br></li><li><strong>软件安装方式</strong>：Windows 通常为 <code>.exe</code>安装包；Linux 主要通过包管理器（<code>apt</code>, <code>yum</code>,<code>dnf</code>, <code>pacman</code> 等）进行统一管理，更加集中。</li></ul><h2 id="文件路径与大小写">2. 文件路径与大小写</h2><ul><li>Windows 用 <code>C:\</code> 等盘符，反斜杠 <code>\</code>作为路径分隔符；Linux 根目录为 <code>/</code>，斜杠 <code>/</code>作为路径分隔，并且<strong>严格区分大小写</strong>。</li></ul><h2 id="网段桥接与-nat">3. 网段、桥接与 NAT</h2><p>在使用虚拟化（VMware、VirtualBox 等）时：<br>-<strong>桥接模式</strong>：虚拟机与宿主机在同一物理网络，可被同网段设备访问；<br>- <strong>NAT 模式</strong>：虚拟机通过宿主机 IP转发网络请求，一般从外部无法直接访问到 VM unless 做端口映射。</p><h2 id="文件类型与后缀">4. 文件类型与后缀</h2><ul><li>在 Windows中，<code>.exe</code>、<code>.doc</code>、<code>.mp4</code>等后缀通常决定文件所能做的事情；<br></li><li>在 Linux 中，<strong>文件权限</strong>（如<code>-rwxr-xr-x</code>）才决定是否可执行，与后缀并无强制关系。<code>.sh</code>只是约定俗成的脚本标识，而不影响其可执行性。</li></ul><h2 id="命令使用">5. 命令使用</h2><ul><li>Windows 上 ssh 连接方式为 <code>ssh 用户名@ip地址 端口号</code></li><li>Linux 上 ssh 连接方式为<code>ssh -p 端口号 用户名@ip地址</code></li></ul><hr><h1 id="五文件扩展名与权限控制">五、文件扩展名与权限控制</h1><h2 id="权限位详解rwx">1. 权限位详解（rwx）</h2><ul><li><strong>r</strong>（read）可读，<strong>w</strong>（write）可写，<strong>x</strong>（execute）可执行。<br></li><li>三组权限：<ul><li>Owner（文件所有者）<br></li><li>Group（同一用户组）<br></li><li>Others（其他用户）<br></li></ul></li><li>可用 <code>chmod</code>修改权限，比如：<code>chmod 755 script.sh</code>；其中<code>7=rwx, 5=rx, 5=rx</code>。</li></ul><h2 id="rpm-软件包与-deb-软件包">2. RPM 软件包与 DEB 软件包</h2><ul><li><strong>RPM</strong>：RedHat 系软件包，如 <code>.rpm</code>，可用<code>yum install xxx.rpm</code> 或 <code>rpm -ivh xxx.rpm</code>安装；<br></li><li><strong>DEB</strong>：Debian/Ubuntu 系软件包，如<code>.deb</code>，可用 <code>dpkg -i xxx.deb</code> 或<code>apt install ./xxx.deb</code>。</li></ul><h2 id="一切皆文件的扩展">3. 一切皆文件的扩展</h2><ul><li><strong>设备文件</strong>：如 <code>/dev/sda</code> 表示第一块SCSI/SATA 硬盘设备；<code>/dev/tty</code> 表示终端设备；<br></li><li><strong>管道文件</strong>：<code>mkfifo</code> 创建FIFO；在进程间通信中可使用管道文件做数据传递；<br></li><li><strong>套接字文件</strong>：某些进程可使用 Unix Domain Socket (UDS)在 <code>/var/run/*.sock</code> 中通信。</li></ul><hr><h1 id="六网络与服务管理">六、网络与服务管理</h1><h2 id="systemctl-与传统-system-v">1. systemctl 与传统 System V</h2><ul><li><strong>systemctl</strong>：主要用于管理 Systemd 服务，如<code>systemctl start/stop/restart/status &lt;service&gt;</code>。<br></li><li><strong>传统 SysV</strong> 使用<code>service &lt;service&gt; start</code> 或<code>/etc/init.d/&lt;service&gt; start</code> 等，现代发行版多已切换到Systemd。</li></ul><h2 id="network-服务">2. network 服务</h2><ul><li><strong>systemctl statusnetwork</strong>：查看网络服务状态；<code>start</code>、<code>stop</code>、<code>restart</code>分别用于启动、停止、重启。<br></li><li>如果在 SSH 会话中停止 <code>network</code>服务，则会<strong>断开</strong>连接，需要本地登录或其他网络路径访问才能恢复。</li></ul><h2 id="网卡配置与-ifcfg">3. 网卡配置与 ifcfg</h2><ul><li>在 RHEL/CentOS 等常见路径<code>/etc/sysconfig/network-scripts/ifcfg-ens33</code>（具体名称以实际网卡命名为准）。例如：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=192.168.1.100</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.1.1</span><br><span class="line">DNS1=8.8.8.8</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><ul><li>BOOTPROTO 可选 <code>static</code>, <code>dhcp</code>。<br></li><li>修改完成后 <code>systemctl restart network</code> 生效。</li></ul><h2 id="其他常见网络命令">4. 其他常见网络命令</h2><ul><li><strong>ip addr show</strong>：替代 <code>ifconfig</code>，显示网卡IP、MAC、子网掩码等；<br></li><li><strong>ip route show</strong>：查看路由表；<br></li><li><strong>ping</strong>：测试网络连通性；<code>ping -c 4 8.8.8.8</code>发送 4 个 ICMP 包；<br></li><li><strong>netstat / ss</strong>：查看端口占用、网络连接状态。</li></ul><h2 id="域名解析入门">5. 域名解析入门</h2><p>Linux 能正确进行互联网 DNS 解析的文件是<code>/etc/resolov.conf</code>，在里面写入域名服务器地址即可。解析就是将域名解析到IP 的一个操作，直接使用 ping 命令即可完成，但 Linux也提供了更专业化的域名查找和解析的命令：</p><ul><li><p><code>dig</code>：可以指定域名服务器，后面加对应的域名，具体的指令可以通过<code>-h</code> 获取：</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202233915839.png" alt="image-20250202233915839"><figcaption aria-hidden="true">image-20250202233915839</figcaption></figure><p>一个简单的示例是：</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202234043360.png" alt="image-20250202234043360"><figcaption aria-hidden="true">image-20250202234043360</figcaption></figure></li><li><p><code>nslookup(name server look up)</code></p><ul><li><p>交互式操作，直接输入命令即可</p></li><li><p>非交互式操作，<code>nslookup 域名</code></p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202233629928.png" alt="image-20250202233629928"><figcaption aria-hidden="true">image-20250202233629928</figcaption></figure></li></ul></li></ul><hr><h1 id="七硬盘与挂载">七、硬盘与挂载</h1><h2 id="基础流程">1. 基础流程</h2><ol type="1"><li><strong>分区</strong>：<code>fdisk /dev/sdb</code> 或<code>parted /dev/sdb</code> 建立主分区、扩展分区等；<br></li><li><strong>格式化</strong>：<code>mkfs.ext4 /dev/sdb1</code>，把分区写入ext4 文件系统（也可能是 xfs、btrfs 等）；<br></li><li><strong>挂载</strong>：<code>mount /dev/sdb1 /mnt/mydisk</code>，将该分区挂载到<code>/mnt/mydisk</code> 目录。</li></ol><h2 id="挂载与自动挂载">2. 挂载与自动挂载</h2><ul><li><strong>临时挂载</strong>：只在当前会话或重启前有效；<br></li><li><strong>永久挂载</strong>：在 <code>/etc/fstab</code>写入配置：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1 /mnt/mydisk ext4 defaults 0 2</span><br></pre></td></tr></table></figure><p>重启后自动挂载。</p><h2 id="磁盘管理命令扩充">3. 磁盘管理命令扩充</h2><ul><li><strong>lsblk</strong>：列出块设备的层次结构，包括挂载点；<br></li><li><strong>df -h</strong>：查看分区的已用/可用空间；<code>-h</code>让显示更友好；<br></li><li><strong>du -sh <目录></目录></strong>：查看目录所占用的实际容量。</li></ul><hr><h1 id="八用户与主机名">八、用户与主机名</h1><h2 id="命令提示符与身份">1. 命令提示符与身份</h2><ul><li><strong>root@hostname ~ #</strong>：root 用户标识符为<code>#</code>；<br></li><li>**普通用户@hostname ~ <span class="math inline">\(**：普通用户以`\)</span>` 结尾提示符；<br></li><li>可在 <code>~/.bashrc</code> 或 <code>/etc/bashrc</code> 中自定义 PS1以改变提示符样式，如在提示符中显示当前时间、Git分支等信息（以点开头的文件表示隐藏文件，可以通过 <code>ls -a</code>查看）。</li></ul><h2 id="切换用户与管理">2. 切换用户与管理</h2><ul><li><strong>su</strong><ul><li><strong>su <user></user></strong>：切换到其他用户，不完全登录，只能用<code>exit</code> 退出，不加载用户的配置文件，可以再次输入<code>bash</code> 命令加载用户环境变量等信息，等同于下面的加杠；</li><li><strong>su -<user></user></strong>：（加杠）切换到其他用户，会进入该用户的环境（包含PATH、工作目录等），涉及到用户的配置文件的加载，即<code>~/.bash_profile</code>。</li></ul></li><li><strong>useradd <user></user></strong>：添加新用户；<strong>passwd<user></user></strong>：设置或修改密码。<br></li><li><strong>usermod</strong>：修改用户属性，如<code>usermod -aG wheel &lt;user&gt;</code> 将该用户加入<code>wheel</code> 组（sudo 权限组）。<br></li><li><strong>userdel</strong>：删除用户，可加 <code>-r</code>同时删除家目录。<br></li><li><strong>id -<user></user></strong>：查看系统中的用户信息或者验证该用户名是否存在。</li></ul><h2 id="修改主机名">3. 修改主机名</h2><ul><li><strong>hostnamectl set-hostname <newname></newname></strong>：Systemd时代标准方式，更改后需要重新登录或重启 shell会话才能看到最新效果。<br></li><li>也可直接修改<code>/etc/hostname</code>、<code>/etc/hosts</code>（旧方式，但在新版本中<code>hostnamectl</code> 更简洁）。</li></ul><hr><h1 id="九常用目录与命令">九、常用目录与命令</h1><h2 id="常见目录">1. 常见目录</h2><ul><li><strong>/etc</strong>：系统配置文件主目录。很多服务（如<code>sshd</code>, <code>network</code>,<code>cron</code>）的配置都在此处。<br></li><li><strong>/var/log</strong>：存放系统及服务运行日志，如<code>messages</code>, <code>secure</code>, <code>cron</code>等文件；分析故障常见在此查看。<br></li><li><strong>/home</strong>：普通用户的家目录存放位置，每个用户对应<code>/home/username</code>。<br></li><li><strong>/root</strong>：root 用户家目录（非<code>/home/root</code>）。<br></li><li><strong>/opt</strong>：可安装第三方软件包或自主编译安装的非系统默认软件。</li></ul><h2 id="系统文件">2. 系统文件</h2><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/1451404-20190107163218473-2030500089.png" alt="linux目录结构"><figcaption aria-hidden="true">linux目录结构</figcaption></figure><ul><li><p><strong>/etc</strong>：初始化系统的重要文件所在目录，包含各种系统配置文件和服务配置文件。</p><ul><li><p><strong>/etc/sysconfig/network-scripts/ifcfg-eth0</strong>：网卡配置文件，用于配置以太网接口的网络参数，如IP地址、子网掩码、网关等。</p></li><li><p><strong>/etc/resolv.conf</strong>：Linux系统的DNS客户端配置文件，用于域名解析，使机器能够识别和访问如www.taobao.com等域名。</p><blockquote><p>注意：</p><ol type="1"><li>将 nameserver 行注释掉就 ping 不通其他网址了，可以写入多个nameserver，防止一个挂掉就无法做域名解析了</li><li>DNS 劫持：修改了 nameserver 地址，并关闭了本地的公网 DNS服务器设置传送到恶意的 DNS 服务器地址，返回一个恶意的 IP地址。要解决只需要修改客户端正确的 DNS 服务器即可（本地机器会有 DNS解析缓存，可以使用命令强制刷新）</li></ol></blockquote></li><li><p><strong>/etc/hostname (CentOS 7)</strong> /<strong>/etc/sysconfig/network (CentOS6)</strong>：主机名配置文件，用于设置系统的主机名。例如，可以设置一个测试用的假域名如www.yejinyang0224.cd。</p></li><li><p><strong>/etc/hosts</strong>：系统本地的DNS解析文件，包含本机的IP地址与域名对应关系，如<code>192.168.0.150 www.yejinyang0224.cc</code>，使本机能够解析指定的域名。该文件必须在客户端机器上配置，决定了本机对特定域名的解析。</p></li><li><p><strong>/etc/fstab</strong>：配置开机时自动挂载设备的文件，定义了设备与挂载点的对应关系。</p></li><li><p><strong>/etc/rc.local</strong>：存放开机自启动程序命令的文件，可以在系统启动时自动执行指定的脚本或命令。</p></li><li><p><strong>/etc/inittab</strong>：系统启动时设定运行级别等配置的文件（主要用于旧版系统）。</p></li><li><p><strong>/etc/profile</strong> 和<strong>/etc/bashrc</strong>：配置系统的环境变量和别名等文件，影响所有用户的登录环境。</p></li><li><p><strong>/etc/profile.d</strong>：用户登录后执行的脚本所在目录，可以在此设置个人快捷命令或别名，每次开机自动加载。</p></li><li><p><strong>/etc/issue</strong> 和<strong>/etc/issue.net</strong>：配置用户登录终端前显示的信息文件，如欢迎信息或系统标识。</p></li><li><p><strong>/etc/init.d</strong>：软件启动程序所在目录（适用于 CentOS6），存放各种服务的启动脚本。</p></li><li><p><strong>/usr/lib/systemd/system/</strong>：软件启动程序所在目录（适用于CentOS 7），存放 Systemd 服务单元文件。</p></li><li><p><strong>/etc/motd</strong>：配置用户登录系统后显示的提示内容文件（Messageof the Day）。</p></li><li><p><strong>/etc/redhat-release</strong>：声明 RedHat系统的版本号和名称信息的文件。</p></li><li><p><strong>/etc/sysctl.conf</strong>：Linux内核参数设置文件，用于配置内核的运行参数，如网络设置、文件系统性能参数等。</p></li></ul></li><li><p><strong>/proc</strong>：重要的虚拟文件系统，提供系统底层的各种信息，如硬件设备、文件系统等，体现了Linux 的“一切皆文件”理念。</p><ul><li><strong>/proc/meminfo</strong>：系统内存信息，提供详细的内存使用情况，虽然对普通用户来说较为底层，但许多程序依赖于此获取内存数据。</li><li><strong>/proc/cpuinfo</strong>：处理器信息文件，包含关于CPU的详细信息，如型号、核心数、频率等。</li></ul></li><li><p><strong>/dev</strong>：设备文件目录，包含系统中所有的设备文件，如<code>/dev/sda</code>（第一块SCSI/SATA硬盘设备）、<code>/dev/tty</code>（终端设备）。</p></li><li><p><strong>/var/log</strong>：存放系统和服务的日志文件，如<code>messages</code>、<code>secure</code>、<code>cron</code>等，帮助运维人员进行系统监控与故障排除。</p></li><li><p><strong>/home</strong>：普通用户的家目录所在位置，每个用户对应<code>/home/username</code>。</p></li><li><p><strong>/root</strong>：超级用户（root）的家目录。</p></li><li><p><strong>/opt</strong>：用于安装大型或第三方软件包，通常不属于系统默认软件的一部分。</p></li><li><p><strong>/lib</strong>：存放系统软件运行必须调用的<code>.so</code> 文件，如同 Windows 软件运行依赖的 <code>.dll</code>文件。</p></li><li><p><strong>/mnt</strong>：就是一个普通文件夹，一般用做光驱、U盘、硬盘等挂载，访问该文件夹即等于读取 U 盘的数据。</p></li><li><p><strong>/usr</strong>：存放系统应用程序、库文件和共享资源，类似于Windows 的 <code>C:\Windows</code> 目录。</p><ul><li><strong>/usr/lib</strong>：存放系统库文件和动态链接库，类似于Windows 的<code>C:\Windows\System32</code>，包含大量系统级别的库和模块。</li><li><strong>/usr/local</strong>：用于安装用户自己编译的程序和手动安装的软件，类似于Windows 的<code>C:\Program Files</code>。这个目录下的程序通常不由包管理器管理，便于用户自定义和维护。</li></ul></li></ul><h2 id="系统信息查看">3. 系统信息查看</h2><ul><li><strong>uname -a</strong>：查看内核版本、主机名、硬件架构等；<br></li><li><strong>cat /etc/os-release</strong>：查看操作系统发行版信息；<br></li><li><strong>hostnamectl</strong>：查看/设置主机名、OS类型、内核等；<br></li><li><strong>w</strong>：可以显示系统登录用户（<strong>w = who +uptime</strong>）。</li></ul><h2 id="帮助与历史">4. 帮助与历史</h2><ul><li><p><strong>man <命令></命令></strong>：查看 Linux内置手册，更多参数与示例；</p></li><li><p><strong>--help</strong>：大多数命令提供简要帮助；</p></li><li><p><strong>info <命令></命令></strong>：另一种详细文档格式（GNU infopage）；</p></li><li><p><strong>history</strong>：查看输入过的命令记录，可配合<code>!&lt;编号&gt;</code> 快速执行某条历史命令。</p></li><li><p><strong>find</strong>：查找文件</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115152941077.png" alt="image-20250115152941077"><figcaption aria-hidden="true">image-20250115152941077</figcaption></figure><ul><li><p><code>-type f</code>：找到文本类型的数据（可以被 <code>cat</code>的文件）</p></li><li><p><code>-type d</code>：找到文件夹类型的数据</p></li><li><p><code>-o</code>：或者，比如要找到所有的压缩文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -<span class="built_in">type</span> f -name <span class="string">&quot;*.tar&quot;</span> -o -name <span class="string">&quot;*.tgz&quot;</span> -o -name <span class="string">&quot;*.zip&quot;</span> -o -name <span class="string">&quot;*.tar.gz&quot;</span></span><br></pre></td></tr></table></figure></li><li><p><code>-a</code>：并且</p><figure><img src="/Linux-%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250117123507969.png" alt="image-20250117123507969"><figcaption aria-hidden="true">image-20250117123507969</figcaption></figure></li><li><p>找出系统上超过 20 M 的 <code>tar</code>压缩包（大于为+20M，等于为 20M，小于为-20M）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -<span class="built_in">type</span> f -size +20M -name <span class="string">&quot;*.tar&quot;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><hr><h1 id="十变量与环境变量">十、变量与环境变量</h1><h2 id="定义与读取">1. 定义与读取</h2><ul><li><p><strong>自定义变量</strong>：不加 <code>export</code> 仅在当前shell 有效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br></pre></td></tr></table></figure></li><li><p><strong>导出为环境变量</strong>：使其在子进程也可见：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> name=<span class="string">&quot;hello&quot;</span>  </span><br></pre></td></tr></table></figure></li><li><p><strong>删除变量</strong>：<code>unset name</code></p></li></ul><h2 id="path-环境变量">2. PATH 环境变量</h2><ul><li><p>决定在终端输入某个命令时，系统依次在这些目录里查找可执行文件。例如<code>PATH=/usr/local/bin:/usr/bin:/bin</code>.</p></li><li><p><strong>which<命令></命令></strong>：显示该命令对应的绝对路径，比如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># /usr/bin/ls</span></span><br></pre></td></tr></table></figure></li><li><p>若某个目录不在 PATH 中，需要<strong>全路径</strong>调用或修改PATH。</p></li></ul><hr><h1 id="十一更多扩充与常见实用技巧">十一、更多扩充与常见实用技巧</h1><h2 id="软件安装相关">1. 软件安装相关</h2><ul><li><strong>yum search <关键字> / apt search<关键字></关键字></关键字></strong>：查找可安装的软件包；<br></li><li><strong>yum update / apt update</strong>：更新软件源信息，再用<code>upgrade</code> 或 <code>dist-upgrade</code> 升级已安装的包；<br></li><li><strong>yum remove <包名> / apt remove<包名></包名></包名></strong>：卸载不用的包。</li></ul><h2 id="查找与过滤命令">2. 查找与过滤命令</h2><ul><li><strong>find <路径> -name<pattern></pattern></路径></strong>：递归查找匹配特定文件名；可加 <code>-type f/d</code>限制类型；<br></li><li><strong>grep<关键词></关键词></strong>：在文本中搜索关键字；<code>grep -r</code>递归搜索目录；<code>egrep / fgrep</code> 为扩展/固定正则版本；<br></li><li><strong>awk /sed</strong>：文本处理的强大工具，常搭配管道组合复杂过滤或替换操作。</li></ul><h2 id="进程管理">3. 进程管理</h2><ul><li><strong>ps aux / top /hto</strong>：查看当前进程列表、CPU/内存占用；<br></li><li><strong>kill <PID> / kill -9<PID></PID></PID></strong>：结束进程；<code>kill -9</code> 为强制结束；<br></li><li><strong>jobs / bg /fg</strong>：管理后台/前台进程；常用场景：一时想把长时间任务放后台执行。</li></ul><h2 id="安全强化基础">4. 安全强化基础</h2><ul><li><strong>sudo 机制</strong>：普通用户临时以 root身份执行管理命令，减少安全隐患；<br></li><li><strong>防火墙</strong>：<code>firewalld</code> 或<code>iptables</code>；控制端口开放与否；<code>firewall-cmd</code> 或<code>iptables</code> 命令进行规则配置；<br></li><li><strong>日志审计</strong>：查看<code>/var/log/secure</code>、<code>/var/log/audit</code>等，以了解系统登录和关键安全事件。</li></ul><h2 id="shell-脚本入门">5. Shell 脚本入门</h2><ul><li>首行常用 <code>#!/bin/bash</code> 指明解释器；<br></li><li>赋予脚本可执行权限 <code>chmod +x script.sh</code>；<br></li><li>通过 <code>./script.sh</code> 或 <code>bash script.sh</code>运行；<br></li><li>脚本中可使用变量、流程控制语句（if/for/while）等实现自动化运维。</li></ul><h2 id="虚拟机快照">6. 虚拟机快照</h2><p>相当于游戏存档，例如软件升级时有很多相关软件也都跟着升级导致某个出问题了，可以回到之前的位置</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Linux
的“难”往往不在命令本身，而在于你是否有一张清晰的系统地图：它为什么适合服务器、它的多用户多任务与权限模型在日常运维里意味着什么、不同发行版的包管理与目录布局有哪些共性与差异。本篇会先把这些核心认知搭起来，然后用一组最常用的命令把你带过一遍“文件/目录—查看与编辑—权限与用户—进程与资源”的基础操作链路。目标不是堆一堆指令表，而是让你从“会登录”走到“能独立完成基本管理与排障”，后续再学任何细分主题都会顺很多。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
  <entry>
    <title>Linux Basics (Core Concepts and Essential Commands)</title>
    <link href="https://chenk.top/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/"/>
    <id>https://chenk.top/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/</id>
    <published>2025-01-09T16:00:00.000Z</published>
    <updated>2026-01-28T01:53:59.326Z</updated>
    
    <content type="html"><![CDATA[<p>Why Linux? This post gives a practical first-principles introduction:what “multi-user / multi-tasking” really means, why Linux dominatesservers and cloud environments, and how to get comfortable with thecommand line quickly. It also provides a high-level map of commondistributions and the foundational commands you’ll use every day, so youcan move from “I can log in” to “I can operate the systemconfidently.”</p><span id="more"></span><h1 id="core-concepts-and-a-mental-model">1. Core concepts and a mentalmodel</h1><h2 id="why-linux">1. Why Linux?</h2><ul><li><strong>Highly customizable</strong>: open-source, free to use, andeasy to tailor to specific needs.<br></li><li><strong>Stable and reliable</strong>: widely used in servers andembedded systems with strong fault tolerance.<br></li><li><strong>A strong ecosystem</strong>: package managers and vastrepositories (<code>apt</code> on Debian/Ubuntu, <code>yum/dnf</code> onRHEL/CentOS).<br></li><li><strong>Everything is a file</strong>: devices and resources areexposed through a unified filesystem interface.</li></ul><h2 id="common-distributions-quick-map">2. Common distributions (quickmap)</h2><ul><li><strong>Ubuntu/Debian</strong>: <code>apt</code>, large community,friendly for beginners and developers.<br></li><li><strong>RHEL/CentOS</strong>: <code>yum</code> / <code>dnf</code>,conservative and stable for production.<br></li><li><strong>SUSE</strong>: <code>zypper</code>, common in enterpriseenvironments (including SAP ecosystems).<br></li><li><strong>Arch Linux</strong>: rolling releases, newest packages,requires more operational maturity.</li></ul><h2 id="key-ideas">3. Key ideas</h2><ul><li><strong>Multi-user, multi-tasking</strong>: multiple users andprocesses can work concurrently.<br></li><li><strong>Permissions</strong>: access control is centered onfiles/directories via <code>r/w/x</code> for owner/group/others.<br></li><li><strong>CLI-first</strong>: many administrative tasks are done viaterminal commands, especially on servers.</li></ul><hr><h1 id="files-and-directories">2. Files and directories</h1><h2 id="create-and-remove">1. Create and remove</h2><ul><li><p>**mkdir</p><dir><p>**: create a directory. Use <code>-p</code> to create parentdirectories as needed:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /home/test/subdir</span><br></pre></td></tr></table></figure><p>This creates missing parent directories automatically.</p><blockquote><p>Note: file and directory names cannot collide in the same path.</p></blockquote></dir></li><li><p>**rmdir</p><dir><p><strong>: remove an </strong>empty** directory. For non-emptydirectories, use <code>rm -r &lt;dir&gt;</code>.</p><p>Note: deletion semantics depend on the filesystem and storage device.In many cases data may be recoverable until overwritten. Tools like<code>shred</code> attempt to overwrite data, but on modernfilesystems/SSDs it is not a perfect guarantee; use with care.</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202234749496.png" alt="image-20250202234749496"><figcaption aria-hidden="true">image-20250202234749496</figcaption></figure></dir></li><li><p><strong>touch <file></file></strong>: create an empty file (if itdoesn’t exist) or update timestamps (typically<code>atime</code>/<code>mtime</code>).</p><ul><li><p>You can create multiple files using brace expansion, e.g.<code>touch a&#123;1,2,3&#125;.txt</code> (no spaces inside braces).</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250110132947074.png" alt="image-20250110132947074"><figcaption aria-hidden="true">image-20250110132947074</figcaption></figure></li><li><p>批量操作方式为：</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250110220016714.png" alt="image-20250110220016714"><figcaption aria-hidden="true">image-20250110220016714</figcaption></figure></li></ul><blockquote><p>Notes:+ &gt; 1. Filenames cannot contain <code>/</code>. If you usespecial characters (e.g. <code>? * &gt; &lt;</code>), quote the name(single quotes are safest).+ &gt; 2. Editors like <code>vi/vim</code>can create files. <code>echo</code> typically creates/writes files viaredirection (<code>&gt;</code> / <code>&gt;&gt;</code>).</p></blockquote></li><li><p><code>stat &lt;file&gt;</code>: show detailed metadata (a moredetailed view than <code>ls</code>), including timestamps.</p><ul><li><p>修改文件名、权限这些信息会导致 change 属性发生时间更新</p></li><li><p>内容数据被修改时 modify 属性会发生时间更新</p></li></ul><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250110090635947.png" alt="image-20250110090635947"><figcaption aria-hidden="true">image-20250110090635947</figcaption></figure></li><li><p><strong>cp <源文件><目标></目标></源文件></strong>：复制文件或目录（如果复制目录需<code>cp -r</code>）。</p><ul><li><p>复制文件夹到目标路径某文件夹时，如果目标路径不存在该文件夹，将给原文件夹改名复制过去；若存在该文件夹，则将原文件夹复制到目标路径文件夹下</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111152537958.png" alt="image-20250111152537958"><figcaption aria-hidden="true">image-20250111152537958</figcaption></figure></li></ul></li><li><p><strong>mv <源> <目标></目标></源></strong>：移动/重命名文件或目录；相当于Windows 的剪切粘贴。</p></li><li><p><strong>zip</strong>：在两个硬盘之间拷贝大量数据会时快时慢，是因为有很多零散文件，打包压缩能将这些文件进行整合在一起再去传输。</p></li></ul><h2 id="查看目录与文件详情">2. 查看目录与文件详情</h2><ul><li><p><strong>ls-l</strong>：列出权限、所有者、大小、修改时间等详细信息，可以简写为<code>ll</code>。</p><ul><li><p><strong>组合参数</strong>：</p><ul><li><p><code>-h</code>：人性化显示大小，如 <code>1K</code>,<code>2M</code></p></li><li><p><code>-a</code>：包括隐藏文件（以 <code>.</code>开头）。</p></li><li><p><code>-d</code>：仅显示文件夹本身的信息，而非其他内部资料。</p></li><li><p><code>-t</code>：按修改时间排序；<code>-r</code>：反向排序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> -lha /var/log</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>权限列</strong>：如 <code>drwxr-xr-x</code>：</p><ul><li><code>d</code> 表示目录；若是 <code>-</code>则是普通文件；<code>l</code> 则表示软链接等</li><li>后面 9 位分三组（owner / group / others），分别对应 rwx的权限位</li></ul></li></ul></li><li><p><strong>ls --help / manls</strong>：查看更多可用参数和说明。</p></li><li><p><strong>head -n 文件路径</strong>：查看前 <span class="math inline">\(n\)</span> 行，可以加入多个路径</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115175522240.png" alt="image-20250115175522240"><figcaption aria-hidden="true">image-20250115175522240</figcaption></figure></li><li><p><strong>tree</strong>：<code>tree -NF 文件夹</code>显示中文的文件类型树，<code>-N</code> 是显示中文。</p></li></ul><h2 id="重定向与文件写入">3. 重定向与文件写入</h2><ul><li><p><strong>echo "content"</strong>：将字符串输出到终端，可以使用<code>&gt;</code>、<code>&gt;&gt;</code> 重定向到文件。</p><ul><li><code>&gt;</code>：覆盖写入，若文件存在则会被清空后写入新内容。<br></li><li><code>&gt;&gt;</code>：追加写入，在文件末尾追加一行。</li></ul></li><li><p><strong>重定向符</strong>也可用于将命令输出保存：如<code>ls -l &gt; list.txt</code> 可将 <code>ls -l</code> 的结果保存到<code>list.txt</code> 文件里。</p><blockquote><p>注意：Linux下的单引号表示不做特殊符号转义，只是一个纯字符串；但双引号除了定义字符串还能识别特殊符号</p></blockquote></li></ul><h2 id="更多常见操作">4. 更多常见操作</h2><ul><li><p><strong>rm <文件 目录></文件></strong>：删除文件或目录，若删除目录需加<code>-r</code>。谨慎使用 <code>rm -rf /</code>之类的命令（危险操作）。</p></li><li><p><strong>cat / tac</strong>：输出文件内容到屏幕；<code>tac</code>为反序输出（从尾到头，注意是单词级别的）。</p><ul><li><p><code>cat</code>可以结合重定向符号使用，合并若干文件后输出到指定文件</p></li><li><p><code>cat -n filename</code> 可以输出行号（使用 <code>-b</code>对有内容的行显示行号，空行不显示）</p></li><li><p><code>cat -E filename</code> 可以在行后加 <code>$</code>代表结束</p></li><li><p>可以结合 <code>EOF</code> 及重定向符使用</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115174620452.png" alt="image-20250115174620452"><figcaption aria-hidden="true">image-20250115174620452</figcaption></figure></li></ul></li><li><p><strong>du</strong>：显示文件或文件夹的大小</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115151052789.png" alt="image-20250115151052789"><figcaption aria-hidden="true">image-20250115151052789</figcaption></figure></li><li><p><strong>wc</strong>：统计文件字数</p></li></ul><p>​ <img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115145624026.png" alt="image-20250115145624026"></p><ul><li><p><strong>head / tail</strong>：查看文件开头/结尾几行，常用<code>tail -f</code> 实时查看日志滚动输出。</p><ul><li><p><code>tail -f</code>：跟踪文件内容变化，但需要文件正常退出后才可见；</p></li><li><p><code>tail -F</code>：跟踪文件内容变化，实时的，即使文件不存在也可以</p></li></ul></li><li><p><strong>alias</strong>：起别名，例如 <code>rm = 'rm -i'</code>，简化繁琐的命令+路径。</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111151402312.png" alt="image-20250111151402312"><figcaption aria-hidden="true">image-20250111151402312</figcaption></figure></li><li><p><strong>md5sum</strong>：文件校验。</p></li><li><p>读取文件：</p><ul><li><p><strong>more</strong>：同<code>cat</code>，一次读取所有内容，不方便查看，占内存资源。分屏显示文本内容，可以用空格、回车、翻页查看，但是也很占内存</p></li><li><p><strong>less</strong>：如果文本内容过多的话，不会一次性显示读取完，显示界面有多大就先显示多少。空格翻页，回车下一行</p></li></ul></li><li><p><strong>tar</strong>：打包压缩与解压缩。打包默认是没有压缩功能的，组合之后才能节省磁盘空间，命令为：<code>tar [选项] [归档文件名] [文件或目录]</code></p><ul><li><p>功能性选项</p><ul><li><p>-c：创建归档文件。</p></li><li><p>-x：从归档文件中提取内容。</p></li><li><p>-t：列出归档文件的内容。</p></li><li><p>-r：向现有归档文件中追加文件。</p></li><li><p>-u：只追加比现有归档文件更新的文件。</p></li></ul></li><li><p>压缩相关选项</p><ul><li><p>-z：通过 gzip 压缩或解压缩（生成 .tar.gz 文件）。</p></li><li><p>-j：通过 bzip2 压缩或解压缩（生成 .tar.bz2 文件）。</p></li><li><p>-J：通过 xz 压缩或解压缩（生成 .tar.xz 文件）。</p></li><li><p>--lzma：通过 lzma 压缩或解压缩。</p></li></ul></li><li><p>其他选项</p><ul><li><p>-v：显示详细操作过程。</p></li><li><p>-f：指定归档文件名（要放在最后一个参数）。</p></li><li><p>-C：切换到目标目录进行操作。</p></li><li><p>--exclude=PATTERN：在操作时排除符合特定模式的文件。</p></li></ul></li><li><p>命名规范</p><ul><li>*.tar：仅仅打包了</li><li>*.tar.gz：打包+压缩</li><li>*.tgz：打包+压缩</li></ul></li></ul><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111170645720.png" alt="image-20250111170645720"><figcaption aria-hidden="true">image-20250111170645720</figcaption></figure><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250111175602363.png" alt="image-20250111175602363"><figcaption aria-hidden="true">image-20250111175602363</figcaption></figure></li></ul><p>使用 <code>file</code> 命令可以查看真实文件类型：</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250127005513276.png" alt="image-20250127005513276"><figcaption aria-hidden="true">image-20250127005513276</figcaption></figure><hr><h1 id="三远程连接与协议">三、远程连接与协议</h1><h2 id="ssh-与常见客户端">1. SSH 与常见客户端</h2><ul><li><strong>SSH（SecureShell）</strong>：通过加密的方式远程登录与传输文件，是服务器管理的常见手段。默认端口<code>22</code>。<br></li><li><strong>语法</strong>： <code>ssh [-p PORT] user@host</code><ul><li><code>-p PORT</code>：指定非默认端口。<br></li><li><code>user@host</code>：登录名 + 服务器 IP 或域名。<br></li></ul></li><li><strong>密钥登录</strong>：可使用 <code>ssh-keygen</code>生成公私钥，配置到服务器的 <code>~/.ssh/authorized_keys</code>中，免密码登录。<br></li><li><strong>常见 SSH 客户端工具</strong>：Xshell, SecureCRT, PuTTY,或直接在 Linux 终端使用 <code>ssh</code> 命令。</li></ul><h2 id="退出连接">2. 退出连接</h2><ul><li><strong>exit / logout</strong>：退出当前会话。<br></li><li>当使用 Xshell 或其他 SSH 工具时，关闭窗口或 <code>exit</code>即可断开。</li></ul><h2 id="协议概念扩充">3. 协议概念扩充</h2><ul><li><strong>协议</strong>本质上是一套约定，用于在两端之间确立通信规范；包括数据格式、握手流程、加密方式等。<br></li><li><strong>常见协议</strong>：<ul><li>HTTP/HTTPS：浏览器与网站交互；<br></li><li>FTP/SFTP：文件传输协议（SFTP 基于 SSH 加密）；<br></li><li>SMTP/POP3/IMAP：邮件相关协议；<br></li><li>TCP/UDP：传输层协议，TCP 面向连接，UDP 面向无连接。</li></ul></li></ul><h2 id="修改-ssh-端口与安全性">4. 修改 SSH 端口与安全性</h2><ul><li>可编辑 <code>/etc/ssh/sshd_config</code> 中的 <code>Port</code>字段；修改后 <code>systemctl restart sshd</code> 生效。<br></li><li>改端口能减少被恶意扫描的概率，但并非绝对安全；结合防火墙、fail2ban、密钥登录等措施才能增强安全性。</li></ul><hr><h1 id="四linux-与-windows-命令对比">四、Linux 与 Windows 命令对比</h1><h2 id="基本差异">1. 基本差异</h2><ul><li><strong>命令行 vs. GUI</strong>：Windows 常以图形界面操作为主；Linux多在终端里敲命令。<br></li><li><strong>驱动方式</strong>：Windows驱动需厂商签名或驱动管理器更新；Linux下多内置模块或通过发行版仓库安装。<br></li><li><strong>软件安装方式</strong>：Windows 通常为 <code>.exe</code>安装包；Linux 主要通过包管理器（<code>apt</code>, <code>yum</code>,<code>dnf</code>, <code>pacman</code> 等）进行统一管理，更加集中。</li></ul><h2 id="文件路径与大小写">2. 文件路径与大小写</h2><ul><li>Windows 用 <code>C:\</code> 等盘符，反斜杠 <code>\</code>作为路径分隔符；Linux 根目录为 <code>/</code>，斜杠 <code>/</code>作为路径分隔，并且<strong>严格区分大小写</strong>。</li></ul><h2 id="网段桥接与-nat">3. 网段、桥接与 NAT</h2><p>在使用虚拟化（VMware、VirtualBox 等）时：<br>-<strong>桥接模式</strong>：虚拟机与宿主机在同一物理网络，可被同网段设备访问；<br>- <strong>NAT 模式</strong>：虚拟机通过宿主机 IP转发网络请求，一般从外部无法直接访问到 VM unless 做端口映射。</p><h2 id="文件类型与后缀">4. 文件类型与后缀</h2><ul><li>在 Windows中，<code>.exe</code>、<code>.doc</code>、<code>.mp4</code>等后缀通常决定文件所能做的事情；<br></li><li>在 Linux 中，<strong>文件权限</strong>（如<code>-rwxr-xr-x</code>）才决定是否可执行，与后缀并无强制关系。<code>.sh</code>只是约定俗成的脚本标识，而不影响其可执行性。</li></ul><h2 id="命令使用">5. 命令使用</h2><ul><li>Windows 上 ssh 连接方式为 <code>ssh 用户名@ip地址 端口号</code></li><li>Linux 上 ssh 连接方式为<code>ssh -p 端口号 用户名@ip地址</code></li></ul><hr><h1 id="五文件扩展名与权限控制">五、文件扩展名与权限控制</h1><h2 id="权限位详解rwx">1. 权限位详解（rwx）</h2><ul><li><strong>r</strong>（read）可读，<strong>w</strong>（write）可写，<strong>x</strong>（execute）可执行。<br></li><li>三组权限：<ul><li>Owner（文件所有者）<br></li><li>Group（同一用户组）<br></li><li>Others（其他用户）<br></li></ul></li><li>可用 <code>chmod</code>修改权限，比如：<code>chmod 755 script.sh</code>；其中<code>7=rwx, 5=rx, 5=rx</code>。</li></ul><h2 id="rpm-软件包与-deb-软件包">2. RPM 软件包与 DEB 软件包</h2><ul><li><strong>RPM</strong>：RedHat 系软件包，如 <code>.rpm</code>，可用<code>yum install xxx.rpm</code> 或 <code>rpm -ivh xxx.rpm</code>安装；<br></li><li><strong>DEB</strong>：Debian/Ubuntu 系软件包，如<code>.deb</code>，可用 <code>dpkg -i xxx.deb</code> 或<code>apt install ./xxx.deb</code>。</li></ul><h2 id="一切皆文件的扩展">3. 一切皆文件的扩展</h2><ul><li><strong>设备文件</strong>：如 <code>/dev/sda</code> 表示第一块SCSI/SATA 硬盘设备；<code>/dev/tty</code> 表示终端设备；<br></li><li><strong>管道文件</strong>：<code>mkfifo</code> 创建FIFO；在进程间通信中可使用管道文件做数据传递；<br></li><li><strong>套接字文件</strong>：某些进程可使用 Unix Domain Socket (UDS)在 <code>/var/run/*.sock</code> 中通信。</li></ul><hr><h1 id="六网络与服务管理">六、网络与服务管理</h1><h2 id="systemctl-与传统-system-v">1. systemctl 与传统 System V</h2><ul><li><strong>systemctl</strong>：主要用于管理 Systemd 服务，如<code>systemctl start/stop/restart/status &lt;service&gt;</code>。<br></li><li><strong>传统 SysV</strong> 使用<code>service &lt;service&gt; start</code> 或<code>/etc/init.d/&lt;service&gt; start</code> 等，现代发行版多已切换到Systemd。</li></ul><h2 id="network-服务">2. network 服务</h2><ul><li><strong>systemctl statusnetwork</strong>：查看网络服务状态；<code>start</code>、<code>stop</code>、<code>restart</code>分别用于启动、停止、重启。<br></li><li>如果在 SSH 会话中停止 <code>network</code>服务，则会<strong>断开</strong>连接，需要本地登录或其他网络路径访问才能恢复。</li></ul><h2 id="网卡配置与-ifcfg">3. 网卡配置与 ifcfg</h2><ul><li>在 RHEL/CentOS 等常见路径<code>/etc/sysconfig/network-scripts/ifcfg-ens33</code>（具体名称以实际网卡命名为准）。例如：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">IPADDR=192.168.1.100</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.1.1</span><br><span class="line">DNS1=8.8.8.8</span><br><span class="line">ONBOOT=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure><ul><li>BOOTPROTO 可选 <code>static</code>, <code>dhcp</code>。<br></li><li>修改完成后 <code>systemctl restart network</code> 生效。</li></ul><h2 id="其他常见网络命令">4. 其他常见网络命令</h2><ul><li><strong>ip addr show</strong>：替代 <code>ifconfig</code>，显示网卡IP、MAC、子网掩码等；<br></li><li><strong>ip route show</strong>：查看路由表；<br></li><li><strong>ping</strong>：测试网络连通性；<code>ping -c 4 8.8.8.8</code>发送 4 个 ICMP 包；<br></li><li><strong>netstat / ss</strong>：查看端口占用、网络连接状态。</li></ul><h2 id="域名解析入门">5. 域名解析入门</h2><p>Linux 能正确进行互联网 DNS 解析的文件是<code>/etc/resolov.conf</code>，在里面写入域名服务器地址即可。解析就是将域名解析到IP 的一个操作，直接使用 ping 命令即可完成，但 Linux也提供了更专业化的域名查找和解析的命令：</p><ul><li><p><code>dig</code>：可以指定域名服务器，后面加对应的域名，具体的指令可以通过<code>-h</code> 获取：</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202233915839.png" alt="image-20250202233915839"><figcaption aria-hidden="true">image-20250202233915839</figcaption></figure><p>一个简单的示例是：</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202234043360.png" alt="image-20250202234043360"><figcaption aria-hidden="true">image-20250202234043360</figcaption></figure></li><li><p><code>nslookup(name server look up)</code></p><ul><li><p>交互式操作，直接输入命令即可</p></li><li><p>非交互式操作，<code>nslookup 域名</code></p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250202233629928.png" alt="image-20250202233629928"><figcaption aria-hidden="true">image-20250202233629928</figcaption></figure></li></ul></li></ul><hr><h1 id="七硬盘与挂载">七、硬盘与挂载</h1><h2 id="基础流程">1. 基础流程</h2><ol type="1"><li><strong>分区</strong>：<code>fdisk /dev/sdb</code> 或<code>parted /dev/sdb</code> 建立主分区、扩展分区等；<br></li><li><strong>格式化</strong>：<code>mkfs.ext4 /dev/sdb1</code>，把分区写入ext4 文件系统（也可能是 xfs、btrfs 等）；<br></li><li><strong>挂载</strong>：<code>mount /dev/sdb1 /mnt/mydisk</code>，将该分区挂载到<code>/mnt/mydisk</code> 目录。</li></ol><h2 id="挂载与自动挂载">2. 挂载与自动挂载</h2><ul><li><strong>临时挂载</strong>：只在当前会话或重启前有效；<br></li><li><strong>永久挂载</strong>：在 <code>/etc/fstab</code>写入配置：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sdb1 /mnt/mydisk ext4 defaults 0 2</span><br></pre></td></tr></table></figure><p>重启后自动挂载。</p><h2 id="磁盘管理命令扩充">3. 磁盘管理命令扩充</h2><ul><li><strong>lsblk</strong>：列出块设备的层次结构，包括挂载点；<br></li><li><strong>df -h</strong>：查看分区的已用/可用空间；<code>-h</code>让显示更友好；<br></li><li><strong>du -sh <目录></目录></strong>：查看目录所占用的实际容量。</li></ul><hr><h1 id="八用户与主机名">八、用户与主机名</h1><h2 id="命令提示符与身份">1. 命令提示符与身份</h2><ul><li><strong>root@hostname ~ #</strong>：root 用户标识符为<code>#</code>；<br></li><li>**普通用户@hostname ~ <span class="math inline">\(**：普通用户以`\)</span>` 结尾提示符；<br></li><li>可在 <code>~/.bashrc</code> 或 <code>/etc/bashrc</code> 中自定义 PS1以改变提示符样式，如在提示符中显示当前时间、Git分支等信息（以点开头的文件表示隐藏文件，可以通过 <code>ls -a</code>查看）。</li></ul><h2 id="切换用户与管理">2. 切换用户与管理</h2><ul><li><strong>su</strong><ul><li><strong>su <user></user></strong>：切换到其他用户，不完全登录，只能用<code>exit</code> 退出，不加载用户的配置文件，可以再次输入<code>bash</code> 命令加载用户环境变量等信息，等同于下面的加杠；</li><li><strong>su -<user></user></strong>：（加杠）切换到其他用户，会进入该用户的环境（包含PATH、工作目录等），涉及到用户的配置文件的加载，即<code>~/.bash_profile</code>。</li></ul></li><li><strong>useradd <user></user></strong>：添加新用户；<strong>passwd<user></user></strong>：设置或修改密码。<br></li><li><strong>usermod</strong>：修改用户属性，如<code>usermod -aG wheel &lt;user&gt;</code> 将该用户加入<code>wheel</code> 组（sudo 权限组）。<br></li><li><strong>userdel</strong>：删除用户，可加 <code>-r</code>同时删除家目录。<br></li><li><strong>id -<user></user></strong>：查看系统中的用户信息或者验证该用户名是否存在。</li></ul><h2 id="修改主机名">3. 修改主机名</h2><ul><li><strong>hostnamectl set-hostname <newname></newname></strong>：Systemd时代标准方式，更改后需要重新登录或重启 shell会话才能看到最新效果。<br></li><li>也可直接修改<code>/etc/hostname</code>、<code>/etc/hosts</code>（旧方式，但在新版本中<code>hostnamectl</code> 更简洁）。</li></ul><hr><h1 id="九常用目录与命令">九、常用目录与命令</h1><h2 id="常见目录">1. 常见目录</h2><ul><li><strong>/etc</strong>：系统配置文件主目录。很多服务（如<code>sshd</code>, <code>network</code>,<code>cron</code>）的配置都在此处。<br></li><li><strong>/var/log</strong>：存放系统及服务运行日志，如<code>messages</code>, <code>secure</code>, <code>cron</code>等文件；分析故障常见在此查看。<br></li><li><strong>/home</strong>：普通用户的家目录存放位置，每个用户对应<code>/home/username</code>。<br></li><li><strong>/root</strong>：root 用户家目录（非<code>/home/root</code>）。<br></li><li><strong>/opt</strong>：可安装第三方软件包或自主编译安装的非系统默认软件。</li></ul><h2 id="系统文件">2. 系统文件</h2><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/1451404-20190107163218473-2030500089.png" alt="linux目录结构"><figcaption aria-hidden="true">linux目录结构</figcaption></figure><ul><li><p><strong>/etc</strong>：初始化系统的重要文件所在目录，包含各种系统配置文件和服务配置文件。</p><ul><li><p><strong>/etc/sysconfig/network-scripts/ifcfg-eth0</strong>：网卡配置文件，用于配置以太网接口的网络参数，如IP地址、子网掩码、网关等。</p></li><li><p><strong>/etc/resolv.conf</strong>：Linux系统的DNS客户端配置文件，用于域名解析，使机器能够识别和访问如www.taobao.com等域名。</p><blockquote><p>注意：</p><ol type="1"><li>将 nameserver 行注释掉就 ping 不通其他网址了，可以写入多个nameserver，防止一个挂掉就无法做域名解析了</li><li>DNS 劫持：修改了 nameserver 地址，并关闭了本地的公网 DNS服务器设置传送到恶意的 DNS 服务器地址，返回一个恶意的 IP地址。要解决只需要修改客户端正确的 DNS 服务器即可（本地机器会有 DNS解析缓存，可以使用命令强制刷新）</li></ol></blockquote></li><li><p><strong>/etc/hostname (CentOS 7)</strong> /<strong>/etc/sysconfig/network (CentOS6)</strong>：主机名配置文件，用于设置系统的主机名。例如，可以设置一个测试用的假域名如www.yejinyang0224.cd。</p></li><li><p><strong>/etc/hosts</strong>：系统本地的DNS解析文件，包含本机的IP地址与域名对应关系，如<code>192.168.0.150 www.yejinyang0224.cc</code>，使本机能够解析指定的域名。该文件必须在客户端机器上配置，决定了本机对特定域名的解析。</p></li><li><p><strong>/etc/fstab</strong>：配置开机时自动挂载设备的文件，定义了设备与挂载点的对应关系。</p></li><li><p><strong>/etc/rc.local</strong>：存放开机自启动程序命令的文件，可以在系统启动时自动执行指定的脚本或命令。</p></li><li><p><strong>/etc/inittab</strong>：系统启动时设定运行级别等配置的文件（主要用于旧版系统）。</p></li><li><p><strong>/etc/profile</strong> 和<strong>/etc/bashrc</strong>：配置系统的环境变量和别名等文件，影响所有用户的登录环境。</p></li><li><p><strong>/etc/profile.d</strong>：用户登录后执行的脚本所在目录，可以在此设置个人快捷命令或别名，每次开机自动加载。</p></li><li><p><strong>/etc/issue</strong> 和<strong>/etc/issue.net</strong>：配置用户登录终端前显示的信息文件，如欢迎信息或系统标识。</p></li><li><p><strong>/etc/init.d</strong>：软件启动程序所在目录（适用于 CentOS6），存放各种服务的启动脚本。</p></li><li><p><strong>/usr/lib/systemd/system/</strong>：软件启动程序所在目录（适用于CentOS 7），存放 Systemd 服务单元文件。</p></li><li><p><strong>/etc/motd</strong>：配置用户登录系统后显示的提示内容文件（Messageof the Day）。</p></li><li><p><strong>/etc/redhat-release</strong>：声明 RedHat系统的版本号和名称信息的文件。</p></li><li><p><strong>/etc/sysctl.conf</strong>：Linux内核参数设置文件，用于配置内核的运行参数，如网络设置、文件系统性能参数等。</p></li></ul></li><li><p><strong>/proc</strong>：重要的虚拟文件系统，提供系统底层的各种信息，如硬件设备、文件系统等，体现了Linux 的“一切皆文件”理念。</p><ul><li><strong>/proc/meminfo</strong>：系统内存信息，提供详细的内存使用情况，虽然对普通用户来说较为底层，但许多程序依赖于此获取内存数据。</li><li><strong>/proc/cpuinfo</strong>：处理器信息文件，包含关于CPU的详细信息，如型号、核心数、频率等。</li></ul></li><li><p><strong>/dev</strong>：设备文件目录，包含系统中所有的设备文件，如<code>/dev/sda</code>（第一块SCSI/SATA硬盘设备）、<code>/dev/tty</code>（终端设备）。</p></li><li><p><strong>/var/log</strong>：存放系统和服务的日志文件，如<code>messages</code>、<code>secure</code>、<code>cron</code>等，帮助运维人员进行系统监控与故障排除。</p></li><li><p><strong>/home</strong>：普通用户的家目录所在位置，每个用户对应<code>/home/username</code>。</p></li><li><p><strong>/root</strong>：超级用户（root）的家目录。</p></li><li><p><strong>/opt</strong>：用于安装大型或第三方软件包，通常不属于系统默认软件的一部分。</p></li><li><p><strong>/lib</strong>：存放系统软件运行必须调用的<code>.so</code> 文件，如同 Windows 软件运行依赖的 <code>.dll</code>文件。</p></li><li><p><strong>/mnt</strong>：就是一个普通文件夹，一般用做光驱、U盘、硬盘等挂载，访问该文件夹即等于读取 U 盘的数据。</p></li><li><p><strong>/usr</strong>：存放系统应用程序、库文件和共享资源，类似于Windows 的 <code>C:\Windows</code> 目录。</p><ul><li><strong>/usr/lib</strong>：存放系统库文件和动态链接库，类似于Windows 的<code>C:\Windows\System32</code>，包含大量系统级别的库和模块。</li><li><strong>/usr/local</strong>：用于安装用户自己编译的程序和手动安装的软件，类似于Windows 的<code>C:\Program Files</code>。这个目录下的程序通常不由包管理器管理，便于用户自定义和维护。</li></ul></li></ul><h2 id="系统信息查看">3. 系统信息查看</h2><ul><li><strong>uname -a</strong>：查看内核版本、主机名、硬件架构等；<br></li><li><strong>cat /etc/os-release</strong>：查看操作系统发行版信息；<br></li><li><strong>hostnamectl</strong>：查看/设置主机名、OS类型、内核等；<br></li><li><strong>w</strong>：可以显示系统登录用户（<strong>w = who +uptime</strong>）。</li></ul><h2 id="帮助与历史">4. 帮助与历史</h2><ul><li><p><strong>man <命令></命令></strong>：查看 Linux内置手册，更多参数与示例；</p></li><li><p><strong>--help</strong>：大多数命令提供简要帮助；</p></li><li><p><strong>info <命令></命令></strong>：另一种详细文档格式（GNU infopage）；</p></li><li><p><strong>history</strong>：查看输入过的命令记录，可配合<code>!&lt;编号&gt;</code> 快速执行某条历史命令。</p></li><li><p><strong>find</strong>：查找文件</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250115152941077.png" alt="image-20250115152941077"><figcaption aria-hidden="true">image-20250115152941077</figcaption></figure><ul><li><p><code>-type f</code>：找到文本类型的数据（可以被 <code>cat</code>的文件）</p></li><li><p><code>-type d</code>：找到文件夹类型的数据</p></li><li><p><code>-o</code>：或者，比如要找到所有的压缩文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -<span class="built_in">type</span> f -name <span class="string">&quot;*.tar&quot;</span> -o -name <span class="string">&quot;*.tgz&quot;</span> -o -name <span class="string">&quot;*.zip&quot;</span> -o -name <span class="string">&quot;*.tar.gz&quot;</span></span><br></pre></td></tr></table></figure></li><li><p><code>-a</code>：并且</p><figure><img src="/Linux%20%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/image-20250117123507969.png" alt="image-20250117123507969"><figcaption aria-hidden="true">image-20250117123507969</figcaption></figure></li><li><p>找出系统上超过 20 M 的 <code>tar</code>压缩包（大于为+20M，等于为 20M，小于为-20M）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -<span class="built_in">type</span> f -size +20M -name <span class="string">&quot;*.tar&quot;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><hr><h1 id="十变量与环境变量">十、变量与环境变量</h1><h2 id="定义与读取">1. 定义与读取</h2><ul><li><p><strong>自定义变量</strong>：不加 <code>export</code> 仅在当前shell 有效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name=<span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$name</span></span><br></pre></td></tr></table></figure></li><li><p><strong>导出为环境变量</strong>：使其在子进程也可见：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> name=<span class="string">&quot;hello&quot;</span>  </span><br></pre></td></tr></table></figure></li><li><p><strong>删除变量</strong>：<code>unset name</code></p></li></ul><h2 id="path-环境变量">2. PATH 环境变量</h2><ul><li><p>决定在终端输入某个命令时，系统依次在这些目录里查找可执行文件。例如<code>PATH=/usr/local/bin:/usr/bin:/bin</code>.</p></li><li><p><strong>which<命令></命令></strong>：显示该命令对应的绝对路径，比如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># /usr/bin/ls</span></span><br></pre></td></tr></table></figure></li><li><p>若某个目录不在 PATH 中，需要<strong>全路径</strong>调用或修改PATH。</p></li></ul><hr><h1 id="十一更多扩充与常见实用技巧">十一、更多扩充与常见实用技巧</h1><h2 id="软件安装相关">1. 软件安装相关</h2><ul><li><strong>yum search <关键字> / apt search<关键字></关键字></关键字></strong>：查找可安装的软件包；<br></li><li><strong>yum update / apt update</strong>：更新软件源信息，再用<code>upgrade</code> 或 <code>dist-upgrade</code> 升级已安装的包；<br></li><li><strong>yum remove <包名> / apt remove<包名></包名></包名></strong>：卸载不用的包。</li></ul><h2 id="查找与过滤命令">2. 查找与过滤命令</h2><ul><li><strong>find <路径> -name<pattern></pattern></路径></strong>：递归查找匹配特定文件名；可加 <code>-type f/d</code>限制类型；<br></li><li><strong>grep<关键词></关键词></strong>：在文本中搜索关键字；<code>grep -r</code>递归搜索目录；<code>egrep / fgrep</code> 为扩展/固定正则版本；<br></li><li><strong>awk /sed</strong>：文本处理的强大工具，常搭配管道组合复杂过滤或替换操作。</li></ul><h2 id="进程管理">3. 进程管理</h2><ul><li><strong>ps aux / top /hto</strong>：查看当前进程列表、CPU/内存占用；<br></li><li><strong>kill <PID> / kill -9<PID></PID></PID></strong>：结束进程；<code>kill -9</code> 为强制结束；<br></li><li><strong>jobs / bg /fg</strong>：管理后台/前台进程；常用场景：一时想把长时间任务放后台执行。</li></ul><h2 id="安全强化基础">4. 安全强化基础</h2><ul><li><strong>sudo 机制</strong>：普通用户临时以 root身份执行管理命令，减少安全隐患；<br></li><li><strong>防火墙</strong>：<code>firewalld</code> 或<code>iptables</code>；控制端口开放与否；<code>firewall-cmd</code> 或<code>iptables</code> 命令进行规则配置；<br></li><li><strong>日志审计</strong>：查看<code>/var/log/secure</code>、<code>/var/log/audit</code>等，以了解系统登录和关键安全事件。</li></ul><h2 id="shell-脚本入门">5. Shell 脚本入门</h2><ul><li>首行常用 <code>#!/bin/bash</code> 指明解释器；<br></li><li>赋予脚本可执行权限 <code>chmod +x script.sh</code>；<br></li><li>通过 <code>./script.sh</code> 或 <code>bash script.sh</code>运行；<br></li><li>脚本中可使用变量、流程控制语句（if/for/while）等实现自动化运维。</li></ul><h2 id="虚拟机快照">6. 虚拟机快照</h2><p>相当于游戏存档，例如软件升级时有很多相关软件也都跟着升级导致某个出问题了，可以回到之前的位置</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Why Linux? This post gives a practical first-principles introduction:
what “multi-user / multi-tasking” really means, why Linux dominates
servers and cloud environments, and how to get comfortable with the
command line quickly. It also provides a high-level map of common
distributions and the foundational commands you’ll use every day, so you
can move from “I can log in” to “I can operate the system
confidently.”&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="Cloud" scheme="https://chenk.top/tags/Cloud/"/>
    
  </entry>
  
  <entry>
    <title>Linux 系统服务管理</title>
    <link href="https://chenk.top/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/"/>
    <id>https://chenk.top/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/</id>
    <published>2025-01-05T16:00:00.000Z</published>
    <updated>2026-01-28T01:01:08.144Z</updated>
    
    <content type="html"><![CDATA[<p>在操作系统中，“服务”指后台常驻的进程或守护程序。本文介绍常见服务如ntpd、firewalld、ssh 等的管理，并讲解如何使用 systemctl命令进行启动、停止、重启与开机自启的配置。</p><span id="more"></span><h1 id="一什么是系统服务管理">一、什么是系统服务管理</h1><p>在操作系统中，“服务”指的是在后台长期运行、对系统或用户提供某种功能的进程或守护程序。例如：- <strong>Windows</strong> 系统中的服务可通过 “services.msc”可视化管理，包括 WiFi、蓝牙、音频、数据库等；<br>- <strong>Linux</strong>系统同样提供大量服务，例如网络、时间同步、计划任务、数据库守护进程等，都可用命令行或工具进行管理。</p><p><strong>Windows 服务举例</strong></p><ul><li>WiFi服务：依赖网卡硬件+网卡驱动+对应服务程序一起协作，让系统能够进行无线网络连接。<br></li><li><strong>MySQL</strong>：若在 Windows 安装了 MySQL 数据库，可以通过Windows 服务控制面板启动/停止服务，也可在命令行通过<code>net start mysql</code> / <code>net stop mysql</code> 管理。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Win 下示例：通过 cmd 管理服务</span></span><br><span class="line">net start mysql</span><br><span class="line">net stop mysql</span><br></pre></td></tr></table></figure><p>Linux 则依赖一套统一的服务管理机制（如 Systemd），使用 systemctl等命令行工具配置和管理这些服务，包括自动启动、重启、停止等操作。</p><h1 id="二linux-systemd-服务管理">二、Linux Systemd 服务管理</h1><h2 id="systemd-基本作用">1.Systemd 基本作用</h2><p><strong>Systemd</strong> 是现代 Linux发行版广泛使用的系统与服务管理器，它会在系统引导时启动各种服务，并维持它们的运行和状态。核心命令是<code>systemctl</code>。</p><p>常见操作：</p><table><thead><tr><th>用法</th><th>说明</th></tr></thead><tbody><tr><td><code>systemctl start name</code></td><td>启动指定服务</td></tr><tr><td><code>systemctl stop name</code></td><td>停止指定服务</td></tr><tr><td><code>systemctl restart name</code></td><td>重启指定服务</td></tr><tr><td><code>systemctl status name</code></td><td>查看指定服务状态</td></tr><tr><td><code>systemctl enable name</code></td><td>开机自动启动</td></tr><tr><td><code>systemctl disable name</code></td><td>取消开机自启</td></tr><tr><td><code>systemctl is-active name</code></td><td>判断服务是否正在运行</td></tr><tr><td><code>systemctl is-enabled name</code></td><td>判断是否设置为开机启动</td></tr></tbody></table><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start crond</span><br><span class="line">systemctl <span class="built_in">enable</span> crond</span><br><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure><h2 id="systemctl-使用">2.systemctl 使用</h2><p>CentOS 6 使用 <code>service</code> 来管理，CentOS 7 中的<code>service</code> 和 <code>chkconfig</code> 都被整合到了<code>systemctl</code> 里，向下兼容，可以使用旧的命令。</p><ol type="1"><li><p><strong>设置服务运行级别</strong>：<code>systemctl set-default multi-user.target</code>/ <code>systemctl set-default graphical.target</code>等控制是否进入文本多用户/图形环境。</p></li><li><p><strong>查看日志</strong>：配合<code>journalctl -u servicename</code> 查看某服务相关日志。</p></li><li><p><strong>编辑服务单元文件</strong>：在<code>/etc/systemd/system/</code> 或<code>/usr/lib/systemd/system/</code> 下存放 <code>.service</code>文件，自定义服务启动顺序、依赖等。</p></li><li><p><strong>列出 active 运行中的服务</strong>：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250127141849192.png" alt="image-20250127141849192"><figcaption aria-hidden="true">image-20250127141849192</figcaption></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出运行中的ssh服务</span></span><br><span class="line">systemctl list-units --<span class="built_in">type</span> service --all | grep ssh</span><br><span class="line"><span class="comment"># ssh.service             loaded    active   running OpenBSD Secure Shell server</span></span><br></pre></td></tr></table></figure><p>unit：单元、服务，指的是如sshd、network、nginx这样的服务名。</p></li></ol><blockquote><p>之前的service命令原理补充：Linux的大部分命令都是去机器上寻找到某个文件，然后读取文件的配置加载功能。而service默认是去/etc/init.d 目录下寻找服务管理脚本文件，然后根据指令service startnetwork等去进行启动。</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203001009014.png" alt="image-20250203001009014"><figcaption aria-hidden="true">image-20250203001009014</figcaption></figure></blockquote><p>找到 <code>ssh</code>这个文件进行打开，往下翻会出现下面的内容，这些就包含了一些相关的指令：</p><blockquote><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203001145705.png" alt="image-20250203001145705"><figcaption aria-hidden="true">image-20250203001145705</figcaption></figure><p>所以如果安装了某个软件后没有方便的启停管理脚本，可以自己写完后放到<code>/etc/init.d</code> 目录下再调用就行。</p></blockquote><p>通过 <code>yum</code> 或 <code>apt</code>等安装的程序，会自动生成对应的管理脚本，自动的在 <code>systemctl</code>管理脚本目录下：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203002716348.png" alt="image-20250203002716348"><figcaption aria-hidden="true">image-20250203002716348</figcaption></figure><p>于是我们每次要关停服务的时候就不需要先 <code>ps -ef</code> 再<code>kill pid</code> 了，非常省事。以 <code>nginx</code>为例我们可以有两种运行方式：</p><ol type="1"><li>直接运行命令</li><li>以服务管理模式运行systemctl</li></ol><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203005916445.png" alt="image-20250203005916445"><figcaption aria-hidden="true">image-20250203005916445</figcaption></figure><p>可以查看 nginx 的服务管理脚本，以后安装软件可以参照这个脚本来写：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203010533155.png" alt="image-20250203010533155"><figcaption aria-hidden="true">image-20250203010533155</figcaption></figure><h1 id="三常见自有服务与用途">三、常见自有服务与用途</h1><p>Linux 系统自带许多基础服务，以下列举几个常用且重要的示例：</p><h2 id="时间服务">1.时间服务</h2><h3 id="ntpd-ntpsec">ntpd &amp; ntpsec</h3><p><strong>ntpd</strong>是用来实现时间同步的守护进程。它会定期与上游时间服务器通信，使本机系统时钟准确一致。<strong>ntpsec</strong>是 <code>ntpd</code>的现代化版本，旨在提高安全性、减少代码复杂度，并提供更高效的时间同步服务。它与传统的<code>ntpd</code>在核心功能上类似，但经过优化，移除了许多遗留特性，以提升稳定性和安全性。</p><p><strong>为什么需要时间同步？</strong></p><p>在分布式系统、集群、日志分析等应用场景下，时间同步至关重要。例如：</p><p>​ • <strong>定时任务的执行</strong>（如 cron 任务）</p><p>​ • <strong>日志对比和分析</strong>（确保日志时间戳的一致性）</p><p>​ • <strong>数据同步</strong>（如数据库主从复制）</p><p>​ • <strong>分布式计算和安全协议</strong>（如 Kerberos 身份认证）</p><p>如果服务器时间不一致，可能会导致：</p><p>​ • <strong>任务调度混乱</strong>（任务可能提前或延后执行）</p><p>​ • <strong>日志分析错误</strong>（难以关联不同系统的日志）</p><p>​ • <strong>通信异常</strong>（如 TLS 证书时间不匹配）</p><p>因此保证服务器之前的时间一致非常重要。一些要点如下：</p><ul><li>NTP（Network TimeProtocol）可实现毫秒级甚至更精确的时间同步，精度在局域网内可达 0.1ms，在互联网上绝大多数地方的精度可以达到 1-50 ms。<br></li><li>在 <code>/etc/ntp.conf</code> 或 <code>/etc/chrony.conf</code>中配置上游时间服务器地址。<br></li><li>启动服务后，<code>ntpd</code> 会定时校准本机时间。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> ntpsec</span><br><span class="line">systemctl start ntpsec</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203113641235.png" alt="image-20250203113641235"><figcaption aria-hidden="true">image-20250203113641235</figcaption></figure><p>可以前往 <code>/etc/ntpsec/ntp.conf</code> 查看对应的配置文件：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203115220880.png" alt="image-20250203115220880"><figcaption aria-hidden="true">image-20250203115220880</figcaption></figure><p>以阿里云 ntp 服务器为例，要修改为这个服务器的时间可以：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server times.aliyun.com iburst prefer</span><br><span class="line">server ntp.aliyun.com iburst</span><br><span class="line">server cn.pool.ntp.org iburst</span><br></pre></td></tr></table></figure><p>可以查看 <code>/usr/lib/systemd/system/ntpsec.service</code>查看配置文件：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203115608782.png" alt="image-20250203115608782"><figcaption aria-hidden="true">image-20250203115608782</figcaption></figure><p>查看运行状态：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203115835862.png" alt="image-20250203115835862"><figcaption aria-hidden="true">image-20250203115835862</figcaption></figure><p><code>ntpd -q</code> 可以监视 <code>ntpsec</code> 运行状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2025-02-03T12:11:49 ntpd[973215]: INIT: ntpd ntpsec-1.2.2: Starting</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: INIT: Command line: ntpd -q</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: INIT: precision = 0.042 usec (-24)</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: INIT: successfully locked into RAM</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: CONFIG: readconfig: parsing file: /etc/ntpsec/ntp.conf</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: CONFIG: Cannot open logfile /var/log/myntpsec.log: Permission denied</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: INIT: ntpd ntpsec-1.2.2: Starting</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: INIT: Command line: ntpd -q</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: CONFIG: restrict nopeer ignored</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: CLOCK: leapsecond file (<span class="string">&#x27;/usr/share/zoneinfo/leap-seconds.list&#x27;</span>): good <span class="built_in">hash</span> signature</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: CLOCK: leapsecond file (<span class="string">&#x27;/usr/share/zoneinfo/leap-seconds.list&#x27;</span>): loaded, expire=2025-06-28T00:00Z last=2017-01-01T00:00Z ofs=37</span><br><span class="line">2025-02-03T12:11:49 ntpd[973215]: IO: unable to <span class="built_in">bind</span> to wildcard address :: - another process may be running: Address already <span class="keyword">in</span> use; EXITING</span><br></pre></td></tr></table></figure><h3 id="ntpdate一次性时间同步工具">ntpdate（一次性时间同步工具）</h3><p>如果仅需临时更新时间，也可用 <code>ntpdate</code>（或<code>chronyc</code>）命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpdate pool.ntp.org</span><br></pre></td></tr></table></figure><p>可以添加 <code>-u</code>参数，指定来自某台服务器或者某个服务器厂商，例如：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ntpdate -u ntp.aliyun.com</span><br><span class="line">ntpdate -u 192.132.2.111</span><br></pre></td></tr></table></figure><p><code>ntpdata</code>它会一次性与指定服务器进行同步，而非常驻守护进程。 <code>ntpd</code>在实际同步时间时是一点点校准过来的，最终把时间慢慢校对，但<code>ntpdate</code>不会考虑其他程序是否会阵痛，直接调整时间，区别是一个是校准，一个是调整。总结来说<code>ntpdate</code> 有如下<strong>缺点</strong>：</p><ol type="1"><li><strong>暴力修改时间</strong><ol type="1"><li><code>ntpdate</code>直接调整时间，可能导致依赖时序的程序（如定时任务、数据库同步）出错。</li><li><code>ntpsec</code> 采用 <strong>平滑调整</strong>方式，避免系统出现 <strong>时间跳变</strong> 影响应用。</li></ol></li><li><strong>安全隐患</strong><ol type="1"><li><code>ntpdate</code> 依赖外部 NTP服务器，如果服务器被攻击，可能导致伪造时间同步。</li></ol></li></ol><p><strong>推荐使用 <code>ntpsec</code> 进行长时间运行的同步，避免<code>ntpdate</code> 直接修改系统时间带来的问题。</strong></p><h3 id="timedatectl-管理系统时间和-ntp-设置">timedatectl（管理系统时间和 NTP 设置）</h3><p><code>timedatectl</code> 是一个命令行工具，用于在 Linux系统上查看和配置系统时间和日期相关设置。它提供了一种简单且统一的方式来管理系统时间，可用于查看当前时间、时区设置，更改时间和日期，启用或禁用NTP 同步等操作。<code>timedatectl</code> 主要是整合了两类指令：</p><ul><li><p>date：改时间日期（软件时间，程序计算的时间）</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203120351446.png" alt="image-20250203120351446"><figcaption aria-hidden="true">image-20250203120351446</figcaption></figure></li><li><p>hwlock：改硬件时间（计算机的主板上有一个 BIOS的系统以及纽扣电池提供电量），可以同步硬件时间和软件时间，但现在timedatectl 直接都做同步了。</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203120334565.png" alt="image-20250203120334565"><figcaption aria-hidden="true">image-20250203120334565</figcaption></figure></li></ul><p>也就是说我们可以选择自己搭建一个<code>ntpsec</code>，也可以选择直接使用 <code>timedatectl</code>自动运行一个 <code>ntpsec</code>。</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203121839638.png" alt="image-20250203121839638"><figcaption aria-hidden="true">image-20250203121839638</figcaption></figure><p>我们可以做个实验，先把原来的 <code>ntpsec</code> 服务关掉，再开启<code>timedatectl</code> 这边的服务：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203122209417.png" alt="image-20250203122209417"><figcaption aria-hidden="true">image-20250203122209417</figcaption></figure><p>发现出了问题，经过排查发现 <code>timedatectl</code> 是通过<code>systemd-timesyncd</code> 管理 <code>ntp</code>同步的，因此首先应该安装<code>systemd-timesyncd</code>，然后开启它，再设置<code>timedatectl</code> 里的 <code>set-ntp</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install systemd-timesyncd -y</span><br><span class="line"><span class="comment"># systemctl status systemd-timesyncd</span></span><br><span class="line">sudo systemctl start systemd-timesyncd</span><br><span class="line">timedatectl set-ntp on</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203122508617.png" alt="image-20250203122508617"><figcaption aria-hidden="true">image-20250203122508617</figcaption></figure><p>当我们启动了 <code>ntp</code> 服务后，会发现无法再使用<code>timedatectl</code> 设置时间了：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203122609864.png" alt="image-20250203122609864"><figcaption aria-hidden="true">image-20250203122609864</figcaption></figure><h4 id="查看当前时间和日期信息">查看当前时间和日期信息</h4><p>可以使用以下命令查看系统当前的时间、日期、时区以及 NTP 同步状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl</span><br></pre></td></tr></table></figure><p>执行该命令后，会输出类似如下信息：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203105914072.png" alt="image-20250203105914072"><figcaption aria-hidden="true">image-20250203105914072</figcaption></figure><h4 id="查看可用时区">查看可用时区</h4><p>要查看所有可用的时区列表，可以使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl list-timezones</span><br></pre></td></tr></table></figure><p>这会列出所有支持的时区名称，例如<code>Asia/Shanghai</code>、<code>Europe/London</code> 等。</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203110010533.png" alt="image-20250203110010533"><figcaption aria-hidden="true">image-20250203110010533</figcaption></figure><p>要修改时区或者系统中查看有哪些时区文件也可以手动去做，这也是 CentOS 6中一般使用的方法：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203110415833.png" alt="image-20250203110415833"><figcaption aria-hidden="true">image-20250203110415833</figcaption></figure><h4 id="设置时区">设置时区</h4><p>若要更改系统的时区，可以使用以下命令，将时区名称替换为你需要的时区：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-timezone Asia/Shanghai</span><br></pre></td></tr></table></figure><h4 id="设置时间和日期">设置时间和日期</h4><p>可以直接使用 <code>timedatectl</code>设置系统的时间和日期，例如设置为 2025 年 2 月 3 日 13:00:00：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-time <span class="string">&quot;2025-02-03 13:00:00&quot;</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203121555291.png" alt="image-20250203121555291"><figcaption aria-hidden="true">image-20250203121555291</figcaption></figure><h4 id="启用或禁用-ntp-同步">启用或禁用 NTP 同步</h4><p>如果要启用 NTP 同步，使用以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">timedatectl set-ntp <span class="literal">true</span><span class="comment"># 启用</span></span><br><span class="line">timedatectl set-ntp <span class="literal">false</span><span class="comment"># 禁用</span></span><br></pre></td></tr></table></figure><p><code>ntpd</code> 主要专注于通过 NTP协议与时间服务器进行通信，实现系统时间的精确同步，是一个持续运行的守护进程，负责不断调整系统时间以保持与时间服务器一致。而<code>timedatectl</code>是一个管理系统时间设置的工具，它可以查看系统时间状态、更改时区、设置时间日期以及控制NTP 同步的启用和禁用等操作。可以说 <code>timedatectl</code>提供了一个用户操作界面，而 <code>ntpd</code>则负责实际的时间同步工作，两者可以配合使用，例如使用<code>timedatectl</code> 启用 NTP 同步后，<code>ntpd</code>会按照配置进行时间同步操作。</p><hr><h2 id="firewalld-防火墙服务">2.firewalld (防火墙服务)</h2><h3 id="基本介绍">基本介绍</h3><p>防火墙（Firewall）是一种网络安全工具（安全策略），用于<strong>控制和过滤网络流量</strong>，防止未经授权的访问，同时允许合法的数据通信。它就像一座<strong>智能大门</strong>，决定哪些数据包可以进入或离开计算机或服务器。</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/firewalld-structure+nftables.png" alt="Documentation - Architecture | firewalld"><figcaption aria-hidden="true">Documentation - Architecture |firewalld</figcaption></figure><p>防火墙的主要作用包括：</p><ul><li><strong>拦截恶意流量</strong>：防止黑客攻击、病毒传播或未经许可的访问。</li><li><strong>保护内部网络</strong>：阻止外部设备直接访问你的计算机或服务器的敏感端口，可以禁止来自特殊站点的访问。</li><li><strong>流量管理</strong>：根据设定的规则（如 IP地址、端口号）允许或阻止特定的数据通信，可以关闭不使用的端口，能够禁止特定端口的流出通信。</li></ul><p>简单来说，<strong>防火墙就像保安</strong>，负责检查每个试图进入或离开你网络的“人”（数据包），并决定是放行、拦截还是询问管理员。防火墙分为硬件防火墙和软件防火墙：</p><ul><li>硬件防火墙：在硬件级别实现部分防火墙功能，另一部分功能基于软件实现，性能高，成本高</li><li>软件防火墙：应用软件处理逻辑运行于通用硬件平台之上的防火墙，性能低，成本低</li></ul><p>常见的防火墙服务有：</p><ul><li><p><strong>iptables</strong>（传统 Linux防火墙），是有从前到后之分的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp -m tcp --dport 22 -j ACCEPT<span class="comment"># 接受22端口</span></span><br><span class="line">iptables -A INPUT -p tcp -m tcp --dport 98 -j DROP<span class="comment"># 拒绝98端口</span></span><br></pre></td></tr></table></figure></li><li><p><strong>firewalld</strong>（现代 Linux 动态防火墙），其实也是创建<code>iptables</code> 规则</p></li><li><p><strong>ufw（Uncomplicated Firewall）</strong>（Ubuntu友好型防火墙）</p></li></ul><p>在 Linux 中，<code>firewalld</code> 是基于 iptables/netfilter提供的一层动态防火墙管理，红帽系（RHEL/CentOS）常用，提供可实时加载规则，支持zone、service、port 等管理方式。</p><h3 id="firewalld-服务脚本">firewalld 服务脚本</h3><p>我们可以通过以下命令查看防火墙服务名以及查看服务脚本：</p><blockquote><p>服务管理脚本其实就是帮我们执行软件提供的二进制命令，firewalld、nginx和其他软件都是这样</p></blockquote><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203192318288.png" alt="image-20250203192318288"><figcaption aria-hidden="true">image-20250203192318288</figcaption></figure><h3 id="启用与关闭">启用与关闭</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl start firewalld</span><br><span class="line">systemctl <span class="built_in">enable</span> firewalld</span><br><span class="line"></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><p><code>firewalld</code>默认使用运行模式，运行模式是配置的防火墙策略立即生效，但不写入配置文件，与之相对的是永久模式，此模式下配置的防火墙策略写入配置文件，但要<code>reload</code> 才生效。</p><h3 id="常用规则操作">常用规则操作</h3><h4 id="添加删除端口允许规则">添加/删除端口允许规则</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放80端口</span></span><br><span class="line">firewall-cmd --permanent --add-port=80/tcp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><ul><li><p><code>--permanent</code>：写入永久规则，需要<code>--reload</code> 生效。</p></li><li><p>若只想临时生效可不加 <code>--permanent</code>。</p></li><li><p>如果不加对应的协议会报错：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: INVALID_PORT: bad port (most likely missing protocol), correct syntax is portid[-portid]/protocol</span><br></pre></td></tr></table></figure></li></ul><p>举个例子，我们现在使用以下命令从89端口启动一个简单的HTTP服务（首先需要将虚拟机设置为桥接模式）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 89</span><br></pre></td></tr></table></figure><p>我们会发现输入这个网址并没有连接成功：http://0.0.0.0:89/</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250204234359318.png" alt="image-20250204234359318"><figcaption aria-hidden="true">image-20250204234359318</figcaption></figure><p>原因当然是我们在主机上要访问的是虚拟机的地址+端口号啦，但测试了虚拟机的地址后依然发现没有连接成功，我们回去看一下我们防火墙的规则，发现其实我们并没有开启89端口：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250204234438104.png" alt="image-20250204234438104"><figcaption aria-hidden="true">image-20250204234438104</figcaption></figure><p>因此我们需要手动先开启端口再尝试连接：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205000851177.png" alt="image-20250205000851177"><figcaption aria-hidden="true">image-20250205000851177</figcaption></figure><p>大功告成：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205000900921.png" alt="image-20250205000900921"><figcaption aria-hidden="true">image-20250205000900921</figcaption></figure><p>接下来我们可以删除端口：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --remove-port=89/tcp</span><br><span class="line"><span class="comment"># success</span></span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205001405409.png" alt="image-20250205001405409"><figcaption aria-hidden="true">image-20250205001405409</figcaption></figure><p>现在又不能连接上了～</p><blockquote><p>补充 tcp协议和 udp 协议：</p><ul><li>tcp协议是一个安全可靠的连接，需要双向确认，客户端和服务端都需要确认对方连接上了才能通信。</li><li>udp协议是一个不可靠的连接协议，客户端可以随便给服务端发，不需要对方确认</li></ul><p>比如在一个很差的网络环境下，网页无法访问，无法做 DNS 解析，但 QQ可以收发消息。因为网络网站服务用的都是 TCP 协议，而 QQ 和 ntp 用的都是UDP 协议。</p></blockquote><h4 id="添加删除服务">添加/删除服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放ntp服务（一般包含80端口规则）</span></span><br><span class="line">firewall-cmd --permanent --add-service=ntp</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205002650259.png" alt="image-20250205002650259"><figcaption aria-hidden="true">image-20250205002650259</figcaption></figure><p>注意：我们有些服务其实是被包含在一些大模块下的，比如我们想要直接添加nginx 服务是做不到的，但我们可以添加http服务，放行80端口即可：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205004341309.png" alt="image-20250205004341309"><figcaption aria-hidden="true">image-20250205004341309</figcaption></figure><p>如果 nginx 不是绑定在80端口就不好使了，得直接指定端口号进行添加：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205004835538.png" alt="image-20250205004835538"><figcaption aria-hidden="true">image-20250205004835538</figcaption></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205004824003.png" alt="image-20250205004824003"><figcaption aria-hidden="true">image-20250205004824003</figcaption></figure><p>总结就是最好直接针对端口号和协议号添加规则，而且<code>firewalld</code> 使用起来限制比较多，可以直接使用<code>iptables</code>，它支持很多复杂的参数，针对协议、来源端口、目标端口等，如公有云的安全组（阿里云提供的硬件防火墙）也是基于<code>iptables</code> 这样的规则添加的。</p><h4 id="zone概念">zone概念</h4><p><code>firewalld</code> 中把网络接口与 zone 绑定，不同zone（public、trusted、internal等）可有不同规则策略，以细分安全级别。</p><table><colgroup><col style="width: 10%"><col style="width: 7%"><col style="width: 50%"><col style="width: 31%"></colgroup><thead><tr><th>区域名称</th><th>信任级别</th><th>默认策略</th><th>典型应用场景</th></tr></thead><tbody><tr><td><strong>drop</strong></td><td>最低</td><td>丢弃所有传入流量，不回应任何请求，允许所有传出流量</td><td>最高安全性，完全隐藏设备，如黑洞防护</td></tr><tr><td><strong>block</strong></td><td>低</td><td>拒绝所有传入流量（返回 ICMP 端口不可达），允许所有传出流量</td><td>仅允许受信任的系统主动连接</td></tr><tr><td><strong>public</strong></td><td>低</td><td>允许出站连接，默认拒绝所有入站连接，仅允许 SSH</td><td>公共网络，如 WiFi 热点或陌生环境</td></tr><tr><td><strong>external</strong></td><td>中</td><td>用于 NAT 路由，默认只允许出站连接</td><td>服务器充当路由器，保护内部网络</td></tr><tr><td><strong>dmz</strong></td><td>中</td><td>允许外部访问特定服务，如 HTTP/HTTPS，默认拒绝所有其他流量</td><td>部署 Web 服务器或公共服务的隔离区域</td></tr><tr><td><strong>work</strong></td><td>高</td><td>允许内部可信网络的访问，默认允许 SSH、Samba</td><td>公司内部网络，适用于员工办公环境</td></tr><tr><td><strong>home</strong></td><td>高</td><td>允许家用网络的访问，默认允许 SSH、Samba、mDNS</td><td>家庭网络，适用于个人设备互通</td></tr><tr><td><strong>internal</strong></td><td>高</td><td>允许内部设备访问，默认允许 SSH、Samba、mDNS</td><td>受信任的局域网，如 VPN 连接</td></tr><tr><td><strong>trusted</strong></td><td>最高</td><td>允许所有流量（入站和出站）</td><td>完全信任的环境，如封闭内网</td></tr></tbody></table><p><strong>查看当前默认区域：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-default-zone</span><br><span class="line"><span class="comment"># public</span></span><br></pre></td></tr></table></figure><p><strong>修改默认区域：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --set-default-zone=work</span><br></pre></td></tr></table></figure><p><strong>列出所有区域的名字：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --get-zones</span><br><span class="line"><span class="comment"># block dmz drop external home internal public trusted work</span></span><br></pre></td></tr></table></figure><p><strong>查询某个区域的默认规则：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public --list-all</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250203194047421.png" alt="image-20250203194047421"><figcaption aria-hidden="true">image-20250203194047421</figcaption></figure><p><strong>变更某个接口的区域：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --zone=home --change-interface=eth0 --permanent</span><br></pre></td></tr></table></figure><p>然后重新加载防火墙：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><h3 id="复杂规则">复杂规则</h3><p>可借助 <code>--add-rich-rule</code>来添加更复杂的匹配条件，如限制特定 IP 地址、端口、协议等；或直接使用<code>iptables</code> 语法进行自定义，注意与 firewalld的并存管理时要小心冲突。</p><h2 id="计划任务crontab">3.计划任务（crontab）</h2><p>计划任务让系统在指定时间周期自动执行某些脚本或命令，例如：</p><ul><li>定时备份数据库，每天凌晨 2 点；<br></li><li>定时清理日志文件或临时文件夹。</li></ul><h3 id="编辑与常用操作">编辑与常用操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crontab -e       <span class="comment"># 编辑当前用户的计划任务</span></span><br><span class="line">crontab -l       <span class="comment"># 查看</span></span><br><span class="line">crontab -r       <span class="comment"># 删除</span></span><br></pre></td></tr></table></figure><p><strong>条目格式</strong>：<br><code>MIN HOUR DAY MONTH WEEKDAY command</code></p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205103130393.png" alt="image-20250205103130393"><figcaption aria-hidden="true">image-20250205103130393</figcaption></figure><p>注意：</p><ol type="1"><li>写在定时任务里的命令必须是绝对路径，不容易出错</li><li>日期和星期是不能同时写的</li><li>WEEKDAY 从 0 到 7 分别表示周日到周六</li><li>四个符号<ol type="1"><li><code>*</code> 表示取值范围中的每一个数字</li><li><code>-</code> 是做连续区间表达式的，想要表达 <code>1-7</code>就直接写 <code>1-7</code> 即可</li><li><code>/</code> 表示每多少个，例如想每十分钟一次，可以在分的位置写<code>*/10</code></li><li><code>,</code> 表示多个取值例如想在 1 点、2 点、6 点执行，可以写<code>1,2,6</code></li></ol></li></ol><p>例如，每天凌晨 1:30 运行脚本<code>/usr/local/bin/backup.sh</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 1 * * * /usr/local/bin/backup.sh</span><br></pre></td></tr></table></figure><p>每天凌晨2点30，执行 <code>ntpdate</code> 命令同步<code>ntp.aliyun.com</code>且不输入任何信息（也就是把命令结果重定向到黑洞文件<code>/dev/null</code>）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">30 2 * * * /usr/sbin/ntpdate -u ntp.aliyun.com &amp;&gt; /dev/null</span><br></pre></td></tr></table></figure><p>现在做一个简单的测试，首先运行 <code>crontab -e</code>进入写定时任务的界面：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205113536906.png" alt="image-20250205113536906"><figcaption aria-hidden="true">image-20250205113536906</figcaption></figure><p>可以看到定时任务已经生效了：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205114021239.png" alt="image-20250205114021239"><figcaption aria-hidden="true">image-20250205114021239</figcaption></figure><h3 id="相关目录">相关目录</h3><ul><li><p><code>/etc/crontab</code> /<code>/etc/cron.d</code>：系统级计划任务配置。</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205115927338.png" alt="image-20250205115927338"><figcaption aria-hidden="true">image-20250205115927338</figcaption></figure></li><li><p><code>/etc/cron.daily/</code>, <code>/etc/cron.hourly/</code>,<code>/etc/cron.weekly/</code>,<code>/etc/cron.monthly/</code>：自动分类执行脚本。</p></li></ul><p>要查看 <code>crontab</code> 的日志，可以查找：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep CRON /var/log/syslog</span><br></pre></td></tr></table></figure><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250205115740974.png" alt="image-20250205115740974"><figcaption aria-hidden="true">image-20250205115740974</figcaption></figure><h3 id="黑名单和白名单">黑名单和白名单</h3><p>超级管理员可以通过配置来设置某些用户不允许设置计划任务，配置文件在<code>/etc/cron.deny</code>，里面每行写一个用户名，白名单在<code>/etc/allow</code>。白名单优先级高于黑名单，如果一个用户同时存在于两个名单中，则会被默认允许创建计划任务。</p><h2 id="ssh-secure-shell">4.SSH (Secure Shell)</h2><h3 id="作用与原理">作用与原理</h3><p><strong>SSH</strong> (Secure Shell)提供安全的远程登录方式，可替代明文的 telnet/rsh。常见服务端程序如<code>sshd</code>，允许远程客户端 <code>ssh user@host</code>方式连接。</p><ul><li><strong>默认端口</strong>：22</li><li><strong>加密通信</strong>：所有数据（含密码）都通过加密隧道传输，确保安全性。</li></ul><p>查看软件的网络配置：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250128145224693.png" alt="image-20250128145224693"><figcaption aria-hidden="true">image-20250128145224693</figcaption></figure><p>其中 <code>ens</code>是真实的网卡配置文件。在网卡配置文件中，<code>BOOTPROTO</code>这一个变量控制的是 IP 的获取方式，其中 <code>dhcp</code>为动态分配，VMware 虚拟网卡会自动给你分配 IP 地址，而<code>static</code>为静态 IP，即自己手动根据网络环境设置固定的 IP 地址。一般默认启动network 服务都是获取 <code>dhcp</code> 动态 IP，可用范围一般是192.168.0.2 到192.168.0.254，同时会有一个默认的地址租期，这段时间内某台设备没用的话这个IP 就会分配给别的设备，网关是流量出去的大门。</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/interlace,1.png" alt="TP-LINK"><figcaption aria-hidden="true">TP-LINK</figcaption></figure><p>要将动态 IP 修改为静态 IP，首先查看这个文件：</p><figure><img src="/Linux-%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/image-20250130151023153.png" alt="image-20250130151023153"><figcaption aria-hidden="true">image-20250130151023153</figcaption></figure><p>需要修改写入的内容形式可以为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对于桥接模式</span></span><br><span class="line"></span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    ens33:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses: [192.168.1.50/24]</span><br><span class="line">      gateway4: 192.168.1.1</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [8.8.8.8, 8.8.4.4]</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 对于NAT模式</span></span><br><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  renderer: networkd</span><br><span class="line">  ethernets:</span><br><span class="line">    ens33:</span><br><span class="line">      dhcp4: no</span><br><span class="line">      addresses: [192.168.182.200/24]</span><br><span class="line">      gateway4: 192.168.182.2</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [8.8.8.8, 8.8.4.4]</span><br></pre></td></tr></table></figure><p>注意 address 写之前记得 ping一下看看是否存在。最后修改完配置文件记得要重庆网络。</p><h3 id="启动与管理">启动与管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">systemctl start sshd</span><br><span class="line">systemctl <span class="built_in">enable</span> sshd</span><br><span class="line">systemctl status sshd</span><br><span class="line">systemctl reload sshd</span><br><span class="line">systemctl <span class="built_in">enable</span> sshd    <span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">disable</span> sshd</span><br><span class="line">systemctl is-enabled sshd.service    <span class="comment"># 查看是否开机自启</span></span><br></pre></td></tr></table></figure><ul><li><code>sshd</code> 为守护进程名，在某些发行版中也写作<code>ssh</code>。</li></ul><h3 id="主要配置">主要配置</h3><p><strong>配置文件</strong>：<code>/etc/ssh/sshd_config</code>。</p><ul><li><code>Port</code>：指定 SSH 监听端口（可修改防止被暴力扫描）。<br></li><li><code>PermitRootLogin</code>：是否允许 root 用户直接登录。<br></li><li><code>PasswordAuthentication</code>：可禁止密码登录，改为公钥方式以提升安全。</li></ul><h3 id="常见使用场景">常见使用场景</h3><ol type="1"><li><p><strong>远程登录</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@192.168.1.100</span><br></pre></td></tr></table></figure></li><li><p><strong>文件传输</strong>：<code>scp</code> 或 <code>sftp</code>通过 SSH 通道安全地上传/下载文件。<br></p></li><li><p><strong>SSH 公钥免密</strong>：把本地公钥加到目标主机的<code>~/.ssh/authorized_keys</code> 里，即可免密码登录。</p></li></ol><h1 id="四源码包与二进制包软件安装模式">四、源码包与二进制包：软件安装模式</h1><h2 id="源码包">1.源码包</h2><ul><li>优点：可自由编译选项、适配性好、可进行自定义特性；<br></li><li>缺点：手动编译复杂、编译周期长、依赖配置繁琐。</li></ul><p>编译安装流程一般为</p><ol type="1"><li><code>./configure --prefix=... [--with-... etc]</code><br></li><li><code>make</code><br></li><li><code>make install</code></li></ol><p>安装结果通常放在指定 <code>prefix</code> 路径，需自行创建服务脚本或systemd unit 文件。</p><h2 id="二进制包">2.二进制包</h2><ul><li><strong>RPM</strong> 系：RedHat/CentOS 等使用的包管理格式，如<code>yum</code>、<code>dnf</code>。</li><li><strong>DEB</strong> 系：Debian/Ubuntu 用 apt/dpkg 安装。<br></li><li>优点：安装方便，自动处理依赖，大多数发行版官方仓库都提供常见软件包；<br></li><li>缺点：可定制程度较低，版本可能不够新。</li></ul><p><strong>RPM</strong>（Red Hat Package Manager）是 RedHat系统的底层包管理工具，<code>yum</code>/<code>dnf</code>是对其的高层封装。</p><p><strong>常见命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh package.rpm     <span class="comment"># 安装</span></span><br><span class="line">rpm -Uvh package.rpm     <span class="comment"># 升级</span></span><br><span class="line">rpm -e packagename       <span class="comment"># 卸载</span></span><br><span class="line">rpm -qa                   <span class="comment"># 查询已安装包列表</span></span><br><span class="line">rpm -qi packagename       <span class="comment"># 查看包信息</span></span><br></pre></td></tr></table></figure><p><strong>更多使用方式</strong></p><ul><li><code>rpm -ql packagename</code>：列出包中安装了哪些文件及路径。</li><li><code>rpm -qf /path/to/file</code>：反查某文件属于哪个 RPM 包。</li><li><code>yum</code>/<code>dnf</code>：自动依赖解析，在/etc/yum.repos.d/ 定义源仓库；<ul><li><code>yum install packagename</code>；<br></li><li><code>dnf update</code>；<br></li><li><code>yum remove packagename</code>。</li></ul></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;在操作系统中，“服务”指后台常驻的进程或守护程序。本文介绍常见服务如
ntpd、firewalld、ssh 等的管理，并讲解如何使用 systemctl
命令进行启动、停止、重启与开机自启的配置。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Linux" scheme="https://chenk.top/tags/Linux/"/>
    
    <category term="云计算" scheme="https://chenk.top/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/"/>
    
  </entry>
  
</feed>
