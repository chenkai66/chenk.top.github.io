<!DOCTYPE html>



<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Chen Kai">
    
    <title>
        
            云计算（三）存储系统与分布式架构 |
        
        Chen Kai Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chenk.top","root":"/","language":"zh-CN","default_language":"zh-CN","languages":["zh-CN","en"],"path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Chen Kai Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    
    
    
    
    

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Chen Kai Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    <li class="menu-item lang-switch lang-switch-trigger" title="Language">
                        <i class="fas fa-globe"></i>
                    </li>
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item lang-switch-trigger"><i class="fas fa-globe"></i></div>
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    
    
    
    

    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">云计算（三）存储系统与分布式架构</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Chen Kai</span>
                        
                            <span class="author-label">BOSS</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    
    
    
    
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2023-10-27 00:00:00</span>
        <span class="mobile">2023-10-27 00:00</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Cloud-Computing/">Cloud Computing</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/">分布式存储</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/">对象存储</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/HDFS/">HDFS</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Ceph/">Ceph</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>10.7k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>50 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>在云计算的三大核心服务中，存储系统往往是最容易被忽视但又是最关键的组件。无论是对象存储、块存储还是文件存储，它们都承载着现代应用的数据基石。本文将从分布式存储的理论基础出发，深入探讨各类存储系统的架构设计与实现细节，并通过实战案例展示如何在实际生产环境中部署、优化和管理大规模存储集群。</p>
<span id="more"></span>
<h2 id="分布式存储基础">分布式存储基础</h2>
<h3 id="cap-定理与存储系统">CAP 定理与存储系统</h3>
<p>CAP
定理指出，在分布式系统中，一致性（Consistency）、可用性（Availability）和分区容错性（Partition
tolerance）三者不可兼得，最多只能同时满足两个。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────┐</span><br><span class="line">│        分布式存储系统                    │</span><br><span class="line">├─────────────────────────────────────────┤</span><br><span class="line">│                                         │</span><br><span class="line">│  一致性 (C)  ←→  可用性 (A)            │</span><br><span class="line">│         ↖         ↙                     │</span><br><span class="line">│          分区容错 (P)                    │</span><br><span class="line">│                                         │</span><br><span class="line">│  必须选择：CP 或 AP                     │</span><br><span class="line">└─────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>CP 系统</strong>（一致性优先）：</p>
<ul>
<li>典型代表：HDFS、传统关系型数据库集群</li>
<li>特点：强一致性，但网络分区时可能不可用</li>
<li>适用场景：金融交易、关键业务数据</li>
</ul>
<p><strong>AP 系统</strong>（可用性优先）：</p>
<ul>
<li>典型代表：Amazon S3、Cassandra</li>
<li>特点：高可用，但可能出现最终一致性</li>
<li>适用场景：内容分发、日志存储、非关键数据</li>
</ul>
<p><strong>CA 系统</strong>：</p>
<ul>
<li>在分布式环境下无法实现（必须容忍网络分区）</li>
</ul>
<h3 id="base-理论">BASE 理论</h3>
<p>BASE 是 CAP 定理中 AP 方向的延伸：</p>
<ul>
<li><strong>BA</strong>（Basically
Available）：基本可用，允许部分功能降级</li>
<li><strong>S</strong>（Soft state）：软状态，允许中间状态存在</li>
<li><strong>E</strong>（Eventually
consistent）：最终一致性，数据最终会达到一致</li>
</ul>
<p>对象存储系统通常采用 BASE 理论，通过异步复制实现最终一致性。</p>
<h3 id="数据分布策略">数据分布策略</h3>
<p><strong>一致性哈希</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">节点环:  [Node1]---[Node2]---[Node3]---[Node1]</span><br><span class="line">          ↓         ↓         ↓</span><br><span class="line">         Key1      Key2      Key3</span><br></pre></td></tr></table></figure></p>
<p>一致性哈希解决了传统哈希在节点增减时需要大量数据迁移的问题。当节点加入或离开时，只需要迁移相邻节点的部分数据。</p>
<p><strong>虚拟节点（Virtual Nodes）</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">物理节点: Node1, Node2, Node3</span><br><span class="line">虚拟节点: V1-1, V1-2, V1-3 (属于Node1)</span><br><span class="line">          V2-1, V2-2, V2-3 (属于Node2)</span><br><span class="line">          V3-1, V3-2, V3-3 (属于Node3)</span><br></pre></td></tr></table></figure></p>
<p>虚拟节点技术让数据分布更加均匀，避免热点问题。</p>
<h2 id="对象存储详解">对象存储详解</h2>
<h3 id="s3oss-架构设计">S3/OSS 架构设计</h3>
<p>对象存储的核心思想是将数据作为对象（Object）存储，每个对象包含：</p>
<ul>
<li><strong>数据本身</strong>（Data）</li>
<li><strong>元数据</strong>（Metadata）</li>
<li><strong>唯一标识符</strong>（Object Key）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│           对象存储架构                       │</span><br><span class="line">├─────────────────────────────────────────────┤</span><br><span class="line">│                                             │</span><br><span class="line">│  ┌──────────┐    ┌──────────┐              │</span><br><span class="line">│  │ API Gateway│   │ 元数据服务 │            │</span><br><span class="line">│  └────┬─────┘    └────┬─────┘              │</span><br><span class="line">│       │               │                     │</span><br><span class="line">│       └───────┬───────┘                     │</span><br><span class="line">│               │                             │</span><br><span class="line">│       ┌───────▼───────┐                     │</span><br><span class="line">│       │  对象存储服务  │                     │</span><br><span class="line">│       └───────┬───────┘                     │</span><br><span class="line">│               │                             │</span><br><span class="line">│    ┌──────────┼──────────┐                 │</span><br><span class="line">│    │          │          │                 │</span><br><span class="line">│ ┌──▼──┐  ┌───▼───┐  ┌───▼───┐            │</span><br><span class="line">│ │存储节点1│ │存储节点2│ │存储节点3│            │</span><br><span class="line">│ └─────┘  └──────┘  └──────┘            │</span><br><span class="line">│                                             │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<h3 id="s3-api-核心操作">S3 API 核心操作</h3>
<p><strong>PUT Object</strong>（上传对象）： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>,</span><br><span class="line">    endpoint_url=<span class="string">&#x27;https://oss.example.com&#x27;</span>,</span><br><span class="line">    aws_access_key_id=<span class="string">&#x27;your-access-key&#x27;</span>,</span><br><span class="line">    aws_secret_access_key=<span class="string">&#x27;your-secret-key&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传小文件（&lt;5MB）</span></span><br><span class="line">s3.put_object(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;path/to/file.jpg&#x27;</span>,</span><br><span class="line">    Body=<span class="built_in">open</span>(<span class="string">&#x27;file.jpg&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>),</span><br><span class="line">    ContentType=<span class="string">&#x27;image/jpeg&#x27;</span>,</span><br><span class="line">    Metadata=&#123;<span class="string">&#x27;author&#x27;</span>: <span class="string">&#x27;user123&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分片上传大文件（Multipart Upload）</span></span><br><span class="line">upload_id = s3.create_multipart_upload(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;large-file.zip&#x27;</span></span><br><span class="line">)[<span class="string">&#x27;UploadId&#x27;</span>]</span><br><span class="line"></span><br><span class="line">parts = []</span><br><span class="line">part_number = <span class="number">1</span></span><br><span class="line">chunk_size = <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 5MB</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;large-file.zip&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        chunk = f.read(chunk_size)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        part = s3.upload_part(</span><br><span class="line">            Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">            Key=<span class="string">&#x27;large-file.zip&#x27;</span>,</span><br><span class="line">            PartNumber=part_number,</span><br><span class="line">            UploadId=upload_id,</span><br><span class="line">            Body=chunk</span><br><span class="line">        )</span><br><span class="line">        parts.append(&#123;<span class="string">&#x27;PartNumber&#x27;</span>: part_number, <span class="string">&#x27;ETag&#x27;</span>: part[<span class="string">&#x27;ETag&#x27;</span>]&#125;)</span><br><span class="line">        part_number += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">s3.complete_multipart_upload(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;large-file.zip&#x27;</span>,</span><br><span class="line">    UploadId=upload_id,</span><br><span class="line">    MultipartUpload=&#123;<span class="string">&#x27;Parts&#x27;</span>: parts&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><strong>GET Object</strong>（下载对象）： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载整个对象</span></span><br><span class="line">response = s3.get_object(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;path/to/file.jpg&#x27;</span></span><br><span class="line">)</span><br><span class="line">data = response[<span class="string">&#x27;Body&#x27;</span>].read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 范围下载（Range Request）</span></span><br><span class="line">response = s3.get_object(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;large-file.zip&#x27;</span>,</span><br><span class="line">    Range=<span class="string">&#x27;bytes=0-1048575&#x27;</span>  <span class="comment"># 下载前1MB</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><strong>LIST Objects</strong>（列出对象）： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简单列出</span></span><br><span class="line">objects = s3.list_objects_v2(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Prefix=<span class="string">&#x27;images/&#x27;</span>,</span><br><span class="line">    MaxKeys=<span class="number">1000</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分页列出</span></span><br><span class="line">paginator = s3.get_paginator(<span class="string">&#x27;list_objects_v2&#x27;</span>)</span><br><span class="line">pages = paginator.paginate(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Prefix=<span class="string">&#x27;images/&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> page <span class="keyword">in</span> pages:</span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> page.get(<span class="string">&#x27;Contents&#x27;</span>, []):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;obj[<span class="string">&#x27;Key&#x27;</span>]&#125;</span>: <span class="subst">&#123;obj[<span class="string">&#x27;Size&#x27;</span>]&#125;</span> bytes&quot;</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="对象存储实现细节">对象存储实现细节</h3>
<p><strong>命名空间设计</strong>：</p>
<ul>
<li><strong>扁平化结构</strong>：所有对象存储在同一命名空间，通过 Key
区分</li>
<li><strong>模拟目录</strong>：通过 Key 中的 <code>/</code>
模拟目录结构（如 <code>images/2024/photo.jpg</code>）</li>
<li><strong>桶（Bucket）隔离</strong>：不同桶之间完全隔离，可作为多租户边界</li>
</ul>
<p><strong>元数据存储</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">对象元数据表结构：</span><br><span class="line">┌─────────────┬──────────────┬─────────────┬─────────────┐</span><br><span class="line">│ Object Key  │ Size (bytes) │ ContentType │ CreateTime  │</span><br><span class="line">├─────────────┼──────────────┼─────────────┼─────────────┤</span><br><span class="line">│ file1.jpg   │ 1,234,567    │ image/jpeg  │ 2024-01-01  │</span><br><span class="line">│ file2.pdf   │ 5,678,901    │ application │ 2024-01-02  │</span><br><span class="line">│             │              │ /pdf        │             │</span><br><span class="line">└─────────────┴──────────────┴─────────────┴─────────────┘</span><br></pre></td></tr></table></figure></p>
<p>元数据通常存储在分布式数据库（如
DynamoDB、Cassandra）或专门的元数据服务中。</p>
<p><strong>数据冗余策略</strong>：</p>
<ul>
<li><strong>多副本</strong>：同一对象存储多个副本（通常 3 副本）</li>
<li><strong>纠删码（Erasure Coding）</strong>：将数据分成 k
个数据块，生成 m 个校验块，总共 n=k+m 个块。可以容忍任意 m
个块丢失。</li>
</ul>
<p>纠删码示例（RS(10,4)）： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">原始数据: [D1, D2, D3, D4, D5, D6, D7, D8, D9, D10]</span><br><span class="line">         ↓ 编码</span><br><span class="line">存储块:   [D1...D10, P1, P2, P3, P4]</span><br><span class="line">         </span><br><span class="line">可容忍任意 4 个块丢失（数据块或校验块）</span><br><span class="line">存储效率: 10/14 ≈ 71%（相比 3 副本的 33% 更高效）</span><br></pre></td></tr></table></figure></p>
<h2 id="块存储与文件存储深度对比">块存储与文件存储深度对比</h2>
<h3 id="块存储block-storage">块存储（Block Storage）</h3>
<p>块存储将数据分割成固定大小的块（通常
4KB-1MB），每个块有唯一地址。操作系统通过块设备接口访问。</p>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>低延迟</strong>：直接访问块，无需文件系统层</li>
<li><strong>高性能</strong>：适合数据库、虚拟机磁盘</li>
<li><strong>无结构</strong>：只有块地址，无文件概念</li>
</ul>
<p><strong>典型应用</strong>：</p>
<ul>
<li>数据库数据文件（MySQL、PostgreSQL）</li>
<li>虚拟机虚拟磁盘（VMware、KVM）</li>
<li>高性能计算（HPC）应用</li>
</ul>
<p><strong>架构示例</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">应用层</span><br><span class="line">  ↓</span><br><span class="line">文件系统（ext4/xfs）</span><br><span class="line">  ↓</span><br><span class="line">块设备接口（/dev/sda1）</span><br><span class="line">  ↓</span><br><span class="line">块存储服务（iSCSI/Ceph RBD）</span><br><span class="line">  ↓</span><br><span class="line">物理存储节点</span><br></pre></td></tr></table></figure></p>
<h3 id="文件存储file-storage">文件存储（File Storage）</h3>
<p>文件存储提供完整的文件系统接口，支持目录树、权限管理、文件属性等。</p>
<p><strong>特点</strong>：</p>
<ul>
<li><strong>结构化</strong>：完整的目录树和文件系统语义</li>
<li><strong>共享访问</strong>：多个客户端可同时访问同一文件系统</li>
<li><strong>协议支持</strong>：NFS、SMB/CIFS、FUSE</li>
</ul>
<p><strong>典型应用</strong>：</p>
<ul>
<li>共享文档存储</li>
<li>代码仓库（Git）</li>
<li>媒体文件存储</li>
<li>容器持久化存储</li>
</ul>
<h3 id="对比表格">对比表格</h3>
<table>
<colgroup>
<col style="width: 17%">
<col style="width: 23%">
<col style="width: 29%">
<col style="width: 29%">
</colgroup>
<thead>
<tr>
<th>特性</th>
<th>块存储</th>
<th>文件存储</th>
<th>对象存储</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>访问接口</strong></td>
<td>块设备（/dev/sdX）</td>
<td>文件系统（/mnt/nfs）</td>
<td>REST API（HTTP）</td>
</tr>
<tr>
<td><strong>延迟</strong></td>
<td>极低（&lt;1ms）</td>
<td>低（1-10ms）</td>
<td>中等（10-100ms）</td>
</tr>
<tr>
<td><strong>吞吐量</strong></td>
<td>极高（&gt;10GB/s）</td>
<td>高（1-10GB/s）</td>
<td>高（1-10GB/s）</td>
</tr>
<tr>
<td><strong>一致性模型</strong></td>
<td>强一致性</td>
<td>强一致性</td>
<td>最终一致性</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>中等</td>
<td>高</td>
<td>极高</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>数据库、虚拟机</td>
<td>共享文件、代码库</td>
<td>静态资源、备份</td>
</tr>
<tr>
<td><strong>成本</strong></td>
<td>高</td>
<td>中</td>
<td>低</td>
</tr>
</tbody>
</table>
<h3 id="选择建议">选择建议</h3>
<p><strong>选择块存储当</strong>：</p>
<ul>
<li>需要极低延迟（数据库）</li>
<li>需要随机读写（OLTP 系统）</li>
<li>应用需要直接控制块布局</li>
</ul>
<p><strong>选择文件存储当</strong>：</p>
<ul>
<li>需要共享访问（多服务器共享数据）</li>
<li>需要 POSIX 文件系统语义</li>
<li>传统应用迁移（无需修改代码）</li>
</ul>
<p><strong>选择对象存储当</strong>：</p>
<ul>
<li>存储大量静态文件（图片、视频）</li>
<li>需要全球分发（CDN 集成）</li>
<li>成本敏感（冷数据归档）</li>
</ul>
<h2 id="hdfs-分布式文件系统实践">HDFS 分布式文件系统实践</h2>
<h3 id="hdfs-架构">HDFS 架构</h3>
<p>HDFS（Hadoop Distributed File System）是 Hadoop
生态的核心存储组件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────┐</span><br><span class="line">│              HDFS 架构                          │</span><br><span class="line">├─────────────────────────────────────────────────┤</span><br><span class="line">│                                                 │</span><br><span class="line">│  ┌──────────────┐                              │</span><br><span class="line">│  │  NameNode    │  (主节点，管理元数据)         │</span><br><span class="line">│  │  (Active)    │                              │</span><br><span class="line">│  └──────┬───────┘                              │</span><br><span class="line">│         │                                       │</span><br><span class="line">│  ┌──────▼───────┐                              │</span><br><span class="line">│  │  NameNode    │  (备用节点，高可用)          │</span><br><span class="line">│  │  (Standby)   │                              │</span><br><span class="line">│  └──────────────┘                              │</span><br><span class="line">│                                                 │</span><br><span class="line">│         │                                       │</span><br><span class="line">│    ┌────┴────┐                                 │</span><br><span class="line">│    │         │                                 │</span><br><span class="line">│ ┌──▼──┐  ┌──▼──┐  ┌──▼──┐                    │</span><br><span class="line">│ │DataNode│ │DataNode│ │DataNode│                │</span><br><span class="line">│ │  1    │ │  2    │ │  3    │                │</span><br><span class="line">│ └──────┘  └──────┘  └──────┘                │</span><br><span class="line">│                                                 │</span><br><span class="line">└─────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>核心组件</strong>：</p>
<ul>
<li><strong>NameNode</strong>：管理文件系统命名空间和客户端访问</li>
<li><strong>DataNode</strong>：存储实际数据块</li>
<li><strong>Secondary NameNode</strong>：辅助
NameNode，执行检查点操作</li>
</ul>
<h3 id="hdfs-数据组织">HDFS 数据组织</h3>
<p><strong>文件分块</strong>：</p>
<ul>
<li>默认块大小：128MB（Hadoop 2.x+）或 64MB（Hadoop 1.x）</li>
<li>大文件被分割成多个块</li>
<li>每个块存储 3 个副本（默认）</li>
</ul>
<p><strong>数据块分布</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">文件: /user/data/large-file.txt (500MB)</span><br><span class="line">      ↓ 分块</span><br><span class="line">块1 (128MB) → DataNode1, DataNode2, DataNode3</span><br><span class="line">块2 (128MB) → DataNode2, DataNode3, DataNode4</span><br><span class="line">块3 (128MB) → DataNode3, DataNode4, DataNode1</span><br><span class="line">块4 (116MB) → DataNode4, DataNode1, DataNode2</span><br></pre></td></tr></table></figure></p>
<h3 id="hdfs-配置示例">HDFS 配置示例</h3>
<p><strong>core-site.xml</strong>： <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- NameNode 地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://namenode:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 临时目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.tmp.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/hadoop/tmp<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>hdfs-site.xml</strong>： <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 副本数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 块大小 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.blocksize<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>134217728<span class="tag">&lt;/<span class="name">value</span>&gt;</span> <span class="comment">&lt;!-- 128MB --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- NameNode 数据目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.name.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/hadoop/namenode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- DataNode 数据目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.datanode.data.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/hadoop/datanode<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 启用 WebHDFS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.webhdfs.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="hdfs-操作命令">HDFS 操作命令</h3>
<p><strong>文件操作</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">hdfs dfs -<span class="built_in">mkdir</span> -p /user/data/input</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line">hdfs dfs -put local-file.txt /user/data/input/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出文件</span></span><br><span class="line">hdfs dfs -<span class="built_in">ls</span> /user/data/input</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件内容</span></span><br><span class="line">hdfs dfs -<span class="built_in">cat</span> /user/data/input/file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载文件</span></span><br><span class="line">hdfs dfs -get /user/data/input/file.txt ./local-file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除文件</span></span><br><span class="line">hdfs dfs -<span class="built_in">rm</span> /user/data/input/file.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件系统使用情况</span></span><br><span class="line">hdfs dfs -<span class="built_in">df</span> -h</span><br></pre></td></tr></table></figure></p>
<p><strong>管理命令</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入安全模式（维护时）</span></span><br><span class="line">hdfs dfsadmin -safemode enter</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出安全模式</span></span><br><span class="line">hdfs dfsadmin -safemode leave</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群状态</span></span><br><span class="line">hdfs dfsadmin -report</span><br><span class="line"></span><br><span class="line"><span class="comment"># 平衡数据分布</span></span><br><span class="line">hdfs balancer -threshold 10</span><br></pre></td></tr></table></figure></p>
<h3 id="hdfs-高可用配置">HDFS 高可用配置</h3>
<p><strong>启用 NameNode HA</strong>（hdfs-site.xml）：
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 启用 HA --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.nameservices<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>mycluster<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- NameNode ID --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.ha.namenodes.mycluster<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>nn1,nn2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- NameNode RPC 地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.mycluster.nn1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>namenode1:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.rpc-address.mycluster.nn2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>namenode2:9000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 共享存储（用于 JournalNode） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.namenode.shared.edits.dir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>qjournal://jn1:8485;jn2:8485;jn3:8485/mycluster<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 故障转移代理 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.client.failover.proxy.provider.mycluster<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="ceph-存储集群部署与管理">Ceph 存储集群部署与管理</h2>
<h3 id="ceph-架构概述">Ceph 架构概述</h3>
<p>Ceph
是一个统一的分布式存储系统，提供对象存储、块存储和文件存储三种接口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────┐</span><br><span class="line">│           Ceph 存储集群                      │</span><br><span class="line">├─────────────────────────────────────────────┤</span><br><span class="line">│                                             │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐ │</span><br><span class="line">│  │ Monitor  │  │ Monitor  │  │ Monitor  │ │</span><br><span class="line">│  │   (MDS)  │  │   (MDS)  │  │   (MDS)  │ │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘ │</span><br><span class="line">│                                             │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐ │</span><br><span class="line">│  │ Manager │  │ Manager  │  │ Manager  │ │</span><br><span class="line">│  └──────────┘  └──────────┘  └──────────┘ │</span><br><span class="line">│                                             │</span><br><span class="line">│  ┌──────────────────────────────────────┐  │</span><br><span class="line">│  │         OSD (Object Storage Daemon) │  │</span><br><span class="line">│  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐       │  │</span><br><span class="line">│  │  │OSD1│ │OSD2│ │OSD3│ │OSD4│ ...   │  │</span><br><span class="line">│  │  └────┘ └────┘ └────┘ └────┘       │  │</span><br><span class="line">│  └──────────────────────────────────────┘  │</span><br><span class="line">│                                             │</span><br><span class="line">└─────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>核心组件</strong>：</p>
<ul>
<li><strong>Monitor (MON)</strong>：维护集群映射和状态</li>
<li><strong>Manager (MGR)</strong>：提供监控和管理接口</li>
<li><strong>OSD</strong>：实际存储数据的守护进程</li>
<li><strong>MDS</strong>（可选）：用于 CephFS 文件系统</li>
</ul>
<h3 id="ceph-部署准备">Ceph 部署准备</h3>
<p><strong>系统要求</strong>：</p>
<ul>
<li>操作系统：CentOS 7+ / Ubuntu 18.04+</li>
<li>内存：每个 OSD 至少 4GB</li>
<li>磁盘：每个 OSD 至少 1TB（推荐 SSD）</li>
<li>网络：10GbE 或更高</li>
</ul>
<p><strong>安装 Ceph</strong>（Ubuntu）： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加 Ceph 仓库</span></span><br><span class="line">wget -q -O- <span class="string">&#x27;https://download.ceph.com/keys/release.asc&#x27;</span> | sudo apt-key add -</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb https://download.ceph.com/debian-octopus/ <span class="subst">$(lsb_release -sc)</span> main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/ceph.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新并安装</span></span><br><span class="line">sudo apt update</span><br><span class="line">sudo apt install ceph-deploy ceph-common</span><br></pre></td></tr></table></figure></p>
<h3 id="ceph-集群部署">Ceph 集群部署</h3>
<p><strong>1. 初始化集群</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建集群配置目录</span></span><br><span class="line"><span class="built_in">mkdir</span> my-cluster</span><br><span class="line"><span class="built_in">cd</span> my-cluster</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新集群（指定第一个 Monitor）</span></span><br><span class="line">ceph-deploy new node1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Ceph（在所有节点）</span></span><br><span class="line">ceph-deploy install node1 node2 node3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 Monitor</span></span><br><span class="line">ceph-deploy mon create-initial</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 部署 OSD</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备 OSD（在所有存储节点）</span></span><br><span class="line">ceph-deploy disk zap node2 /dev/sdb</span><br><span class="line">ceph-deploy disk zap node3 /dev/sdb</span><br><span class="line">ceph-deploy disk zap node4 /dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 OSD</span></span><br><span class="line">ceph-deploy osd create --data /dev/sdb node2</span><br><span class="line">ceph-deploy osd create --data /dev/sdb node3</span><br><span class="line">ceph-deploy osd create --data /dev/sdb node4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署 Manager</span></span><br><span class="line">ceph-deploy mgr create node1</span><br></pre></td></tr></table></figure></p>
<p><strong>3. 部署客户端</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复制配置文件到客户端</span></span><br><span class="line">ceph-deploy admin node-client</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在客户端设置权限</span></span><br><span class="line">sudo <span class="built_in">chmod</span> +r /etc/ceph/ceph.client.admin.keyring</span><br></pre></td></tr></table></figure></p>
<h3 id="ceph-配置管理">Ceph 配置管理</h3>
<p><strong>ceph.conf 示例</strong>： <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">fsid</span> = <span class="number">12345678</span>-<span class="number">1234</span>-<span class="number">1234</span>-<span class="number">1234</span>-<span class="number">123456789</span>abc</span><br><span class="line"><span class="attr">mon_initial_members</span> = node1, node2, node3</span><br><span class="line"><span class="attr">mon_host</span> = <span class="number">192.168</span>.<span class="number">1.10</span>, <span class="number">192.168</span>.<span class="number">1.11</span>, <span class="number">192.168</span>.<span class="number">1.12</span></span><br><span class="line"><span class="attr">auth_cluster_required</span> = cephx</span><br><span class="line"><span class="attr">auth_service_required</span> = cephx</span><br><span class="line"><span class="attr">auth_client_required</span> = cephx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络配置</span></span><br><span class="line"><span class="attr">public_network</span> = <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br><span class="line"><span class="attr">cluster_network</span> = <span class="number">10.0</span>.<span class="number">0.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OSD 配置</span></span><br><span class="line"><span class="attr">osd_journal_size</span> = <span class="number">10240</span></span><br><span class="line"><span class="attr">osd_pool_default_size</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">osd_pool_default_min_size</span> = <span class="number">2</span></span><br><span class="line"><span class="attr">osd_pool_default_pg_num</span> = <span class="number">128</span></span><br><span class="line"><span class="attr">osd_pool_default_pgp_num</span> = <span class="number">128</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能调优</span></span><br><span class="line"><span class="attr">filestore_max_sync_interval</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">journal_max_write_bytes</span> = <span class="number">10737418240</span></span><br><span class="line"><span class="attr">journal_max_write_entries</span> = <span class="number">10000</span></span><br></pre></td></tr></table></figure></p>
<h3 id="ceph-存储池管理">Ceph 存储池管理</h3>
<p><strong>创建存储池</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建副本池</span></span><br><span class="line">ceph osd pool create mypool 128 128</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建纠删码池</span></span><br><span class="line">ceph osd pool create ecpool 32 erasure</span><br><span class="line">ceph osd pool <span class="built_in">set</span> ecpool allow_ec_overwrites <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看池信息</span></span><br><span class="line">ceph osd pool <span class="built_in">ls</span> detail</span><br></pre></td></tr></table></figure></p>
<p><strong>PG（Placement Group）配置</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PG 数量计算公式：</span><br><span class="line">PGs = (OSDs × 100) / 副本数</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line"></span><br><span class="line">- 10 个 OSD，3 副本</span><br><span class="line">- PGs = (10 × 100) / 3 ≈ 333</span><br><span class="line">- 向上取整到 2 的幂次：512</span><br></pre></td></tr></table></figure></p>
<p><strong>设置 PG 数量</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置 PG 数量</span></span><br><span class="line">ceph osd pool <span class="built_in">set</span> mypool pg_num 512</span><br><span class="line">ceph osd pool <span class="built_in">set</span> mypool pgp_num 512</span><br></pre></td></tr></table></figure></p>
<h3 id="ceph-块存储rbd">Ceph 块存储（RBD）</h3>
<p><strong>创建 RBD 镜像</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建镜像</span></span><br><span class="line">rbd create --size 100G mypool/myimage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 映射到本地</span></span><br><span class="line">sudo rbd map mypool/myimage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 格式化并挂载</span></span><br><span class="line">sudo mkfs.ext4 /dev/rbd0</span><br><span class="line">sudo mount /dev/rbd0 /mnt/rbd</span><br></pre></td></tr></table></figure></p>
<p><strong>快照管理</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建快照</span></span><br><span class="line">rbd snap create mypool/myimage@snapshot1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出快照</span></span><br><span class="line">rbd snap <span class="built_in">ls</span> mypool/myimage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到快照</span></span><br><span class="line">rbd snap rollback mypool/myimage@snapshot1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 克隆快照</span></span><br><span class="line">rbd snap protect mypool/myimage@snapshot1</span><br><span class="line">rbd <span class="built_in">clone</span> mypool/myimage@snapshot1 mypool/myclone</span><br></pre></td></tr></table></figure></p>
<h3 id="ceph-对象存储rados-gateway">Ceph 对象存储（RADOS Gateway）</h3>
<p><strong>部署 RGW</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 RGW 实例</span></span><br><span class="line">ceph-deploy rgw create node1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或手动创建</span></span><br><span class="line">ceph auth get-or-create client.rgw.node1 osd <span class="string">&#x27;allow rwx&#x27;</span> mon <span class="string">&#x27;allow rw&#x27;</span> -o /etc/ceph/ceph.client.rgw.keyring</span><br></pre></td></tr></table></figure></p>
<p><strong>RGW 配置</strong>（ceph.conf）： <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client.rgw.node1]</span></span><br><span class="line"><span class="attr">rgw_frontends</span> = civetweb port=<span class="number">7480</span></span><br><span class="line"><span class="attr">rgw_dns_name</span> = s3.example.com</span><br><span class="line"><span class="attr">rgw_zone</span> = default</span><br><span class="line"><span class="attr">rgw_zonegroup</span> = default</span><br></pre></td></tr></table></figure></p>
<p><strong>使用 S3 API</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 s3cmd</span></span><br><span class="line">pip install s3cmd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">s3cmd --configure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建桶</span></span><br><span class="line">s3cmd mb s3://my-bucket</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件</span></span><br><span class="line">s3cmd put file.txt s3://my-bucket/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出对象</span></span><br><span class="line">s3cmd <span class="built_in">ls</span> s3://my-bucket/</span><br></pre></td></tr></table></figure></p>
<h3 id="ceph-监控与维护">Ceph 监控与维护</h3>
<p><strong>集群状态检查</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看集群健康状态</span></span><br><span class="line">ceph health</span><br><span class="line">ceph health detail</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群使用情况</span></span><br><span class="line">ceph <span class="built_in">df</span></span><br><span class="line">ceph <span class="built_in">df</span> detail</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 OSD 状态</span></span><br><span class="line">ceph osd tree</span><br><span class="line">ceph osd <span class="built_in">df</span></span><br></pre></td></tr></table></figure></p>
<p><strong>性能监控</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用 Dashboard（需要 MGR）</span></span><br><span class="line">ceph mgr module <span class="built_in">enable</span> dashboard</span><br><span class="line">ceph dashboard create-self-signed-cert</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问 https://node1:8443</span></span><br></pre></td></tr></table></figure></p>
<p><strong>常见维护操作</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OSD 下线（数据迁移）</span></span><br><span class="line">ceph osd out osd.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># OSD 上线</span></span><br><span class="line">ceph osd <span class="keyword">in</span> osd.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除 OSD</span></span><br><span class="line">ceph osd crush remove osd.1</span><br><span class="line">ceph auth del osd.1</span><br><span class="line">ceph osd <span class="built_in">rm</span> osd.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据重平衡</span></span><br><span class="line">ceph osd reweight osd.1 0.8  <span class="comment"># 降低权重到 80%</span></span><br></pre></td></tr></table></figure></p>
<h2 id="数据一致性与复制策略">数据一致性与复制策略</h2>
<h3 id="一致性模型">一致性模型</h3>
<p><strong>强一致性（Strong Consistency）</strong>：</p>
<ul>
<li>所有副本同时更新</li>
<li>读取总是返回最新数据</li>
<li>实现方式：同步复制 + 多数派写入</li>
</ul>
<p><strong>最终一致性（Eventually Consistency）</strong>：</p>
<ul>
<li>允许短暂的不一致</li>
<li>最终所有副本会达到一致</li>
<li>实现方式：异步复制</li>
</ul>
<p><strong>因果一致性（Causal Consistency）</strong>：</p>
<ul>
<li>保证因果相关的操作顺序</li>
<li>不相关的操作可以乱序</li>
</ul>
<h3 id="复制策略">复制策略</h3>
<p><strong>同步复制</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">写入流程：</span><br><span class="line">Client → Primary → Replica1 (等待确认)</span><br><span class="line">              ↓</span><br><span class="line">           Replica2 (等待确认)</span><br><span class="line">              ↓</span><br><span class="line">        所有副本确认 → Client 收到成功</span><br></pre></td></tr></table></figure></p>
<p><strong>异步复制</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">写入流程：</span><br><span class="line">Client → Primary (立即返回成功)</span><br><span class="line">           ↓</span><br><span class="line">        Replica1 (异步)</span><br><span class="line">           ↓</span><br><span class="line">        Replica2 (异步)</span><br></pre></td></tr></table></figure></p>
<p><strong>多数派写入（Quorum）</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3 副本系统：</span><br><span class="line"></span><br><span class="line">- 写入需要至少 2 个副本确认（W=2）</span><br><span class="line">- 读取需要至少 2 个副本确认（R=2）</span><br><span class="line">- 可以容忍 1 个副本故障</span><br><span class="line"></span><br><span class="line">5 副本系统：</span><br><span class="line"></span><br><span class="line">- W=3, R=3，可容忍 2 个副本故障</span><br></pre></td></tr></table></figure></p>
<h3 id="冲突解决">冲突解决</h3>
<p><strong>最后写入获胜（LWW）</strong>：</p>
<ul>
<li>使用时间戳比较</li>
<li>简单但可能丢失数据</li>
</ul>
<p><strong>向量时钟（Vector Clock）</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">节点 A: [A:2, B:1, C:0]</span><br><span class="line">节点 B: [A:1, B:2, C:1]</span><br><span class="line">节点 C: [A:0, B:1, C:2]</span><br><span class="line"></span><br><span class="line">可以检测并发写入冲突</span><br></pre></td></tr></table></figure></p>
<p><strong>CRDT（无冲突复制数据类型）</strong>：</p>
<ul>
<li>数学上保证合并结果唯一</li>
<li>适用于计数器、集合等数据类型</li>
</ul>
<h2 id="数据备份与容灾方案">数据备份与容灾方案</h2>
<h3 id="备份策略">备份策略</h3>
<p><strong>3-2-1 规则</strong>：</p>
<ul>
<li><strong>3</strong> 份数据副本</li>
<li><strong>2</strong> 种不同存储介质</li>
<li><strong>1</strong> 份异地备份</li>
</ul>
<p><strong>备份类型</strong>：</p>
<ul>
<li><strong>全量备份</strong>：备份所有数据</li>
<li><strong>增量备份</strong>：只备份变更数据</li>
<li><strong>差异备份</strong>：备份自上次全量备份后的变更</li>
</ul>
<h3 id="对象存储备份">对象存储备份</h3>
<p><strong>S3 版本控制</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用版本控制</span></span><br><span class="line">s3.put_bucket_versioning(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    VersioningConfiguration=&#123;<span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传文件（自动创建版本）</span></span><br><span class="line">s3.put_object(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;document.pdf&#x27;</span>,</span><br><span class="line">    Body=<span class="built_in">open</span>(<span class="string">&#x27;document.pdf&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有版本</span></span><br><span class="line">versions = s3.list_object_versions(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Prefix=<span class="string">&#x27;document.pdf&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复旧版本</span></span><br><span class="line">s3.copy_object(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;document.pdf&#x27;</span>,</span><br><span class="line">    CopySource=&#123;</span><br><span class="line">        <span class="string">&#x27;Bucket&#x27;</span>: <span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Key&#x27;</span>: <span class="string">&#x27;document.pdf&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;VersionId&#x27;</span>: <span class="string">&#x27;old-version-id&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p><strong>生命周期策略</strong>： <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;Rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ArchiveRule&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enabled&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;archive/&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Transitions&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;Days&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;StorageClass&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GLACIER&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;Days&quot;</span><span class="punctuation">:</span> <span class="number">90</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;StorageClass&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DEEP_ARCHIVE&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;DeleteRule&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enabled&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Prefix&quot;</span><span class="punctuation">:</span> <span class="string">&quot;temp/&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Expiration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Days&quot;</span><span class="punctuation">:</span> <span class="number">7</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="跨区域复制">跨区域复制</h3>
<p><strong>S3 跨区域复制配置</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建复制配置</span></span><br><span class="line">replication_config = &#123;</span><br><span class="line">    <span class="string">&#x27;Role&#x27;</span>: <span class="string">&#x27;arn:aws:iam::account:role/replication-role&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Rules&#x27;</span>: [&#123;</span><br><span class="line">        <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;ReplicateAll&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Priority&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;Filter&#x27;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&#x27;Destination&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Bucket&#x27;</span>: <span class="string">&#x27;arn:aws:s3:::destination-bucket&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;StorageClass&#x27;</span>: <span class="string">&#x27;STANDARD_IA&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s3.put_bucket_replication(</span><br><span class="line">    Bucket=<span class="string">&#x27;source-bucket&#x27;</span>,</span><br><span class="line">    ReplicationConfiguration=replication_config</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h3 id="容灾方案设计">容灾方案设计</h3>
<p><strong>RTO 与 RPO</strong>：</p>
<ul>
<li><strong>RTO（Recovery Time
Objective）</strong>：恢复时间目标，系统恢复所需时间</li>
<li><strong>RPO（Recovery Point
Objective）</strong>：恢复点目标，可接受的数据丢失量</li>
</ul>
<p><strong>容灾等级</strong>：</p>
<table>
<thead>
<tr>
<th>等级</th>
<th>RTO</th>
<th>RPO</th>
<th>实现方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>0级</td>
<td>无</td>
<td>无</td>
<td>无备份</td>
</tr>
<tr>
<td>1级</td>
<td>1周</td>
<td>1天</td>
<td>定期备份</td>
</tr>
<tr>
<td>2级</td>
<td>1天</td>
<td>1小时</td>
<td>实时备份</td>
</tr>
<tr>
<td>3级</td>
<td>1小时</td>
<td>5分钟</td>
<td>热备</td>
</tr>
<tr>
<td>4级</td>
<td>10分钟</td>
<td>0</td>
<td>双活</td>
</tr>
<tr>
<td>5级</td>
<td>0</td>
<td>0</td>
<td>多活</td>
</tr>
</tbody>
</table>
<p><strong>多活架构</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┐         ┌─────────────┐</span><br><span class="line">│  区域 A     │ ←────→  │  区域 B     │</span><br><span class="line">│  (主)      │  双向   │  (主)       │</span><br><span class="line">└─────────────┘  复制   └─────────────┘</span><br><span class="line">      ↓                    ↓</span><br><span class="line">  用户流量              用户流量</span><br></pre></td></tr></table></figure></p>
<h2 id="存储性能优化实战">存储性能优化实战</h2>
<h3 id="性能指标">性能指标</h3>
<p><strong>关键指标</strong>：</p>
<ul>
<li><strong>IOPS</strong>（Input/Output Operations Per Second）：每秒 IO
操作数</li>
<li><strong>吞吐量</strong>（Throughput）：每秒传输的数据量（MB/s 或
GB/s）</li>
<li><strong>延迟</strong>（Latency）：单个 IO 操作的响应时间</li>
<li><strong>队列深度</strong>（Queue Depth）：同时进行的 IO 请求数</li>
</ul>
<h3 id="对象存储性能优化">对象存储性能优化</h3>
<p><strong>并发上传</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_chunk</span>(<span class="params">args</span>):</span><br><span class="line">    bucket, key, chunk_data, part_number, upload_id = args</span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    response = s3.upload_part(</span><br><span class="line">        Bucket=bucket,</span><br><span class="line">        Key=key,</span><br><span class="line">        PartNumber=part_number,</span><br><span class="line">        UploadId=upload_id,</span><br><span class="line">        Body=chunk_data</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;PartNumber&#x27;</span>: part_number, <span class="string">&#x27;ETag&#x27;</span>: response[<span class="string">&#x27;ETag&#x27;</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 并发分片上传</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parallel_multipart_upload</span>(<span class="params">bucket, key, file_path, chunk_size=<span class="number">5</span>*<span class="number">1024</span>*<span class="number">1024</span></span>):</span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建分片上传</span></span><br><span class="line">    upload_id = s3.create_multipart_upload(Bucket=bucket, Key=key)[<span class="string">&#x27;UploadId&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 读取文件并分块</span></span><br><span class="line">    chunks = []</span><br><span class="line">    part_number = <span class="number">1</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            chunk = f.read(chunk_size)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            chunks.append((bucket, key, chunk, part_number, upload_id))</span><br><span class="line">            part_number += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并发上传（最多 10 个线程）</span></span><br><span class="line">    parts = []</span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">10</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        futures = executor.<span class="built_in">map</span>(upload_chunk, chunks)</span><br><span class="line">        parts = <span class="built_in">list</span>(futures)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 完成上传</span></span><br><span class="line">    s3.complete_multipart_upload(</span><br><span class="line">        Bucket=bucket,</span><br><span class="line">        Key=key,</span><br><span class="line">        UploadId=upload_id,</span><br><span class="line">        MultipartUpload=&#123;<span class="string">&#x27;Parts&#x27;</span>: <span class="built_in">sorted</span>(parts, key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;PartNumber&#x27;</span>])&#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p>
<p><strong>CDN 加速</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CloudFront 分发配置</span></span><br><span class="line">cloudfront = boto3.client(<span class="string">&#x27;cloudfront&#x27;</span>)</span><br><span class="line"></span><br><span class="line">distribution_config = &#123;</span><br><span class="line">    <span class="string">&#x27;CallerReference&#x27;</span>: <span class="built_in">str</span>(time.time()),</span><br><span class="line">    <span class="string">&#x27;Comment&#x27;</span>: <span class="string">&#x27;S3 bucket distribution&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DefaultCacheBehavior&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;TargetOriginId&#x27;</span>: <span class="string">&#x27;S3-my-bucket&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ViewerProtocolPolicy&#x27;</span>: <span class="string">&#x27;redirect-to-https&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;AllowedMethods&#x27;</span>: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>, <span class="string">&#x27;OPTIONS&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;CachedMethods&#x27;</span>: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;ForwardedValues&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;QueryString&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;Cookies&#x27;</span>: &#123;<span class="string">&#x27;Forward&#x27;</span>: <span class="string">&#x27;none&#x27;</span>&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;MinTTL&#x27;</span>: <span class="number">3600</span>,</span><br><span class="line">        <span class="string">&#x27;DefaultTTL&#x27;</span>: <span class="number">86400</span>,</span><br><span class="line">        <span class="string">&#x27;MaxTTL&#x27;</span>: <span class="number">31536000</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;Origins&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Quantity&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;Items&#x27;</span>: [&#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;S3-my-bucket&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;DomainName&#x27;</span>: <span class="string">&#x27;my-bucket.s3.amazonaws.com&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;S3OriginConfig&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;OriginAccessIdentity&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;Enabled&#x27;</span>: <span class="literal">True</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">response = cloudfront.create_distribution(</span><br><span class="line">    DistributionConfig=distribution_config</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h3 id="块存储性能优化">块存储性能优化</h3>
<p><strong>IO 调度器调优</strong>（Linux）： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前调度器</span></span><br><span class="line"><span class="built_in">cat</span> /sys/block/sda/queue/scheduler</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置为 deadline 调度器（适合数据库）</span></span><br><span class="line"><span class="built_in">echo</span> deadline &gt; /sys/block/sda/queue/scheduler</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或设置为 noop（虚拟环境）</span></span><br><span class="line"><span class="built_in">echo</span> noop &gt; /sys/block/sda/queue/scheduler</span><br></pre></td></tr></table></figure></p>
<p><strong>预读优化</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加预读大小（适合顺序读取）</span></span><br><span class="line">blockdev --setra 8192 /dev/sda</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前值</span></span><br><span class="line">blockdev --getra /dev/sda</span><br></pre></td></tr></table></figure></p>
<p><strong>文件系统优化</strong>（ext4）： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载选项优化</span></span><br><span class="line">mount -o noatime,nodiratime,data=writeback /dev/sda1 /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或写入 /etc/fstab</span></span><br><span class="line">/dev/sda1 /mnt ext4 noatime,nodiratime,data=writeback 0 2</span><br></pre></td></tr></table></figure></p>
<h3 id="hdfs-性能优化">HDFS 性能优化</h3>
<p><strong>数据本地性</strong>：</p>
<ul>
<li><strong>本地读取</strong>：数据在本地 DataNode</li>
<li><strong>机架本地</strong>：数据在同一机架</li>
<li><strong>跨机架</strong>：数据在不同机架</li>
</ul>
<p>优化策略： <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- hdfs-site.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.client.read.shortcircuit<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dfs.domain.socket.path<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>/var/lib/hadoop-hdfs/dn_socket<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>压缩</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Snappy 压缩（平衡压缩率和速度）</span></span><br><span class="line">hdfs dfs -Ddfs.compression.codec=org.apache.hadoop.io.compress.SnappyCodec \</span><br><span class="line">  -put large-file.txt /user/data/</span><br></pre></td></tr></table></figure></p>
<h3 id="ceph-性能优化">Ceph 性能优化</h3>
<p><strong>CRUSH 规则优化</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 SSD 池规则</span></span><br><span class="line">ceph osd crush rule create-replicated ssd-pool default host ssd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 HDD 池规则</span></span><br><span class="line">ceph osd crush rule create-replicated hdd-pool default host hdd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用规则到存储池</span></span><br><span class="line">ceph osd pool <span class="built_in">set</span> mypool crush_rule ssd-pool</span><br></pre></td></tr></table></figure></p>
<p><strong>OSD 调优</strong>： <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ceph.conf</span></span><br><span class="line"><span class="section">[osd]</span></span><br><span class="line"><span class="comment"># 增加并发数</span></span><br><span class="line"><span class="attr">osd_op_threads</span> = <span class="number">8</span></span><br><span class="line"><span class="attr">osd_disk_threads</span> = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存缓存</span></span><br><span class="line"><span class="attr">osd_cache_size</span> = <span class="number">2048</span>  <span class="comment"># MB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志优化（SSD）</span></span><br><span class="line"><span class="attr">bluestore_block_db_size</span> = <span class="number">10737418240</span>  <span class="comment"># 10GB</span></span><br><span class="line"><span class="attr">bluestore_block_wal_size</span> = <span class="number">1073741824</span>   <span class="comment"># 1GB</span></span><br></pre></td></tr></table></figure></p>
<p><strong>网络优化</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增加网络缓冲区</span></span><br><span class="line">sysctl -w net.core.rmem_max = 134217728</span><br><span class="line">sysctl -w net.core.wmem_max = 134217728</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用 TCP 窗口缩放</span></span><br><span class="line">sysctl -w net.ipv4.tcp_window_scaling = 1</span><br></pre></td></tr></table></figure></p>
<h2 id="成本优化策略">成本优化策略</h2>
<h3 id="存储分层">存储分层</h3>
<p><strong>S3 存储类别</strong>：</p>
<table>
<thead>
<tr>
<th>存储类别</th>
<th>成本（$/GB/月）</th>
<th>访问延迟</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>Standard</td>
<td>0.023</td>
<td>毫秒级</td>
<td>频繁访问</td>
</tr>
<tr>
<td>Standard-IA</td>
<td>0.0125</td>
<td>毫秒级</td>
<td>不频繁访问</td>
</tr>
<tr>
<td>Glacier</td>
<td>0.004</td>
<td>分钟级</td>
<td>归档</td>
</tr>
<tr>
<td>Deep Archive</td>
<td>0.00099</td>
<td>小时级</td>
<td>长期归档</td>
</tr>
</tbody>
</table>
<p><strong>生命周期策略</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">lifecycle_config = &#123;</span><br><span class="line">    <span class="string">&#x27;Rules&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;MoveToIA&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Transitions&#x27;</span>: [&#123;</span><br><span class="line">                <span class="string">&#x27;Days&#x27;</span>: <span class="number">30</span>,</span><br><span class="line">                <span class="string">&#x27;StorageClass&#x27;</span>: <span class="string">&#x27;STANDARD_IA&#x27;</span></span><br><span class="line">            &#125;],</span><br><span class="line">            <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;logs/&#x27;</span>&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;ArchiveToGlacier&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Transitions&#x27;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;Days&#x27;</span>: <span class="number">90</span>,</span><br><span class="line">                    <span class="string">&#x27;StorageClass&#x27;</span>: <span class="string">&#x27;GLACIER&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;Days&#x27;</span>: <span class="number">365</span>,</span><br><span class="line">                    <span class="string">&#x27;StorageClass&#x27;</span>: <span class="string">&#x27;DEEP_ARCHIVE&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;archive/&#x27;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s3.put_bucket_lifecycle_configuration(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    LifecycleConfiguration=lifecycle_config</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<h3 id="数据去重">数据去重</h3>
<p><strong>块级去重</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">原始数据：</span><br><span class="line">文件A: [块1, 块2, 块3, 块4]</span><br><span class="line">文件B: [块1, 块5, 块3, 块6]</span><br><span class="line"></span><br><span class="line">去重后：</span><br><span class="line">存储: [块1, 块2, 块3, 块4, 块5, 块6]</span><br><span class="line">引用: 文件A → [1,2,3,4]</span><br><span class="line">      文件B → [1,5,3,6]</span><br><span class="line"></span><br><span class="line">节省空间: 2/8 = 25%</span><br></pre></td></tr></table></figure></p>
<p><strong>实现示例</strong>（简化）： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DeduplicationStorage</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.block_store = &#123;&#125;  <span class="comment"># hash -&gt; data</span></span><br><span class="line">        self.file_index = &#123;&#125;   <span class="comment"># filename -&gt; [hashes]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">store_file</span>(<span class="params">self, filename, data, block_size=<span class="number">4096</span></span>):</span><br><span class="line">        blocks = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(data), block_size):</span><br><span class="line">            block = data[i:i+block_size]</span><br><span class="line">            block_hash = hashlib.sha256(block).hexdigest()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 只存储新块</span></span><br><span class="line">            <span class="keyword">if</span> block_hash <span class="keyword">not</span> <span class="keyword">in</span> self.block_store:</span><br><span class="line">                self.block_store[block_hash] = block</span><br><span class="line">            </span><br><span class="line">            blocks.append(block_hash)</span><br><span class="line">        </span><br><span class="line">        self.file_index[filename] = blocks</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_file</span>(<span class="params">self, filename</span>):</span><br><span class="line">        blocks = self.file_index.get(filename, [])</span><br><span class="line">        <span class="keyword">return</span> <span class="string">b&#x27;&#x27;</span>.join(self.block_store[h] <span class="keyword">for</span> h <span class="keyword">in</span> blocks)</span><br></pre></td></tr></table></figure></p>
<h3 id="压缩策略">压缩策略</h3>
<p><strong>压缩算法对比</strong>：</p>
<table>
<thead>
<tr>
<th>算法</th>
<th>压缩率</th>
<th>速度</th>
<th>CPU 消耗</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>gzip</td>
<td>中等</td>
<td>中等</td>
<td>中等</td>
<td>通用</td>
</tr>
<tr>
<td>bzip2</td>
<td>高</td>
<td>慢</td>
<td>高</td>
<td>归档</td>
</tr>
<tr>
<td>lz4</td>
<td>低</td>
<td>极快</td>
<td>低</td>
<td>实时压缩</td>
</tr>
<tr>
<td>zstd</td>
<td>高</td>
<td>快</td>
<td>中等</td>
<td>推荐</td>
</tr>
</tbody>
</table>
<p><strong>Hadoop 压缩配置</strong>： <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- core-site.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>io.compression.codecs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span></span><br><span class="line">        org.apache.hadoop.io.compress.GzipCodec,</span><br><span class="line">        org.apache.hadoop.io.compress.BZip2Codec,</span><br><span class="line">        org.apache.hadoop.io.compress.Lz4Codec,</span><br><span class="line">        org.apache.hadoop.io.compress.SnappyCodec</span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.output.compress<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mapreduce.map.output.compress.codec<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.io.compress.SnappyCodec<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="容量规划">容量规划</h3>
<p><strong>容量计算公式</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">总容量需求 = 原始数据 × (1 + 副本数) × (1 + 增长因子) × (1 + 冗余率)</span><br><span class="line"></span><br><span class="line">示例：</span><br><span class="line"></span><br><span class="line">- 原始数据：100TB</span><br><span class="line">- 副本数：3</span><br><span class="line">- 年增长：20%</span><br><span class="line">- 冗余率：10%</span><br><span class="line"></span><br><span class="line">总容量 = 100TB × 4 × 1.2 × 1.1 = 528TB</span><br></pre></td></tr></table></figure></p>
<p><strong>成本估算</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">estimate_storage_cost</span>(<span class="params">data_size_tb, replication=<span class="number">3</span>, growth_rate=<span class="number">0.2</span>, </span></span><br><span class="line"><span class="params">                          years=<span class="number">3</span>, cost_per_tb_month=<span class="number">20</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    估算存储成本</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        data_size_tb: 初始数据量（TB）</span></span><br><span class="line"><span class="string">        replication: 副本数</span></span><br><span class="line"><span class="string">        growth_rate: 年增长率</span></span><br><span class="line"><span class="string">        years: 年限</span></span><br><span class="line"><span class="string">        cost_per_tb_month: 每 TB 每月成本（美元）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    total_cost = <span class="number">0</span></span><br><span class="line">    current_size = data_size_tb</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> year <span class="keyword">in</span> <span class="built_in">range</span>(years):</span><br><span class="line">        <span class="comment"># 当前年容量（考虑副本）</span></span><br><span class="line">        capacity = current_size * replication</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 年度成本</span></span><br><span class="line">        year_cost = capacity * cost_per_tb_month * <span class="number">12</span></span><br><span class="line">        total_cost += year_cost</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 下一年数据增长</span></span><br><span class="line">        current_size *= (<span class="number">1</span> + growth_rate)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Year <span class="subst">&#123;year+<span class="number">1</span>&#125;</span>: <span class="subst">&#123;capacity:<span class="number">.2</span>f&#125;</span>TB, Cost: $<span class="subst">&#123;year_cost:,<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\nTotal <span class="subst">&#123;years&#125;</span>-year cost: $<span class="subst">&#123;total_cost:,<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> total_cost</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例</span></span><br><span class="line">estimate_storage_cost(<span class="number">100</span>, replication=<span class="number">3</span>, growth_rate=<span class="number">0.2</span>, years=<span class="number">3</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="实战案例">实战案例</h2>
<h3 id="案例一大规模日志存储系统">案例一：大规模日志存储系统</h3>
<p><strong>场景</strong>：某互联网公司需要存储每天 10TB 的日志数据，保留
90 天。</p>
<p><strong>需求分析</strong>：</p>
<ul>
<li>写入：高吞吐（&gt;1GB/s）</li>
<li>读取：按时间范围查询</li>
<li>成本：尽可能低</li>
<li>可靠性：99.9%</li>
</ul>
<p><strong>架构设计</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┐</span><br><span class="line">│  日志采集    │ → Kafka</span><br><span class="line">└──────┬───────┘</span><br><span class="line">       │</span><br><span class="line">       ↓</span><br><span class="line">┌──────────────┐</span><br><span class="line">│  日志处理    │ → 压缩、分区</span><br><span class="line">└──────┬───────┘</span><br><span class="line">       │</span><br><span class="line">       ↓</span><br><span class="line">┌──────────────┐     ┌──────────────┐</span><br><span class="line">│ 对象存储     │ ←→  │ 冷存储       │</span><br><span class="line">│ (热数据)     │     │ (归档数据)   │</span><br><span class="line">│ 30天         │     │ 60天         │</span><br><span class="line">└──────────────┘     └──────────────┘</span><br></pre></td></tr></table></figure></p>
<p><strong>实现方案</strong>：</p>
<ol type="1">
<li><p><strong>数据分区策略</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_log_path</span>(<span class="params">timestamp, log_type</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;按日期和类型分区&quot;&quot;&quot;</span></span><br><span class="line">    dt = datetime.fromtimestamp(timestamp)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;logs/<span class="subst">&#123;log_type&#125;</span>/year=<span class="subst">&#123;dt.year&#125;</span>/month=<span class="subst">&#123;dt.month:02d&#125;</span>/day=<span class="subst">&#123;dt.day:02d&#125;</span>/hour=<span class="subst">&#123;dt.hour:02d&#125;</span>/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_logs</span>(<span class="params">logs, bucket, log_type</span>):</span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 按小时分组</span></span><br><span class="line">    hourly_logs = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> log <span class="keyword">in</span> logs:</span><br><span class="line">        hour_key = get_log_path(log[<span class="string">&#x27;timestamp&#x27;</span>], log_type)</span><br><span class="line">        <span class="keyword">if</span> hour_key <span class="keyword">not</span> <span class="keyword">in</span> hourly_logs:</span><br><span class="line">            hourly_logs[hour_key] = []</span><br><span class="line">        hourly_logs[hour_key].append(log)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 并发上传</span></span><br><span class="line">    <span class="keyword">for</span> hour_key, hour_logs <span class="keyword">in</span> hourly_logs.items():</span><br><span class="line">        <span class="comment"># 压缩</span></span><br><span class="line">        <span class="keyword">import</span> gzip</span><br><span class="line">        <span class="keyword">import</span> json</span><br><span class="line">        data = gzip.compress(</span><br><span class="line">            <span class="string">&#x27;\n&#x27;</span>.join(json.dumps(log) <span class="keyword">for</span> log <span class="keyword">in</span> hour_logs).encode()</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 上传到 S3</span></span><br><span class="line">        key = <span class="string">f&quot;<span class="subst">&#123;hour_key&#125;</span>logs-<span class="subst">&#123;<span class="built_in">int</span>(hour_logs[<span class="number">0</span>][<span class="string">&#x27;timestamp&#x27;</span>])&#125;</span>.json.gz&quot;</span></span><br><span class="line">        s3.put_object(</span><br><span class="line">            Bucket=bucket,</span><br><span class="line">            Key=key,</span><br><span class="line">            Body=data,</span><br><span class="line">            StorageClass=<span class="string">&#x27;STANDARD_IA&#x27;</span>,  <span class="comment"># 不频繁访问</span></span><br><span class="line">            ContentEncoding=<span class="string">&#x27;gzip&#x27;</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>生命周期管理</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">lifecycle_config = &#123;</span><br><span class="line">    <span class="string">&#x27;Rules&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;MoveToGlacier&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Transitions&#x27;</span>: [&#123;</span><br><span class="line">                <span class="string">&#x27;Days&#x27;</span>: <span class="number">30</span>,</span><br><span class="line">                <span class="string">&#x27;StorageClass&#x27;</span>: <span class="string">&#x27;GLACIER&#x27;</span></span><br><span class="line">            &#125;],</span><br><span class="line">            <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;logs/&#x27;</span>&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;DeleteOldLogs&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Expiration&#x27;</span>: &#123;<span class="string">&#x27;Days&#x27;</span>: <span class="number">90</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;logs/&#x27;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>查询接口</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">query_logs</span>(<span class="params">bucket, log_type, start_time, end_time</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查询指定时间范围的日志&quot;&quot;&quot;</span></span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成需要查询的前缀</span></span><br><span class="line">    prefixes = generate_prefixes(log_type, start_time, end_time)</span><br><span class="line">    </span><br><span class="line">    logs = []</span><br><span class="line">    <span class="keyword">for</span> prefix <span class="keyword">in</span> prefixes:</span><br><span class="line">        <span class="comment"># 列出对象</span></span><br><span class="line">        objects = s3.list_objects_v2(</span><br><span class="line">            Bucket=bucket,</span><br><span class="line">            Prefix=prefix</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> obj <span class="keyword">in</span> objects.get(<span class="string">&#x27;Contents&#x27;</span>, []):</span><br><span class="line">            <span class="comment"># 下载并解压</span></span><br><span class="line">            response = s3.get_object(Bucket=bucket, Key=obj[<span class="string">&#x27;Key&#x27;</span>])</span><br><span class="line">            data = gzip.decompress(response[<span class="string">&#x27;Body&#x27;</span>].read())</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解析日志</span></span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> data.decode().split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> line:</span><br><span class="line">                    log = json.loads(line)</span><br><span class="line">                    <span class="keyword">if</span> start_time &lt;= log[<span class="string">&#x27;timestamp&#x27;</span>] &lt;= end_time:</span><br><span class="line">                        logs.append(log)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> logs</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p><strong>成本分析</strong>：</p>
<ul>
<li>热数据（30天）：300TB × $0.0125/GB/月 = $3,750/月</li>
<li>冷数据（60天）：600TB × $0.004/GB/月 = $2,400/月</li>
<li>总成本：$6,150/月</li>
<li>相比全量 Standard 存储节省：约 70%</li>
</ul>
<h3 id="案例二数据库备份系统">案例二：数据库备份系统</h3>
<p><strong>场景</strong>：MySQL 数据库集群，总数据量
50TB，需要每日全量备份 + 每小时增量备份。</p>
<p><strong>需求</strong>：</p>
<ul>
<li>RPO：1 小时</li>
<li>RTO：4 小时</li>
<li>保留策略：7 天每日备份 + 30 天每周备份</li>
</ul>
<p><strong>架构设计</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL 集群</span><br><span class="line">    ↓</span><br><span class="line">XtraBackup (备份工具)</span><br><span class="line">    ↓</span><br><span class="line">压缩 + 加密</span><br><span class="line">    ↓</span><br><span class="line">对象存储 (多区域)</span><br><span class="line">    ├── 区域 A (主)</span><br><span class="line">    └── 区域 B (备)</span><br></pre></td></tr></table></figure></p>
<p><strong>实现方案</strong>：</p>
<ol type="1">
<li><p><strong>备份脚本</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># backup-mysql.sh</span></span><br><span class="line"></span><br><span class="line">BACKUP_TYPE=<span class="variable">$&#123;1:-incremental&#125;</span>  <span class="comment"># full or incremental</span></span><br><span class="line">BUCKET=<span class="string">&quot;mysql-backups&quot;</span></span><br><span class="line">REGION=<span class="string">&quot;us-east-1&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d)</span><br><span class="line">TIME=$(<span class="built_in">date</span> +%H%M%S)</span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backup/mysql&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全量备份</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$BACKUP_TYPE</span>&quot;</span> == <span class="string">&quot;full&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    BACKUP_PATH=<span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/full-<span class="variable">$DATE</span>-<span class="variable">$TIME</span>&quot;</span></span><br><span class="line">    xtrabackup --backup --target-dir=<span class="variable">$BACKUP_PATH</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 压缩</span></span><br><span class="line">    tar czf <span class="variable">$BACKUP_PATH</span>.tar.gz -C <span class="variable">$BACKUP_DIR</span> full-<span class="variable">$DATE</span>-<span class="variable">$TIME</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加密</span></span><br><span class="line">    gpg --encrypt --recipient backup-key <span class="variable">$BACKUP_PATH</span>.tar.gz</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 上传到 S3</span></span><br><span class="line">    aws s3 <span class="built_in">cp</span> <span class="variable">$BACKUP_PATH</span>.tar.gz.gpg \</span><br><span class="line">        s3://<span class="variable">$BUCKET</span>/full/<span class="variable">$DATE</span>/ \</span><br><span class="line">        --storage-class STANDARD_IA</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 增量备份</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment"># 找到最新的全量备份</span></span><br><span class="line">    LATEST_FULL=$(aws s3 <span class="built_in">ls</span> s3://<span class="variable">$BUCKET</span>/full/ | <span class="built_in">sort</span> | <span class="built_in">tail</span> -1 | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    BACKUP_PATH=<span class="string">&quot;<span class="variable">$BACKUP_DIR</span>/incr-<span class="variable">$DATE</span>-<span class="variable">$TIME</span>&quot;</span></span><br><span class="line">    xtrabackup --backup \</span><br><span class="line">        --target-dir=<span class="variable">$BACKUP_PATH</span> \</span><br><span class="line">        --incremental-basedir=/backup/mysql/<span class="variable">$LATEST_FULL</span></span><br><span class="line">    </span><br><span class="line">    tar czf <span class="variable">$BACKUP_PATH</span>.tar.gz -C <span class="variable">$BACKUP_DIR</span> incr-<span class="variable">$DATE</span>-<span class="variable">$TIME</span></span><br><span class="line">    gpg --encrypt --recipient backup-key <span class="variable">$BACKUP_PATH</span>.tar.gz</span><br><span class="line">    </span><br><span class="line">    aws s3 <span class="built_in">cp</span> <span class="variable">$BACKUP_PATH</span>.tar.gz.gpg \</span><br><span class="line">        s3://<span class="variable">$BUCKET</span>/incremental/<span class="variable">$DATE</span>/ \</span><br><span class="line">        --storage-class STANDARD_IA</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理本地备份（保留最近 3 天）</span></span><br><span class="line">find <span class="variable">$BACKUP_DIR</span> -<span class="built_in">type</span> f -mtime +3 -delete</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>恢复脚本</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># restore-mysql.sh</span></span><br><span class="line"></span><br><span class="line">BACKUP_DATE=<span class="variable">$1</span></span><br><span class="line">BUCKET=<span class="string">&quot;mysql-backups&quot;</span></span><br><span class="line">RESTORE_DIR=<span class="string">&quot;/restore/mysql&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载全量备份</span></span><br><span class="line">aws s3 <span class="built_in">cp</span> s3://<span class="variable">$BUCKET</span>/full/<span class="variable">$BACKUP_DATE</span>/ <span class="variable">$RESTORE_DIR</span>/full/ --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载增量备份</span></span><br><span class="line">aws s3 <span class="built_in">cp</span> s3://<span class="variable">$BUCKET</span>/incremental/<span class="variable">$BACKUP_DATE</span>/ <span class="variable">$RESTORE_DIR</span>/incremental/ --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解密全量备份</span></span><br><span class="line">gpg --decrypt <span class="variable">$RESTORE_DIR</span>/full/*.gpg | tar xz -C <span class="variable">$RESTORE_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备基础备份</span></span><br><span class="line">xtrabackup --prepare --apply-log-only --target-dir=<span class="variable">$RESTORE_DIR</span>/full</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用增量备份（按时间顺序）</span></span><br><span class="line"><span class="keyword">for</span> incr_backup <span class="keyword">in</span> $(<span class="built_in">ls</span> -t <span class="variable">$RESTORE_DIR</span>/incremental/*.gpg); <span class="keyword">do</span></span><br><span class="line">    gpg --decrypt <span class="variable">$incr_backup</span> | tar xz -C <span class="variable">$RESTORE_DIR</span>/incremental</span><br><span class="line">    xtrabackup --prepare --apply-log-only \</span><br><span class="line">        --target-dir=<span class="variable">$RESTORE_DIR</span>/full \</span><br><span class="line">        --incremental-dir=<span class="variable">$RESTORE_DIR</span>/incremental/$(<span class="built_in">basename</span> <span class="variable">$incr_backup</span> .tar.gz.gpg)</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最终准备</span></span><br><span class="line">xtrabackup --prepare --target-dir=<span class="variable">$RESTORE_DIR</span>/full</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复数据</span></span><br><span class="line">systemctl stop mysql</span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/mysql/*</span><br><span class="line">xtrabackup --copy-back --target-dir=<span class="variable">$RESTORE_DIR</span>/full</span><br><span class="line"><span class="built_in">chown</span> -R mysql:mysql /var/lib/mysql</span><br><span class="line">systemctl start mysql</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>跨区域复制</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置跨区域复制</span></span><br><span class="line">replication_config = &#123;</span><br><span class="line">    <span class="string">&#x27;Role&#x27;</span>: <span class="string">&#x27;arn:aws:iam::account:role/replication-role&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Rules&#x27;</span>: [&#123;</span><br><span class="line">        <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;ReplicateBackups&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;,</span><br><span class="line">        <span class="string">&#x27;Destination&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Bucket&#x27;</span>: <span class="string">&#x27;arn:aws:s3:::mysql-backups-dr&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;StorageClass&#x27;</span>: <span class="string">&#x27;STANDARD_IA&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">s3.put_bucket_replication(</span><br><span class="line">    Bucket=<span class="string">&#x27;mysql-backups&#x27;</span>,</span><br><span class="line">    ReplicationConfiguration=replication_config</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>生命周期策略</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">lifecycle_config = &#123;</span><br><span class="line">    <span class="string">&#x27;Rules&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;DeleteDailyAfter7Days&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Expiration&#x27;</span>: &#123;<span class="string">&#x27;Days&#x27;</span>: <span class="number">7</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;full/&#x27;</span>&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;ArchiveWeekly&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Transitions&#x27;</span>: [&#123;</span><br><span class="line">                <span class="string">&#x27;Days&#x27;</span>: <span class="number">7</span>,</span><br><span class="line">                <span class="string">&#x27;StorageClass&#x27;</span>: <span class="string">&#x27;GLACIER&#x27;</span></span><br><span class="line">            &#125;],</span><br><span class="line">            <span class="string">&#x27;Expiration&#x27;</span>: &#123;<span class="string">&#x27;Days&#x27;</span>: <span class="number">30</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;full/&#x27;</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;TagFilters&#x27;</span>: [&#123;</span><br><span class="line">                <span class="string">&#x27;Key&#x27;</span>: <span class="string">&#x27;backup-type&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Value&#x27;</span>: <span class="string">&#x27;weekly&#x27;</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;Id&#x27;</span>: <span class="string">&#x27;DeleteIncrementalAfter24Hours&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Status&#x27;</span>: <span class="string">&#x27;Enabled&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;Expiration&#x27;</span>: &#123;<span class="string">&#x27;Days&#x27;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">            <span class="string">&#x27;Filter&#x27;</span>: &#123;<span class="string">&#x27;Prefix&#x27;</span>: <span class="string">&#x27;incremental/&#x27;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>备份速度：500MB/s（压缩后）</li>
<li>恢复时间：全量恢复 2 小时，增量恢复 30 分钟</li>
<li>存储成本：约 $500/月（含跨区域复制）</li>
</ul>
<h3 id="案例三多媒体内容分发系统">案例三：多媒体内容分发系统</h3>
<p><strong>场景</strong>：视频平台，存储 100PB
视频文件，全球用户访问。</p>
<p><strong>需求</strong>：</p>
<ul>
<li>高可用：99.99%</li>
<li>全球加速：CDN 集成</li>
<li>成本优化：热冷数据分离</li>
<li>转码支持：多种分辨率</li>
</ul>
<p><strong>架构设计</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┐</span><br><span class="line">│  视频上传    │ → 对象存储（原始）</span><br><span class="line">└──────┬───────┘</span><br><span class="line">       │</span><br><span class="line">       ↓</span><br><span class="line">┌──────────────┐</span><br><span class="line">│  转码服务    │ → 多分辨率版本</span><br><span class="line">└──────┬───────┘</span><br><span class="line">       │</span><br><span class="line">       ↓</span><br><span class="line">┌──────────────┐     ┌──────────────┐</span><br><span class="line">│ 对象存储     │ ←→  │ CDN          │</span><br><span class="line">│ (源站)       │     │ (边缘缓存)   │</span><br><span class="line">└──────────────┘     └──────────────┘</span><br></pre></td></tr></table></figure></p>
<p><strong>实现方案</strong>：</p>
<ol type="1">
<li><p><strong>上传优化</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VideoUploader</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, bucket, region</span>):</span><br><span class="line">        self.s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>, region_name=region)</span><br><span class="line">        self.bucket = bucket</span><br><span class="line">        self.chunk_size = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 10MB</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload_video</span>(<span class="params">self, video_path, video_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分片并发上传视频&quot;&quot;&quot;</span></span><br><span class="line">        file_size = os.path.getsize(video_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建分片上传</span></span><br><span class="line">        upload_id = self.s3.create_multipart_upload(</span><br><span class="line">            Bucket=self.bucket,</span><br><span class="line">            Key=<span class="string">f&#x27;originals/<span class="subst">&#123;video_id&#125;</span>.mp4&#x27;</span>,</span><br><span class="line">            Metadata=&#123;</span><br><span class="line">                <span class="string">&#x27;video-id&#x27;</span>: video_id,</span><br><span class="line">                <span class="string">&#x27;original-size&#x27;</span>: <span class="built_in">str</span>(file_size)</span><br><span class="line">            &#125;,</span><br><span class="line">            StorageClass=<span class="string">&#x27;STANDARD&#x27;</span></span><br><span class="line">        )[<span class="string">&#x27;UploadId&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算分片</span></span><br><span class="line">        parts = []</span><br><span class="line">        part_number = <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(video_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                chunk = f.read(self.chunk_size)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 并发上传分片</span></span><br><span class="line">                part = self.s3.upload_part(</span><br><span class="line">                    Bucket=self.bucket,</span><br><span class="line">                    Key=<span class="string">f&#x27;originals/<span class="subst">&#123;video_id&#125;</span>.mp4&#x27;</span>,</span><br><span class="line">                    PartNumber=part_number,</span><br><span class="line">                    UploadId=upload_id,</span><br><span class="line">                    Body=chunk</span><br><span class="line">                )</span><br><span class="line">                parts.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;PartNumber&#x27;</span>: part_number,</span><br><span class="line">                    <span class="string">&#x27;ETag&#x27;</span>: part[<span class="string">&#x27;ETag&#x27;</span>]</span><br><span class="line">                &#125;)</span><br><span class="line">                part_number += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 完成上传</span></span><br><span class="line">        self.s3.complete_multipart_upload(</span><br><span class="line">            Bucket=self.bucket,</span><br><span class="line">            Key=<span class="string">f&#x27;originals/<span class="subst">&#123;video_id&#125;</span>.mp4&#x27;</span>,</span><br><span class="line">            UploadId=upload_id,</span><br><span class="line">            MultipartUpload=&#123;<span class="string">&#x27;Parts&#x27;</span>: parts&#125;</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 触发转码任务</span></span><br><span class="line">        self.trigger_transcoding(video_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">trigger_transcoding</span>(<span class="params">self, video_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;触发转码任务（Lambda/ECS）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> boto3</span><br><span class="line">        lambda_client = boto3.client(<span class="string">&#x27;lambda&#x27;</span>)</span><br><span class="line">        lambda_client.invoke(</span><br><span class="line">            FunctionName=<span class="string">&#x27;video-transcoder&#x27;</span>,</span><br><span class="line">            InvocationType=<span class="string">&#x27;Event&#x27;</span>,</span><br><span class="line">            Payload=json.dumps(&#123;</span><br><span class="line">                <span class="string">&#x27;video_id&#x27;</span>: video_id,</span><br><span class="line">                <span class="string">&#x27;source_key&#x27;</span>: <span class="string">f&#x27;originals/<span class="subst">&#123;video_id&#125;</span>.mp4&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;resolutions&#x27;</span>: [<span class="string">&#x27;1080p&#x27;</span>, <span class="string">&#x27;720p&#x27;</span>, <span class="string">&#x27;480p&#x27;</span>, <span class="string">&#x27;360p&#x27;</span>]</span><br><span class="line">            &#125;)</span><br><span class="line">        )</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>转码后存储</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">store_transcoded_video</span>(<span class="params">video_id, resolution, transcoded_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;存储转码后的视频&quot;&quot;&quot;</span></span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    key = <span class="string">f&#x27;videos/<span class="subst">&#123;video_id&#125;</span>/<span class="subst">&#123;resolution&#125;</span>.mp4&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 上传转码文件</span></span><br><span class="line">    s3.put_object(</span><br><span class="line">        Bucket=<span class="string">&#x27;video-bucket&#x27;</span>,</span><br><span class="line">        Key=key,</span><br><span class="line">        Body=transcoded_file,</span><br><span class="line">        StorageClass=<span class="string">&#x27;STANDARD&#x27;</span>,  <span class="comment"># 热数据</span></span><br><span class="line">        CacheControl=<span class="string">&#x27;max-age=31536000&#x27;</span>,  <span class="comment"># CDN 缓存 1 年</span></span><br><span class="line">        ContentType=<span class="string">&#x27;video/mp4&#x27;</span>,</span><br><span class="line">        Metadata=&#123;</span><br><span class="line">            <span class="string">&#x27;video-id&#x27;</span>: video_id,</span><br><span class="line">            <span class="string">&#x27;resolution&#x27;</span>: resolution</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成播放列表（HLS）</span></span><br><span class="line">    generate_hls_playlist(video_id, resolution)</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>CDN 配置</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">configure_cdn_for_video</span>(<span class="params">bucket, distribution_id</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;配置 CloudFront 用于视频分发&quot;&quot;&quot;</span></span><br><span class="line">    cloudfront = boto3.client(<span class="string">&#x27;cloudfront&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 更新分发配置</span></span><br><span class="line">    config = cloudfront.get_distribution_config(Id=distribution_id)</span><br><span class="line">    etag = config[<span class="string">&#x27;ETag&#x27;</span>]</span><br><span class="line">    distribution_config = config[<span class="string">&#x27;DistributionConfig&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 添加缓存行为</span></span><br><span class="line">    distribution_config[<span class="string">&#x27;CacheBehaviors&#x27;</span>][<span class="string">&#x27;Items&#x27;</span>].append(&#123;</span><br><span class="line">        <span class="string">&#x27;PathPattern&#x27;</span>: <span class="string">&#x27;videos/*&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;TargetOriginId&#x27;</span>: <span class="string">&#x27;S3-video-bucket&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ViewerProtocolPolicy&#x27;</span>: <span class="string">&#x27;redirect-to-https&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;AllowedMethods&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Quantity&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">&#x27;Items&#x27;</span>: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>],</span><br><span class="line">            <span class="string">&#x27;CachedMethods&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Quantity&#x27;</span>: <span class="number">2</span>,</span><br><span class="line">                <span class="string">&#x27;Items&#x27;</span>: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;Compress&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;MinTTL&#x27;</span>: <span class="number">86400</span>,</span><br><span class="line">        <span class="string">&#x27;DefaultTTL&#x27;</span>: <span class="number">31536000</span>,</span><br><span class="line">        <span class="string">&#x27;MaxTTL&#x27;</span>: <span class="number">31536000</span>,</span><br><span class="line">        <span class="string">&#x27;ForwardedValues&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;QueryString&#x27;</span>: <span class="literal">False</span>,</span><br><span class="line">            <span class="string">&#x27;Cookies&#x27;</span>: &#123;<span class="string">&#x27;Forward&#x27;</span>: <span class="string">&#x27;none&#x27;</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    cloudfront.update_distribution(</span><br><span class="line">        Id=distribution_id,</span><br><span class="line">        IfMatch=etag,</span><br><span class="line">        DistributionConfig=distribution_config</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>热冷数据分离</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">manage_video_lifecycle</span>(<span class="params">video_id, access_stats</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;根据访问统计管理视频生命周期&quot;&quot;&quot;</span></span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算访问频率</span></span><br><span class="line">    views_last_30_days = access_stats.get(<span class="string">&#x27;views_30d&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> views_last_30_days &lt; <span class="number">100</span>:</span><br><span class="line">        <span class="comment"># 冷数据，移动到 Glacier</span></span><br><span class="line">        <span class="keyword">for</span> resolution <span class="keyword">in</span> [<span class="string">&#x27;1080p&#x27;</span>, <span class="string">&#x27;720p&#x27;</span>, <span class="string">&#x27;480p&#x27;</span>, <span class="string">&#x27;360p&#x27;</span>]:</span><br><span class="line">            key = <span class="string">f&#x27;videos/<span class="subst">&#123;video_id&#125;</span>/<span class="subst">&#123;resolution&#125;</span>.mp4&#x27;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 复制到 Glacier</span></span><br><span class="line">            s3.copy_object(</span><br><span class="line">                Bucket=<span class="string">&#x27;video-bucket&#x27;</span>,</span><br><span class="line">                CopySource=&#123;<span class="string">&#x27;Bucket&#x27;</span>: <span class="string">&#x27;video-bucket&#x27;</span>, <span class="string">&#x27;Key&#x27;</span>: key&#125;,</span><br><span class="line">                Key=<span class="string">f&#x27;archive/<span class="subst">&#123;video_id&#125;</span>/<span class="subst">&#123;resolution&#125;</span>.mp4&#x27;</span>,</span><br><span class="line">                StorageClass=<span class="string">&#x27;GLACIER&#x27;</span>,</span><br><span class="line">                MetadataDirective=<span class="string">&#x27;COPY&#x27;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 删除原文件（或保留元数据）</span></span><br><span class="line">            s3.delete_object(Bucket=<span class="string">&#x27;video-bucket&#x27;</span>, Key=key)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> views_last_30_days &lt; <span class="number">1000</span>:</span><br><span class="line">        <span class="comment"># 温数据，移动到 Standard-IA</span></span><br><span class="line">        <span class="keyword">for</span> resolution <span class="keyword">in</span> [<span class="string">&#x27;1080p&#x27;</span>, <span class="string">&#x27;720p&#x27;</span>]:</span><br><span class="line">            key = <span class="string">f&#x27;videos/<span class="subst">&#123;video_id&#125;</span>/<span class="subst">&#123;resolution&#125;</span>.mp4&#x27;</span></span><br><span class="line">            s3.copy_object(</span><br><span class="line">                Bucket=<span class="string">&#x27;video-bucket&#x27;</span>,</span><br><span class="line">                CopySource=&#123;<span class="string">&#x27;Bucket&#x27;</span>: <span class="string">&#x27;video-bucket&#x27;</span>, <span class="string">&#x27;Key&#x27;</span>: key&#125;,</span><br><span class="line">                Key=key,</span><br><span class="line">                StorageClass=<span class="string">&#x27;STANDARD_IA&#x27;</span>,</span><br><span class="line">                MetadataDirective=<span class="string">&#x27;COPY&#x27;</span></span><br><span class="line">            )</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>访问统计</strong>： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">track_video_access</span>(<span class="params">video_id, resolution, user_ip</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;记录视频访问（用于生命周期管理）&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> boto3</span><br><span class="line">    <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">    </span><br><span class="line">    dynamodb = boto3.resource(<span class="string">&#x27;dynamodb&#x27;</span>)</span><br><span class="line">    table = dynamodb.Table(<span class="string">&#x27;video-access-stats&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    date = datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    table.update_item(</span><br><span class="line">        Key=&#123;</span><br><span class="line">            <span class="string">&#x27;video_id&#x27;</span>: video_id,</span><br><span class="line">            <span class="string">&#x27;date&#x27;</span>: date</span><br><span class="line">        &#125;,</span><br><span class="line">        UpdateExpression=<span class="string">&#x27;ADD views :inc, #res.#r :inc&#x27;</span>,</span><br><span class="line">        ExpressionAttributeNames=&#123;</span><br><span class="line">            <span class="string">&#x27;#res&#x27;</span>: <span class="string">&#x27;resolutions&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        ExpressionAttributeValues=&#123;</span><br><span class="line">            <span class="string">&#x27;:inc&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;#r&#x27;</span>: resolution</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure></p></li>
</ol>
<p><strong>性能指标</strong>：</p>
<ul>
<li>上传速度：&gt;100MB/s（10 并发分片）</li>
<li>CDN 命中率：&gt;95%</li>
<li>存储成本：相比全量 Standard 节省 60%（热冷分离）</li>
<li>全球访问延迟：&lt;100ms（CDN 边缘节点）</li>
</ul>
<h2 id="qa-云存储常见问题">❓ Q&amp;A: 云存储常见问题</h2>
<h3 id="q1-对象存储块存储和文件存储如何选择">Q1:
对象存储、块存储和文件存储如何选择？</h3>
<p><strong>A</strong>: 选择主要取决于应用场景：</p>
<ul>
<li><p><strong>对象存储</strong>：适合存储大量静态文件（图片、视频、文档），需要
REST API
访问，成本敏感的场景。典型应用：网站静态资源、备份归档、大数据分析。</p></li>
<li><p><strong>块存储</strong>：适合需要低延迟、高 IOPS
的场景，如数据库、虚拟机磁盘。提供块设备接口，需要文件系统层。</p></li>
<li><p><strong>文件存储</strong>：适合需要共享文件系统、POSIX
语义的场景，如代码仓库、共享文档、容器持久化存储。</p></li>
</ul>
<p><strong>混合方案</strong>：很多企业采用混合架构，如数据库用块存储，静态资源用对象存储，共享文件用文件存储。</p>
<h3 id="q2-如何保证对象存储的数据一致性">Q2:
如何保证对象存储的数据一致性？</h3>
<p><strong>A</strong>:
对象存储通常采用最终一致性模型，通过以下机制保证：</p>
<ol type="1">
<li><p><strong>版本控制</strong>：启用对象版本控制，可以追踪所有变更历史。</p></li>
<li><p><strong>多副本机制</strong>：数据写入多个副本（通常 3
副本），使用多数派写入（Quorum）保证强一致性。</p></li>
<li><p><strong>校验和</strong>：每个对象都有
ETag（MD5/SHA256），下载时验证完整性。</p></li>
<li><p><strong>跨区域复制</strong>：异步复制到多个区域，保证地理冗余。</p></li>
<li><p><strong>读写一致性</strong>：</p>
<ul>
<li><strong>强一致性读取</strong>：读取最新写入的数据（可能延迟）</li>
<li><strong>最终一致性读取</strong>：可能读到旧数据（性能更好）</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 强一致性读取示例</span></span><br><span class="line">response = s3.get_object(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;file.txt&#x27;</span>,</span><br><span class="line">    ConsistencyControl=<span class="string">&#x27;STRONG&#x27;</span>  <span class="comment"># 如果支持</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="q3-hdfs-和对象存储如-s3有什么区别">Q3: HDFS 和对象存储（如
S3）有什么区别？</h3>
<p><strong>A</strong>: 主要区别：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>HDFS</th>
<th>对象存储（S3）</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>访问方式</strong></td>
<td>文件系统接口（hdfs://）</td>
<td>REST API（HTTP）</td>
</tr>
<tr>
<td><strong>一致性</strong></td>
<td>强一致性</td>
<td>最终一致性</td>
</tr>
<tr>
<td><strong>延迟</strong></td>
<td>低（本地访问）</td>
<td>中等（网络访问）</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>有限（NameNode 瓶颈）</td>
<td>极高（无单点）</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>Hadoop 生态、大数据分析</td>
<td>通用存储、Web 应用</td>
</tr>
<tr>
<td><strong>成本</strong></td>
<td>自建成本高</td>
<td>按需付费</td>
</tr>
</tbody>
</table>
<p><strong>选择建议</strong>：</p>
<ul>
<li>如果使用 Hadoop/Spark 生态，选择 HDFS</li>
<li>如果是通用存储需求，选择对象存储</li>
<li>很多企业使用 S3 作为 HDFS 的后端存储（S3A）</li>
</ul>
<h3 id="q4-如何优化对象存储的上传下载性能">Q4:
如何优化对象存储的上传下载性能？</h3>
<p><strong>A</strong>: 性能优化策略：</p>
<ol type="1">
<li><p><strong>并发上传</strong>：</p>
<ul>
<li>使用分片上传（Multipart Upload）</li>
<li>并发上传多个分片（建议 5-10 个并发）</li>
<li>分片大小：5-10MB（小文件）或 100MB（大文件）</li>
</ul></li>
<li><p><strong>压缩</strong>：</p>
<ul>
<li>上传前压缩（gzip、zstd）</li>
<li>设置 Content-Encoding 头</li>
</ul></li>
<li><p><strong>CDN 加速</strong>：</p>
<ul>
<li>静态资源通过 CDN 分发</li>
<li>设置合适的缓存策略</li>
</ul></li>
<li><p><strong>区域选择</strong>：</p>
<ul>
<li>选择离用户最近的区域</li>
<li>使用跨区域复制实现全球访问</li>
</ul></li>
<li><p><strong>连接池</strong>：</p>
<ul>
<li>复用 HTTP 连接</li>
<li>使用连接池管理</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 性能优化示例</span></span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">optimized_upload</span>(<span class="params">bucket, key, file_path</span>):</span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. 分片大小优化</span></span><br><span class="line">    file_size = os.path.getsize(file_path)</span><br><span class="line">    <span class="keyword">if</span> file_size &gt; <span class="number">100</span> * <span class="number">1024</span> * <span class="number">1024</span>:  <span class="comment"># &gt;100MB</span></span><br><span class="line">        chunk_size = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 10MB chunks</span></span><br><span class="line">        max_workers = <span class="number">10</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        chunk_size = <span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>   <span class="comment"># 5MB chunks</span></span><br><span class="line">        max_workers = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 并发上传</span></span><br><span class="line">    upload_id = s3.create_multipart_upload(Bucket=bucket, Key=key)[<span class="string">&#x27;UploadId&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> ThreadPoolExecutor(max_workers=max_workers) <span class="keyword">as</span> executor:</span><br><span class="line">        <span class="comment"># ... 并发上传逻辑</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h3 id="q5-ceph-和传统-sannas-存储有什么区别">Q5: Ceph 和传统 SAN/NAS
存储有什么区别？</h3>
<p><strong>A</strong>: 主要区别：</p>
<p><strong>传统 SAN/NAS</strong>：</p>
<ul>
<li>集中式架构，有单点故障风险</li>
<li>扩展性有限，需要专业硬件</li>
<li>成本高（硬件 + 软件许可）</li>
<li>适合传统企业应用</li>
</ul>
<p><strong>Ceph</strong>：</p>
<ul>
<li>分布式架构，无单点故障</li>
<li>软件定义，使用通用硬件</li>
<li>成本低，开源免费</li>
<li>提供对象、块、文件三种接口</li>
<li>适合云原生、大规模场景</li>
</ul>
<p><strong>迁移建议</strong>：</p>
<ul>
<li>新项目优先考虑 Ceph</li>
<li>传统应用可以逐步迁移</li>
<li>关键业务需要充分测试</li>
</ul>
<h3 id="q6-如何设计存储系统的容灾方案">Q6:
如何设计存储系统的容灾方案？</h3>
<p><strong>A</strong>: 容灾设计要点：</p>
<ol type="1">
<li><p><strong>3-2-1 规则</strong>：</p>
<ul>
<li>3 份数据副本</li>
<li>2 种不同存储介质</li>
<li>1 份异地备份</li>
</ul></li>
<li><p><strong>RTO/RPO 定义</strong>：</p>
<ul>
<li>根据业务需求定义恢复时间目标（RTO）和恢复点目标（RPO）</li>
<li>关键业务：RTO&lt;1 小时，RPO&lt;5 分钟</li>
<li>一般业务：RTO&lt;24 小时，RPO&lt;1 小时</li>
</ul></li>
<li><p><strong>多区域部署</strong>：</p>
<ul>
<li>主区域：生产环境</li>
<li>备区域：灾难恢复</li>
<li>跨区域异步复制</li>
</ul></li>
<li><p><strong>定期演练</strong>：</p>
<ul>
<li>定期进行灾难恢复演练</li>
<li>验证备份完整性</li>
<li>测试恢复流程</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容灾配置示例</span></span><br><span class="line">disaster_recovery_config = &#123;</span><br><span class="line">    <span class="string">&#x27;primary_region&#x27;</span>: <span class="string">&#x27;us-east-1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;backup_region&#x27;</span>: <span class="string">&#x27;us-west-2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;replication&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;enabled&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;mode&#x27;</span>: <span class="string">&#x27;async&#x27;</span>,  <span class="comment"># 异步复制</span></span><br><span class="line">        <span class="string">&#x27;rpo&#x27;</span>: <span class="number">3600</span>  <span class="comment"># 1 小时</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;backup&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;schedule&#x27;</span>: <span class="string">&#x27;daily&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;retention&#x27;</span>: <span class="number">30</span>,  <span class="comment"># 保留 30 天</span></span><br><span class="line">        <span class="string">&#x27;encryption&#x27;</span>: <span class="literal">True</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;monitoring&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;health_check_interval&#x27;</span>: <span class="number">300</span>,  <span class="comment"># 5 分钟</span></span><br><span class="line">        <span class="string">&#x27;alert_on_failure&#x27;</span>: <span class="literal">True</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="q7-存储成本如何优化">Q7: 存储成本如何优化？</h3>
<p><strong>A</strong>: 成本优化策略：</p>
<ol type="1">
<li><p><strong>存储分层</strong>：</p>
<ul>
<li>热数据：Standard 存储</li>
<li>温数据：Standard-IA（不频繁访问）</li>
<li>冷数据：Glacier（归档）</li>
</ul></li>
<li><p><strong>生命周期管理</strong>：</p>
<ul>
<li>自动迁移到低成本存储类别</li>
<li>自动删除过期数据</li>
</ul></li>
<li><p><strong>数据去重</strong>：</p>
<ul>
<li>块级去重</li>
<li>文件级去重</li>
</ul></li>
<li><p><strong>压缩</strong>：</p>
<ul>
<li>上传前压缩</li>
<li>选择合适压缩算法（平衡压缩率和速度）</li>
</ul></li>
<li><p><strong>容量规划</strong>：</p>
<ul>
<li>避免过度预留</li>
<li>按需扩展</li>
<li>定期清理无用数据</li>
</ul></li>
</ol>
<p><strong>成本对比示例</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">100TB 数据，保留 1 年：</span><br><span class="line"></span><br><span class="line">方案 1（全量 Standard）：</span><br><span class="line">100TB × $0.023/GB/月 × 12 = $27,600/年</span><br><span class="line"></span><br><span class="line">方案 2（分层存储）：</span><br><span class="line"></span><br><span class="line">- 热数据（10TB，30% 时间）：10TB × $0.023 × 12 = $2,760</span><br><span class="line">- 温数据（30TB，60% 时间）：30TB × $0.0125 × 12 = $4,500</span><br><span class="line">- 冷数据（60TB，10% 时间）：60TB × $0.004 × 12 = $2,880</span><br><span class="line">总计：$10,140/年（节省 63%）</span><br></pre></td></tr></table></figure></p>
<h3 id="q8-如何处理存储系统的数据迁移">Q8:
如何处理存储系统的数据迁移？</h3>
<p><strong>A</strong>: 数据迁移策略：</p>
<ol type="1">
<li><p><strong>迁移前准备</strong>：</p>
<ul>
<li>评估数据量、网络带宽</li>
<li>制定迁移计划和时间窗口</li>
<li>准备回滚方案</li>
</ul></li>
<li><p><strong>迁移方式</strong>：</p>
<ul>
<li><strong>在线迁移</strong>：不停机，逐步迁移</li>
<li><strong>离线迁移</strong>：停机窗口，批量迁移</li>
<li><strong>混合迁移</strong>：先迁移历史数据，再同步增量</li>
</ul></li>
<li><p><strong>工具选择</strong>：</p>
<ul>
<li>AWS：<code>aws s3 sync</code>、DataSync</li>
<li>阿里云：ossutil、ossimport</li>
<li>通用：rclone、rsync</li>
</ul></li>
<li><p><strong>验证</strong>：</p>
<ul>
<li>校验和对比</li>
<li>抽样验证</li>
<li>完整性检查</li>
</ul></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 rclone 迁移示例</span></span><br><span class="line"><span class="comment"># 1. 配置源和目标</span></span><br><span class="line">rclone config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试迁移（dry-run）</span></span><br><span class="line">rclone copy <span class="built_in">source</span>:path dest:path --dry-run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 执行迁移（带进度）</span></span><br><span class="line">rclone copy <span class="built_in">source</span>:path dest:path --progress --transfers 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 验证（校验和）</span></span><br><span class="line">rclone check <span class="built_in">source</span>:path dest:path</span><br></pre></td></tr></table></figure>
<h3 id="q9-对象存储的安全性如何保证">Q9: 对象存储的安全性如何保证？</h3>
<p><strong>A</strong>: 安全措施：</p>
<ol type="1">
<li><p><strong>访问控制</strong>：</p>
<ul>
<li>IAM 策略（细粒度权限）</li>
<li>桶策略（Bucket Policy）</li>
<li>ACL（访问控制列表）</li>
<li>预签名 URL（临时访问）</li>
</ul></li>
<li><p><strong>加密</strong>：</p>
<ul>
<li><strong>传输加密</strong>：HTTPS/TLS</li>
<li><strong>存储加密</strong>：服务端加密（SSE-S3、SSE-KMS）</li>
<li><strong>客户端加密</strong>：上传前加密</li>
</ul></li>
<li><p><strong>审计</strong>：</p>
<ul>
<li>启用访问日志（Access Logging）</li>
<li>CloudTrail 审计（AWS）</li>
<li>监控异常访问</li>
</ul></li>
<li><p><strong>合规</strong>：</p>
<ul>
<li>数据分类和标记</li>
<li>保留策略</li>
<li>合规性检查</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安全配置示例</span></span><br><span class="line"><span class="comment"># 1. 加密存储</span></span><br><span class="line">s3.put_object(</span><br><span class="line">    Bucket=<span class="string">&#x27;my-bucket&#x27;</span>,</span><br><span class="line">    Key=<span class="string">&#x27;sensitive-data.txt&#x27;</span>,</span><br><span class="line">    Body=data,</span><br><span class="line">    ServerSideEncryption=<span class="string">&#x27;AES256&#x27;</span>  <span class="comment"># 或 &#x27;aws:kms&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 预签名 URL（临时访问）</span></span><br><span class="line">url = s3.generate_presigned_url(</span><br><span class="line">    <span class="string">&#x27;get_object&#x27;</span>,</span><br><span class="line">    Params=&#123;<span class="string">&#x27;Bucket&#x27;</span>: <span class="string">&#x27;my-bucket&#x27;</span>, <span class="string">&#x27;Key&#x27;</span>: <span class="string">&#x27;file.txt&#x27;</span>&#125;,</span><br><span class="line">    ExpiresIn=<span class="number">3600</span>  <span class="comment"># 1 小时有效</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 桶策略（禁止公开访问）</span></span><br><span class="line">bucket_policy = &#123;</span><br><span class="line">    <span class="string">&quot;Version&quot;</span>: <span class="string">&quot;2012-10-17&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Statement&quot;</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;Sid&quot;</span>: <span class="string">&quot;DenyPublicAccess&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Effect&quot;</span>: <span class="string">&quot;Deny&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Principal&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Action&quot;</span>: <span class="string">&quot;s3:GetObject&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Resource&quot;</span>: <span class="string">&quot;arn:aws:s3:::my-bucket/*&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Condition&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;StringNotEquals&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;aws:username&quot;</span>: [<span class="string">&quot;allowed-user&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="q10-如何监控存储系统的性能和健康状态">Q10:
如何监控存储系统的性能和健康状态？</h3>
<p><strong>A</strong>: 监控指标和工具：</p>
<p><strong>关键指标</strong>： 1. <strong>容量指标</strong>：</p>
<ul>
<li>总容量、已用容量、可用容量</li>
<li>增长率、预测容量</li>
</ul>
<ol start="2" type="1">
<li><p><strong>性能指标</strong>：</p>
<ul>
<li>IOPS、吞吐量、延迟</li>
<li>请求成功率、错误率</li>
</ul></li>
<li><p><strong>可用性指标</strong>：</p>
<ul>
<li>服务可用性（SLA）</li>
<li>节点健康状态</li>
<li>副本完整性</li>
</ul></li>
<li><p><strong>成本指标</strong>：</p>
<ul>
<li>存储成本、请求成本</li>
<li>数据传输成本</li>
</ul></li>
</ol>
<p><strong>监控工具</strong>：</p>
<ul>
<li><strong>云服务商</strong>：CloudWatch（AWS）、云监控（阿里云）</li>
<li><strong>开源</strong>：Prometheus + Grafana</li>
<li><strong>专业工具</strong>：Datadog、New Relic</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控示例（使用 boto3）</span></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line">cloudwatch = boto3.client(<span class="string">&#x27;cloudwatch&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取存储使用量</span></span><br><span class="line">response = cloudwatch.get_metric_statistics(</span><br><span class="line">    Namespace=<span class="string">&#x27;AWS/S3&#x27;</span>,</span><br><span class="line">    MetricName=<span class="string">&#x27;BucketSizeBytes&#x27;</span>,</span><br><span class="line">    Dimensions=[</span><br><span class="line">        &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;BucketName&#x27;</span>, <span class="string">&#x27;Value&#x27;</span>: <span class="string">&#x27;my-bucket&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;StorageType&#x27;</span>, <span class="string">&#x27;Value&#x27;</span>: <span class="string">&#x27;StandardStorage&#x27;</span>&#125;</span><br><span class="line">    ],</span><br><span class="line">    StartTime=datetime.now() - timedelta(days=<span class="number">7</span>),</span><br><span class="line">    EndTime=datetime.now(),</span><br><span class="line">    Period=<span class="number">3600</span>,</span><br><span class="line">    Statistics=[<span class="string">&#x27;Average&#x27;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取请求数</span></span><br><span class="line">response = cloudwatch.get_metric_statistics(</span><br><span class="line">    Namespace=<span class="string">&#x27;AWS/S3&#x27;</span>,</span><br><span class="line">    MetricName=<span class="string">&#x27;NumberOfObjects&#x27;</span>,</span><br><span class="line">    Dimensions=[</span><br><span class="line">        &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;BucketName&#x27;</span>, <span class="string">&#x27;Value&#x27;</span>: <span class="string">&#x27;my-bucket&#x27;</span>&#125;</span><br><span class="line">    ],</span><br><span class="line">    StartTime=datetime.now() - timedelta(days=<span class="number">1</span>),</span><br><span class="line">    EndTime=datetime.now(),</span><br><span class="line">    Period=<span class="number">300</span>,</span><br><span class="line">    Statistics=[<span class="string">&#x27;Average&#x27;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 告警配置</span></span><br><span class="line">cloudwatch.put_metric_alarm(</span><br><span class="line">    AlarmName=<span class="string">&#x27;s3-bucket-size-alarm&#x27;</span>,</span><br><span class="line">    MetricName=<span class="string">&#x27;BucketSizeBytes&#x27;</span>,</span><br><span class="line">    Namespace=<span class="string">&#x27;AWS/S3&#x27;</span>,</span><br><span class="line">    Statistic=<span class="string">&#x27;Average&#x27;</span>,</span><br><span class="line">    Period=<span class="number">3600</span>,</span><br><span class="line">    EvaluationPeriods=<span class="number">1</span>,</span><br><span class="line">    Threshold=<span class="number">1000000000000</span>,  <span class="comment"># 1TB</span></span><br><span class="line">    ComparisonOperator=<span class="string">&#x27;GreaterThanThreshold&#x27;</span>,</span><br><span class="line">    AlarmActions=[<span class="string">&#x27;arn:aws:sns:region:account:topic&#x27;</span>]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>设置容量告警（80%、90%、95%）</li>
<li>监控异常访问模式</li>
<li>定期检查备份完整性</li>
<li>跟踪成本趋势</li>
<li>建立监控仪表板（Dashboard）</li>
</ul>
<hr>
<h2 id="总结">总结</h2>
<p>云存储系统是现代云计算基础设施的核心组件，选择合适的存储类型、设计合理的架构、实施有效的优化策略，对于构建稳定、高效、经济的存储解决方案至关重要。无论是对象存储的
RESTful 接口、块存储的低延迟特性，还是文件存储的 POSIX
语义，每种存储类型都有其适用场景。通过理解 CAP/BASE
理论、掌握复制策略、实施容灾方案，可以构建出既满足业务需求又控制成本的存储系统。</p>
<p>在实际应用中，往往需要结合多种存储类型，形成混合存储架构。同时，随着数据量的增长和业务需求的变化，存储系统也需要持续优化和演进。希望本文的内容能够帮助读者更好地理解和应用云存储技术，在实际项目中做出明智的技术选择。</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    
    
    
    
    
    
    <ul>
        <li>本文标题：云计算（三）存储系统与分布式架构</li>
        <li>本文作者：Chen Kai</li>
        <li>创建时间：2023-10-27 00:00:00</li>
        <li>
            本文链接：https://www.chenk.top/cloud-computing-storage-systems/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">#云计算</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8/">#分布式存储</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/">#对象存储</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/HDFS/">#HDFS</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/Ceph/">#Ceph</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/cloud-computing-fundamentals/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">云计算（一）基础概念与架构体系</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/cloud-computing-operations-devops/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">云计算（七）运维与DevOps实践</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'p2Cu9MgjoKzo3VmulhNLIusH-gzGzoHsz',
                    appKey: 'QThQHg3c8sVwGpzg9lu8zEG3',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情赞美帅气伟大的ck吧~',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Chen Kai';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2026&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Chen Kai</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
            </div>
        
        <div class="theme-info info-item">
            <!-- 由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a> -->
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">分布式存储基础</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cap-%E5%AE%9A%E7%90%86%E4%B8%8E%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F"><span class="nav-number">1.1.</span> <span class="nav-text">CAP 定理与存储系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#base-%E7%90%86%E8%AE%BA"><span class="nav-number">1.2.</span> <span class="nav-text">BASE 理论</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%88%86%E5%B8%83%E7%AD%96%E7%95%A5"><span class="nav-number">1.3.</span> <span class="nav-text">数据分布策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">对象存储详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#s3oss-%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.1.</span> <span class="nav-text">S3&#x2F;OSS 架构设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#s3-api-%E6%A0%B8%E5%BF%83%E6%93%8D%E4%BD%9C"><span class="nav-number">2.2.</span> <span class="nav-text">S3 API 核心操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82"><span class="nav-number">2.3.</span> <span class="nav-text">对象存储实现细节</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9D%97%E5%AD%98%E5%82%A8%E4%B8%8E%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E6%B7%B1%E5%BA%A6%E5%AF%B9%E6%AF%94"><span class="nav-number">3.</span> <span class="nav-text">块存储与文件存储深度对比</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%97%E5%AD%98%E5%82%A8block-storage"><span class="nav-number">3.1.</span> <span class="nav-text">块存储（Block Storage）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8file-storage"><span class="nav-number">3.2.</span> <span class="nav-text">文件存储（File Storage）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94%E8%A1%A8%E6%A0%BC"><span class="nav-number">3.3.</span> <span class="nav-text">对比表格</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE"><span class="nav-number">3.4.</span> <span class="nav-text">选择建议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hdfs-%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.</span> <span class="nav-text">HDFS 分布式文件系统实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hdfs-%E6%9E%B6%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">HDFS 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hdfs-%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87"><span class="nav-number">4.2.</span> <span class="nav-text">HDFS 数据组织</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hdfs-%E9%85%8D%E7%BD%AE%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.3.</span> <span class="nav-text">HDFS 配置示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hdfs-%E6%93%8D%E4%BD%9C%E5%91%BD%E4%BB%A4"><span class="nav-number">4.4.</span> <span class="nav-text">HDFS 操作命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hdfs-%E9%AB%98%E5%8F%AF%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">4.5.</span> <span class="nav-text">HDFS 高可用配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ceph-%E5%AD%98%E5%82%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E4%B8%8E%E7%AE%A1%E7%90%86"><span class="nav-number">5.</span> <span class="nav-text">Ceph 存储集群部署与管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0"><span class="nav-number">5.1.</span> <span class="nav-text">Ceph 架构概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E9%83%A8%E7%BD%B2%E5%87%86%E5%A4%87"><span class="nav-number">5.2.</span> <span class="nav-text">Ceph 部署准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">5.3.</span> <span class="nav-text">Ceph 集群部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">5.4.</span> <span class="nav-text">Ceph 配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E5%AD%98%E5%82%A8%E6%B1%A0%E7%AE%A1%E7%90%86"><span class="nav-number">5.5.</span> <span class="nav-text">Ceph 存储池管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E5%9D%97%E5%AD%98%E5%82%A8rbd"><span class="nav-number">5.6.</span> <span class="nav-text">Ceph 块存储（RBD）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8rados-gateway"><span class="nav-number">5.7.</span> <span class="nav-text">Ceph 对象存储（RADOS Gateway）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E7%9B%91%E6%8E%A7%E4%B8%8E%E7%BB%B4%E6%8A%A4"><span class="nav-number">5.8.</span> <span class="nav-text">Ceph 监控与维护</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E4%B8%8E%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5"><span class="nav-number">6.</span> <span class="nav-text">数据一致性与复制策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7%E6%A8%A1%E5%9E%8B"><span class="nav-number">6.1.</span> <span class="nav-text">一致性模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%8D%E5%88%B6%E7%AD%96%E7%95%A5"><span class="nav-number">6.2.</span> <span class="nav-text">复制策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3"><span class="nav-number">6.3.</span> <span class="nav-text">冲突解决</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E5%AE%B9%E7%81%BE%E6%96%B9%E6%A1%88"><span class="nav-number">7.</span> <span class="nav-text">数据备份与容灾方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5"><span class="nav-number">7.1.</span> <span class="nav-text">备份策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%A4%87%E4%BB%BD"><span class="nav-number">7.2.</span> <span class="nav-text">对象存储备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%A8%E5%8C%BA%E5%9F%9F%E5%A4%8D%E5%88%B6"><span class="nav-number">7.3.</span> <span class="nav-text">跨区域复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E7%81%BE%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1"><span class="nav-number">7.4.</span> <span class="nav-text">容灾方案设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%AE%9E%E6%88%98"><span class="nav-number">8.</span> <span class="nav-text">存储性能优化实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="nav-number">8.1.</span> <span class="nav-text">性能指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">8.2.</span> <span class="nav-text">对象存储性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%97%E5%AD%98%E5%82%A8%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">8.3.</span> <span class="nav-text">块存储性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hdfs-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">8.4.</span> <span class="nav-text">HDFS 性能优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ceph-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">8.5.</span> <span class="nav-text">Ceph 性能优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-number">9.</span> <span class="nav-text">成本优化策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%88%86%E5%B1%82"><span class="nav-number">9.1.</span> <span class="nav-text">存储分层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D"><span class="nav-number">9.2.</span> <span class="nav-text">数据去重</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E7%AD%96%E7%95%A5"><span class="nav-number">9.3.</span> <span class="nav-text">压缩策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E9%87%8F%E8%A7%84%E5%88%92"><span class="nav-number">9.4.</span> <span class="nav-text">容量规划</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="nav-number">10.</span> <span class="nav-text">实战案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%E5%A4%A7%E8%A7%84%E6%A8%A1%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F"><span class="nav-number">10.1.</span> <span class="nav-text">案例一：大规模日志存储系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E7%B3%BB%E7%BB%9F"><span class="nav-number">10.2.</span> <span class="nav-text">案例二：数据库备份系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%E5%A4%9A%E5%AA%92%E4%BD%93%E5%86%85%E5%AE%B9%E5%88%86%E5%8F%91%E7%B3%BB%E7%BB%9F"><span class="nav-number">10.3.</span> <span class="nav-text">案例三：多媒体内容分发系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#qa-%E4%BA%91%E5%AD%98%E5%82%A8%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">11.</span> <span class="nav-text">❓ Q&amp;A: 云存储常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#q1-%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%9D%97%E5%AD%98%E5%82%A8%E5%92%8C%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9"><span class="nav-number">11.1.</span> <span class="nav-text">Q1:
对象存储、块存储和文件存储如何选择？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q2-%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-number">11.2.</span> <span class="nav-text">Q2:
如何保证对象存储的数据一致性？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q3-hdfs-%E5%92%8C%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E5%A6%82-s3%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB"><span class="nav-number">11.3.</span> <span class="nav-text">Q3: HDFS 和对象存储（如
S3）有什么区别？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q4-%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%9A%84%E4%B8%8A%E4%BC%A0%E4%B8%8B%E8%BD%BD%E6%80%A7%E8%83%BD"><span class="nav-number">11.4.</span> <span class="nav-text">Q4:
如何优化对象存储的上传下载性能？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q5-ceph-%E5%92%8C%E4%BC%A0%E7%BB%9F-sannas-%E5%AD%98%E5%82%A8%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB"><span class="nav-number">11.5.</span> <span class="nav-text">Q5: Ceph 和传统 SAN&#x2F;NAS
存储有什么区别？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q6-%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%AE%B9%E7%81%BE%E6%96%B9%E6%A1%88"><span class="nav-number">11.6.</span> <span class="nav-text">Q6:
如何设计存储系统的容灾方案？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q7-%E5%AD%98%E5%82%A8%E6%88%90%E6%9C%AC%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96"><span class="nav-number">11.7.</span> <span class="nav-text">Q7: 存储成本如何优化？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q8-%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="nav-number">11.8.</span> <span class="nav-text">Q8:
如何处理存储系统的数据迁移？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q9-%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81"><span class="nav-number">11.9.</span> <span class="nav-text">Q9: 对象存储的安全性如何保证？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q10-%E5%A6%82%E4%BD%95%E7%9B%91%E6%8E%A7%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%80%A7%E8%83%BD%E5%92%8C%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="nav-number">11.10.</span> <span class="nav-text">Q10:
如何监控存储系统的性能和健康状态？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">12.</span> <span class="nav-text">总结</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/lang-switch.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
