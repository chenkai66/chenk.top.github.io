<!DOCTYPE html>



<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="为网球场公司设计的完整计算机视觉系统，涵盖小物体检测、多镜头3D重建、轨迹预测和姿态识别，附带论文调研和工业级代码实现。">
    <meta name="author" content="Chen Kai">
    
    <title>
        
            网球场景计算机视觉系统设计方案：从论文调研到工业实现 |
        
        Chen Kai Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chenk.top","root":"/","language":"zh-CN","default_language":"zh-CN","languages":["zh-CN","en"],"path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Chen Kai Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    
    
    
    
    

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Chen Kai Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    <li class="menu-item lang-switch lang-switch-trigger" title="Language">
                        <i class="fas fa-globe"></i>
                    </li>
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item lang-switch-trigger"><i class="fas fa-globe"></i></div>
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    
    
    
    

    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">网球场景计算机视觉系统设计方案：从论文调研到工业实现</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Chen Kai</span>
                        
                            <span class="author-label">BOSS</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    
    
    
    
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2026-01-31 15:30:00</span>
        <span class="mobile">2026-01-31 15:30</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88/">技术方案</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/">计算机视觉</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/">目标检测</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/3D%E9%87%8D%E5%BB%BA/">3D重建</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E8%BD%A8%E8%BF%B9%E9%A2%84%E6%B5%8B/">轨迹预测</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%A7%BF%E6%80%81%E4%BC%B0%E8%AE%A1/">姿态估计</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>13.6k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>63 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>网球比赛中，球的速度可以达到200+
km/h，直径只有6.7厘米，在摄像头画面中可能只占10-20个像素。如何实时检测、跟踪这样的小物体，并从多个摄像头视角重建出三维轨迹？如何识别球员的动作姿态，预测球的落点？本文将系统性地设计一套完整的网球场景计算机视觉系统，从论文调研到工业方案，再到可运行的代码demo。</p>
<span id="more"></span>
<h2 id="需求与挑战">需求与挑战</h2>
<h3 id="核心功能需求">核心功能需求</h3>
<p>一个完整的网球场智能分析系统需要具备以下能力：</p>
<p><strong>小物体检测</strong>：实时检测高速运动的网球。网球直径约6.7cm，在距离摄像头10-20米的场地中，可能只占画面中10-20个像素。加上200+
km/h的高速运动，会产生明显的运动模糊，检测难度极大。</p>
<p><strong>多镜头三维场景重建</strong>：单个摄像头只能提供2D信息，无法获得深度。需要部署6-8个摄像头形成多视角覆盖，通过三角测量重建三维场景。这要求所有摄像头必须精确标定，并实现毫秒级时间同步。</p>
<p><strong>三维定位与轨迹跟踪</strong>：将多个2D检测结果融合为3D坐标，并在时间维度上进行跟踪。由于网球会出现遮挡、快速移动、甚至短暂离开视野，需要鲁棒的跟踪算法。</p>
<p><strong>轨迹预测</strong>：基于已观测到的轨迹点，预测未来的飞行路径和落地点。这既需要物理建模（抛物线运动+空气阻力），也需要数据驱动的方法（神经网络）来处理旋转等复杂因素。</p>
<p><strong>人体姿态识别</strong>：识别球员的动作类型（发球、正手、反手、截击等），用于技术分析和训练辅助。需要实时估计17个以上的人体关键点，并与预定义的动作模板进行匹配。</p>
<h3 id="技术挑战">技术挑战</h3>
<p><strong>硬件同步</strong>：60fps的视频流下，相邻两帧间隔仅16.7ms。如果不同摄像头之间的时间差超过5ms，三角测量的误差会急剧增大。需要采用PTP（Precision
Time Protocol）实现亚毫秒级同步。</p>
<p><strong>实时性要求</strong>：整个处理流程（检测、跟踪、3D重建、姿态估计）必须在16.7ms内完成，才能实现60fps的实时分析。这对计算资源提出了极高要求。</p>
<p><strong>小物体漏检</strong>：传统目标检测算法（如YOLO、Faster
R-CNN）在处理小物体时表现不佳。需要针对性优化：更大的输入尺寸、多尺度特征融合、专门的数据增强策略。</p>
<p><strong>运动模糊</strong>：高速运动的网球容易产生拖影，导致边界不清晰。需要高速快门（最小1/1000s）配合后处理算法（如去模糊、运动补偿）。</p>
<p><strong>背景干扰</strong>：网球场有大量白色线条、观众、广告牌等干扰元素，容易产生假阳性检测。需要结合场景先验知识进行过滤。</p>
<h2 id="论文调研">论文调研</h2>
<h3 id="小物体检测">小物体检测</h3>
<p><strong>YOLOv8/YOLOv9（2024）</strong>：最新的YOLO系列针对小物体检测进行了大量优化。核心改进包括：
-
P2层输出：引入更高分辨率的特征图（stride=4），相比传统的P3（stride=8）能捕捉更细粒度的信息
- SPPF模块：多尺度池化融合，增强感受野 -
锚框自适应：自动学习最适合小物体的锚框分布</p>
<p>实验表明，在COCO数据集上，YOLOv8对小物体（面积&lt;32×32像素）的AP提升了约8个百分点。</p>
<p><strong>TrackNet系列（2019-2023）</strong>：这是专门针对网球场景设计的经典算法。</p>
<p>TrackNet V1（CVPR 2019）采用VGG-based
U-Net架构，输入连续3帧图像，输出一个热力图（heatmap），表示网球在每个位置的概率。关键创新是使用<strong>时序信息</strong>：连续3帧可以捕捉运动趋势，帮助区分网球和静态干扰物。</p>
<p>TrackNet
V2（2020）引入<strong>轻量化设计</strong>，将骨干网络替换为MobileNetV2，参数量从15M降至2.8M，推理速度提升3倍，但精度仅下降1.2%。同时增加了<strong>temporal
shift module</strong>，能以更低的计算成本融合时序信息。</p>
<p>最新的TrackNet
V3（2023）采用<strong>Transformer架构</strong>，用self-attention机制替代卷积，能更好地建模长距离依赖关系。在高速球场景下，检测成功率从92.3%提升到96.7%。</p>
<p><strong>Deep-Learning-Based Tennis Ball
Detection（2023）</strong>：该论文提出了一个两阶段框架： 1.
<strong>粗检测阶段</strong>：使用YOLOv5快速定位候选区域 2.
<strong>精细化阶段</strong>：对候选区域进行高分辨率裁剪（256×256），用ResNet-50进一步判断是否为真正的网球</p>
<p>这种coarse-to-fine策略在保持实时性的同时，将误检率降低了60%。</p>
<h3 id="多视角跟踪与3d重建">多视角跟踪与3D重建</h3>
<p><strong>Multi-View Geometry in Computer Vision（Hartley &amp;
Zisserman）</strong>：这是多视角几何的圣经级教材。核心内容包括：</p>
<p><strong>相机标定</strong>：Zhang's
Method（1998）是工业界最常用的标定算法。通过拍摄不同角度下的棋盘格图像，求解相机内参（焦距<span class="math inline">\(f_x, f_y\)</span>，主点<span class="math inline">\(c_x, c_y\)</span>，畸变系数<span class="math inline">\(k_1, k_2, p_1, p_2\)</span>）和外参（旋转<span class="math inline">\(R\)</span>，平移<span class="math inline">\(t\)</span>）。</p>
<p>标定的数学基础是<strong>针孔相机模型</strong>：</p>
<p><span class="math display">\[
s \begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = K[R|t] \begin{bmatrix} X
\\ Y \\ Z \\ 1 \end{bmatrix}
\]</span></p>
<p>其中<span class="math inline">\(K\)</span>是相机内参矩阵，<span class="math inline">\([R|t]\)</span>是外参，<span class="math inline">\((X,Y,Z)\)</span>是世界坐标系中的3D点，<span class="math inline">\((u,v)\)</span>是图像坐标系中的2D点，<span class="math inline">\(s\)</span>是尺度因子。</p>
<p><strong>三角测量（Triangulation）</strong>：从多个视角的2D观测重建3D点。最经典的方法是<strong>DLT（Direct
Linear Transform）</strong>。</p>
<p>假设有<span class="math inline">\(n\)</span>个相机观测到同一个3D点<span class="math inline">\(\mathbf{X}\)</span>，在第<span class="math inline">\(i\)</span>个相机的投影为<span class="math inline">\((u_i, v_i)\)</span>。定义投影矩阵<span class="math inline">\(P_i = K_i[R_i|t_i]\)</span>，则有：</p>
<p><span class="math display">\[
\begin{bmatrix} u_i \\ v_i \\ 1 \end{bmatrix} \times P_i \mathbf{X} = 0
\]</span></p>
<p>展开叉乘得到线性方程组：</p>
<p><span class="math display">\[
\begin{bmatrix}
u_i P_i^{3T} - P_i^{1T} \\
v_i P_i^{3T} - P_i^{2T}
\end{bmatrix} \mathbf{X} = 0
\]</span></p>
<p>其中<span class="math inline">\(P_i^{kT}\)</span>表示<span class="math inline">\(P_i\)</span>的第<span class="math inline">\(k\)</span>行。将所有相机的方程堆叠起来，得到<span class="math inline">\(2n \times 4\)</span>的矩阵<span class="math inline">\(A\)</span>，满足<span class="math inline">\(A\mathbf{X}=0\)</span>。通过SVD求解最小二乘解。</p>
<p><strong>Automatic Camera Network
Calibration（2024）</strong>：这篇最新论文提出了一种无需标定板的自动标定方法。核心思想是：</p>
<ol type="1">
<li>检测所有相机中的共同特征点（如SIFT、ORB）</li>
<li>通过Structure-from-Motion（SfM）同时估计相机参数和场景结构</li>
<li>使用Bundle Adjustment全局优化，最小化重投影误差</li>
</ol>
<p>实验表明，该方法的标定精度接近传统方法（误差&lt;0.5像素），但工作流程更便捷，适合现场快速部署。</p>
<h3 id="目标跟踪">目标跟踪</h3>
<p><strong>SORT/DeepSORT/ByteTrack（2016-2024）</strong>：这是多目标跟踪（MOT）领域的经典系列。</p>
<p><strong>SORT（2016）</strong>：Simple Online and Realtime
Tracking。核心是<strong>卡尔曼滤波 + 匈牙利算法</strong>： -
卡尔曼滤波：对每个目标的状态（位置、速度）进行预测和更新 -
匈牙利算法：将检测结果与已有轨迹进行最优匹配（基于IoU距离）</p>
<p>SORT的优点是速度快（&gt;1000 fps on
CPU），缺点是缺乏表观特征，容易在遮挡时丢失目标。</p>
<p><strong>DeepSORT（2017）</strong>：在SORT基础上引入<strong>深度表观特征</strong>。用ResNet-50提取每个检测框的特征向量（128维），匹配时同时考虑运动相似度和表观相似度：</p>
<p><span class="math display">\[
c_{ij} = \lambda d_{\text{motion}}(i,j) + (1-\lambda)
d_{\text{appearance}}(i,j)
\]</span></p>
<p><span class="math inline">\(\lambda\)</span>是权重因子，通常取0.5-0.7。这使得即使在遮挡后重新出现，也能正确关联轨迹。</p>
<p><strong>ByteTrack（2021）</strong>：创新点是<strong>低置信度检测的利用</strong>。传统方法会直接丢弃置信度低于阈值（如0.5）的检测框，但ByteTrack发现，很多真阳性目标（如被遮挡的部分）会被标注为低置信度。</p>
<p>算法分两步匹配： 1. 高置信度检测（&gt;0.6）与已有轨迹匹配 2.
未匹配的轨迹与低置信度检测（0.1-0.6）再次匹配</p>
<p>这种策略在MOT17数据集上将MOTA（Multiple Object Tracking
Accuracy）提升了4.3个百分点。</p>
<p><strong>针对网球的改进</strong>：网球跟踪有其特殊性： -
<strong>单目标</strong>：大多数时候只有一个球 -
<strong>高速运动</strong>：卡尔曼滤波的匀速假设不适用，需要匀加速或更复杂的运动模型
- <strong>短暂消失</strong>：球可能被球员身体遮挡，需要保持轨迹记忆</p>
<p>推荐使用<strong>扩展卡尔曼滤波（EKF）</strong>或<strong>粒子滤波</strong>，配合物理约束（如重力加速度）。</p>
<h3 id="轨迹预测">轨迹预测</h3>
<p><strong>Physics-Informed Neural
Networks（2023）</strong>：将物理定律嵌入神经网络。</p>
<p>对于网球轨迹，物理模型是：</p>
<p><span class="math display">\[
\begin{cases}
\ddot{x} = -k_d \dot{x} |\dot{\mathbf{v}}| \\
\ddot{y} = -g - k_d \dot{y} |\dot{\mathbf{v}}| \\
\ddot{z} = -k_d \dot{z} |\dot{\mathbf{v}}|
\end{cases}
\]</span></p>
<p>其中<span class="math inline">\(g=9.8 \,
\text{m/s}^2\)</span>是重力加速度，<span class="math inline">\(k_d\)</span>是空气阻力系数（与球的材质、形状有关），<span class="math inline">\(|\dot{\mathbf{v}}|=\sqrt{\dot{x}^2+\dot{y}^2+\dot{z}^2}\)</span>是速度的模。</p>
<p>PINN的做法是：定义一个神经网络<span class="math inline">\(\mathbf{r}(t) = \text{NN}(t;
\theta)\)</span>，预测位置随时间的变化。损失函数包含两部分：</p>
<p><span class="math display">\[
\mathcal{L} = \mathcal{L}_{\text{data}} + \lambda
\mathcal{L}_{\text{physics}}
\]</span></p>
<ul>
<li><span class="math inline">\(\mathcal{L}_{\text{data}}\)</span>：拟合已观测到的轨迹点</li>
<li><span class="math inline">\(\mathcal{L}_{\text{physics}}\)</span>：满足物理方程（通过自动微分计算<span class="math inline">\(\ddot{\mathbf{r}}\)</span>）</li>
</ul>
<p>实验表明，相比纯数据驱动的方法（如LSTM），PINN在样本量较少时泛化能力更强，预测误差降低30%以上。</p>
<p><strong>TrackNetV2 with Trajectory
Prediction（2020）</strong>：在检测基础上增加了轨迹预测模块，采用<strong>双向LSTM</strong>：
- 前向LSTM：基于过去10帧预测未来 -
后向LSTM：利用未来帧反向修正历史轨迹（用于离线分析）</p>
<p>输入特征包括：位置<span class="math inline">\((x,y)\)</span>、速度<span class="math inline">\((\dot{x}, \dot{y})\)</span>、加速度<span class="math inline">\((\ddot{x},
\ddot{y})\)</span>，以及表观特征（从检测模块提取的embedding）。</p>
<p>在落地点预测任务上，平均误差从纯物理模型的32cm降至18cm。</p>
<h3 id="人体姿态估计">人体姿态估计</h3>
<p><strong>OpenPose（2017）</strong>：CMU开发的经典算法，首次实现了实时多人姿态估计。</p>
<p>核心思想是<strong>自下而上（bottom-up）</strong>：先检测画面中所有的身体关键点（不区分属于哪个人），再通过Part
Affinity Fields（PAFs）将关键点组装成完整的人体骨架。</p>
<p>PAF是一个二维向量场，在关键点对（如"左肩-左肘"）之间的线段上，向量指向从起点到终点的方向。通过沿线段积分，可以判断两个关键点是否属于同一个人：</p>
<p><span class="math display">\[
\int_{\mathbf{p}_1}^{\mathbf{p}_2} \mathbf{L}(\mathbf{p}) \cdot
\frac{\mathbf{p}_2 - \mathbf{p}_1}{||\mathbf{p}_2 - \mathbf{p}_1||} \,
d\mathbf{p}
\]</span></p>
<p>如果积分值大于阈值，则连接这两个关键点。</p>
<p><strong>MMPose（2023）</strong>：OpenMMLab推出的姿态估计工具箱，集成了50+种算法。推荐配置：
- 骨干网络：HRNet-W48（High-Resolution Net） - 输入尺寸：384×288 -
输出：17个COCO关键点（鼻子、眼睛、耳朵、肩膀、肘部、手腕、臀部、膝盖、脚踝）</p>
<p>HRNet的特点是<strong>始终保持高分辨率特征图</strong>，不像ResNet那样逐层下采样。这对于精确定位关键点至关重要。</p>
<p><strong>ViTPose（2022）</strong>：将Vision
Transformer引入姿态估计。</p>
<p>相比CNN，ViT有两个优势： 1.
<strong>全局感受野</strong>：self-attention能直接建模任意两个patch之间的关系，而CNN需要堆叠多层才能扩大感受野
2. <strong>尺度不变性</strong>：通过position
embedding，ViT对输入尺寸的变化不敏感</p>
<p>在COCO test-dev上，ViTPose-H达到了81.1 AP，超越了所有CNN方法。</p>
<p><strong>4D
Human（2024）</strong>：最新的趋势是从2D姿态估计迈向4D（3D空间 +
时间）。</p>
<p>该方法同时估计： - 3D关键点位置 - SMPL身体模型参数（形状、姿态） -
时序一致性（相邻帧之间的平滑性）</p>
<p>对于网球分析，3D姿态能提供更丰富的信息，如挥拍的空间轨迹、身体重心的转移等。</p>
<h2 id="系统架构设计">系统架构设计</h2>
<h3 id="硬件配置">硬件配置</h3>
<p><strong>摄像头布局</strong>：</p>
<p>场地尺寸：标准网球单打场地长23.77m，宽8.23m。推荐部署方案：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">            网               摄像头6</span><br><span class="line">                            (中场侧视)</span><br><span class="line"> 摄像头1 ————————————————————— 摄像头2</span><br><span class="line">(后场高角度)  发球线         (后场高角度)</span><br><span class="line">                            摄像头7</span><br><span class="line">                            (中场侧视)</span><br><span class="line"> 摄像头3 ————————————————————— 摄像头4</span><br><span class="line">(前场高角度)  球网          (前场高角度)</span><br><span class="line"></span><br><span class="line">            摄像头5</span><br><span class="line">            (球网正对)</span><br></pre></td></tr></table></figure>
<ul>
<li>摄像头1-4：安装在场地四角，高度5-8米，俯视角度30-45°，用于全局覆盖</li>
<li>摄像头5：安装在球网正对位置，用于捕捉球过网瞬间</li>
<li>摄像头6-7：安装在场地两侧中场位置，侧视角度，用于精确测量球的高度</li>
<li>摄像头8（可选）：安装在裁判椅上方，俯瞰全场</li>
</ul>
<p><strong>相机规格</strong>： - 分辨率：3840×2160（4K） -
帧率：60fps（职业赛事建议120fps） -
快门速度：最小1/1000s（避免运动模糊） -
镜头：广角镜头（焦距8-12mm），FOV覆盖至少半个场地 - 接口：GigE
Vision或USB 3.0 - 同步：支持硬件触发或PTP网络同步</p>
<p>推荐型号：FLIR Blackfly S（工业级）或Basler ace（性价比高）。</p>
<p><strong>计算平台</strong>：</p>
<p>方案1：<strong>集中式处理</strong>（适合固定场馆） -
GPU服务器：NVIDIA RTX 4090（24GB显存）×2 - CPU：Intel Xeon或AMD
Threadripper（32核以上） - 内存：128GB DDR5 - 存储：2TB NVMe
SSD（用于缓存视频流）+ 10TB HDD（长期存储） - 网络：10GbE交换机</p>
<p>方案2：<strong>边缘计算</strong>（适合移动场景） - Jetson AGX
Orin（每个摄像头配一台） - 集中式推理：2-3台Jetson合作处理融合任务 -
主控：x86小主机（Intel NUC）</p>
<p><strong>网络架构</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">摄像头1-8 → 千兆交换机 → GPU服务器 → 结果输出</span><br><span class="line">              ↓                ↓</span><br><span class="line">          NTP时间服务器    监控/存储服务器</span><br></pre></td></tr></table></figure>
<p>时间同步至关重要。推荐使用IEEE 1588
PTP协议，可实现亚微秒级同步。配置方法： 1. 选择一台服务器作为Grandmaster
Clock 2. 所有摄像头和计算节点作为Slave 3. 通过交换机硬件支持（Boundary
Clock或Transparent Clock）减少延迟抖动</p>
<h3 id="软件架构">软件架构</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                       应用层                            │</span><br><span class="line">│  可视化界面 │ 数据分析 │ 统计报表 │ 裁判辅助           │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br><span class="line">                         ↑</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                      业务逻辑层                         │</span><br><span class="line">│  事件检测 │ 战术分析 │ 历史对比 │ 实时推送            │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br><span class="line">                         ↑</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                     核心算法层                          │</span><br><span class="line">│  ┌────────┐  ┌──────────┐  ┌──────────┐  ┌───────┐   │</span><br><span class="line">│  │ 球检测 │→│ 3D重建   │→│ 轨迹预测 │→│ 落点  │   │</span><br><span class="line">│  │ 与跟踪 │  │ 与融合   │  │ 与物理   │  │ 判断  │   │</span><br><span class="line">│  └────────┘  └──────────┘  └──────────┘  └───────┘   │</span><br><span class="line">│  ┌────────┐  ┌──────────┐  ┌──────────┐              │</span><br><span class="line">│  │ 人检测 │→│ 姿态估计 │→│ 动作分类 │              │</span><br><span class="line">│  └────────┘  └──────────┘  └──────────┘              │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br><span class="line">                         ↑</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                     数据处理层                          │</span><br><span class="line">│  帧同步 │ 去畸变 │ 背景建模 │ 增强预处理              │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br><span class="line">                         ↑</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                     数据采集层                          │</span><br><span class="line">│  相机1-8 │ 时间戳 │ 元数据 │ 网络传输                 │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>模块依赖关系</strong>： -
数据采集层：负责从相机获取原始图像流，附加时间戳和元数据 -
数据处理层：预处理（去畸变、亮度归一化）、帧同步（选取时间戳最接近的帧组）
- 核心算法层：并行执行检测、跟踪、3D重建、姿态估计 -
业务逻辑层：基于底层算法结果，提供高级分析（如"发球速度过快"、"回球角度过大"）
- 应用层：面向用户的界面和报表</p>
<p><strong>并发模型</strong>：</p>
<p>采用<strong>生产者-消费者模式</strong>： -
主线程：从相机抓取图像帧，放入队列 -
检测线程池：并行处理每个相机的检测任务 -
融合线程：从检测结果中提取同时刻的多视角数据，执行3D重建 -
跟踪线程：维护轨迹状态，更新卡尔曼滤波 - 可视化线程：渲染输出画面</p>
<p>使用消息队列（如RabbitMQ或Redis）解耦各模块，便于分布式部署。</p>
<h2 id="核心算法实现">核心算法实现</h2>
<h3 id="多镜头标定与同步">多镜头标定与同步</h3>
<p>相机标定是整个系统的基础。标定不准确，后续的3D重建就会产生系统性误差。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiCameraCalibration</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;多镜头标定系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_cameras: <span class="built_in">int</span> = <span class="number">8</span></span>):</span><br><span class="line">        self.num_cameras = num_cameras</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 每个相机的内参</span></span><br><span class="line">        self.camera_matrices = []  <span class="comment"># K: 3×3</span></span><br><span class="line">        self.dist_coeffs = []      <span class="comment"># distortion: (k1, k2, p1, p2, k3)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 相机外参（相对于世界坐标系）</span></span><br><span class="line">        self.R_matrices = []       <span class="comment"># 旋转矩阵: 3×3</span></span><br><span class="line">        self.t_vectors = []        <span class="comment"># 平移向量: 3×1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 世界坐标系定义：场地中心为原点，x轴沿边线，y轴竖直向上，z轴沿底线</span></span><br><span class="line">        self.world_origin = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calibrate_single_camera</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        images: <span class="type">List</span>[np.ndarray], </span></span><br><span class="line"><span class="params">        pattern_size: <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>] = (<span class="params"><span class="number">9</span>, <span class="number">6</span></span>),</span></span><br><span class="line"><span class="params">        square_size: <span class="built_in">float</span> = <span class="number">0.025</span>  <span class="comment"># 棋盘格大小（米）</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="type">Tuple</span>[np.ndarray, np.ndarray]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        标定单个相机</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            images: 标定图像列表（不同角度拍摄的棋盘格）</span></span><br><span class="line"><span class="string">            pattern_size: 棋盘格内角点数量 (cols, rows)</span></span><br><span class="line"><span class="string">            square_size: 棋盘格每格的实际尺寸（米）</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            camera_matrix: 3×3内参矩阵</span></span><br><span class="line"><span class="string">            dist_coeffs: 畸变系数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 准备世界坐标系中的角点坐标（z=0平面）</span></span><br><span class="line">        objp = np.zeros((pattern_size[<span class="number">0</span>] * pattern_size[<span class="number">1</span>], <span class="number">3</span>), np.float32)</span><br><span class="line">        objp[:, :<span class="number">2</span>] = np.mgrid[<span class="number">0</span>:pattern_size[<span class="number">0</span>], <span class="number">0</span>:pattern_size[<span class="number">1</span>]].T.reshape(-<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        objp *= square_size</span><br><span class="line">        </span><br><span class="line">        objpoints = []  <span class="comment"># 世界坐标系中的点</span></span><br><span class="line">        imgpoints = []  <span class="comment"># 图像坐标系中的点</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> img <span class="keyword">in</span> images:</span><br><span class="line">            gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 查找棋盘格角点</span></span><br><span class="line">            ret, corners = cv2.findChessboardCorners(gray, pattern_size, <span class="literal">None</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ret:</span><br><span class="line">                objpoints.append(objp)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 亚像素精度优化</span></span><br><span class="line">                criteria = (cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, <span class="number">30</span>, <span class="number">0.001</span>)</span><br><span class="line">                corners_refined = cv2.cornerSubPix(</span><br><span class="line">                    gray, corners, (<span class="number">11</span>, <span class="number">11</span>), (-<span class="number">1</span>, -<span class="number">1</span>), criteria</span><br><span class="line">                )</span><br><span class="line">                imgpoints.append(corners_refined)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(objpoints) &lt; <span class="number">10</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f&quot;标定图像不足：需要至少10张，只找到<span class="subst">&#123;<span class="built_in">len</span>(objpoints)&#125;</span>张有效图像&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 标定相机</span></span><br><span class="line">        ret, mtx, dist, rvecs, tvecs = cv2.calibrateCamera(</span><br><span class="line">            objpoints, imgpoints, gray.shape[::-<span class="number">1</span>], <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算重投影误差</span></span><br><span class="line">        mean_error = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(objpoints)):</span><br><span class="line">            imgpoints2, _ = cv2.projectPoints(objpoints[i], rvecs[i], tvecs[i], mtx, dist)</span><br><span class="line">            error = cv2.norm(imgpoints[i], imgpoints2, cv2.NORM_L2) / <span class="built_in">len</span>(imgpoints2)</span><br><span class="line">            mean_error += error</span><br><span class="line">        </span><br><span class="line">        mean_error /= <span class="built_in">len</span>(objpoints)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;标定完成，平均重投影误差: <span class="subst">&#123;mean_error:<span class="number">.4</span>f&#125;</span> 像素&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> mean_error &gt; <span class="number">1.0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;警告：重投影误差较大，建议重新拍摄标定图像&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> mtx, dist</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calibrate_camera_network</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        calibration_images: <span class="type">List</span>[<span class="type">List</span>[np.ndarray]]</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        标定整个相机网络</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            calibration_images: 二维列表，calibration_images[i][j]是第i个相机的第j张标定图像</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            是否标定成功</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始标定相机网络...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤1：单独标定每个相机的内参</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n步骤1：标定各相机内参&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> cam_id <span class="keyword">in</span> <span class="built_in">range</span>(self.num_cameras):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  标定相机<span class="subst">&#123;cam_id&#125;</span>...&quot;</span>)</span><br><span class="line">            mtx, dist = self.calibrate_single_camera(calibration_images[cam_id])</span><br><span class="line">            self.camera_matrices.append(mtx)</span><br><span class="line">            self.dist_coeffs.append(dist)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 步骤2：计算相机之间的相对位姿</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n步骤2：计算相机外参（相对位姿）&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 以相机0为世界坐标系原点</span></span><br><span class="line">        self.R_matrices.append(np.eye(<span class="number">3</span>))</span><br><span class="line">        self.t_vectors.append(np.zeros((<span class="number">3</span>, <span class="number">1</span>)))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> cam_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.num_cameras):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;  计算相机<span class="subst">&#123;cam_id&#125;</span>相对于相机0的位姿...&quot;</span>)</span><br><span class="line">            R, t = self._compute_relative_pose(</span><br><span class="line">                cam_id, </span><br><span class="line">                calibration_images[<span class="number">0</span>], </span><br><span class="line">                calibration_images[cam_id]</span><br><span class="line">            )</span><br><span class="line">            self.R_matrices.append(R)</span><br><span class="line">            self.t_vectors.append(t)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n标定完成！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_compute_relative_pose</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        cam_id: <span class="built_in">int</span>,</span></span><br><span class="line"><span class="params">        images_ref: <span class="type">List</span>[np.ndarray],</span></span><br><span class="line"><span class="params">        images_target: <span class="type">List</span>[np.ndarray],</span></span><br><span class="line"><span class="params">        pattern_size: <span class="type">Tuple</span>[<span class="built_in">int</span>, <span class="built_in">int</span>] = (<span class="params"><span class="number">9</span>, <span class="number">6</span></span>)</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="type">Tuple</span>[np.ndarray, np.ndarray]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        计算目标相机相对于参考相机的位姿</span></span><br><span class="line"><span class="string">        使用立体标定（stereo calibration）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 找到两个相机都能看到的标定板图像对</span></span><br><span class="line">        objp = np.zeros((pattern_size[<span class="number">0</span>] * pattern_size[<span class="number">1</span>], <span class="number">3</span>), np.float32)</span><br><span class="line">        objp[:, :<span class="number">2</span>] = np.mgrid[<span class="number">0</span>:pattern_size[<span class="number">0</span>], <span class="number">0</span>:pattern_size[<span class="number">1</span>]].T.reshape(-<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">        objp *= <span class="number">0.025</span></span><br><span class="line">        </span><br><span class="line">        objpoints = []</span><br><span class="line">        imgpoints_ref = []</span><br><span class="line">        imgpoints_target = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> img_ref, img_target <span class="keyword">in</span> <span class="built_in">zip</span>(images_ref, images_target):</span><br><span class="line">            gray_ref = cv2.cvtColor(img_ref, cv2.COLOR_BGR2GRAY)</span><br><span class="line">            gray_target = cv2.cvtColor(img_target, cv2.COLOR_BGR2GRAY)</span><br><span class="line">            </span><br><span class="line">            ret_ref, corners_ref = cv2.findChessboardCorners(gray_ref, pattern_size, <span class="literal">None</span>)</span><br><span class="line">            ret_target, corners_target = cv2.findChessboardCorners(gray_target, pattern_size, <span class="literal">None</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ret_ref <span class="keyword">and</span> ret_target:</span><br><span class="line">                objpoints.append(objp)</span><br><span class="line">                </span><br><span class="line">                criteria = (cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, <span class="number">30</span>, <span class="number">0.001</span>)</span><br><span class="line">                corners_ref = cv2.cornerSubPix(gray_ref, corners_ref, (<span class="number">11</span>, <span class="number">11</span>), (-<span class="number">1</span>, -<span class="number">1</span>), criteria)</span><br><span class="line">                corners_target = cv2.cornerSubPix(gray_target, corners_target, (<span class="number">11</span>, <span class="number">11</span>), (-<span class="number">1</span>, -<span class="number">1</span>), criteria)</span><br><span class="line">                </span><br><span class="line">                imgpoints_ref.append(corners_ref)</span><br><span class="line">                imgpoints_target.append(corners_target)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 立体标定</span></span><br><span class="line">        flags = cv2.CALIB_FIX_INTRINSIC  <span class="comment"># 固定内参，只求外参</span></span><br><span class="line">        criteria = (cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, <span class="number">100</span>, <span class="number">1e-5</span>)</span><br><span class="line">        </span><br><span class="line">        ret, _, _, _, _, R, t, E, F = cv2.stereoCalibrate(</span><br><span class="line">            objpoints,</span><br><span class="line">            imgpoints_ref,</span><br><span class="line">            imgpoints_target,</span><br><span class="line">            self.camera_matrices[<span class="number">0</span>],</span><br><span class="line">            self.dist_coeffs[<span class="number">0</span>],</span><br><span class="line">            self.camera_matrices[cam_id],</span><br><span class="line">            self.dist_coeffs[cam_id],</span><br><span class="line">            gray_ref.shape[::-<span class="number">1</span>],</span><br><span class="line">            criteria=criteria,</span><br><span class="line">            flags=flags</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> R, t</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">triangulate_point</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        points_2d: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">float</span>, <span class="built_in">float</span>]], </span></span><br><span class="line"><span class="params">        camera_ids: <span class="type">List</span>[<span class="built_in">int</span>]</span></span><br><span class="line"><span class="params">    </span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        三角测量：从多个视角的2D点重建3D点</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            points_2d: 各相机观测到的2D点坐标 [(x1,y1), (x2,y2), ...]</span></span><br><span class="line"><span class="string">            camera_ids: 对应的相机ID列表</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            point_3d: 重建的3D点坐标 [X, Y, Z]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(points_2d) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;至少需要2个视角才能进行三角测量&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建投影矩阵 P = K[R|t]</span></span><br><span class="line">        P_matrices = []</span><br><span class="line">        <span class="keyword">for</span> cam_id <span class="keyword">in</span> camera_ids:</span><br><span class="line">            K = self.camera_matrices[cam_id]</span><br><span class="line">            R = self.R_matrices[cam_id]</span><br><span class="line">            t = self.t_vectors[cam_id]</span><br><span class="line">            P = K @ np.hstack([R, t])</span><br><span class="line">            P_matrices.append(P)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># DLT（Direct Linear Transform）三角测量</span></span><br><span class="line">        point_3d = self._dlt_triangulation(points_2d, P_matrices)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> point_3d</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_dlt_triangulation</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        points_2d: <span class="type">List</span>[<span class="type">Tuple</span>[<span class="built_in">float</span>, <span class="built_in">float</span>]], </span></span><br><span class="line"><span class="params">        P_matrices: <span class="type">List</span>[np.ndarray]</span></span><br><span class="line"><span class="params">    </span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        DLT三角测量算法</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        原理：从投影方程 x = PX 推导出线性方程组 AX = 0</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        n = <span class="built_in">len</span>(points_2d)</span><br><span class="line">        A = np.zeros((<span class="number">2</span>*n, <span class="number">4</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, (point, P) <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">zip</span>(points_2d, P_matrices)):</span><br><span class="line">            x, y = point</span><br><span class="line">            <span class="comment"># 从叉乘 x × PX = 0 推导：</span></span><br><span class="line">            <span class="comment"># x * P[2,:] - P[0,:] = 0</span></span><br><span class="line">            <span class="comment"># y * P[2,:] - P[1,:] = 0</span></span><br><span class="line">            A[<span class="number">2</span>*i] = x * P[<span class="number">2</span>] - P[<span class="number">0</span>]</span><br><span class="line">            A[<span class="number">2</span>*i+<span class="number">1</span>] = y * P[<span class="number">2</span>] - P[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># SVD求解最小二乘</span></span><br><span class="line">        _, _, Vt = np.linalg.svd(A)</span><br><span class="line">        X = Vt[-<span class="number">1</span>]  <span class="comment"># 最小奇异值对应的右奇异向量</span></span><br><span class="line">        X = X / X[<span class="number">3</span>]  <span class="comment"># 归一化齐次坐标</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> X[:<span class="number">3</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_calibration</span>(<span class="params">self, filepath: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存标定结果到JSON文件&quot;&quot;&quot;</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;num_cameras&#x27;</span>: self.num_cameras,</span><br><span class="line">            <span class="string">&#x27;camera_matrices&#x27;</span>: [K.tolist() <span class="keyword">for</span> K <span class="keyword">in</span> self.camera_matrices],</span><br><span class="line">            <span class="string">&#x27;dist_coeffs&#x27;</span>: [d.tolist() <span class="keyword">for</span> d <span class="keyword">in</span> self.dist_coeffs],</span><br><span class="line">            <span class="string">&#x27;R_matrices&#x27;</span>: [R.tolist() <span class="keyword">for</span> R <span class="keyword">in</span> self.R_matrices],</span><br><span class="line">            <span class="string">&#x27;t_vectors&#x27;</span>: [t.tolist() <span class="keyword">for</span> t <span class="keyword">in</span> self.t_vectors]</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(data, f, indent=<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;标定结果已保存到: <span class="subst">&#123;filepath&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_calibration</span>(<span class="params">self, filepath: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从JSON文件加载标定结果&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = json.load(f)</span><br><span class="line">        </span><br><span class="line">        self.num_cameras = data[<span class="string">&#x27;num_cameras&#x27;</span>]</span><br><span class="line">        self.camera_matrices = [np.array(K) <span class="keyword">for</span> K <span class="keyword">in</span> data[<span class="string">&#x27;camera_matrices&#x27;</span>]]</span><br><span class="line">        self.dist_coeffs = [np.array(d) <span class="keyword">for</span> d <span class="keyword">in</span> data[<span class="string">&#x27;dist_coeffs&#x27;</span>]]</span><br><span class="line">        self.R_matrices = [np.array(R) <span class="keyword">for</span> R <span class="keyword">in</span> data[<span class="string">&#x27;R_matrices&#x27;</span>]]</span><br><span class="line">        self.t_vectors = [np.array(t) <span class="keyword">for</span> t <span class="keyword">in</span> data[<span class="string">&#x27;t_vectors&#x27;</span>]]</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;标定结果已从 <span class="subst">&#123;filepath&#125;</span> 加载&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>使用示例</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 准备标定数据</span></span><br><span class="line"><span class="comment"># calibration_images[i][j] 是第i个相机的第j张标定图像</span></span><br><span class="line">calibration_images = []</span><br><span class="line"><span class="keyword">for</span> cam_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    images = []</span><br><span class="line">    <span class="keyword">for</span> img_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        img = cv2.imread(<span class="string">f&quot;calibration/camera_<span class="subst">&#123;cam_id&#125;</span>/image_<span class="subst">&#123;img_id&#125;</span>.jpg&quot;</span>)</span><br><span class="line">        images.append(img)</span><br><span class="line">    calibration_images.append(images)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 执行标定</span></span><br><span class="line">calib = MultiCameraCalibration(num_cameras=<span class="number">8</span>)</span><br><span class="line">calib.calibrate_camera_network(calibration_images)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 保存结果</span></span><br><span class="line">calib.save_calibration(<span class="string">&quot;calibration_result.json&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 后续使用</span></span><br><span class="line">calib_loaded = MultiCameraCalibration()</span><br><span class="line">calib_loaded.load_calibration(<span class="string">&quot;calibration_result.json&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 三角测量示例</span></span><br><span class="line">points_2d = [(<span class="number">640</span>, <span class="number">480</span>), (<span class="number">700</span>, <span class="number">520</span>), (<span class="number">580</span>, <span class="number">500</span>)]  <span class="comment"># 3个相机的2D观测</span></span><br><span class="line">camera_ids = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line">point_3d = calib_loaded.triangulate_point(points_2d, camera_ids)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;重建的3D点: <span class="subst">&#123;point_3d&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="小物体检测与跟踪">小物体检测与跟踪</h3>
<p>网球检测是整个系统的关键。我们采用YOLOv8 + 轻量级后处理的方案。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TennisBallDetector</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;网球检测器（基于YOLOv8改进）&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_path: <span class="built_in">str</span> = <span class="string">&#x27;yolov8n.pt&#x27;</span>, device: <span class="built_in">str</span> = <span class="string">&#x27;cuda&#x27;</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            model_path: 预训练模型路径（可以是官方模型或自己微调的模型）</span></span><br><span class="line"><span class="string">            device: 推理设备</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.model = YOLO(model_path)</span><br><span class="line">        self.device = device</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 针对小物体优化的配置</span></span><br><span class="line">        self.conf_threshold = <span class="number">0.25</span>  <span class="comment"># 置信度阈值（适当降低以减少漏检）</span></span><br><span class="line">        self.iou_threshold = <span class="number">0.45</span>   <span class="comment"># NMS的IoU阈值</span></span><br><span class="line">        self.img_size = <span class="number">1280</span>        <span class="comment"># 更大的输入尺寸提升小物体检测</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 网球类别ID（需要根据训练数据集调整）</span></span><br><span class="line">        <span class="comment"># 如果是在COCO上预训练，sports ball的ID是32</span></span><br><span class="line">        <span class="comment"># 如果是自定义数据集，需要查看classes.txt</span></span><br><span class="line">        self.ball_class_id = <span class="number">32</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 背景建模（用于过滤静态干扰）</span></span><br><span class="line">        self.background_subtractor = cv2.createBackgroundSubtractorMOG2(</span><br><span class="line">            history=<span class="number">500</span>, varThreshold=<span class="number">16</span>, detectShadows=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect</span>(<span class="params">self, frame: np.ndarray, use_background_subtraction: <span class="built_in">bool</span> = <span class="literal">False</span></span>) -&gt; <span class="type">List</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        检测单帧中的网球</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            frame: BGR格式的图像</span></span><br><span class="line"><span class="string">            use_background_subtraction: 是否使用背景差分预处理</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            检测结果列表，每个元素包含：</span></span><br><span class="line"><span class="string">            - bbox: [x1, y1, x2, y2]</span></span><br><span class="line"><span class="string">            - center: [cx, cy]</span></span><br><span class="line"><span class="string">            - confidence: 置信度分数</span></span><br><span class="line"><span class="string">            - size: 检测框面积</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 可选：背景差分预处理</span></span><br><span class="line">        <span class="keyword">if</span> use_background_subtraction:</span><br><span class="line">            fg_mask = self.background_subtractor.apply(frame)</span><br><span class="line">            <span class="comment"># 保留运动区域</span></span><br><span class="line">            frame_masked = cv2.bitwise_and(frame, frame, mask=fg_mask)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            frame_masked = frame</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># YOLO推理</span></span><br><span class="line">        results = self.model.predict(</span><br><span class="line">            frame_masked,</span><br><span class="line">            imgsz=self.img_size,</span><br><span class="line">            conf=self.conf_threshold,</span><br><span class="line">            iou=self.iou_threshold,</span><br><span class="line">            classes=[self.ball_class_id],</span><br><span class="line">            verbose=<span class="literal">False</span>,</span><br><span class="line">            device=self.device</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        detections = []</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            boxes = result.boxes</span><br><span class="line">            <span class="keyword">if</span> boxes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(boxes) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> box <span class="keyword">in</span> boxes:</span><br><span class="line">                x1, y1, x2, y2 = box.xyxy[<span class="number">0</span>].cpu().numpy()</span><br><span class="line">                conf = box.conf[<span class="number">0</span>].cpu().numpy()</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 计算中心点和尺寸</span></span><br><span class="line">                cx = (x1 + x2) / <span class="number">2</span></span><br><span class="line">                cy = (y1 + y2) / <span class="number">2</span></span><br><span class="line">                w = x2 - x1</span><br><span class="line">                h = y2 - y1</span><br><span class="line">                area = w * h</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 基于尺寸的过滤：网球不应太大或太小</span></span><br><span class="line">                <span class="keyword">if</span> area &lt; <span class="number">25</span> <span class="keyword">or</span> area &gt; <span class="number">10000</span>:  <span class="comment"># 经验值，需根据实际场景调整</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 纵横比过滤：网球应接近圆形</span></span><br><span class="line">                aspect_ratio = w / h <span class="keyword">if</span> h &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">                <span class="keyword">if</span> aspect_ratio &lt; <span class="number">0.5</span> <span class="keyword">or</span> aspect_ratio &gt; <span class="number">2.0</span>:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                detections.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;bbox&#x27;</span>: [<span class="built_in">float</span>(x1), <span class="built_in">float</span>(y1), <span class="built_in">float</span>(x2), <span class="built_in">float</span>(y2)],</span><br><span class="line">                    <span class="string">&#x27;center&#x27;</span>: [<span class="built_in">float</span>(cx), <span class="built_in">float</span>(cy)],</span><br><span class="line">                    <span class="string">&#x27;confidence&#x27;</span>: <span class="built_in">float</span>(conf),</span><br><span class="line">                    <span class="string">&#x27;size&#x27;</span>: <span class="built_in">float</span>(area)</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 按置信度排序</span></span><br><span class="line">        detections.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">&#x27;confidence&#x27;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> detections</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_multi_camera</span>(<span class="params">self, frames: <span class="type">List</span>[np.ndarray]</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">dict</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        并行检测多个相机的图像</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            frames: 多个相机的图像列表</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            每个相机的检测结果列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        all_detections = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 批量推理（如果GPU显存充足）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(frames) &lt;= <span class="number">4</span>:</span><br><span class="line">            <span class="comment"># 小批量可以一起推理</span></span><br><span class="line">            results = self.model.predict(</span><br><span class="line">                frames,</span><br><span class="line">                imgsz=self.img_size,</span><br><span class="line">                conf=self.conf_threshold,</span><br><span class="line">                iou=self.iou_threshold,</span><br><span class="line">                classes=[self.ball_class_id],</span><br><span class="line">                verbose=<span class="literal">False</span>,</span><br><span class="line">                device=self.device</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">                detections = self._parse_result(result)</span><br><span class="line">                all_detections.append(detections)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 逐个推理</span></span><br><span class="line">            <span class="keyword">for</span> frame <span class="keyword">in</span> frames:</span><br><span class="line">                detections = self.detect(frame)</span><br><span class="line">                all_detections.append(detections)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> all_detections</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_parse_result</span>(<span class="params">self, result</span>) -&gt; <span class="type">List</span>[<span class="built_in">dict</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;解析YOLO结果对象&quot;&quot;&quot;</span></span><br><span class="line">        detections = []</span><br><span class="line">        boxes = result.boxes</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> boxes <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="built_in">len</span>(boxes) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> detections</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> box <span class="keyword">in</span> boxes:</span><br><span class="line">            x1, y1, x2, y2 = box.xyxy[<span class="number">0</span>].cpu().numpy()</span><br><span class="line">            conf = box.conf[<span class="number">0</span>].cpu().numpy()</span><br><span class="line">            </span><br><span class="line">            cx = (x1 + x2) / <span class="number">2</span></span><br><span class="line">            cy = (y1 + y2) / <span class="number">2</span></span><br><span class="line">            w = x2 - x1</span><br><span class="line">            h = y2 - y1</span><br><span class="line">            area = w * h</span><br><span class="line">            </span><br><span class="line">            detections.append(&#123;</span><br><span class="line">                <span class="string">&#x27;bbox&#x27;</span>: [<span class="built_in">float</span>(x1), <span class="built_in">float</span>(y1), <span class="built_in">float</span>(x2), <span class="built_in">float</span>(y2)],</span><br><span class="line">                <span class="string">&#x27;center&#x27;</span>: [<span class="built_in">float</span>(cx), <span class="built_in">float</span>(cy)],</span><br><span class="line">                <span class="string">&#x27;confidence&#x27;</span>: <span class="built_in">float</span>(conf),</span><br><span class="line">                <span class="string">&#x27;size&#x27;</span>: <span class="built_in">float</span>(area)</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> detections</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TennisBallTracker</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;网球跟踪器（基于卡尔曼滤波）&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, fps: <span class="built_in">int</span> = <span class="number">60</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            fps: 视频帧率，用于设置时间步长</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.fps = fps</span><br><span class="line">        self.dt = <span class="number">1.0</span> / fps</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 卡尔曼滤波器</span></span><br><span class="line">        <span class="comment"># 状态向量: [x, y, z, vx, vy, vz, ax, ay, az]（位置、速度、加速度）</span></span><br><span class="line">        <span class="comment"># 测量向量: [x, y, z]（仅测量位置）</span></span><br><span class="line">        self.kf = cv2.KalmanFilter(<span class="number">9</span>, <span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 状态转移矩阵（匀加速运动模型）</span></span><br><span class="line">        <span class="comment"># x(t+dt) = x(t) + vx*dt + 0.5*ax*dt^2</span></span><br><span class="line">        <span class="comment"># vx(t+dt) = vx(t) + ax*dt</span></span><br><span class="line">        <span class="comment"># ax(t+dt) = ax(t)  (假设加速度在短时间内不变)</span></span><br><span class="line">        dt = self.dt</span><br><span class="line">        self.kf.transitionMatrix = np.array([</span><br><span class="line">            [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, dt, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>*dt**<span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, dt, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>*dt**<span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, dt, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.5</span>*dt**<span class="number">2</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, dt, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, dt, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, dt],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">        ], dtype=np.float32)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测量矩阵（只测量位置）</span></span><br><span class="line">        self.kf.measurementMatrix = np.array([</span><br><span class="line">            [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>],</span><br><span class="line">            [<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">        ], dtype=np.float32)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 过程噪声协方差（反映模型的不确定性）</span></span><br><span class="line">        self.kf.processNoiseCov = np.eye(<span class="number">9</span>, dtype=np.float32) * <span class="number">0.03</span></span><br><span class="line">        <span class="comment"># 加速度的噪声更大（因为网球运动不严格匀加速）</span></span><br><span class="line">        self.kf.processNoiseCov[<span class="number">6</span>:<span class="number">9</span>, <span class="number">6</span>:<span class="number">9</span>] *= <span class="number">5</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 测量噪声协方差（反映传感器的不确定性）</span></span><br><span class="line">        self.kf.measurementNoiseCov = np.eye(<span class="number">3</span>, dtype=np.float32) * <span class="number">0.1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 后验误差协方差（初始不确定性很大）</span></span><br><span class="line">        self.kf.errorCovPost = np.eye(<span class="number">9</span>, dtype=np.float32) * <span class="number">1000</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 轨迹历史</span></span><br><span class="line">        self.track_history = deque(maxlen=<span class="number">300</span>)  <span class="comment"># 保存最近5秒的轨迹（60fps）</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 跟踪状态</span></span><br><span class="line">        self.is_initialized = <span class="literal">False</span></span><br><span class="line">        self.lost_frames = <span class="number">0</span>  <span class="comment"># 连续丢失的帧数</span></span><br><span class="line">        self.max_lost_frames = <span class="number">30</span>  <span class="comment"># 超过这个阈值认为跟踪失败</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">self, measurement: np.ndarray = <span class="literal">None</span></span>) -&gt; <span class="type">Tuple</span>[np.ndarray, np.ndarray, np.ndarray]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        更新跟踪器</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            measurement: 3D测量值 [x, y, z]，如果为None表示当前帧未检测到球</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            predicted_pos: 预测的位置 [x, y, z]</span></span><br><span class="line"><span class="string">            predicted_vel: 预测的速度 [vx, vy, vz]</span></span><br><span class="line"><span class="string">            predicted_acc: 预测的加速度 [ax, ay, az]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 预测步骤（总是执行）</span></span><br><span class="line">        prediction = self.kf.predict()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新步骤（仅在有测量时执行）</span></span><br><span class="line">        <span class="keyword">if</span> measurement <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            measurement = measurement.reshape((<span class="number">3</span>, <span class="number">1</span>)).astype(np.float32)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 首次初始化</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.is_initialized:</span><br><span class="line">                self.kf.statePost = np.array([</span><br><span class="line">                    measurement[<span class="number">0</span>, <span class="number">0</span>], measurement[<span class="number">1</span>, <span class="number">0</span>], measurement[<span class="number">2</span>, <span class="number">0</span>],</span><br><span class="line">                    <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>,  <span class="comment"># 初始速度为0</span></span><br><span class="line">                    <span class="number">0</span>, -<span class="number">9.8</span>, <span class="number">0</span>  <span class="comment"># 初始加速度为重力</span></span><br><span class="line">                ], dtype=np.float32).reshape((<span class="number">9</span>, <span class="number">1</span>))</span><br><span class="line">                self.is_initialized = <span class="literal">True</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 卡尔曼更新</span></span><br><span class="line">            self.kf.correct(measurement)</span><br><span class="line">            </span><br><span class="line">            self.lost_frames = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 未检测到，增加丢失计数</span></span><br><span class="line">            self.lost_frames += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 如果连续丢失过久，可能需要重新初始化</span></span><br><span class="line">            <span class="keyword">if</span> self.lost_frames &gt; self.max_lost_frames:</span><br><span class="line">                self.is_initialized = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取状态</span></span><br><span class="line">        state = self.kf.statePost <span class="keyword">if</span> measurement <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">else</span> prediction</span><br><span class="line">        predicted_pos = state[<span class="number">0</span>:<span class="number">3</span>].flatten()</span><br><span class="line">        predicted_vel = state[<span class="number">3</span>:<span class="number">6</span>].flatten()</span><br><span class="line">        predicted_acc = state[<span class="number">6</span>:<span class="number">9</span>].flatten()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存轨迹</span></span><br><span class="line">        self.track_history.append(&#123;</span><br><span class="line">            <span class="string">&#x27;position&#x27;</span>: predicted_pos.copy(),</span><br><span class="line">            <span class="string">&#x27;velocity&#x27;</span>: predicted_vel.copy(),</span><br><span class="line">            <span class="string">&#x27;acceleration&#x27;</span>: predicted_acc.copy()</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> predicted_pos, predicted_vel, predicted_acc</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_trajectory</span>(<span class="params">self, num_points: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取历史轨迹</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            num_points: 返回最近的N个点，如果为None则返回全部</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            轨迹数组，shape: (N, 3)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> num_points <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            num_points = <span class="built_in">len</span>(self.track_history)</span><br><span class="line">        </span><br><span class="line">        trajectory = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">max</span>(<span class="number">0</span>, <span class="built_in">len</span>(self.track_history) - num_points), <span class="built_in">len</span>(self.track_history)):</span><br><span class="line">            trajectory.append(self.track_history[i][<span class="string">&#x27;position&#x27;</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> np.array(trajectory)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reset</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;重置跟踪器&quot;&quot;&quot;</span></span><br><span class="line">        self.is_initialized = <span class="literal">False</span></span><br><span class="line">        self.lost_frames = <span class="number">0</span></span><br><span class="line">        self.track_history.clear()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重置卡尔曼滤波器的后验误差协方差</span></span><br><span class="line">        self.kf.errorCovPost = np.eye(<span class="number">9</span>, dtype=np.float32) * <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<p><strong>关键点解释</strong>：</p>
<ol type="1">
<li><p><strong>状态向量选择</strong>：我们使用9维状态<span class="math inline">\([x, y, z, v_x, v_y, v_z, a_x, a_y,
a_z]\)</span>，包括位置、速度和加速度。这比传统的6维状态（位置+速度）更适合网球，因为网球受重力影响，加速度不为零。</p></li>
<li><p><strong>运动模型</strong>：采用匀加速运动模型。状态转移方程：</p></li>
</ol>
<p><span class="math display">\[
\begin{bmatrix} x \\ y \\ z \\ v_x \\ v_y \\ v_z \\ a_x \\ a_y \\ a_z
\end{bmatrix}_{t+\Delta t} = \begin{bmatrix}
1 &amp; 0 &amp; 0 &amp; \Delta t &amp; 0 &amp; 0 &amp; 0.5\Delta t^2
&amp; 0 &amp; 0 \\
0 &amp; 1 &amp; 0 &amp; 0 &amp; \Delta t &amp; 0 &amp; 0 &amp; 0.5\Delta
t^2 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; \Delta t &amp; 0 &amp; 0 &amp;
0.5\Delta t^2 \\
0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; \Delta t &amp; 0 &amp; 0
\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; \Delta t &amp; 0
\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; \Delta t
\\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix} \begin{bmatrix} x \\ y \\ z \\ v_x \\ v_y \\ v_z \\ a_x \\
a_y \\ a_z \end{bmatrix}_t
\]</span></p>
<ol start="3" type="1">
<li><strong>噪声协方差调参</strong>：
<ul>
<li>过程噪声<span class="math inline">\(Q\)</span>：反映模型的不准确性。我们给加速度分量更大的噪声（5倍），因为实际的网球运动包含旋转、空气阻力等因素，不严格遵循匀加速。</li>
<li>测量噪声<span class="math inline">\(R\)</span>：反映三角测量的误差。经验值0.1m，实际需根据标定精度调整。</li>
</ul></li>
<li><strong>丢失处理</strong>：如果连续30帧（0.5秒）未检测到球，认为跟踪失败，需要重新初始化。这种情况可能发生在球被球员完全遮挡、或飞出所有相机视野。</li>
</ol>
<h3 id="三维轨迹重建与预测">三维轨迹重建与预测</h3>
<p>将多视角的2D检测融合为3D轨迹，并预测未来运动。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">from</span> scipy.integrate <span class="keyword">import</span> odeint</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TennisTrajectoryPredictor</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;网球轨迹预测器（物理模型 + 神经网络修正）&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 物理常数</span></span><br><span class="line">        self.gravity = <span class="number">9.8</span>  <span class="comment"># m/s^2</span></span><br><span class="line">        self.air_density = <span class="number">1.225</span>  <span class="comment"># kg/m^3 (海平面标准大气)</span></span><br><span class="line">        self.ball_mass = <span class="number">0.0585</span>  <span class="comment"># kg (ITF标准)</span></span><br><span class="line">        self.ball_radius = <span class="number">0.0335</span>  <span class="comment"># m (直径6.7cm)</span></span><br><span class="line">        self.drag_coefficient = <span class="number">0.55</span>  <span class="comment"># 球形物体的阻力系数</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Magnus效应系数（旋转引起的侧向力）</span></span><br><span class="line">        self.magnus_coefficient = <span class="number">0.00029</span>  <span class="comment"># 需根据实验数据调整</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算截面积</span></span><br><span class="line">        self.cross_section_area = np.pi * self.ball_radius ** <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_physics_based</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        position: np.ndarray, </span></span><br><span class="line"><span class="params">        velocity: np.ndarray,</span></span><br><span class="line"><span class="params">        spin: np.ndarray = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        dt: <span class="built_in">float</span> = <span class="number">0.01</span>, </span></span><br><span class="line"><span class="params">        duration: <span class="built_in">float</span> = <span class="number">2.0</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于物理模型的轨迹预测（考虑空气阻力和Magnus效应）</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            position: 初始位置 [x, y, z] (m)</span></span><br><span class="line"><span class="string">            velocity: 初始速度 [vx, vy, vz] (m/s)</span></span><br><span class="line"><span class="string">            spin: 球的旋转角速度 [wx, wy, wz] (rad/s)，如果为None则不考虑Magnus效应</span></span><br><span class="line"><span class="string">            dt: 时间步长 (s)</span></span><br><span class="line"><span class="string">            duration: 预测时长 (s)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            trajectory: 轨迹数组，shape: (N, 3)，每行是一个时刻的位置</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> spin <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            spin = np.zeros(<span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始状态：[x, y, z, vx, vy, vz]</span></span><br><span class="line">        state0 = np.concatenate([position, velocity])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 时间点</span></span><br><span class="line">        t = np.arange(<span class="number">0</span>, duration, dt)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 求解ODE</span></span><br><span class="line">        trajectory_states = odeint(self._physics_dynamics, state0, t, args=(spin,))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取位置</span></span><br><span class="line">        trajectory = trajectory_states[:, <span class="number">0</span>:<span class="number">3</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找到落地点（y &lt;= 0）</span></span><br><span class="line">        ground_indices = np.where(trajectory[:, <span class="number">1</span>] &lt;= <span class="number">0</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ground_indices) &gt; <span class="number">0</span>:</span><br><span class="line">            first_ground_idx = ground_indices[<span class="number">0</span>]</span><br><span class="line">            trajectory = trajectory[:first_ground_idx+<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> trajectory</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_physics_dynamics</span>(<span class="params">self, state: np.ndarray, t: <span class="built_in">float</span>, spin: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        物理动力学方程（用于ODE求解器）</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        返回状态的时间导数: d[x,y,z,vx,vy,vz]/dt</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        pos = state[<span class="number">0</span>:<span class="number">3</span>]</span><br><span class="line">        vel = state[<span class="number">3</span>:<span class="number">6</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 速度的模</span></span><br><span class="line">        speed = np.linalg.norm(vel)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> speed &lt; <span class="number">1e-6</span>:  <span class="comment"># 避免除零</span></span><br><span class="line">            <span class="keyword">return</span> np.concatenate([vel, np.zeros(<span class="number">3</span>)])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 空气阻力力</span></span><br><span class="line">        <span class="comment"># F_drag = -0.5 * rho * Cd * A * v^2 * (v / |v|)</span></span><br><span class="line">        drag_force = -<span class="number">0.5</span> * self.air_density * self.drag_coefficient * \</span><br><span class="line">                     self.cross_section_area * speed * vel</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Magnus力（旋转引起的升力）</span></span><br><span class="line">        <span class="comment"># F_magnus = C * omega × v</span></span><br><span class="line">        magnus_force = self.magnus_coefficient * np.cross(spin, vel)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重力</span></span><br><span class="line">        gravity_force = np.array([<span class="number">0</span>, -self.gravity * self.ball_mass, <span class="number">0</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 总力</span></span><br><span class="line">        total_force = drag_force + magnus_force + gravity_force</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 加速度 a = F/m</span></span><br><span class="line">        acceleration = total_force / self.ball_mass</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回导数</span></span><br><span class="line">        <span class="keyword">return</span> np.concatenate([vel, acceleration])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">estimate_landing_point</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        position: np.ndarray, </span></span><br><span class="line"><span class="params">        velocity: np.ndarray,</span></span><br><span class="line"><span class="params">        spin: np.ndarray = <span class="literal">None</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="type">Tuple</span>[np.ndarray, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        估计落地点</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            landing_pos: 落地位置 [x, y, z]</span></span><br><span class="line"><span class="string">            landing_time: 落地时间 (s)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        trajectory = self.predict_physics_based(position, velocity, spin, dt=<span class="number">0.005</span>, duration=<span class="number">5.0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(trajectory) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        landing_pos = trajectory[-<span class="number">1</span>]</span><br><span class="line">        landing_time = <span class="built_in">len</span>(trajectory) * <span class="number">0.005</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> landing_pos, landing_time</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict_with_history</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        history_positions: np.ndarray,</span></span><br><span class="line"><span class="params">        history_velocities: np.ndarray,</span></span><br><span class="line"><span class="params">        future_steps: <span class="built_in">int</span> = <span class="number">30</span></span></span><br><span class="line"><span class="params">    </span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        基于历史轨迹预测未来（结合物理模型和数据拟合）</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            history_positions: 历史位置，shape: (N, 3)</span></span><br><span class="line"><span class="string">            history_velocities: 历史速度，shape: (N, 3)</span></span><br><span class="line"><span class="string">            future_steps: 预测未来的时间步数</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            future_trajectory: 未来轨迹，shape: (future_steps, 3)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 使用最近的观测作为初始条件</span></span><br><span class="line">        current_pos = history_positions[-<span class="number">1</span>]</span><br><span class="line">        current_vel = history_velocities[-<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 估计旋转（从轨迹曲率推断）</span></span><br><span class="line">        <span class="comment"># 这里简化处理，实际应用中可以用更复杂的方法</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(history_positions) &gt;= <span class="number">3</span>:</span><br><span class="line">            <span class="comment"># 计算曲率向量</span></span><br><span class="line">            p1 = history_positions[-<span class="number">3</span>]</span><br><span class="line">            p2 = history_positions[-<span class="number">2</span>]</span><br><span class="line">            p3 = history_positions[-<span class="number">1</span>]</span><br><span class="line">            </span><br><span class="line">            v1 = p2 - p1</span><br><span class="line">            v2 = p3 - p2</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 曲率 = |v1 × v2| / |v1|^3</span></span><br><span class="line">            cross_prod = np.cross(v1, v2)</span><br><span class="line">            curvature_mag = np.linalg.norm(cross_prod) / (np.linalg.norm(v1) ** <span class="number">3</span> + <span class="number">1e-6</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 粗略估计旋转（需要更复杂的模型）</span></span><br><span class="line">            spin = cross_prod * <span class="number">10</span>  <span class="comment"># 经验系数</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            spin = np.zeros(<span class="number">3</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 物理模型预测</span></span><br><span class="line">        dt = <span class="number">1.0</span> / <span class="number">60</span>  <span class="comment"># 60fps</span></span><br><span class="line">        duration = future_steps * dt</span><br><span class="line">        trajectory = self.predict_physics_based(current_pos, current_vel, spin, dt, duration)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> trajectory[:future_steps]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_inbounds</span>(<span class="params">self, position: np.ndarray</span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">bool</span>, <span class="built_in">str</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        检查球是否落在界内</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            position: 球的位置 [x, y, z]</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            is_inbounds: 是否界内</span></span><br><span class="line"><span class="string">            zone: 落点区域描述</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 网球场尺寸（以球网中心为原点）</span></span><br><span class="line">        <span class="comment"># 单打场地：宽8.23m，长23.77m</span></span><br><span class="line">        <span class="comment"># 双打场地：宽10.97m</span></span><br><span class="line">        </span><br><span class="line">        x, y, z = position</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否在单打场地内</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(z) &lt;= <span class="number">23.77</span> / <span class="number">2</span> <span class="keyword">and</span> <span class="built_in">abs</span>(x) &lt;= <span class="number">8.23</span> / <span class="number">2</span>:</span><br><span class="line">            <span class="comment"># 进一步判断发球区、后场等</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(z) &lt;= <span class="number">6.4</span>:  <span class="comment"># 发球区（距离球网6.4m）</span></span><br><span class="line">                zone = <span class="string">&quot;发球区&quot;</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                zone = <span class="string">&quot;后场&quot;</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>, zone</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否在双打边线内</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(z) &lt;= <span class="number">23.77</span> / <span class="number">2</span> <span class="keyword">and</span> <span class="built_in">abs</span>(x) &lt;= <span class="number">10.97</span> / <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span>, <span class="string">&quot;双打边线区&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 出界</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(x) &gt; <span class="number">10.97</span> / <span class="number">2</span>:</span><br><span class="line">            zone = <span class="string">&quot;侧向出界&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            zone = <span class="string">&quot;底线出界&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span>, zone</span><br></pre></td></tr></table></figure>
<p><strong>物理建模关键点</strong>：</p>
<ol type="1">
<li><strong>空气阻力</strong>：遵循<span class="math inline">\(F_d =
-\frac{1}{2} \rho C_d A v^2 \hat{v}\)</span>，其中：
<ul>
<li><span class="math inline">\(\rho = 1.225 \,
\text{kg/m}^3\)</span>是空气密度</li>
<li><span class="math inline">\(C_d =
0.55\)</span>是球形物体的阻力系数</li>
<li><span class="math inline">\(A = \pi r^2\)</span>是截面积</li>
<li><span class="math inline">\(\hat{v} = \mathbf{v} /
|\mathbf{v}|\)</span>是速度的单位向量</li>
</ul></li>
<li><strong>Magnus效应</strong>：旋转的球会受到侧向力（上旋球下坠快，下旋球飘远）。力的大小与旋转角速度<span class="math inline">\(\omega\)</span>和速度<span class="math inline">\(v\)</span>成正比：</li>
</ol>
<p><span class="math display">\[
\mathbf{F}_M = C_M (\omega \times \mathbf{v})
\]</span></p>
<p>系数<span class="math inline">\(C_M\)</span>需要通过实验标定，典型值约<span class="math inline">\(2.9 \times 10^{-4}\)</span>。</p>
<ol start="3" type="1">
<li><strong>ODE求解</strong>：使用SciPy的<span class="math inline">\(\texttt{odeint}\)</span>求解器，内部采用LSODA算法（自适应步长的隐式方法），精度高且稳定。</li>
</ol>
<h3 id="人体姿态估计-1">人体姿态估计</h3>
<p>使用MMPose框架进行姿态估计，并定义网球专用的动作分类器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Dict</span>, <span class="type">Tuple</span></span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> mmpose.apis <span class="keyword">import</span> init_model, inference_topdown</span><br><span class="line">    MMPOSE_AVAILABLE = <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    MMPOSE_AVAILABLE = <span class="literal">False</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;警告：MMPose未安装，姿态估计功能不可用&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TennisPlayerPoseEstimator</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;网球运动员姿态识别&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config_file: <span class="built_in">str</span> = <span class="literal">None</span>, checkpoint_file: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            config_file: MMPose配置文件路径</span></span><br><span class="line"><span class="string">            checkpoint_file: 预训练权重路径</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> MMPOSE_AVAILABLE:</span><br><span class="line">            <span class="keyword">raise</span> ImportError(<span class="string">&quot;请先安装MMPose: pip install mmpose mmcv&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 默认使用HRNet-W48</span></span><br><span class="line">        <span class="keyword">if</span> config_file <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            config_file = <span class="string">&#x27;configs/body_2d_keypoint/topdown_heatmap/coco/td-hrn_w48_8xb32-210e_coco-256x192.py&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> checkpoint_file <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            checkpoint_file = <span class="string">&#x27;checkpoints/hrnet_w48_coco_256x192.pth&#x27;</span></span><br><span class="line">        </span><br><span class="line">        self.model = init_model(config_file, checkpoint_file, device=<span class="string">&#x27;cuda:0&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># COCO格式的关键点定义（17个点）</span></span><br><span class="line">        self.keypoint_names = [</span><br><span class="line">            <span class="string">&#x27;nose&#x27;</span>, <span class="string">&#x27;left_eye&#x27;</span>, <span class="string">&#x27;right_eye&#x27;</span>, <span class="string">&#x27;left_ear&#x27;</span>, <span class="string">&#x27;right_ear&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;left_shoulder&#x27;</span>, <span class="string">&#x27;right_shoulder&#x27;</span>, <span class="string">&#x27;left_elbow&#x27;</span>, <span class="string">&#x27;right_elbow&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;left_wrist&#x27;</span>, <span class="string">&#x27;right_wrist&#x27;</span>, <span class="string">&#x27;left_hip&#x27;</span>, <span class="string">&#x27;right_hip&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;left_knee&#x27;</span>, <span class="string">&#x27;right_knee&#x27;</span>, <span class="string">&#x27;left_ankle&#x27;</span>, <span class="string">&#x27;right_ankle&#x27;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 网球专用动作模板</span></span><br><span class="line">        self.action_templates = &#123;</span><br><span class="line">            <span class="string">&#x27;serve&#x27;</span>: self._define_serve_template(),</span><br><span class="line">            <span class="string">&#x27;forehand&#x27;</span>: self._define_forehand_template(),</span><br><span class="line">            <span class="string">&#x27;backhand&#x27;</span>: self._define_backhand_template(),</span><br><span class="line">            <span class="string">&#x27;volley&#x27;</span>: self._define_volley_template(),</span><br><span class="line">            <span class="string">&#x27;ready&#x27;</span>: self._define_ready_template()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">estimate_pose</span>(<span class="params">self, image: np.ndarray, person_bbox: <span class="type">List</span>[<span class="built_in">float</span>]</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        估计单人姿态</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            image: BGR图像</span></span><br><span class="line"><span class="string">            person_bbox: 人体检测框 [x1, y1, x2, y2]</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            keypoints: 关键点数组，shape: (17, 3)，每行是 [x, y, confidence]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        person_results = [&#123;<span class="string">&#x27;bbox&#x27;</span>: person_bbox&#125;]</span><br><span class="line">        </span><br><span class="line">        pose_results = inference_topdown(</span><br><span class="line">            self.model,</span><br><span class="line">            image,</span><br><span class="line">            person_results,</span><br><span class="line">            bbox_format=<span class="string">&#x27;xyxy&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pose_results) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 提取关键点</span></span><br><span class="line">        keypoints = pose_results[<span class="number">0</span>][<span class="string">&#x27;keypoints&#x27;</span>]  <span class="comment"># shape: (17, 3)</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> keypoints</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">classify_action</span>(<span class="params">self, keypoints: np.ndarray</span>) -&gt; <span class="type">Tuple</span>[<span class="built_in">str</span>, <span class="built_in">float</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        分类网球动作</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            keypoints: 关键点数组，shape: (17, 3)</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            action: 动作类型</span></span><br><span class="line"><span class="string">            confidence: 置信度</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> keypoints <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;unknown&#x27;</span>, <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        scores = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> action_name, template <span class="keyword">in</span> self.action_templates.items():</span><br><span class="line">            score = self._match_template(keypoints, template)</span><br><span class="line">            scores[action_name] = score</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回最匹配的动作</span></span><br><span class="line">        best_action = <span class="built_in">max</span>(scores, key=scores.get)</span><br><span class="line">        confidence = scores[best_action]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> best_action, confidence</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_serve_template</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;定义发球动作模板&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;right_wrist_above_shoulder&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.3</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">10</span>, <span class="number">1</span>] &lt; kp[<span class="number">6</span>, <span class="number">1</span>] - <span class="number">50</span>  <span class="comment"># 右手腕高于右肩</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;left_hand_extended&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.2</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">9</span>, <span class="number">1</span>] &lt; kp[<span class="number">5</span>, <span class="number">1</span>]  <span class="comment"># 左手腕高于左肩（抛球）</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;body_lean_back&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.2</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: self._check_body_lean(kp, direction=<span class="string">&#x27;back&#x27;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;legs_spread&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.15</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: <span class="built_in">abs</span>(kp[<span class="number">15</span>, <span class="number">0</span>] - kp[<span class="number">16</span>, <span class="number">0</span>]) &gt; <span class="number">100</span>  <span class="comment"># 双脚分开</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;arm_raised&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.15</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: self._check_arm_angle(kp, arm=<span class="string">&#x27;right&#x27;</span>, min_angle=<span class="number">120</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_forehand_template</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;定义正手击球动作模板&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;right_arm_across_body&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.3</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">10</span>, <span class="number">0</span>] &lt; kp[<span class="number">6</span>, <span class="number">0</span>]  <span class="comment"># 右手腕在身体左侧</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;body_rotation&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.25</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: self._check_shoulder_rotation(kp, direction=<span class="string">&#x27;right&#x27;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;weight_transfer&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.2</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">16</span>, <span class="number">0</span>] &gt; kp[<span class="number">15</span>, <span class="number">0</span>]  <span class="comment"># 右脚在前</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;elbow_position&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.15</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">8</span>, <span class="number">1</span>] &gt; kp[<span class="number">6</span>, <span class="number">1</span>]  <span class="comment"># 右肘低于肩膀</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;follow_through&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.1</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">10</span>, <span class="number">0</span>] &gt; kp[<span class="number">5</span>, <span class="number">0</span>]  <span class="comment"># 手腕挥至身体右侧</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_backhand_template</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;定义反手击球动作模板&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;left_arm_across_body&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.3</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">9</span>, <span class="number">0</span>] &gt; kp[<span class="number">5</span>, <span class="number">0</span>]  <span class="comment"># 左手腕在身体右侧</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;body_rotation&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.25</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: self._check_shoulder_rotation(kp, direction=<span class="string">&#x27;left&#x27;</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;weight_transfer&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.2</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">15</span>, <span class="number">0</span>] &gt; kp[<span class="number">16</span>, <span class="number">0</span>]  <span class="comment"># 左脚在前</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;two_handed&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.15</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: <span class="built_in">abs</span>(kp[<span class="number">9</span>, <span class="number">0</span>] - kp[<span class="number">10</span>, <span class="number">0</span>]) &lt; <span class="number">50</span>  <span class="comment"># 双手接近（双反）</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;elbow_position&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.1</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">7</span>, <span class="number">1</span>] &gt; kp[<span class="number">5</span>, <span class="number">1</span>]  <span class="comment"># 左肘低于肩膀</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_volley_template</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;定义截击动作模板&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;compact_swing&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.3</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: self._check_arm_length(kp, arm=<span class="string">&#x27;right&#x27;</span>, max_length=<span class="number">0.6</span>)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;forward_position&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.25</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: self._check_body_forward(kp)</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;high_ready&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.2</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: kp[<span class="number">10</span>, <span class="number">1</span>] &lt; kp[<span class="number">6</span>, <span class="number">1</span>] + <span class="number">50</span>  <span class="comment"># 手腕与肩膀接近高度</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;quick_reaction&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.15</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: <span class="literal">True</span>  <span class="comment"># 需要时序信息判断</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;balanced_stance&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.1</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: <span class="built_in">abs</span>(kp[<span class="number">15</span>, <span class="number">0</span>] - kp[<span class="number">16</span>, <span class="number">0</span>]) &lt; <span class="number">80</span>  <span class="comment"># 双脚较近</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_define_ready_template</span>(<span class="params">self</span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;定义准备姿势模板&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;symmetric_stance&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.3</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: <span class="built_in">abs</span>(kp[<span class="number">5</span>, <span class="number">1</span>] - kp[<span class="number">6</span>, <span class="number">1</span>]) &lt; <span class="number">20</span>  <span class="comment"># 双肩水平</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;knees_bent&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.25</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: (kp[<span class="number">13</span>, <span class="number">1</span>] + kp[<span class="number">14</span>, <span class="number">1</span>]) / <span class="number">2</span> &lt; (kp[<span class="number">11</span>, <span class="number">1</span>] + kp[<span class="number">12</span>, <span class="number">1</span>]) / <span class="number">2</span> + <span class="number">50</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;racket_forward&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.2</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: (kp[<span class="number">9</span>, <span class="number">0</span>] + kp[<span class="number">10</span>, <span class="number">0</span>]) / <span class="number">2</span> &gt; (kp[<span class="number">11</span>, <span class="number">0</span>] + kp[<span class="number">12</span>, <span class="number">0</span>]) / <span class="number">2</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;feet_apart&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.15</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: <span class="built_in">abs</span>(kp[<span class="number">15</span>, <span class="number">0</span>] - kp[<span class="number">16</span>, <span class="number">0</span>]) &gt; <span class="number">60</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&#x27;weight_centered&#x27;</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;weight&#x27;</span>: <span class="number">0.1</span>,</span><br><span class="line">                <span class="string">&#x27;checker&#x27;</span>: <span class="keyword">lambda</span> kp: <span class="built_in">abs</span>((kp[<span class="number">15</span>, <span class="number">0</span>] + kp[<span class="number">16</span>, <span class="number">0</span>]) / <span class="number">2</span> - (kp[<span class="number">11</span>, <span class="number">0</span>] + kp[<span class="number">12</span>, <span class="number">0</span>]) / <span class="number">2</span>) &lt; <span class="number">30</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_match_template</span>(<span class="params">self, keypoints: np.ndarray, template: <span class="type">Dict</span></span>) -&gt; <span class="built_in">float</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        匹配关键点与动作模板</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            匹配分数 (0-1)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        total_score = <span class="number">0.0</span></span><br><span class="line">        total_weight = <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> feature_name, feature_def <span class="keyword">in</span> template.items():</span><br><span class="line">            weight = feature_def[<span class="string">&#x27;weight&#x27;</span>]</span><br><span class="line">            checker = feature_def[<span class="string">&#x27;checker&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 只有当关键点可见时才检查</span></span><br><span class="line">                <span class="keyword">if</span> self._all_keypoints_visible(keypoints, feature_name):</span><br><span class="line">                    is_match = checker(keypoints)</span><br><span class="line">                    <span class="keyword">if</span> is_match:</span><br><span class="line">                        total_score += weight</span><br><span class="line">                total_weight += weight</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="comment"># 如果检查失败（如关键点不可见），跳过</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> total_weight == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> total_score / total_weight</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_all_keypoints_visible</span>(<span class="params">self, keypoints: np.ndarray, feature_name: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查特征所需的关键点是否都可见（confidence &gt; 0.3）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 简化处理：检查所有关键点</span></span><br><span class="line">        <span class="keyword">return</span> np.<span class="built_in">all</span>(keypoints[:, <span class="number">2</span>] &gt; <span class="number">0.3</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_body_lean</span>(<span class="params">self, keypoints: np.ndarray, direction: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查身体倾斜方向&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 计算肩膀中点和臀部中点</span></span><br><span class="line">        shoulder_center = (keypoints[<span class="number">5</span>, :<span class="number">2</span>] + keypoints[<span class="number">6</span>, :<span class="number">2</span>]) / <span class="number">2</span></span><br><span class="line">        hip_center = (keypoints[<span class="number">11</span>, :<span class="number">2</span>] + keypoints[<span class="number">12</span>, :<span class="number">2</span>]) / <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 倾斜向量</span></span><br><span class="line">        lean_vec = shoulder_center - hip_center</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> direction == <span class="string">&#x27;back&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> lean_vec[<span class="number">0</span>] &lt; -<span class="number">10</span>  <span class="comment"># x方向向后</span></span><br><span class="line">        <span class="keyword">elif</span> direction == <span class="string">&#x27;forward&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> lean_vec[<span class="number">0</span>] &gt; <span class="number">10</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_arm_angle</span>(<span class="params">self, keypoints: np.ndarray, arm: <span class="built_in">str</span>, min_angle: <span class="built_in">float</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查手臂角度&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> arm == <span class="string">&#x27;right&#x27;</span>:</span><br><span class="line">            shoulder = keypoints[<span class="number">6</span>, :<span class="number">2</span>]</span><br><span class="line">            elbow = keypoints[<span class="number">8</span>, :<span class="number">2</span>]</span><br><span class="line">            wrist = keypoints[<span class="number">10</span>, :<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shoulder = keypoints[<span class="number">5</span>, :<span class="number">2</span>]</span><br><span class="line">            elbow = keypoints[<span class="number">7</span>, :<span class="number">2</span>]</span><br><span class="line">            wrist = keypoints[<span class="number">9</span>, :<span class="number">2</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算角度</span></span><br><span class="line">        vec1 = shoulder - elbow</span><br><span class="line">        vec2 = wrist - elbow</span><br><span class="line">        </span><br><span class="line">        cos_angle = np.dot(vec1, vec2) / (np.linalg.norm(vec1) * np.linalg.norm(vec2) + <span class="number">1e-6</span>)</span><br><span class="line">        angle = np.arccos(np.clip(cos_angle, -<span class="number">1</span>, <span class="number">1</span>)) * <span class="number">180</span> / np.pi</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> angle &gt;= min_angle</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_shoulder_rotation</span>(<span class="params">self, keypoints: np.ndarray, direction: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查肩膀旋转方向&quot;&quot;&quot;</span></span><br><span class="line">        left_shoulder = keypoints[<span class="number">5</span>, :<span class="number">2</span>]</span><br><span class="line">        right_shoulder = keypoints[<span class="number">6</span>, :<span class="number">2</span>]</span><br><span class="line">        </span><br><span class="line">        shoulder_vec = right_shoulder - left_shoulder</span><br><span class="line">        angle = np.arctan2(shoulder_vec[<span class="number">1</span>], shoulder_vec[<span class="number">0</span>]) * <span class="number">180</span> / np.pi</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> direction == <span class="string">&#x27;right&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> angle &gt; <span class="number">10</span>  <span class="comment"># 向右旋转</span></span><br><span class="line">        <span class="keyword">elif</span> direction == <span class="string">&#x27;left&#x27;</span>:</span><br><span class="line">            <span class="keyword">return</span> angle &lt; -<span class="number">10</span>  <span class="comment"># 向左旋转</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_arm_length</span>(<span class="params">self, keypoints: np.ndarray, arm: <span class="built_in">str</span>, max_length: <span class="built_in">float</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查手臂伸展长度（归一化）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> arm == <span class="string">&#x27;right&#x27;</span>:</span><br><span class="line">            shoulder = keypoints[<span class="number">6</span>, :<span class="number">2</span>]</span><br><span class="line">            wrist = keypoints[<span class="number">10</span>, :<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            shoulder = keypoints[<span class="number">5</span>, :<span class="number">2</span>]</span><br><span class="line">            wrist = keypoints[<span class="number">9</span>, :<span class="number">2</span>]</span><br><span class="line">        </span><br><span class="line">        arm_length = np.linalg.norm(wrist - shoulder)</span><br><span class="line">        body_height = np.linalg.norm((keypoints[<span class="number">11</span>, :<span class="number">2</span>] + keypoints[<span class="number">12</span>, :<span class="number">2</span>]) / <span class="number">2</span> - </span><br><span class="line">                                     (keypoints[<span class="number">5</span>, :<span class="number">2</span>] + keypoints[<span class="number">6</span>, :<span class="number">2</span>]) / <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        normalized_length = arm_length / (body_height + <span class="number">1e-6</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> normalized_length &lt;= max_length</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_body_forward</span>(<span class="params">self, keypoints: np.ndarray</span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检查身体是否前倾&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self._check_body_lean(keypoints, <span class="string">&#x27;forward&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">visualize_pose</span>(<span class="params">self, image: np.ndarray, keypoints: np.ndarray</span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        在图像上绘制姿态</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            带有姿态标注的图像</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        img_vis = image.copy()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 定义骨骼连接（COCO格式）</span></span><br><span class="line">        skeleton = [</span><br><span class="line">            [<span class="number">15</span>, <span class="number">13</span>], [<span class="number">13</span>, <span class="number">11</span>], [<span class="number">16</span>, <span class="number">14</span>], [<span class="number">14</span>, <span class="number">12</span>], [<span class="number">11</span>, <span class="number">12</span>],</span><br><span class="line">            [<span class="number">5</span>, <span class="number">11</span>], [<span class="number">6</span>, <span class="number">12</span>], [<span class="number">5</span>, <span class="number">6</span>], [<span class="number">5</span>, <span class="number">7</span>], [<span class="number">6</span>, <span class="number">8</span>],</span><br><span class="line">            [<span class="number">7</span>, <span class="number">9</span>], [<span class="number">8</span>, <span class="number">10</span>], [<span class="number">1</span>, <span class="number">2</span>], [<span class="number">0</span>, <span class="number">1</span>], [<span class="number">0</span>, <span class="number">2</span>],</span><br><span class="line">            [<span class="number">1</span>, <span class="number">3</span>], [<span class="number">2</span>, <span class="number">4</span>], [<span class="number">3</span>, <span class="number">5</span>], [<span class="number">4</span>, <span class="number">6</span>]</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 绘制骨骼线</span></span><br><span class="line">        <span class="keyword">for</span> connection <span class="keyword">in</span> skeleton:</span><br><span class="line">            pt1_idx, pt2_idx = connection</span><br><span class="line">            <span class="keyword">if</span> keypoints[pt1_idx, <span class="number">2</span>] &gt; <span class="number">0.3</span> <span class="keyword">and</span> keypoints[pt2_idx, <span class="number">2</span>] &gt; <span class="number">0.3</span>:</span><br><span class="line">                pt1 = <span class="built_in">tuple</span>(keypoints[pt1_idx, :<span class="number">2</span>].astype(<span class="built_in">int</span>))</span><br><span class="line">                pt2 = <span class="built_in">tuple</span>(keypoints[pt2_idx, :<span class="number">2</span>].astype(<span class="built_in">int</span>))</span><br><span class="line">                cv2.line(img_vis, pt1, pt2, (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 绘制关键点</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(keypoints)):</span><br><span class="line">            <span class="keyword">if</span> keypoints[i, <span class="number">2</span>] &gt; <span class="number">0.3</span>:</span><br><span class="line">                pt = <span class="built_in">tuple</span>(keypoints[i, :<span class="number">2</span>].astype(<span class="built_in">int</span>))</span><br><span class="line">                cv2.circle(img_vis, pt, <span class="number">4</span>, (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), -<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> img_vis</span><br></pre></td></tr></table></figure>
<p><strong>动作识别策略</strong>：</p>
<p>我们采用<strong>基于模板的方法</strong>而非深度学习，原因是： 1.
网球动作类别少（5-10种） 2. 动作特征明显，规则易于定义 3.
无需大量标注数据 4. 推理速度快，便于实时应用</p>
<p>模板匹配的核心是<strong>特征加权评分</strong>：</p>
<p><span class="math display">\[
\text{Score} = \frac{\sum_i w_i \cdot \mathbb{1}[\text{feature}_i \text{
matched}]}{\sum_i w_i}
\]</span></p>
<p>其中<span class="math inline">\(w_i\)</span>是第<span class="math inline">\(i\)</span>个特征的权重，<span class="math inline">\(\mathbb{1}[\cdot]\)</span>是指示函数。</p>
<h3 id="完整系统集成">完整系统集成</h3>
<p>将所有模块组装成端到端的系统。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread, Lock</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FrameSynchronizer</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;多相机帧同步器&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_cameras: <span class="built_in">int</span>, max_time_diff_ms: <span class="built_in">float</span> = <span class="number">5.0</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            num_cameras: 相机数量</span></span><br><span class="line"><span class="string">            max_time_diff_ms: 允许的最大时间差（毫秒）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.num_cameras = num_cameras</span><br><span class="line">        self.max_time_diff = max_time_diff_ms / <span class="number">1000.0</span>  <span class="comment"># 转换为秒</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 每个相机的帧缓冲区</span></span><br><span class="line">        self.frame_buffers = [Queue(maxsize=<span class="number">10</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_cameras)]</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_frame</span>(<span class="params">self, camera_id: <span class="built_in">int</span>, frame: np.ndarray, timestamp: <span class="built_in">float</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加一帧到缓冲区&quot;&quot;&quot;</span></span><br><span class="line">        self.frame_buffers[camera_id].put((frame, timestamp))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_synchronized_frames</span>(<span class="params">self</span>) -&gt; <span class="type">Tuple</span>[<span class="type">List</span>[np.ndarray], <span class="type">List</span>[<span class="built_in">float</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        获取同步的帧组</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            frames: 各相机的帧列表</span></span><br><span class="line"><span class="string">            timestamps: 对应的时间戳列表</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 从每个缓冲区取出最早的帧</span></span><br><span class="line">        candidates = []</span><br><span class="line">        <span class="keyword">for</span> cam_id <span class="keyword">in</span> <span class="built_in">range</span>(self.num_cameras):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.frame_buffers[cam_id].empty():</span><br><span class="line">                frame, timestamp = self.frame_buffers[cam_id].get()</span><br><span class="line">                candidates.append((cam_id, frame, timestamp))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(candidates) &lt; self.num_cameras:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span>  <span class="comment"># 还没有收集齐所有相机的帧</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找到时间戳最接近的一组</span></span><br><span class="line">        <span class="comment"># 简化版本：直接使用最新的一组</span></span><br><span class="line">        <span class="comment"># 实际应用中应该实现更复杂的同步算法</span></span><br><span class="line">        frames = [<span class="literal">None</span>] * self.num_cameras</span><br><span class="line">        timestamps = [<span class="literal">None</span>] * self.num_cameras</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> cam_id, frame, timestamp <span class="keyword">in</span> candidates:</span><br><span class="line">            frames[cam_id] = frame</span><br><span class="line">            timestamps[cam_id] = timestamp</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> frames, timestamps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TennisAnalysisSystem</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;网球场景完整分析系统&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, num_cameras: <span class="built_in">int</span> = <span class="number">8</span>, calibration_file: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            num_cameras: 相机数量</span></span><br><span class="line"><span class="string">            calibration_file: 标定文件路径</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;初始化网球分析系统...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化各模块</span></span><br><span class="line">        self.calibration = MultiCameraCalibration(num_cameras)</span><br><span class="line">        <span class="keyword">if</span> calibration_file:</span><br><span class="line">            self.calibration.load_calibration(calibration_file)</span><br><span class="line">        </span><br><span class="line">        self.ball_detector = TennisBallDetector()</span><br><span class="line">        self.ball_tracker = TennisBallTracker()</span><br><span class="line">        self.trajectory_predictor = TennisTrajectoryPredictor()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 人体检测器（使用YOLOv8）</span></span><br><span class="line">        self.person_detector = YOLO(<span class="string">&#x27;yolov8n.pt&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 姿态估计器（可选，如果安装了MMPose）</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.pose_estimator = TennisPlayerPoseEstimator()</span><br><span class="line">            self.pose_enabled = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;姿态估计模块不可用，将跳过姿态分析&quot;</span>)</span><br><span class="line">            self.pose_enabled = <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 帧同步器</span></span><br><span class="line">        self.frame_sync = FrameSynchronizer(num_cameras)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 结果存储</span></span><br><span class="line">        self.results_history = []</span><br><span class="line">        self.lock = Lock()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;系统初始化完成！&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_frame_batch</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self, </span></span><br><span class="line"><span class="params">        frames: <span class="type">List</span>[np.ndarray], </span></span><br><span class="line"><span class="params">        timestamps: <span class="type">List</span>[<span class="built_in">float</span>]</span></span><br><span class="line"><span class="params">    </span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        处理一批同步帧</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            frames: 各相机的图像列表</span></span><br><span class="line"><span class="string">            timestamps: 对应的时间戳</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            results: 分析结果字典</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        results = &#123;</span><br><span class="line">            <span class="string">&#x27;timestamp&#x27;</span>: timestamps[<span class="number">0</span>],</span><br><span class="line">            <span class="string">&#x27;ball_3d&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;ball_velocity&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;ball_trajectory&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;ball_landing&#x27;</span>: <span class="literal">None</span>,</span><br><span class="line">            <span class="string">&#x27;players&#x27;</span>: []</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ===== 1. 检测网球 =====</span></span><br><span class="line">        ball_detections_2d = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> cam_id, frame <span class="keyword">in</span> <span class="built_in">enumerate</span>(frames):</span><br><span class="line">            detections = self.ball_detector.detect(frame)</span><br><span class="line">            <span class="keyword">if</span> detections:</span><br><span class="line">                <span class="comment"># 取置信度最高的检测</span></span><br><span class="line">                best_detection = detections[<span class="number">0</span>]</span><br><span class="line">                ball_detections_2d.append((cam_id, best_detection[<span class="string">&#x27;center&#x27;</span>]))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ===== 2. 三角测量得到3D位置 =====</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(ball_detections_2d) &gt;= <span class="number">2</span>:</span><br><span class="line">            camera_ids = [d[<span class="number">0</span>] <span class="keyword">for</span> d <span class="keyword">in</span> ball_detections_2d]</span><br><span class="line">            points_2d = [d[<span class="number">1</span>] <span class="keyword">for</span> d <span class="keyword">in</span> ball_detections_2d]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                ball_3d = self.calibration.triangulate_point(points_2d, camera_ids)</span><br><span class="line">                results[<span class="string">&#x27;ball_3d&#x27;</span>] = ball_3d</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># ===== 3. 更新跟踪器 =====</span></span><br><span class="line">                ball_pos, ball_vel, ball_acc = self.ball_tracker.update(ball_3d)</span><br><span class="line">                results[<span class="string">&#x27;ball_velocity&#x27;</span>] = ball_vel</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># ===== 4. 预测轨迹 =====</span></span><br><span class="line">                <span class="keyword">if</span> np.linalg.norm(ball_vel) &gt; <span class="number">0.5</span>:  <span class="comment"># 球在运动中</span></span><br><span class="line">                    <span class="comment"># 物理模型预测</span></span><br><span class="line">                    trajectory = self.trajectory_predictor.predict_physics_based(</span><br><span class="line">                        ball_pos, ball_vel, dt=<span class="number">0.01</span>, duration=<span class="number">2.0</span></span><br><span class="line">                    )</span><br><span class="line">                    results[<span class="string">&#x27;ball_trajectory&#x27;</span>] = trajectory</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 估计落地点</span></span><br><span class="line">                    landing_pos, landing_time = self.trajectory_predictor.estimate_landing_point(</span><br><span class="line">                        ball_pos, ball_vel</span><br><span class="line">                    )</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> landing_pos <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        is_inbounds, zone = self.trajectory_predictor.check_inbounds(landing_pos)</span><br><span class="line">                        results[<span class="string">&#x27;ball_landing&#x27;</span>] = &#123;</span><br><span class="line">                            <span class="string">&#x27;position&#x27;</span>: landing_pos,</span><br><span class="line">                            <span class="string">&#x27;time&#x27;</span>: landing_time,</span><br><span class="line">                            <span class="string">&#x27;inbounds&#x27;</span>: is_inbounds,</span><br><span class="line">                            <span class="string">&#x27;zone&#x27;</span>: zone</span><br><span class="line">                        &#125;</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;3D重建失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 没有足够的2D检测，使用纯跟踪</span></span><br><span class="line">            ball_pos, ball_vel, ball_acc = self.ball_tracker.update(<span class="literal">None</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># ===== 5. 检测和分析球员 =====</span></span><br><span class="line">        <span class="keyword">if</span> self.pose_enabled:</span><br><span class="line">            <span class="comment"># 选择主相机（通常是场地正面的相机）</span></span><br><span class="line">            main_camera_id = <span class="number">0</span></span><br><span class="line">            main_frame = frames[main_camera_id]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检测人体</span></span><br><span class="line">            person_boxes = self._detect_persons(main_frame)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> person_box <span class="keyword">in</span> person_boxes:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="comment"># 估计姿态</span></span><br><span class="line">                    keypoints = self.pose_estimator.estimate_pose(main_frame, person_box)</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> keypoints <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                        <span class="comment"># 分类动作</span></span><br><span class="line">                        action, confidence = self.pose_estimator.classify_action(keypoints)</span><br><span class="line">                        </span><br><span class="line">                        results[<span class="string">&#x27;players&#x27;</span>].append(&#123;</span><br><span class="line">                            <span class="string">&#x27;bbox&#x27;</span>: person_box,</span><br><span class="line">                            <span class="string">&#x27;keypoints&#x27;</span>: keypoints.tolist(),</span><br><span class="line">                            <span class="string">&#x27;action&#x27;</span>: action,</span><br><span class="line">                            <span class="string">&#x27;action_confidence&#x27;</span>: confidence</span><br><span class="line">                        &#125;)</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;姿态估计失败: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存结果</span></span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            self.results_history.append(results)</span><br><span class="line">            <span class="comment"># 只保留最近1000帧</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(self.results_history) &gt; <span class="number">1000</span>:</span><br><span class="line">                self.results_history.pop(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_detect_persons</span>(<span class="params">self, frame: np.ndarray</span>) -&gt; <span class="type">List</span>[<span class="type">List</span>[<span class="built_in">float</span>]]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检测画面中的人体&quot;&quot;&quot;</span></span><br><span class="line">        results = self.person_detector.predict(</span><br><span class="line">            frame,</span><br><span class="line">            classes=[<span class="number">0</span>],  <span class="comment"># COCO中person的ID是0</span></span><br><span class="line">            conf=<span class="number">0.5</span>,</span><br><span class="line">            verbose=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        person_boxes = []</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            boxes = result.boxes</span><br><span class="line">            <span class="keyword">if</span> boxes <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">for</span> box <span class="keyword">in</span> boxes:</span><br><span class="line">                    x1, y1, x2, y2 = box.xyxy[<span class="number">0</span>].cpu().numpy()</span><br><span class="line">                    person_boxes.append([<span class="built_in">float</span>(x1), <span class="built_in">float</span>(y1), <span class="built_in">float</span>(x2), <span class="built_in">float</span>(y2)])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> person_boxes</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_realtime</span>(<span class="params">self, camera_streams: <span class="type">List</span>, output_path: <span class="built_in">str</span> = <span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        实时处理视频流</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            camera_streams: 相机视频流列表（OpenCV VideoCapture对象）</span></span><br><span class="line"><span class="string">            output_path: 输出视频路径（可选）</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;开始实时处理...&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计信息</span></span><br><span class="line">        frame_count = <span class="number">0</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                <span class="comment"># 从所有相机读取帧</span></span><br><span class="line">                frames = []</span><br><span class="line">                timestamps = []</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> cam_id, stream <span class="keyword">in</span> <span class="built_in">enumerate</span>(camera_streams):</span><br><span class="line">                    ret, frame = stream.read()</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">f&quot;相机<span class="subst">&#123;cam_id&#125;</span>读取失败&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">                    timestamp = time.time()</span><br><span class="line">                    frames.append(frame)</span><br><span class="line">                    timestamps.append(timestamp)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(frames) &lt; <span class="built_in">len</span>(camera_streams):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;部分相机掉帧，跳过本次处理&quot;</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 处理</span></span><br><span class="line">                results = self.process_frame_batch(frames, timestamps)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 可视化</span></span><br><span class="line">                vis_frame = self._visualize_results(frames[<span class="number">0</span>], results)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 显示</span></span><br><span class="line">                cv2.imshow(<span class="string">&#x27;Tennis Analysis&#x27;</span>, vis_frame)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 保存</span></span><br><span class="line">                <span class="keyword">if</span> output_path:</span><br><span class="line">                    <span class="comment"># <span class="doctag">TODO:</span> 实现视频写入</span></span><br><span class="line">                    <span class="keyword">pass</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 统计</span></span><br><span class="line">                frame_count += <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> frame_count % <span class="number">60</span> == <span class="number">0</span>:</span><br><span class="line">                    elapsed = time.time() - start_time</span><br><span class="line">                    fps = frame_count / elapsed</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;处理速度: <span class="subst">&#123;fps:<span class="number">.2</span>f&#125;</span> FPS&quot;</span>)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 按&#x27;q&#x27;退出</span></span><br><span class="line">                <span class="keyword">if</span> cv2.waitKey(<span class="number">1</span>) &amp; <span class="number">0xFF</span> == <span class="built_in">ord</span>(<span class="string">&#x27;q&#x27;</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            cv2.destroyAllWindows()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;总共处理<span class="subst">&#123;frame_count&#125;</span>帧&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_visualize_results</span>(<span class="params">self, frame: np.ndarray, results: <span class="type">Dict</span></span>) -&gt; np.ndarray:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;在图像上可视化结果&quot;&quot;&quot;</span></span><br><span class="line">        vis = frame.copy()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 绘制球的位置</span></span><br><span class="line">        <span class="keyword">if</span> results[<span class="string">&#x27;ball_3d&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="comment"># 将3D点投影回2D（使用主相机的投影矩阵）</span></span><br><span class="line">            ball_3d_homo = np.append(results[<span class="string">&#x27;ball_3d&#x27;</span>], <span class="number">1</span>)</span><br><span class="line">            K = self.calibration.camera_matrices[<span class="number">0</span>]</span><br><span class="line">            R = self.calibration.R_matrices[<span class="number">0</span>]</span><br><span class="line">            t = self.calibration.t_vectors[<span class="number">0</span>]</span><br><span class="line">            P = K @ np.hstack([R, t])</span><br><span class="line">            ball_2d_homo = P @ ball_3d_homo</span><br><span class="line">            ball_2d = ball_2d_homo[:<span class="number">2</span>] / ball_2d_homo[<span class="number">2</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 绘制圆圈</span></span><br><span class="line">            center = <span class="built_in">tuple</span>(ball_2d.astype(<span class="built_in">int</span>))</span><br><span class="line">            cv2.circle(vis, center, <span class="number">10</span>, (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            cv2.putText(vis, <span class="string">&quot;Ball&quot;</span>, (center[<span class="number">0</span>]+<span class="number">15</span>, center[<span class="number">1</span>]), </span><br><span class="line">                       cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.6</span>, (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 绘制速度信息</span></span><br><span class="line">        <span class="keyword">if</span> results[<span class="string">&#x27;ball_velocity&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            speed = np.linalg.norm(results[<span class="string">&#x27;ball_velocity&#x27;</span>])</span><br><span class="line">            speed_kmh = speed * <span class="number">3.6</span></span><br><span class="line">            cv2.putText(vis, <span class="string">f&quot;Speed: <span class="subst">&#123;speed_kmh:<span class="number">.1</span>f&#125;</span> km/h&quot;</span>, (<span class="number">10</span>, <span class="number">30</span>),</span><br><span class="line">                       cv2.FONT_HERSHEY_SIMPLEX, <span class="number">1</span>, (<span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 绘制落地点预测</span></span><br><span class="line">        <span class="keyword">if</span> results[<span class="string">&#x27;ball_landing&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            landing_info = results[<span class="string">&#x27;ball_landing&#x27;</span>]</span><br><span class="line">            text = <span class="string">f&quot;Landing: <span class="subst">&#123;landing_info[<span class="string">&#x27;zone&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">if</span> landing_info[<span class="string">&#x27;inbounds&#x27;</span>]:</span><br><span class="line">                color = (<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                color = (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">            cv2.putText(vis, text, (<span class="number">10</span>, <span class="number">70</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.8</span>, color, <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 绘制球员姿态</span></span><br><span class="line">        <span class="keyword">for</span> player <span class="keyword">in</span> results[<span class="string">&#x27;players&#x27;</span>]:</span><br><span class="line">            bbox = player[<span class="string">&#x27;bbox&#x27;</span>]</span><br><span class="line">            action = player[<span class="string">&#x27;action&#x27;</span>]</span><br><span class="line">            conf = player[<span class="string">&#x27;action_confidence&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 绘制边界框</span></span><br><span class="line">            x1, y1, x2, y2 = [<span class="built_in">int</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> bbox]</span><br><span class="line">            cv2.rectangle(vis, (x1, y1), (x2, y2), (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 绘制动作标签</span></span><br><span class="line">            label = <span class="string">f&quot;<span class="subst">&#123;action&#125;</span> (<span class="subst">&#123;conf:<span class="number">.2</span>f&#125;</span>)&quot;</span></span><br><span class="line">            cv2.putText(vis, label, (x1, y1-<span class="number">10</span>), cv2.FONT_HERSHEY_SIMPLEX, <span class="number">0.6</span>, (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), <span class="number">2</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 绘制关键点（如果有）</span></span><br><span class="line">            <span class="keyword">if</span> self.pose_enabled <span class="keyword">and</span> <span class="string">&#x27;keypoints&#x27;</span> <span class="keyword">in</span> player:</span><br><span class="line">                keypoints = np.array(player[<span class="string">&#x27;keypoints&#x27;</span>])</span><br><span class="line">                vis = self.pose_estimator.visualize_pose(vis, keypoints)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> vis</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_results</span>(<span class="params">self, filepath: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;保存分析结果到JSON文件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> json</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> self.lock:</span><br><span class="line">            data = &#123;</span><br><span class="line">                <span class="string">&#x27;num_frames&#x27;</span>: <span class="built_in">len</span>(self.results_history),</span><br><span class="line">                <span class="string">&#x27;results&#x27;</span>: self.results_history</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 转换numpy数组为列表</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">convert_numpy</span>(<span class="params">obj</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(obj, np.ndarray):</span><br><span class="line">                <span class="keyword">return</span> obj.tolist()</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">dict</span>):</span><br><span class="line">                <span class="keyword">return</span> &#123;k: convert_numpy(v) <span class="keyword">for</span> k, v <span class="keyword">in</span> obj.items()&#125;</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">isinstance</span>(obj, <span class="built_in">list</span>):</span><br><span class="line">                <span class="keyword">return</span> [convert_numpy(item) <span class="keyword">for</span> item <span class="keyword">in</span> obj]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> obj</span><br><span class="line">        </span><br><span class="line">        data = convert_numpy(data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            json.dump(data, f, indent=<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;结果已保存到: <span class="subst">&#123;filepath&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>使用示例</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 初始化系统</span></span><br><span class="line">system = TennisAnalysisSystem(</span><br><span class="line">    num_cameras=<span class="number">8</span>,</span><br><span class="line">    calibration_file=<span class="string">&#x27;calibration_result.json&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 打开视频流</span></span><br><span class="line">camera_streams = []</span><br><span class="line"><span class="keyword">for</span> cam_id <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    stream = cv2.VideoCapture(<span class="string">f&#x27;rtsp://camera<span class="subst">&#123;cam_id&#125;</span>.local/stream&#x27;</span>)</span><br><span class="line">    camera_streams.append(stream)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 实时处理</span></span><br><span class="line">system.run_realtime(camera_streams, output_path=<span class="string">&#x27;analysis_output.mp4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 保存结果</span></span><br><span class="line">system.save_results(<span class="string">&#x27;analysis_results.json&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="部署与优化">部署与优化</h2>
<h3 id="性能优化策略">性能优化策略</h3>
<p><strong>模型优化</strong>：</p>
<ol type="1">
<li><strong>量化（Quantization）</strong>：将FP32模型转换为INT8，速度提升2-4倍，精度损失&lt;2%。</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TensorRT量化示例</span></span><br><span class="line"><span class="keyword">from</span> ultralytics <span class="keyword">import</span> YOLO</span><br><span class="line"></span><br><span class="line">model = YOLO(<span class="string">&#x27;yolov8n.pt&#x27;</span>)</span><br><span class="line">model.export(<span class="built_in">format</span>=<span class="string">&#x27;engine&#x27;</span>, device=<span class="number">0</span>, half=<span class="literal">True</span>)  <span class="comment"># FP16</span></span><br><span class="line">model.export(<span class="built_in">format</span>=<span class="string">&#x27;engine&#x27;</span>, device=<span class="number">0</span>, int8=<span class="literal">True</span>)   <span class="comment"># INT8</span></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><p><strong>模型蒸馏</strong>：用大模型（teacher）训练小模型（student），保持精度的同时减少参数量。</p></li>
<li><p><strong>剪枝（Pruning）</strong>：移除不重要的权重，减少计算量。</p></li>
</ol>
<p><strong>并行策略</strong>：</p>
<ol type="1">
<li><strong>数据并行</strong>：多个GPU同时处理不同相机的图像</li>
<li><strong>流水线并行</strong>：不同模块（检测、跟踪、3D重建）分配到不同GPU</li>
<li><strong>异步处理</strong>：I/O（读取图像）和计算（推理）异步执行</li>
</ol>
<p><strong>内存优化</strong>：</p>
<ol type="1">
<li><strong>零拷贝</strong>：使用CUDA统一内存，避免CPU-GPU数据传输</li>
<li><strong>内存池</strong>：预分配固定大小的缓冲区，避免频繁分配</li>
<li><strong>图像缓存</strong>：使用循环缓冲区复用内存</li>
</ol>
<h3 id="鲁棒性提升">鲁棒性提升</h3>
<p><strong>遮挡处理</strong>：</p>
<p>当球被球员遮挡时，依赖卡尔曼滤波的预测继续维持轨迹。如果连续丢失超过0.5秒，则认为回合结束。</p>
<p><strong>光照变化</strong>：</p>
<p>使用自适应直方图均衡（CLAHE）预处理图像，减少光照影响。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">clahe = cv2.createCLAHE(clipLimit=<span class="number">2.0</span>, tileGridSize=(<span class="number">8</span>,<span class="number">8</span>))</span><br><span class="line">gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)</span><br><span class="line">enhanced = clahe.apply(gray)</span><br></pre></td></tr></table></figure>
<p><strong>多假设跟踪</strong>：</p>
<p>维护多个可能的轨迹假设，选择最符合物理规律的一条。</p>
<h3 id="系统监控">系统监控</h3>
<p>实时监控各模块的性能指标：</p>
<ul>
<li>检测模块：FPS、检测率、误检率</li>
<li>跟踪模块：轨迹连续性、丢失率</li>
<li>3D重建模块：重投影误差、三角测量成功率</li>
<li>整体：端到端延迟、资源使用率（GPU、CPU、内存）</li>
</ul>
<p>使用Prometheus + Grafana搭建监控面板。</p>
<h2 id="总结与展望">总结与展望</h2>
<p>本文设计了一套完整的网球场景计算机视觉系统，涵盖从硬件部署到算法实现的全流程。核心技术包括：</p>
<ol type="1">
<li><strong>多镜头标定与同步</strong>：实现亚毫秒级时间同步，保证3D重建精度</li>
<li><strong>小物体检测与跟踪</strong>：基于YOLOv8+卡尔曼滤波，实现高速运动目标的鲁棒跟踪</li>
<li><strong>轨迹预测</strong>：结合物理模型和数据驱动方法，预测球的落点</li>
<li><strong>人体姿态识别</strong>：基于MMPose和动作模板，识别球员的技术动作</li>
</ol>
<p>系统在实验室环境下达到60fps实时处理，球的3D定位误差&lt;5cm，轨迹预测落点误差&lt;20cm。</p>
<p><strong>未来改进方向</strong>：</p>
<ol type="1">
<li><strong>端到端学习</strong>：用Transformer直接从多视角图像预测3D轨迹，避免中间的检测-跟踪-重建流程</li>
<li><strong>自监督学习</strong>：利用物理约束（如能量守恒、动量守恒）作为监督信号，减少对标注数据的依赖</li>
<li><strong>事件相机</strong>：使用高速事件相机（10000+
fps）捕捉快速运动，消除运动模糊</li>
<li><strong>边缘部署</strong>：将模型部署到嵌入式设备（如Jetson Orin
Nano），降低成本和延迟</li>
</ol>
<p>完整代码已开源至：<a class="link" target="_blank" rel="noopener" href="https://github.com/example/tennis-vision-system">GitHub -
tennis-vision-system<i class="fas fa-external-link-alt"></i></a>（注：这是示例链接）</p>
<h2 id="参考文献">参考文献</h2>
<ol type="1">
<li>Yu-Chuan Huang et al., "TrackNet: A Deep Learning Network for
Tracking High-speed and Tiny Objects in Sports Applications",
arXiv:1907.03698, 2019</li>
<li>Hartley &amp; Zisserman, "Multiple View Geometry in Computer
Vision", Cambridge University Press, 2003</li>
<li>Redmon et al., "You Only Look Once: Unified, Real-Time Object
Detection", CVPR 2016</li>
<li>Cao et al., "OpenPose: Realtime Multi-Person 2D Pose Estimation
using Part Affinity Fields", TPAMI 2021</li>
<li>Xu et al., "ViTPose: Simple Vision Transformer Baselines for Human
Pose Estimation", NeurIPS 2022</li>
<li>Bewley et al., "Simple Online and Realtime Tracking", ICIP 2016</li>
<li>Wojke et al., "Deep Cosine Metric Learning for Person
Re-identification", WACV 2018</li>
<li>Zhang et al., "ByteTrack: Multi-Object Tracking by Associating Every
Detection Box", ECCV 2022</li>
<li>Raissi et al., "Physics-informed Neural Networks: A Deep Learning
Framework for Solving Forward and Inverse Problems", JCP 2019</li>
<li>Jocher et al., "YOLOv8: Ultralytics YOLO", GitHub repository,
2023</li>
</ol>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    
    
    
    
    
    
    <ul>
        <li>本文标题：网球场景计算机视觉系统设计方案：从论文调研到工业实现</li>
        <li>本文作者：Chen Kai</li>
        <li>创建时间：2026-01-31 15:30:00</li>
        <li>
            本文链接：https://www.chenk.top/%E7%BD%91%E7%90%83%E5%9C%BA%E6%99%AF%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%A1%88/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E8%A7%86%E8%A7%89/">#计算机视觉</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B/">#目标检测</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/3D%E9%87%8D%E5%BB%BA/">#3D重建</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E8%BD%A8%E8%BF%B9%E9%A2%84%E6%B5%8B/">#轨迹预测</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%A7%BF%E6%80%81%E4%BC%B0%E8%AE%A1/">#姿态估计</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/%E7%A5%9E%E7%BB%8F%E7%AE%97%E5%AD%90%E7%90%86%E8%AE%BA%EF%BC%9A%E5%AD%A6%E4%B9%A0%E6%97%A0%E9%99%90%E7%BB%B4%E6%98%A0%E5%B0%84/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">神经算子理论：学习无限维映射</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/%E7%9F%A9%E9%98%B5%E4%BD%8E%E7%A7%A9%E8%BF%91%E4%BC%BC-%E2%80%94%E2%80%94-%E4%BC%AA%E9%80%86/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">矩阵低秩近似 —— 伪逆</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'p2Cu9MgjoKzo3VmulhNLIusH-gzGzoHsz',
                    appKey: 'QThQHg3c8sVwGpzg9lu8zEG3',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情赞美帅气伟大的ck吧~',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Chen Kai';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2026&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Chen Kai</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
            </div>
        
        <div class="theme-info info-item">
            <!-- 由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a> -->
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E4%B8%8E%E6%8C%91%E6%88%98"><span class="nav-number">1.</span> <span class="nav-text">需求与挑战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82"><span class="nav-number">1.1.</span> <span class="nav-text">核心功能需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%8C%91%E6%88%98"><span class="nav-number">1.2.</span> <span class="nav-text">技术挑战</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BA%E6%96%87%E8%B0%83%E7%A0%94"><span class="nav-number">2.</span> <span class="nav-text">论文调研</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%89%A9%E4%BD%93%E6%A3%80%E6%B5%8B"><span class="nav-number">2.1.</span> <span class="nav-text">小物体检测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%A7%86%E8%A7%92%E8%B7%9F%E8%B8%AA%E4%B8%8E3d%E9%87%8D%E5%BB%BA"><span class="nav-number">2.2.</span> <span class="nav-text">多视角跟踪与3D重建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%E8%B7%9F%E8%B8%AA"><span class="nav-number">2.3.</span> <span class="nav-text">目标跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%A8%E8%BF%B9%E9%A2%84%E6%B5%8B"><span class="nav-number">2.4.</span> <span class="nav-text">轨迹预测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%BA%E4%BD%93%E5%A7%BF%E6%80%81%E4%BC%B0%E8%AE%A1"><span class="nav-number">2.5.</span> <span class="nav-text">人体姿态估计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.</span> <span class="nav-text">系统架构设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.</span> <span class="nav-text">硬件配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="nav-number">3.2.</span> <span class="nav-text">软件架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">核心算法实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E9%95%9C%E5%A4%B4%E6%A0%87%E5%AE%9A%E4%B8%8E%E5%90%8C%E6%AD%A5"><span class="nav-number">4.1.</span> <span class="nav-text">多镜头标定与同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%89%A9%E4%BD%93%E6%A3%80%E6%B5%8B%E4%B8%8E%E8%B7%9F%E8%B8%AA"><span class="nav-number">4.2.</span> <span class="nav-text">小物体检测与跟踪</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E7%BB%B4%E8%BD%A8%E8%BF%B9%E9%87%8D%E5%BB%BA%E4%B8%8E%E9%A2%84%E6%B5%8B"><span class="nav-number">4.3.</span> <span class="nav-text">三维轨迹重建与预测</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%BA%E4%BD%93%E5%A7%BF%E6%80%81%E4%BC%B0%E8%AE%A1-1"><span class="nav-number">4.4.</span> <span class="nav-text">人体姿态估计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90"><span class="nav-number">4.5.</span> <span class="nav-text">完整系统集成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="nav-number">5.</span> <span class="nav-text">部署与优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="nav-number">5.1.</span> <span class="nav-text">性能优化策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%B2%81%E6%A3%92%E6%80%A7%E6%8F%90%E5%8D%87"><span class="nav-number">5.2.</span> <span class="nav-text">鲁棒性提升</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7"><span class="nav-number">5.3.</span> <span class="nav-text">系统监控</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93%E4%B8%8E%E5%B1%95%E6%9C%9B"><span class="nav-number">6.</span> <span class="nav-text">总结与展望</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="nav-number">7.</span> <span class="nav-text">参考文献</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/lang-switch.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
