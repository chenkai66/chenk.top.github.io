<!DOCTYPE html>



<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Chen Kai">
    
    <title>
        
            AI Agent完全指南：从理论到工业实践 |
        
        Chen Kai Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chenk.top","root":"/","language":"zh-CN","default_language":"zh-CN","languages":["zh-CN","en"],"path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Chen Kai Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    
    
    
    
    

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Chen Kai Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    <li class="menu-item lang-switch lang-switch-trigger" title="Language">
                        <i class="fas fa-globe"></i>
                    </li>
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item lang-switch-trigger"><i class="fas fa-globe"></i></div>
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    
    
    
    

    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">AI Agent完全指南：从理论到工业实践</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Chen Kai</span>
                        
                            <span class="author-label">BOSS</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    
    
    
    
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2025-03-15 00:00:00</span>
        <span class="mobile">2025-03-15 00:00</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Large-Language-Models/">Large Language Models</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/LLM/">LLM</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/AI-Agents/">AI Agents</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Applications/">Applications</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>18.4k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>86 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>两年前，ChatGPT
横空出世让我们见识到大语言模型的强大对话能力。但仅仅"对话"还不够——当你问
ChatGPT"帮我订一张明天去上海的机票"时，它只能给你建议，却无法真正完成任务。这就是普通
LLM 的局限：<strong>缺乏与外部世界交互的能力</strong>。</p>
<p>AI Agent 的出现改变了这一切。Agent
不仅能理解你的需求，还能自主规划步骤、调用工具、执行操作、从错误中学习，最终完成复杂任务。从
AutoGPT 到 GPT-4 的 Function Calling，从单个智能体到多 Agent
协作系统，Agent 技术正在快速演进，逐步从研究原型走向工业应用。</p>
<p>本文将系统梳理 AI Agent
的核心概念、关键技术、主流框架和实战案例，帮助你构建属于自己的智能代理系统。</p>
<span id="more"></span>
<h2 id="agent-是什么">Agent 是什么</h2>
<h3 id="从被动回答到主动执行">从"被动回答"到"主动执行"</h3>
<p>传统的大语言模型就像一位博学的顾问：你问什么，它答什么。但 Agent
更像一位能干的助手：你提出目标，它会自己拆解任务、查找资料、调用工具、验证结果，直到完成目标。</p>
<p>想象你要组织一场技术分享会。普通 LLM 的交互可能是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">你：帮我策划一场 AI 主题的技术分享会</span><br><span class="line">LLM：可以从以下几个方面准备：</span><br><span class="line">     1. 确定主题和时间</span><br><span class="line">     2. 预订会议室</span><br><span class="line">     3. 邀请讲师</span><br><span class="line">     ...（给出建议后就结束了）</span><br></pre></td></tr></table></figure>
<p>而 Agent 的工作流程则完全不同：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">你：帮我组织一场 AI 主题的技术分享会</span><br><span class="line">Agent：</span><br><span class="line">  [规划] 拆解任务：调研热点话题、预订场地、联系讲师、发送邀请</span><br><span class="line">  [执行] 搜索最近三个月 AI 领域的热门论文...</span><br><span class="line">  [工具] 调用日历 API 查询可用时间...</span><br><span class="line">  [工具] 调用会议室预订系统...</span><br><span class="line">  [反思] 发现讲师时间冲突，重新调整...</span><br><span class="line">  [完成] 已完成预订，邀请邮件已发送</span><br></pre></td></tr></table></figure>
<p>这种"理解目标→自主规划→使用工具→执行反馈"的循环，就是 Agent
的核心特征。</p>
<h3 id="agent-的正式定义">Agent 的正式定义</h3>
<p>在学术界，Agent 通常被定义为：</p>
<p><strong>Agent
是一个能够感知环境、自主决策并采取行动以达成目标的计算实体。</strong></p>
<p>这个定义包含三个关键要素：</p>
<ol type="1">
<li><strong>感知（Perception）</strong>：Agent
能够接收来自环境的信息，包括用户输入、工具返回结果、外部数据源等</li>
<li><strong>决策（Planning &amp; Reasoning）</strong>：Agent
基于感知到的信息，结合自身知识进行推理和规划</li>
<li><strong>行动（Action）</strong>：Agent
执行具体操作，改变环境状态，并观察行动的结果</li>
</ol>
<p>用一个简单的公式表示：</p>
<p><span class="math display">\[
\text{Agent} = \text{LLM} + \text{Planning} + \text{Memory} + \text{Tool
Use}
\]</span></p>
<p>其中： - <strong>LLM</strong>（Large Language
Model）提供核心的理解和生成能力 - <strong>Planning</strong>
负责任务分解和执行计划制定 - <strong>Memory</strong>
存储上下文、历史记录和学到的经验 - <strong>Tool Use</strong> 让 Agent
能调用外部工具扩展能力边界</p>
<h3 id="agent-vs-普通-llm">Agent vs 普通 LLM</h3>
<p>让我们用一个对比表格来明确两者的区别：</p>
<table>
<thead>
<tr>
<th>维度</th>
<th>普通 LLM</th>
<th>AI Agent</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>交互模式</strong></td>
<td>单轮问答或多轮对话</td>
<td>目标驱动的任务执行</td>
</tr>
<tr>
<td><strong>能力范围</strong></td>
<td>仅限于生成文本</td>
<td>可调用工具、访问外部资源</td>
</tr>
<tr>
<td><strong>规划能力</strong></td>
<td>无，只能根据 prompt 回答</td>
<td>有，能自主拆解复杂任务</td>
</tr>
<tr>
<td><strong>记忆机制</strong></td>
<td>仅限于当前对话上下文</td>
<td>长期记忆、经验积累</td>
</tr>
<tr>
<td><strong>自主性</strong></td>
<td>被动响应</td>
<td>主动执行、迭代优化</td>
</tr>
<tr>
<td><strong>错误处理</strong></td>
<td>无法自我纠正</td>
<td>可以反思并重试</td>
</tr>
</tbody>
</table>
<p>举个具体例子。假设任务是"分析我的 GitHub 仓库的代码质量"：</p>
<p><strong>普通 LLM</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">用户：分析我的 GitHub 仓库 username/repo 的代码质量</span><br><span class="line">LLM：我无法直接访问你的 GitHub 仓库。你可以：</span><br><span class="line">     1. 把代码粘贴给我</span><br><span class="line">     2. 使用代码质量分析工具如 SonarQube</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure></p>
<p><strong>AI Agent</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用户：分析我的 GitHub 仓库 username/repo 的代码质量</span><br><span class="line">Agent：</span><br><span class="line">  [工具调用] 使用 GitHub API 克隆仓库...</span><br><span class="line">  [工具调用] 使用 pylint 扫描 Python 文件...</span><br><span class="line">  [分析] 发现 23 个潜在问题：</span><br><span class="line">    - 10 个未使用的导入</span><br><span class="line">    - 5 个命名不规范的变量</span><br><span class="line">    - 8 个过长的函数（&gt;50行）</span><br><span class="line">  [生成报告] 已生成详细报告并保存到 report.md</span><br></pre></td></tr></table></figure></p>
<p>这就是 Agent
的强大之处——它不仅理解你的需求，还能<strong>真正执行</strong>。</p>
<h2 id="agent-的发展历程">Agent 的发展历程</h2>
<h3 id="早期探索2020-2022">早期探索（2020-2022）</h3>
<p>AI Agent 的概念并非全新，早在强化学习领域就有 agent 的研究。但真正让
Agent 走向大众视野的是大语言模型的突破。</p>
<p><strong>ReAct（2022.10）</strong> 是早期的里程碑。研究者发现，让 LLM
交替进行"推理"（Reasoning）和"行动"（Acting），能显著提升问题解决能力。ReAct
的核心 prompt 模板非常简单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Question: [用户的问题]</span><br><span class="line">Thought: [我需要做什么]</span><br><span class="line">Action: [调用工具]</span><br><span class="line">Observation: [工具返回结果]</span><br><span class="line">Thought: [分析结果]</span><br><span class="line">Action: [下一步操作]</span><br><span class="line">...</span><br><span class="line">Final Answer: [最终答案]</span><br></pre></td></tr></table></figure>
<p>这个简单的循环奠定了现代 Agent 的基本框架。</p>
<h3 id="爆发期2023">爆发期（2023）</h3>
<p>2023 年是 Agent 技术井喷的一年：</p>
<p><strong>AutoGPT（2023.03）</strong> 引爆了全民关注。它让 GPT-4
自己给自己分配任务，自己调用工具，自己迭代优化。虽然实用性有限，但证明了
Agent 的可行性。</p>
<p><strong>GPT-4 Function Calling（2023.06）</strong>
是工程实践的重要突破。OpenAI 官方支持了结构化的工具调用，让 Agent
开发变得标准化。</p>
<p><strong>LangChain/LangGraph（2023）</strong>
等框架迅速成熟，提供了开箱即用的 Agent 组件。</p>
<p><strong>Multi-Agent 系统</strong> 开始出现：让多个 Agent
协作完成复杂任务，比如 MetaGPT、ChatDev 等。</p>
<h3 id="工业化阶段2024-现在">工业化阶段（2024-现在）</h3>
<p>进入 2024 年，Agent 技术开始从研究走向生产：</p>
<ul>
<li><p><strong>Claude Computer Use（2024.10）</strong>：Anthropic 推出的
Computer Use 功能让 Agent
能直接操作电脑界面，标志着通用智能代理的新阶段</p></li>
<li><p><strong>企业级 Agent 平台</strong> 涌现：各大云厂商推出 Agent
服务，如 AWS Bedrock Agents、Azure AI Agent Service</p></li>
<li><p><strong>垂直领域 Agent</strong> 成熟：代码助手（GitHub
Copilot）、客服机器人、数据分析 Agent 等开始规模化应用</p></li>
<li><p><strong>评估体系</strong> 完善：AgentBench、GAIA、AgentBoard
等基准测试建立，为 Agent 能力提供量化标准</p></li>
</ul>
<p>现在，Agent
技术已经进入"如何做好"而非"能否实现"的阶段。接下来，让我们深入 Agent
的核心能力。</p>
<h2 id="核心能力一规划planning">核心能力一：规划（Planning）</h2>
<p>规划是 Agent 最关键的能力——它决定了 Agent
能否将复杂目标分解为可执行的步骤。</p>
<h3 id="为什么需要规划">为什么需要规划</h3>
<p>人类解决复杂问题时会自然地进行任务分解。比如"做一顿晚餐"这个目标，你会拆分成：</p>
<ol type="1">
<li>确定菜单</li>
<li>列购物清单</li>
<li>去超市采购</li>
<li>洗菜切菜</li>
<li>烹饪</li>
<li>摆盘上桌</li>
</ol>
<p>每个子任务还能继续细化。这种层次化的规划能力，正是 Agent
需要具备的。</p>
<p>对于 LLM
来说，直接生成完整的执行步骤往往不可靠——可能遗漏关键步骤，或者顺序混乱。因此，Agent
需要专门的规划机制。</p>
<h3 id="规划的基本方法">规划的基本方法</h3>
<h4 id="单路径规划single-path">单路径规划（Single-Path）</h4>
<p>最简单的规划方式是<strong>线性分解</strong>：把任务拆成顺序执行的步骤。</p>
<p><strong>Chain of Thought (CoT)</strong> 就是这种思路。通过在 prompt
中加入"让我们一步步思考"，引导 LLM 逐步推理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">任务：计算 (15 + 27) * 3 - 8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">让我们一步步思考：</span></span><br><span class="line"><span class="string">第一步：计算括号内的加法</span></span><br><span class="line"><span class="string">第二步：乘以3</span></span><br><span class="line"><span class="string">第三步：减去8</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>对于 Agent 任务，<strong>ReAct</strong> 是经典的单路径规划框架：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReActAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, task</span>):</span><br><span class="line">        thought = self.think(task)  <span class="comment"># 推理</span></span><br><span class="line">        action = self.plan_action(thought)  <span class="comment"># 规划动作</span></span><br><span class="line">        observation = self.execute(action)  <span class="comment"># 执行</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.is_finished(observation):</span><br><span class="line">            <span class="keyword">return</span> self.generate_answer(observation)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.run(self.update_task(observation))  <span class="comment"># 递归</span></span><br></pre></td></tr></table></figure>
<p>单路径规划的优点是简单直接，缺点是遇到错误时难以回溯。</p>
<h4 id="多路径规划multi-path">多路径规划（Multi-Path）</h4>
<p>更高级的规划方法会同时探索多个可能的路径。</p>
<p><strong>Tree of Thoughts (ToT)</strong>
将推理过程建模为搜索树。每个节点是一个"思考"，Agent 可以： -
生成多个候选思考 - 评估每个思考的质量 - 选择最佳路径继续探索 -
必要时回溯到父节点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ToTAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">self, problem</span>):</span><br><span class="line">        root = Node(problem)</span><br><span class="line">        frontier = [root]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> frontier:</span><br><span class="line">            node = self.select_best(frontier)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> self.is_solution(node):</span><br><span class="line">                <span class="keyword">return</span> node.path</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成多个子思考</span></span><br><span class="line">            children = self.generate_thoughts(node, num=<span class="number">5</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 评估每个子思考</span></span><br><span class="line">            <span class="keyword">for</span> child <span class="keyword">in</span> children:</span><br><span class="line">                child.score = self.evaluate(child)</span><br><span class="line">            </span><br><span class="line">            frontier.extend(children)</span><br><span class="line">            frontier.sort(key=<span class="keyword">lambda</span> n: n.score, reverse=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>ToT 特别适合需要试错的任务，比如数学难题、游戏策略等。</p>
<h3 id="层次化任务分解htn">层次化任务分解（HTN）</h3>
<p><strong>Hierarchical Task Network (HTN)</strong>
是更结构化的规划方法。它将任务分解为多个层次：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">目标：组织技术大会</span><br><span class="line">├─ 子任务1：确定主题和议程</span><br><span class="line">│  ├─ 调研行业热点</span><br><span class="line">│  ├─ 设计分会场主题</span><br><span class="line">│  └─ 安排时间表</span><br><span class="line">├─ 子任务2：联系讲师</span><br><span class="line">│  ├─ 列出候选人名单</span><br><span class="line">│  ├─ 发送邀请邮件</span><br><span class="line">│  └─ 确认参与意愿</span><br><span class="line">└─ 子任务3：场地和后勤</span><br><span class="line">   ├─ 预订会议中心</span><br><span class="line">   ├─ 准备物料</span><br><span class="line">   └─ 安排餐饮</span><br></pre></td></tr></table></figure>
<p>HTN 规划的代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HTNPlanner</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.task_library = &#123;</span><br><span class="line">            <span class="string">&quot;组织技术大会&quot;</span>: [<span class="string">&quot;确定主题&quot;</span>, <span class="string">&quot;联系讲师&quot;</span>, <span class="string">&quot;安排场地&quot;</span>],</span><br><span class="line">            <span class="string">&quot;确定主题&quot;</span>: [<span class="string">&quot;调研热点&quot;</span>, <span class="string">&quot;设计议程&quot;</span>, <span class="string">&quot;制定时间表&quot;</span>],</span><br><span class="line">            <span class="comment"># ... 更多任务分解规则</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decompose</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;递归分解任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> task <span class="keyword">in</span> self.task_library:</span><br><span class="line">            subtasks = self.task_library[task]</span><br><span class="line">            <span class="keyword">return</span> [self.decompose(st) <span class="keyword">for</span> st <span class="keyword">in</span> subtasks]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> task  <span class="comment"># 原子任务，不再分解</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">plan</span>(<span class="params">self, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成执行计划&quot;&quot;&quot;</span></span><br><span class="line">        task_tree = self.decompose(goal)</span><br><span class="line">        <span class="keyword">return</span> self.flatten(task_tree)  <span class="comment"># 展开为执行序列</span></span><br></pre></td></tr></table></figure>
<p>HTN 的优势在于可复用的任务模板，缺点是需要预先定义分解规则。</p>
<h3 id="动态规划与重规划">动态规划与重规划</h3>
<p>实际执行中，环境可能变化，计划需要调整。<strong>自适应规划</strong>机制至关重要。</p>
<p><strong>AdaPlanner</strong> 是一个典型的自适应规划框架：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AdaPlanner</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_with_replanning</span>(<span class="params">self, plan</span>):</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> plan:</span><br><span class="line">            result = self.execute_step(step)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> result.success:</span><br><span class="line">                <span class="keyword">continue</span>  <span class="comment"># 继续执行</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 执行失败，触发重规划</span></span><br><span class="line">                failed_context = &#123;</span><br><span class="line">                    <span class="string">&quot;step&quot;</span>: step,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: result.error,</span><br><span class="line">                    <span class="string">&quot;previous_plan&quot;</span>: plan</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                new_plan = self.replan(failed_context)</span><br><span class="line">                <span class="keyword">return</span> self.execute_with_replanning(new_plan)</span><br></pre></td></tr></table></figure>
<p>重规划的提示词设计：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">replan_prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">原计划：<span class="subst">&#123;original_plan&#125;</span></span></span><br><span class="line"><span class="string">当前步骤：<span class="subst">&#123;current_step&#125;</span></span></span><br><span class="line"><span class="string">失败原因：<span class="subst">&#123;error_message&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请分析失败原因并生成新的计划。注意：</span></span><br><span class="line"><span class="string">1. 保留已成功的步骤</span></span><br><span class="line"><span class="string">2. 修正导致失败的策略</span></span><br><span class="line"><span class="string">3. 考虑替代方案</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="实战案例旅行规划-agent">实战案例：旅行规划 Agent</h3>
<p>让我们实现一个完整的旅行规划 Agent：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor, create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> tool</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义工具</span></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_flights</span>(<span class="params">origin: <span class="built_in">str</span>, destination: <span class="built_in">str</span>, date: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;搜索航班信息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 实际应调用航班API</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;找到3个航班：CA123 (¥1200), MU456 (¥980), CZ789 (¥1100)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_hotels</span>(<span class="params">city: <span class="built_in">str</span>, checkin: <span class="built_in">str</span>, checkout: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;搜索酒店&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;city&#125;</span>有5家酒店可选，价格区间¥300-800/晚&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search_attractions</span>(<span class="params">city: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;搜索景点&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;city&#125;</span>热门景点：外滩、豫园、东方明珠、迪士尼&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建规划Agent</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">tools = [search_flights, search_hotels, search_attractions]</span><br><span class="line"></span><br><span class="line">agent_prompt = <span class="string">&quot;&quot;&quot;你是一个专业的旅行规划助手。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">用户目标：&#123;input&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">请按以下步骤规划：</span></span><br><span class="line"><span class="string">1. 理解用户需求（目的地、时间、预算）</span></span><br><span class="line"><span class="string">2. 搜索交通方式</span></span><br><span class="line"><span class="string">3. 推荐住宿</span></span><br><span class="line"><span class="string">4. 安排游玩行程</span></span><br><span class="line"><span class="string">5. 生成完整计划</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">可用工具：</span></span><br><span class="line"><span class="string">- search_flights: 查询航班</span></span><br><span class="line"><span class="string">- search_hotels: 查询酒店</span></span><br><span class="line"><span class="string">- search_attractions: 查询景点</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">开始规划：</span></span><br><span class="line"><span class="string">&#123;agent_scratchpad&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">agent = create_openai_functions_agent(llm, tools, agent_prompt)</span><br><span class="line">executor = AgentExecutor(agent=agent, tools=tools, verbose=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">result = executor.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;帮我规划3天的上海之旅，预算5000元，喜欢人文历史&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result[<span class="string">&quot;output&quot;</span>])</span><br></pre></td></tr></table></figure>
<p>运行示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering AgentExecutor chain...</span><br><span class="line"></span><br><span class="line">Thought: 用户要去上海3天，预算5000元，喜欢人文历史。</span><br><span class="line">        我需要先搜索航班和酒店。</span><br><span class="line"></span><br><span class="line">Action: search_flights</span><br><span class="line">Action Input: &#123;&quot;origin&quot;: &quot;北京&quot;, &quot;destination&quot;: &quot;上海&quot;, &quot;date&quot;: &quot;2024-04-01&quot;&#125;</span><br><span class="line">Observation: 找到3个航班：CA123 (¥1200), MU456 (¥980), CZ789 (¥1100)</span><br><span class="line"></span><br><span class="line">Thought: MU456最便宜，选它。现在搜索酒店。</span><br><span class="line"></span><br><span class="line">Action: search_hotels</span><br><span class="line">Action Input: &#123;&quot;city&quot;: &quot;上海&quot;, &quot;checkin&quot;: &quot;2024-04-01&quot;, &quot;checkout&quot;: &quot;2024-04-04&quot;&#125;</span><br><span class="line">Observation: 上海有5家酒店可选，价格区间¥300-800/晚</span><br><span class="line"></span><br><span class="line">Thought: 3晚住宿预算¥1200左右。查询景点。</span><br><span class="line"></span><br><span class="line">Action: search_attractions</span><br><span class="line">Action Input: &#123;&quot;city&quot;: &quot;上海&quot;&#125;</span><br><span class="line">Observation: 上海热门景点：外滩、豫园、东方明珠、迪士尼</span><br><span class="line"></span><br><span class="line">Thought: 用户喜欢人文历史，迪士尼不太合适。规划完成。</span><br><span class="line"></span><br><span class="line">Final Answer:</span><br><span class="line">【上海3日游计划】</span><br><span class="line"></span><br><span class="line">交通：</span><br><span class="line">- 往返航班MU456，¥980×2 = ¥1960</span><br><span class="line"></span><br><span class="line">住宿：</span><br><span class="line">- 推荐黄浦区酒店（靠近外滩），¥400/晚×3 = ¥1200</span><br><span class="line"></span><br><span class="line">行程：</span><br><span class="line">第一天：外滩 → 南京路 → 人民广场</span><br><span class="line">第二天：豫园 → 城隍庙 → 田子坊</span><br><span class="line">第三天：上海博物馆 → 新天地 → 返程</span><br><span class="line"></span><br><span class="line">总预算：¥3160（交通+住宿），剩余¥1840用于餐饮和门票</span><br></pre></td></tr></table></figure>
<p>这个例子展示了完整的规划流程：理解需求→调用工具→组合信息→生成计划。</p>
<h2 id="核心能力二记忆memory">核心能力二：记忆（Memory）</h2>
<p>如果说规划是 Agent 的"大脑"，那么记忆就是 Agent
的"知识库"。没有记忆，Agent
就像患了失忆症，无法从经验中学习，也无法处理长期任务。</p>
<h3 id="为什么-agent-需要记忆">为什么 Agent 需要记忆</h3>
<p>LLM 的上下文窗口是有限的。即使是 GPT-4 的 128k tokens，也只能容纳约
10 万字的对话。对于需要持续运行数天甚至数周的 Agent
任务，这远远不够。</p>
<p>更重要的是，Agent 需要记住： -
<strong>任务上下文</strong>：之前做了什么，还剩什么没做 -
<strong>工具使用经验</strong>：哪些工具调用成功了，哪些失败了 -
<strong>领域知识</strong>：积累的专业信息和最佳实践 -
<strong>用户偏好</strong>：历史交互中暴露的用户习惯</p>
<h3 id="短期记忆-vs-长期记忆">短期记忆 vs 长期记忆</h3>
<p>人类的记忆分为短期记忆（工作记忆）和长期记忆。Agent
也采用类似架构：</p>
<p><strong>短期记忆（Short-Term Memory）</strong>： -
存储当前对话和最近的执行历史 - 直接放在 LLM 的上下文窗口中 -
容量有限，需要不断更新</p>
<p><strong>长期记忆（Long-Term Memory）</strong>： -
存储重要的历史信息和学到的知识 - 通常保存在外部数据库中 -
按需检索加载到短期记忆</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AgentMemory</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 短期记忆：当前会话的消息列表</span></span><br><span class="line">        self.short_term = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 长期记忆：向量数据库</span></span><br><span class="line">        <span class="keyword">from</span> langchain.vectorstores <span class="keyword">import</span> Chroma</span><br><span class="line">        <span class="keyword">from</span> langchain.embeddings <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line">        </span><br><span class="line">        self.long_term = Chroma(</span><br><span class="line">            embedding_function=OpenAIEmbeddings(),</span><br><span class="line">            persist_directory=<span class="string">&quot;./agent_memory&quot;</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_message</span>(<span class="params">self, role, content</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加到短期记忆&quot;&quot;&quot;</span></span><br><span class="line">        self.short_term.append(&#123;<span class="string">&quot;role&quot;</span>: role, <span class="string">&quot;content&quot;</span>: content&#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 超过限制时，转移到长期记忆</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.short_term) &gt; <span class="number">20</span>:</span><br><span class="line">            old_message = self.short_term.pop(<span class="number">0</span>)</span><br><span class="line">            self.long_term.add_texts([old_message[<span class="string">&quot;content&quot;</span>]])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, query, k=<span class="number">5</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从长期记忆中检索相关内容&quot;&quot;&quot;</span></span><br><span class="line">        docs = self.long_term.similarity_search(query, k=k)</span><br><span class="line">        <span class="keyword">return</span> [doc.page_content <span class="keyword">for</span> doc <span class="keyword">in</span> docs]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_context</span>(<span class="params">self, current_query</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;组合短期和长期记忆&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检索相关的长期记忆</span></span><br><span class="line">        relevant_history = self.recall(current_query)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 拼接成完整上下文</span></span><br><span class="line">        context = relevant_history + self.short_term</span><br><span class="line">        <span class="keyword">return</span> context</span><br></pre></td></tr></table></figure>
<h3 id="向量数据库记忆的基础设施">向量数据库：记忆的基础设施</h3>
<p>长期记忆通常基于<strong>向量数据库</strong>实现。基本流程：</p>
<ol type="1">
<li><strong>存储</strong>：将文本转为向量（embedding），存入数据库</li>
<li><strong>检索</strong>：将查询转为向量，找到最相似的记忆</li>
<li><strong>更新</strong>：定期清理过时信息，合并重复记忆</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.embeddings <span class="keyword">import</span> OpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> langchain.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VectorMemory</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.embeddings = OpenAIEmbeddings()</span><br><span class="line">        self.vectorstore = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, text, metadata=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加记忆&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.vectorstore <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.vectorstore = FAISS.from_texts(</span><br><span class="line">                [text], </span><br><span class="line">                self.embeddings,</span><br><span class="line">                metadatas=[metadata <span class="keyword">or</span> &#123;&#125;]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.vectorstore.add_texts([text], [metadata <span class="keyword">or</span> &#123;&#125;])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">self, query, k=<span class="number">5</span>, <span class="built_in">filter</span>=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;搜索记忆&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.vectorstore <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        </span><br><span class="line">        docs = self.vectorstore.similarity_search_with_score(</span><br><span class="line">            query, k=k, <span class="built_in">filter</span>=<span class="built_in">filter</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [(doc.page_content, score) <span class="keyword">for</span> doc, score <span class="keyword">in</span> docs]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self, path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;持久化&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.vectorstore:</span><br><span class="line">            self.vectorstore.save_local(path)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">self, path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;加载&quot;&quot;&quot;</span></span><br><span class="line">        self.vectorstore = FAISS.load_local(path, self.embeddings)</span><br></pre></td></tr></table></figure>
<p>常用的向量数据库包括： - <strong>FAISS</strong>：Meta
开源，适合原型开发 - <strong>Pinecone</strong>：托管服务，易于扩展 -
<strong>Milvus</strong>：开源，适合大规模部署 -
<strong>Chroma</strong>：轻量级，适合中小项目</p>
<h3 id="结构化记忆超越简单文本">结构化记忆：超越简单文本</h3>
<p>纯文本记忆不够精确。很多 Agent 采用<strong>结构化记忆</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StructuredMemory</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">import</span> sqlite3</span><br><span class="line">        self.conn = sqlite3.connect(<span class="string">&quot;agent_memory.db&quot;</span>)</span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 创建表</span></span><br><span class="line">        self.cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            CREATE TABLE IF NOT EXISTS interactions (</span></span><br><span class="line"><span class="string">                id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="string">                timestamp TEXT,</span></span><br><span class="line"><span class="string">                task TEXT,</span></span><br><span class="line"><span class="string">                action TEXT,</span></span><br><span class="line"><span class="string">                result TEXT,</span></span><br><span class="line"><span class="string">                success BOOLEAN</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        self.cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            CREATE TABLE IF NOT EXISTS knowledge (</span></span><br><span class="line"><span class="string">                id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="string">                entity TEXT,</span></span><br><span class="line"><span class="string">                attribute TEXT,</span></span><br><span class="line"><span class="string">                value TEXT,</span></span><br><span class="line"><span class="string">                source TEXT</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_interaction</span>(<span class="params">self, task, action, result, success</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;记录交互历史&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line">        self.cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            INSERT INTO interactions </span></span><br><span class="line"><span class="string">            (timestamp, task, action, result, success)</span></span><br><span class="line"><span class="string">            VALUES (?, ?, ?, ?, ?)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>, (datetime.now().isoformat(), task, action, result, success))</span><br><span class="line">        self.conn.commit()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">store_knowledge</span>(<span class="params">self, entity, attribute, value, source</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;存储知识三元组&quot;&quot;&quot;</span></span><br><span class="line">        self.cursor.execute(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            INSERT OR REPLACE INTO knowledge</span></span><br><span class="line"><span class="string">            (entity, attribute, value, source)</span></span><br><span class="line"><span class="string">            VALUES (?, ?, ?, ?)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>, (entity, attribute, value, source))</span><br><span class="line">        self.conn.commit()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">query_knowledge</span>(<span class="params">self, entity=<span class="literal">None</span>, attribute=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;查询知识&quot;&quot;&quot;</span></span><br><span class="line">        query = <span class="string">&quot;SELECT * FROM knowledge WHERE 1=1&quot;</span></span><br><span class="line">        params = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> entity:</span><br><span class="line">            query += <span class="string">&quot; AND entity = ?&quot;</span></span><br><span class="line">            params.append(entity)</span><br><span class="line">        <span class="keyword">if</span> attribute:</span><br><span class="line">            query += <span class="string">&quot; AND attribute = ?&quot;</span></span><br><span class="line">            params.append(attribute)</span><br><span class="line">        </span><br><span class="line">        self.cursor.execute(query, params)</span><br><span class="line">        <span class="keyword">return</span> self.cursor.fetchall()</span><br></pre></td></tr></table></figure>
<p>这种结构化记忆适合存储： - 实体关系（如"张三是产品经理"） -
任务状态（如"已完成数据清洗"） - 工具调用记录（如"search_api
在周末超时"）</p>
<h3 id="mars多步推理的记忆增强">MARS：多步推理的记忆增强</h3>
<p><strong>MARS (Memory-Augmented Reasoning with Search)</strong>
是一个专门为 Agent 设计的记忆系统。核心思想：</p>
<ol type="1">
<li>在每个推理步骤后，将重要信息存入记忆</li>
<li>下一步推理前，先检索相关记忆</li>
<li>将检索结果和当前问题一起送入 LLM</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MARSAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm, memory</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">        self.memory = memory</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">self, problem</span>):</span><br><span class="line">        steps = []</span><br><span class="line">        current_state = problem</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.is_solved(current_state):</span><br><span class="line">            <span class="comment"># 检索相关记忆</span></span><br><span class="line">            relevant_memories = self.memory.search(</span><br><span class="line">                current_state, k=<span class="number">3</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 组合成prompt</span></span><br><span class="line">            prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            问题：<span class="subst">&#123;problem&#125;</span></span></span><br><span class="line"><span class="string">            当前状态：<span class="subst">&#123;current_state&#125;</span></span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            相关经验：</span></span><br><span class="line"><span class="string">            <span class="subst">&#123;self.format_memories(relevant_memories)&#125;</span></span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            下一步该做什么？</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># LLM推理</span></span><br><span class="line">            response = self.llm(prompt)</span><br><span class="line">            action = self.parse_action(response)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行动作</span></span><br><span class="line">            result = self.execute(action)</span><br><span class="line">            steps.append((action, result))</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 存入记忆</span></span><br><span class="line">            self.memory.add(</span><br><span class="line">                <span class="string">f&quot;问题：<span class="subst">&#123;current_state&#125;</span>\n动作：<span class="subst">&#123;action&#125;</span>\n结果：<span class="subst">&#123;result&#125;</span>&quot;</span></span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            current_state = self.update_state(current_state, result)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> steps</span><br></pre></td></tr></table></figure>
<p>MARS 特别适合需要多步推理的任务，如数学证明、代码调试等。</p>
<h3 id="memento基于事件的记忆管理">Memento：基于事件的记忆管理</h3>
<p><strong>Memento</strong> 系统将 Agent 的记忆组织为事件流：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span>, <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MemoryEvent</span>:</span><br><span class="line">    timestamp: datetime</span><br><span class="line">    event_type: <span class="built_in">str</span>  <span class="comment"># &quot;observation&quot;, &quot;action&quot;, &quot;reflection&quot;</span></span><br><span class="line">    content: <span class="built_in">str</span></span><br><span class="line">    importance: <span class="built_in">float</span>  <span class="comment"># 0-1</span></span><br><span class="line">    tags: <span class="type">List</span>[<span class="built_in">str</span>]</span><br><span class="line">    linked_events: <span class="type">List</span>[<span class="built_in">int</span>]  <span class="comment"># 关联事件的ID</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MementoMemory</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.events: <span class="type">List</span>[MemoryEvent] = []</span><br><span class="line">        self.index = &#123;&#125;  <span class="comment"># tag -&gt; event_ids</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_event</span>(<span class="params">self, event: MemoryEvent</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加事件&quot;&quot;&quot;</span></span><br><span class="line">        event_id = <span class="built_in">len</span>(self.events)</span><br><span class="line">        self.events.append(event)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 建立索引</span></span><br><span class="line">        <span class="keyword">for</span> tag <span class="keyword">in</span> event.tags:</span><br><span class="line">            <span class="keyword">if</span> tag <span class="keyword">not</span> <span class="keyword">in</span> self.index:</span><br><span class="line">                self.index[tag] = []</span><br><span class="line">            self.index[tag].append(event_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_by_time</span>(<span class="params">self, start, end</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;按时间检索&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [e <span class="keyword">for</span> e <span class="keyword">in</span> self.events </span><br><span class="line">                <span class="keyword">if</span> start &lt;= e.timestamp &lt;= end]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_by_tag</span>(<span class="params">self, tag</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;按标签检索&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> tag <span class="keyword">not</span> <span class="keyword">in</span> self.index:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">return</span> [self.events[i] <span class="keyword">for</span> i <span class="keyword">in</span> self.index[tag]]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve_by_importance</span>(<span class="params">self, threshold=<span class="number">0.7</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;检索重要事件&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> [e <span class="keyword">for</span> e <span class="keyword">in</span> self.events </span><br><span class="line">                <span class="keyword">if</span> e.importance &gt;= threshold]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_event_chain</span>(<span class="params">self, event_id</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;获取事件链&quot;&quot;&quot;</span></span><br><span class="line">        chain = []</span><br><span class="line">        current = self.events[event_id]</span><br><span class="line">        chain.append(current)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> linked_id <span class="keyword">in</span> current.linked_events:</span><br><span class="line">            chain.extend(self.get_event_chain(linked_id))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain</span><br></pre></td></tr></table></figure>
<p>使用示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">memory = MementoMemory()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加观察事件</span></span><br><span class="line">memory.add_event(MemoryEvent(</span><br><span class="line">    timestamp=datetime.now(),</span><br><span class="line">    event_type=<span class="string">&quot;observation&quot;</span>,</span><br><span class="line">    content=<span class="string">&quot;用户询问如何优化数据库查询&quot;</span>,</span><br><span class="line">    importance=<span class="number">0.8</span>,</span><br><span class="line">    tags=[<span class="string">&quot;数据库&quot;</span>, <span class="string">&quot;查询优化&quot;</span>, <span class="string">&quot;用户问题&quot;</span>],</span><br><span class="line">    linked_events=[]</span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加行动事件</span></span><br><span class="line">memory.add_event(MemoryEvent(</span><br><span class="line">    timestamp=datetime.now(),</span><br><span class="line">    event_type=<span class="string">&quot;action&quot;</span>,</span><br><span class="line">    content=<span class="string">&quot;查询数据库schema&quot;</span>,</span><br><span class="line">    importance=<span class="number">0.6</span>,</span><br><span class="line">    tags=[<span class="string">&quot;数据库&quot;</span>, <span class="string">&quot;工具调用&quot;</span>],</span><br><span class="line">    linked_events=[<span class="number">0</span>]  <span class="comment"># 关联到第一个事件</span></span><br><span class="line">))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检索</span></span><br><span class="line">recent_db_events = memory.retrieve_by_tag(<span class="string">&quot;数据库&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="记忆压缩与遗忘">记忆压缩与遗忘</h3>
<p>记忆不能无限增长。Agent 需要"遗忘"机制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AdaptiveMemory</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_size=<span class="number">1000</span></span>):</span><br><span class="line">        self.memories = []</span><br><span class="line">        self.max_size = max_size</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, content, importance=<span class="number">0.5</span></span>):</span><br><span class="line">        self.memories.append(&#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span>: content,</span><br><span class="line">            <span class="string">&quot;importance&quot;</span>: importance,</span><br><span class="line">            <span class="string">&quot;access_count&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;last_access&quot;</span>: datetime.now()</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 超过容量时清理</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.memories) &gt; self.max_size:</span><br><span class="line">            self.cleanup()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">cleanup</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;清理低价值记忆&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 计算每条记忆的保留分数</span></span><br><span class="line">        <span class="keyword">for</span> mem <span class="keyword">in</span> self.memories:</span><br><span class="line">            recency = (datetime.now() - mem[<span class="string">&quot;last_access&quot;</span>]).days</span><br><span class="line">            mem[<span class="string">&quot;score&quot;</span>] = (</span><br><span class="line">                mem[<span class="string">&quot;importance&quot;</span>] * <span class="number">0.5</span> +</span><br><span class="line">                mem[<span class="string">&quot;access_count&quot;</span>] * <span class="number">0.3</span> -</span><br><span class="line">                recency * <span class="number">0.2</span></span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 排序并保留前N条</span></span><br><span class="line">        self.memories.sort(key=<span class="keyword">lambda</span> m: m[<span class="string">&quot;score&quot;</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        self.memories = self.memories[:self.max_size]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">retrieve</span>(<span class="params">self, query, k=<span class="number">5</span></span>):</span><br><span class="line">        <span class="comment"># 使用向量搜索（省略细节）</span></span><br><span class="line">        results = self.vector_search(query, k)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新访问统计</span></span><br><span class="line">        <span class="keyword">for</span> mem <span class="keyword">in</span> results:</span><br><span class="line">            mem[<span class="string">&quot;access_count&quot;</span>] += <span class="number">1</span></span><br><span class="line">            mem[<span class="string">&quot;last_access&quot;</span>] = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>
<p>这种基于重要性、访问频率和时间衰减的遗忘机制，让 Agent
能够聚焦于最相关的记忆。</p>
<h2 id="核心能力三工具使用tool-use">核心能力三：工具使用（Tool
Use）</h2>
<p>工具使用是 Agent 突破 LLM 固有限制的关键。通过工具，Agent 能够： -
访问实时信息（搜索引擎、数据库） - 执行精确计算（计算器、代码解释器） -
操作外部系统（API 调用、文件操作） -
感知多模态信息（图像识别、语音转文字）</p>
<h3 id="function-calling标准化的工具接口">Function
Calling：标准化的工具接口</h3>
<p><strong>Function Calling</strong> 是现代 Agent 工具使用的基础。以
OpenAI 的实现为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义工具</span></span><br><span class="line">tools = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;function&quot;</span>,</span><br><span class="line">        <span class="string">&quot;function&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;get_weather&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;获取指定城市的天气信息&quot;</span>,</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">                <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;city&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;城市名称，如&#x27;北京&#x27;&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;unit&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;enum&quot;</span>: [<span class="string">&quot;celsius&quot;</span>, <span class="string">&quot;fahrenheit&quot;</span>],</span><br><span class="line">                        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;温度单位&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;city&quot;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Agent调用</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run_agent</span>(<span class="params">user_message</span>):</span><br><span class="line">    messages = [&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: user_message&#125;]</span><br><span class="line">    </span><br><span class="line">    response = openai.chat.completions.create(</span><br><span class="line">        model=<span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">        messages=messages,</span><br><span class="line">        tools=tools,</span><br><span class="line">        tool_choice=<span class="string">&quot;auto&quot;</span>  <span class="comment"># 让模型决定是否调用工具</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查是否需要调用工具</span></span><br><span class="line">    message = response.choices[<span class="number">0</span>].message</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> message.tool_calls:</span><br><span class="line">        <span class="comment"># 执行工具调用</span></span><br><span class="line">        <span class="keyword">for</span> tool_call <span class="keyword">in</span> message.tool_calls:</span><br><span class="line">            function_name = tool_call.function.name</span><br><span class="line">            arguments = json.loads(tool_call.function.arguments)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 调用实际函数</span></span><br><span class="line">            <span class="keyword">if</span> function_name == <span class="string">&quot;get_weather&quot;</span>:</span><br><span class="line">                result = get_weather(**arguments)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 将结果返回给模型</span></span><br><span class="line">            messages.append(message)</span><br><span class="line">            messages.append(&#123;</span><br><span class="line">                <span class="string">&quot;role&quot;</span>: <span class="string">&quot;tool&quot;</span>,</span><br><span class="line">                <span class="string">&quot;tool_call_id&quot;</span>: tool_call.<span class="built_in">id</span>,</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: result</span><br><span class="line">            &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取最终回复</span></span><br><span class="line">        final_response = openai.chat.completions.create(</span><br><span class="line">            model=<span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">            messages=messages</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> final_response.choices[<span class="number">0</span>].message.content</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> message.content</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实际工具实现</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_weather</span>(<span class="params">city, unit=<span class="string">&quot;celsius&quot;</span></span>):</span><br><span class="line">    <span class="comment"># 这里应调用真实天气API</span></span><br><span class="line">    <span class="keyword">return</span> json.dumps(&#123;</span><br><span class="line">        <span class="string">&quot;city&quot;</span>: city,</span><br><span class="line">        <span class="string">&quot;temperature&quot;</span>: <span class="number">22</span>,</span><br><span class="line">        <span class="string">&quot;condition&quot;</span>: <span class="string">&quot;晴&quot;</span>,</span><br><span class="line">        <span class="string">&quot;unit&quot;</span>: unit</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">result = run_agent(<span class="string">&quot;北京今天天气怎么样？&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># 输出：北京今天晴，温度22摄氏度</span></span><br></pre></td></tr></table></figure>
<p>Function Calling 的优势： - <strong>结构化输出</strong>：模型生成
JSON 格式的参数，易于解析 -
<strong>类型安全</strong>：参数有明确的类型定义 -
<strong>自动选择</strong>：模型决定何时调用哪个工具 -
<strong>链式调用</strong>：可以连续调用多个工具</p>
<h3 id="claude-的工具使用">Claude 的工具使用</h3>
<p>Anthropic 的 Claude 也支持工具使用，语法略有不同：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> anthropic</span><br><span class="line"></span><br><span class="line">client = anthropic.Anthropic()</span><br><span class="line"></span><br><span class="line">tools = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;search_database&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;在数据库中搜索信息&quot;</span>,</span><br><span class="line">        <span class="string">&quot;input_schema&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">            <span class="string">&quot;properties&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;搜索关键词&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;required&quot;</span>: [<span class="string">&quot;query&quot;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">message = client.messages.create(</span><br><span class="line">    model=<span class="string">&quot;claude-3-5-sonnet-20241022&quot;</span>,</span><br><span class="line">    max_tokens=<span class="number">1024</span>,</span><br><span class="line">    tools=tools,</span><br><span class="line">    messages=[</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;查询用户ID 12345 的订单记录&quot;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理工具调用</span></span><br><span class="line"><span class="keyword">if</span> message.stop_reason == <span class="string">&quot;tool_use&quot;</span>:</span><br><span class="line">    tool_use = <span class="built_in">next</span>(</span><br><span class="line">        block <span class="keyword">for</span> block <span class="keyword">in</span> message.content </span><br><span class="line">        <span class="keyword">if</span> block.<span class="built_in">type</span> == <span class="string">&quot;tool_use&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行工具</span></span><br><span class="line">    result = search_database(tool_use.<span class="built_in">input</span>[<span class="string">&quot;query&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 继续对话</span></span><br><span class="line">    response = client.messages.create(</span><br><span class="line">        model=<span class="string">&quot;claude-3-5-sonnet-20241022&quot;</span>,</span><br><span class="line">        max_tokens=<span class="number">1024</span>,</span><br><span class="line">        tools=tools,</span><br><span class="line">        messages=[</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: <span class="string">&quot;查询用户ID 12345的订单记录&quot;</span>&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;content&quot;</span>: message.content&#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                <span class="string">&quot;content&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;tool_result&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;tool_use_id&quot;</span>: tool_use.<span class="built_in">id</span>,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: result</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h3 id="computer-use突破界面限制">Computer Use：突破界面限制</h3>
<p>2024年10月，Anthropic 推出的 <strong>Computer Use</strong>
功能是工具使用的重大突破。Agent 不再局限于预定义的
API，而是可以直接操作电脑：</p>
<ul>
<li>移动鼠标和点击</li>
<li>键盘输入</li>
<li>截图并理解界面</li>
<li>跨应用操作</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> anthropic <span class="keyword">import</span> Anthropic</span><br><span class="line"></span><br><span class="line">client = Anthropic()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">computer_use_agent</span>(<span class="params">task</span>):</span><br><span class="line">    messages = [</span><br><span class="line">        &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: task&#125;</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        response = client.messages.create(</span><br><span class="line">            model=<span class="string">&quot;claude-3-5-sonnet-20241022&quot;</span>,</span><br><span class="line">            max_tokens=<span class="number">4096</span>,</span><br><span class="line">            tools=[</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;computer_20241022&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;computer&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;display_width_px&quot;</span>: <span class="number">1920</span>,</span><br><span class="line">                    <span class="string">&quot;display_height_px&quot;</span>: <span class="number">1080</span></span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            messages=messages</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查是否有操作</span></span><br><span class="line">        <span class="keyword">if</span> response.stop_reason == <span class="string">&quot;tool_use&quot;</span>:</span><br><span class="line">            <span class="keyword">for</span> block <span class="keyword">in</span> response.content:</span><br><span class="line">                <span class="keyword">if</span> block.<span class="built_in">type</span> == <span class="string">&quot;tool_use&quot;</span>:</span><br><span class="line">                    action = block.<span class="built_in">input</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 执行操作（鼠标、键盘、截图）</span></span><br><span class="line">                    result = execute_computer_action(action)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 更新对话</span></span><br><span class="line">                    messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;content&quot;</span>: response.content&#125;)</span><br><span class="line">                    messages.append(&#123;</span><br><span class="line">                        <span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;content&quot;</span>: [&#123;</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;tool_result&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;tool_use_id&quot;</span>: block.<span class="built_in">id</span>,</span><br><span class="line">                            <span class="string">&quot;content&quot;</span>: result</span><br><span class="line">                        &#125;]</span><br><span class="line">                    &#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 任务完成</span></span><br><span class="line">            <span class="keyword">return</span> response.content</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例任务</span></span><br><span class="line">computer_use_agent(<span class="string">&quot;打开浏览器，搜索&#x27;AI Agent 教程&#x27;，并总结前三个结果&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Computer Use
开启了通用自动化的大门，但也带来安全性挑战——需要严格的权限控制和沙箱隔离。</p>
<h3 id="工具生态从基础到高级">工具生态：从基础到高级</h3>
<h4 id="基础工具">基础工具</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 搜索工具</span></span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> DuckDuckGoSearchRun</span><br><span class="line"></span><br><span class="line">search = DuckDuckGoSearchRun()</span><br><span class="line">result = search.run(<span class="string">&quot;AI Agent 最新进展&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计算器</span></span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> PythonREPLTool</span><br><span class="line"></span><br><span class="line">calculator = PythonREPLTool()</span><br><span class="line">result = calculator.run(<span class="string">&quot;import math; math.sqrt(12345)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 文件操作</span></span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> FileManagementToolkit</span><br><span class="line"><span class="keyword">from</span> langchain.tools.file_management <span class="keyword">import</span> (</span><br><span class="line">    ReadFileTool,</span><br><span class="line">    WriteFileTool,</span><br><span class="line">    ListDirectoryTool</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">file_tools = FileManagementToolkit(</span><br><span class="line">    root_dir=<span class="string">&quot;./workspace&quot;</span></span><br><span class="line">).get_tools()</span><br></pre></td></tr></table></figure>
<h4 id="数据库工具">数据库工具</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain_community.utilities <span class="keyword">import</span> SQLDatabase</span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> QuerySQLDataBaseTool</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接数据库</span></span><br><span class="line">db = SQLDatabase.from_uri(<span class="string">&quot;sqlite:///users.db&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建查询工具</span></span><br><span class="line">db_tool = QuerySQLDataBaseTool(db=db)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自然语言转SQL</span></span><br><span class="line"><span class="keyword">from</span> langchain.chains <span class="keyword">import</span> create_sql_query_chain</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"></span><br><span class="line">llm = ChatOpenAI()</span><br><span class="line">chain = create_sql_query_chain(llm, db)</span><br><span class="line"></span><br><span class="line">query = chain.invoke(&#123;<span class="string">&quot;question&quot;</span>: <span class="string">&quot;有多少活跃用户？&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># 输出：SELECT COUNT(*) FROM users WHERE status = &#x27;active&#x27;</span></span><br><span class="line"></span><br><span class="line">result = db_tool.run(query)</span><br></pre></td></tr></table></figure>
<h4 id="api-集成工具">API 集成工具</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> APIOperation</span><br><span class="line"><span class="keyword">from</span> langchain.utilities <span class="keyword">import</span> RequestsWrapper</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义API工具</span></span><br><span class="line">api_spec = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">openapi: 3.0.0</span></span><br><span class="line"><span class="string">info:</span></span><br><span class="line"><span class="string">  title: GitHub API</span></span><br><span class="line"><span class="string">  version: 1.0.0</span></span><br><span class="line"><span class="string">paths:</span></span><br><span class="line"><span class="string">  /repos/&#123;owner&#125;/&#123;repo&#125;/issues:</span></span><br><span class="line"><span class="string">    get:</span></span><br><span class="line"><span class="string">      summary: List repository issues</span></span><br><span class="line"><span class="string">      parameters:</span></span><br><span class="line"><span class="string">        - name: owner</span></span><br><span class="line"><span class="string">          in: path</span></span><br><span class="line"><span class="string">          required: true</span></span><br><span class="line"><span class="string">        - name: repo</span></span><br><span class="line"><span class="string">          in: path</span></span><br><span class="line"><span class="string">          required: true</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">requests_wrapper = RequestsWrapper(headers=&#123;<span class="string">&quot;Authorization&quot;</span>: <span class="string">&quot;token YOUR_TOKEN&quot;</span>&#125;)</span><br><span class="line">github_tool = APIOperation.from_openapi_spec(api_spec, requests_wrapper)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">issues = github_tool.run(&#123;</span><br><span class="line">    <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;langchain-ai&quot;</span>,</span><br><span class="line">    <span class="string">&quot;repo&quot;</span>: <span class="string">&quot;langchain&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="工具编排组合多个工具">工具编排：组合多个工具</h3>
<p>复杂任务需要多个工具协作。<strong>工具编排</strong>是关键能力：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentType, initialize_agent</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> Tool</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义多个工具</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_data</span>(<span class="params">data_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析数据文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">    df = pd.read_csv(data_path)</span><br><span class="line">    <span class="keyword">return</span> df.describe().to_string()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualize_data</span>(<span class="params">data_path, chart_type</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;生成数据可视化&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">    <span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">    </span><br><span class="line">    df = pd.read_csv(data_path)</span><br><span class="line">    <span class="keyword">if</span> chart_type == <span class="string">&quot;bar&quot;</span>:</span><br><span class="line">        df.plot.bar()</span><br><span class="line">    <span class="keyword">elif</span> chart_type == <span class="string">&quot;line&quot;</span>:</span><br><span class="line">        df.plot.line()</span><br><span class="line">    </span><br><span class="line">    plt.savefig(<span class="string">&quot;chart.png&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;图表已保存到 chart.png&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_report</span>(<span class="params">recipient, content</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;发送报告邮件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 实际应调用邮件API</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;报告已发送给 <span class="subst">&#123;recipient&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建工具列表</span></span><br><span class="line">tools = [</span><br><span class="line">    Tool(name=<span class="string">&quot;AnalyzeData&quot;</span>, func=analyze_data, </span><br><span class="line">         description=<span class="string">&quot;分析CSV文件，返回统计信息&quot;</span>),</span><br><span class="line">    Tool(name=<span class="string">&quot;VisualizeData&quot;</span>, func=visualize_data,</span><br><span class="line">         description=<span class="string">&quot;生成数据图表，需要指定图表类型&quot;</span>),</span><br><span class="line">    Tool(name=<span class="string">&quot;SendReport&quot;</span>, func=send_report,</span><br><span class="line">         description=<span class="string">&quot;发送报告邮件&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Agent</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">agent = initialize_agent(</span><br><span class="line">    tools, </span><br><span class="line">    llm, </span><br><span class="line">    agent=AgentType.OPENAI_FUNCTIONS,</span><br><span class="line">    verbose=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行复杂任务</span></span><br><span class="line">agent.run(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">分析 sales_data.csv 文件，生成柱状图，</span></span><br><span class="line"><span class="string">然后把分析结果和图表发送给 manager@company.com</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>执行过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt; Entering AgentChain...</span><br><span class="line"></span><br><span class="line">Thought: 需要先分析数据，然后生成图表，最后发送报告</span><br><span class="line"></span><br><span class="line">Action: AnalyzeData</span><br><span class="line">Action Input: sales_data.csv</span><br><span class="line">Observation: </span><br><span class="line">       销售额      数量</span><br><span class="line">count   12.0    12.0</span><br><span class="line">mean   8500.0   85.0</span><br><span class="line">std    1200.0   15.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Thought: 数据已分析，现在生成柱状图</span><br><span class="line"></span><br><span class="line">Action: VisualizeData</span><br><span class="line">Action Input: &#123;&quot;data_path&quot;: &quot;sales_data.csv&quot;, &quot;chart_type&quot;: &quot;bar&quot;&#125;</span><br><span class="line">Observation: 图表已保存到 chart.png</span><br><span class="line"></span><br><span class="line">Thought: 准备发送报告</span><br><span class="line"></span><br><span class="line">Action: SendReport</span><br><span class="line">Action Input: &#123;</span><br><span class="line">  &quot;recipient&quot;: &quot;manager@company.com&quot;,</span><br><span class="line">  &quot;content&quot;: &quot;销售数据分析完成，平均销售额8500，详见附件图表&quot;</span><br><span class="line">&#125;</span><br><span class="line">Observation: 报告已发送给 manager@company.com</span><br><span class="line"></span><br><span class="line">Final Answer: 任务已完成。已分析数据，生成图表，并发送报告。</span><br></pre></td></tr></table></figure>
<h3 id="动态工具发现">动态工具发现</h3>
<p>更高级的 Agent 能够<strong>自动发现和学习新工具</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ToolRegistry</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.tools = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">self, tool_spec</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册新工具&quot;&quot;&quot;</span></span><br><span class="line">        self.tools[tool_spec[<span class="string">&quot;name&quot;</span>]] = &#123;</span><br><span class="line">            <span class="string">&quot;function&quot;</span>: tool_spec[<span class="string">&quot;function&quot;</span>],</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: tool_spec[<span class="string">&quot;description&quot;</span>],</span><br><span class="line">            <span class="string">&quot;parameters&quot;</span>: tool_spec[<span class="string">&quot;parameters&quot;</span>],</span><br><span class="line">            <span class="string">&quot;examples&quot;</span>: tool_spec.get(<span class="string">&quot;examples&quot;</span>, [])</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">discover</span>(<span class="params">self, task_description</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据任务描述推荐工具&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line">        <span class="keyword">from</span> sentence_transformers <span class="keyword">import</span> SentenceTransformer</span><br><span class="line">        </span><br><span class="line">        model = SentenceTransformer(<span class="string">&#x27;all-MiniLM-L6-v2&#x27;</span>)</span><br><span class="line">        task_embedding = model.encode([task_description])</span><br><span class="line">        </span><br><span class="line">        tool_descriptions = [</span><br><span class="line">            self.tools[name][<span class="string">&quot;description&quot;</span>] </span><br><span class="line">            <span class="keyword">for</span> name <span class="keyword">in</span> self.tools</span><br><span class="line">        ]</span><br><span class="line">        tool_embeddings = model.encode(tool_descriptions)</span><br><span class="line">        </span><br><span class="line">        similarities = cosine_similarity(task_embedding, tool_embeddings)[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回最相关的工具</span></span><br><span class="line">        top_indices = similarities.argsort()[-<span class="number">3</span>:][::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">list</span>(self.tools.keys())[i] <span class="keyword">for</span> i <span class="keyword">in</span> top_indices]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">registry = ToolRegistry()</span><br><span class="line"></span><br><span class="line">registry.register(&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;weather_api&quot;</span>,</span><br><span class="line">    <span class="string">&quot;function&quot;</span>: get_weather,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;获取城市天气信息&quot;</span>,</span><br><span class="line">    <span class="string">&quot;parameters&quot;</span>: &#123;<span class="string">&quot;city&quot;</span>: <span class="string">&quot;string&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;examples&quot;</span>: [<span class="string">&quot;北京天气如何&quot;</span>, <span class="string">&quot;上海明天会下雨吗&quot;</span>]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态发现</span></span><br><span class="line">recommended = registry.discover(<span class="string">&quot;我想知道深圳的气温&quot;</span>)</span><br><span class="line"><span class="comment"># 返回：[&quot;weather_api&quot;, ...]</span></span><br></pre></td></tr></table></figure>
<h2 id="核心能力四反思reflection">核心能力四：反思（Reflection）</h2>
<p>反思是 Agent 从错误中学习、持续改进的能力。没有反思，Agent
会重复同样的错误；有了反思，Agent 能够自我纠正、优化策略。</p>
<h3 id="为什么需要反思">为什么需要反思</h3>
<p>人类解决问题时会不断反思： - "这个方法不work，换个思路试试" -
"上次失败是因为参数设置不对" - "这个策略在类似场景下效果更好"</p>
<p>Agent 同样需要这种元认知能力。</p>
<h3 id="self-refine迭代优化">Self-Refine：迭代优化</h3>
<p><strong>Self-Refine</strong> 是最简单的反思模式：生成→评估→改进。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SelfRefineAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成初始输出&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;任务：<span class="subst">&#123;task&#125;</span>\n请给出解决方案：&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">self, task, output</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;评估输出质量&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        当前方案：<span class="subst">&#123;output&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请评估这个方案，指出存在的问题和改进方向。</span></span><br><span class="line"><span class="string">        按以下格式回答：</span></span><br><span class="line"><span class="string">        评分（1-10）：</span></span><br><span class="line"><span class="string">        问题：</span></span><br><span class="line"><span class="string">        改进建议：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">refine</span>(<span class="params">self, task, output, feedback</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据反馈改进&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        当前方案：<span class="subst">&#123;output&#125;</span></span></span><br><span class="line"><span class="string">        反馈意见：<span class="subst">&#123;feedback&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请根据反馈改进方案：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, task, max_iterations=<span class="number">3</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;迭代优化&quot;&quot;&quot;</span></span><br><span class="line">        output = self.generate(task)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(max_iterations):</span><br><span class="line">            feedback = self.evaluate(task, output)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 解析评分</span></span><br><span class="line">            score = self.parse_score(feedback)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;迭代 <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>，评分：<span class="subst">&#123;score&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> score &gt;= <span class="number">8</span>:</span><br><span class="line">                <span class="keyword">break</span>  <span class="comment"># 质量足够好</span></span><br><span class="line">            </span><br><span class="line">            output = self.refine(task, output, feedback)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>
<p>应用示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">agent = SelfRefineAgent(ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>))</span><br><span class="line"></span><br><span class="line">result = agent.run(<span class="string">&quot;写一个Python函数，计算斐波那契数列&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出过程：</span></span><br><span class="line"><span class="comment"># 迭代1，评分：5（初始代码效率低）</span></span><br><span class="line"><span class="comment"># 迭代2，评分：7（改用动态规划，但缺少注释）</span></span><br><span class="line"><span class="comment"># 迭代3，评分：9（添加详细注释和类型提示）</span></span><br></pre></td></tr></table></figure>
<h3 id="reflexion从失败中学习">Reflexion：从失败中学习</h3>
<p><strong>Reflexion</strong> 框架更进一步，让 Agent
从失败案例中提取教训。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReflexionAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">        self.memory = []  <span class="comment"># 存储失败案例和反思</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">act</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检索相关的历史反思</span></span><br><span class="line">        relevant_reflections = self.retrieve_reflections(task)</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        历史经验：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_reflections(relevant_reflections)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请制定执行计划：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        plan = self.llm(prompt)</span><br><span class="line">        result = self.execute(plan)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reflect</span>(<span class="params">self, task, trajectory, result</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;反思执行过程&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        执行轨迹：<span class="subst">&#123;trajectory&#125;</span></span></span><br><span class="line"><span class="string">        最终结果：<span class="subst">&#123;result&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请分析：</span></span><br><span class="line"><span class="string">        1. 哪些步骤是正确的？</span></span><br><span class="line"><span class="string">        2. 哪些步骤出了问题？</span></span><br><span class="line"><span class="string">        3. 为什么会失败？</span></span><br><span class="line"><span class="string">        4. 下次应该怎么做？</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请给出具体的反思和改进建议：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        reflection = self.llm(prompt)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 存入记忆</span></span><br><span class="line">        self.memory.append(&#123;</span><br><span class="line">            <span class="string">&quot;task&quot;</span>: task,</span><br><span class="line">            <span class="string">&quot;reflection&quot;</span>: reflection,</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: datetime.now()</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> reflection</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_with_retry</span>(<span class="params">self, task, max_attempts=<span class="number">3</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;带重试的执行&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(max_attempts):</span><br><span class="line">            trajectory = []</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result = self.act(task)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> self.is_successful(result):</span><br><span class="line">                    <span class="keyword">return</span> result</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># 失败，进行反思</span></span><br><span class="line">                    reflection = self.reflect(task, trajectory, result)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;尝试 <span class="subst">&#123;attempt+<span class="number">1</span>&#125;</span> 失败，反思：<span class="subst">&#123;reflection&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                reflection = self.reflect(task, trajectory, <span class="built_in">str</span>(e))</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;尝试 <span class="subst">&#123;attempt+<span class="number">1</span>&#125;</span> 出错，反思：<span class="subst">&#123;reflection&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<h3 id="rise结构化的错误分析">RISE：结构化的错误分析</h3>
<p><strong>RISE (Reflective Iterative Self-Evaluation)</strong>
提供更结构化的反思框架：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RISEAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_with_rise</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="comment"># 阶段1：初始执行</span></span><br><span class="line">        output = self.initial_attempt(task)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段2：识别错误（Recognize）</span></span><br><span class="line">        errors = self.recognize_errors(task, output)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> errors:</span><br><span class="line">            <span class="keyword">return</span> output</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段3：调查原因（Investigate）</span></span><br><span class="line">        root_causes = self.investigate_causes(errors)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段4：策略制定（Strategize）</span></span><br><span class="line">        strategy = self.formulate_strategy(root_causes)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 阶段5：执行改进（Execute）</span></span><br><span class="line">        improved_output = self.execute_strategy(task, strategy)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> improved_output</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recognize_errors</span>(<span class="params">self, task, output</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;识别错误&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        输出：<span class="subst">&#123;output&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请列出所有存在的错误或不足：</span></span><br><span class="line"><span class="string">        1.</span></span><br><span class="line"><span class="string">        2.</span></span><br><span class="line"><span class="string">        3.</span></span><br><span class="line"><span class="string">        ...</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">investigate_causes</span>(<span class="params">self, errors</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;调查根本原因&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        发现的错误：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;errors&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请使用&quot;5个为什么&quot;分析法，找出根本原因：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        错误1：</span></span><br><span class="line"><span class="string">        - 为什么？</span></span><br><span class="line"><span class="string">        - 为什么？</span></span><br><span class="line"><span class="string">        - ...</span></span><br><span class="line"><span class="string">        - 根本原因：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        错误2：</span></span><br><span class="line"><span class="string">        ...</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">formulate_strategy</span>(<span class="params">self, root_causes</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;制定改进策略&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        根本原因：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;root_causes&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请为每个根本原因制定具体的改进策略：</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        原因1 → 策略1：</span></span><br><span class="line"><span class="string">        原因2 → 策略2：</span></span><br><span class="line"><span class="string">        ...</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br></pre></td></tr></table></figure>
<h3 id="基于奖励模型的反思">基于奖励模型的反思</h3>
<p>更高级的反思可以使用<strong>奖励模型</strong>来量化输出质量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> transformers <span class="keyword">import</span> AutoModelForSequenceClassification, AutoTokenizer</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RewardBasedReflection</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm, reward_model_name</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">        self.reward_model = AutoModelForSequenceClassification.from_pretrained(</span><br><span class="line">            reward_model_name</span><br><span class="line">        )</span><br><span class="line">        self.tokenizer = AutoTokenizer.from_pretrained(reward_model_name)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_reward</span>(<span class="params">self, task, output</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算输出的奖励分数&quot;&quot;&quot;</span></span><br><span class="line">        input_text = <span class="string">f&quot;任务：<span class="subst">&#123;task&#125;</span>\n输出：<span class="subst">&#123;output&#125;</span>&quot;</span></span><br><span class="line">        inputs = self.tokenizer(input_text, return_tensors=<span class="string">&quot;pt&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            reward = self.reward_model(**inputs).logits[<span class="number">0</span>][<span class="number">0</span>].item()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> reward</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">optimize_with_reward</span>(<span class="params">self, task, num_samples=<span class="number">5</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成多个候选，选择奖励最高的&quot;&quot;&quot;</span></span><br><span class="line">        candidates = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(num_samples):</span><br><span class="line">            output = self.llm(task)</span><br><span class="line">            reward = self.compute_reward(task, output)</span><br><span class="line">            candidates.append((output, reward))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 选择最佳输出</span></span><br><span class="line">        best_output, best_reward = <span class="built_in">max</span>(candidates, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 反思：分析为什么这个输出更好</span></span><br><span class="line">        reflection = self.analyze_best_output(task, candidates, best_output)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> best_output, reflection</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_best_output</span>(<span class="params">self, task, all_candidates, best</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;分析最佳输出的特点&quot;&quot;&quot;</span></span><br><span class="line">        others = [c[<span class="number">0</span>] <span class="keyword">for</span> c <span class="keyword">in</span> all_candidates <span class="keyword">if</span> c[<span class="number">0</span>] != best]</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        最佳输出：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;best&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        其他候选：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;<span class="built_in">chr</span>(<span class="number">10</span>).join(others)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请分析最佳输出为什么更好，总结其特点：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br></pre></td></tr></table></figure>
<h3 id="协作式反思">协作式反思</h3>
<p>在多 Agent 系统中，Agent 之间可以互相反思：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CollaborativeReflection</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agents</span>):</span><br><span class="line">        self.agents = agents</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">peer_review</span>(<span class="params">self, task, outputs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;同行评审&quot;&quot;&quot;</span></span><br><span class="line">        reviews = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> agent_id, output <span class="keyword">in</span> outputs.items():</span><br><span class="line">            reviews[agent_id] = []</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 其他agent评审这个输出</span></span><br><span class="line">            <span class="keyword">for</span> reviewer_id, reviewer <span class="keyword">in</span> self.agents.items():</span><br><span class="line">                <span class="keyword">if</span> reviewer_id != agent_id:</span><br><span class="line">                    review = reviewer.review(task, output)</span><br><span class="line">                    reviews[agent_id].append(&#123;</span><br><span class="line">                        <span class="string">&quot;reviewer&quot;</span>: reviewer_id,</span><br><span class="line">                        <span class="string">&quot;feedback&quot;</span>: review</span><br><span class="line">                    &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> reviews</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">consensus_reflection</span>(<span class="params">self, task, outputs, reviews</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;基于评审达成共识&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 汇总所有反馈</span></span><br><span class="line">        all_feedback = []</span><br><span class="line">        <span class="keyword">for</span> agent_reviews <span class="keyword">in</span> reviews.values():</span><br><span class="line">            all_feedback.extend([r[<span class="string">&quot;feedback&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> agent_reviews])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成共识性的反思</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        各Agent的输出：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_outputs(outputs)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        收到的反馈：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;<span class="built_in">chr</span>(<span class="number">10</span>).join(all_feedback)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请综合所有反馈，总结：</span></span><br><span class="line"><span class="string">        1. 达成共识的优秀做法</span></span><br><span class="line"><span class="string">        2. 存在争议的问题</span></span><br><span class="line"><span class="string">        3. 改进建议</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        consensus = self.agents[<span class="number">0</span>].llm(prompt)</span><br><span class="line">        <span class="keyword">return</span> consensus</span><br></pre></td></tr></table></figure>
<p>反思能力让 Agent
不再是"一次性"的执行者，而是能够持续学习和改进的智能系统。</p>
<h2 id="主流框架实现">主流框架实现</h2>
<p>理解了核心能力后，让我们看看如何用现有框架快速构建 Agent。</p>
<h3 id="langchain最流行的-agent-框架">LangChain：最流行的 Agent
框架</h3>
<p><strong>LangChain</strong> 是目前最广泛使用的 Agent
框架，提供了丰富的组件和预置模板。</p>
<h4 id="基础-agent-构建">基础 Agent 构建</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor, create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate, MessagesPlaceholder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义工具</span></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>(<span class="params">query: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;搜索互联网信息&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 实际应调用搜索API</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;搜索结果：<span class="subst">&#123;query&#125;</span> 的相关信息...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculator</span>(<span class="params">expression: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;执行数学计算&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = <span class="built_in">eval</span>(expression)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;计算结果：<span class="subst">&#123;result&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;计算错误&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建prompt模板</span></span><br><span class="line">prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;你是一个有用的助手，可以使用工具来回答问题。&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;agent_scratchpad&quot;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化LLM和工具</span></span><br><span class="line">llm = ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">tools = [search, calculator]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Agent</span></span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt)</span><br><span class="line">executor = AgentExecutor(</span><br><span class="line">    agent=agent,</span><br><span class="line">    tools=tools,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    max_iterations=<span class="number">5</span>,</span><br><span class="line">    handle_parsing_errors=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">result = executor.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;input&quot;</span>: <span class="string">&quot;搜索2024年诺贝尔物理学奖获得者，并计算他们的平均年龄&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="带记忆的-agent">带记忆的 Agent</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ConversationBufferMemory</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建记忆</span></span><br><span class="line">memory = ConversationBufferMemory(</span><br><span class="line">    memory_key=<span class="string">&quot;chat_history&quot;</span>,</span><br><span class="line">    return_messages=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带记忆的prompt</span></span><br><span class="line">prompt_with_memory = ChatPromptTemplate.from_messages([</span><br><span class="line">    (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;你是一个有用的助手。&quot;</span>),</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),</span><br><span class="line">    (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">    MessagesPlaceholder(variable_name=<span class="string">&quot;agent_scratchpad&quot;</span>)</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Agent</span></span><br><span class="line">agent = create_openai_functions_agent(llm, tools, prompt_with_memory)</span><br><span class="line">executor = AgentExecutor(</span><br><span class="line">    agent=agent,</span><br><span class="line">    tools=tools,</span><br><span class="line">    memory=memory,</span><br><span class="line">    verbose=<span class="literal">True</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多轮对话</span></span><br><span class="line">executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;我喜欢Python编程&quot;</span>&#125;)</span><br><span class="line">executor.invoke(&#123;<span class="string">&quot;input&quot;</span>: <span class="string">&quot;推荐一些学习资源&quot;</span>&#125;)  <span class="comment"># Agent会记住你喜欢Python</span></span><br></pre></td></tr></table></figure>
<h3 id="langgraph流程编排的新范式">LangGraph：流程编排的新范式</h3>
<p><strong>LangGraph</strong> 是 LangChain
团队推出的新框架，用图结构来定义 Agent 的执行流程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, END</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict, Annotated, <span class="type">Sequence</span></span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义状态</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentState</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    messages: Annotated[<span class="type">Sequence</span>[BaseMessage], operator.add]</span><br><span class="line">    next_action: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义节点</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_model</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;调用LLM&quot;&quot;&quot;</span></span><br><span class="line">    messages = state[<span class="string">&quot;messages&quot;</span>]</span><br><span class="line">    response = llm.invoke(messages)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [response]&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_tool</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;执行工具&quot;&quot;&quot;</span></span><br><span class="line">    last_message = state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line">    tool_call = last_message.tool_calls[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行工具</span></span><br><span class="line">    tool_output = tools[tool_call[<span class="string">&quot;name&quot;</span>]].invoke(tool_call[<span class="string">&quot;args&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;messages&quot;</span>: [ToolMessage(</span><br><span class="line">        content=tool_output,</span><br><span class="line">        tool_call_id=tool_call[<span class="string">&quot;id&quot;</span>]</span><br><span class="line">    )]&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">should_continue</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;决定是否继续&quot;&quot;&quot;</span></span><br><span class="line">    last_message = state[<span class="string">&quot;messages&quot;</span>][-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(last_message, <span class="string">&quot;tool_calls&quot;</span>) <span class="keyword">and</span> last_message.tool_calls:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;continue&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;end&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建图</span></span><br><span class="line">workflow = StateGraph(AgentState)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加节点</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;agent&quot;</span>, call_model)</span><br><span class="line">workflow.add_node(<span class="string">&quot;tools&quot;</span>, call_tool)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置入口</span></span><br><span class="line">workflow.set_entry_point(<span class="string">&quot;agent&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加边</span></span><br><span class="line">workflow.add_conditional_edges(</span><br><span class="line">    <span class="string">&quot;agent&quot;</span>,</span><br><span class="line">    should_continue,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;continue&quot;</span>: <span class="string">&quot;tools&quot;</span>,</span><br><span class="line">        <span class="string">&quot;end&quot;</span>: END</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;tools&quot;</span>, <span class="string">&quot;agent&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">app = workflow.<span class="built_in">compile</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">result = app.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;messages&quot;</span>: [HumanMessage(content=<span class="string">&quot;北京今天天气如何？&quot;</span>)]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>LangGraph 的优势： - <strong>可视化</strong>：流程图一目了然 -
<strong>灵活</strong>：支持复杂的条件分支和循环 -
<strong>调试友好</strong>：每个节点的状态都可追踪</p>
<h3 id="autogpt自主任务规划">AutoGPT：自主任务规划</h3>
<p><strong>AutoGPT</strong> 是最早引起轰动的自主 Agent
项目。其核心思想：让 GPT-4 自己给自己分配任务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AutoGPTAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm, tools, memory</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">        self.tools = tools</span><br><span class="line">        self.memory = memory</span><br><span class="line">        self.task_list = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行AutoGPT主循环&quot;&quot;&quot;</span></span><br><span class="line">        self.task_list = [&#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;task&quot;</span>: goal&#125;]</span><br><span class="line">        completed_tasks = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> self.task_list:</span><br><span class="line">            <span class="comment"># 获取当前任务</span></span><br><span class="line">            current_task = self.task_list.pop(<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n执行任务：<span class="subst">&#123;current_task[<span class="string">&#x27;task&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成新任务</span></span><br><span class="line">            new_tasks = self.generate_new_tasks(</span><br><span class="line">                current_task,</span><br><span class="line">                completed_tasks,</span><br><span class="line">                goal</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行当前任务</span></span><br><span class="line">            result = self.execute_task(current_task[<span class="string">&#x27;task&#x27;</span>])</span><br><span class="line">            completed_tasks.append(&#123;</span><br><span class="line">                <span class="string">&quot;task&quot;</span>: current_task[<span class="string">&#x27;task&#x27;</span>],</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: result</span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 优先级排序</span></span><br><span class="line">            self.task_list = self.prioritize_tasks(</span><br><span class="line">                self.task_list + new_tasks,</span><br><span class="line">                goal</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查是否完成目标</span></span><br><span class="line">            <span class="keyword">if</span> self.check_goal_completion(goal, completed_tasks):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> completed_tasks</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_new_tasks</span>(<span class="params">self, current_task, completed_tasks, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;生成新任务&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        总目标：<span class="subst">&#123;goal&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        当前任务：<span class="subst">&#123;current_task[<span class="string">&#x27;task&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        已完成任务：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_tasks(completed_tasks)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        基于当前任务的结果，生成接下来需要完成的新任务列表。</span></span><br><span class="line"><span class="string">        每个任务应该是独立可执行的。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        以JSON格式返回：</span></span><br><span class="line"><span class="string">        [</span></span><br><span class="line"><span class="string">            &#123;&#123;&quot;id&quot;: 1, &quot;task&quot;: &quot;任务描述&quot;&#125;&#125;,</span></span><br><span class="line"><span class="string">            &#123;&#123;&quot;id&quot;: 2, &quot;task&quot;: &quot;任务描述&quot;&#125;&#125;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self.llm(prompt)</span><br><span class="line">        <span class="keyword">return</span> json.loads(response)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_task</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行单个任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检索相关记忆</span></span><br><span class="line">        context = self.memory.search(task)</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        相关上下文：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;context&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        可用工具：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_tools()&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请完成这个任务，返回执行结果。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        result = self.llm_with_tools(prompt)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 存入记忆</span></span><br><span class="line">        self.memory.add(<span class="string">f&quot;任务：<span class="subst">&#123;task&#125;</span>\n结果：<span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">prioritize_tasks</span>(<span class="params">self, tasks, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;任务优先级排序&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        总目标：<span class="subst">&#123;goal&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        待完成任务：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_tasks(tasks)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请对这些任务按优先级排序，考虑：</span></span><br><span class="line"><span class="string">        1. 哪些任务对实现目标最关键</span></span><br><span class="line"><span class="string">        2. 哪些任务有依赖关系</span></span><br><span class="line"><span class="string">        3. 哪些任务可以并行</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        返回排序后的任务列表（JSON格式）：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self.llm(prompt)</span><br><span class="line">        <span class="keyword">return</span> json.loads(response)</span><br></pre></td></tr></table></figure>
<p>使用示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">agent = AutoGPTAgent(</span><br><span class="line">    llm=ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>),</span><br><span class="line">    tools=[search, calculator, file_ops],</span><br><span class="line">    memory=VectorMemory()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">result = agent.run(<span class="string">&quot;研究并总结2024年AI领域的重大突破&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AutoGPT会自主分解任务：</span></span><br><span class="line"><span class="comment"># 任务1：搜索2024年AI领域的新闻</span></span><br><span class="line"><span class="comment"># 任务2：筛选重大突破</span></span><br><span class="line"><span class="comment"># 任务3：深入研究每个突破</span></span><br><span class="line"><span class="comment"># 任务4：撰写总结报告</span></span><br><span class="line"><span class="comment"># 任务5：保存到文件</span></span><br></pre></td></tr></table></figure>
<p>AutoGPT 的问题： - <strong>成本高</strong>：每个决策都要调用 LLM -
<strong>不稳定</strong>：容易陷入死循环或偏离目标 -
<strong>难控制</strong>：自主性太强，不易干预</p>
<h3 id="babyagi任务管理的极简实现">BabyAGI：任务管理的极简实现</h3>
<p><strong>BabyAGI</strong> 是 AutoGPT 的简化版，核心只有 140
行代码，但包含了关键思想。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BabyAGI</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm, vectorstore</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">        self.vectorstore = vectorstore</span><br><span class="line">        self.task_queue = deque([])</span><br><span class="line">        self.task_id_counter = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_task</span>(<span class="params">self, task_description</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;添加任务到队列&quot;&quot;&quot;</span></span><br><span class="line">        task = &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: self.task_id_counter,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: task_description</span><br><span class="line">        &#125;</span><br><span class="line">        self.task_queue.append(task)</span><br><span class="line">        self.task_id_counter += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_task</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检索相关上下文</span></span><br><span class="line">        context = self.vectorstore.similarity_search(</span><br><span class="line">            task[<span class="string">&quot;description&quot;</span>], k=<span class="number">5</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        任务：<span class="subst">&#123;task[<span class="string">&#x27;description&#x27;</span>]&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        上下文：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_context(context)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请完成这个任务：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        result = self.llm(prompt)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 存储结果</span></span><br><span class="line">        self.vectorstore.add_texts([</span><br><span class="line">            <span class="string">f&quot;任务：<span class="subst">&#123;task[<span class="string">&#x27;description&#x27;</span>]&#125;</span>\n结果：<span class="subst">&#123;result&#125;</span>&quot;</span></span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_new_tasks</span>(<span class="params">self, result, task_description, objective</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;基于结果创建新任务&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        你是一个任务创建AI。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        目标：<span class="subst">&#123;objective&#125;</span></span></span><br><span class="line"><span class="string">        上一个任务：<span class="subst">&#123;task_description&#125;</span></span></span><br><span class="line"><span class="string">        上一个任务的结果：<span class="subst">&#123;result&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        当前任务列表：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_task_queue()&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        基于结果，创建新的任务来帮助实现目标。</span></span><br><span class="line"><span class="string">        不要创建重复的任务。</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        以JSON数组格式返回新任务：</span></span><br><span class="line"><span class="string">        [&quot;任务1&quot;, &quot;任务2&quot;, ...]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self.llm(prompt)</span><br><span class="line">        new_tasks = json.loads(response)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> new_tasks:</span><br><span class="line">            self.add_task(task)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">prioritize_tasks</span>(<span class="params">self, objective</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;重新排列任务优先级&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        目标：<span class="subst">&#123;objective&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        当前任务列表：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_task_queue()&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请对任务重新排序，把最重要的任务放在前面。</span></span><br><span class="line"><span class="string">        返回排序后的任务ID列表（JSON数组）：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self.llm(prompt)</span><br><span class="line">        task_ids = json.loads(response)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重新排列队列</span></span><br><span class="line">        new_queue = deque([])</span><br><span class="line">        <span class="keyword">for</span> tid <span class="keyword">in</span> task_ids:</span><br><span class="line">            <span class="keyword">for</span> task <span class="keyword">in</span> self.task_queue:</span><br><span class="line">                <span class="keyword">if</span> task[<span class="string">&quot;id&quot;</span>] == tid:</span><br><span class="line">                    new_queue.append(task)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        self.task_queue = new_queue</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, objective, max_iterations=<span class="number">10</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;主循环&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 添加初始任务</span></span><br><span class="line">        self.add_task(objective)</span><br><span class="line">        </span><br><span class="line">        iteration = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> self.task_queue <span class="keyword">and</span> iteration &lt; max_iterations:</span><br><span class="line">            iteration += <span class="number">1</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 执行队首任务</span></span><br><span class="line">            task = self.task_queue.popleft()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n[<span class="subst">&#123;iteration&#125;</span>] 执行：<span class="subst">&#123;task[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            result = self.execute_task(task)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;结果：<span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 创建新任务</span></span><br><span class="line">            self.create_new_tasks(result, task[<span class="string">&quot;description&quot;</span>], objective)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 重新排序</span></span><br><span class="line">            <span class="keyword">if</span> self.task_queue:</span><br><span class="line">                self.prioritize_tasks(objective)</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n任务完成！&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="agents模块化的框架设计">AGENTS：模块化的框架设计</h3>
<p>AGENTS 框架提供了更模块化的设计：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> ABC, abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 抽象基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Agent</span>(<span class="title class_ inherited__">ABC</span>):</span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perceive</span>(<span class="params">self, observation</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;感知环境&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">plan</span>(<span class="params">self, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;制定计划&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">act</span>(<span class="params">self, action</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行动作&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reflect</span>(<span class="params">self, feedback</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;反思改进&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResearchAgent</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, llm, tools, memory</span>):</span><br><span class="line">        self.llm = llm</span><br><span class="line">        self.tools = tools</span><br><span class="line">        self.memory = memory</span><br><span class="line">        self.current_plan = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perceive</span>(<span class="params">self, observation</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理观察到的信息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 提取关键信息</span></span><br><span class="line">        summary = self.llm(<span class="string">f&quot;总结以下信息：\n<span class="subst">&#123;observation&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新记忆</span></span><br><span class="line">        self.memory.add(summary)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> summary</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">plan</span>(<span class="params">self, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;制定研究计划&quot;&quot;&quot;</span></span><br><span class="line">        context = self.memory.recall(goal)</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        研究目标：<span class="subst">&#123;goal&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        已知信息：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;context&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请制定详细的研究计划，包括：</span></span><br><span class="line"><span class="string">        1. 需要搜索的关键词</span></span><br><span class="line"><span class="string">        2. 需要阅读的文献</span></span><br><span class="line"><span class="string">        3. 需要验证的假设</span></span><br><span class="line"><span class="string">        4. 预期的输出</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        self.current_plan = self.llm(prompt)</span><br><span class="line">        <span class="keyword">return</span> self.current_plan</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">act</span>(<span class="params">self, action</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行研究动作&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> action[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;search&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.tools[<span class="string">&quot;search&quot;</span>](action[<span class="string">&quot;query&quot;</span>])</span><br><span class="line">        <span class="keyword">elif</span> action[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;read&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.tools[<span class="string">&quot;read&quot;</span>](action[<span class="string">&quot;url&quot;</span>])</span><br><span class="line">        <span class="keyword">elif</span> action[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;analyze&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.llm(<span class="string">f&quot;分析：<span class="subst">&#123;action[<span class="string">&#x27;content&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reflect</span>(<span class="params">self, feedback</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;反思研究过程&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        原计划：<span class="subst">&#123;self.current_plan&#125;</span></span></span><br><span class="line"><span class="string">        反馈：<span class="subst">&#123;feedback&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请反思：</span></span><br><span class="line"><span class="string">        1. 计划执行得如何？</span></span><br><span class="line"><span class="string">        2. 遇到了什么问题？</span></span><br><span class="line"><span class="string">        3. 应该如何调整？</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        reflection = self.llm(prompt)</span><br><span class="line">        self.memory.add(<span class="string">f&quot;反思：<span class="subst">&#123;reflection&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> reflection</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;完整的研究流程&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 制定计划</span></span><br><span class="line">        plan = self.plan(goal)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行计划</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> step <span class="keyword">in</span> self.parse_plan(plan):</span><br><span class="line">            observation = self.act(step)</span><br><span class="line">            summary = self.perceive(observation)</span><br><span class="line">            results.append(summary)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 反思改进</span></span><br><span class="line">        feedback = self.evaluate_results(results)</span><br><span class="line">        self.reflect(feedback)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 生成最终报告</span></span><br><span class="line">        report = self.generate_report(goal, results)</span><br><span class="line">        <span class="keyword">return</span> report</span><br></pre></td></tr></table></figure>
<p>各框架对比：</p>
<table>
<thead>
<tr>
<th>框架</th>
<th>优势</th>
<th>劣势</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LangChain</strong></td>
<td>生态丰富、易上手</td>
<td>抽象层次复杂</td>
<td>通用Agent快速开发</td>
</tr>
<tr>
<td><strong>LangGraph</strong></td>
<td>流程可视化、灵活</td>
<td>学习曲线陡峭</td>
<td>复杂流程编排</td>
</tr>
<tr>
<td><strong>AutoGPT</strong></td>
<td>高度自主</td>
<td>成本高、不稳定</td>
<td>探索性任务</td>
</tr>
<tr>
<td><strong>BabyAGI</strong></td>
<td>简单清晰</td>
<td>功能有限</td>
<td>学习和原型</td>
</tr>
<tr>
<td><strong>AGENTS</strong></td>
<td>模块化、可扩展</td>
<td>需要自己实现很多</td>
<td>定制化需求</td>
</tr>
</tbody>
</table>
<h2 id="多-agent-协作">多 Agent 协作</h2>
<p>单个 Agent 能力有限，多个 Agent
协作能解决更复杂的问题。就像一个团队，不同成员各司其职，协同完成任务。</p>
<h3 id="为什么需要多-agent">为什么需要多 Agent</h3>
<p>考虑"写一本技术书"这个任务： -
<strong>研究员Agent</strong>：收集资料、调研技术 -
<strong>作者Agent</strong>：撰写章节内容 -
<strong>编辑Agent</strong>：审阅和修改 -
<strong>设计师Agent</strong>：制作配图和排版</p>
<p>每个 Agent 专注于自己擅长的领域，协作效率远超单个全能 Agent。</p>
<h3 id="multi-agent-debate辩论式协作">Multi-Agent
Debate：辩论式协作</h3>
<p>让多个 Agent 对同一问题展开辩论，通过思想碰撞得到更好的答案。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DebateAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, llm, stance</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.llm = llm</span><br><span class="line">        self.stance = stance</span><br><span class="line">        self.arguments = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_argument</span>(<span class="params">self, topic, opponent_arguments</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提出论点&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        辩题：<span class="subst">&#123;topic&#125;</span></span></span><br><span class="line"><span class="string">        你的立场：<span class="subst">&#123;self.stance&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        对方的论点：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;<span class="built_in">chr</span>(<span class="number">10</span>).join(opponent_arguments)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请提出你的论点，要：</span></span><br><span class="line"><span class="string">        1. 支持自己的立场</span></span><br><span class="line"><span class="string">        2. 反驳对方的观点</span></span><br><span class="line"><span class="string">        3. 提供证据和逻辑</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        argument = self.llm(prompt)</span><br><span class="line">        self.arguments.append(argument)</span><br><span class="line">        <span class="keyword">return</span> argument</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DebateSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agents, judge_llm</span>):</span><br><span class="line">        self.agents = agents</span><br><span class="line">        self.judge_llm = judge_llm</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">debate</span>(<span class="params">self, topic, rounds=<span class="number">3</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;进行辩论&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> round_num <span class="keyword">in</span> <span class="built_in">range</span>(rounds):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n--- 第 <span class="subst">&#123;round_num + <span class="number">1</span>&#125;</span> 轮 ---&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> agent <span class="keyword">in</span> self.agents:</span><br><span class="line">                <span class="comment"># 获取其他Agent的论点</span></span><br><span class="line">                opponent_arguments = [</span><br><span class="line">                    arg <span class="keyword">for</span> other <span class="keyword">in</span> self.agents </span><br><span class="line">                    <span class="keyword">if</span> other != agent</span><br><span class="line">                    <span class="keyword">for</span> arg <span class="keyword">in</span> other.arguments</span><br><span class="line">                ]</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 发表论点</span></span><br><span class="line">                argument = agent.make_argument(topic, opponent_arguments)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;agent.name&#125;</span>：<span class="subst">&#123;argument&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 评委总结</span></span><br><span class="line">        <span class="keyword">return</span> self.judge_debate(topic)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">judge_debate</span>(<span class="params">self, topic</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;评判辩论结果&quot;&quot;&quot;</span></span><br><span class="line">        all_arguments = &#123;</span><br><span class="line">            agent.name: agent.arguments </span><br><span class="line">            <span class="keyword">for</span> agent <span class="keyword">in</span> self.agents</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        辩题：<span class="subst">&#123;topic&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        各方论点：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_arguments(all_arguments)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请作为公正的评委：</span></span><br><span class="line"><span class="string">        1. 总结各方的核心观点</span></span><br><span class="line"><span class="string">        2. 分析论点的优缺点</span></span><br><span class="line"><span class="string">        3. 给出综合结论</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        judgment = self.judge_llm(prompt)</span><br><span class="line">        <span class="keyword">return</span> judgment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">topic = <span class="string">&quot;AI会取代程序员吗？&quot;</span></span><br><span class="line"></span><br><span class="line">agent_pro = DebateAgent(<span class="string">&quot;支持方&quot;</span>, llm, <span class="string">&quot;AI会取代程序员&quot;</span>)</span><br><span class="line">agent_con = DebateAgent(<span class="string">&quot;反对方&quot;</span>, llm, <span class="string">&quot;AI不会取代程序员&quot;</span>)</span><br><span class="line"></span><br><span class="line">debate = DebateSystem([agent_pro, agent_con], judge_llm)</span><br><span class="line">result = debate.debate(topic, rounds=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n评委总结：\n<span class="subst">&#123;result&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="consensus共识机制">Consensus：共识机制</h3>
<p><strong>ReConcile</strong> 等共识框架让多个 Agent
通过投票和协商达成一致。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ConsensusAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, llm</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.llm = llm</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">propose_solution</span>(<span class="params">self, problem</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;提出解决方案&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;问题：<span class="subst">&#123;problem&#125;</span>\n请提出你的解决方案：&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">vote</span>(<span class="params">self, problem, proposals</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;对方案投票&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        问题：<span class="subst">&#123;problem&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        候选方案：</span></span><br><span class="line"><span class="string">        <span class="subst">&#123;self.format_proposals(proposals)&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请投票选择最佳方案，并说明理由。</span></span><br><span class="line"><span class="string">        返回格式：</span></span><br><span class="line"><span class="string">        &#123;&#123;</span></span><br><span class="line"><span class="string">            &quot;choice&quot;: 方案编号,</span></span><br><span class="line"><span class="string">            &quot;reason&quot;: &quot;理由&quot;</span></span><br><span class="line"><span class="string">        &#125;&#125;</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        response = self.llm(prompt)</span><br><span class="line">        <span class="keyword">return</span> json.loads(response)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">revise_solution</span>(<span class="params">self, original, feedback</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;根据反馈修改方案&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        原方案：<span class="subst">&#123;original&#125;</span></span></span><br><span class="line"><span class="string">        反馈意见：<span class="subst">&#123;feedback&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请改进方案：</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReConcileSystem</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, agents</span>):</span><br><span class="line">        self.agents = agents</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reach_consensus</span>(<span class="params">self, problem, max_rounds=<span class="number">5</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;达成共识&quot;&quot;&quot;</span></span><br><span class="line">        proposals = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第一轮：每个Agent提出方案</span></span><br><span class="line">        <span class="keyword">for</span> agent <span class="keyword">in</span> self.agents:</span><br><span class="line">            proposal = agent.propose_solution(problem)</span><br><span class="line">            proposals[agent.name] = proposal</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> round_num <span class="keyword">in</span> <span class="built_in">range</span>(max_rounds):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;\n--- 第 <span class="subst">&#123;round_num + <span class="number">1</span>&#125;</span> 轮投票 ---&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 投票</span></span><br><span class="line">            votes = &#123;&#125;</span><br><span class="line">            <span class="keyword">for</span> agent <span class="keyword">in</span> self.agents:</span><br><span class="line">                vote = agent.vote(problem, proposals)</span><br><span class="line">                votes[agent.name] = vote</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 统计结果</span></span><br><span class="line">            vote_counts = self.count_votes(votes)</span><br><span class="line">            winner = <span class="built_in">max</span>(vote_counts, key=vote_counts.get)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查是否达成共识（超过2/3支持）</span></span><br><span class="line">            <span class="keyword">if</span> vote_counts[winner] &gt;= <span class="built_in">len</span>(self.agents) * <span class="number">2</span> / <span class="number">3</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;\n达成共识！选择方案：<span class="subst">&#123;winner&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> proposals[winner]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 未达成共识，收集反馈并修改方案</span></span><br><span class="line">            feedback = self.collect_feedback(votes)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> agent_name, proposal <span class="keyword">in</span> proposals.items():</span><br><span class="line">                agent = <span class="built_in">next</span>(a <span class="keyword">for</span> a <span class="keyword">in</span> self.agents <span class="keyword">if</span> a.name == agent_name)</span><br><span class="line">                revised = agent.revise_solution(</span><br><span class="line">                    proposal,</span><br><span class="line">                    feedback.get(agent_name, <span class="string">&quot;&quot;</span>)</span><br><span class="line">                )</span><br><span class="line">                proposals[agent_name] = revised</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 未能达成共识，返回得票最多的方案</span></span><br><span class="line">        final_winner = <span class="built_in">max</span>(vote_counts, key=vote_counts.get)</span><br><span class="line">        <span class="keyword">return</span> proposals[final_winner]</span><br></pre></td></tr></table></figure>
<h3 id="down分层协作框架">DOWN：分层协作框架</h3>
<p><strong>DOWN (Divide, Operate, Write, Navigate)</strong>
框架将任务分层：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DOWNFramework</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.coordinator = CoordinatorAgent()  <span class="comment"># 协调者</span></span><br><span class="line">        self.specialists = []  <span class="comment"># 专家Agent列表</span></span><br><span class="line">        self.executor = ExecutorAgent()  <span class="comment"># 执行者</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_specialist</span>(<span class="params">self, specialist</span>):</span><br><span class="line">        self.specialists.append(specialist)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">solve</span>(<span class="params">self, problem</span>):</span><br><span class="line">        <span class="comment"># D: Divide - 分解任务</span></span><br><span class="line">        subtasks = self.coordinator.divide_task(problem)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># O: Operate - 分配给专家</span></span><br><span class="line">        results = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> subtask <span class="keyword">in</span> subtasks:</span><br><span class="line">            specialist = self.select_specialist(subtask)</span><br><span class="line">            result = specialist.operate(subtask)</span><br><span class="line">            results[subtask[<span class="string">&quot;id&quot;</span>]] = result</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># W: Write - 整合结果</span></span><br><span class="line">        integrated = self.coordinator.write_summary(results)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># N: Navigate - 导航下一步</span></span><br><span class="line">        next_action = self.coordinator.navigate(integrated, problem)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> next_action == <span class="string">&quot;complete&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> integrated</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 递归处理</span></span><br><span class="line">            <span class="keyword">return</span> self.solve(next_action)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_specialist</span>(<span class="params">self, subtask</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;选择最适合的专家&quot;&quot;&quot;</span></span><br><span class="line">        scores = []</span><br><span class="line">        <span class="keyword">for</span> specialist <span class="keyword">in</span> self.specialists:</span><br><span class="line">            score = specialist.evaluate_capability(subtask)</span><br><span class="line">            scores.append((specialist, score))</span><br><span class="line">        </span><br><span class="line">        best_specialist, _ = <span class="built_in">max</span>(scores, key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> best_specialist</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义专家Agent</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CodeSpecialist</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_capability</span>(<span class="params">self, subtask</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;代码&quot;</span> <span class="keyword">in</span> subtask[<span class="string">&quot;description&quot;</span>] <span class="keyword">or</span> <span class="string">&quot;编程&quot;</span> <span class="keyword">in</span> subtask[<span class="string">&quot;description&quot;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.9</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">operate</span>(<span class="params">self, subtask</span>):</span><br><span class="line">        <span class="comment"># 编写代码</span></span><br><span class="line">        <span class="keyword">return</span> self.generate_code(subtask[<span class="string">&quot;description&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResearchSpecialist</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_capability</span>(<span class="params">self, subtask</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;调研&quot;</span> <span class="keyword">in</span> subtask[<span class="string">&quot;description&quot;</span>] <span class="keyword">or</span> <span class="string">&quot;搜索&quot;</span> <span class="keyword">in</span> subtask[<span class="string">&quot;description&quot;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.9</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">operate</span>(<span class="params">self, subtask</span>):</span><br><span class="line">        <span class="comment"># 执行调研</span></span><br><span class="line">        <span class="keyword">return</span> self.research(subtask[<span class="string">&quot;description&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">framework = DOWNFramework()</span><br><span class="line">framework.add_specialist(CodeSpecialist())</span><br><span class="line">framework.add_specialist(ResearchSpecialist())</span><br><span class="line"></span><br><span class="line">result = framework.solve(<span class="string">&quot;开发一个天气查询网站&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="metagpt软件公司模拟">MetaGPT：软件公司模拟</h3>
<p><strong>MetaGPT</strong> 模拟了完整的软件团队协作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SoftwareCompany</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.ceo = CEOAgent()</span><br><span class="line">        self.product_manager = ProductManagerAgent()</span><br><span class="line">        self.architect = ArchitectAgent()</span><br><span class="line">        self.engineer = EngineerAgent()</span><br><span class="line">        self.qa = QAAgent()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">develop_product</span>(<span class="params">self, requirement</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;完整的产品开发流程&quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. CEO制定目标</span></span><br><span class="line">        goal = self.ceo.set_goal(requirement)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. PM撰写PRD</span></span><br><span class="line">        prd = self.product_manager.write_prd(goal)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 架构师设计系统</span></span><br><span class="line">        design = self.architect.design_system(prd)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. 工程师实现代码</span></span><br><span class="line">        code = self.engineer.write_code(design)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 5. QA测试</span></span><br><span class="line">        test_results = self.qa.test(code, prd)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 6. 迭代改进</span></span><br><span class="line">        <span class="keyword">if</span> test_results[<span class="string">&quot;pass&quot;</span>]:</span><br><span class="line">            <span class="keyword">return</span> code</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 反馈给工程师修复</span></span><br><span class="line">            fixed_code = self.engineer.fix_bugs(</span><br><span class="line">                code,</span><br><span class="line">                test_results[<span class="string">&quot;issues&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">return</span> self.qa.test(fixed_code, prd)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ProductManagerAgent</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_prd</span>(<span class="params">self, goal</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;撰写产品需求文档&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        产品目标：<span class="subst">&#123;goal&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请撰写详细的PRD，包括：</span></span><br><span class="line"><span class="string">        1. 用户故事</span></span><br><span class="line"><span class="string">        2. 功能列表</span></span><br><span class="line"><span class="string">        3. 非功能需求</span></span><br><span class="line"><span class="string">        4. 验收标准</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArchitectAgent</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">design_system</span>(<span class="params">self, prd</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;设计系统架构&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        PRD：<span class="subst">&#123;prd&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        请设计系统架构，包括：</span></span><br><span class="line"><span class="string">        1. 技术栈选择</span></span><br><span class="line"><span class="string">        2. 模块划分</span></span><br><span class="line"><span class="string">        3. 数据库设计</span></span><br><span class="line"><span class="string">        4. API设计</span></span><br><span class="line"><span class="string">        5. 部署方案</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.llm(prompt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EngineerAgent</span>(<span class="title class_ inherited__">Agent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">write_code</span>(<span class="params">self, design</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;编写代码&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 根据设计逐个模块实现</span></span><br><span class="line">        modules = self.parse_modules(design)</span><br><span class="line">        code = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> modules:</span><br><span class="line">            code[module[<span class="string">&quot;name&quot;</span>]] = self.generate_module_code(module)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> code</span><br></pre></td></tr></table></figure>
<h3 id="agent-通信协议">Agent 通信协议</h3>
<p>多 Agent 系统需要标准化的通信协议：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageType</span>(<span class="title class_ inherited__">Enum</span>):</span><br><span class="line">    REQUEST = <span class="string">&quot;request&quot;</span></span><br><span class="line">    RESPONSE = <span class="string">&quot;response&quot;</span></span><br><span class="line">    BROADCAST = <span class="string">&quot;broadcast&quot;</span></span><br><span class="line">    QUERY = <span class="string">&quot;query&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@dataclass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AgentMessage</span>:</span><br><span class="line">    sender: <span class="built_in">str</span></span><br><span class="line">    receiver: <span class="built_in">str</span></span><br><span class="line">    message_type: MessageType</span><br><span class="line">    content: <span class="built_in">dict</span></span><br><span class="line">    timestamp: datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageBus</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.agents = &#123;&#125;</span><br><span class="line">        self.message_queue = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">register</span>(<span class="params">self, agent</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;注册Agent&quot;&quot;&quot;</span></span><br><span class="line">        self.agents[agent.name] = agent</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, message: AgentMessage</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;发送消息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> message.message_type == MessageType.BROADCAST:</span><br><span class="line">            <span class="comment"># 广播给所有Agent</span></span><br><span class="line">            <span class="keyword">for</span> agent <span class="keyword">in</span> self.agents.values():</span><br><span class="line">                <span class="keyword">if</span> agent.name != message.sender:</span><br><span class="line">                    agent.receive(message)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 点对点发送</span></span><br><span class="line">            receiver = self.agents.get(message.receiver)</span><br><span class="line">            <span class="keyword">if</span> receiver:</span><br><span class="line">                receiver.receive(message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">subscribe</span>(<span class="params">self, agent_name, topic</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;订阅主题&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 实现发布-订阅模式</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Agent基类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommunicatingAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, message_bus</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.message_bus = message_bus</span><br><span class="line">        self.inbox = []</span><br><span class="line">        </span><br><span class="line">        message_bus.register(self)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_message</span>(<span class="params">self, receiver, message_type, content</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;发送消息&quot;&quot;&quot;</span></span><br><span class="line">        message = AgentMessage(</span><br><span class="line">            sender=self.name,</span><br><span class="line">            receiver=receiver,</span><br><span class="line">            message_type=message_type,</span><br><span class="line">            content=content,</span><br><span class="line">            timestamp=datetime.now()</span><br><span class="line">        )</span><br><span class="line">        self.message_bus.send(message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">receive</span>(<span class="params">self, message</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;接收消息&quot;&quot;&quot;</span></span><br><span class="line">        self.inbox.append(message)</span><br><span class="line">        self.process_message(message)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_message</span>(<span class="params">self, message</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理消息&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> message.message_type == MessageType.REQUEST:</span><br><span class="line">            response = self.handle_request(message.content)</span><br><span class="line">            self.send_message(</span><br><span class="line">                message.sender,</span><br><span class="line">                MessageType.RESPONSE,</span><br><span class="line">                response</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>
<p>多 Agent 协作是 AI Agent 技术的前沿，能够解决单个 Agent
难以应对的复杂问题。</p>
<h2 id="评估与基准测试">评估与基准测试</h2>
<p>如何评估一个 Agent 的能力？这需要标准化的基准测试。</p>
<h3 id="agentbench综合能力评估">AgentBench：综合能力评估</h3>
<p><strong>AgentBench</strong> 是首个大规模的 Agent 评估基准，包含 8
个不同环境：</p>
<ol type="1">
<li><strong>操作系统任务</strong>（OS）：文件操作、程序安装</li>
<li><strong>数据库操作</strong>（DB）：SQL查询、数据分析</li>
<li><strong>知识图谱</strong>（KG）：实体关系推理</li>
<li><strong>数字卡牌游戏</strong>（DCG）：策略规划</li>
<li><strong>横向思维谜题</strong>（LTP）：创造性思维</li>
<li><strong>家庭环境导航</strong>（ALFWorld）：多步交互</li>
<li><strong>网页导航</strong>（WebShop）：电商任务</li>
<li><strong>网页问答</strong>（Mind2Web）：复杂交互</li>
</ol>
<p>评估示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 操作系统任务评估</span></span><br><span class="line">task = &#123;</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;在/home/user目录下创建一个名为project的文件夹，并在其中创建README.md&quot;</span>,</span><br><span class="line">    <span class="string">&quot;environment&quot;</span>: <span class="string">&quot;ubuntu_container&quot;</span>,</span><br><span class="line">    <span class="string">&quot;success_criteria&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;目录/home/user/project存在&quot;</span>,</span><br><span class="line">        <span class="string">&quot;文件/home/user/project/README.md存在&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_os_task</span>(<span class="params">agent, task</span>):</span><br><span class="line">    <span class="comment"># 初始化环境</span></span><br><span class="line">    env = DockerEnvironment(<span class="string">&quot;ubuntu:latest&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Agent执行</span></span><br><span class="line">    agent.run(task[<span class="string">&quot;description&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 检查成功标准</span></span><br><span class="line">    success = <span class="built_in">all</span>([</span><br><span class="line">        env.check_condition(criterion)</span><br><span class="line">        <span class="keyword">for</span> criterion <span class="keyword">in</span> task[<span class="string">&quot;success_criteria&quot;</span>]</span><br><span class="line">    ])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;success&quot;</span>: success,</span><br><span class="line">        <span class="string">&quot;steps&quot;</span>: agent.get_trajectory(),</span><br><span class="line">        <span class="string">&quot;cost&quot;</span>: agent.get_token_usage()</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>AgentBench 的评估结果显示： - GPT-4 在大部分任务上表现最好（总分
35.1%） - 开源模型如 LLaMA 明显落后（&lt; 10%） -
所有模型在复杂交互任务上都有很大提升空间</p>
<h3 id="gaia真实世界问答">GAIA：真实世界问答</h3>
<p><strong>GAIA (General AI Assistants)</strong>
基准专注于真实世界的问答任务，特点：</p>
<ul>
<li><strong>需要多步推理</strong>：不是一次搜索就能解决</li>
<li><strong>需要工具使用</strong>：计算器、搜索、代码执行</li>
<li><strong>答案明确</strong>：便于自动评估</li>
</ul>
<p>示例任务：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">gaia_task = &#123;</span><br><span class="line">    <span class="string">&quot;question&quot;</span>: <span class="string">&quot;2023年诺贝尔物理学奖获得者中，哪位的h-index最高？&quot;</span>,</span><br><span class="line">    <span class="string">&quot;level&quot;</span>: <span class="string">&quot;medium&quot;</span>,</span><br><span class="line">    <span class="string">&quot;expected_steps&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;搜索2023年诺贝尔物理学奖获得者&quot;</span>,</span><br><span class="line">        <span class="string">&quot;查询每位获得者的Google Scholar页面&quot;</span>,</span><br><span class="line">        <span class="string">&quot;提取h-index数值&quot;</span>,</span><br><span class="line">        <span class="string">&quot;比较并返回最高者&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;ground_truth&quot;</span>: <span class="string">&quot;Anne L&#x27;Huillier (h-index: 82)&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evaluate_gaia</span>(<span class="params">agent, task</span>):</span><br><span class="line">    answer = agent.run(task[<span class="string">&quot;question&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标准化答案比较</span></span><br><span class="line">    correct = compare_answers(answer, task[<span class="string">&quot;ground_truth&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;correct&quot;</span>: correct,</span><br><span class="line">        <span class="string">&quot;agent_answer&quot;</span>: answer,</span><br><span class="line">        <span class="string">&quot;expected_answer&quot;</span>: task[<span class="string">&quot;ground_truth&quot;</span>]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>GAIA 2</strong> 扩展版加入了更多挑战： -
多模态输入（图片、音频） - 需要隐私保护的个人助手任务 -
长期记忆依赖的场景</p>
<h3 id="agentboard全方位评估">AgentBoard：全方位评估</h3>
<p><strong>AgentBoard</strong> 提供更细粒度的能力评估：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AgentBoard</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate</span>(<span class="params">self, agent</span>):</span><br><span class="line">        scores = &#123;&#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 规划能力</span></span><br><span class="line">        scores[<span class="string">&quot;planning&quot;</span>] = self.test_planning(agent)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 工具使用</span></span><br><span class="line">        scores[<span class="string">&quot;tool_use&quot;</span>] = self.test_tool_use(agent)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 错误恢复</span></span><br><span class="line">        scores[<span class="string">&quot;error_recovery&quot;</span>] = self.test_error_recovery(agent)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. 长期任务</span></span><br><span class="line">        scores[<span class="string">&quot;long_horizon&quot;</span>] = self.test_long_horizon(agent)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 5. 多模态理解</span></span><br><span class="line">        scores[<span class="string">&quot;multimodal&quot;</span>] = self.test_multimodal(agent)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> scores</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_planning</span>(<span class="params">self, agent</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;测试规划能力&quot;&quot;&quot;</span></span><br><span class="line">        tasks = [</span><br><span class="line">            <span class="string">&quot;组织一次10人的户外徒步活动&quot;</span>,</span><br><span class="line">            <span class="string">&quot;规划一周的健康饮食计划&quot;</span>,</span><br><span class="line">            <span class="string">&quot;准备一场技术分享会&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        scores = []</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">            plan = agent.plan(task)</span><br><span class="line">            score = self.evaluate_plan_quality(plan)</span><br><span class="line">            scores.append(score)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(scores) / <span class="built_in">len</span>(scores)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_plan_quality</span>(<span class="params">self, plan</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;评估计划质量&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 检查完整性、合理性、可执行性</span></span><br><span class="line">        criteria = &#123;</span><br><span class="line">            <span class="string">&quot;completeness&quot;</span>: <span class="number">0.3</span>,  <span class="comment"># 步骤是否完整</span></span><br><span class="line">            <span class="string">&quot;feasibility&quot;</span>: <span class="number">0.3</span>,   <span class="comment"># 是否可行</span></span><br><span class="line">            <span class="string">&quot;efficiency&quot;</span>: <span class="number">0.2</span>,    <span class="comment"># 是否高效</span></span><br><span class="line">            <span class="string">&quot;detail&quot;</span>: <span class="number">0.2</span>         <span class="comment"># 细节是否充分</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用评估模型打分</span></span><br><span class="line">        scores = self.evaluator_llm.score(plan, criteria)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sum</span>(scores.values())</span><br></pre></td></tr></table></figure>
<h3 id="自动化评估流程">自动化评估流程</h3>
<p>完整的评估流程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AgentEvaluator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, benchmarks</span>):</span><br><span class="line">        self.benchmarks = benchmarks</span><br><span class="line">        self.results = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_evaluation</span>(<span class="params">self, agent, num_tasks=<span class="number">100</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;运行评估&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(num_tasks):</span><br><span class="line">            task = self.sample_task()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 执行任务</span></span><br><span class="line">                start_time = time.time()</span><br><span class="line">                result = agent.run(task[<span class="string">&quot;input&quot;</span>])</span><br><span class="line">                elapsed = time.time() - start_time</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 评估结果</span></span><br><span class="line">                score = self.score_result(result, task[<span class="string">&quot;expected&quot;</span>])</span><br><span class="line">                </span><br><span class="line">                self.results.append(&#123;</span><br><span class="line">                    <span class="string">&quot;task_id&quot;</span>: task[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: score &gt;= <span class="number">0.8</span>,</span><br><span class="line">                    <span class="string">&quot;score&quot;</span>: score,</span><br><span class="line">                    <span class="string">&quot;time&quot;</span>: elapsed,</span><br><span class="line">                    <span class="string">&quot;tokens&quot;</span>: agent.get_token_usage()</span><br><span class="line">                &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                self.results.append(&#123;</span><br><span class="line">                    <span class="string">&quot;task_id&quot;</span>: task[<span class="string">&quot;id&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;success&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                    <span class="string">&quot;error&quot;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">                &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> self.compute_metrics()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算指标&quot;&quot;&quot;</span></span><br><span class="line">        total = <span class="built_in">len</span>(self.results)</span><br><span class="line">        success_count = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> r <span class="keyword">in</span> self.results <span class="keyword">if</span> r.get(<span class="string">&quot;success&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        avg_score = np.mean([r[<span class="string">&quot;score&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> self.results <span class="keyword">if</span> <span class="string">&quot;score&quot;</span> <span class="keyword">in</span> r])</span><br><span class="line">        avg_time = np.mean([r[<span class="string">&quot;time&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> self.results <span class="keyword">if</span> <span class="string">&quot;time&quot;</span> <span class="keyword">in</span> r])</span><br><span class="line">        total_tokens = <span class="built_in">sum</span>(r[<span class="string">&quot;tokens&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> self.results <span class="keyword">if</span> <span class="string">&quot;tokens&quot;</span> <span class="keyword">in</span> r)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&quot;success_rate&quot;</span>: success_count / total,</span><br><span class="line">            <span class="string">&quot;average_score&quot;</span>: avg_score,</span><br><span class="line">            <span class="string">&quot;average_time&quot;</span>: avg_time,</span><br><span class="line">            <span class="string">&quot;total_cost&quot;</span>: total_tokens * <span class="number">0.00001</span>,  <span class="comment"># 假设每1k tokens = $0.01</span></span><br><span class="line">            <span class="string">&quot;reliability&quot;</span>: self.compute_reliability()</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_reliability</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;计算可靠性（相同任务多次执行的一致性）&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 对部分任务重复执行3次</span></span><br><span class="line">        consistency_scores = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> task_type <span class="keyword">in</span> self.task_types:</span><br><span class="line">            results = [r <span class="keyword">for</span> r <span class="keyword">in</span> self.results <span class="keyword">if</span> r[<span class="string">&quot;type&quot;</span>] == task_type]</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(results) &gt;= <span class="number">3</span>:</span><br><span class="line">                scores = [r[<span class="string">&quot;score&quot;</span>] <span class="keyword">for</span> r <span class="keyword">in</span> results[:<span class="number">3</span>]]</span><br><span class="line">                variance = np.var(scores)</span><br><span class="line">                consistency_scores.append(<span class="number">1</span> - variance)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> np.mean(consistency_scores)</span><br></pre></td></tr></table></figure>
<h3 id="人类评估">人类评估</h3>
<p>某些任务需要人类评估：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">human_evaluation</span>(<span class="params">agent_outputs, tasks</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;人类评估界面&quot;&quot;&quot;</span></span><br><span class="line">    scores = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> output, task <span class="keyword">in</span> <span class="built_in">zip</span>(agent_outputs, tasks):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n任务：<span class="subst">&#123;task[<span class="string">&#x27;description&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Agent输出：<span class="subst">&#123;output&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 多维度评分</span></span><br><span class="line">        relevance = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;相关性(1-5)：&quot;</span>))</span><br><span class="line">        accuracy = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;准确性(1-5)：&quot;</span>))</span><br><span class="line">        completeness = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;完整性(1-5)：&quot;</span>))</span><br><span class="line">        usefulness = <span class="built_in">int</span>(<span class="built_in">input</span>(<span class="string">&quot;实用性(1-5)：&quot;</span>))</span><br><span class="line">        </span><br><span class="line">        scores.append(&#123;</span><br><span class="line">            <span class="string">&quot;relevance&quot;</span>: relevance,</span><br><span class="line">            <span class="string">&quot;accuracy&quot;</span>: accuracy,</span><br><span class="line">            <span class="string">&quot;completeness&quot;</span>: completeness,</span><br><span class="line">            <span class="string">&quot;usefulness&quot;</span>: usefulness,</span><br><span class="line">            <span class="string">&quot;overall&quot;</span>: (relevance + accuracy + completeness + usefulness) / <span class="number">4</span></span><br><span class="line">        &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> scores</span><br></pre></td></tr></table></figure>
<p>评估是持续改进 Agent 的基础。通过系统化的测试，我们能发现 Agent
的弱点，有针对性地优化。</p>
<h2 id="实战构建完整的-agent-项目">实战：构建完整的 Agent 项目</h2>
<p>理论和框架都了解了，现在让我们动手构建一个完整的 Agent
项目：<strong>智能数据分析助手</strong>。</p>
<h3 id="项目需求">项目需求</h3>
<p>目标：构建一个能够自动分析数据、生成报告的 Agent。</p>
<p>功能： 1. 接收 CSV/Excel 文件 2. 自动进行数据清洗 3.
探索性数据分析（EDA） 4. 生成可视化图表 5. 撰写分析报告 6.
回答用户的数据相关问题</p>
<h3 id="系统架构">系统架构</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 系统架构</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">┌─────────────────────────────────────────┐</span></span><br><span class="line"><span class="string">│           User Interface                │</span></span><br><span class="line"><span class="string">│    (接收文件、展示结果、对话)            │</span></span><br><span class="line"><span class="string">└──────────────┬──────────────────────────┘</span></span><br><span class="line"><span class="string">               │</span></span><br><span class="line"><span class="string">┌──────────────▼──────────────────────────┐</span></span><br><span class="line"><span class="string">│        Main Agent                       │</span></span><br><span class="line"><span class="string">│    (协调、规划、决策)                    │</span></span><br><span class="line"><span class="string">└──┬───────┬────────┬────────┬───────────┘</span></span><br><span class="line"><span class="string">   │       │        │        │</span></span><br><span class="line"><span class="string">   ▼       ▼        ▼        ▼</span></span><br><span class="line"><span class="string">┌─────┐ ┌──────┐ ┌──────┐ ┌──────────┐</span></span><br><span class="line"><span class="string">│Data │ │ EDA  │ │ Viz  │ │  Report  │</span></span><br><span class="line"><span class="string">│Clean│ │Agent │ │Agent │ │  Agent   │</span></span><br><span class="line"><span class="string">└─────┘ └──────┘ └──────┘ └──────────┘</span></span><br><span class="line"><span class="string">   │       │        │        │</span></span><br><span class="line"><span class="string">   └───────┴────────┴────────┴───────────┐</span></span><br><span class="line"><span class="string">                                          │</span></span><br><span class="line"><span class="string">                ┌─────────────────────────▼──┐</span></span><br><span class="line"><span class="string">                │     Shared Memory          │</span></span><br><span class="line"><span class="string">                │  (数据、中间结果、报告)     │</span></span><br><span class="line"><span class="string">                └────────────────────────────┘</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="核心实现">核心实现</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">from</span> langchain.chat_models <span class="keyword">import</span> ChatOpenAI</span><br><span class="line"><span class="keyword">from</span> langchain.tools <span class="keyword">import</span> tool</span><br><span class="line"><span class="keyword">from</span> langchain.agents <span class="keyword">import</span> AgentExecutor, create_openai_functions_agent</span><br><span class="line"><span class="keyword">from</span> langchain.memory <span class="keyword">import</span> ConversationBufferMemory</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 工具定义 =====</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_data</span>(<span class="params">file_path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;加载数据文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> file_path.endswith(<span class="string">&#x27;.csv&#x27;</span>):</span><br><span class="line">            df = pd.read_csv(file_path)</span><br><span class="line">        <span class="keyword">elif</span> file_path.endswith(<span class="string">&#x27;.xlsx&#x27;</span>):</span><br><span class="line">            df = pd.read_excel(file_path)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;不支持的文件格式&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存到共享内存</span></span><br><span class="line">        DataStore.save(<span class="string">&quot;raw_data&quot;</span>, df)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;成功加载数据：<span class="subst">&#123;df.shape[<span class="number">0</span>]&#125;</span>行 × <span class="subst">&#123;df.shape[<span class="number">1</span>]&#125;</span>列\n列名：<span class="subst">&#123;<span class="built_in">list</span>(df.columns)&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;加载失败：<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">clean_data</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;清洗数据&quot;&quot;&quot;</span></span><br><span class="line">    df = DataStore.load(<span class="string">&quot;raw_data&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 删除重复行</span></span><br><span class="line">    df = df.drop_duplicates()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 处理缺失值</span></span><br><span class="line">    numeric_cols = df.select_dtypes(include=[<span class="string">&#x27;number&#x27;</span>]).columns</span><br><span class="line">    df[numeric_cols] = df[numeric_cols].fillna(df[numeric_cols].mean())</span><br><span class="line">    </span><br><span class="line">    categorical_cols = df.select_dtypes(include=[<span class="string">&#x27;object&#x27;</span>]).columns</span><br><span class="line">    df[categorical_cols] = df[categorical_cols].fillna(df[categorical_cols].mode().iloc[<span class="number">0</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 保存清洗后的数据</span></span><br><span class="line">    DataStore.save(<span class="string">&quot;clean_data&quot;</span>, df)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;数据清洗完成：删除了<span class="subst">&#123;<span class="built_in">len</span>(DataStore.load(<span class="string">&#x27;raw_data&#x27;</span>)) - <span class="built_in">len</span>(df)&#125;</span>行重复数据&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">describe_data</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取数据统计描述&quot;&quot;&quot;</span></span><br><span class="line">    df = DataStore.load(<span class="string">&quot;clean_data&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> df.describe().to_string()</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">analyze_correlation</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;分析变量相关性&quot;&quot;&quot;</span></span><br><span class="line">    df = DataStore.load(<span class="string">&quot;clean_data&quot;</span>)</span><br><span class="line">    numeric_df = df.select_dtypes(include=[<span class="string">&#x27;number&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    corr = numeric_df.corr()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 找出强相关的变量对</span></span><br><span class="line">    strong_corr = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(corr.columns)):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i+<span class="number">1</span>, <span class="built_in">len</span>(corr.columns)):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">abs</span>(corr.iloc[i, j]) &gt; <span class="number">0.7</span>:</span><br><span class="line">                strong_corr.append(</span><br><span class="line">                    <span class="string">f&quot;<span class="subst">&#123;corr.columns[i]&#125;</span> 与 <span class="subst">&#123;corr.columns[j]&#125;</span>: <span class="subst">&#123;corr.iloc[i, j]:<span class="number">.2</span>f&#125;</span>&quot;</span></span><br><span class="line">                )</span><br><span class="line">    </span><br><span class="line">    DataStore.save(<span class="string">&quot;correlation&quot;</span>, corr)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;相关性分析完成。\n强相关关系：\n&quot;</span> + <span class="string">&quot;\n&quot;</span>.join(strong_corr)</span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_visualization</span>(<span class="params">chart_type: <span class="built_in">str</span>, x_column: <span class="built_in">str</span>, y_column: <span class="built_in">str</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建可视化图表</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        chart_type: 图表类型 (histogram, scatter, bar, box)</span></span><br><span class="line"><span class="string">        x_column: X轴列名</span></span><br><span class="line"><span class="string">        y_column: Y轴列名（可选）</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df = DataStore.load(<span class="string">&quot;clean_data&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    plt.figure(figsize=(<span class="number">10</span>, <span class="number">6</span>))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> chart_type == <span class="string">&quot;histogram&quot;</span>:</span><br><span class="line">        plt.hist(df[x_column], bins=<span class="number">30</span>)</span><br><span class="line">        plt.xlabel(x_column)</span><br><span class="line">        plt.ylabel(<span class="string">&quot;频数&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> chart_type == <span class="string">&quot;scatter&quot;</span> <span class="keyword">and</span> y_column:</span><br><span class="line">        plt.scatter(df[x_column], df[y_column])</span><br><span class="line">        plt.xlabel(x_column)</span><br><span class="line">        plt.ylabel(y_column)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> chart_type == <span class="string">&quot;bar&quot;</span>:</span><br><span class="line">        df[x_column].value_counts().plot(kind=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">        plt.xlabel(x_column)</span><br><span class="line">        plt.ylabel(<span class="string">&quot;计数&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">elif</span> chart_type == <span class="string">&quot;box&quot;</span>:</span><br><span class="line">        df.boxplot(column=x_column)</span><br><span class="line">    </span><br><span class="line">    plt.title(<span class="string">f&quot;<span class="subst">&#123;chart_type.title()&#125;</span> - <span class="subst">&#123;x_column&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 保存图表</span></span><br><span class="line">    filename = <span class="string">f&quot;chart_<span class="subst">&#123;chart_type&#125;</span>_<span class="subst">&#123;x_column&#125;</span>.png&quot;</span></span><br><span class="line">    plt.savefig(filename)</span><br><span class="line">    plt.close()</span><br><span class="line">    </span><br><span class="line">    DataStore.add_chart(filename)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;图表已生成：<span class="subst">&#123;filename&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_report</span>() -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;生成分析报告&quot;&quot;&quot;</span></span><br><span class="line">    df = DataStore.load(<span class="string">&quot;clean_data&quot;</span>)</span><br><span class="line">    charts = DataStore.get_charts()</span><br><span class="line">    </span><br><span class="line">    report = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># 数据分析报告</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 数据概览</span></span><br><span class="line"><span class="string">- 总行数：<span class="subst">&#123;<span class="built_in">len</span>(df)&#125;</span></span></span><br><span class="line"><span class="string">- 总列数：<span class="subst">&#123;<span class="built_in">len</span>(df.columns)&#125;</span></span></span><br><span class="line"><span class="string">- 列名：<span class="subst">&#123;<span class="string">&#x27;, &#x27;</span>.join(df.columns)&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 数据统计</span></span><br><span class="line"><span class="string"><span class="subst">&#123;df.describe().to_string()&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">## 可视化图表</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> chart <span class="keyword">in</span> charts:</span><br><span class="line">        report += <span class="string">f&quot;\n![<span class="subst">&#123;chart&#125;</span>](<span class="subst">&#123;chart&#125;</span>)\n&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 保存报告</span></span><br><span class="line">    DataStore.save(<span class="string">&quot;report&quot;</span>, report)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;analysis_report.md&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(report)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;报告已生成：analysis_report.md&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 数据存储 =====</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataStore</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;共享数据存储&quot;&quot;&quot;</span></span><br><span class="line">    _data = &#123;&#125;</span><br><span class="line">    _charts = []</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">cls, key, value</span>):</span><br><span class="line">        cls._data[key] = value</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load</span>(<span class="params">cls, key</span>):</span><br><span class="line">        <span class="keyword">return</span> cls._data.get(key)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_chart</span>(<span class="params">cls, filename</span>):</span><br><span class="line">        cls._charts.append(filename)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_charts</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="keyword">return</span> cls._charts</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 主 Agent =====</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataAnalysisAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.llm = ChatOpenAI(model=<span class="string">&quot;gpt-4&quot;</span>, temperature=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        self.tools = [</span><br><span class="line">            load_data,</span><br><span class="line">            clean_data,</span><br><span class="line">            describe_data,</span><br><span class="line">            analyze_correlation,</span><br><span class="line">            create_visualization,</span><br><span class="line">            generate_report</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        self.memory = ConversationBufferMemory(</span><br><span class="line">            memory_key=<span class="string">&quot;chat_history&quot;</span>,</span><br><span class="line">            return_messages=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        self.agent = self._create_agent()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_create_agent</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;创建Agent&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">from</span> langchain.prompts <span class="keyword">import</span> ChatPromptTemplate, MessagesPlaceholder</span><br><span class="line">        </span><br><span class="line">        prompt = ChatPromptTemplate.from_messages([</span><br><span class="line">            (<span class="string">&quot;system&quot;</span>, <span class="string">&quot;&quot;&quot;你是一个专业的数据分析师助手。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">你的工作流程：</span></span><br><span class="line"><span class="string">1. 加载数据文件</span></span><br><span class="line"><span class="string">2. 清洗数据（处理缺失值、重复值）</span></span><br><span class="line"><span class="string">3. 进行探索性数据分析</span></span><br><span class="line"><span class="string">4. 创建合适的可视化图表</span></span><br><span class="line"><span class="string">5. 生成分析报告</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">在分析时，注意：</span></span><br><span class="line"><span class="string">- 先理解数据的结构和含义</span></span><br><span class="line"><span class="string">- 识别数据中的模式和异常</span></span><br><span class="line"><span class="string">- 选择恰当的图表类型</span></span><br><span class="line"><span class="string">- 提供清晰的解释和洞察</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>),</span><br><span class="line">            MessagesPlaceholder(variable_name=<span class="string">&quot;chat_history&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;human&quot;</span>, <span class="string">&quot;&#123;input&#125;&quot;</span>),</span><br><span class="line">            MessagesPlaceholder(variable_name=<span class="string">&quot;agent_scratchpad&quot;</span>)</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        agent = create_openai_functions_agent(self.llm, self.tools, prompt)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> AgentExecutor(</span><br><span class="line">            agent=agent,</span><br><span class="line">            tools=self.tools,</span><br><span class="line">            memory=self.memory,</span><br><span class="line">            verbose=<span class="literal">True</span>,</span><br><span class="line">            max_iterations=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;自动分析数据文件&quot;&quot;&quot;</span></span><br><span class="line">        prompt = <span class="string">f&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        请分析数据文件：<span class="subst">&#123;file_path&#125;</span></span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        执行完整的分析流程：</span></span><br><span class="line"><span class="string">        1. 加载数据</span></span><br><span class="line"><span class="string">        2. 清洗数据</span></span><br><span class="line"><span class="string">        3. 统计描述</span></span><br><span class="line"><span class="string">        4. 相关性分析</span></span><br><span class="line"><span class="string">        5. 创建3-5个有意义的可视化图表</span></span><br><span class="line"><span class="string">        6. 生成完整报告</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> self.agent.invoke(&#123;<span class="string">&quot;input&quot;</span>: prompt&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">chat</span>(<span class="params">self, question</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;对话式查询&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> self.agent.invoke(&#123;<span class="string">&quot;input&quot;</span>: question&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ===== 使用示例 =====</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 创建Agent</span></span><br><span class="line">    agent = DataAnalysisAgent()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 自动分析</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=== 自动分析模式 ===&quot;</span>)</span><br><span class="line">    result = agent.analyze(<span class="string">&quot;sales_data.csv&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n分析完成！&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(result[<span class="string">&quot;output&quot;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 对话模式</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n=== 对话模式 ===&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        question = <span class="built_in">input</span>(<span class="string">&quot;\n你的问题（输入&#x27;quit&#x27;退出）：&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> question.lower() == <span class="string">&#x27;quit&#x27;</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line">        response = agent.chat(question)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\nAgent: <span class="subst">&#123;response[<span class="string">&#x27;output&#x27;</span>]&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="运行效果">运行效果</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">=== 自动分析模式 ===</span><br><span class="line"></span><br><span class="line">&gt; Entering AgentExecutor chain...</span><br><span class="line"></span><br><span class="line">Thought: 我需要先加载数据文件</span><br><span class="line">Action: load_data</span><br><span class="line">Action Input: &#123;&quot;file_path&quot;: &quot;sales_data.csv&quot;&#125;</span><br><span class="line">Observation: 成功加载数据：1000行 × 5列</span><br><span class="line">列名：[&#x27;date&#x27;, &#x27;product&#x27;, &#x27;quantity&#x27;, &#x27;price&#x27;, &#x27;revenue&#x27;]</span><br><span class="line"></span><br><span class="line">Thought: 数据已加载，现在清洗数据</span><br><span class="line">Action: clean_data</span><br><span class="line">Observation: 数据清洗完成：删除了15行重复数据</span><br><span class="line"></span><br><span class="line">Thought: 获取统计描述</span><br><span class="line">Action: describe_data</span><br><span class="line">Observation: </span><br><span class="line">       quantity      price      revenue</span><br><span class="line">count   985.000   985.000     985.000</span><br><span class="line">mean     45.230    99.850    4513.205</span><br><span class="line">std      12.450    25.320    1123.450</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Thought: 分析相关性</span><br><span class="line">Action: analyze_correlation</span><br><span class="line">Observation: 相关性分析完成。</span><br><span class="line">强相关关系：</span><br><span class="line">quantity 与 revenue: 0.89</span><br><span class="line">price 与 revenue: 0.76</span><br><span class="line"></span><br><span class="line">Thought: 创建可视化图表</span><br><span class="line">Action: create_visualization</span><br><span class="line">Action Input: &#123;&quot;chart_type&quot;: &quot;histogram&quot;, &quot;x_column&quot;: &quot;revenue&quot;&#125;</span><br><span class="line">Observation: 图表已生成：chart_histogram_revenue.png</span><br><span class="line"></span><br><span class="line">Action: create_visualization</span><br><span class="line">Action Input: &#123;&quot;chart_type&quot;: &quot;scatter&quot;, &quot;x_column&quot;: &quot;quantity&quot;, &quot;y_column&quot;: &quot;revenue&quot;&#125;</span><br><span class="line">Observation: 图表已生成：chart_scatter_quantity_revenue.png</span><br><span class="line"></span><br><span class="line">Action: create_visualization</span><br><span class="line">Action Input: &#123;&quot;chart_type&quot;: &quot;bar&quot;, &quot;x_column&quot;: &quot;product&quot;&#125;</span><br><span class="line">Observation: 图表已生成：chart_bar_product.png</span><br><span class="line"></span><br><span class="line">Thought: 生成最终报告</span><br><span class="line">Action: generate_report</span><br><span class="line">Observation: 报告已生成：analysis_report.md</span><br><span class="line"></span><br><span class="line">Final Answer: 数据分析完成！</span><br><span class="line"></span><br><span class="line">主要发现：</span><br><span class="line">1. 数据集包含985条有效销售记录</span><br><span class="line">2. 销售数量和收入有很强的正相关关系（0.89）</span><br><span class="line">3. 价格对收入也有较强影响（0.76）</span><br><span class="line">4. 已生成3个可视化图表</span><br><span class="line">5. 完整报告已保存到 analysis_report.md</span><br><span class="line"></span><br><span class="line">=== 对话模式 ===</span><br><span class="line"></span><br><span class="line">你的问题：哪个产品销量最高？</span><br><span class="line"></span><br><span class="line">Agent: 让我查询一下...</span><br><span class="line"></span><br><span class="line">Action: load_data</span><br><span class="line">...（Agent会调用相应工具回答）</span><br><span class="line"></span><br><span class="line">Agent: 根据数据分析，产品A的销量最高，共售出12,450件。</span><br></pre></td></tr></table></figure>
<h3 id="扩展功能">扩展功能</h3>
<p>这个基础版本可以继续扩展：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 添加更多工具</span></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detect_outliers</span>(<span class="params">column: <span class="built_in">str</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;检测异常值&quot;&quot;&quot;</span></span><br><span class="line">    df = DataStore.load(<span class="string">&quot;clean_data&quot;</span>)</span><br><span class="line">    Q1 = df[column].quantile(<span class="number">0.25</span>)</span><br><span class="line">    Q3 = df[column].quantile(<span class="number">0.75</span>)</span><br><span class="line">    IQR = Q3 - Q1</span><br><span class="line">    outliers = df[(df[column] &lt; Q1 - <span class="number">1.5</span>*IQR) | (df[column] &gt; Q3 + <span class="number">1.5</span>*IQR)]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;发现<span class="subst">&#123;<span class="built_in">len</span>(outliers)&#125;</span>个异常值&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@tool</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">predict_trend</span>(<span class="params">column: <span class="built_in">str</span>, periods: <span class="built_in">int</span> = <span class="number">30</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;预测趋势&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">from</span> statsmodels.tsa.arima.model <span class="keyword">import</span> ARIMA</span><br><span class="line">    df = DataStore.load(<span class="string">&quot;clean_data&quot;</span>)</span><br><span class="line">    model = ARIMA(df[column], order=(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>))</span><br><span class="line">    fitted = model.fit()</span><br><span class="line">    forecast = fitted.forecast(steps=periods)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;未来<span class="subst">&#123;periods&#125;</span>期预测：<span class="subst">&#123;forecast.tolist()&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 添加多Agent协作</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpecialistAgents</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;专家Agent团队&quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.cleaning_agent = DataCleaningAgent()</span><br><span class="line">        self.viz_agent = VisualizationAgent()</span><br><span class="line">        self.report_agent = ReportAgent()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">collaborate</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="comment"># 清洗Agent处理数据质量</span></span><br><span class="line">        cleaned = self.cleaning_agent.process()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 可视化Agent创建图表</span></span><br><span class="line">        charts = self.viz_agent.create_charts(cleaned)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 报告Agent整合结果</span></span><br><span class="line">        report = self.report_agent.generate(cleaned, charts)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> report</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 添加反思机制</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReflectiveAnalysisAgent</span>(<span class="title class_ inherited__">DataAnalysisAgent</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_with_reflection</span>(<span class="params">self, file_path</span>):</span><br><span class="line">        <span class="comment"># 第一次分析</span></span><br><span class="line">        result = self.analyze(file_path)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 自我评估</span></span><br><span class="line">        evaluation = self.evaluate_analysis(result)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果质量不够，改进</span></span><br><span class="line">        <span class="keyword">if</span> evaluation[<span class="string">&quot;score&quot;</span>] &lt; <span class="number">0.8</span>:</span><br><span class="line">            improvements = self.suggest_improvements(evaluation)</span><br><span class="line">            result = self.refine_analysis(improvements)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p>这个完整的项目展示了如何将 Agent 的核心能力整合到实际应用中。</p>
<h2 id="最佳实践与注意事项">最佳实践与注意事项</h2>
<p>构建生产级 Agent 系统，需要注意以下要点：</p>
<h3 id="提示词工程">提示词工程</h3>
<p>好的提示词是 Agent 成功的关键：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ❌ 差的提示词</span></span><br><span class="line">prompt = <span class="string">&quot;分析这个数据&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ✅ 好的提示词</span></span><br><span class="line">prompt = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">你是一个专业的数据分析师。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">任务：分析提供的销售数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">步骤：</span></span><br><span class="line"><span class="string">1. 首先检查数据质量（缺失值、异常值）</span></span><br><span class="line"><span class="string">2. 计算关键指标（总销售额、平均客单价、增长率）</span></span><br><span class="line"><span class="string">3. 识别趋势和模式</span></span><br><span class="line"><span class="string">4. 提供可行的业务建议</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">输出格式：</span></span><br><span class="line"><span class="string">- 数据质量报告</span></span><br><span class="line"><span class="string">- 关键指标表格</span></span><br><span class="line"><span class="string">- 趋势分析（附图表）</span></span><br><span class="line"><span class="string">- 业务建议（3-5条）</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">- 使用专业术语</span></span><br><span class="line"><span class="string">- 提供具体数字</span></span><br><span class="line"><span class="string">- 解释分析逻辑</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="错误处理">错误处理</h3>
<p>健壮的错误处理机制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RobustAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_with_retry</span>(<span class="params">self, action, max_retries=<span class="number">3</span></span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;带重试的执行&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(max_retries):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                result = self.execute(action)</span><br><span class="line">                <span class="keyword">return</span> result</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">except</span> RateLimitError:</span><br><span class="line">                wait_time = <span class="number">2</span> ** attempt  <span class="comment"># 指数退避</span></span><br><span class="line">                time.sleep(wait_time)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">except</span> ToolExecutionError <span class="keyword">as</span> e:</span><br><span class="line">                <span class="comment"># 尝试修复工具调用</span></span><br><span class="line">                fixed_action = self.fix_tool_call(action, e)</span><br><span class="line">                result = self.execute(fixed_action)</span><br><span class="line">                <span class="keyword">return</span> result</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">if</span> attempt == max_retries - <span class="number">1</span>:</span><br><span class="line">                    <span class="comment"># 最后一次尝试仍失败，降级处理</span></span><br><span class="line">                    <span class="keyword">return</span> self.fallback_strategy(action, e)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    logging.error(<span class="string">f&quot;尝试 <span class="subst">&#123;attempt + <span class="number">1</span>&#125;</span> 失败：<span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="成本控制">成本控制</h3>
<p>LLM 调用成本可能很高：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CostAwareAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, budget_limit=<span class="number">10.0</span></span>):</span><br><span class="line">        self.budget_limit = budget_limit  <span class="comment"># 美元</span></span><br><span class="line">        self.total_cost = <span class="number">0.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call_llm</span>(<span class="params">self, prompt, model=<span class="string">&quot;gpt-4&quot;</span></span>):</span><br><span class="line">        <span class="comment"># 估算成本</span></span><br><span class="line">        estimated_tokens = <span class="built_in">len</span>(prompt.split()) * <span class="number">1.3</span></span><br><span class="line">        estimated_cost = estimated_tokens / <span class="number">1000</span> * <span class="number">0.03</span>  <span class="comment"># GPT-4价格</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.total_cost + estimated_cost &gt; self.budget_limit:</span><br><span class="line">            <span class="comment"># 超出预算，降级到便宜模型</span></span><br><span class="line">            model = <span class="string">&quot;gpt-3.5-turbo&quot;</span></span><br><span class="line">            estimated_cost = estimated_tokens / <span class="number">1000</span> * <span class="number">0.001</span></span><br><span class="line">        </span><br><span class="line">        response = openai.ChatCompletion.create(</span><br><span class="line">            model=model,</span><br><span class="line">            messages=[&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记录实际成本</span></span><br><span class="line">        actual_tokens = response.usage.total_tokens</span><br><span class="line">        actual_cost = actual_tokens / <span class="number">1000</span> * (<span class="number">0.03</span> <span class="keyword">if</span> model == <span class="string">&quot;gpt-4&quot;</span> <span class="keyword">else</span> <span class="number">0.001</span>)</span><br><span class="line">        self.total_cost += actual_cost</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> response.choices[<span class="number">0</span>].message.content</span><br></pre></td></tr></table></figure>
<h3 id="安全性">安全性</h3>
<p>Agent 能执行代码和操作系统命令，必须严格控制权限：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SecureAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 白名单：允许的操作</span></span><br><span class="line">        self.allowed_operations = [</span><br><span class="line">            <span class="string">&quot;read_file&quot;</span>,</span><br><span class="line">            <span class="string">&quot;write_file&quot;</span>,</span><br><span class="line">            <span class="string">&quot;search_web&quot;</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 黑名单：禁止的命令</span></span><br><span class="line">        self.forbidden_patterns = [</span><br><span class="line">            <span class="string">r&quot;rm\s+-rf&quot;</span>,</span><br><span class="line">            <span class="string">r&quot;del\s+/f&quot;</span>,</span><br><span class="line">            <span class="string">r&quot;DROP\s+TABLE&quot;</span>,</span><br><span class="line">            <span class="string">r&quot;eval\(&quot;</span>,</span><br><span class="line">        ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_action</span>(<span class="params">self, action</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;验证动作是否安全&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> action[<span class="string">&quot;type&quot;</span>] <span class="keyword">not</span> <span class="keyword">in</span> self.allowed_operations:</span><br><span class="line">            <span class="keyword">raise</span> SecurityError(<span class="string">f&quot;不允许的操作：<span class="subst">&#123;action[<span class="string">&#x27;type&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查命令内容</span></span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> self.forbidden_patterns:</span><br><span class="line">            <span class="keyword">if</span> re.search(pattern, <span class="built_in">str</span>(action), re.IGNORECASE):</span><br><span class="line">                <span class="keyword">raise</span> SecurityError(<span class="string">f&quot;检测到危险命令：<span class="subst">&#123;pattern&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_in_sandbox</span>(<span class="params">self, code</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;在沙箱中执行代码&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">import</span> docker</span><br><span class="line">        </span><br><span class="line">        client = docker.from_env()</span><br><span class="line">        container = client.containers.run(</span><br><span class="line">            <span class="string">&quot;python:3.9-slim&quot;</span>,</span><br><span class="line">            command=<span class="string">f&quot;python -c &#x27;<span class="subst">&#123;code&#125;</span>&#x27;&quot;</span>,</span><br><span class="line">            remove=<span class="literal">True</span>,</span><br><span class="line">            network_disabled=<span class="literal">True</span>,  <span class="comment"># 禁用网络</span></span><br><span class="line">            mem_limit=<span class="string">&quot;256m&quot;</span>,  <span class="comment"># 限制内存</span></span><br><span class="line">            cpu_quota=<span class="number">50000</span>,  <span class="comment"># 限制CPU</span></span><br><span class="line">            timeout=<span class="number">30</span>  <span class="comment"># 超时限制</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> container.decode()</span><br></pre></td></tr></table></figure>
<h3 id="可观测性">可观测性</h3>
<p>生产环境需要完善的监控：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ObservableAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.logger = logging.getLogger(<span class="string">&quot;agent&quot;</span>)</span><br><span class="line">        self.metrics = &#123;</span><br><span class="line">            <span class="string">&quot;total_tasks&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;successful_tasks&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;failed_tasks&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;total_cost&quot;</span>: <span class="number">0.0</span>,</span><br><span class="line">            <span class="string">&quot;average_latency&quot;</span>: <span class="number">0.0</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_with_logging</span>(<span class="params">self, task</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;带日志的执行&quot;&quot;&quot;</span></span><br><span class="line">        task_id = self.generate_task_id()</span><br><span class="line">        start_time = datetime.now()</span><br><span class="line">        </span><br><span class="line">        self.logger.info(<span class="string">f&quot;[<span class="subst">&#123;task_id&#125;</span>] 开始执行任务：<span class="subst">&#123;task&#125;</span>&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = self.execute(task)</span><br><span class="line">            </span><br><span class="line">            elapsed = (datetime.now() - start_time).total_seconds()</span><br><span class="line">            </span><br><span class="line">            self.logger.info(<span class="string">f&quot;[<span class="subst">&#123;task_id&#125;</span>] 任务成功，耗时<span class="subst">&#123;elapsed&#125;</span>秒&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            self.metrics[<span class="string">&quot;successful_tasks&quot;</span>] += <span class="number">1</span></span><br><span class="line">            self.update_metrics(elapsed)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.logger.error(<span class="string">f&quot;[<span class="subst">&#123;task_id&#125;</span>] 任务失败：<span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">            self.metrics[<span class="string">&quot;failed_tasks&quot;</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            self.metrics[<span class="string">&quot;total_tasks&quot;</span>] += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">export_metrics</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;导出指标供监控系统使用&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            **self.metrics,</span><br><span class="line">            <span class="string">&quot;success_rate&quot;</span>: self.metrics[<span class="string">&quot;successful_tasks&quot;</span>] / self.metrics[<span class="string">&quot;total_tasks&quot;</span>],</span><br><span class="line">            <span class="string">&quot;timestamp&quot;</span>: datetime.now().isoformat()</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h2 id="未来展望">未来展望</h2>
<p>AI Agent 技术仍在快速演进，未来几个重要方向：</p>
<h3 id="多模态-agent">多模态 Agent</h3>
<p>未来的 Agent 将不限于文本，能够处理图像、音频、视频：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultimodalAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">self, inputs</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;处理多模态输入&quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> inputs[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;image&quot;</span>:</span><br><span class="line">            <span class="comment"># 图像理解</span></span><br><span class="line">            description = self.vision_model.describe(inputs[<span class="string">&quot;data&quot;</span>])</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">elif</span> inputs[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;audio&quot;</span>:</span><br><span class="line">            <span class="comment"># 语音识别</span></span><br><span class="line">            text = self.speech_to_text(inputs[<span class="string">&quot;data&quot;</span>])</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">elif</span> inputs[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;video&quot;</span>:</span><br><span class="line">            <span class="comment"># 视频分析</span></span><br><span class="line">            frames = self.extract_keyframes(inputs[<span class="string">&quot;data&quot;</span>])</span><br><span class="line">            analysis = self.analyze_frames(frames)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 综合处理</span></span><br><span class="line">        <span class="keyword">return</span> self.llm.process(description, text, analysis)</span><br></pre></td></tr></table></figure>
<h3 id="具身智能">具身智能</h3>
<p>Agent 将从纯软件走向物理世界，控制机器人：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EmbodiedAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, robot</span>):</span><br><span class="line">        self.robot = robot</span><br><span class="line">        self.perception = VisionSystem()</span><br><span class="line">        self.planning = MotionPlanner()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_task</span>(<span class="params">self, instruction</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;执行物理世界任务&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 感知环境</span></span><br><span class="line">        scene = self.perception.understand_scene()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 规划动作序列</span></span><br><span class="line">        plan = self.planning.plan(instruction, scene)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行动作</span></span><br><span class="line">        <span class="keyword">for</span> action <span class="keyword">in</span> plan:</span><br><span class="line">            self.robot.execute(action)</span><br><span class="line">            feedback = self.robot.get_feedback()</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 动态调整</span></span><br><span class="line">            <span class="keyword">if</span> feedback[<span class="string">&quot;success&quot;</span>]:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                plan = self.replan(action, feedback)</span><br></pre></td></tr></table></figure>
<h3 id="终身学习">终身学习</h3>
<p>Agent 将能够从每次交互中学习，持续改进：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LifelongLearningAgent</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">learn_from_experience</span>(<span class="params">self, trajectory, feedback</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;从经验中学习&quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># 提取教训</span></span><br><span class="line">        lesson = self.extract_lesson(trajectory, feedback)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新知识库</span></span><br><span class="line">        self.knowledge_base.add(lesson)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 微调模型（可选）</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.experiences) &gt;= <span class="number">100</span>:</span><br><span class="line">            self.fine_tune_model(self.experiences)</span><br></pre></td></tr></table></figure>
<h3 id="通用人工智能agi之路">通用人工智能（AGI）之路</h3>
<p>Agent 是通向 AGI 的重要一步。未来的 Agent 将具备：</p>
<ul>
<li><strong>跨领域迁移</strong>：在一个领域学到的能力可以迁移到其他领域</li>
<li><strong>元学习</strong>：学会如何学习，快速适应新任务</li>
<li><strong>创造性</strong>：不仅执行任务，还能提出新想法</li>
<li><strong>价值对齐</strong>：理解人类价值观，做出符合伦理的决策</li>
</ul>
<h2 id="总结">总结</h2>
<p>AI Agent 代表了人工智能从"理解"到"行动"的跨越。本文系统介绍了：</p>
<ol type="1">
<li><strong>Agent 基础</strong>：定义、核心组件、与普通 LLM 的区别</li>
<li><strong>核心能力</strong>：规划、记忆、工具使用、反思四大支柱</li>
<li><strong>主流框架</strong>：LangChain、LangGraph、AutoGPT、BabyAGI
等</li>
<li><strong>多 Agent 协作</strong>：辩论、共识、分层协作等模式</li>
<li><strong>评估方法</strong>：AgentBench、GAIA、AgentBoard 等基准</li>
<li><strong>实战项目</strong>：完整的数据分析 Agent 实现</li>
<li><strong>最佳实践</strong>：提示词工程、错误处理、安全性、可观测性</li>
</ol>
<p>Agent
技术正在从研究走向生产，从玩具走向工具。无论你是研究者、工程师还是产品经理，现在都是深入了解和应用
Agent 技术的最佳时机。</p>
<p>希望这篇完全指南能帮助你构建属于自己的智能代理系统。Agent
的时代，才刚刚开始。</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    
    
    
    
    
    
    <ul>
        <li>本文标题：AI Agent完全指南：从理论到工业实践</li>
        <li>本文作者：Chen Kai</li>
        <li>创建时间：2025-03-15 00:00:00</li>
        <li>
            本文链接：https://www.chenk.top/AI-Agent%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E7%90%86%E8%AE%BA%E5%88%B0%E5%B7%A5%E4%B8%9A%E5%AE%9E%E8%B7%B5/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/LLM/">#LLM</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/AI-Agents/">#AI Agents</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/Applications/">#Applications</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/Graph-Contextualized-Self-Attention-Network-for-Session-based-Recommendation/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Graph Contextualized Self-Attention Network for Session-based Recommendation</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'p2Cu9MgjoKzo3VmulhNLIusH-gzGzoHsz',
                    appKey: 'QThQHg3c8sVwGpzg9lu8zEG3',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情赞美帅气伟大的ck吧~',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Chen Kai';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2026&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Chen Kai</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
            </div>
        
        <div class="theme-info info-item">
            <!-- 由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a> -->
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#agent-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">1.</span> <span class="nav-text">Agent 是什么</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E%E8%A2%AB%E5%8A%A8%E5%9B%9E%E7%AD%94%E5%88%B0%E4%B8%BB%E5%8A%A8%E6%89%A7%E8%A1%8C"><span class="nav-number">1.1.</span> <span class="nav-text">从&quot;被动回答&quot;到&quot;主动执行&quot;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#agent-%E7%9A%84%E6%AD%A3%E5%BC%8F%E5%AE%9A%E4%B9%89"><span class="nav-number">1.2.</span> <span class="nav-text">Agent 的正式定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#agent-vs-%E6%99%AE%E9%80%9A-llm"><span class="nav-number">1.3.</span> <span class="nav-text">Agent vs 普通 LLM</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#agent-%E7%9A%84%E5%8F%91%E5%B1%95%E5%8E%86%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">Agent 的发展历程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A9%E6%9C%9F%E6%8E%A2%E7%B4%A22020-2022"><span class="nav-number">2.1.</span> <span class="nav-text">早期探索（2020-2022）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%88%86%E5%8F%91%E6%9C%9F2023"><span class="nav-number">2.2.</span> <span class="nav-text">爆发期（2023）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E4%B8%9A%E5%8C%96%E9%98%B6%E6%AE%B52024-%E7%8E%B0%E5%9C%A8"><span class="nav-number">2.3.</span> <span class="nav-text">工业化阶段（2024-现在）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E8%83%BD%E5%8A%9B%E4%B8%80%E8%A7%84%E5%88%92planning"><span class="nav-number">3.</span> <span class="nav-text">核心能力一：规划（Planning）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E8%A7%84%E5%88%92"><span class="nav-number">3.1.</span> <span class="nav-text">为什么需要规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%84%E5%88%92%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%96%B9%E6%B3%95"><span class="nav-number">3.2.</span> <span class="nav-text">规划的基本方法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%95%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92single-path"><span class="nav-number">3.2.1.</span> <span class="nav-text">单路径规划（Single-Path）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%9A%E8%B7%AF%E5%BE%84%E8%A7%84%E5%88%92multi-path"><span class="nav-number">3.2.2.</span> <span class="nav-text">多路径规划（Multi-Path）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%82%E6%AC%A1%E5%8C%96%E4%BB%BB%E5%8A%A1%E5%88%86%E8%A7%A3htn"><span class="nav-number">3.3.</span> <span class="nav-text">层次化任务分解（HTN）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92%E4%B8%8E%E9%87%8D%E8%A7%84%E5%88%92"><span class="nav-number">3.4.</span> <span class="nav-text">动态规划与重规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E6%97%85%E8%A1%8C%E8%A7%84%E5%88%92-agent"><span class="nav-number">3.5.</span> <span class="nav-text">实战案例：旅行规划 Agent</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E8%83%BD%E5%8A%9B%E4%BA%8C%E8%AE%B0%E5%BF%86memory"><span class="nav-number">4.</span> <span class="nav-text">核心能力二：记忆（Memory）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-agent-%E9%9C%80%E8%A6%81%E8%AE%B0%E5%BF%86"><span class="nav-number">4.1.</span> <span class="nav-text">为什么 Agent 需要记忆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%AD%E6%9C%9F%E8%AE%B0%E5%BF%86-vs-%E9%95%BF%E6%9C%9F%E8%AE%B0%E5%BF%86"><span class="nav-number">4.2.</span> <span class="nav-text">短期记忆 vs 长期记忆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%91%E9%87%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%B0%E5%BF%86%E7%9A%84%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD"><span class="nav-number">4.3.</span> <span class="nav-text">向量数据库：记忆的基础设施</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%B0%E5%BF%86%E8%B6%85%E8%B6%8A%E7%AE%80%E5%8D%95%E6%96%87%E6%9C%AC"><span class="nav-number">4.4.</span> <span class="nav-text">结构化记忆：超越简单文本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mars%E5%A4%9A%E6%AD%A5%E6%8E%A8%E7%90%86%E7%9A%84%E8%AE%B0%E5%BF%86%E5%A2%9E%E5%BC%BA"><span class="nav-number">4.5.</span> <span class="nav-text">MARS：多步推理的记忆增强</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#memento%E5%9F%BA%E4%BA%8E%E4%BA%8B%E4%BB%B6%E7%9A%84%E8%AE%B0%E5%BF%86%E7%AE%A1%E7%90%86"><span class="nav-number">4.6.</span> <span class="nav-text">Memento：基于事件的记忆管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%B0%E5%BF%86%E5%8E%8B%E7%BC%A9%E4%B8%8E%E9%81%97%E5%BF%98"><span class="nav-number">4.7.</span> <span class="nav-text">记忆压缩与遗忘</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E8%83%BD%E5%8A%9B%E4%B8%89%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8tool-use"><span class="nav-number">5.</span> <span class="nav-text">核心能力三：工具使用（Tool
Use）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#function-calling%E6%A0%87%E5%87%86%E5%8C%96%E7%9A%84%E5%B7%A5%E5%85%B7%E6%8E%A5%E5%8F%A3"><span class="nav-number">5.1.</span> <span class="nav-text">Function
Calling：标准化的工具接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#claude-%E7%9A%84%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="nav-number">5.2.</span> <span class="nav-text">Claude 的工具使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#computer-use%E7%AA%81%E7%A0%B4%E7%95%8C%E9%9D%A2%E9%99%90%E5%88%B6"><span class="nav-number">5.3.</span> <span class="nav-text">Computer Use：突破界面限制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E7%94%9F%E6%80%81%E4%BB%8E%E5%9F%BA%E7%A1%80%E5%88%B0%E9%AB%98%E7%BA%A7"><span class="nav-number">5.4.</span> <span class="nav-text">工具生态：从基础到高级</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E5%B7%A5%E5%85%B7"><span class="nav-number">5.4.1.</span> <span class="nav-text">基础工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%B7%A5%E5%85%B7"><span class="nav-number">5.4.2.</span> <span class="nav-text">数据库工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#api-%E9%9B%86%E6%88%90%E5%B7%A5%E5%85%B7"><span class="nav-number">5.4.3.</span> <span class="nav-text">API 集成工具</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A5%E5%85%B7%E7%BC%96%E6%8E%92%E7%BB%84%E5%90%88%E5%A4%9A%E4%B8%AA%E5%B7%A5%E5%85%B7"><span class="nav-number">5.5.</span> <span class="nav-text">工具编排：组合多个工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%B7%A5%E5%85%B7%E5%8F%91%E7%8E%B0"><span class="nav-number">5.6.</span> <span class="nav-text">动态工具发现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E8%83%BD%E5%8A%9B%E5%9B%9B%E5%8F%8D%E6%80%9Dreflection"><span class="nav-number">6.</span> <span class="nav-text">核心能力四：反思（Reflection）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%8F%8D%E6%80%9D"><span class="nav-number">6.1.</span> <span class="nav-text">为什么需要反思</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#self-refine%E8%BF%AD%E4%BB%A3%E4%BC%98%E5%8C%96"><span class="nav-number">6.2.</span> <span class="nav-text">Self-Refine：迭代优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reflexion%E4%BB%8E%E5%A4%B1%E8%B4%A5%E4%B8%AD%E5%AD%A6%E4%B9%A0"><span class="nav-number">6.3.</span> <span class="nav-text">Reflexion：从失败中学习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rise%E7%BB%93%E6%9E%84%E5%8C%96%E7%9A%84%E9%94%99%E8%AF%AF%E5%88%86%E6%9E%90"><span class="nav-number">6.4.</span> <span class="nav-text">RISE：结构化的错误分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%A5%96%E5%8A%B1%E6%A8%A1%E5%9E%8B%E7%9A%84%E5%8F%8D%E6%80%9D"><span class="nav-number">6.5.</span> <span class="nav-text">基于奖励模型的反思</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E4%BD%9C%E5%BC%8F%E5%8F%8D%E6%80%9D"><span class="nav-number">6.6.</span> <span class="nav-text">协作式反思</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E6%B5%81%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.</span> <span class="nav-text">主流框架实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#langchain%E6%9C%80%E6%B5%81%E8%A1%8C%E7%9A%84-agent-%E6%A1%86%E6%9E%B6"><span class="nav-number">7.1.</span> <span class="nav-text">LangChain：最流行的 Agent
框架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80-agent-%E6%9E%84%E5%BB%BA"><span class="nav-number">7.1.1.</span> <span class="nav-text">基础 Agent 构建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%A6%E8%AE%B0%E5%BF%86%E7%9A%84-agent"><span class="nav-number">7.1.2.</span> <span class="nav-text">带记忆的 Agent</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#langgraph%E6%B5%81%E7%A8%8B%E7%BC%96%E6%8E%92%E7%9A%84%E6%96%B0%E8%8C%83%E5%BC%8F"><span class="nav-number">7.2.</span> <span class="nav-text">LangGraph：流程编排的新范式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#autogpt%E8%87%AA%E4%B8%BB%E4%BB%BB%E5%8A%A1%E8%A7%84%E5%88%92"><span class="nav-number">7.3.</span> <span class="nav-text">AutoGPT：自主任务规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#babyagi%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E7%9A%84%E6%9E%81%E7%AE%80%E5%AE%9E%E7%8E%B0"><span class="nav-number">7.4.</span> <span class="nav-text">BabyAGI：任务管理的极简实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#agents%E6%A8%A1%E5%9D%97%E5%8C%96%E7%9A%84%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1"><span class="nav-number">7.5.</span> <span class="nav-text">AGENTS：模块化的框架设计</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A-agent-%E5%8D%8F%E4%BD%9C"><span class="nav-number">8.</span> <span class="nav-text">多 Agent 协作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%A4%9A-agent"><span class="nav-number">8.1.</span> <span class="nav-text">为什么需要多 Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#multi-agent-debate%E8%BE%A9%E8%AE%BA%E5%BC%8F%E5%8D%8F%E4%BD%9C"><span class="nav-number">8.2.</span> <span class="nav-text">Multi-Agent
Debate：辩论式协作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#consensus%E5%85%B1%E8%AF%86%E6%9C%BA%E5%88%B6"><span class="nav-number">8.3.</span> <span class="nav-text">Consensus：共识机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#down%E5%88%86%E5%B1%82%E5%8D%8F%E4%BD%9C%E6%A1%86%E6%9E%B6"><span class="nav-number">8.4.</span> <span class="nav-text">DOWN：分层协作框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#metagpt%E8%BD%AF%E4%BB%B6%E5%85%AC%E5%8F%B8%E6%A8%A1%E6%8B%9F"><span class="nav-number">8.5.</span> <span class="nav-text">MetaGPT：软件公司模拟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#agent-%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE"><span class="nav-number">8.6.</span> <span class="nav-text">Agent 通信协议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%84%E4%BC%B0%E4%B8%8E%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95"><span class="nav-number">9.</span> <span class="nav-text">评估与基准测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#agentbench%E7%BB%BC%E5%90%88%E8%83%BD%E5%8A%9B%E8%AF%84%E4%BC%B0"><span class="nav-number">9.1.</span> <span class="nav-text">AgentBench：综合能力评估</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gaia%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E9%97%AE%E7%AD%94"><span class="nav-number">9.2.</span> <span class="nav-text">GAIA：真实世界问答</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#agentboard%E5%85%A8%E6%96%B9%E4%BD%8D%E8%AF%84%E4%BC%B0"><span class="nav-number">9.3.</span> <span class="nav-text">AgentBoard：全方位评估</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%84%E4%BC%B0%E6%B5%81%E7%A8%8B"><span class="nav-number">9.4.</span> <span class="nav-text">自动化评估流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%BA%E7%B1%BB%E8%AF%84%E4%BC%B0"><span class="nav-number">9.5.</span> <span class="nav-text">人类评估</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%9E%84%E5%BB%BA%E5%AE%8C%E6%95%B4%E7%9A%84-agent-%E9%A1%B9%E7%9B%AE"><span class="nav-number">10.</span> <span class="nav-text">实战：构建完整的 Agent 项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E9%9C%80%E6%B1%82"><span class="nav-number">10.1.</span> <span class="nav-text">项目需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="nav-number">10.2.</span> <span class="nav-text">系统架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E5%AE%9E%E7%8E%B0"><span class="nav-number">10.3.</span> <span class="nav-text">核心实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C"><span class="nav-number">10.4.</span> <span class="nav-text">运行效果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8A%9F%E8%83%BD"><span class="nav-number">10.5.</span> <span class="nav-text">扩展功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">11.</span> <span class="nav-text">最佳实践与注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B"><span class="nav-number">11.1.</span> <span class="nav-text">提示词工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">11.2.</span> <span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="nav-number">11.3.</span> <span class="nav-text">成本控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">11.4.</span> <span class="nav-text">安全性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="nav-number">11.5.</span> <span class="nav-text">可观测性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%AA%E6%9D%A5%E5%B1%95%E6%9C%9B"><span class="nav-number">12.</span> <span class="nav-text">未来展望</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%A8%A1%E6%80%81-agent"><span class="nav-number">12.1.</span> <span class="nav-text">多模态 Agent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E8%BA%AB%E6%99%BA%E8%83%BD"><span class="nav-number">12.2.</span> <span class="nav-text">具身智能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%88%E8%BA%AB%E5%AD%A6%E4%B9%A0"><span class="nav-number">12.3.</span> <span class="nav-text">终身学习</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BDagi%E4%B9%8B%E8%B7%AF"><span class="nav-number">12.4.</span> <span class="nav-text">通用人工智能（AGI）之路</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">13.</span> <span class="nav-text">总结</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/lang-switch.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
