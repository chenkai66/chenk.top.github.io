<!DOCTYPE html>



<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Chen Kai">
    
    <title>
        
            云计算（四）云原生与容器技术 |
        
        Chen Kai Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chenk.top","root":"/","language":"zh-CN","default_language":"zh-CN","languages":["zh-CN","en"],"path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Chen Kai Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    
    
    
    
    

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Chen Kai Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    <li class="menu-item lang-switch lang-switch-trigger" title="Language">
                        <i class="fas fa-globe"></i>
                    </li>
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item lang-switch-trigger"><i class="fas fa-globe"></i></div>
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    
    
    
    

    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">云计算（四）云原生与容器技术</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Chen Kai</span>
                        
                            <span class="author-label">BOSS</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    
    
    
    
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2024-06-10 00:00:00</span>
        <span class="mobile">2024-06-10 00:00</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Cloud-Computing/">Cloud Computing</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Docker/">Docker</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Kubernetes/">Kubernetes</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">微服务</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>19.4k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>95 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>云原生技术正在重塑现代软件开发和部署的方式。从单体应用到微服务，从虚拟机到容器，从手动部署到自动化编排，这一系列转变背后是云原生理念的推动。理解容器技术和
Kubernetes 编排系统，已经成为现代 DevOps 工程师的必备技能。</p>
<p>本文将从云原生的核心理念出发，深入探讨 Docker
容器技术的实现细节，然后系统介绍 Kubernetes
集群的部署与管理，最后通过实战案例展示如何构建完整的云原生应用栈。无论你是刚开始接触容器技术，还是希望深入理解
Kubernetes 的底层机制，都能在本文中找到实用的内容。</p>
<span id="more"></span>
<h2 id="云原生概念与12要素应用">云原生概念与12要素应用</h2>
<h3 id="什么是云原生">什么是云原生</h3>
<p>云原生（Cloud
Native）是一种构建和运行应用程序的方法，充分利用云计算的优势。CNCF（Cloud
Native Computing
Foundation）将其定义为：<strong>云原生技术使组织能够在现代动态环境（如公有云、私有云和混合云）中构建和运行可扩展的应用程序</strong>。</p>
<p>云原生的核心特征包括：</p>
<ul>
<li><strong>容器化</strong>：应用打包在容器中，实现环境一致性</li>
<li><strong>微服务架构</strong>：应用拆分为小型、独立的服务</li>
<li><strong>动态编排</strong>：通过 Kubernetes
等工具自动管理容器生命周期</li>
<li><strong>DevOps 文化</strong>：开发与运维紧密协作，实现持续交付</li>
</ul>
<h3 id="要素应用12-factor-app">12要素应用（12-Factor App）</h3>
<p>12要素应用是一套构建 SaaS
应用的最佳实践，这些原则同样适用于云原生应用：</p>
<ol type="1">
<li><strong>代码库（Codebase）</strong>：一个代码库对应多个部署环境</li>
<li><strong>依赖（Dependencies）</strong>：显式声明并隔离依赖</li>
<li><strong>配置（Config）</strong>：将配置存储在环境变量中</li>
<li><strong>后端服务（Backing
Services）</strong>：将数据库、消息队列等视为附加资源</li>
<li><strong>构建、发布、运行（Build, Release,
Run）</strong>：严格分离构建和运行阶段</li>
<li><strong>进程（Processes）</strong>：应用作为无状态进程运行</li>
<li><strong>端口绑定（Port
Binding）</strong>：应用通过端口绑定提供服务</li>
<li><strong>并发（Concurrency）</strong>：通过进程模型进行扩展</li>
<li><strong>易处理（Disposability）</strong>：快速启动和优雅关闭</li>
<li><strong>开发/生产环境等价（Dev/Prod
Parity）</strong>：保持开发和生产环境尽可能相似</li>
<li><strong>日志（Logs）</strong>：将日志视为事件流</li>
<li><strong>管理进程（Admin
Processes）</strong>：将管理任务作为一次性进程运行</li>
</ol>
<p>这些原则指导我们设计可扩展、可维护的云原生应用。</p>
<h2 id="docker容器技术详解">Docker容器技术详解</h2>
<h3 id="docker-架构与核心概念">Docker 架构与核心概念</h3>
<p>Docker 采用客户端-服务器架构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┐</span><br><span class="line">│ Docker CLI  │  ← 客户端</span><br><span class="line">└──────┬──────┘</span><br><span class="line">       │</span><br><span class="line">       │ API 调用</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ Docker Daemon   │  ← 服务端（dockerd）</span><br><span class="line">│  - 镜像管理     │</span><br><span class="line">│  - 容器管理     │</span><br><span class="line">│  - 网络管理     │</span><br><span class="line">│  - 存储管理     │</span><br><span class="line">└─────────────────┘</span><br><span class="line">       │</span><br><span class="line">       ▼</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ Linux Kernel    │</span><br><span class="line">│  - Namespaces   │</span><br><span class="line">│  - Cgroups      │</span><br><span class="line">│  - Union FS     │</span><br><span class="line">└─────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>核心组件</strong>：</p>
<ul>
<li><strong>镜像（Image）</strong>：只读的模板，用于创建容器</li>
<li><strong>容器（Container）</strong>：镜像的运行实例，包含应用和运行时环境</li>
<li><strong>仓库（Registry）</strong>：存储镜像的地方，如 Docker
Hub</li>
<li><strong>Dockerfile</strong>：用于构建镜像的文本文件</li>
</ul>
<h3 id="镜像管理">镜像管理</h3>
<p>镜像采用分层存储结构，每一层都是只读的。多个容器可以共享相同的镜像层，节省存储空间。</p>
<p><strong>查看镜像</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出本地镜像</span></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像详细信息</span></span><br><span class="line">docker inspect nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像历史（各层信息）</span></span><br><span class="line">docker <span class="built_in">history</span> nginx:latest</span><br></pre></td></tr></table></figure>
<p><strong>拉取和推送镜像</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从 Docker Hub 拉取镜像</span></span><br><span class="line">docker pull nginx:1.21</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从私有仓库拉取</span></span><br><span class="line">docker pull registry.example.com/myapp:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送镜像到仓库</span></span><br><span class="line">docker tag myapp:v1.0 registry.example.com/myapp:v1.0</span><br><span class="line">docker push registry.example.com/myapp:v1.0</span><br></pre></td></tr></table></figure>
<p><strong>镜像构建</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Dockerfile 构建</span></span><br><span class="line">docker build -t myapp:v1.0 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 Dockerfile 路径</span></span><br><span class="line">docker build -f Dockerfile.prod -t myapp:prod .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建时传递构建参数</span></span><br><span class="line">docker build --build-arg VERSION=1.0 -t myapp:v1.0 .</span><br></pre></td></tr></table></figure>
<h3 id="容器管理">容器管理</h3>
<p>容器是镜像的运行实例，具有独立的文件系统、网络和进程空间。</p>
<p><strong>容器生命周期</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建并启动容器</span></span><br><span class="line">docker run -d --name myapp nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动已停止的容器</span></span><br><span class="line">docker start myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止容器</span></span><br><span class="line">docker stop myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启容器</span></span><br><span class="line">docker restart myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除容器</span></span><br><span class="line">docker <span class="built_in">rm</span> myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制删除运行中的容器</span></span><br><span class="line">docker <span class="built_in">rm</span> -f myapp</span><br></pre></td></tr></table></figure>
<p><strong>容器交互</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入运行中的容器</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myapp /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器中执行命令</span></span><br><span class="line">docker <span class="built_in">exec</span> myapp <span class="built_in">ls</span> /var/log</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器日志</span></span><br><span class="line">docker logs -f myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器资源使用情况</span></span><br><span class="line">docker stats myapp</span><br></pre></td></tr></table></figure>
<p><strong>容器导出和导入</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导出容器为 tar 文件</span></span><br><span class="line">docker <span class="built_in">export</span> myapp &gt; myapp.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 tar 文件导入为镜像</span></span><br><span class="line">docker import myapp.tar myapp:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存镜像为 tar 文件（包含所有层）</span></span><br><span class="line">docker save myapp:v1.0 &gt; myapp.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 tar 文件加载镜像</span></span><br><span class="line">docker load &lt; myapp.tar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 批量导出多个镜像</span></span><br><span class="line">docker save myapp:v1.0 myapp:v2.0 nginx:latest &gt; all-images.tar</span><br></pre></td></tr></table></figure>
<p><strong>容器监控和调试</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实时查看容器资源使用</span></span><br><span class="line">docker stats myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看特定容器的资源使用</span></span><br><span class="line">docker stats --no-stream myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器进程</span></span><br><span class="line">docker top myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器详细信息</span></span><br><span class="line">docker inspect myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器配置的特定字段</span></span><br><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;&#x27;</span> myapp</span><br><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Status&#125;&#125;&#x27;</span> myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器事件</span></span><br><span class="line">docker events --filter container=myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器日志（带时间戳）</span></span><br><span class="line">docker logs -f --timestamps myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最近100行日志</span></span><br><span class="line">docker logs --<span class="built_in">tail</span> 100 myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定时间范围的日志</span></span><br><span class="line">docker logs --since 2025-01-02T10:00:00 myapp</span><br><span class="line">docker logs --until 2025-01-02T12:00:00 myapp</span><br></pre></td></tr></table></figure>
<p><strong>容器故障排查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查容器健康状态</span></span><br><span class="line">docker ps --filter <span class="string">&quot;health=unhealthy&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器退出代码</span></span><br><span class="line">docker inspect -f <span class="string">&#x27;&#123;&#123;.State.ExitCode&#125;&#125;&#x27;</span> myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器启动失败原因</span></span><br><span class="line">docker inspect myapp | grep -A 10 <span class="string">&quot;State&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进入容器调试（容器必须运行）</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myapp /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果容器没有 bash，使用 sh</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myapp /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器中执行命令</span></span><br><span class="line">docker <span class="built_in">exec</span> myapp ps aux</span><br><span class="line">docker <span class="built_in">exec</span> myapp netstat -tlnp</span><br><span class="line">docker <span class="built_in">exec</span> myapp <span class="built_in">env</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件到容器</span></span><br><span class="line">docker <span class="built_in">cp</span> local-file.txt myapp:/app/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从容器复制文件</span></span><br><span class="line">docker <span class="built_in">cp</span> myapp:/app/log.txt ./log.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器网络配置</span></span><br><span class="line">docker network inspect bridge | grep -A 10 myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试容器网络连通性</span></span><br><span class="line">docker <span class="built_in">exec</span> myapp ping -c 3 8.8.8.8</span><br><span class="line">docker <span class="built_in">exec</span> myapp curl http://another-container:8080</span><br></pre></td></tr></table></figure>
<p><strong>容器批量操作</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止所有运行中的容器</span></span><br><span class="line">docker stop $(docker ps -q)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有停止的容器</span></span><br><span class="line">docker <span class="built_in">rm</span> $(docker ps -aq)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除所有容器（包括运行中的）</span></span><br><span class="line">docker <span class="built_in">rm</span> -f $(docker ps -aq)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理未使用的容器</span></span><br><span class="line">docker container prune</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有未使用的资源</span></span><br><span class="line">docker system prune -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器资源使用情况</span></span><br><span class="line">docker stats --no-stream --format <span class="string">&quot;table &#123;&#123;.Container&#125;&#125;\t&#123;&#123;.CPUPerc&#125;&#125;\t&#123;&#123;.MemUsage&#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>容器性能优化</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制容器资源使用</span></span><br><span class="line">docker run -d --name myapp \</span><br><span class="line">  --memory=<span class="string">&quot;512m&quot;</span> \</span><br><span class="line">  --cpus=<span class="string">&quot;1.0&quot;</span> \</span><br><span class="line">  --cpu-shares=1024 \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置容器重启策略</span></span><br><span class="line">docker run -d --name myapp \</span><br><span class="line">  --restart=always \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># restart 选项：</span></span><br><span class="line"><span class="comment"># no - 不自动重启（默认）</span></span><br><span class="line"><span class="comment"># on-failure - 失败时重启</span></span><br><span class="line"><span class="comment"># always - 总是重启</span></span><br><span class="line"><span class="comment"># unless-stopped - 除非手动停止，否则总是重启</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置容器优先级</span></span><br><span class="line">docker run -d --name myapp \</span><br><span class="line">  --oom-kill-disable \</span><br><span class="line">  --memory=<span class="string">&quot;512m&quot;</span> \</span><br><span class="line">  myapp:latest</span><br></pre></td></tr></table></figure>
<h3 id="docker-网络详解">Docker 网络详解</h3>
<p>Docker
提供了多种网络模式，满足不同的网络需求。理解这些网络模式对于构建复杂的容器化应用至关重要。</p>
<p><strong>网络模式概览</strong>：</p>
<ol type="1">
<li><strong>bridge（桥接）</strong>：默认模式，容器通过虚拟网桥连接</li>
<li><strong>host（主机）</strong>：容器直接使用主机网络</li>
<li><strong>none（无）</strong>：容器没有网络接口</li>
<li><strong>overlay（覆盖）</strong>：用于多主机网络，常用于 Swarm 或
Kubernetes</li>
<li><strong>macvlan</strong>：容器获得 MAC 地址，直接连接到物理网络</li>
</ol>
<h4 id="bridge-网络详解">Bridge 网络详解</h4>
<p>Bridge 网络是 Docker 的默认网络模式，每个容器都连接到名为
<code>docker0</code> 的虚拟网桥。容器之间可以通过容器名称或 IP
地址通信。</p>
<p><strong>Bridge 网络工作原理</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────┐         ┌─────────────┐</span><br><span class="line">│  Container1 │         │  Container2 │</span><br><span class="line">│  172.17.0.2 │         │  172.17.0.3 │</span><br><span class="line">└──────┬──────┘         └──────┬──────┘</span><br><span class="line">       │                      │</span><br><span class="line">       └──────────┬───────────┘</span><br><span class="line">                  │</span><br><span class="line">            ┌─────▼─────┐</span><br><span class="line">            │  docker0  │</span><br><span class="line">            │ 172.17.0.1│</span><br><span class="line">            └─────┬─────┘</span><br><span class="line">                  │</span><br><span class="line">            ┌─────▼─────┐</span><br><span class="line">            │   Host    │</span><br><span class="line">            │ Interface │</span><br><span class="line">            └───────────┘</span><br></pre></td></tr></table></figure>
<p><strong>创建自定义 Bridge 网络</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建基础 bridge 网络</span></span><br><span class="line">docker network create mynetwork</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带子网和网关的网络</span></span><br><span class="line">docker network create --driver bridge \</span><br><span class="line">  --subnet=172.20.0.0/16 \</span><br><span class="line">  --gateway=172.20.0.1 \</span><br><span class="line">  --ip-range=172.20.240.0/20 \</span><br><span class="line">  mynetwork</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带 DNS 配置的网络</span></span><br><span class="line">docker network create --driver bridge \</span><br><span class="line">  --subnet=172.20.0.0/16 \</span><br><span class="line">  --gateway=172.20.0.1 \</span><br><span class="line">  --dns=8.8.8.8 \</span><br><span class="line">  --dns=8.8.4.4 \</span><br><span class="line">  mynetwork</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建隔离网络（容器无法访问外部）</span></span><br><span class="line">docker network create --driver bridge \</span><br><span class="line">  --internal \</span><br><span class="line">  isolated-network</span><br></pre></td></tr></table></figure>
<p><strong>Bridge 网络高级配置</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看网络详细信息</span></span><br><span class="line">docker network inspect mynetwork</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出示例：</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;mynetwork&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Id&quot;: &quot;abc123...&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Created&quot;: &quot;2025-01-02T10:00:00Z&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;bridge&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;IPAM&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;Driver&quot;: &quot;default&quot;,</span></span><br><span class="line"><span class="comment">#             &quot;Config&quot;: [</span></span><br><span class="line"><span class="comment">#                 &#123;</span></span><br><span class="line"><span class="comment">#                     &quot;Subnet&quot;: &quot;172.20.0.0/16&quot;,</span></span><br><span class="line"><span class="comment">#                     &quot;Gateway&quot;: &quot;172.20.0.1&quot;</span></span><br><span class="line"><span class="comment">#                 &#125;</span></span><br><span class="line"><span class="comment">#             ]</span></span><br><span class="line"><span class="comment">#         &#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Containers&quot;: &#123;</span></span><br><span class="line"><span class="comment">#             &quot;container-id&quot;: &#123;</span></span><br><span class="line"><span class="comment">#                 &quot;Name&quot;: &quot;myapp&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;EndpointID&quot;: &quot;...&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;MacAddress&quot;: &quot;02:42:ac:14:00:02&quot;,</span></span><br><span class="line"><span class="comment">#                 &quot;IPv4Address&quot;: &quot;172.20.0.2/16&quot;</span></span><br><span class="line"><span class="comment">#             &#125;</span></span><br><span class="line"><span class="comment">#         &#125;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接容器到网络</span></span><br><span class="line">docker network connect mynetwork myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接时指定 IP 地址</span></span><br><span class="line">docker network connect --ip=172.20.0.100 mynetwork myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 断开连接</span></span><br><span class="line">docker network disconnect mynetwork myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除网络（需要先断开所有容器）</span></span><br><span class="line">docker network <span class="built_in">rm</span> mynetwork</span><br><span class="line"></span><br><span class="line"><span class="comment"># 强制删除网络</span></span><br><span class="line">docker network <span class="built_in">rm</span> -f mynetwork</span><br></pre></td></tr></table></figure>
<p><strong>Bridge 网络容器间通信</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建网络</span></span><br><span class="line">docker network create app-network</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动数据库容器</span></span><br><span class="line">docker run -d --name mysql \</span><br><span class="line">  --network app-network \</span><br><span class="line">  --network-alias db \</span><br><span class="line">  -e MYSQL_ROOT_PASSWORD=secret \</span><br><span class="line">  mysql:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动应用容器，通过容器名或别名访问数据库</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  --network app-network \</span><br><span class="line">  -e DB_HOST=mysql \</span><br><span class="line">  -e DB_HOST_ALT=db \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试容器间连通性</span></span><br><span class="line">docker <span class="built_in">exec</span> app ping -c 3 mysql</span><br><span class="line">docker <span class="built_in">exec</span> app ping -c 3 db</span><br></pre></td></tr></table></figure>
<h4 id="host-网络模式">Host 网络模式</h4>
<p>Host
网络模式下，容器直接使用主机的网络栈，没有网络隔离。性能最好，但安全性较低。</p>
<p><strong>使用 Host 网络</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 host 网络模式运行容器</span></span><br><span class="line">docker run -d --name nginx \</span><br><span class="line">  --network host \</span><br><span class="line">  nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 容器可以直接访问主机的所有网络接口</span></span><br><span class="line"><span class="comment"># 端口映射选项会被忽略（-p 无效）</span></span><br></pre></td></tr></table></figure>
<p><strong>Host 网络适用场景</strong>：</p>
<ul>
<li>需要最佳网络性能的应用</li>
<li>需要直接访问主机网络服务的场景</li>
<li>网络密集型应用（如负载均衡器）</li>
</ul>
<p><strong>Host 网络注意事项</strong>：</p>
<ul>
<li>容器端口直接绑定到主机，可能造成端口冲突</li>
<li>无法在同一主机上运行多个使用相同端口的容器</li>
<li>安全性较低，容器可以直接访问主机网络</li>
</ul>
<h4 id="overlay-网络详解">Overlay 网络详解</h4>
<p>Overlay 网络用于跨多个 Docker 主机连接容器，常用于 Docker Swarm 或
Kubernetes 集群。</p>
<p><strong>创建 Overlay 网络（Swarm 模式）</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化 Swarm</span></span><br><span class="line">docker swarm init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 overlay 网络</span></span><br><span class="line">docker network create \</span><br><span class="line">  --driver overlay \</span><br><span class="line">  --subnet=10.0.0.0/24 \</span><br><span class="line">  --attachable \</span><br><span class="line">  my-overlay-network</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在服务中使用 overlay 网络</span></span><br><span class="line">docker service create \</span><br><span class="line">  --name web \</span><br><span class="line">  --network my-overlay-network \</span><br><span class="line">  --replicas 3 \</span><br><span class="line">  nginx:latest</span><br></pre></td></tr></table></figure>
<p><strong>Overlay 网络特性</strong>：</p>
<ul>
<li>跨主机容器通信</li>
<li>自动服务发现</li>
<li>加密通信（可选）</li>
<li>支持多子网</li>
</ul>
<p><strong>Overlay 网络配置示例</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建加密的 overlay 网络</span></span><br><span class="line">docker network create \</span><br><span class="line">  --driver overlay \</span><br><span class="line">  --opt encrypted=<span class="literal">true</span> \</span><br><span class="line">  secure-overlay</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带自定义子网的 overlay 网络</span></span><br><span class="line">docker network create \</span><br><span class="line">  --driver overlay \</span><br><span class="line">  --subnet=10.1.0.0/24 \</span><br><span class="line">  --gateway=10.1.0.1 \</span><br><span class="line">  --ip-range=10.1.0.0/25 \</span><br><span class="line">  custom-overlay</span><br></pre></td></tr></table></figure>
<h4 id="macvlan-网络">Macvlan 网络</h4>
<p>Macvlan 允许容器直接连接到物理网络，每个容器都有独立的 MAC 地址。</p>
<p><strong>创建 Macvlan 网络</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 macvlan 网络</span></span><br><span class="line">docker network create -d macvlan \</span><br><span class="line">  --subnet=192.168.1.0/24 \</span><br><span class="line">  --gateway=192.168.1.1 \</span><br><span class="line">  -o parent=eth0 \</span><br><span class="line">  macvlan-net</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行容器使用 macvlan 网络</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  --network macvlan-net \</span><br><span class="line">  --ip=192.168.1.100 \</span><br><span class="line">  myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>Macvlan 网络管理</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有网络</span></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络详细信息</span></span><br><span class="line">docker network inspect mynetwork</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络中的容器</span></span><br><span class="line">docker network inspect mynetwork --format <span class="string">&#x27;&#123;&#123;range .Containers&#125;&#125;&#123;&#123;.Name&#125;&#125; &#123;&#123;end&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理未使用的网络</span></span><br><span class="line">docker network prune</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理所有未使用的网络（包括未使用的）</span></span><br><span class="line">docker network prune -a</span><br></pre></td></tr></table></figure>
<p><strong>网络故障排查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查容器网络配置</span></span><br><span class="line">docker inspect &lt;container-name&gt; | grep -A 20 <span class="string">&quot;NetworkSettings&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试容器间连通性</span></span><br><span class="line">docker <span class="built_in">exec</span> &lt;container1&gt; ping &lt;container2-ip&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看容器 DNS 配置</span></span><br><span class="line">docker <span class="built_in">exec</span> &lt;container&gt; <span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络接口</span></span><br><span class="line">docker <span class="built_in">exec</span> &lt;container&gt; ip addr show</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跟踪网络数据包（需要特权容器）</span></span><br><span class="line">docker run --<span class="built_in">rm</span> --privileged --network host \</span><br><span class="line">  nicolaka/netshoot tcpdump -i eth0</span><br></pre></td></tr></table></figure>
<h3 id="docker-存储驱动与卷管理">Docker 存储驱动与卷管理</h3>
<p>Docker
提供了多种数据持久化方案和存储驱动，理解这些机制对于优化容器性能和确保数据安全至关重要。</p>
<h4 id="存储驱动详解">存储驱动详解</h4>
<p>存储驱动控制 Docker
如何在宿主机上存储和管理镜像层。选择合适的存储驱动可以显著影响性能。</p>
<p><strong>Docker 支持的存储驱动</strong>：</p>
<ul>
<li><strong>overlay2</strong>：推荐使用，性能好，支持最多 128
层，适合大多数场景</li>
<li><strong>devicemapper</strong>：基于设备映射，适合生产环境，但性能不如
overlay2</li>
<li><strong>aufs</strong>：早期版本使用，现在较少使用，兼容性较好</li>
<li><strong>btrfs</strong>：需要 btrfs 文件系统支持，支持快照和压缩</li>
<li><strong>zfs</strong>：需要 ZFS 文件系统支持，功能强大但配置复杂</li>
</ul>
<p><strong>查看和配置存储驱动</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前存储驱动</span></span><br><span class="line">docker info | grep <span class="string">&quot;Storage Driver&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详细的存储信息</span></span><br><span class="line">docker system <span class="built_in">df</span> -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看存储驱动配置</span></span><br><span class="line"><span class="built_in">cat</span> /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置存储驱动（需要重启 Docker）</span></span><br><span class="line"><span class="comment"># /etc/docker/daemon.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;storage-driver&quot;</span>: <span class="string">&quot;overlay2&quot;</span>,</span><br><span class="line">  <span class="string">&quot;storage-opts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;overlay2.override_kernel_check=true&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Overlay2 存储驱动详解</strong>：</p>
<p>Overlay2 是推荐的存储驱动，使用 Linux 内核的 OverlayFS 文件系统。</p>
<p><strong>工作原理</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">镜像层结构：</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   Container     │  ← 可写层（容器层）</span><br><span class="line">├─────────────────┤</span><br><span class="line">│   Upper Dir     │  ← 容器修改的文件</span><br><span class="line">├─────────────────┤</span><br><span class="line">│   Lower Dirs    │  ← 只读镜像层（多个）</span><br><span class="line">│   (镜像层1)     │</span><br><span class="line">│   (镜像层2)     │</span><br><span class="line">│   (镜像层3)     │</span><br><span class="line">└─────────────────┘</span><br></pre></td></tr></table></figure></p>
<p><strong>Overlay2 优势</strong>：</p>
<ul>
<li>性能优异，接近原生文件系统</li>
<li>支持最多 128 层</li>
<li>支持页缓存共享，节省内存</li>
<li>支持硬链接，节省磁盘空间</li>
</ul>
<p><strong>检查 Overlay2 状态</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 overlay2 挂载信息</span></span><br><span class="line">mount | grep overlay</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看存储使用情况</span></span><br><span class="line">docker system <span class="built_in">df</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理未使用的数据</span></span><br><span class="line">docker system prune -a --volumes</span><br></pre></td></tr></table></figure>
<h4 id="数据卷volume管理">数据卷（Volume）管理</h4>
<p>数据卷是 Docker 推荐的数据持久化方式，由 Docker
管理，独立于容器生命周期。</p>
<p><strong>Volume 基础操作</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建数据卷</span></span><br><span class="line">docker volume create mydata</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带标签的卷</span></span><br><span class="line">docker volume create --label <span class="built_in">env</span>=prod \</span><br><span class="line">  --label app=myapp \</span><br><span class="line">  prod-data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有数据卷</span></span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据卷详细信息</span></span><br><span class="line">docker volume inspect mydata</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出示例：</span></span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;CreatedAt&quot;: &quot;2025-01-02T10:00:00Z&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/mydata/_data&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;mydata&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除数据卷</span></span><br><span class="line">docker volume <span class="built_in">rm</span> mydata</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除未使用的数据卷</span></span><br><span class="line">docker volume prune</span><br></pre></td></tr></table></figure>
<p><strong>Volume 高级用法</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建带驱动选项的卷</span></span><br><span class="line">docker volume create \</span><br><span class="line">  --driver <span class="built_in">local</span> \</span><br><span class="line">  --opt <span class="built_in">type</span>=none \</span><br><span class="line">  --opt device=/host/path \</span><br><span class="line">  --opt o=<span class="built_in">bind</span> \</span><br><span class="line">  myvolume</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用卷运行容器</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  -v mydata:/var/lib/data:ro \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载选项说明：</span></span><br><span class="line"><span class="comment"># :ro - 只读挂载</span></span><br><span class="line"><span class="comment"># :rw - 读写挂载（默认）</span></span><br><span class="line"><span class="comment"># :z  - SELinux 共享标签</span></span><br><span class="line"><span class="comment"># :Z  - SELinux 私有标签</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个卷挂载</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  -v data1:/app/data1 \</span><br><span class="line">  -v data2:/app/data2 \</span><br><span class="line">  -v data3:/app/data3 \</span><br><span class="line">  myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>Volume 备份与恢复</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份卷数据</span></span><br><span class="line">docker run --<span class="built_in">rm</span> \</span><br><span class="line">  -v mydata:/data \</span><br><span class="line">  -v $(<span class="built_in">pwd</span>):/backup \</span><br><span class="line">  alpine tar czf /backup/mydata-backup.tar.gz -C /data .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复卷数据</span></span><br><span class="line">docker run --<span class="built_in">rm</span> \</span><br><span class="line">  -v mydata:/data \</span><br><span class="line">  -v $(<span class="built_in">pwd</span>):/backup \</span><br><span class="line">  alpine sh -c <span class="string">&quot;cd /data &amp;&amp; tar xzf /backup/mydata-backup.tar.gz&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卷迁移示例</span></span><br><span class="line">docker run --<span class="built_in">rm</span> \</span><br><span class="line">  -v source-volume:/source \</span><br><span class="line">  -v target-volume:/target \</span><br><span class="line">  alpine sh -c <span class="string">&quot;cp -a /source/. /target/&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="绑定挂载bind-mount">绑定挂载（Bind Mount）</h4>
<p>绑定挂载将主机文件系统路径直接挂载到容器，适合开发环境和配置文件管理。</p>
<p><strong>绑定挂载用法</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基本绑定挂载</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  -v /host/path:/container/path \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只读绑定挂载</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  -v /host/config:/app/config:ro \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载单个文件</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  -v /host/config.json:/app/config.json:ro \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用绝对路径（推荐）</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  -v $(<span class="built_in">pwd</span>)/config:/app/config \</span><br><span class="line">  myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>绑定挂载注意事项</strong>：</p>
<ul>
<li>路径必须存在，否则 Docker 会创建目录</li>
<li>文件挂载时，如果文件不存在，Docker 会创建空文件</li>
<li>权限问题：容器内进程的 UID/GID 需要匹配文件权限</li>
<li>性能：绑定挂载性能略低于 Volume</li>
</ul>
<p><strong>权限问题处理</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看文件权限</span></span><br><span class="line"><span class="built_in">ls</span> -la /host/path</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用特定用户运行容器</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  --user 1000:1000 \</span><br><span class="line">  -v /host/path:/container/path \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Dockerfile 中设置用户</span></span><br><span class="line"><span class="comment"># USER 1000:1000</span></span><br></pre></td></tr></table></figure>
<h4 id="临时文件系统tmpfs">临时文件系统（tmpfs）</h4>
<p>tmpfs 将数据存储在内存中，适合临时数据和缓存。</p>
<p><strong>tmpfs 用法</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 tmpfs 挂载</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  --tmpfs /tmp \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定 tmpfs 大小和选项</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  --tmpfs /tmp:rw,noexec,nosuid,size=100m \</span><br><span class="line">  myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># tmpfs 选项说明：</span></span><br><span class="line"><span class="comment"># rw - 读写（默认）</span></span><br><span class="line"><span class="comment"># ro - 只读</span></span><br><span class="line"><span class="comment"># noexec - 禁止执行</span></span><br><span class="line"><span class="comment"># nosuid - 禁止 setuid</span></span><br><span class="line"><span class="comment"># size - 大小限制（如 100m, 1g）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多个 tmpfs 挂载</span></span><br><span class="line">docker run -d --name app \</span><br><span class="line">  --tmpfs /tmp:size=100m \</span><br><span class="line">  --tmpfs /cache:size=200m \</span><br><span class="line">  myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>tmpfs 适用场景</strong>：</p>
<ul>
<li>临时文件存储</li>
<li>缓存数据（如编译缓存）</li>
<li>敏感数据（容器停止后自动清除）</li>
<li>高性能临时存储需求</li>
</ul>
<h4 id="存储最佳实践">存储最佳实践</h4>
<p><strong>1. 选择合适的存储方式</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生产环境：使用 Volume</span></span><br><span class="line">docker run -v db-data:/var/lib/mysql mysql:8.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发环境：使用绑定挂载</span></span><br><span class="line">docker run -v $(<span class="built_in">pwd</span>):/app myapp:dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时数据：使用 tmpfs</span></span><br><span class="line">docker run --tmpfs /tmp myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>2. 数据卷命名规范</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用有意义的名称</span></span><br><span class="line">docker volume create app-db-data</span><br><span class="line">docker volume create app-cache-data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用标签组织</span></span><br><span class="line">docker volume create \</span><br><span class="line">  --label project=myapp \</span><br><span class="line">  --label <span class="built_in">env</span>=production \</span><br><span class="line">  prod-db-data</span><br></pre></td></tr></table></figure>
<p><strong>3. 存储清理策略</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看存储使用情况</span></span><br><span class="line">docker system <span class="built_in">df</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理未使用的数据</span></span><br><span class="line">docker system prune</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理包括卷的数据（谨慎使用）</span></span><br><span class="line">docker system prune -a --volumes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定期清理脚本</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 清理超过7天未使用的容器</span></span><br><span class="line">docker container prune -f --filter <span class="string">&quot;until=168h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理未使用的镜像</span></span><br><span class="line">docker image prune -a -f --filter <span class="string">&quot;until=168h&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理未使用的卷</span></span><br><span class="line">docker volume prune -f</span><br></pre></td></tr></table></figure>
<p><strong>4. 存储监控</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监控卷使用情况</span></span><br><span class="line">docker system <span class="built_in">df</span> -v | grep -A 10 <span class="string">&quot;VOLUME NAME&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查卷大小</span></span><br><span class="line"><span class="built_in">du</span> -sh /var/lib/docker/volumes/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找大文件</span></span><br><span class="line">docker <span class="built_in">exec</span> &lt;container&gt; find /data -<span class="built_in">type</span> f -size +100M</span><br></pre></td></tr></table></figure>
<h2 id="dockerfile最佳实践与多阶段构建">Dockerfile最佳实践与多阶段构建</h2>
<h3 id="dockerfile-基础语法">Dockerfile 基础语法</h3>
<p>Dockerfile 由一系列指令组成，每条指令创建一个新的镜像层。</p>
<p><strong>常用指令</strong>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 维护者信息</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;your-email@example.com&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置工作目录</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制文件</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加文件（支持 URL 和解压）</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> https://example.com/file.tar.gz /tmp/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y python3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> PYTHONUNBUFFERED=<span class="number">1</span></span><br><span class="line"><span class="keyword">ENV</span> APP_VERSION=<span class="number">1.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置入口点</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;python3&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置默认命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--help&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<h3 id="dockerfile-最佳实践">Dockerfile 最佳实践</h3>
<p><strong>1. 使用多阶段构建减少镜像大小</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建阶段</span></span><br><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.19</span>-alpine AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> go build -o app .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行阶段</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:latest</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk --no-cache add ca-certificates</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /build/app .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;./app&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 合理利用缓存层</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先复制依赖文件，利用缓存</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再复制应用代码（代码变更频繁）</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br></pre></td></tr></table></figure>
<p><strong>3. 使用 .dockerignore</strong></p>
<p>创建 <code>.dockerignore</code> 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">node_modules</span><br><span class="line">.git</span><br><span class="line">.env</span><br><span class="line">*.log</span><br><span class="line">dist</span><br></pre></td></tr></table></figure>
<p><strong>4. 使用非 root 用户运行</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> addgroup -g 1000 appuser &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    adduser -D -u 1000 -G appuser appuser</span></span><br><span class="line"><span class="keyword">USER</span> appuser</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /home/appuser</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --<span class="built_in">chown</span>=appuser:appuser . .</span></span><br></pre></td></tr></table></figure>
<p><strong>5. 健康检查</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">HEALTHCHECK</span><span class="language-bash"> --interval=30s --<span class="built_in">timeout</span>=3s --start-period=5s --retries=3 \</span></span><br><span class="line"><span class="language-bash">  CMD curl -f http://localhost:8080/health || <span class="built_in">exit</span> 1</span></span><br></pre></td></tr></table></figure>
<h3 id="多阶段构建实战">多阶段构建实战</h3>
<p><strong>示例：构建 Python Flask 应用</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 阶段1：构建依赖</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install --user --no-cache-dir -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 阶段2：运行环境</span></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-slim</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从构建阶段复制已安装的包</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /root/.local /root/.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用代码</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保使用本地安装的包</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=/root/.local/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行应用</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;python&quot;</span>, <span class="string">&quot;app.py&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p><strong>示例：构建 Node.js 应用</strong></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 阶段1：构建</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm ci --only=production</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 阶段2：运行</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /build/node_modules ./node_modules</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3000</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;node&quot;</span>, <span class="string">&quot;server.js&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<h2 id="docker-compose编排">Docker Compose编排</h2>
<p>Docker Compose 用于定义和运行多容器 Docker 应用。通过 YAML
文件配置服务、网络和卷。</p>
<h3 id="compose-文件结构">Compose 文件结构</h3>
<p><strong>基本示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">FLASK_ENV=production</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_data:/var/lib/postgresql/data</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br></pre></td></tr></table></figure>
<h3 id="常用配置项">常用配置项</h3>
<p><strong>服务配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="comment"># 构建配置</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile.prod</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">VERSION:</span> <span class="number">1.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 镜像</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:v1.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 命令覆盖</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">python</span> <span class="string">app.py</span> <span class="string">--debug</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 环境变量</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NODE_ENV=production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DATABASE_URL=postgres://user:pass@db:5432/mydb</span></span><br><span class="line">    <span class="attr">env_file:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.env.production</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 端口映射</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8443:443&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 卷挂载</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data:/app/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app_cache:/app/cache</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 网络</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 依赖服务</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cache</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 重启策略</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 资源限制</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&#x27;0.5&#x27;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">512M</span></span><br><span class="line">        <span class="attr">reservations:</span></span><br><span class="line">          <span class="attr">cpus:</span> <span class="string">&#x27;0.25&#x27;</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">256M</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 健康检查</span></span><br><span class="line">    <span class="attr">healthcheck:</span></span><br><span class="line">      <span class="attr">test:</span> [<span class="string">&quot;CMD&quot;</span>, <span class="string">&quot;curl&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;http://localhost:8080/health&quot;</span>]</span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">start_period:</span> <span class="string">40s</span></span><br></pre></td></tr></table></figure>
<p><strong>网络配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>卷配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">    <span class="attr">driver_opts:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">none</span></span><br><span class="line">      <span class="attr">o:</span> <span class="string">bind</span></span><br><span class="line">      <span class="attr">device:</span> <span class="string">/path/to/data</span></span><br></pre></td></tr></table></figure>
<h3 id="compose-命令">Compose 命令</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务状态</span></span><br><span class="line">docker-compose ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">docker-compose logs -f web</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务</span></span><br><span class="line">docker-compose stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止并删除容器</span></span><br><span class="line">docker-compose down</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止并删除容器、网络、卷</span></span><br><span class="line">docker-compose down -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新构建并启动</span></span><br><span class="line">docker-compose up -d --build</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展服务实例</span></span><br><span class="line">docker-compose up -d --scale web=3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行命令</span></span><br><span class="line">docker-compose <span class="built_in">exec</span> web python manage.py migrate</span><br></pre></td></tr></table></figure>
<h3 id="实战案例微服务应用栈">实战案例：微服务应用栈</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># Nginx 反向代理</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:alpine</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./ssl:/etc/nginx/ssl</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">api</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 前端应用</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./frontend</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">API_URL=http://api:3000</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># API 服务</span></span><br><span class="line">  <span class="attr">api:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./api</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DATABASE_URL=postgres://user:pass@db:5432/mydb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REDIS_URL=redis://redis:6379</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 数据库</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:13</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">mydb</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_data:/var/lib/postgresql/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Redis 缓存</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">backend</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">frontend:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br><span class="line">  <span class="attr">backend:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<h2 id="kubernetes核心概念">Kubernetes核心概念</h2>
<p>Kubernetes（K8s）是 Google
开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。</p>
<h3 id="集群架构">集群架构</h3>
<p>Kubernetes 集群由控制平面（Control
Plane）和工作节点（Node）组成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│         Control Plane               │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐        │</span><br><span class="line">│  │ API      │  │ etcd     │        │</span><br><span class="line">│  │ Server   │  │          │        │</span><br><span class="line">│  └──────────┘  └──────────┘        │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐        │</span><br><span class="line">│  │ Scheduler│  │ Controller│       │</span><br><span class="line">│  │          │  │ Manager  │        │</span><br><span class="line">│  └──────────┘  └──────────┘        │</span><br><span class="line">└─────────────────────────────────────┘</span><br><span class="line">              │</span><br><span class="line">              │</span><br><span class="line">    ┌─────────┴─────────┐</span><br><span class="line">    │                   │</span><br><span class="line">┌───▼────┐         ┌───▼────┐</span><br><span class="line">│ Node 1 │         │ Node 2 │</span><br><span class="line">│ ┌────┐ │         │ ┌────┐ │</span><br><span class="line">│ │Pod │ │         │ │Pod │ │</span><br><span class="line">│ └────┘ │         │ └────┘ │</span><br><span class="line">│ ┌────┐ │         │ ┌────┐ │</span><br><span class="line">│ │Pod │ │         │ │Pod │ │</span><br><span class="line">│ └────┘ │         │ └────┘ │</span><br><span class="line">└────────┘         └────────┘</span><br></pre></td></tr></table></figure>
<p><strong>控制平面组件</strong>：</p>
<ul>
<li><strong>API Server</strong>：集群的前端接口，处理所有 REST 请求</li>
<li><strong>etcd</strong>：分布式键值存储，保存集群状态</li>
<li><strong>Scheduler</strong>：调度器，决定 Pod 运行在哪个节点</li>
<li><strong>Controller
Manager</strong>：运行各种控制器，维护集群状态</li>
</ul>
<p><strong>节点组件</strong>：</p>
<ul>
<li><strong>kubelet</strong>：节点代理，与 API Server 通信</li>
<li><strong>kube-proxy</strong>：网络代理，实现服务发现和负载均衡</li>
<li><strong>容器运行时</strong>：Docker、containerd 等</li>
</ul>
<h3 id="pod">Pod</h3>
<p>Pod 是 Kubernetes
的最小调度单元，包含一个或多个容器，共享网络和存储。</p>
<p><strong>Pod 定义示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.21</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx-config</span></span><br></pre></td></tr></table></figure>
<p><strong>Pod 生命周期</strong>：</p>
<ol type="1">
<li><strong>Pending</strong>：Pod 已被创建，但容器尚未启动</li>
<li><strong>Running</strong>：Pod 已绑定到节点，所有容器已创建</li>
<li><strong>Succeeded</strong>：所有容器成功终止</li>
<li><strong>Failed</strong>：至少一个容器终止失败</li>
<li><strong>Unknown</strong>：无法获取 Pod 状态</li>
</ol>
<h3 id="service">Service</h3>
<p>Service 为 Pod 提供稳定的网络访问，实现服务发现和负载均衡。</p>
<p><strong>Service 类型</strong>：</p>
<ol type="1">
<li><strong>ClusterIP</strong>：默认类型，在集群内部访问</li>
<li><strong>NodePort</strong>：通过节点端口暴露服务</li>
<li><strong>LoadBalancer</strong>：使用云提供商的负载均衡器</li>
<li><strong>ExternalName</strong>：将服务映射到外部 DNS 名称</li>
</ol>
<p><strong>Service 定义示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">ClientIP</span></span><br><span class="line">  <span class="attr">sessionAffinityConfig:</span></span><br><span class="line">    <span class="attr">clientIP:</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">10800</span></span><br></pre></td></tr></table></figure>
<p><strong>NodePort Service</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-nodeport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30080</span></span><br></pre></td></tr></table></figure>
<h3 id="deployment">Deployment</h3>
<p>Deployment 管理 Pod 的副本集，提供声明式更新、回滚和扩缩容功能。</p>
<p><strong>Deployment 定义示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.21</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><strong>Deployment 操作</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Deployment</span></span><br><span class="line">kubectl apply -f deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Deployment</span></span><br><span class="line">kubectl get deployments</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩缩容</span></span><br><span class="line">kubectl scale deployment nginx-deployment --replicas=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新镜像</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-deployment nginx=nginx:1.22</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看更新历史</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚</span></span><br><span class="line">kubectl rollout undo deployment/nginx-deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到特定版本</span></span><br><span class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看更新状态</span></span><br><span class="line">kubectl rollout status deployment/nginx-deployment</span><br></pre></td></tr></table></figure>
<h3 id="statefulset">StatefulSet</h3>
<p>StatefulSet 用于管理有状态应用，提供稳定的网络标识和有序部署。</p>
<p><strong>StatefulSet 特性</strong>：</p>
<ul>
<li>稳定的网络标识：Pod 名称和 DNS 名称保持不变</li>
<li>有序部署和扩展：按顺序创建和删除 Pod</li>
<li>有序更新：按顺序更新 Pod</li>
<li>持久存储：每个 Pod 有独立的存储卷</li>
</ul>
<p><strong>StatefulSet 定义示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure>
<p><strong>StatefulSet 操作</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 StatefulSet</span></span><br><span class="line">kubectl apply -f statefulset.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 StatefulSet</span></span><br><span class="line">kubectl get statefulset</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod（按顺序命名）</span></span><br><span class="line">kubectl get pods -l app=mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扩展 StatefulSet</span></span><br><span class="line">kubectl scale statefulset mysql-statefulset --replicas=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 StatefulSet（需要先删除 Pod）</span></span><br><span class="line">kubectl delete statefulset mysql-statefulset</span><br></pre></td></tr></table></figure>
<h2 id="k8s集群部署">K8s集群部署</h2>
<h3 id="kubeadm-部署推荐">kubeadm 部署（推荐）</h3>
<p>kubeadm 是 Kubernetes
官方提供的集群部署工具，适合快速搭建测试和生产环境。</p>
<p><strong>前置准备</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在所有节点上执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 关闭 swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -i <span class="string">&#x27;/ swap / s/^\(.*\)$/#\1/g&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 配置内核参数</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables  = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward                 = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sudo sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 安装容器运行时（containerd）</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | sudo tee /etc/modules-load.d/containerd.conf</span></span><br><span class="line"><span class="string">overlay</span></span><br><span class="line"><span class="string">br_netfilter</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">sudo modprobe overlay</span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/containerd</span><br><span class="line">containerd config default | sudo <span class="built_in">tee</span> /etc/containerd/config.toml</span><br><span class="line">sudo systemctl restart containerd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 安装 kubeadm、kubelet、kubectl</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y apt-transport-https ca-certificates curl</span><br><span class="line"></span><br><span class="line">sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list</span><br><span class="line"></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install -y kubelet kubeadm kubectl</span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>
<p><strong>初始化控制平面节点</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在主节点执行</span></span><br><span class="line">sudo kubeadm init \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16 \</span><br><span class="line">  --apiserver-advertise-address=192.168.1.100 \</span><br><span class="line">  --control-plane-endpoint=192.168.1.100:6443 \</span><br><span class="line">  --upload-certs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置 kubectl</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>
<p><strong>安装网络插件（Flannel）</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<p><strong>加入工作节点</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在工作节点执行（使用初始化时输出的 join 命令）</span></span><br><span class="line">sudo kubeadm <span class="built_in">join</span> 192.168.1.100:6443 \</span><br><span class="line">  --token &lt;token&gt; \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:&lt;<span class="built_in">hash</span>&gt;</span><br></pre></td></tr></table></figure>
<p><strong>验证集群</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点</span></span><br><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有 Pod</span></span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看集群信息</span></span><br><span class="line">kubectl cluster-info</span><br></pre></td></tr></table></figure>
<h3 id="二进制部署">二进制部署</h3>
<p>二进制部署提供更多控制，适合需要自定义配置的场景。</p>
<p><strong>下载二进制文件</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 Kubernetes 组件</span></span><br><span class="line">wget https://dl.k8s.io/v1.28.0/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">tar -xzf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载 etcd</span></span><br><span class="line">wget https://github.com/etcd-io/etcd/releases/download/v3.5.9/etcd-v3.5.9-linux-amd64.tar.gz</span><br><span class="line">tar -xzf etcd-v3.5.9-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<p><strong>配置 etcd</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 etcd 配置</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/etcd/etcd.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">ETCD_NAME=etcd1</span></span><br><span class="line"><span class="string">ETCD_DATA_DIR=/var/lib/etcd</span></span><br><span class="line"><span class="string">ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379</span></span><br><span class="line"><span class="string">ETCD_ADVERTISE_CLIENT_URLS=http://192.168.1.100:2379</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 systemd 服务</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/etcd.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=etcd</span></span><br><span class="line"><span class="string">After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=notify</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.conf</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> etcd</span><br><span class="line">systemctl start etcd</span><br></pre></td></tr></table></figure>
<p><strong>配置 API Server</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 API Server 配置</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/kubernetes/apiserver.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">KUBE_API_ARGS=&quot;--etcd-servers=http://127.0.0.1:2379 \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.96.0.0/12 \</span></span><br><span class="line"><span class="string">  --advertise-address=192.168.1.100 \</span></span><br><span class="line"><span class="string">  --allow-privileged=true \</span></span><br><span class="line"><span class="string">  --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">  --enable-admission-plugins=NodeRestriction&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 systemd 服务</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/kube-apiserver.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Kubernetes API Server</span></span><br><span class="line"><span class="string">After=etcd.service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/kube-apiserver \$KUBE_API_ARGS</span></span><br><span class="line"><span class="string">Restart=always</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kube-apiserver</span><br><span class="line">systemctl start kube-apiserver</span><br></pre></td></tr></table></figure>
<h3 id="高可用部署">高可用部署</h3>
<p>高可用集群需要多个控制平面节点，使用负载均衡器分发请求。</p>
<p><strong>架构设计</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                    ┌─────────────┐</span><br><span class="line">                    │ Load        │</span><br><span class="line">                    │ Balancer    │</span><br><span class="line">                    │ (HAProxy)   │</span><br><span class="line">                    └──────┬──────┘</span><br><span class="line">                           │</span><br><span class="line">        ┌──────────────────┼──────────────────┐</span><br><span class="line">        │                  │                  │</span><br><span class="line">┌───────▼──────┐  ┌────────▼──────┐  ┌────────▼──────┐</span><br><span class="line">│ Master Node 1│  │ Master Node 2 │  │ Master Node 3 │</span><br><span class="line">│              │  │               │  │               │</span><br><span class="line">│ API Server   │  │ API Server    │  │ API Server    │</span><br><span class="line">│ etcd         │  │ etcd          │  │ etcd          │</span><br><span class="line">│ Scheduler    │  │ Scheduler     │  │ Scheduler     │</span><br><span class="line">│ Controller   │  │ Controller    │  │ Controller    │</span><br><span class="line">└──────────────┘  └───────────────┘  └───────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>使用 kubeadm 部署高可用集群</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 配置负载均衡器（HAProxy）</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/haproxy/haproxy.cfg &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">global</span></span><br><span class="line"><span class="string">    log /dev/log local0</span></span><br><span class="line"><span class="string">    chroot /var/lib/haproxy</span></span><br><span class="line"><span class="string">    stats socket /run/haproxy/admin.sock mode 660 level admin</span></span><br><span class="line"><span class="string">    stats timeout 30s</span></span><br><span class="line"><span class="string">    user haproxy</span></span><br><span class="line"><span class="string">    group haproxy</span></span><br><span class="line"><span class="string">    daemon</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">defaults</span></span><br><span class="line"><span class="string">    mode http</span></span><br><span class="line"><span class="string">    log global</span></span><br><span class="line"><span class="string">    option httplog</span></span><br><span class="line"><span class="string">    option dontlognull</span></span><br><span class="line"><span class="string">    timeout connect 5000ms</span></span><br><span class="line"><span class="string">    timeout client 50000ms</span></span><br><span class="line"><span class="string">    timeout server 50000ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">frontend kubernetes-frontend</span></span><br><span class="line"><span class="string">    bind *:6443</span></span><br><span class="line"><span class="string">    mode tcp</span></span><br><span class="line"><span class="string">    option tcplog</span></span><br><span class="line"><span class="string">    default_backend kubernetes-backend</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">backend kubernetes-backend</span></span><br><span class="line"><span class="string">    mode tcp</span></span><br><span class="line"><span class="string">    balance roundrobin</span></span><br><span class="line"><span class="string">    option tcp-check</span></span><br><span class="line"><span class="string">    server master1 192.168.1.101:6443 check</span></span><br><span class="line"><span class="string">    server master2 192.168.1.102:6443 check</span></span><br><span class="line"><span class="string">    server master3 192.168.1.103:6443 check</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">systemctl restart haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 初始化第一个控制平面节点</span></span><br><span class="line">sudo kubeadm init \</span><br><span class="line">  --control-plane-endpoint=192.168.1.100:6443 \</span><br><span class="line">  --upload-certs \</span><br><span class="line">  --pod-network-cidr=10.244.0.0/16</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 在其他控制平面节点执行 join</span></span><br><span class="line">sudo kubeadm <span class="built_in">join</span> 192.168.1.100:6443 \</span><br><span class="line">  --control-plane \</span><br><span class="line">  --token &lt;token&gt; \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:&lt;<span class="built_in">hash</span>&gt; \</span><br><span class="line">  --certificate-key &lt;certificate-key&gt;</span><br></pre></td></tr></table></figure>
<h2 id="k8s网络与存储">K8s网络与存储</h2>
<h3 id="kubernetes-网络模型">Kubernetes 网络模型</h3>
<p>Kubernetes 网络遵循以下原则：</p>
<ol type="1">
<li><strong>每个 Pod 都有独立的 IP 地址</strong></li>
<li><strong>Pod 之间可以直接通信，无需 NAT</strong></li>
<li><strong>节点上的 Pod 可以与所有节点上的 Pod 通信</strong></li>
</ol>
<p><strong>网络插件</strong>：</p>
<ul>
<li><strong>Flannel</strong>：简单易用，使用 VXLAN 或 host-gw</li>
<li><strong>Calico</strong>：功能强大，支持网络策略和 BGP</li>
<li><strong>Weave Net</strong>：自动网络发现，支持加密</li>
<li><strong>Cilium</strong>：基于 eBPF，高性能</li>
</ul>
<p><strong>Flannel 配置示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-flannel-cfg</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">cni-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;name&quot;: &quot;cbr0&quot;,</span></span><br><span class="line"><span class="string">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span></span><br><span class="line"><span class="string">      &quot;plugins&quot;: [</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;flannel&quot;,</span></span><br><span class="line"><span class="string">          &quot;delegate&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;hairpinMode&quot;: true,</span></span><br><span class="line"><span class="string">            &quot;isDefaultGateway&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">          &quot;type&quot;: &quot;portmap&quot;,</span></span><br><span class="line"><span class="string">          &quot;capabilities&quot;: &#123;</span></span><br><span class="line"><span class="string">            &quot;portMappings&quot;: true</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      ]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  <span class="attr">net-conf.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span></span><br><span class="line"><span class="string">      &quot;Backend&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;Type&quot;: &quot;vxlan&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="service-网络">Service 网络</h3>
<p><strong>ClusterIP Service</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p><strong>Headless Service</strong>（用于 StatefulSet）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>
<h3 id="ingress-详解">Ingress 详解</h3>
<p>Ingress 提供 HTTP/HTTPS 路由，支持基于域名和路径的路由，是 Kubernetes
中暴露服务到集群外部的主要方式。</p>
<h4 id="ingress-基础概念">Ingress 基础概念</h4>
<p>Ingress 需要 Ingress Controller 才能工作，常见的 Controller
包括：</p>
<ul>
<li><strong>Nginx Ingress Controller</strong>：功能丰富，使用最广泛</li>
<li><strong>Traefik</strong>：自动服务发现，配置简单</li>
<li><strong>HAProxy Ingress</strong>：高性能，适合大规模场景</li>
<li><strong>Istio Gateway</strong>：与服务网格集成</li>
</ul>
<p><strong>安装 Nginx Ingress Controller</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用官方 YAML 安装</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 Helm 安装</span></span><br><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm install ingress-nginx ingress-nginx/ingress-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">kubectl get pods -n ingress-nginx</span><br><span class="line">kubectl get svc -n ingress-nginx</span><br></pre></td></tr></table></figure>
<h4 id="ingress-基本配置">Ingress 基本配置</h4>
<p><strong>简单 Ingress 示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>PathType 说明</strong>：</p>
<ul>
<li><code>Exact</code>：精确匹配路径</li>
<li><code>Prefix</code>：前缀匹配（最常用）</li>
<li><code>ImplementationSpecific</code>：由 Ingress Controller 决定</li>
</ul>
<h4 id="ingress-高级配置">Ingress 高级配置</h4>
<p><strong>多路径路由</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">multi-path-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="string">/$2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="comment"># API 路由</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/api(/|$)(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">      <span class="comment"># 前端路由</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/app(/|$)(.*)</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">ImplementationSpecific</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">frontend-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="comment"># 默认路由</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">default-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>TLS/HTTPS 配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tls-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">app.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">app.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>创建 TLS Secret</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用现有证书创建 Secret</span></span><br><span class="line">kubectl create secret tls tls-secret \</span><br><span class="line">  --cert=path/to/cert.crt \</span><br><span class="line">  --key=path/to/cert.key</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Let&#x27;s Encrypt（需要 cert-manager）</span></span><br><span class="line"><span class="comment"># 安装 cert-manager</span></span><br><span class="line">kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 ClusterIssuer</span></span><br><span class="line">apiVersion: cert-manager.io/v1</span><br><span class="line">kind: ClusterIssuer</span><br><span class="line">metadata:</span><br><span class="line">  name: letsencrypt-prod</span><br><span class="line">spec:</span><br><span class="line">  acme:</span><br><span class="line">    server: https://acme-v02.api.letsencrypt.org/directory</span><br><span class="line">    email: your-email@example.com</span><br><span class="line">    privateKeySecretRef:</span><br><span class="line">      name: letsencrypt-prod</span><br><span class="line">    solvers:</span><br><span class="line"></span><br><span class="line">    - http01:</span><br><span class="line">        ingress:</span><br><span class="line">          class: nginx</span><br></pre></td></tr></table></figure>
<p><strong>使用 cert-manager 自动 TLS</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">auto-tls-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">&quot;letsencrypt-prod&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">api-tls-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h4 id="nginx-ingress-常用注解">Nginx Ingress 常用注解</h4>
<p><strong>限流配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rate-limit-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/limit-rps:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/limit-connections:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>CORS 配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cors-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/enable-cors:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="string">&quot;https://example.com&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="string">&quot;GET, POST, PUT, DELETE, OPTIONS&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="string">&quot;DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>SSL 重定向</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ssl-redirect-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/force-ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">tls:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">tls-secret</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>自定义 Nginx 配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">custom-config-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-body-size:</span> <span class="string">&quot;10m&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-connect-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/client-max-body-size:</span> <span class="string">&quot;10m&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>基于 Cookie 的会话保持</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">session-affinity-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/affinity:</span> <span class="string">&quot;cookie&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/session-cookie-name:</span> <span class="string">&quot;route&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/session-cookie-expires:</span> <span class="string">&quot;172800&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/session-cookie-max-age:</span> <span class="string">&quot;172800&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">app.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">app-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h4 id="ingress-故障排查">Ingress 故障排查</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Ingress 状态</span></span><br><span class="line">kubectl get ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Ingress 详细信息</span></span><br><span class="line">kubectl describe ingress my-ingress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Ingress Controller 日志</span></span><br><span class="line">kubectl logs -n ingress-nginx deployment/ingress-nginx-controller</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 Ingress 路由</span></span><br><span class="line">curl -H <span class="string">&quot;Host: api.example.com&quot;</span> http://&lt;ingress-ip&gt;/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Ingress Controller 配置</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -n ingress-nginx deployment/ingress-nginx-controller -- <span class="built_in">cat</span> /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>
<h3 id="存储卷">存储卷</h3>
<p><strong>PersistentVolume（PV）和
PersistentVolumeClaim（PVC）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义 PersistentVolume</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 定义 PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 在 Pod 中使用</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br></pre></td></tr></table></figure>
<p><strong>StorageClass（动态 provisioning）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fast-ssd</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/no-provisioner</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br><span class="line"><span class="attr">allowVolumeExpansion:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="configmap-和-secret-管理">ConfigMap 和 Secret 管理</h3>
<p>ConfigMap 和 Secret 是 Kubernetes
中管理配置和敏感信息的重要资源。</p>
<h4 id="configmap-详解">ConfigMap 详解</h4>
<p>ConfigMap
用于存储非敏感的配置数据，如配置文件、环境变量、命令行参数等。</p>
<p><strong>创建 ConfigMap</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：从字面量创建</span></span><br><span class="line">kubectl create configmap my-config \</span><br><span class="line">  --from-literal=key1=value1 \</span><br><span class="line">  --from-literal=key2=value2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2：从文件创建</span></span><br><span class="line">kubectl create configmap my-config \</span><br><span class="line">  --from-file=config.properties</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式3：从目录创建</span></span><br><span class="line">kubectl create configmap my-config \</span><br><span class="line">  --from-file=/path/to/config/dir</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式4：从环境文件创建</span></span><br><span class="line">kubectl create configmap my-config \</span><br><span class="line">  --from-env-file=config.env</span><br></pre></td></tr></table></figure>
<p><strong>YAML 方式定义 ConfigMap</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 键值对形式</span></span><br><span class="line">  <span class="attr">database.host:</span> <span class="string">&quot;mysql-service&quot;</span></span><br><span class="line">  <span class="attr">database.port:</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">  <span class="attr">cache.host:</span> <span class="string">&quot;redis-service&quot;</span></span><br><span class="line">  <span class="attr">cache.port:</span> <span class="string">&quot;6379&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 文件形式（多行内容）</span></span><br><span class="line">  <span class="attr">nginx.conf:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    server &#123;</span></span><br><span class="line"><span class="string">        listen 80;</span></span><br><span class="line"><span class="string">        server_name example.com;</span></span><br><span class="line"><span class="string">        location / &#123;</span></span><br><span class="line"><span class="string">            proxy_pass http://backend;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">  <span class="attr">application.properties:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    spring.datasource.url=jdbc:mysql://mysql-service:3306/mydb</span></span><br><span class="line"><span class="string">    spring.redis.host=redis-service</span></span><br><span class="line"><span class="string">    spring.redis.port=6379</span></span><br></pre></td></tr></table></figure>
<p><strong>在 Pod 中使用 ConfigMap</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="comment"># 方式1：作为环境变量</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">database.host</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PORT</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">database.port</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方式2：使用 envFrom 导入所有键值对</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方式3：作为文件挂载</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/config</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-config-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="comment"># 挂载整个 ConfigMap</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 挂载特定键</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-config-volume</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nginx.conf</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">nginx.conf</span></span><br></pre></td></tr></table></figure>
<p><strong>ConfigMap 更新和热重载</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新 ConfigMap</span></span><br><span class="line">kubectl edit configmap app-config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或通过文件更新</span></span><br><span class="line">kubectl create configmap app-config \</span><br><span class="line">  --from-file=config.properties \</span><br><span class="line">  --dry-run=client -o yaml | kubectl apply -f -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 ConfigMap</span></span><br><span class="line">kubectl get configmap app-config -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 ConfigMap</span></span><br><span class="line">kubectl delete configmap app-config</span><br></pre></td></tr></table></figure>
<p><strong>ConfigMap 使用最佳实践</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 使用子路径避免覆盖目录</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/config/application.properties</span></span><br><span class="line">      <span class="attr">subPath:</span> <span class="string">application.properties</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 设置默认值和可选配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;localhost&quot;</span>  <span class="comment"># 默认值</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PORT</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">database.port</span></span><br><span class="line">          <span class="attr">optional:</span> <span class="literal">true</span>  <span class="comment"># 可选，不存在时不报错</span></span><br></pre></td></tr></table></figure>
<h4 id="secret-详解">Secret 详解</h4>
<p>Secret 用于存储敏感信息，如密码、令牌、密钥等。Secret 数据会被 Base64
编码（不是加密），需要额外的加密措施保护。</p>
<p><strong>创建 Secret</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 方式1：从字面量创建</span></span><br><span class="line">kubectl create secret generic my-secret \</span><br><span class="line">  --from-literal=username=admin \</span><br><span class="line">  --from-literal=password=secret123</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2：从文件创建</span></span><br><span class="line">kubectl create secret generic my-secret \</span><br><span class="line">  --from-file=username.txt \</span><br><span class="line">  --from-file=password.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式3：从 Docker 配置创建（用于镜像仓库认证）</span></span><br><span class="line">kubectl create secret docker-registry regcred \</span><br><span class="line">  --docker-server=registry.example.com \</span><br><span class="line">  --docker-username=admin \</span><br><span class="line">  --docker-password=secret123 \</span><br><span class="line">  --docker-email=admin@example.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式4：从 TLS 证书创建</span></span><br><span class="line">kubectl create secret tls tls-secret \</span><br><span class="line">  --cert=path/to/cert.crt \</span><br><span class="line">  --key=path/to/cert.key</span><br></pre></td></tr></table></figure>
<p><strong>YAML 方式定义 Secret</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># Base64 编码的值</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4=</span>  <span class="comment"># admin</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">c2VjcmV0MTIz</span>  <span class="comment"># secret123</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 stringData（自动 Base64 编码）</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">secret123</span></span><br></pre></td></tr></table></figure>
<p><strong>Secret 类型</strong>：</p>
<ul>
<li><code>Opaque</code>：用户定义的任意数据（默认）</li>
<li><code>kubernetes.io/dockerconfigjson</code>：Docker
镜像仓库认证</li>
<li><code>kubernetes.io/tls</code>：TLS 证书和密钥</li>
<li><code>kubernetes.io/service-account-token</code>：Service Account
令牌</li>
</ul>
<p><strong>在 Pod 中使用 Secret</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="comment"># 方式1：作为环境变量</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USERNAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">secretKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方式2：使用 envFrom 导入所有键值对</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">secretRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">my-secret</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 方式3：作为文件挂载</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/etc/secrets</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secret-volume</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">my-secret</span></span><br><span class="line">      <span class="comment"># 可选：设置文件权限</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">0400</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">db-username</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">db-password</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0400</span></span><br></pre></td></tr></table></figure>
<p><strong>镜像拉取 Secret</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">private-reg-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">imagePullSecrets:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">regcred</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.example.com/myapp:latest</span></span><br></pre></td></tr></table></figure>
<p><strong>Secret 安全最佳实践</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 使用外部 Secret 管理工具（如 Vault、Sealed Secrets）</span></span><br><span class="line"><span class="comment"># 2. 启用 Secret 加密（需要配置 EncryptionConfiguration）</span></span><br><span class="line"><span class="comment"># 3. 限制 Secret 访问权限（RBAC）</span></span><br><span class="line"><span class="comment"># 4. 定期轮换 Secret</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Secret（注意：密码会显示）</span></span><br><span class="line">kubectl get secret my-secret -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码 Secret 值</span></span><br><span class="line">kubectl get secret my-secret -o jsonpath=<span class="string">&#x27;&#123;.data.password&#125;&#x27;</span> | <span class="built_in">base64</span> -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新 Secret</span></span><br><span class="line">kubectl create secret generic my-secret \</span><br><span class="line">  --from-literal=password=newpassword \</span><br><span class="line">  --dry-run=client -o yaml | kubectl apply -f -</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 Secret</span></span><br><span class="line">kubectl delete secret my-secret</span><br></pre></td></tr></table></figure>
<p><strong>使用 Sealed Secrets 加密 Secret</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 kubeseal</span></span><br><span class="line">brew install kubeseal  <span class="comment"># macOS</span></span><br><span class="line"><span class="comment"># 或从 GitHub 下载</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 SealedSecret</span></span><br><span class="line">kubectl create secret generic my-secret \</span><br><span class="line">  --from-literal=password=secret123 \</span><br><span class="line">  --dry-run=client -o yaml | \</span><br><span class="line">  kubeseal -o yaml &gt; sealed-secret.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用 SealedSecret</span></span><br><span class="line">kubectl apply -f sealed-secret.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kubernetes 会自动解密并创建 Secret</span></span><br></pre></td></tr></table></figure>
<h3 id="kubernetes-资源限制与-qos">Kubernetes 资源限制与 QoS</h3>
<p>Kubernetes 通过资源请求（requests）和限制（limits）来管理 Pod
的资源使用，并根据这些设置分配 QoS 等级。</p>
<h4 id="资源请求和限制">资源请求和限制</h4>
<p><strong>CPU 和内存资源</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">resource-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="comment"># 请求资源（调度时保证）</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span>  <span class="comment"># 250 millicores = 0.25 CPU</span></span><br><span class="line">      <span class="comment"># 资源限制（运行时限制）</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span>  <span class="comment"># 500 millicores = 0.5 CPU</span></span><br></pre></td></tr></table></figure>
<p><strong>CPU 单位说明</strong>：</p>
<ul>
<li><code>1000m</code> = <code>1</code> = 1 个 CPU 核心</li>
<li><code>500m</code> = <code>0.5</code> = 0.5 个 CPU 核心</li>
<li><code>100m</code> = <code>0.1</code> = 0.1 个 CPU 核心</li>
</ul>
<p><strong>内存单位说明</strong>：</p>
<ul>
<li><code>Mi</code> = Mebibyte (1024^2 bytes)</li>
<li><code>Gi</code> = Gibibyte (1024^3 bytes)</li>
<li><code>M</code> = Megabyte (1000^2 bytes)</li>
<li><code>G</code> = Gigabyte (1000^3 bytes)</li>
</ul>
<p><strong>扩展资源（如 GPU）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">gpu-app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gpu-app:latest</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="qos-等级">QoS 等级</h4>
<p>Kubernetes 根据资源请求和限制分配三种 QoS 等级：</p>
<p><strong>1. Guaranteed（保证）</strong>：</p>
<ul>
<li>所有容器都设置了 requests 和 limits</li>
<li>requests 和 limits 相等</li>
<li>优先级最高，不会被驱逐（除非节点资源不足）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">guaranteed-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>2. Burstable（可突发）</strong>：</p>
<ul>
<li>至少有一个容器设置了 requests，但不满足 Guaranteed 条件</li>
<li>可以使用超出 requests 的资源（在 limits 范围内）</li>
<li>中等优先级</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">burstable-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>3. BestEffort（尽力而为）</strong>：</p>
<ul>
<li>所有容器都没有设置 requests 和 limits</li>
<li>优先级最低，资源不足时首先被驱逐</li>
<li>可以使用节点的所有可用资源</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">besteffort-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="comment"># 没有设置 resources</span></span><br></pre></td></tr></table></figure>
<h4 id="资源配额resourcequota">资源配额（ResourceQuota）</h4>
<p>ResourceQuota 用于限制命名空间的资源使用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="comment"># CPU 和内存配额</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">8Gi</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;8&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">16Gi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Pod 数量限制</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 持久卷限制</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;4&quot;</span></span><br><span class="line">    <span class="attr">requests.storage:</span> <span class="string">100Gi</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ConfigMap 和 Secret 限制</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;10&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>查看资源配额</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看命名空间的配额</span></span><br><span class="line">kubectl get resourcequota -n production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看配额详情</span></span><br><span class="line">kubectl describe resourcequota compute-quota -n production</span><br></pre></td></tr></table></figure>
<h4 id="限制范围limitrange">限制范围（LimitRange）</h4>
<p>LimitRange 用于设置命名空间中 Pod 和容器的默认资源限制。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">LimitRange</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mem-limit-range</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">  <span class="comment"># 容器默认限制</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">default:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line">    <span class="attr">defaultRequest:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Container</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Pod 级别限制</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">max:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;1Gi&quot;</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;1000m&quot;</span></span><br><span class="line">    <span class="attr">min:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">&quot;100m&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>
<p><strong>资源限制最佳实践</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 始终设置 requests 和 limits</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 根据应用特性设置合理的比例</span></span><br><span class="line"><span class="comment"># CPU 密集型：limits.cpu / requests.cpu = 2-4</span></span><br><span class="line"><span class="comment"># 内存密集型：limits.memory / requests.memory = 1.5-2</span></span><br><span class="line"><span class="comment"># 一般应用：比例在 2 左右</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用 HPA 自动扩缩容</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">70</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>资源监控和调优</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod 资源使用情况</span></span><br><span class="line">kubectl top pod &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点资源使用情况</span></span><br><span class="line">kubectl top node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 资源请求和限制</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt; | grep -A 5 <span class="string">&quot;Limits\|Requests&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析资源使用情况</span></span><br><span class="line">kubectl get pods --all-namespaces -o json | \</span><br><span class="line">  jq <span class="string">&#x27;.items[] | &#123;name: .metadata.name, namespace: .metadata.namespace, requests: .spec.containers[].resources.requests, limits: .spec.containers[].resources.limits&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="helm包管理">Helm包管理</h2>
<p>Helm 是 Kubernetes 的包管理器，类似于 apt/yum，用于管理 Kubernetes
应用。</p>
<h3 id="helm-基础">Helm 基础</h3>
<p><strong>安装 Helm</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 Helm</span></span><br><span class="line">curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用包管理器</span></span><br><span class="line">brew install helm  <span class="comment"># macOS</span></span><br><span class="line">apt-get install helm  <span class="comment"># Ubuntu</span></span><br></pre></td></tr></table></figure>
<p><strong>Helm 概念</strong>：</p>
<ul>
<li><strong>Chart</strong>：Helm 包，包含应用的所有资源定义</li>
<li><strong>Repository</strong>：Chart 仓库，存储 Chart</li>
<li><strong>Release</strong>：Chart 的部署实例</li>
<li><strong>Values</strong>：配置参数，用于定制 Chart</li>
</ul>
<p><strong>基本命令</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加仓库</span></span><br><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索 Chart</span></span><br><span class="line">helm search repo nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 Chart</span></span><br><span class="line">helm install my-nginx bitnami/nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Release</span></span><br><span class="line">helm list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Release 详情</span></span><br><span class="line">helm status my-nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 Release</span></span><br><span class="line">helm upgrade my-nginx bitnami/nginx --<span class="built_in">set</span> service.type=NodePort</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载 Release</span></span><br><span class="line">helm uninstall my-nginx</span><br></pre></td></tr></table></figure>
<h3 id="创建自定义-chart">创建自定义 Chart</h3>
<p><strong>Chart 结构</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mychart/</span><br><span class="line">├── Chart.yaml          # Chart 元数据</span><br><span class="line">├── values.yaml         # 默认配置值</span><br><span class="line">├── templates/          # 模板文件</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   └── _helpers.tpl    # 辅助模板</span><br><span class="line">└── charts/             # 依赖 Chart</span><br></pre></td></tr></table></figure>
<p><strong>Chart.yaml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v2</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">A</span> <span class="string">Helm</span> <span class="string">chart</span> <span class="string">for</span> <span class="string">my</span> <span class="string">application</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">application</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">appVersion:</span> <span class="string">&quot;1.0.0&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>values.yaml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">replicaCount:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span></span><br><span class="line">  <span class="attr">repository:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">pullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">&quot;1.21&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ingress:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">className:</span> <span class="string">&quot;nginx&quot;</span></span><br><span class="line">  <span class="attr">annotations:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">chart-example.local</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">          <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">  <span class="attr">tls:</span> []</span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">256Mi</span></span><br></pre></td></tr></table></figure>
<p><strong>templates/deployment.yaml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> &#123;&#123; <span class="string">include</span> <span class="string">&quot;myapp.fullname&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    &#123;&#123;<span class="bullet">-</span> <span class="string">include</span> <span class="string">&quot;myapp.labels&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">4</span> &#125;&#125;</span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> &#123;&#123; <span class="string">.Values.replicaCount</span> &#125;&#125;</span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      &#123;&#123;<span class="bullet">-</span> <span class="string">include</span> <span class="string">&quot;myapp.selectorLabels&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">6</span> &#125;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        &#123;&#123;<span class="bullet">-</span> <span class="string">include</span> <span class="string">&quot;myapp.selectorLabels&quot;</span> <span class="string">.</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">8</span> &#125;&#125;</span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> &#123;&#123; <span class="string">.Chart.Name</span> &#125;&#125;</span><br><span class="line">        <span class="attr">image:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123; .Values.image.repository &#125;&#125;</span>:<span class="template-variable">&#123;&#123; .Values.image.tag | default .Chart.AppVersion &#125;&#125;</span>&quot;</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> &#123;&#123; <span class="string">.Values.image.pullPolicy</span> &#125;&#125;</span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          &#123;&#123;<span class="bullet">-</span> <span class="string">toYaml</span> <span class="string">.Values.resources</span> <span class="string">|</span> <span class="string">nindent</span> <span class="number">10</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>**templates/_helpers.tpl**：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;myapp.name&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">default</span> <span class="string">.Chart.Name</span> <span class="string">.Values.nameOverride</span> <span class="string">|</span> <span class="string">trunc</span> <span class="number">63</span> <span class="string">|</span> <span class="string">trimSuffix</span> <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;myapp.fullname&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Values.nameOverride</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">.Values.nameOverride</span> <span class="string">|</span> <span class="string">trunc</span> <span class="number">63</span> <span class="string">|</span> <span class="string">trimSuffix</span> <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">else</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">printf</span> <span class="string">&quot;%s-%s&quot;</span> <span class="string">.Chart.Name</span> <span class="string">.Chart.Version</span> <span class="string">|</span> <span class="string">replace</span> <span class="string">&quot;+&quot;</span> <span class="string">&quot;_&quot;</span> <span class="string">|</span> <span class="string">trunc</span> <span class="number">63</span> <span class="string">|</span> <span class="string">trimSuffix</span> <span class="string">&quot;-&quot;</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;myapp.labels&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"><span class="attr">helm.sh/chart:</span> &#123;&#123; <span class="string">include</span> <span class="string">&quot;myapp.chart&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="string">include</span> <span class="string">&quot;myapp.selectorLabels&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">if</span> <span class="string">.Chart.AppVersion</span> &#125;&#125;</span><br><span class="line"><span class="attr">app.kubernetes.io/version:</span> &#123;&#123; <span class="string">.Chart.AppVersion</span> <span class="string">|</span> <span class="string">quote</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"><span class="attr">app.kubernetes.io/managed-by:</span> &#123;&#123; <span class="string">.Release.Service</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">define</span> <span class="string">&quot;myapp.selectorLabels&quot;</span> <span class="string">-</span>&#125;&#125;</span><br><span class="line"><span class="attr">app.kubernetes.io/name:</span> &#123;&#123; <span class="string">include</span> <span class="string">&quot;myapp.name&quot;</span> <span class="string">.</span> &#125;&#125;</span><br><span class="line"><span class="attr">app.kubernetes.io/instance:</span> &#123;&#123; <span class="string">.Release.Name</span> &#125;&#125;</span><br><span class="line">&#123;&#123;<span class="bullet">-</span> <span class="string">end</span> &#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>打包和安装</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打包 Chart</span></span><br><span class="line">helm package mychart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装本地 Chart</span></span><br><span class="line">helm install myapp ./mychart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义 values</span></span><br><span class="line">helm install myapp ./mychart -f my-values.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 --set 覆盖值</span></span><br><span class="line">helm install myapp ./mychart --<span class="built_in">set</span> replicaCount=5</span><br></pre></td></tr></table></figure>
<h2 id="服务网格istio深入">服务网格（Istio）深入</h2>
<p>服务网格（Service
Mesh）是处理服务间通信的基础设施层，提供服务发现、负载均衡、故障恢复、指标收集、安全策略等功能，无需修改应用代码。</p>
<h3 id="istio-架构详解">Istio 架构详解</h3>
<p>Istio 由数据平面和控制平面组成：</p>
<p><strong>数据平面</strong>：</p>
<ul>
<li><strong>Envoy 代理</strong>：以 Sidecar 形式部署在每个 Pod
中，拦截所有服务间通信</li>
<li>处理流量路由、负载均衡、健康检查、故障注入等</li>
</ul>
<p><strong>控制平面</strong>：</p>
<ul>
<li><strong>Istiod</strong>：统一管理和配置所有 Envoy 代理</li>
<li>包含 Pilot（流量管理）、Citadel（安全）、Galley（配置管理）</li>
</ul>
<p><strong>架构图</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│         Control Plane (Istiod)     │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐       │</span><br><span class="line">│  │  Pilot   │  │ Citadel  │       │</span><br><span class="line">│  │ (Traffic)│  │ (Security)│      │</span><br><span class="line">│  └──────────┘  └──────────┘       │</span><br><span class="line">│  ┌──────────┐                      │</span><br><span class="line">│  │  Galley  │                      │</span><br><span class="line">│  │  (Config)│                      │</span><br><span class="line">│  └──────────┘                      │</span><br><span class="line">└─────────────────────────────────────┘</span><br><span class="line">              │</span><br><span class="line">              │ 配置下发</span><br><span class="line">              ▼</span><br><span class="line">┌─────────────────────────────────────┐</span><br><span class="line">│         Data Plane (Envoy)          │</span><br><span class="line">│  ┌──────┐  ┌──────┐  ┌──────┐     │</span><br><span class="line">│  │ Pod1 │  │ Pod2 │  │ Pod3 │     │</span><br><span class="line">│  │ ┌──┐ │  │ ┌──┐ │  │ ┌──┐ │     │</span><br><span class="line">│  │ │App│ │  │ │App│ │  │ │App│ │     │</span><br><span class="line">│  │ └┬─┘ │  │ └┬─┘ │  │ └┬─┘ │     │</span><br><span class="line">│  │ ┌▼─┐ │  │ ┌▼─┐ │  │ ┌▼─┐ │     │</span><br><span class="line">│  │ │Env│ │  │ │Env│ │  │ │Env│ │     │</span><br><span class="line">│  │ │oy │ │  │ │oy │ │  │ │oy │ │     │</span><br><span class="line">│  │ └──┘ │  │ └──┘ │  │ └──┘ │     │</span><br><span class="line">│  └──────┘  └──────┘  └──────┘     │</span><br><span class="line">└─────────────────────────────────────┘</span><br></pre></td></tr></table></figure>
<p><strong>安装 Istio</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 Istio</span></span><br><span class="line">curl -L https://istio.io/downloadIstio | sh -</span><br><span class="line"><span class="built_in">cd</span> istio-*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将 istioctl 添加到 PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PWD</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装到集群（使用 default profile）</span></span><br><span class="line">istioctl install --<span class="built_in">set</span> profile=default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">istioctl verify-install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用 sidecar 自动注入</span></span><br><span class="line">kubectl label namespace default istio-injection=enabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 istioctl 注入</span></span><br><span class="line">istioctl kube-inject -f deployment.yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure>
<p><strong>Istio 安装配置选项</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义安装配置</span></span><br><span class="line">istioctl install --<span class="built_in">set</span> profile=default \</span><br><span class="line">  --<span class="built_in">set</span> values.global.proxy.logLevel=debug \</span><br><span class="line">  --<span class="built_in">set</span> values.telemetry.v2.prometheus.enabled=<span class="literal">true</span> \</span><br><span class="line">  --<span class="built_in">set</span> values.pilot.traceSampling=100.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看安装配置</span></span><br><span class="line">istioctl profile dump default</span><br><span class="line"></span><br><span class="line"><span class="comment"># 升级 Istio</span></span><br><span class="line">istioctl upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载 Istio</span></span><br><span class="line">istioctl uninstall --purge</span><br></pre></td></tr></table></figure>
<h3 id="流量管理深入">流量管理深入</h3>
<h4 id="virtualservice-详解">VirtualService 详解</h4>
<p>VirtualService 定义路由规则，控制流量如何路由到服务。</p>
<p><strong>基础路由</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">50</span></span><br></pre></td></tr></table></figure>
<p><strong>基于 Header 的路由</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">end-user:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/api/v2&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">x-api-version:</span></span><br><span class="line">          <span class="attr">regex:</span> <span class="string">&quot;^v[2-9]&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">75</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v3</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">25</span></span><br></pre></td></tr></table></figure>
<p><strong>基于 URI 的路由</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">/api/v1/users</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">user-service</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/api/v2</span></span><br><span class="line">    <span class="attr">rewrite:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">/api/v1</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">api-service</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">8080</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&quot;^/api/.*&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">api-service</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p><strong>故障注入</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">delay:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">fixedDelay:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">abort:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">httpStatus:</span> <span class="number">500</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>
<p><strong>超时和重试</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">3s</span></span><br><span class="line">    <span class="attr">retries:</span></span><br><span class="line">      <span class="attr">attempts:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">perTryTimeout:</span> <span class="string">2s</span></span><br><span class="line">      <span class="attr">retryOn:</span> <span class="string">5xx,gateway-error,connect-failure</span></span><br></pre></td></tr></table></figure>
<h4 id="destinationrule-详解">DestinationRule 详解</h4>
<p>DestinationRule 定义服务的流量策略，如负载均衡、连接池、熔断等。</p>
<p><strong>负载均衡策略</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">loadBalancer:</span></span><br><span class="line">      <span class="attr">simple:</span> <span class="string">LEAST_CONN</span>  <span class="comment"># ROUND_ROBIN, LEAST_CONN, RANDOM, PASSTHROUGH</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">http1MaxPendingRequests:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">http2MaxRequests:</span> <span class="number">100</span></span><br><span class="line">        <span class="attr">maxRequestsPerConnection:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">maxRetries:</span> <span class="number">3</span></span><br><span class="line">        <span class="attr">idleTimeout:</span> <span class="string">90s</span></span><br><span class="line">    <span class="attr">outlierDetection:</span></span><br><span class="line">      <span class="attr">consecutiveErrors:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">baseEjectionTime:</span> <span class="string">30s</span></span><br><span class="line">      <span class="attr">maxEjectionPercent:</span> <span class="number">50</span></span><br><span class="line">      <span class="attr">minHealthPercent:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">trafficPolicy:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">simple:</span> <span class="string">ROUND_ROBIN</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">trafficPolicy:</span></span><br><span class="line">      <span class="attr">loadBalancer:</span></span><br><span class="line">        <span class="attr">simple:</span> <span class="string">LEAST_CONN</span></span><br></pre></td></tr></table></figure>
<p><strong>TLS 策略</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">ISTIO_MUTUAL</span>  <span class="comment"># DISABLE, SIMPLE, MUTUAL, ISTIO_MUTUAL</span></span><br><span class="line">      <span class="attr">sni:</span> <span class="string">reviews.example.com</span></span><br><span class="line">      <span class="attr">subjectAltNames:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">reviews.example.com</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">trafficPolicy:</span></span><br><span class="line">      <span class="attr">tls:</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">SIMPLE</span></span><br></pre></td></tr></table></figure>
<h4 id="gateway-详解">Gateway 详解</h4>
<p>Gateway 用于管理入口流量，类似于 Kubernetes Ingress。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">app.example.com</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">httpsRedirect:</span> <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTPS</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">app.example.com</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">SIMPLE</span></span><br><span class="line">      <span class="attr">credentialName:</span> <span class="string">tls-secret</span></span><br></pre></td></tr></table></figure>
<p><strong>Gateway 与 VirtualService 配合</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gateway 定义入口</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># VirtualService 定义路由规则</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">api-gateway</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">api-service</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<h3 id="安全策略深入">安全策略深入</h3>
<h4 id="mtls-配置">mTLS 配置</h4>
<p><strong>PeerAuthentication（对等认证）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命名空间级别 mTLS</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">production</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">STRICT</span>  <span class="comment"># DISABLE, PERMISSIVE, STRICT</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 全局 mTLS</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">STRICT</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br></pre></td></tr></table></figure>
<p><strong>mTLS 模式说明</strong>：</p>
<ul>
<li><code>DISABLE</code>：禁用 mTLS</li>
<li><code>PERMISSIVE</code>：允许明文和 mTLS 流量（迁移阶段使用）</li>
<li><code>STRICT</code>：只允许 mTLS 流量（生产环境推荐）</li>
</ul>
<h4 id="授权策略">授权策略</h4>
<p><strong>AuthorizationPolicy 详解</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许所有请求</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">allow-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 拒绝所有请求</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">DENY</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 基于 IP 的访问控制</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ip-based-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">ipBlocks:</span> [<span class="string">&quot;192.168.1.0/24&quot;</span>]</span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">operation:</span></span><br><span class="line">        <span class="attr">methods:</span> [<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 基于 JWT 的访问控制</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">AuthorizationPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jwt-based-policy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">api</span></span><br><span class="line">  <span class="attr">action:</span> <span class="string">ALLOW</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">requestPrincipals:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">operation:</span></span><br><span class="line">        <span class="attr">methods:</span> [<span class="string">&quot;GET&quot;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">from:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source:</span></span><br><span class="line">        <span class="attr">requestPrincipals:</span> [<span class="string">&quot;cluster.local/ns/default/sa/admin&quot;</span>]</span><br><span class="line">    <span class="attr">to:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">operation:</span></span><br><span class="line">        <span class="attr">methods:</span> [<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;DELETE&quot;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="可观测性">可观测性</h3>
<p><strong>指标收集（Prometheus）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用 Prometheus 指标</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioOperator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">control-plane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">values:</span></span><br><span class="line">    <span class="attr">telemetry:</span></span><br><span class="line">      <span class="attr">v2:</span></span><br><span class="line">        <span class="attr">prometheus:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><strong>分布式追踪（Jaeger）</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置追踪采样率</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">install.istio.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">IstioOperator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">control-plane</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">meshConfig:</span></span><br><span class="line">    <span class="attr">defaultConfig:</span></span><br><span class="line">      <span class="attr">tracing:</span></span><br><span class="line">        <span class="attr">sampling:</span> <span class="number">100.0</span>  <span class="comment"># 100% 采样率</span></span><br></pre></td></tr></table></figure>
<p><strong>访问追踪数据</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 端口转发到 Jaeger UI</span></span><br><span class="line">kubectl port-forward -n istio-system svc/jaeger-query 16686:16686</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问 http://localhost:16686</span></span><br></pre></td></tr></table></figure>
<h3 id="服务网格最佳实践">服务网格最佳实践</h3>
<p><strong>1. 渐进式采用</strong>：</p>
<ul>
<li>先在非关键服务上启用</li>
<li>使用 PERMISSIVE mTLS 模式进行迁移</li>
<li>逐步启用 STRICT mTLS</li>
</ul>
<p><strong>2. 性能优化</strong>：</p>
<ul>
<li>合理设置连接池大小</li>
<li>使用适当的负载均衡算法</li>
<li>监控 Sidecar 资源使用</li>
</ul>
<p><strong>3. 安全配置</strong>：</p>
<ul>
<li>启用 mTLS</li>
<li>使用 AuthorizationPolicy 限制访问</li>
<li>定期轮换证书</li>
</ul>
<p><strong>4. 监控和告警</strong>：</p>
<ul>
<li>监控服务指标</li>
<li>设置 SLA 告警</li>
<li>追踪错误率</li>
</ul>
<h2 id="微服务架构设计模式">微服务架构设计模式</h2>
<h3 id="api-网关模式">API 网关模式</h3>
<p>API
网关作为所有客户端请求的单一入口点，提供路由、认证、限流等功能。</p>
<p><strong>使用 Kong 作为 API 网关</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-proxy</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">proxy</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">proxy-ssl</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kong</span></span><br></pre></td></tr></table></figure>
<h3 id="服务发现模式">服务发现模式</h3>
<p><strong>使用 Kubernetes Service 进行服务发现</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p>应用通过服务名称访问：<code>http://user-service:80</code></p>
<h3 id="配置中心模式">配置中心模式</h3>
<p><strong>使用 ConfigMap 存储配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">database.host:</span> <span class="string">&quot;mysql-service&quot;</span></span><br><span class="line">  <span class="attr">database.port:</span> <span class="string">&quot;3306&quot;</span></span><br><span class="line">  <span class="attr">cache.host:</span> <span class="string">&quot;redis-service&quot;</span></span><br><span class="line">  <span class="attr">cache.port:</span> <span class="string">&quot;6379&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>在 Pod 中使用</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">envFrom:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">app-config</span></span><br></pre></td></tr></table></figure>
<h3 id="熔断器模式circuit-breaker">熔断器模式（Circuit Breaker）</h3>
<p>熔断器模式用于防止级联故障，当服务失败率达到阈值时，快速失败而不是等待超时。</p>
<p><strong>使用 Istio 实现熔断</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">httpbin</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">httpbin</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">100</span>  <span class="comment"># 最大连接数</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="string">30s</span>  <span class="comment"># 连接超时</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">http1MaxPendingRequests:</span> <span class="number">10</span>  <span class="comment"># 最大等待请求数</span></span><br><span class="line">        <span class="attr">http2MaxRequests:</span> <span class="number">100</span>       <span class="comment"># HTTP/2 最大请求数</span></span><br><span class="line">        <span class="attr">maxRequestsPerConnection:</span> <span class="number">2</span>  <span class="comment"># 每个连接最大请求数</span></span><br><span class="line">        <span class="attr">maxRetries:</span> <span class="number">3</span>                <span class="comment"># 最大重试次数</span></span><br><span class="line">    <span class="attr">outlierDetection:</span></span><br><span class="line">      <span class="attr">consecutiveErrors:</span> <span class="number">5</span>          <span class="comment"># 连续错误次数</span></span><br><span class="line">      <span class="attr">interval:</span> <span class="string">30s</span>                 <span class="comment"># 检测间隔</span></span><br><span class="line">      <span class="attr">baseEjectionTime:</span> <span class="string">30s</span>         <span class="comment"># 基础驱逐时间</span></span><br><span class="line">      <span class="attr">maxEjectionPercent:</span> <span class="number">50</span>         <span class="comment"># 最大驱逐百分比</span></span><br><span class="line">      <span class="attr">minHealthPercent:</span> <span class="number">50</span>          <span class="comment"># 最小健康百分比</span></span><br></pre></td></tr></table></figure>
<p><strong>熔断器状态</strong>：</p>
<ul>
<li><strong>Closed（关闭）</strong>：正常状态，请求正常通过</li>
<li><strong>Open（打开）</strong>：失败率超过阈值，直接拒绝请求</li>
<li><strong>Half-Open（半开）</strong>：尝试恢复，允许少量请求通过</li>
</ul>
<p><strong>使用 Spring Cloud 实现熔断</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 Hystrix</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">callRemoteService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://remote-service/api&quot;</span>, String.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">fallbackMethod</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Service temporarily unavailable&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Resilience4j</span></span><br><span class="line"><span class="meta">@CircuitBreaker(name = &quot;remoteService&quot;, fallbackMethod = &quot;fallbackMethod&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">callRemoteService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(<span class="string">&quot;http://remote-service/api&quot;</span>, String.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="限流模式rate-limiting">限流模式（Rate Limiting）</h3>
<p>限流模式用于控制服务的请求速率，防止系统过载。</p>
<p><strong>使用 Istio 实现限流</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">EnvoyFilter</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rate-limit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">configPatches:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">applyTo:</span> <span class="string">HTTP_FILTER</span></span><br><span class="line">    <span class="attr">match:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">SIDECAR_INBOUND</span></span><br><span class="line">      <span class="attr">listener:</span></span><br><span class="line">        <span class="attr">filterChain:</span></span><br><span class="line">          <span class="attr">filter:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">&quot;envoy.filters.network.http_connection_manager&quot;</span></span><br><span class="line">    <span class="attr">patch:</span></span><br><span class="line">      <span class="attr">operation:</span> <span class="string">INSERT_BEFORE</span></span><br><span class="line">      <span class="attr">value:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">envoy.filters.http.local_ratelimit</span></span><br><span class="line">        <span class="attr">typed_config:</span></span><br><span class="line">          <span class="string">&quot;@type&quot;</span><span class="string">:</span> <span class="string">type.googleapis.com/envoy.extensions.filters.http.local_ratelimit.v3.LocalRateLimit</span></span><br><span class="line">          <span class="attr">stat_prefix:</span> <span class="string">http_local_rate_limiter</span></span><br><span class="line">          <span class="attr">token_bucket:</span></span><br><span class="line">            <span class="attr">max_tokens:</span> <span class="number">100</span></span><br><span class="line">            <span class="attr">tokens_per_fill:</span> <span class="number">100</span></span><br><span class="line">            <span class="attr">fill_interval:</span> <span class="string">60s</span></span><br><span class="line">          <span class="attr">filter_enabled:</span></span><br><span class="line">            <span class="attr">runtime_key:</span> <span class="string">local_rate_limit_enabled</span></span><br><span class="line">            <span class="attr">default_value:</span></span><br><span class="line">              <span class="attr">numerator:</span> <span class="number">100</span></span><br><span class="line">              <span class="attr">denominator:</span> <span class="string">HUNDRED</span></span><br><span class="line">          <span class="attr">filter_enforced:</span></span><br><span class="line">            <span class="attr">runtime_key:</span> <span class="string">local_rate_limit_enforced</span></span><br><span class="line">            <span class="attr">default_value:</span></span><br><span class="line">              <span class="attr">numerator:</span> <span class="number">100</span></span><br><span class="line">              <span class="attr">denominator:</span> <span class="string">HUNDRED</span></span><br></pre></td></tr></table></figure>
<p><strong>使用 Nginx Ingress 限流</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rate-limit-ingress</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/limit-rps:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/limit-connections:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/limit-rpm:</span> <span class="string">&quot;1000&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">api.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">api-service</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p><strong>使用 Redis 实现分布式限流</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RateLimiter</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, key, max_requests, window_seconds</span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.key = key</span><br><span class="line">        self.max_requests = max_requests</span><br><span class="line">        self.window_seconds = window_seconds</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">is_allowed</span>(<span class="params">self</span>):</span><br><span class="line">        now = time.time()</span><br><span class="line">        window_start = now - self.window_seconds</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用滑动窗口</span></span><br><span class="line">        pipe = self.redis.pipeline()</span><br><span class="line">        pipe.zremrangebyscore(self.key, <span class="number">0</span>, window_start)</span><br><span class="line">        pipe.zcard(self.key)</span><br><span class="line">        pipe.zadd(self.key, &#123;<span class="built_in">str</span>(now): now&#125;)</span><br><span class="line">        pipe.expire(self.key, self.window_seconds)</span><br><span class="line">        results = pipe.execute()</span><br><span class="line">        </span><br><span class="line">        current_requests = results[<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> current_requests &lt; self.max_requests</span><br></pre></td></tr></table></figure>
<h3 id="降级模式degradation">降级模式（Degradation）</h3>
<p>降级模式在系统负载过高或部分服务不可用时，提供简化版功能或返回缓存数据。</p>
<p><strong>降级策略</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Istio 实现降级</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">x-degrade:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1-cache</span>  <span class="comment"># 使用缓存版本</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">fault:</span></span><br><span class="line">      <span class="attr">delay:</span></span><br><span class="line">        <span class="attr">percentage:</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">fixedDelay:</span> <span class="string">5s</span></span><br></pre></td></tr></table></figure>
<p><strong>降级实现示例（Java）</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheService cacheService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RemoteService remoteService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Degrade(fallbackMethod = &quot;getProductFromCache&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProduct</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> remoteService.getProduct(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Product <span class="title function_">getProductFromCache</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="comment">// 降级：从缓存获取</span></span><br><span class="line">        <span class="type">Product</span> <span class="variable">product</span> <span class="operator">=</span> cacheService.get(id);</span><br><span class="line">        <span class="keyword">if</span> (product == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 返回默认值</span></span><br><span class="line">            <span class="keyword">return</span> Product.defaultProduct();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="重试模式retry">重试模式（Retry）</h3>
<p>重试模式用于处理临时性故障，通过重试提高请求成功率。</p>
<p><strong>使用 Istio 实现重试</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">retries:</span></span><br><span class="line">      <span class="attr">attempts:</span> <span class="number">3</span>              <span class="comment"># 重试次数</span></span><br><span class="line">      <span class="attr">perTryTimeout:</span> <span class="string">2s</span>         <span class="comment"># 每次重试超时</span></span><br><span class="line">      <span class="attr">retryOn:</span> <span class="string">5xx,gateway-error,connect-failure,refused-stream</span></span><br><span class="line">      <span class="attr">retryRemoteLocalities:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p><strong>指数退避重试</strong>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">exponential_backoff_retry</span>(<span class="params">func, max_retries=<span class="number">3</span>, base_delay=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">for</span> attempt <span class="keyword">in</span> <span class="built_in">range</span>(max_retries):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> func()</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">if</span> attempt == max_retries - <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 指数退避 + 抖动</span></span><br><span class="line">            delay = base_delay * (<span class="number">2</span> ** attempt) + random.uniform(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">            time.sleep(delay)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<h3 id="超时模式timeout">超时模式（Timeout）</h3>
<p>超时模式用于防止请求无限等待，及时释放资源。</p>
<p><strong>使用 Istio 配置超时</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">3s</span>  <span class="comment"># 请求超时时间</span></span><br></pre></td></tr></table></figure>
<p><strong>超时配置最佳实践</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不同路径设置不同超时</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">api.example.com</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/api/fast&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">api-service</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">1s</span>  <span class="comment"># 快速接口短超时</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/api/slow&quot;</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">api-service</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">30s</span>  <span class="comment"># 慢速接口长超时</span></span><br></pre></td></tr></table></figure>
<h3 id="服务发现模式扩展">服务发现模式扩展</h3>
<p><strong>使用 Consul 进行服务发现</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">consul-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">consul.json:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">      &quot;service&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;myapp&quot;,</span></span><br><span class="line"><span class="string">        &quot;tags&quot;: [&quot;web&quot;, &quot;v1&quot;],</span></span><br><span class="line"><span class="string">        &quot;port&quot;: 8080,</span></span><br><span class="line"><span class="string">        &quot;check&quot;: &#123;</span></span><br><span class="line"><span class="string">          &quot;http&quot;: &quot;http://localhost:8080/health&quot;,</span></span><br><span class="line"><span class="string">          &quot;interval&quot;: &quot;10s&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>使用 Eureka 进行服务发现</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Spring Cloud Eureka Client 配置</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">eureka-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">application.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    eureka:</span></span><br><span class="line"><span class="string">      client:</span></span><br><span class="line"><span class="string">        service-url:</span></span><br><span class="line"><span class="string">          defaultZone: http://eureka-server:8761/eureka/</span></span><br><span class="line"><span class="string">      instance:</span></span><br><span class="line"><span class="string">        prefer-ip-address: true</span></span><br></pre></td></tr></table></figure>
<h3 id="分布式追踪模式">分布式追踪模式</h3>
<p><strong>使用 Jaeger 进行分布式追踪</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-with-tracing</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAEGER_AGENT_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">jaeger-agent</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAEGER_AGENT_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;6831&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAEGER_SAMPLER_TYPE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;const&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAEGER_SAMPLER_PARAM</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>使用 OpenTelemetry</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-with-otel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">myapp:latest</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_EXPORTER_OTLP_ENDPOINT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;http://otel-collector:4317&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_SERVICE_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;myapp&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">OTEL_RESOURCE_ATTRIBUTES</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;service.name=myapp,service.version=1.0&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="cicd流水线实战">CI/CD流水线实战</h2>
<h3 id="jenkins-pipeline">Jenkins Pipeline</h3>
<p><strong>Jenkinsfile 示例</strong>：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    environment &#123;</span><br><span class="line">        DOCKER_REGISTRY = <span class="string">&#x27;registry.example.com&#x27;</span></span><br><span class="line">        IMAGE_NAME = <span class="string">&#x27;myapp&#x27;</span></span><br><span class="line">        KUBERNETES_NAMESPACE = <span class="string">&#x27;production&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Checkout&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout scm</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker build -t $&#123;IMAGE_NAME&#125;:$&#123;BUILD_NUMBER&#125; .&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;docker tag $&#123;IMAGE_NAME&#125;:$&#123;BUILD_NUMBER&#125; $&#123;DOCKER_REGISTRY&#125;/$&#123;IMAGE_NAME&#125;:$&#123;BUILD_NUMBER&#125;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker run --rm $&#123;IMAGE_NAME&#125;:$&#123;BUILD_NUMBER&#125; npm test&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Push&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                withCredentials([usernamePassword(<span class="attr">credentialsId:</span> <span class="string">&#x27;docker-registry&#x27;</span>, <span class="attr">usernameVariable:</span> <span class="string">&#x27;USERNAME&#x27;</span>, <span class="attr">passwordVariable:</span> <span class="string">&#x27;PASSWORD&#x27;</span>)]) &#123;</span><br><span class="line">                    sh <span class="string">&#x27;echo $PASSWORD | docker login -u $USERNAME --password-stdin $&#123;DOCKER_REGISTRY&#125;&#x27;</span></span><br><span class="line">                    sh <span class="string">&#x27;docker push $&#123;DOCKER_REGISTRY&#125;/$&#123;IMAGE_NAME&#125;:$&#123;BUILD_NUMBER&#125;&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    kubectl set image deployment/myapp myapp=$&#123;DOCKER_REGISTRY&#125;/$&#123;IMAGE_NAME&#125;:$&#123;BUILD_NUMBER&#125; -n $&#123;KUBERNETES_NAMESPACE&#125;</span></span><br><span class="line"><span class="string">                    kubectl rollout status deployment/myapp -n $&#123;KUBERNETES_NAMESPACE&#125;</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            echo <span class="string">&#x27;Pipeline succeeded!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            echo <span class="string">&#x27;Pipeline failed!&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gitlab-cicd">GitLab CI/CD</h3>
<p><strong>.gitlab-ci.yml 示例</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DOCKER_REGISTRY:</span> <span class="string">registry.gitlab.com</span></span><br><span class="line">  <span class="attr">IMAGE_NAME:</span> <span class="string">$CI_REGISTRY_IMAGE</span></span><br><span class="line">  <span class="attr">KUBERNETES_NAMESPACE:</span> <span class="string">production</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">$IMAGE_NAME:$CI_COMMIT_SHA</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">tag</span> <span class="string">$IMAGE_NAME:$CI_COMMIT_SHA</span> <span class="string">$IMAGE_NAME:latest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$IMAGE_NAME:$CI_COMMIT_SHA</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$IMAGE_NAME:latest</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">$IMAGE_NAME:$CI_COMMIT_SHA</span> <span class="string">npm</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">develop</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">set</span> <span class="string">image</span> <span class="string">deployment/myapp</span> <span class="string">myapp=$IMAGE_NAME:$CI_COMMIT_SHA</span> <span class="string">-n</span> <span class="string">$KUBERNETES_NAMESPACE</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">status</span> <span class="string">deployment/myapp</span> <span class="string">-n</span> <span class="string">$KUBERNETES_NAMESPACE</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">production</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://myapp.example.com</span></span><br></pre></td></tr></table></figure>
<h3 id="github-actions">GitHub Actions</h3>
<p><strong>.github/workflows/ci-cd.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">CI/CD</span> <span class="string">Pipeline</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">REGISTRY:</span> <span class="string">ghcr.io</span></span><br><span class="line">  <span class="attr">IMAGE_NAME:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-and-push:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">permissions:</span></span><br><span class="line">      <span class="attr">contents:</span> <span class="string">read</span></span><br><span class="line">      <span class="attr">packages:</span> <span class="string">write</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v2</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Log</span> <span class="string">in</span> <span class="string">to</span> <span class="string">Container</span> <span class="string">Registry</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/login-action@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">registry:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.actor</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/build-push-action@v4</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">        <span class="attr">push:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">tags:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          $&#123;&#123; env.REGISTRY &#125;&#125;/$&#123;&#123; env.IMAGE_NAME &#125;&#125;:$&#123;&#123; github.sha &#125;&#125;</span></span><br><span class="line"><span class="string">          $&#123;&#123; env.REGISTRY &#125;&#125;/$&#123;&#123; env.IMAGE_NAME &#125;&#125;:latest</span></span><br><span class="line"><span class="string"></span>    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">Kubernetes</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">azure/k8s-deploy@v4</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">manifests:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          k8s/deployment.yaml</span></span><br><span class="line"><span class="string">          k8s/service.yaml</span></span><br><span class="line"><span class="string"></span>        <span class="attr">images:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          $&#123;&#123; env.REGISTRY &#125;&#125;/$&#123;&#123; env.IMAGE_NAME &#125;&#125;:$&#123;&#123; github.sha &#125;&#125;</span></span><br><span class="line"><span class="string"></span>        <span class="attr">namespace:</span> <span class="string">production</span></span><br></pre></td></tr></table></figure>
<h2 id="实战案例">实战案例</h2>
<h3 id="案例一部署-wordpress-应用栈">案例一：部署 WordPress 应用栈</h3>
<p><strong>架构</strong>：WordPress + MySQL + Redis</p>
<p><strong>docker-compose.yml</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wordpress:php8.0-apache</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:80&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_NAME:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">wp_data:/var/www/html</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">rootpassword</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db_data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app-network</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">redis-server</span> <span class="string">--appendonly</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis_data:/data</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">app-network</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">wp_data:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br><span class="line">  <span class="attr">redis_data:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">app-network:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>
<p><strong>Kubernetes 部署</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">root-password</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql-storage</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mysql-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># wordpress-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">wordpress:php8.0-apache</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">mysql</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_PASSWORD</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mysql-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">WORDPRESS_DB_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">wordpress</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wp-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/www/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wp-storage</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">wp-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">wordpress</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<h3 id="案例二构建微服务电商系统">案例二：构建微服务电商系统</h3>
<p><strong>服务架构</strong>：</p>
<ul>
<li>API Gateway（Kong）</li>
<li>用户服务（User Service）</li>
<li>商品服务（Product Service）</li>
<li>订单服务（Order Service）</li>
<li>支付服务（Payment Service）</li>
<li>数据库（PostgreSQL）</li>
<li>消息队列（RabbitMQ）</li>
</ul>
<p><strong>Kong API Gateway 配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kong-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">kong.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    _format_version: &quot;1.1&quot;</span></span><br><span class="line"><span class="string">    services:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">http://user-service:8080</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user-route</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/api/users</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">product-service</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">http://product-service:8080</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">product-route</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/api/products</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">http://order-service:8080</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">order-route</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/api/orders</span></span><br></pre></td></tr></table></figure>
<p><strong>用户服务 Deployment</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">user-service</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">user-service</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">myregistry/user-service:v1.0</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_URL</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">secretKeyRef:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">              <span class="attr">key:</span> <span class="string">url</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">RABBITMQ_URL</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">amqp://rabbitmq:5672</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<h3 id="案例三高可用-redis-集群">案例三：高可用 Redis 集群</h3>
<p><strong>Redis Sentinel 配置</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis-master.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-server</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/redis/redis.conf</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/redis</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">redis-config</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># redis-sentinel.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-sentinel</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">redis-sentinel</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis-sentinel</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis-sentinel</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sentinel</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:6-alpine</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis-sentinel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/etc/sentinel/sentinel.conf</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">26379</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sentinel-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/sentinel</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sentinel-config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">sentinel-config</span></span><br></pre></td></tr></table></figure>
<h2 id="qa-云原生与容器常见问题">❓ Q&amp;A: 云原生与容器常见问题</h2>
<h3 id="q1-docker-容器和虚拟机的区别是什么">Q1: Docker
容器和虚拟机的区别是什么？</h3>
<p><strong>A</strong>: Docker 容器和虚拟机的主要区别在于：</p>
<ol type="1">
<li><strong>资源占用</strong>：容器共享主机操作系统内核，比虚拟机更轻量，启动更快</li>
<li><strong>隔离级别</strong>：虚拟机提供硬件级隔离，容器提供进程级隔离</li>
<li><strong>性能</strong>：容器性能接近原生应用，虚拟机有虚拟化开销</li>
<li><strong>可移植性</strong>：容器镜像更小，更容易在不同环境间迁移</li>
</ol>
<p>容器适合微服务、CI/CD
等场景，虚拟机适合需要完整操作系统隔离的场景。</p>
<h3 id="q2-如何选择-kubernetes-的网络插件">Q2: 如何选择 Kubernetes
的网络插件？</h3>
<p><strong>A</strong>: 选择网络插件需要考虑以下因素：</p>
<ul>
<li><strong>Flannel</strong>：简单易用，适合中小型集群，性能良好</li>
<li><strong>Calico</strong>：功能强大，支持网络策略，适合需要细粒度安全控制的场景</li>
<li><strong>Weave
Net</strong>：自动网络发现，支持加密，适合多租户环境</li>
<li><strong>Cilium</strong>：基于 eBPF，高性能，适合大规模集群</li>
</ul>
<p>对于大多数场景，Flannel 或 Calico 是不错的选择。</p>
<h3 id="q3-pod-和容器的关系是什么">Q3: Pod 和容器的关系是什么？</h3>
<p><strong>A</strong>: Pod 是 Kubernetes
的最小调度单元，可以包含一个或多个容器。Pod 内的容器：</p>
<ul>
<li>共享网络命名空间（同一 IP 地址）</li>
<li>共享存储卷</li>
<li>可以通过 localhost 通信</li>
<li>生命周期一致（一起创建、删除）</li>
</ul>
<p>单容器 Pod 最常见，多容器 Pod 通常用于：</p>
<ul>
<li>Sidecar 模式（如日志收集、代理）</li>
<li>初始化容器（准备主容器运行环境）</li>
</ul>
<h3 id="q4-如何实现-kubernetes-的滚动更新">Q4: 如何实现 Kubernetes
的滚动更新？</h3>
<p><strong>A</strong>: Deployment 默认使用 RollingUpdate 策略：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">strategy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">rollingUpdate:</span></span><br><span class="line">    <span class="attr">maxSurge:</span> <span class="number">1</span>          <span class="comment"># 可以超出期望副本数的 Pod 数量</span></span><br><span class="line">    <span class="attr">maxUnavailable:</span> <span class="number">0</span>    <span class="comment"># 更新时不可用的 Pod 数量</span></span><br></pre></td></tr></table></figure>
<p>更新过程： 1. 创建新版本 Pod 2. 等待新 Pod 就绪 3. 删除旧版本 Pod 4.
重复直到所有 Pod 更新完成</p>
<p>可以通过 <code>kubectl rollout</code> 命令管理更新：</p>
<ul>
<li><code>kubectl rollout status</code> 查看状态</li>
<li><code>kubectl rollout pause</code> 暂停更新</li>
<li><code>kubectl rollout undo</code> 回滚</li>
</ul>
<h3 id="q5-statefulset-和-deployment-的区别">Q5: StatefulSet 和
Deployment 的区别？</h3>
<p><strong>A</strong>: 主要区别：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>Deployment</th>
<th>StatefulSet</th>
</tr>
</thead>
<tbody>
<tr>
<td>网络标识</td>
<td>随机名称</td>
<td>稳定名称（pod-0, pod-1）</td>
</tr>
<tr>
<td>存储</td>
<td>共享存储</td>
<td>每个 Pod 独立存储</td>
</tr>
<tr>
<td>部署顺序</td>
<td>并行</td>
<td>有序（0, 1, 2...）</td>
</tr>
<tr>
<td>删除顺序</td>
<td>并行</td>
<td>逆序（2, 1, 0）</td>
</tr>
<tr>
<td>适用场景</td>
<td>无状态应用</td>
<td>有状态应用（数据库、消息队列）</td>
</tr>
</tbody>
</table>
<p>StatefulSet 适合需要稳定网络标识和持久存储的应用。</p>
<h3 id="q6-如何调试-kubernetes-pod-问题">Q6: 如何调试 Kubernetes Pod
问题？</h3>
<p><strong>A</strong>: 调试步骤和常用命令：</p>
<p><strong>1. 查看 Pod 状态</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有 Pod</span></span><br><span class="line">kubectl get pods</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看特定命名空间的 Pod</span></span><br><span class="line">kubectl get pods -n production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 详细信息</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 的 YAML 配置</span></span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 的 JSON 格式</span></span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 标签</span></span><br><span class="line">kubectl get pods --show-labels</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据标签筛选 Pod</span></span><br><span class="line">kubectl get pods -l app=myapp</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 查看日志</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Pod 日志</span></span><br><span class="line">kubectl logs &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多容器 Pod 查看特定容器日志</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实时查看日志</span></span><br><span class="line">kubectl logs -f &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看最近100行日志</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; --<span class="built_in">tail</span>=100</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定时间范围的日志</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; --since=1h</span><br><span class="line">kubectl logs &lt;pod-name&gt; --since-time=2025-01-02T10:00:00Z</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看之前容器的日志（Pod 重启后）</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; --previous</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有容器的日志</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; --all-containers=<span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<p><strong>3. 进入容器调试</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入容器</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果容器没有 bash，使用 sh</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在容器中执行命令</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- ps aux</span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- <span class="built_in">env</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- netstat -tlnp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 多容器 Pod 进入特定容器</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -- /bin/bash</span><br></pre></td></tr></table></figure></p>
<p><strong>4. 查看事件和资源</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有事件（按时间排序）</span></span><br><span class="line">kubectl get events --sort-by=.metadata.creationTimestamp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看特定命名空间的事件</span></span><br><span class="line">kubectl get events -n production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 资源使用情况</span></span><br><span class="line">kubectl top pod &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看节点资源使用情况</span></span><br><span class="line">kubectl top node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 的 IP 地址</span></span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 的节点信息</span></span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o jsonpath=<span class="string">&#x27;&#123;.spec.nodeName&#125;&#x27;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>5. 常见问题排查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pod 一直 Pending</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt; | grep -A 5 <span class="string">&quot;Events&quot;</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl describe node &lt;node-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pod 一直 CrashLoopBackOff</span></span><br><span class="line">kubectl logs &lt;pod-name&gt; --previous</span><br><span class="line">kubectl describe pod &lt;pod-name&gt; | grep -A 10 <span class="string">&quot;State&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Pod 无法启动</span></span><br><span class="line">kubectl get pod &lt;pod-name&gt; -o yaml | grep -A 20 <span class="string">&quot;containerStatuses&quot;</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt; | grep -A 10 <span class="string">&quot;Warning\|Error&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查镜像拉取问题</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt; | grep -i <span class="string">&quot;image\|pull&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查资源限制</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt; | grep -A 5 <span class="string">&quot;Limits\|Requests&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查存储卷挂载</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt; | grep -A 10 <span class="string">&quot;Volumes\|Mounts&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>6. 网络问题排查</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Service 和 Endpoints</span></span><br><span class="line">kubectl get svc &lt;service-name&gt;</span><br><span class="line">kubectl get endpoints &lt;service-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 Service 连通性</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> debug --image=busybox --restart=Never -- sh</span><br><span class="line"><span class="comment"># 在 debug pod 中：wget -qO- http://&lt;service-name&gt;:&lt;port&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看网络策略</span></span><br><span class="line">kubectl get networkpolicy</span><br><span class="line">kubectl describe networkpolicy &lt;policy-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 的 DNS 配置</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- <span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 DNS 解析</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> dns-test --image=busybox --restart=Never -- nslookup &lt;service-name&gt;</span><br></pre></td></tr></table></figure>
<p><strong>7. 使用临时调试容器</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建临时 Pod 进行调试</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> debug \</span><br><span class="line">  --image=busybox \</span><br><span class="line">  --restart=Never \</span><br><span class="line">  -- sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 netshoot 工具（网络调试）</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> netshoot \</span><br><span class="line">  --image=nicolaka/netshoot \</span><br><span class="line">  --restart=Never \</span><br><span class="line">  -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 curl 测试服务</span></span><br><span class="line">kubectl run -it --<span class="built_in">rm</span> curl-test \</span><br><span class="line">  --image=curlimages/curl \</span><br><span class="line">  --restart=Never \</span><br><span class="line">  -- curl http://&lt;service-name&gt;:&lt;port&gt;</span><br></pre></td></tr></table></figure>
<h3 id="q7-helm-chart-的依赖管理如何工作">Q7: Helm Chart
的依赖管理如何工作？</h3>
<p><strong>A</strong>: Helm 支持 Chart 依赖，通过
<code>Chart.yaml</code> 的 <code>dependencies</code> 字段定义：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">8.8</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">https://charts.bitnami.com/bitnami</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">17.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">repository:</span> <span class="string">https://charts.bitnami.com/bitnami</span></span><br></pre></td></tr></table></figure>
<p>管理依赖： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新依赖</span></span><br><span class="line">helm dependency update</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建包含依赖的 Chart</span></span><br><span class="line">helm package .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装时自动安装依赖</span></span><br><span class="line">helm install myapp .</span><br></pre></td></tr></table></figure></p>
<p>依赖 Chart 会被下载到 <code>charts/</code> 目录，可以通过
<code>values.yaml</code> 覆盖依赖的配置。</p>
<h3 id="q8-如何实现-kubernetes-的自动扩缩容">Q8: 如何实现 Kubernetes
的自动扩缩容？</h3>
<p><strong>A</strong>: Kubernetes 提供 HPA（Horizontal Pod
Autoscaler）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">70</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">    <span class="attr">resource:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">      <span class="attr">target:</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">        <span class="attr">averageUtilization:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>HPA 会根据 CPU/内存使用率自动调整 Pod 数量。需要安装
metrics-server：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br></pre></td></tr></table></figure>
<h3 id="q9-docker-镜像层缓存机制如何优化构建速度">Q9: Docker
镜像层缓存机制如何优化构建速度？</h3>
<p><strong>A</strong>: Docker 使用层缓存机制，优化策略：</p>
<ol type="1">
<li><p><strong>合理排序 Dockerfile 指令</strong>：
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先复制依赖文件（变更频率低）</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再复制应用代码（变更频率高）</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>合并 RUN 指令</strong>： <figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 好的做法</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y python3 &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 避免多个 RUN（每层都会增加镜像大小）</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>使用 .dockerignore</strong>：排除不需要的文件</p></li>
<li><p><strong>多阶段构建</strong>：减少最终镜像大小</p></li>
</ol>
<h3 id="q10-如何保障-kubernetes-集群的安全性">Q10: 如何保障 Kubernetes
集群的安全性？</h3>
<p><strong>A</strong>: 安全最佳实践：</p>
<ol type="1">
<li><p><strong>RBAC 权限控制</strong>： <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>网络策略</strong>： <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">NetworkPolicy</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deny-all</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">podSelector:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">policyTypes:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ingress</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Egress</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>Secret 管理</strong>：使用 Secret
存储敏感信息，避免硬编码</p></li>
<li><p><strong>镜像安全</strong>：扫描镜像漏洞，使用可信镜像源</p></li>
<li><p><strong>Pod 安全策略</strong>：限制 Pod
权限，禁止特权容器</p></li>
<li><p><strong>TLS 加密</strong>：启用 API Server
TLS，使用加密存储</p></li>
</ol>
<p>定期更新 Kubernetes 版本，及时修复安全漏洞。</p>
<h3 id="q11-docker-镜像构建缓慢如何优化">Q11: Docker
镜像构建缓慢，如何优化？</h3>
<p><strong>A</strong>: 优化 Docker 镜像构建速度的方法：</p>
<p><strong>1. 利用构建缓存</strong>： <figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将变更频率低的层放在前面</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 变更频率高的代码放在后面</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br></pre></td></tr></table></figure></p>
<p><strong>2. 使用多阶段构建</strong>： <figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建阶段</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine AS builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> package*.json ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> npm ci --only=production</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行阶段</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">16</span>-alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=builder /build/node_modules ./node_modules</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br></pre></td></tr></table></figure></p>
<p><strong>3. 使用 .dockerignore</strong>： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">node_modules</span><br><span class="line">.git</span><br><span class="line">.env</span><br><span class="line">*.log</span><br><span class="line">dist</span><br><span class="line">.DS_Store</span><br></pre></td></tr></table></figure></p>
<p><strong>4. 使用 BuildKit</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用 BuildKit</span></span><br><span class="line"><span class="built_in">export</span> DOCKER_BUILDKIT=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 BuildKit 构建</span></span><br><span class="line">docker build --progress=plain -t myapp .</span><br></pre></td></tr></table></figure></p>
<p><strong>5. 并行构建多个阶段</strong>： <figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine AS deps</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine AS runtime</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache python3</span></span><br></pre></td></tr></table></figure></p>
<p><strong>6. 使用缓存挂载</strong>： <figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> --mount=<span class="built_in">type</span>=cache,target=/root/.cache/pip \</span></span><br><span class="line"><span class="language-bash">    pip install -r requirements.txt</span></span><br></pre></td></tr></table></figure></p>
<h3 id="q12-kubernetes-pod-一直处于-pending-状态怎么办">Q12: Kubernetes
Pod 一直处于 Pending 状态怎么办？</h3>
<p><strong>A</strong>: Pod Pending 状态的常见原因和解决方法：</p>
<p><strong>1. 检查节点资源</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点资源</span></span><br><span class="line">kubectl describe node &lt;node-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Pod 调度事件</span></span><br><span class="line">kubectl describe pod &lt;pod-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 常见原因：节点资源不足（CPU/内存）</span></span><br></pre></td></tr></table></figure></p>
<p><strong>2. 检查节点选择器</strong>： <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Pod 有 nodeSelector，但节点不匹配</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure></p>
<p><strong>3. 检查污点和容忍度</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看节点污点</span></span><br><span class="line">kubectl describe node &lt;node-name&gt; | grep Taints</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pod 需要匹配容忍度</span></span><br><span class="line">spec:</span><br><span class="line">  tolerations:</span><br><span class="line"></span><br><span class="line">  - key: <span class="string">&quot;key1&quot;</span></span><br><span class="line">    operator: <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    value: <span class="string">&quot;value1&quot;</span></span><br><span class="line">    effect: <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure></p>
<p><strong>4. 检查持久卷声明</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 PVC 状态</span></span><br><span class="line">kubectl get pvc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果 PVC 未绑定，检查 StorageClass 和 PV</span></span><br><span class="line">kubectl get storageclass</span><br><span class="line">kubectl get pv</span><br></pre></td></tr></table></figure></p>
<p><strong>5. 检查资源配额</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看命名空间配额</span></span><br><span class="line">kubectl describe resourcequota -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果超出配额，需要增加配额或删除其他资源</span></span><br></pre></td></tr></table></figure></p>
<p><strong>6. 查看调度器日志</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看调度器 Pod 日志</span></span><br><span class="line">kubectl logs -n kube-system &lt;scheduler-pod-name&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="q13-docker-容器无法访问外部网络怎么办">Q13: Docker
容器无法访问外部网络怎么办？</h3>
<p><strong>A</strong>: 容器网络问题的排查步骤：</p>
<p><strong>1. 检查容器网络模式</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器网络配置</span></span><br><span class="line">docker inspect &lt;container-name&gt; | grep -A 20 <span class="string">&quot;NetworkSettings&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查网络连接</span></span><br><span class="line">docker <span class="built_in">exec</span> &lt;container-name&gt; ping -c 3 8.8.8.8</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 检查 DNS 配置</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看容器 DNS 配置</span></span><br><span class="line">docker <span class="built_in">exec</span> &lt;container-name&gt; <span class="built_in">cat</span> /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用自定义 DNS</span></span><br><span class="line">docker run --dns=8.8.8.8 --dns=8.8.4.4 myapp</span><br></pre></td></tr></table></figure></p>
<p><strong>3. 检查防火墙规则</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查 iptables 规则</span></span><br><span class="line">sudo iptables -L -n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 Docker 网络</span></span><br><span class="line">docker network inspect bridge</span><br></pre></td></tr></table></figure></p>
<p><strong>4. 检查代理设置</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果使用代理，配置代理环境变量</span></span><br><span class="line">docker run -e HTTP_PROXY=http://proxy:8080 \</span><br><span class="line">           -e HTTPS_PROXY=http://proxy:8080 \</span><br><span class="line">           myapp</span><br></pre></td></tr></table></figure></p>
<p><strong>5. 重启 Docker 服务</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重启 Docker daemon</span></span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或重启 Docker 网络</span></span><br><span class="line">sudo systemctl restart docker-network</span><br></pre></td></tr></table></figure></p>
<h3 id="q14-kubernetes-service-无法访问如何排查">Q14: Kubernetes Service
无法访问，如何排查？</h3>
<p><strong>A</strong>: Service 访问问题的排查方法：</p>
<p><strong>1. 检查 Service 和 Endpoints</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 Service</span></span><br><span class="line">kubectl get svc &lt;service-name&gt; -o yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 Endpoints（确保有后端 Pod）</span></span><br><span class="line">kubectl get endpoints &lt;service-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有 Endpoints，检查 Pod 标签是否匹配</span></span><br><span class="line">kubectl get pods --show-labels</span><br></pre></td></tr></table></figure></p>
<p><strong>2. 检查 Pod 标签和 Selector</strong>： <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Service selector 必须匹配 Pod labels</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span>  <span class="comment"># 必须与 Pod labels 匹配</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure></p>
<p><strong>3. 检查 Pod 端口</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保 Pod 监听的端口与 targetPort 一致</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- netstat -tlnp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 Pod 端口</span></span><br><span class="line">kubectl <span class="built_in">exec</span> &lt;pod-name&gt; -- curl localhost:8080</span><br></pre></td></tr></table></figure></p>
<p><strong>4. 检查网络策略</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 NetworkPolicy</span></span><br><span class="line">kubectl get networkpolicy</span><br><span class="line"></span><br><span class="line"><span class="comment"># NetworkPolicy 可能阻止流量</span></span><br></pre></td></tr></table></figure></p>
<p><strong>5. 从 Pod 内部测试 Service</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入 Pod</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -- /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 Service DNS</span></span><br><span class="line">nslookup my-service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 Service IP</span></span><br><span class="line">curl http://my-service:80</span><br></pre></td></tr></table></figure></p>
<p><strong>6. 检查 kube-proxy</strong>： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 kube-proxy 日志</span></span><br><span class="line">kubectl logs -n kube-system &lt;kube-proxy-pod&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查 iptables 规则</span></span><br><span class="line">sudo iptables -t nat -L | grep &lt;service-name&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="q15-docker-和-kubernetes-的资源消耗对比">Q15: Docker 和
Kubernetes 的资源消耗对比？</h3>
<p><strong>A</strong>: 资源消耗对比表：</p>
<table>
<colgroup>
<col style="width: 16%">
<col style="width: 14%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr>
<th>资源类型</th>
<th>Docker</th>
<th>Kubernetes (单节点)</th>
<th>Kubernetes (3节点)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>CPU</strong></td>
<td>低（仅容器运行时）</td>
<td>中等（控制平面+节点组件）</td>
<td>高（3个控制平面+节点）</td>
</tr>
<tr>
<td><strong>内存</strong></td>
<td>低（~100MB）</td>
<td>中等（~2-4GB）</td>
<td>高（~6-12GB）</td>
</tr>
<tr>
<td><strong>磁盘</strong></td>
<td>低（镜像和容器）</td>
<td>中等（+etcd数据）</td>
<td>高（+多节点数据）</td>
</tr>
<tr>
<td><strong>网络</strong></td>
<td>低（仅容器网络）</td>
<td>中等（+Service网络）</td>
<td>高（+跨节点通信）</td>
</tr>
</tbody>
</table>
<p><strong>详细说明</strong>：</p>
<p><strong>Docker</strong>：</p>
<ul>
<li>CPU：容器运行时开销约 1-5%</li>
<li>内存：Docker daemon 约 50-200MB，每个容器约 10-50MB 开销</li>
<li>磁盘：镜像存储，可共享层节省空间</li>
<li>网络：bridge 网络开销很小</li>
</ul>
<p><strong>Kubernetes（单节点）</strong>：</p>
<ul>
<li>CPU：控制平面组件（API Server、etcd、Scheduler、Controller
Manager）约 500m-2 CPU</li>
<li>内存：控制平面约 1-2GB，节点组件（kubelet、kube-proxy）约
200-500MB</li>
<li>磁盘：etcd 数据约 1-10GB（取决于集群规模）</li>
<li>网络：CNI 插件额外开销</li>
</ul>
<p><strong>Kubernetes（多节点）</strong>：</p>
<ul>
<li>控制平面资源乘以节点数（高可用部署）</li>
<li>跨节点网络通信开销</li>
<li>分布式存储开销</li>
</ul>
<p><strong>优化建议</strong>： 1. 小规模应用：使用 Docker Compose 2.
中等规模：单节点 Kubernetes 或轻量级发行版（k3s、k0s） 3.
大规模生产：完整 Kubernetes 集群</p>
<h3 id="q16-如何实现-kubernetes-的蓝绿部署">Q16: 如何实现 Kubernetes
的蓝绿部署？</h3>
<p><strong>A</strong>: 蓝绿部署实现方法：</p>
<p><strong>方法1：使用两个 Deployment</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 蓝色版本（当前生产）</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-blue</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">blue</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">blue</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">myapp:v1.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 绿色版本（新版本）</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-green</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">green</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">green</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">myapp:v2.0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Service 指向蓝色版本</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">blue</span>  <span class="comment"># 切换到 green 实现切换</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p><strong>切换脚本</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 切换到绿色版本</span></span><br><span class="line">kubectl patch service app-service -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;selector&quot;:&#123;&quot;version&quot;:&quot;green&quot;&#125;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证切换</span></span><br><span class="line">kubectl get endpoints app-service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回滚到蓝色版本</span></span><br><span class="line">kubectl patch service app-service -p <span class="string">&#x27;&#123;&quot;spec&quot;:&#123;&quot;selector&quot;:&#123;&quot;version&quot;:&quot;blue&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>方法2：使用 Istio VirtualService</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">app.example.com</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">app-service</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">blue</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">app-service</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">green</span></span><br><span class="line">      <span class="attr">weight:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 切换到绿色（修改 weight）</span></span><br><span class="line"><span class="comment"># blue: 0, green: 100</span></span><br></pre></td></tr></table></figure>
<h3 id="q17-docker-容器日志管理最佳实践">Q17: Docker
容器日志管理最佳实践？</h3>
<p><strong>A</strong>: 容器日志管理策略：</p>
<p><strong>1. 配置日志驱动</strong>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /etc/docker/daemon.json</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log-driver&quot;</span><span class="punctuation">:</span> <span class="string">&quot;json-file&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;log-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;max-size&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10m&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;max-file&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="string">&quot;production&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;os,customer&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 容器级别日志配置</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 限制日志大小</span></span><br><span class="line">docker run --log-opt max-size=10m \</span><br><span class="line">           --log-opt max-file=3 \</span><br><span class="line">           myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 syslog 驱动</span></span><br><span class="line">docker run --log-driver=syslog \</span><br><span class="line">           --log-opt syslog-address=udp://localhost:514 \</span><br><span class="line">           myapp</span><br></pre></td></tr></table></figure>
<p><strong>3. 使用日志收集工具</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker Compose 配置 Fluentd</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">&quot;fluentd&quot;</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">fluentd-address:</span> <span class="string">localhost:24224</span></span><br><span class="line">        <span class="attr">tag:</span> <span class="string">docker.&#123;&#123;.Name&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">fluentd:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">fluent/fluentd</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./fluentd.conf:/fluentd/etc/fluent.conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;24224:24224&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>4. Kubernetes 日志管理</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="comment"># 日志轮转（需要日志驱动支持）</span></span><br></pre></td></tr></table></figure>
<p><strong>5. 日志清理脚本</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 清理所有容器的旧日志</span></span><br><span class="line">docker system prune -f</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理特定容器的日志</span></span><br><span class="line">docker logs &lt;container-name&gt; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line"><span class="built_in">truncate</span> -s 0 $(docker inspect &lt;container-name&gt; | grep LogPath | <span class="built_in">cut</span> -d <span class="string">&#x27;&quot;&#x27;</span> -f 4)</span><br></pre></td></tr></table></figure>
<h3 id="q18-kubernetes-中如何实现服务间认证">Q18: Kubernetes
中如何实现服务间认证？</h3>
<p><strong>A</strong>: 服务间认证的几种方式：</p>
<p><strong>1. 使用 ServiceAccount 和 Token</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 ServiceAccount</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app-sa</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Pod 使用 ServiceAccount</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">app-sa</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KUBERNETES_SERVICE_HOST</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">&quot;kubernetes.default.svc&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>2. 使用 Istio mTLS</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用 mTLS</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">security.istio.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PeerAuthentication</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mtls:</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="string">STRICT</span></span><br></pre></td></tr></table></figure>
<p><strong>3. 使用 OAuth2/OIDC</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 OIDC</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">oidc-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">oidc-issuer-url:</span> <span class="string">&quot;https://auth.example.com&quot;</span></span><br><span class="line">  <span class="attr">oidc-client-id:</span> <span class="string">&quot;kubernetes&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>4. 使用 cert-manager 管理证书</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">cert-manager.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Certificate</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-cert</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">secretName:</span> <span class="string">service-tls</span></span><br><span class="line">  <span class="attr">issuerRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">ca-issuer</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">ClusterIssuer</span></span><br><span class="line">  <span class="attr">dnsNames:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">service.example.com</span></span><br></pre></td></tr></table></figure>
<h3 id="q19-docker-镜像安全扫描和漏洞管理">Q19: Docker
镜像安全扫描和漏洞管理？</h3>
<p><strong>A</strong>: 镜像安全最佳实践：</p>
<p><strong>1. 使用 Docker Scout</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 扫描镜像</span></span><br><span class="line">docker scout cves myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详细报告</span></span><br><span class="line">docker scout cves --format json myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 持续监控</span></span><br><span class="line">docker scout watch myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>2. 使用 Trivy</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Trivy</span></span><br><span class="line">brew install trivy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扫描镜像</span></span><br><span class="line">trivy image myapp:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扫描并生成报告</span></span><br><span class="line">trivy image -f json -o report.json myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>3. 使用 Clair</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Clair 扫描</span></span><br><span class="line">clair-scanner --ip &lt;clair-server-ip&gt; myapp:latest</span><br></pre></td></tr></table></figure>
<p><strong>4. CI/CD 集成</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GitHub Actions 示例</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Scan</span> <span class="string">image</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">aquasecurity/trivy-action@master</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">image-ref:</span> <span class="string">myapp:latest</span></span><br><span class="line">    <span class="attr">format:</span> <span class="string">&#x27;sarif&#x27;</span></span><br><span class="line">    <span class="attr">output:</span> <span class="string">&#x27;trivy-results.sarif&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>5. 使用基础镜像安全扫描</strong>：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用官方、维护良好的基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> node:<span class="number">18</span>-alpine  <span class="comment"># Alpine 镜像更小、更安全</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定期更新基础镜像</span></span><br><span class="line"><span class="comment"># docker pull node:18-alpine</span></span><br></pre></td></tr></table></figure>
<h3 id="q20-kubernetes-集群备份和恢复策略">Q20: Kubernetes
集群备份和恢复策略？</h3>
<p><strong>A</strong>: 集群备份和恢复方法：</p>
<p><strong>1. etcd 备份</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份 etcd</span></span><br><span class="line">ETCDCTL_API=3 etcdctl \</span><br><span class="line">  --endpoints=https://127.0.0.1:2379 \</span><br><span class="line">  --cacert=/etc/kubernetes/pki/etcd/ca.crt \</span><br><span class="line">  --cert=/etc/kubernetes/pki/etcd/server.crt \</span><br><span class="line">  --key=/etc/kubernetes/pki/etcd/server.key \</span><br><span class="line">  snapshot save /backup/etcd-snapshot-$(<span class="built_in">date</span> +%Y%m%d).db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复 etcd</span></span><br><span class="line">ETCDCTL_API=3 etcdctl snapshot restore /backup/etcd-snapshot.db \</span><br><span class="line">  --data-dir=/var/lib/etcd-backup</span><br></pre></td></tr></table></figure>
<p><strong>2. 资源备份脚本</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 备份所有资源</span></span><br><span class="line">NAMESPACE=production</span><br><span class="line">BACKUP_DIR=/backup/k8s-$(<span class="built_in">date</span> +%Y%m%d)</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$BACKUP_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份所有资源</span></span><br><span class="line">kubectl get all -n <span class="variable">$NAMESPACE</span> -o yaml &gt; <span class="variable">$BACKUP_DIR</span>/all-resources.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份 ConfigMap 和 Secret</span></span><br><span class="line">kubectl get configmap -n <span class="variable">$NAMESPACE</span> -o yaml &gt; <span class="variable">$BACKUP_DIR</span>/configmaps.yaml</span><br><span class="line">kubectl get secret -n <span class="variable">$NAMESPACE</span> -o yaml &gt; <span class="variable">$BACKUP_DIR</span>/secrets.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份 PVC</span></span><br><span class="line">kubectl get pvc -n <span class="variable">$NAMESPACE</span> -o yaml &gt; <span class="variable">$BACKUP_DIR</span>/pvcs.yaml</span><br></pre></td></tr></table></figure>
<p><strong>3. 使用 Velero</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 Velero</span></span><br><span class="line">velero install \</span><br><span class="line">  --provider aws \</span><br><span class="line">  --bucket my-backup-bucket \</span><br><span class="line">  --secret-file ./credentials-velero</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份整个命名空间</span></span><br><span class="line">velero backup create production-backup \</span><br><span class="line">  --include-namespaces production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复备份</span></span><br><span class="line">velero restore create --from-backup production-backup</span><br></pre></td></tr></table></figure>
<p><strong>4. 定期备份策略</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CronJob 自动备份</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronJob</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">etcd-backup</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">schedule:</span> <span class="string">&quot;0 2 * * *&quot;</span>  <span class="comment"># 每天凌晨2点</span></span><br><span class="line">  <span class="attr">jobTemplate:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">etcd-backup</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">bitnami/etcd:latest</span></span><br><span class="line">            <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">              ETCDCTL_API=3 etcdctl snapshot save /backup/etcd.db</span></span><br><span class="line"><span class="string">              # 上传到云存储</span></span><br><span class="line"><span class="string"></span>          <span class="attr">volumes:</span></span><br><span class="line"></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">backup</span></span><br><span class="line">            <span class="attr">hostPath:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/backup</span></span><br><span class="line">          <span class="attr">restartPolicy:</span> <span class="string">OnFailure</span></span><br></pre></td></tr></table></figure>
<hr>
<p>云原生技术正在快速发展，掌握容器技术和 Kubernetes
编排能力，对于现代软件开发和运维至关重要。通过本文的介绍，希望你能建立起对云原生技术的全面理解，并在实际项目中灵活运用这些工具和模式。持续学习，不断实践，才能在这个快速变化的领域中保持竞争力。</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    
    
    
    
    
    
    <ul>
        <li>本文标题：云计算（四）云原生与容器技术</li>
        <li>本文作者：Chen Kai</li>
        <li>创建时间：2024-06-10 00:00:00</li>
        <li>
            本文链接：https://www.chenk.top/cloud-computing-cloud-native-containers/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">#云计算</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/Docker/">#Docker</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">#云原生</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/Kubernetes/">#Kubernetes</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/">#微服务</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/%E5%8F%98%E5%88%86%E8%87%AA%E7%BC%96%E7%A0%81%E5%99%A8%EF%BC%88VAE%EF%BC%89%E8%AF%A6%E8%A7%A3/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">变分自编码器（VAE）详解</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/cloud-computing-networking-sdn/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">云计算（五）网络架构与SDN技术</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'p2Cu9MgjoKzo3VmulhNLIusH-gzGzoHsz',
                    appKey: 'QThQHg3c8sVwGpzg9lu8zEG3',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情赞美帅气伟大的ck吧~',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Chen Kai';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2026&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Chen Kai</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
            </div>
        
        <div class="theme-info info-item">
            <!-- 由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a> -->
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%91%E5%8E%9F%E7%94%9F%E6%A6%82%E5%BF%B5%E4%B8%8E12%E8%A6%81%E7%B4%A0%E5%BA%94%E7%94%A8"><span class="nav-number">1.</span> <span class="nav-text">云原生概念与12要素应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%91%E5%8E%9F%E7%94%9F"><span class="nav-number">1.1.</span> <span class="nav-text">什么是云原生</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%81%E7%B4%A0%E5%BA%94%E7%94%A812-factor-app"><span class="nav-number">1.2.</span> <span class="nav-text">12要素应用（12-Factor App）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker%E5%AE%B9%E5%99%A8%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">Docker容器技术详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">2.1.</span> <span class="nav-text">Docker 架构与核心概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86"><span class="nav-number">2.2.</span> <span class="nav-text">镜像管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86"><span class="nav-number">2.3.</span> <span class="nav-text">容器管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-%E7%BD%91%E7%BB%9C%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.4.</span> <span class="nav-text">Docker 网络详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#bridge-%E7%BD%91%E7%BB%9C%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.4.1.</span> <span class="nav-text">Bridge 网络详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#host-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.4.2.</span> <span class="nav-text">Host 网络模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#overlay-%E7%BD%91%E7%BB%9C%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.4.3.</span> <span class="nav-text">Overlay 网络详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#macvlan-%E7%BD%91%E7%BB%9C"><span class="nav-number">2.4.4.</span> <span class="nav-text">Macvlan 网络</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8%E4%B8%8E%E5%8D%B7%E7%AE%A1%E7%90%86"><span class="nav-number">2.5.</span> <span class="nav-text">Docker 存储驱动与卷管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8%E8%AF%A6%E8%A7%A3"><span class="nav-number">2.5.1.</span> <span class="nav-text">存储驱动详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%8D%B7volume%E7%AE%A1%E7%90%86"><span class="nav-number">2.5.2.</span> <span class="nav-text">数据卷（Volume）管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BB%91%E5%AE%9A%E6%8C%82%E8%BD%BDbind-mount"><span class="nav-number">2.5.3.</span> <span class="nav-text">绑定挂载（Bind Mount）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9Ftmpfs"><span class="nav-number">2.5.4.</span> <span class="nav-text">临时文件系统（tmpfs）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">2.5.5.</span> <span class="nav-text">存储最佳实践</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dockerfile%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA"><span class="nav-number">3.</span> <span class="nav-text">Dockerfile最佳实践与多阶段构建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dockerfile-%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="nav-number">3.1.</span> <span class="nav-text">Dockerfile 基础语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dockerfile-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.2.</span> <span class="nav-text">Dockerfile 最佳实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E9%98%B6%E6%AE%B5%E6%9E%84%E5%BB%BA%E5%AE%9E%E6%88%98"><span class="nav-number">3.3.</span> <span class="nav-text">多阶段构建实战</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-compose%E7%BC%96%E6%8E%92"><span class="nav-number">4.</span> <span class="nav-text">Docker Compose编排</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#compose-%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">Compose 文件结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="nav-number">4.2.</span> <span class="nav-text">常用配置项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compose-%E5%91%BD%E4%BB%A4"><span class="nav-number">4.3.</span> <span class="nav-text">Compose 命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BA%94%E7%94%A8%E6%A0%88"><span class="nav-number">4.4.</span> <span class="nav-text">实战案例：微服务应用栈</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubernetes%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="nav-number">5.</span> <span class="nav-text">Kubernetes核心概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="nav-number">5.1.</span> <span class="nav-text">集群架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pod"><span class="nav-number">5.2.</span> <span class="nav-text">Pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#service"><span class="nav-number">5.3.</span> <span class="nav-text">Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#deployment"><span class="nav-number">5.4.</span> <span class="nav-text">Deployment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#statefulset"><span class="nav-number">5.5.</span> <span class="nav-text">StatefulSet</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2"><span class="nav-number">6.</span> <span class="nav-text">K8s集群部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeadm-%E9%83%A8%E7%BD%B2%E6%8E%A8%E8%8D%90"><span class="nav-number">6.1.</span> <span class="nav-text">kubeadm 部署（推荐）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2"><span class="nav-number">6.2.</span> <span class="nav-text">二进制部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="nav-number">6.3.</span> <span class="nav-text">高可用部署</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s%E7%BD%91%E7%BB%9C%E4%B8%8E%E5%AD%98%E5%82%A8"><span class="nav-number">7.</span> <span class="nav-text">K8s网络与存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubernetes-%E7%BD%91%E7%BB%9C%E6%A8%A1%E5%9E%8B"><span class="nav-number">7.1.</span> <span class="nav-text">Kubernetes 网络模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#service-%E7%BD%91%E7%BB%9C"><span class="nav-number">7.2.</span> <span class="nav-text">Service 网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ingress-%E8%AF%A6%E8%A7%A3"><span class="nav-number">7.3.</span> <span class="nav-text">Ingress 详解</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">7.3.1.</span> <span class="nav-text">Ingress 基础概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress-%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="nav-number">7.3.2.</span> <span class="nav-text">Ingress 基本配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress-%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE"><span class="nav-number">7.3.3.</span> <span class="nav-text">Ingress 高级配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx-ingress-%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3"><span class="nav-number">7.3.4.</span> <span class="nav-text">Nginx Ingress 常用注解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ingress-%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"><span class="nav-number">7.3.5.</span> <span class="nav-text">Ingress 故障排查</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="nav-number">7.4.</span> <span class="nav-text">存储卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#configmap-%E5%92%8C-secret-%E7%AE%A1%E7%90%86"><span class="nav-number">7.5.</span> <span class="nav-text">ConfigMap 和 Secret 管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#configmap-%E8%AF%A6%E8%A7%A3"><span class="nav-number">7.5.1.</span> <span class="nav-text">ConfigMap 详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#secret-%E8%AF%A6%E8%A7%A3"><span class="nav-number">7.5.2.</span> <span class="nav-text">Secret 详解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubernetes-%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6%E4%B8%8E-qos"><span class="nav-number">7.6.</span> <span class="nav-text">Kubernetes 资源限制与 QoS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E8%AF%B7%E6%B1%82%E5%92%8C%E9%99%90%E5%88%B6"><span class="nav-number">7.6.1.</span> <span class="nav-text">资源请求和限制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#qos-%E7%AD%89%E7%BA%A7"><span class="nav-number">7.6.2.</span> <span class="nav-text">QoS 等级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9Dresourcequota"><span class="nav-number">7.6.3.</span> <span class="nav-text">资源配额（ResourceQuota）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%99%90%E5%88%B6%E8%8C%83%E5%9B%B4limitrange"><span class="nav-number">7.6.4.</span> <span class="nav-text">限制范围（LimitRange）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#helm%E5%8C%85%E7%AE%A1%E7%90%86"><span class="nav-number">8.</span> <span class="nav-text">Helm包管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#helm-%E5%9F%BA%E7%A1%80"><span class="nav-number">8.1.</span> <span class="nav-text">Helm 基础</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89-chart"><span class="nav-number">8.2.</span> <span class="nav-text">创建自定义 Chart</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BCistio%E6%B7%B1%E5%85%A5"><span class="nav-number">9.</span> <span class="nav-text">服务网格（Istio）深入</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#istio-%E6%9E%B6%E6%9E%84%E8%AF%A6%E8%A7%A3"><span class="nav-number">9.1.</span> <span class="nav-text">Istio 架构详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86%E6%B7%B1%E5%85%A5"><span class="nav-number">9.2.</span> <span class="nav-text">流量管理深入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#virtualservice-%E8%AF%A6%E8%A7%A3"><span class="nav-number">9.2.1.</span> <span class="nav-text">VirtualService 详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#destinationrule-%E8%AF%A6%E8%A7%A3"><span class="nav-number">9.2.2.</span> <span class="nav-text">DestinationRule 详解</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gateway-%E8%AF%A6%E8%A7%A3"><span class="nav-number">9.2.3.</span> <span class="nav-text">Gateway 详解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5%E6%B7%B1%E5%85%A5"><span class="nav-number">9.3.</span> <span class="nav-text">安全策略深入</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#mtls-%E9%85%8D%E7%BD%AE"><span class="nav-number">9.3.1.</span> <span class="nav-text">mTLS 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E7%AD%96%E7%95%A5"><span class="nav-number">9.3.2.</span> <span class="nav-text">授权策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7"><span class="nav-number">9.4.</span> <span class="nav-text">可观测性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">9.5.</span> <span class="nav-text">服务网格最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="nav-number">10.</span> <span class="nav-text">微服务架构设计模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#api-%E7%BD%91%E5%85%B3%E6%A8%A1%E5%BC%8F"><span class="nav-number">10.1.</span> <span class="nav-text">API 网关模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%A8%A1%E5%BC%8F"><span class="nav-number">10.2.</span> <span class="nav-text">服务发现模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E6%A8%A1%E5%BC%8F"><span class="nav-number">10.3.</span> <span class="nav-text">配置中心模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%86%94%E6%96%AD%E5%99%A8%E6%A8%A1%E5%BC%8Fcircuit-breaker"><span class="nav-number">10.4.</span> <span class="nav-text">熔断器模式（Circuit Breaker）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%90%E6%B5%81%E6%A8%A1%E5%BC%8Frate-limiting"><span class="nav-number">10.5.</span> <span class="nav-text">限流模式（Rate Limiting）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%8D%E7%BA%A7%E6%A8%A1%E5%BC%8Fdegradation"><span class="nav-number">10.6.</span> <span class="nav-text">降级模式（Degradation）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E8%AF%95%E6%A8%A1%E5%BC%8Fretry"><span class="nav-number">10.7.</span> <span class="nav-text">重试模式（Retry）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B6%85%E6%97%B6%E6%A8%A1%E5%BC%8Ftimeout"><span class="nav-number">10.8.</span> <span class="nav-text">超时模式（Timeout）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E6%A8%A1%E5%BC%8F%E6%89%A9%E5%B1%95"><span class="nav-number">10.9.</span> <span class="nav-text">服务发现模式扩展</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA%E6%A8%A1%E5%BC%8F"><span class="nav-number">10.10.</span> <span class="nav-text">分布式追踪模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#cicd%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%AE%9E%E6%88%98"><span class="nav-number">11.</span> <span class="nav-text">CI&#x2F;CD流水线实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#jenkins-pipeline"><span class="nav-number">11.1.</span> <span class="nav-text">Jenkins Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gitlab-cicd"><span class="nav-number">11.2.</span> <span class="nav-text">GitLab CI&#x2F;CD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#github-actions"><span class="nav-number">11.3.</span> <span class="nav-text">GitHub Actions</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="nav-number">12.</span> <span class="nav-text">实战案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%E9%83%A8%E7%BD%B2-wordpress-%E5%BA%94%E7%94%A8%E6%A0%88"><span class="nav-number">12.1.</span> <span class="nav-text">案例一：部署 WordPress 应用栈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%E6%9E%84%E5%BB%BA%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%94%B5%E5%95%86%E7%B3%BB%E7%BB%9F"><span class="nav-number">12.2.</span> <span class="nav-text">案例二：构建微服务电商系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%E9%AB%98%E5%8F%AF%E7%94%A8-redis-%E9%9B%86%E7%BE%A4"><span class="nav-number">12.3.</span> <span class="nav-text">案例三：高可用 Redis 集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#qa-%E4%BA%91%E5%8E%9F%E7%94%9F%E4%B8%8E%E5%AE%B9%E5%99%A8%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">13.</span> <span class="nav-text">❓ Q&amp;A: 云原生与容器常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#q1-docker-%E5%AE%B9%E5%99%A8%E5%92%8C%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">13.1.</span> <span class="nav-text">Q1: Docker
容器和虚拟机的区别是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q2-%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9-kubernetes-%E7%9A%84%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6"><span class="nav-number">13.2.</span> <span class="nav-text">Q2: 如何选择 Kubernetes
的网络插件？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q3-pod-%E5%92%8C%E5%AE%B9%E5%99%A8%E7%9A%84%E5%85%B3%E7%B3%BB%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-number">13.3.</span> <span class="nav-text">Q3: Pod 和容器的关系是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q4-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0-kubernetes-%E7%9A%84%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="nav-number">13.4.</span> <span class="nav-text">Q4: 如何实现 Kubernetes
的滚动更新？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q5-statefulset-%E5%92%8C-deployment-%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">13.5.</span> <span class="nav-text">Q5: StatefulSet 和
Deployment 的区别？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q6-%E5%A6%82%E4%BD%95%E8%B0%83%E8%AF%95-kubernetes-pod-%E9%97%AE%E9%A2%98"><span class="nav-number">13.6.</span> <span class="nav-text">Q6: 如何调试 Kubernetes Pod
问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q7-helm-chart-%E7%9A%84%E4%BE%9D%E8%B5%96%E7%AE%A1%E7%90%86%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="nav-number">13.7.</span> <span class="nav-text">Q7: Helm Chart
的依赖管理如何工作？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q8-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0-kubernetes-%E7%9A%84%E8%87%AA%E5%8A%A8%E6%89%A9%E7%BC%A9%E5%AE%B9"><span class="nav-number">13.8.</span> <span class="nav-text">Q8: 如何实现 Kubernetes
的自动扩缩容？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q9-docker-%E9%95%9C%E5%83%8F%E5%B1%82%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%E6%9E%84%E5%BB%BA%E9%80%9F%E5%BA%A6"><span class="nav-number">13.9.</span> <span class="nav-text">Q9: Docker
镜像层缓存机制如何优化构建速度？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q10-%E5%A6%82%E4%BD%95%E4%BF%9D%E9%9A%9C-kubernetes-%E9%9B%86%E7%BE%A4%E7%9A%84%E5%AE%89%E5%85%A8%E6%80%A7"><span class="nav-number">13.10.</span> <span class="nav-text">Q10: 如何保障 Kubernetes
集群的安全性？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q11-docker-%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E7%BC%93%E6%85%A2%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96"><span class="nav-number">13.11.</span> <span class="nav-text">Q11: Docker
镜像构建缓慢，如何优化？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q12-kubernetes-pod-%E4%B8%80%E7%9B%B4%E5%A4%84%E4%BA%8E-pending-%E7%8A%B6%E6%80%81%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="nav-number">13.12.</span> <span class="nav-text">Q12: Kubernetes
Pod 一直处于 Pending 状态怎么办？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q13-docker-%E5%AE%B9%E5%99%A8%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E5%A4%96%E9%83%A8%E7%BD%91%E7%BB%9C%E6%80%8E%E4%B9%88%E5%8A%9E"><span class="nav-number">13.13.</span> <span class="nav-text">Q13: Docker
容器无法访问外部网络怎么办？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q14-kubernetes-service-%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5"><span class="nav-number">13.14.</span> <span class="nav-text">Q14: Kubernetes Service
无法访问，如何排查？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q15-docker-%E5%92%8C-kubernetes-%E7%9A%84%E8%B5%84%E6%BA%90%E6%B6%88%E8%80%97%E5%AF%B9%E6%AF%94"><span class="nav-number">13.15.</span> <span class="nav-text">Q15: Docker 和
Kubernetes 的资源消耗对比？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q16-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0-kubernetes-%E7%9A%84%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2"><span class="nav-number">13.16.</span> <span class="nav-text">Q16: 如何实现 Kubernetes
的蓝绿部署？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q17-docker-%E5%AE%B9%E5%99%A8%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">13.17.</span> <span class="nav-text">Q17: Docker
容器日志管理最佳实践？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q18-kubernetes-%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E9%97%B4%E8%AE%A4%E8%AF%81"><span class="nav-number">13.18.</span> <span class="nav-text">Q18: Kubernetes
中如何实现服务间认证？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q19-docker-%E9%95%9C%E5%83%8F%E5%AE%89%E5%85%A8%E6%89%AB%E6%8F%8F%E5%92%8C%E6%BC%8F%E6%B4%9E%E7%AE%A1%E7%90%86"><span class="nav-number">13.19.</span> <span class="nav-text">Q19: Docker
镜像安全扫描和漏洞管理？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q20-kubernetes-%E9%9B%86%E7%BE%A4%E5%A4%87%E4%BB%BD%E5%92%8C%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5"><span class="nav-number">13.20.</span> <span class="nav-text">Q20: Kubernetes
集群备份和恢复策略？</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/lang-switch.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
