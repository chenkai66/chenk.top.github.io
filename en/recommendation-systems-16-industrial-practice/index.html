<!DOCTYPE html>



<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Chen Kai">
    
    <title>
        
            Recommendation Systems (16): Industrial Architecture and Best Practices |
        
        Chen Kai Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chenk.top","root":"/","language":"en","default_language":"zh-CN","languages":["zh-CN","en"],"path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Chen Kai Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    
    
    
    
    

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/en/">
                Chen Kai Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/en/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/en/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/en/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/en/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                    <li class="menu-item lang-switch lang-switch-trigger" title="Language">
                        <i class="fas fa-globe"></i>
                    </li>
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item lang-switch-trigger"><i class="fas fa-globe"></i></div>
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/en/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/en/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/en/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/en/tags">TAGS</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    
    
    
    

    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Recommendation Systems (16): Industrial Architecture and Best Practices</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Chen Kai</span>
                        
                            <span class="author-label">BOSS</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    
    
    
    
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2025-12-29 00:00:00</span>
        <span class="mobile">2025-12-29 00:00</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/en/categories/Recommendation-Systems/">Recommendation Systems</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/en/tags/Recommendation-Systems/">Recommendation Systems</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/en/tags/Industrial-Practice/">Industrial Practice</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/en/tags/System-Architecture/">System Architecture</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>6.7k Words</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>41 Mins</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>Building production-grade recommendation systems requires navigating
a complex landscape of architectural decisions, performance constraints,
and business requirements. This article explores the industrial practice
of recommendation systems, covering everything from multi-channel recall
strategies to deployment pipelines and monitoring infrastructure.</p>
<span id="more"></span>
<h2 id="introduction">Introduction</h2>
<p>Industrial recommendation systems differ fundamentally from academic
prototypes. While research papers focus on novel algorithms and metrics,
production systems must handle millions of requests per second, maintain
sub-100ms latency, and continuously adapt to changing user behavior. The
architecture must balance accuracy, scalability, and operational
complexity.</p>
<p>This article synthesizes best practices from leading tech companies,
including Alibaba's EasyRec framework and ByteDance's LONGER system.
We'll examine the complete pipeline: recall, ranking, reranking, feature
engineering, A/B testing, and production deployment.</p>
<h2 id="industrial-recommendation-system-landscape">Industrial
Recommendation System Landscape</h2>
<h3 id="architecture-overview">Architecture Overview</h3>
<p>Modern industrial recommendation systems follow a multi-stage
pipeline architecture:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User Request → Recall (Multi-Channel) → Coarse Ranking → Fine Ranking → Reranking → Response</span><br></pre></td></tr></table></figure>
<p>Each stage serves a specific purpose:</p>
<ul>
<li><strong>Recall</strong>: Reduces the candidate space from millions
to thousands</li>
<li><strong>Coarse Ranking</strong>: Quick filtering using lightweight
models</li>
<li><strong>Fine Ranking</strong>: Detailed scoring with complex
models</li>
<li><strong>Reranking</strong>: Business rules, diversity, and freshness
adjustments</li>
</ul>
<h3 id="key-design-principles">Key Design Principles</h3>
<p><strong>1. Scalability First</strong></p>
<p>Production systems must handle traffic spikes. Horizontal scaling and
stateless services are essential:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example: Stateless ranking service</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RankingService</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_path</span>):</span><br><span class="line">        self.model = load_model(model_path)</span><br><span class="line">        self.feature_extractor = FeatureExtractor()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rank</span>(<span class="params">self, user_id, candidates, context</span>):</span><br><span class="line">        <span class="string">"""Stateless ranking - can be scaled horizontally"""</span></span><br><span class="line">        features = self.feature_extractor.extract(</span><br><span class="line">            user_id, candidates, context</span><br><span class="line">        )</span><br><span class="line">        scores = self.model.predict(features)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sorted</span>(<span class="built_in">zip</span>(candidates, scores), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>2. Latency Budget Allocation</strong></p>
<p>Typical latency budgets: - Recall: 20-30ms - Coarse ranking: 10-20ms
- Fine ranking: 30-50ms - Reranking: 10-20ms - Total: &lt;100ms
(p95)</p>
<p><strong>3. Fault Tolerance</strong></p>
<p>Every component must degrade gracefully:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FaultTolerantRecall</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, recall_channels</span>):</span><br><span class="line">        self.channels = recall_channels</span><br><span class="line">        self.fallback = PopularItemsRecall()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, context</span>):</span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> channel <span class="keyword">in</span> self.channels:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                channel_results = channel.recall(user_id, context, timeout=<span class="number">20</span>)</span><br><span class="line">                results.extend(channel_results)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.warning(<span class="string">f"Channel <span class="subst">{channel.name}</span> failed: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="comment"># Continue with other channels</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> results:</span><br><span class="line">            <span class="keyword">return</span> self.fallback.recall(user_id, context)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> deduplicate(results)</span><br></pre></td></tr></table></figure>
<h2 id="multi-channel-recall-design">Multi-Channel Recall Design</h2>
<p>Recall is the most critical stage—it determines the upper bound of
recommendation quality. Industrial systems employ multiple recall
channels in parallel.</p>
<h3 id="channel-types">Channel Types</h3>
<p><strong>1. Collaborative Filtering Recall</strong></p>
<p>Matrix factorization and item-based collaborative filtering remain
effective:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.sparse <span class="keyword">import</span> csr_matrix</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MatrixFactorizationRecall</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_embeddings, item_embeddings</span>):</span><br><span class="line">        self.user_emb = user_embeddings  <span class="comment"># [num_users, dim]</span></span><br><span class="line">        self.item_emb = item_embeddings  <span class="comment"># [num_items, dim]</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_k=<span class="number">1000</span></span>):</span><br><span class="line">        <span class="string">"""Recall items similar to user preferences"""</span></span><br><span class="line">        user_vec = self.user_emb[user_id]</span><br><span class="line">        <span class="comment"># Approximate nearest neighbor search</span></span><br><span class="line">        scores = np.dot(self.item_emb, user_vec)</span><br><span class="line">        top_indices = np.argsort(scores)[-top_k:][::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> top_indices.tolist()</span><br></pre></td></tr></table></figure>
<p><strong>2. Deep Learning Recall</strong></p>
<p>Neural collaborative filtering and two-tower models:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoTowerRecall</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_dim, item_dim, hidden_dims=[<span class="number">256</span>, <span class="number">128</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.user_tower = self._build_tower(user_dim, hidden_dims)</span><br><span class="line">        self.item_tower = self._build_tower(item_dim, hidden_dims)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_build_tower</span>(<span class="params">self, input_dim, hidden_dims</span>):</span><br><span class="line">        layers = []</span><br><span class="line">        prev_dim = input_dim</span><br><span class="line">        <span class="keyword">for</span> hidden_dim <span class="keyword">in</span> hidden_dims:</span><br><span class="line">            layers.extend([</span><br><span class="line">                nn.Linear(prev_dim, hidden_dim),</span><br><span class="line">                nn.ReLU(),</span><br><span class="line">                nn.BatchNorm1d(hidden_dim)</span><br><span class="line">            ])</span><br><span class="line">            prev_dim = hidden_dim</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, user_features, item_features</span>):</span><br><span class="line">        user_emb = self.user_tower(user_features)</span><br><span class="line">        item_emb = self.item_tower(item_features)</span><br><span class="line">        <span class="keyword">return</span> torch.mm(user_emb, item_emb.t())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_features, item_pool, top_k=<span class="number">1000</span></span>):</span><br><span class="line">        <span class="string">"""Efficient recall using approximate nearest neighbor"""</span></span><br><span class="line">        self.<span class="built_in">eval</span>()</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            user_emb = self.user_tower(user_features)</span><br><span class="line">            item_embs = self.item_tower(item_pool)</span><br><span class="line">            scores = torch.mm(user_emb, item_embs.t())</span><br><span class="line">            _, top_indices = torch.topk(scores, top_k)</span><br><span class="line">            <span class="keyword">return</span> top_indices.cpu().numpy()</span><br></pre></td></tr></table></figure>
<p><strong>3. Graph-Based Recall</strong></p>
<p>Leveraging user-item interaction graphs:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GraphRecall</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, interaction_graph</span>):</span><br><span class="line">        self.graph = interaction_graph</span><br><span class="line">        self.item_similarity = self._compute_item_similarity()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_compute_item_similarity</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""Compute item-item similarity using graph structure"""</span></span><br><span class="line">        similarity = defaultdict(<span class="built_in">dict</span>)</span><br><span class="line">        items = [n <span class="keyword">for</span> n <span class="keyword">in</span> self.graph.nodes() <span class="keyword">if</span> self.graph.nodes[n][<span class="string">'type'</span>] == <span class="string">'item'</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> item1 <span class="keyword">in</span> items:</span><br><span class="line">            neighbors1 = <span class="built_in">set</span>(self.graph.neighbors(item1))</span><br><span class="line">            <span class="keyword">for</span> item2 <span class="keyword">in</span> items:</span><br><span class="line">                <span class="keyword">if</span> item1 != item2:</span><br><span class="line">                    neighbors2 = <span class="built_in">set</span>(self.graph.neighbors(item2))</span><br><span class="line">                    intersection = <span class="built_in">len</span>(neighbors1 &amp; neighbors2)</span><br><span class="line">                    union = <span class="built_in">len</span>(neighbors1 | neighbors2)</span><br><span class="line">                    <span class="keyword">if</span> union &gt; <span class="number">0</span>:</span><br><span class="line">                        similarity[item1][item2] = intersection / union</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> similarity</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_k=<span class="number">1000</span></span>):</span><br><span class="line">        <span class="string">"""Recall items connected to user's interacted items"""</span></span><br><span class="line">        user_items = [</span><br><span class="line">            n <span class="keyword">for</span> n <span class="keyword">in</span> self.graph.neighbors(user_id)</span><br><span class="line">            <span class="keyword">if</span> self.graph.nodes[n][<span class="string">'type'</span>] == <span class="string">'item'</span></span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        candidate_scores = defaultdict(<span class="built_in">float</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> user_items:</span><br><span class="line">            <span class="keyword">for</span> similar_item, sim_score <span class="keyword">in</span> self.item_similarity.get(item, {}).items():</span><br><span class="line">                candidate_scores[similar_item] += sim_score</span><br><span class="line">        </span><br><span class="line">        top_items = <span class="built_in">sorted</span>(</span><br><span class="line">            candidate_scores.items(),</span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>],</span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )[:top_k]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, _ <span class="keyword">in</span> top_items]</span><br></pre></td></tr></table></figure>
<p><strong>4. Real-Time Behavior Recall</strong></p>
<p>Capturing recent user actions:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RealTimeBehaviorRecall</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, time_window_minutes=<span class="number">30</span></span>):</span><br><span class="line">        self.time_window = timedelta(minutes=time_window_minutes)</span><br><span class="line">        self.user_behaviors = defaultdict(deque)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_behavior</span>(<span class="params">self, user_id, item_id, action_type, timestamp</span>):</span><br><span class="line">        <span class="string">"""Record user behavior"""</span></span><br><span class="line">        self.user_behaviors[user_id].append({</span><br><span class="line">            <span class="string">'item_id'</span>: item_id,</span><br><span class="line">            <span class="string">'action_type'</span>: action_type,</span><br><span class="line">            <span class="string">'timestamp'</span>: timestamp</span><br><span class="line">        })</span><br><span class="line">        <span class="comment"># Remove old behaviors</span></span><br><span class="line">        cutoff = timestamp - self.time_window</span><br><span class="line">        <span class="keyword">while</span> (self.user_behaviors[user_id] <span class="keyword">and</span></span><br><span class="line">               self.user_behaviors[user_id][<span class="number">0</span>][<span class="string">'timestamp'</span>] &lt; cutoff):</span><br><span class="line">            self.user_behaviors[user_id].popleft()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_k=<span class="number">500</span></span>):</span><br><span class="line">        <span class="string">"""Recall items based on recent behaviors"""</span></span><br><span class="line">        behaviors = self.user_behaviors.get(user_id, deque())</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Weight by recency and action type</span></span><br><span class="line">        action_weights = {<span class="string">'view'</span>: <span class="number">1.0</span>, <span class="string">'click'</span>: <span class="number">2.0</span>, <span class="string">'purchase'</span>: <span class="number">5.0</span>}</span><br><span class="line">        candidate_scores = defaultdict(<span class="built_in">float</span>)</span><br><span class="line">        current_time = datetime.now()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> behavior <span class="keyword">in</span> behaviors:</span><br><span class="line">            age_minutes = (current_time - behavior[<span class="string">'timestamp'</span>]).total_seconds() / <span class="number">60</span></span><br><span class="line">            recency_weight = np.exp(-age_minutes / <span class="number">10</span>)  <span class="comment"># Exponential decay</span></span><br><span class="line">            action_weight = action_weights.get(behavior[<span class="string">'action_type'</span>], <span class="number">1.0</span>)</span><br><span class="line">            </span><br><span class="line">            score = recency_weight * action_weight</span><br><span class="line">            candidate_scores[behavior[<span class="string">'item_id'</span>]] += score</span><br><span class="line">        </span><br><span class="line">        top_items = <span class="built_in">sorted</span>(</span><br><span class="line">            candidate_scores.items(),</span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>],</span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )[:top_k]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, _ <span class="keyword">in</span> top_items]</span><br></pre></td></tr></table></figure>
<p><strong>5. Content-Based Recall</strong></p>
<p>Using item features and user preferences:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_extraction.text <span class="keyword">import</span> TfidfVectorizer</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ContentBasedRecall</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, item_features</span>):</span><br><span class="line">        self.item_features = item_features</span><br><span class="line">        self.vectorizer = TfidfVectorizer(max_features=<span class="number">1000</span>)</span><br><span class="line">        self.item_vectors = self._vectorize_items()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_vectorize_items</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""Convert item features to vectors"""</span></span><br><span class="line">        texts = [</span><br><span class="line">            <span class="string">' '</span>.join(<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> features.values())</span><br><span class="line">            <span class="keyword">for</span> features <span class="keyword">in</span> self.item_features.values()</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">return</span> self.vectorizer.fit_transform(texts)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_profile, top_k=<span class="number">1000</span></span>):</span><br><span class="line">        <span class="string">"""Recall items matching user profile"""</span></span><br><span class="line">        user_vector = self.vectorizer.transform([<span class="string">' '</span>.join(<span class="built_in">str</span>(v) <span class="keyword">for</span> v <span class="keyword">in</span> user_profile.values())])</span><br><span class="line">        similarities = cosine_similarity(user_vector, self.item_vectors)[<span class="number">0</span>]</span><br><span class="line">        top_indices = np.argsort(similarities)[-top_k:][::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> top_indices.tolist()</span><br></pre></td></tr></table></figure>
<h3 id="multi-channel-fusion">Multi-Channel Fusion</h3>
<p>Combining multiple recall channels requires careful
orchestration:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiChannelRecall</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, channels, channel_weights=<span class="literal">None</span></span>):</span><br><span class="line">        self.channels = channels</span><br><span class="line">        self.channel_weights = channel_weights <span class="keyword">or</span> {ch.name: <span class="number">1.0</span> <span class="keyword">for</span> ch <span class="keyword">in</span> channels}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, context, target_size=<span class="number">2000</span></span>):</span><br><span class="line">        <span class="string">"""Fuse results from multiple channels"""</span></span><br><span class="line">        channel_results = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Parallel execution</span></span><br><span class="line">        <span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="built_in">len</span>(self.channels)) <span class="keyword">as</span> executor:</span><br><span class="line">            futures = {</span><br><span class="line">                executor.submit(ch.recall, user_id, context): ch.name</span><br><span class="line">                <span class="keyword">for</span> ch <span class="keyword">in</span> self.channels</span><br><span class="line">            }</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(futures):</span><br><span class="line">                channel_name = futures[future]</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    results = future.result(timeout=<span class="number">25</span>)</span><br><span class="line">                    channel_results[channel_name] = results</span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    logger.error(<span class="string">f"Channel <span class="subst">{channel_name}</span> failed: <span class="subst">{e}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Weighted fusion</span></span><br><span class="line">        candidate_scores = defaultdict(<span class="built_in">float</span>)</span><br><span class="line">        <span class="keyword">for</span> channel_name, items <span class="keyword">in</span> channel_results.items():</span><br><span class="line">            weight = self.channel_weights.get(channel_name, <span class="number">1.0</span>)</span><br><span class="line">            <span class="keyword">for</span> rank, item_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(items):</span><br><span class="line">                <span class="comment"># Rank-based scoring with channel weight</span></span><br><span class="line">                score = weight * (<span class="number">1.0</span> / (rank + <span class="number">1</span>))</span><br><span class="line">                candidate_scores[item_id] += score</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Select top candidates</span></span><br><span class="line">        top_candidates = <span class="built_in">sorted</span>(</span><br><span class="line">            candidate_scores.items(),</span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>],</span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )[:target_size]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, _ <span class="keyword">in</span> top_candidates]</span><br></pre></td></tr></table></figure>
<h3 id="qa-multi-channel-recall">Q&amp;A: Multi-Channel Recall</h3>
<p><strong>Q1: How many recall channels should we use?</strong></p>
<p>A: Typically 5-10 channels. Too few limits diversity; too many
increases latency and complexity. Start with 3-5 core channels (CF, deep
learning, real-time behavior) and add specialized channels based on
business needs.</p>
<p><strong>Q2: How to handle channel failures?</strong></p>
<p>A: Implement circuit breakers and fallbacks. Each channel should have
a timeout (20-30ms). If a channel fails, continue with others. Always
maintain a fallback channel (e.g., popular items) that never fails.</p>
<p><strong>Q3: Should we deduplicate across channels?</strong></p>
<p>A: Yes, but after fusion. Deduplication before fusion loses
information about item importance across channels. Fuse first, then
deduplicate based on final scores.</p>
<h2 id="coarse-ranking">Coarse Ranking</h2>
<p>Coarse ranking filters recall results using lightweight models,
reducing candidates from thousands to hundreds.</p>
<h3 id="lightweight-model-design">Lightweight Model Design</h3>
<p><strong>1. Linear Models</strong></p>
<p>Fast and interpretable:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> xgboost <span class="keyword">as</span> xgb</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoarseRankingModel</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.model = xgb.XGBRanker(</span><br><span class="line">            objective=<span class="string">'rank:pairwise'</span>,</span><br><span class="line">            tree_method=<span class="string">'hist'</span>,</span><br><span class="line">            max_depth=<span class="number">4</span>,</span><br><span class="line">            n_estimators=<span class="number">50</span>,</span><br><span class="line">            learning_rate=<span class="number">0.1</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">self, X_train, y_train, group_train</span>):</span><br><span class="line">        <span class="string">"""Train with group-based ranking"""</span></span><br><span class="line">        self.model.fit(</span><br><span class="line">            X_train, y_train,</span><br><span class="line">            group=group_train,</span><br><span class="line">            eval_set=[(X_train, y_train)],</span><br><span class="line">            verbose=<span class="literal">False</span></span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, features</span>):</span><br><span class="line">        <span class="string">"""Fast prediction"""</span></span><br><span class="line">        <span class="keyword">return</span> self.model.predict(features)</span><br></pre></td></tr></table></figure>
<p><strong>2. Shallow Neural Networks</strong></p>
<p>More capacity than linear models:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShallowRankingNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_dim, hidden_dims=[<span class="number">128</span>, <span class="number">64</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        layers = []</span><br><span class="line">        prev_dim = input_dim</span><br><span class="line">        <span class="keyword">for</span> hidden_dim <span class="keyword">in</span> hidden_dims:</span><br><span class="line">            layers.extend([</span><br><span class="line">                nn.Linear(prev_dim, hidden_dim),</span><br><span class="line">                nn.ReLU(),</span><br><span class="line">                nn.Dropout(<span class="number">0.1</span>)</span><br><span class="line">            ])</span><br><span class="line">            prev_dim = hidden_dim</span><br><span class="line">        layers.append(nn.Linear(prev_dim, <span class="number">1</span>))</span><br><span class="line">        self.network = nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> self.network(x).squeeze(-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><strong>3. Feature Engineering for Coarse Ranking</strong></p>
<p>Focus on high-signal, low-computation features:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CoarseRankingFeatures</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract</span>(<span class="params">self, user_id, item_id, context</span>):</span><br><span class="line">        <span class="string">"""Extract lightweight features"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># User features</span></span><br><span class="line">        features[<span class="string">'user_click_count_7d'</span>] = self.get_user_stat(user_id, <span class="string">'click_count'</span>, days=<span class="number">7</span>)</span><br><span class="line">        features[<span class="string">'user_purchase_count_30d'</span>] = self.get_user_stat(user_id, <span class="string">'purchase_count'</span>, days=<span class="number">30</span>)</span><br><span class="line">        features[<span class="string">'user_avg_price'</span>] = self.get_user_stat(user_id, <span class="string">'avg_price'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Item features</span></span><br><span class="line">        features[<span class="string">'item_popularity'</span>] = self.get_item_stat(item_id, <span class="string">'popularity'</span>)</span><br><span class="line">        features[<span class="string">'item_ctr_7d'</span>] = self.get_item_stat(item_id, <span class="string">'ctr'</span>, days=<span class="number">7</span>)</span><br><span class="line">        features[<span class="string">'item_price'</span>] = self.get_item_stat(item_id, <span class="string">'price'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Interaction features</span></span><br><span class="line">        features[<span class="string">'user_item_click_count'</span>] = self.get_interaction_count(user_id, item_id, <span class="string">'click'</span>)</span><br><span class="line">        features[<span class="string">'user_category_click_count'</span>] = self.get_category_interaction(user_id, item_id, <span class="string">'click'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Context features</span></span><br><span class="line">        features[<span class="string">'hour'</span>] = context.get(<span class="string">'hour'</span>, <span class="number">0</span>)</span><br><span class="line">        features[<span class="string">'day_of_week'</span>] = context.get(<span class="string">'day_of_week'</span>, <span class="number">0</span>)</span><br><span class="line">        features[<span class="string">'device_type'</span>] = self.encode_device(context.get(<span class="string">'device'</span>, <span class="string">'unknown'</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> np.array([features[k] <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">sorted</span>(features.keys())])</span><br></pre></td></tr></table></figure>
<h3 id="qa-coarse-ranking">Q&amp;A: Coarse Ranking</h3>
<p><strong>Q4: What's the ideal candidate reduction ratio?</strong></p>
<p>A: Typically 10:1 (e.g., 2000 → 200). Too aggressive loses good
candidates; too conservative wastes fine ranking resources. Monitor
recall@K metrics to find the sweet spot.</p>
<p><strong>Q5: Should coarse ranking use the same features as fine
ranking?</strong></p>
<p>A: No. Coarse ranking prioritizes speed, so use fewer, simpler
features. Fine ranking can use complex, expensive features. Overlap is
fine, but coarse ranking should avoid heavy computations.</p>
<h2 id="fine-ranking">Fine Ranking</h2>
<p>Fine ranking uses complex models to score the remaining candidates
precisely.</p>
<h3 id="deep-learning-models">Deep Learning Models</h3>
<p><strong>1. Wide &amp; Deep Architecture</strong></p>
<p>Combines memorization and generalization:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">WideDeepRanking</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, wide_dim, deep_dims, embedding_dims</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># Wide component (linear)</span></span><br><span class="line">        self.wide = nn.Linear(wide_dim, <span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Deep component</span></span><br><span class="line">        self.embeddings = nn.ModuleDict({</span><br><span class="line">            name: nn.Embedding(num_embeddings, dim)</span><br><span class="line">            <span class="keyword">for</span> name, (num_embeddings, dim) <span class="keyword">in</span> embedding_dims.items()</span><br><span class="line">        })</span><br><span class="line">        </span><br><span class="line">        deep_input_dim = <span class="built_in">sum</span>(dim <span class="keyword">for</span> _, dim <span class="keyword">in</span> embedding_dims.values())</span><br><span class="line">        deep_input_dim += deep_dims[<span class="number">0</span>]  <span class="comment"># Dense features</span></span><br><span class="line">        </span><br><span class="line">        layers = []</span><br><span class="line">        prev_dim = deep_input_dim</span><br><span class="line">        <span class="keyword">for</span> hidden_dim <span class="keyword">in</span> deep_dims[<span class="number">1</span>:]:</span><br><span class="line">            layers.extend([</span><br><span class="line">                nn.Linear(prev_dim, hidden_dim),</span><br><span class="line">                nn.ReLU(),</span><br><span class="line">                nn.BatchNorm1d(hidden_dim),</span><br><span class="line">                nn.Dropout(<span class="number">0.2</span>)</span><br><span class="line">            ])</span><br><span class="line">            prev_dim = hidden_dim</span><br><span class="line">        layers.append(nn.Linear(prev_dim, <span class="number">1</span>))</span><br><span class="line">        self.deep = nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, wide_features, sparse_ids, dense_features</span>):</span><br><span class="line">        <span class="comment"># Wide part</span></span><br><span class="line">        wide_out = self.wide(wide_features)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Deep part</span></span><br><span class="line">        embeddings = [</span><br><span class="line">            self.embeddings[name](ids)</span><br><span class="line">            <span class="keyword">for</span> name, ids <span class="keyword">in</span> sparse_ids.items()</span><br><span class="line">        ]</span><br><span class="line">        deep_input = torch.cat(embeddings + [dense_features], dim=<span class="number">1</span>)</span><br><span class="line">        deep_out = self.deep(deep_input)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Combine</span></span><br><span class="line">        <span class="keyword">return</span> wide_out + deep_out</span><br></pre></td></tr></table></figure>
<p><strong>2. DeepFM Architecture</strong></p>
<p>Factorization machines with deep networks:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DeepFM</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, field_dims, embed_dim=<span class="number">10</span>, mlp_dims=[<span class="number">128</span>, <span class="number">64</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.field_dims = field_dims</span><br><span class="line">        self.embed_dim = embed_dim</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FM component</span></span><br><span class="line">        self.embeddings = nn.ModuleList([</span><br><span class="line">            nn.Embedding(field_dim, embed_dim)</span><br><span class="line">            <span class="keyword">for</span> field_dim <span class="keyword">in</span> field_dims</span><br><span class="line">        ])</span><br><span class="line">        self.fm_linear = nn.ModuleList([</span><br><span class="line">            nn.Linear(field_dim, <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">for</span> field_dim <span class="keyword">in</span> field_dims</span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Deep component</span></span><br><span class="line">        mlp_input_dim = <span class="built_in">len</span>(field_dims) * embed_dim</span><br><span class="line">        layers = []</span><br><span class="line">        prev_dim = mlp_input_dim</span><br><span class="line">        <span class="keyword">for</span> hidden_dim <span class="keyword">in</span> mlp_dims:</span><br><span class="line">            layers.extend([</span><br><span class="line">                nn.Linear(prev_dim, hidden_dim),</span><br><span class="line">                nn.ReLU(),</span><br><span class="line">                nn.Dropout(<span class="number">0.2</span>)</span><br><span class="line">            ])</span><br><span class="line">            prev_dim = hidden_dim</span><br><span class="line">        layers.append(nn.Linear(prev_dim, <span class="number">1</span>))</span><br><span class="line">        self.mlp = nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># x: [batch_size, num_fields]</span></span><br><span class="line">        embeddings = [emb(x[:, i]) <span class="keyword">for</span> i, emb <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.embeddings)]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FM part</span></span><br><span class="line">        fm_linear = <span class="built_in">sum</span>([linear(x[:, i:i+<span class="number">1</span>]) <span class="keyword">for</span> i, linear <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.fm_linear)])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sum of squares</span></span><br><span class="line">        sum_square = <span class="built_in">sum</span>(embeddings) ** <span class="number">2</span></span><br><span class="line">        square_sum = <span class="built_in">sum</span>([emb ** <span class="number">2</span> <span class="keyword">for</span> emb <span class="keyword">in</span> embeddings])</span><br><span class="line">        fm_interaction = <span class="number">0.5</span> * (sum_square - square_sum).<span class="built_in">sum</span>(dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Deep part</span></span><br><span class="line">        deep_input = torch.cat(embeddings, dim=<span class="number">1</span>)</span><br><span class="line">        deep_out = self.mlp(deep_input)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> fm_linear + fm_interaction + deep_out</span><br></pre></td></tr></table></figure>
<p><strong>3. DIN (Deep Interest Network)</strong></p>
<p>Models user interest evolution:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DIN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, item_embed_dim, user_embed_dim, hidden_dims=[<span class="number">128</span>, <span class="number">64</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.item_embed_dim = item_embed_dim</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Attention mechanism</span></span><br><span class="line">        self.attention_net = nn.Sequential(</span><br><span class="line">            nn.Linear(item_embed_dim * <span class="number">4</span>, <span class="number">36</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(<span class="number">36</span>, <span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># User behavior encoding</span></span><br><span class="line">        self.behavior_encoder = nn.LSTM(</span><br><span class="line">            item_embed_dim, user_embed_dim, batch_first=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Final MLP</span></span><br><span class="line">        mlp_input_dim = item_embed_dim + user_embed_dim + item_embed_dim</span><br><span class="line">        layers = []</span><br><span class="line">        prev_dim = mlp_input_dim</span><br><span class="line">        <span class="keyword">for</span> hidden_dim <span class="keyword">in</span> hidden_dims:</span><br><span class="line">            layers.extend([</span><br><span class="line">                nn.Linear(prev_dim, hidden_dim),</span><br><span class="line">                nn.ReLU(),</span><br><span class="line">                nn.Dropout(<span class="number">0.2</span>)</span><br><span class="line">            ])</span><br><span class="line">            prev_dim = hidden_dim</span><br><span class="line">        layers.append(nn.Linear(prev_dim, <span class="number">1</span>))</span><br><span class="line">        self.mlp = nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, candidate_item, user_behaviors, user_profile</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        candidate_item: [batch_size, item_embed_dim]</span></span><br><span class="line"><span class="string">        user_behaviors: [batch_size, seq_len, item_embed_dim]</span></span><br><span class="line"><span class="string">        user_profile: [batch_size, user_embed_dim]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        batch_size = candidate_item.size(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Attention over behaviors</span></span><br><span class="line">        candidate_expanded = candidate_item.unsqueeze(<span class="number">1</span>).expand_as(user_behaviors)</span><br><span class="line">        attention_input = torch.cat([</span><br><span class="line">            user_behaviors,</span><br><span class="line">            candidate_expanded,</span><br><span class="line">            user_behaviors - candidate_expanded,</span><br><span class="line">            user_behaviors * candidate_expanded</span><br><span class="line">        ], dim=<span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        attention_weights = self.attention_net(attention_input).squeeze(-<span class="number">1</span>)</span><br><span class="line">        attention_weights = torch.softmax(attention_weights, dim=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Weighted behavior representation</span></span><br><span class="line">        weighted_behaviors = (user_behaviors * attention_weights.unsqueeze(-<span class="number">1</span>)).<span class="built_in">sum</span>(dim=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Final prediction</span></span><br><span class="line">        mlp_input = torch.cat([</span><br><span class="line">            candidate_item,</span><br><span class="line">            weighted_behaviors,</span><br><span class="line">            user_profile</span><br><span class="line">        ], dim=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> self.mlp(mlp_input)</span><br></pre></td></tr></table></figure>
<h3 id="feature-engineering-for-fine-ranking">Feature Engineering for
Fine Ranking</h3>
<p>Complex, high-signal features:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FineRankingFeatures</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">extract</span>(<span class="params">self, user_id, item_id, context</span>):</span><br><span class="line">        <span class="string">"""Extract comprehensive features"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># User sequence features</span></span><br><span class="line">        user_history = self.get_user_history(user_id, max_len=<span class="number">50</span>)</span><br><span class="line">        features[<span class="string">'user_history_emb'</span>] = self.encode_sequence(user_history)</span><br><span class="line">        features[<span class="string">'user_interest_diversity'</span>] = self.compute_diversity(user_history)</span><br><span class="line">        features[<span class="string">'user_preference_shift'</span>] = self.compute_preference_shift(user_history)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Item features</span></span><br><span class="line">        item_features = self.get_item_features(item_id)</span><br><span class="line">        features.update(item_features)</span><br><span class="line">        features[<span class="string">'item_quality_score'</span>] = self.compute_quality_score(item_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cross features</span></span><br><span class="line">        features[<span class="string">'user_item_similarity'</span>] = self.compute_similarity(</span><br><span class="line">            user_history, item_features</span><br><span class="line">        )</span><br><span class="line">        features[<span class="string">'user_category_affinity'</span>] = self.get_category_affinity(</span><br><span class="line">            user_id, item_features[<span class="string">'category'</span>]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Temporal features</span></span><br><span class="line">        features[<span class="string">'time_since_last_interaction'</span>] = self.get_time_since_interaction(</span><br><span class="line">            user_id, item_id</span><br><span class="line">        )</span><br><span class="line">        features[<span class="string">'hour_category_match'</span>] = self.check_hour_category_match(</span><br><span class="line">            context[<span class="string">'hour'</span>], item_features[<span class="string">'category'</span>]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Contextual features</span></span><br><span class="line">        features[<span class="string">'device_item_match'</span>] = self.check_device_match(</span><br><span class="line">            context[<span class="string">'device'</span>], item_features</span><br><span class="line">        )</span><br><span class="line">        features[<span class="string">'location_category_match'</span>] = self.check_location_match(</span><br><span class="line">            context[<span class="string">'location'</span>], item_features[<span class="string">'category'</span>]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br></pre></td></tr></table></figure>
<h3 id="qa-fine-ranking">Q&amp;A: Fine Ranking</h3>
<p><strong>Q6: How complex should fine ranking models be?</strong></p>
<p>A: Balance accuracy and latency. Start with Wide &amp; Deep or
DeepFM. Add complexity (e.g., DIN, DIEN) only if it improves metrics
significantly. Monitor inference time—complex models may require model
compression.</p>
<p><strong>Q7: How to handle feature engineering
complexity?</strong></p>
<p>A: Use feature stores and automated feature engineering. Store
precomputed features in Redis/feature store. Use tools like Feast or
Tecton for feature management. Consider automated feature selection to
reduce dimensionality.</p>
<h2 id="reranking">Reranking</h2>
<p>Reranking applies business rules, diversity constraints, and
freshness adjustments to the final ranking.</p>
<h3 id="diversity-reranking">Diversity Reranking</h3>
<p>Ensuring result diversity:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DiversityReranker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, diversity_weight=<span class="number">0.3</span></span>):</span><br><span class="line">        self.diversity_weight = diversity_weight</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rerank</span>(<span class="params">self, items, scores, item_features, top_k=<span class="number">20</span></span>):</span><br><span class="line">        <span class="string">"""Rerank with diversity constraint"""</span></span><br><span class="line">        selected = []</span><br><span class="line">        remaining = <span class="built_in">list</span>(<span class="built_in">zip</span>(items, scores, item_features))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Greedy selection with diversity</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(selected) &lt; top_k <span class="keyword">and</span> remaining:</span><br><span class="line">            best_idx = <span class="literal">None</span></span><br><span class="line">            best_score = <span class="built_in">float</span>(<span class="string">'-inf'</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> idx, (item, score, features) <span class="keyword">in</span> <span class="built_in">enumerate</span>(remaining):</span><br><span class="line">                <span class="comment"># Relevance score</span></span><br><span class="line">                relevance = score</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Diversity score (distance from selected items)</span></span><br><span class="line">                <span class="keyword">if</span> selected:</span><br><span class="line">                    diversity = <span class="built_in">min</span>([</span><br><span class="line">                        self.compute_distance(features, sel_features)</span><br><span class="line">                        <span class="keyword">for</span> _, _, sel_features <span class="keyword">in</span> selected</span><br><span class="line">                    ])</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    diversity = <span class="number">1.0</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># Combined score</span></span><br><span class="line">                combined = (<span class="number">1</span> - self.diversity_weight) * relevance + \</span><br><span class="line">                          self.diversity_weight * diversity</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> combined &gt; best_score:</span><br><span class="line">                    best_score = combined</span><br><span class="line">                    best_idx = idx</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> best_idx <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                selected.append(remaining.pop(best_idx))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [item <span class="keyword">for</span> item, _, _ <span class="keyword">in</span> selected]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_distance</span>(<span class="params">self, features1, features2</span>):</span><br><span class="line">        <span class="string">"""Compute feature distance"""</span></span><br><span class="line">        <span class="comment"># Example: cosine distance</span></span><br><span class="line">        vec1 = np.array([features1.get(k, <span class="number">0</span>) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">sorted</span>(features1.keys())])</span><br><span class="line">        vec2 = np.array([features2.get(k, <span class="number">0</span>) <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">sorted</span>(features2.keys())])</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> - np.dot(vec1, vec2) / (np.linalg.norm(vec1) * np.linalg.norm(vec2) + <span class="number">1e-8</span>)</span><br></pre></td></tr></table></figure>
<h3 id="business-rules-reranking">Business Rules Reranking</h3>
<p>Applying business constraints:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BusinessRulesReranker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rules</span>):</span><br><span class="line">        self.rules = rules</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rerank</span>(<span class="params">self, items, scores, item_metadata</span>):</span><br><span class="line">        <span class="string">"""Apply business rules"""</span></span><br><span class="line">        results = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> item, score <span class="keyword">in</span> <span class="built_in">zip</span>(items, scores):</span><br><span class="line">            <span class="comment"># Check rules</span></span><br><span class="line">            passed = <span class="literal">True</span></span><br><span class="line">            adjusted_score = score</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> rule <span class="keyword">in</span> self.rules:</span><br><span class="line">                rule_result = rule.apply(item, item_metadata.get(item, {}))</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> rule_result.passed:</span><br><span class="line">                    passed = <span class="literal">False</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                adjusted_score = rule_result.adjust_score(adjusted_score)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> passed:</span><br><span class="line">                results.append((item, adjusted_score))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Sort by adjusted score</span></span><br><span class="line">        results.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> [item <span class="keyword">for</span> item, _ <span class="keyword">in</span> results]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BusinessRule</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, condition, score_adjustment=<span class="number">0.0</span></span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.condition = condition</span><br><span class="line">        self.score_adjustment = score_adjustment</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">apply</span>(<span class="params">self, item, metadata</span>):</span><br><span class="line">        passed = self.condition(item, metadata)</span><br><span class="line">        <span class="keyword">return</span> RuleResult(passed, self.score_adjustment <span class="keyword">if</span> passed <span class="keyword">else</span> -<span class="built_in">float</span>(<span class="string">'inf'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example rules</span></span><br><span class="line">rules = [</span><br><span class="line">    BusinessRule(</span><br><span class="line">        <span class="string">'promoted_items'</span>,</span><br><span class="line">        <span class="keyword">lambda</span> item, meta: meta.get(<span class="string">'is_promoted'</span>, <span class="literal">False</span>),</span><br><span class="line">        score_adjustment=<span class="number">0.5</span></span><br><span class="line">    ),</span><br><span class="line">    BusinessRule(</span><br><span class="line">        <span class="string">'new_items_boost'</span>,</span><br><span class="line">        <span class="keyword">lambda</span> item, meta: meta.get(<span class="string">'days_since_launch'</span>, <span class="number">365</span>) &lt; <span class="number">7</span>,</span><br><span class="line">        score_adjustment=<span class="number">0.2</span></span><br><span class="line">    ),</span><br><span class="line">    BusinessRule(</span><br><span class="line">        <span class="string">'exclude_out_of_stock'</span>,</span><br><span class="line">        <span class="keyword">lambda</span> item, meta: meta.get(<span class="string">'stock'</span>, <span class="number">0</span>) &gt; <span class="number">0</span>,</span><br><span class="line">        score_adjustment=<span class="number">0.0</span></span><br><span class="line">    )</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="freshness-reranking">Freshness Reranking</h3>
<p>Promoting recent content:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FreshnessReranker</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, freshness_decay_hours=<span class="number">24</span></span>):</span><br><span class="line">        self.freshness_decay_hours = freshness_decay_hours</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rerank</span>(<span class="params">self, items, scores, item_timestamps</span>):</span><br><span class="line">        <span class="string">"""Boost fresh items"""</span></span><br><span class="line">        current_time = datetime.now()</span><br><span class="line">        </span><br><span class="line">        adjusted_scores = []</span><br><span class="line">        <span class="keyword">for</span> item, score <span class="keyword">in</span> <span class="built_in">zip</span>(items, scores):</span><br><span class="line">            item_time = item_timestamps.get(item)</span><br><span class="line">            <span class="keyword">if</span> item_time:</span><br><span class="line">                age_hours = (current_time - item_time).total_seconds() / <span class="number">3600</span></span><br><span class="line">                freshness_boost = np.exp(-age_hours / self.freshness_decay_hours)</span><br><span class="line">                adjusted_score = score * (<span class="number">1</span> + <span class="number">0.3</span> * freshness_boost)  <span class="comment"># Up to 30% boost</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                adjusted_score = score</span><br><span class="line">            </span><br><span class="line">            adjusted_scores.append((item, adjusted_score))</span><br><span class="line">        </span><br><span class="line">        adjusted_scores.sort(key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> [item <span class="keyword">for</span> item, _ <span class="keyword">in</span> adjusted_scores]</span><br></pre></td></tr></table></figure>
<h3 id="qa-reranking">Q&amp;A: Reranking</h3>
<p><strong>Q8: How to balance relevance and diversity?</strong></p>
<p>A: Use MMR (Maximal Marginal Relevance) or similar algorithms. Start
with diversity_weight=0.2-0.3. A/B test different weights and monitor
both CTR and diversity metrics (e.g., category diversity, price
diversity).</p>
<p><strong>Q9: Should reranking be model-based or
rule-based?</strong></p>
<p>A: Hybrid approach works best. Use rules for hard constraints (e.g.,
exclude out-of-stock items) and model-based reranking for soft
optimization (e.g., diversity, freshness). Consider learning-to-rank
models for reranking if you have sufficient data.</p>
<h2 id="alibaba-easyrec-framework">Alibaba EasyRec Framework</h2>
<p>EasyRec is Alibaba's open-source recommendation framework, providing
end-to-end tools for building production systems.</p>
<h3 id="architecture-overview-1">Architecture Overview</h3>
<p>EasyRec provides:</p>
<ol type="1">
<li><strong>Feature Engineering</strong>: Automated feature extraction
and transformation</li>
<li><strong>Model Training</strong>: Pre-built models (Wide&amp;Deep,
DeepFM, DIN, etc.)</li>
<li><strong>Serving</strong>: High-performance inference engine</li>
<li><strong>Evaluation</strong>: Comprehensive metrics and A/B testing
tools</li>
</ol>
<h3 id="key-components">Key Components</h3>
<p><strong>1. Feature Configuration</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EasyRec feature config</span></span><br><span class="line"><span class="string">features</span> {</span><br><span class="line">  <span class="string">user_features</span> {</span><br><span class="line">    <span class="string">features</span> {</span><br><span class="line">      <span class="attr">user_id:</span> {</span><br><span class="line">        <span class="attr">feature_type:</span> <span class="string">IdFeature</span></span><br><span class="line">        <span class="attr">embedding_dim:</span> <span class="number">64</span></span><br><span class="line">      }</span><br><span class="line">      <span class="attr">user_age:</span> {</span><br><span class="line">        <span class="attr">feature_type:</span> <span class="string">RawFeature</span></span><br><span class="line">        <span class="attr">default_value:</span> <span class="number">25</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="string">item_features</span> {</span><br><span class="line">    <span class="string">features</span> {</span><br><span class="line">      <span class="attr">item_id:</span> {</span><br><span class="line">        <span class="attr">feature_type:</span> <span class="string">IdFeature</span></span><br><span class="line">        <span class="attr">embedding_dim:</span> <span class="number">64</span></span><br><span class="line">      }</span><br><span class="line">      <span class="attr">item_category:</span> {</span><br><span class="line">        <span class="attr">feature_type:</span> <span class="string">IdFeature</span></span><br><span class="line">        <span class="attr">embedding_dim:</span> <span class="number">32</span></span><br><span class="line">      }</span><br><span class="line">      <span class="attr">item_price:</span> {</span><br><span class="line">        <span class="attr">feature_type:</span> <span class="string">RawFeature</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="string">context_features</span> {</span><br><span class="line">    <span class="string">features</span> {</span><br><span class="line">      <span class="attr">hour:</span> {</span><br><span class="line">        <span class="attr">feature_type:</span> <span class="string">IdFeature</span></span><br><span class="line">        <span class="attr">embedding_dim:</span> <span class="number">16</span></span><br><span class="line">      }</span><br><span class="line">      <span class="attr">device:</span> {</span><br><span class="line">        <span class="attr">feature_type:</span> <span class="string">IdFeature</span></span><br><span class="line">        <span class="attr">embedding_dim:</span> <span class="number">16</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>2. Model Configuration</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EasyRec model config</span></span><br><span class="line"><span class="string">model_config</span> {</span><br><span class="line">  <span class="attr">model_class:</span> <span class="string">"DeepFM"</span></span><br><span class="line">  </span><br><span class="line">  <span class="string">feature_groups</span> {</span><br><span class="line">    <span class="attr">group_name:</span> <span class="string">"wide"</span></span><br><span class="line">    <span class="attr">feature_names:</span> [<span class="string">"user_id"</span>, <span class="string">"item_id"</span>, <span class="string">"item_category"</span>]</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="string">feature_groups</span> {</span><br><span class="line">    <span class="attr">group_name:</span> <span class="string">"deep"</span></span><br><span class="line">    <span class="attr">feature_names:</span> [<span class="string">"user_id"</span>, <span class="string">"item_id"</span>, <span class="string">"item_category"</span>, <span class="string">"item_price"</span>, <span class="string">"hour"</span>]</span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="string">deepfm</span> {</span><br><span class="line">    <span class="attr">wide_output_dim:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">deep_hidden_dims:</span> [<span class="number">128</span>, <span class="number">64</span>, <span class="number">32</span>]</span><br><span class="line">    <span class="attr">dropout_rate:</span> <span class="number">0.2</span></span><br><span class="line">  }</span><br><span class="line">  </span><br><span class="line">  <span class="attr">embedding_regularization:</span> <span class="number">1e-6</span></span><br><span class="line">  <span class="attr">l2_regularization:</span> <span class="number">1e-5</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p><strong>3. Training Pipeline</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EasyRec training example</span></span><br><span class="line"><span class="keyword">import</span> easy_rec</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initialize</span></span><br><span class="line">config = easy_rec.Config(<span class="string">'model_config.yaml'</span>)</span><br><span class="line">trainer = easy_rec.Trainer(config)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Train</span></span><br><span class="line">trainer.train(</span><br><span class="line">    train_data_path=<span class="string">'s3://bucket/train/'</span>,</span><br><span class="line">    eval_data_path=<span class="string">'s3://bucket/eval/'</span>,</span><br><span class="line">    output_path=<span class="string">'s3://bucket/models/'</span>,</span><br><span class="line">    num_epochs=<span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Export model</span></span><br><span class="line">trainer.export_model(</span><br><span class="line">    checkpoint_path=<span class="string">'s3://bucket/models/checkpoint-10000'</span>,</span><br><span class="line">    export_path=<span class="string">'s3://bucket/models/exported/'</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>4. Serving</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EasyRec serving</span></span><br><span class="line"><span class="keyword">import</span> easy_rec</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load model</span></span><br><span class="line">predictor = easy_rec.Predictor(<span class="string">'s3://bucket/models/exported/'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Predict</span></span><br><span class="line">features = {</span><br><span class="line">    <span class="string">'user_id'</span>: [<span class="number">12345</span>],</span><br><span class="line">    <span class="string">'item_id'</span>: [<span class="number">67890</span>],</span><br><span class="line">    <span class="string">'item_category'</span>: [<span class="number">5</span>],</span><br><span class="line">    <span class="string">'item_price'</span>: [<span class="number">99.99</span>],</span><br><span class="line">    <span class="string">'hour'</span>: [<span class="number">14</span>]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">scores = predictor.predict(features)</span><br></pre></td></tr></table></figure>
<h3 id="easyrec-best-practices">EasyRec Best Practices</h3>
<ol type="1">
<li><strong>Feature Engineering</strong>: Use EasyRec's feature
transformations (normalization, bucketization, etc.)</li>
<li><strong>Model Selection</strong>: Start with DeepFM, upgrade to
DIN/DIEN if needed</li>
<li><strong>Distributed Training</strong>: Use EasyRec's distributed
training for large datasets</li>
<li><strong>Model Versioning</strong>: Leverage EasyRec's model
versioning for A/B testing</li>
</ol>
<h3 id="qa-easyrec">Q&amp;A: EasyRec</h3>
<p><strong>Q10: How does EasyRec compare to TensorFlow
Recommenders?</strong></p>
<p>A: EasyRec is more production-oriented with built-in serving, feature
engineering, and A/B testing. TensorFlow Recommenders is more flexible
but requires more custom code. EasyRec is better for rapid deployment;
TF Recommenders for research.</p>
<h2 id="bytedance-longer-system">ByteDance LONGER System</h2>
<p>LONGER (Learning to Optimize Recommendation with Graph Enhanced
Ranking) is ByteDance's graph-enhanced ranking system.</p>
<h3 id="architecture">Architecture</h3>
<p>LONGER combines: 1. <strong>Graph Neural Networks</strong>: Modeling
user-item relationships 2. <strong>Multi-Task Learning</strong>:
Optimizing multiple objectives simultaneously 3. <strong>Real-Time
Updates</strong>: Incremental graph updates</p>
<h3 id="key-innovations">Key Innovations</h3>
<p><strong>1. Graph Construction</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LONGERGraph</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.user_nodes = {}</span><br><span class="line">        self.item_nodes = {}</span><br><span class="line">        self.edges = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_interaction</span>(<span class="params">self, user_id, item_id, interaction_type, timestamp</span>):</span><br><span class="line">        <span class="string">"""Add interaction to graph"""</span></span><br><span class="line">        edge = {</span><br><span class="line">            <span class="string">'user_id'</span>: user_id,</span><br><span class="line">            <span class="string">'item_id'</span>: item_id,</span><br><span class="line">            <span class="string">'type'</span>: interaction_type,</span><br><span class="line">            <span class="string">'timestamp'</span>: timestamp,</span><br><span class="line">            <span class="string">'weight'</span>: self._compute_weight(interaction_type)</span><br><span class="line">        }</span><br><span class="line">        self.edges[user_id].append(edge)</span><br><span class="line">        self.edges[item_id].append(edge)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_compute_weight</span>(<span class="params">self, interaction_type</span>):</span><br><span class="line">        <span class="string">"""Compute edge weight"""</span></span><br><span class="line">        weights = {<span class="string">'view'</span>: <span class="number">1.0</span>, <span class="string">'click'</span>: <span class="number">2.0</span>, <span class="string">'share'</span>: <span class="number">3.0</span>, <span class="string">'purchase'</span>: <span class="number">5.0</span>}</span><br><span class="line">        <span class="keyword">return</span> weights.get(interaction_type, <span class="number">1.0</span>)</span><br></pre></td></tr></table></figure>
<p><strong>2. Graph Neural Network</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">from</span> torch_geometric.nn <span class="keyword">import</span> GCNConv, GATConv</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LONGERGNN</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_dim, hidden_dims=[<span class="number">128</span>, <span class="number">64</span>], num_heads=<span class="number">4</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.convs = nn.ModuleList()</span><br><span class="line">        prev_dim = input_dim</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># GAT layers for attention</span></span><br><span class="line">        <span class="keyword">for</span> hidden_dim <span class="keyword">in</span> hidden_dims:</span><br><span class="line">            self.convs.append(</span><br><span class="line">                GATConv(prev_dim, hidden_dim, heads=num_heads, concat=<span class="literal">True</span>)</span><br><span class="line">            )</span><br><span class="line">            prev_dim = hidden_dim * num_heads</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Final projection</span></span><br><span class="line">        self.final_proj = nn.Linear(prev_dim, hidden_dims[-<span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x, edge_index, edge_weight=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">"""Forward pass through graph"""</span></span><br><span class="line">        <span class="keyword">for</span> conv <span class="keyword">in</span> self.convs:</span><br><span class="line">            x = conv(x, edge_index, edge_weight)</span><br><span class="line">            x = F.relu(x)</span><br><span class="line">            x = F.dropout(x, training=self.training)</span><br><span class="line">        </span><br><span class="line">        x = self.final_proj(x)</span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<p><strong>3. Multi-Task Learning</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LONGERMultiTask</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, gnn, task_dims</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.gnn = gnn</span><br><span class="line">        self.task_heads = nn.ModuleDict({</span><br><span class="line">            task: nn.Linear(gnn.final_proj.out_features, dim)</span><br><span class="line">            <span class="keyword">for</span> task, dim <span class="keyword">in</span> task_dims.items()</span><br><span class="line">        })</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, user_emb, item_emb, edge_index, task=<span class="string">'ctr'</span></span>):</span><br><span class="line">        <span class="string">"""Forward pass for specific task"""</span></span><br><span class="line">        <span class="comment"># Combine user and item embeddings</span></span><br><span class="line">        node_emb = torch.cat([user_emb, item_emb], dim=<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># GNN encoding</span></span><br><span class="line">        encoded = self.gnn(node_emb, edge_index)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Task-specific head</span></span><br><span class="line">        user_encoded = encoded[:user_emb.size(<span class="number">0</span>)]</span><br><span class="line">        item_encoded = encoded[user_emb.size(<span class="number">0</span>):]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Interaction</span></span><br><span class="line">        interaction = user_encoded * item_encoded</span><br><span class="line">        output = self.task_heads[task](interaction)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>
<h3 id="longer-advantages">LONGER Advantages</h3>
<ol type="1">
<li><strong>Graph Structure</strong>: Captures complex user-item
relationships</li>
<li><strong>Cold Start</strong>: Better handling of new users/items
through graph propagation</li>
<li><strong>Multi-Objective</strong>: Optimizes CTR, engagement, and
revenue simultaneously</li>
<li><strong>Real-Time</strong>: Incremental updates enable real-time
personalization</li>
</ol>
<h3 id="qa-longer">Q&amp;A: LONGER</h3>
<p><strong>Q11: When should we use graph-based approaches like
LONGER?</strong></p>
<p>A: Use graph methods when you have rich interaction data and need to
model complex relationships. They're especially effective for cold start
problems and multi-hop reasoning. However, they require more
computational resources than traditional methods.</p>
<h2 id="feature-engineering-automation">Feature Engineering
Automation</h2>
<p>Manual feature engineering is time-consuming and error-prone.
Automation is essential for scale.</p>
<h3 id="automated-feature-generation">Automated Feature Generation</h3>
<p><strong>1. Feature Crosses</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AutoFeatureCross</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_cross_degree=<span class="number">2</span></span>):</span><br><span class="line">        self.max_cross_degree = max_cross_degree</span><br><span class="line">        self.feature_crosses = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_crosses</span>(<span class="params">self, feature_names</span>):</span><br><span class="line">        <span class="string">"""Generate feature crosses"""</span></span><br><span class="line">        crosses = []</span><br><span class="line">        <span class="keyword">for</span> degree <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, self.max_cross_degree + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">from</span> itertools <span class="keyword">import</span> combinations</span><br><span class="line">            <span class="keyword">for</span> combo <span class="keyword">in</span> combinations(feature_names, degree):</span><br><span class="line">                crosses.append(combo)</span><br><span class="line">        <span class="keyword">return</span> crosses</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_cross</span>(<span class="params">self, cross, data, target</span>):</span><br><span class="line">        <span class="string">"""Evaluate feature cross importance"""</span></span><br><span class="line">        <span class="comment"># Create cross feature</span></span><br><span class="line">        cross_values = data[<span class="built_in">list</span>(cross)].apply(</span><br><span class="line">            <span class="keyword">lambda</span> x: <span class="string">'_'</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, x)), axis=<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Compute mutual information or correlation</span></span><br><span class="line">        <span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> mutual_info_regression</span><br><span class="line">        mi = mutual_info_regression(</span><br><span class="line">            cross_values.values.reshape(-<span class="number">1</span>, <span class="number">1</span>),</span><br><span class="line">            target</span><br><span class="line">        )[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> mi</span><br></pre></td></tr></table></figure>
<p><strong>2. Temporal Features</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TemporalFeatureGenerator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, user_id, item_id, timestamp</span>):</span><br><span class="line">        <span class="string">"""Generate temporal features"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Time-based features</span></span><br><span class="line">        dt = datetime.fromtimestamp(timestamp)</span><br><span class="line">        features[<span class="string">'hour'</span>] = dt.hour</span><br><span class="line">        features[<span class="string">'day_of_week'</span>] = dt.weekday()</span><br><span class="line">        features[<span class="string">'is_weekend'</span>] = dt.weekday() &gt;= <span class="number">5</span></span><br><span class="line">        features[<span class="string">'month'</span>] = dt.month</span><br><span class="line">        features[<span class="string">'day_of_month'</span>] = dt.day</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Cyclical encoding</span></span><br><span class="line">        features[<span class="string">'hour_sin'</span>] = np.sin(<span class="number">2</span> * np.pi * dt.hour / <span class="number">24</span>)</span><br><span class="line">        features[<span class="string">'hour_cos'</span>] = np.cos(<span class="number">2</span> * np.pi * dt.hour / <span class="number">24</span>)</span><br><span class="line">        features[<span class="string">'day_sin'</span>] = np.sin(<span class="number">2</span> * np.pi * dt.weekday() / <span class="number">7</span>)</span><br><span class="line">        features[<span class="string">'day_cos'</span>] = np.cos(<span class="number">2</span> * np.pi * dt.weekday() / <span class="number">7</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Time since events</span></span><br><span class="line">        features[<span class="string">'time_since_last_click'</span>] = self.get_time_since(</span><br><span class="line">            user_id, <span class="string">'click'</span>, timestamp</span><br><span class="line">        )</span><br><span class="line">        features[<span class="string">'time_since_last_purchase'</span>] = self.get_time_since(</span><br><span class="line">            user_id, <span class="string">'purchase'</span>, timestamp</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br></pre></td></tr></table></figure>
<p><strong>3. Statistical Features</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StatisticalFeatureGenerator</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">self, user_id, item_id, window_days=[<span class="number">1</span>, <span class="number">7</span>, <span class="number">30</span>]</span>):</span><br><span class="line">        <span class="string">"""Generate statistical features"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> window <span class="keyword">in</span> window_days:</span><br><span class="line">            <span class="comment"># User statistics</span></span><br><span class="line">            user_clicks = self.get_user_stat(user_id, <span class="string">'click'</span>, window)</span><br><span class="line">            user_purchases = self.get_user_stat(user_id, <span class="string">'purchase'</span>, window)</span><br><span class="line">            features[<span class="string">f'user_clicks_<span class="subst">{window}</span>d'</span>] = user_clicks</span><br><span class="line">            features[<span class="string">f'user_purchases_<span class="subst">{window}</span>d'</span>] = user_purchases</span><br><span class="line">            features[<span class="string">f'user_ctr_<span class="subst">{window}</span>d'</span>] = (</span><br><span class="line">                user_purchases / (user_clicks + <span class="number">1e-8</span>)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Item statistics</span></span><br><span class="line">            item_clicks = self.get_item_stat(item_id, <span class="string">'click'</span>, window)</span><br><span class="line">            item_purchases = self.get_item_stat(item_id, <span class="string">'purchase'</span>, window)</span><br><span class="line">            features[<span class="string">f'item_clicks_<span class="subst">{window}</span>d'</span>] = item_clicks</span><br><span class="line">            features[<span class="string">f'item_purchases_<span class="subst">{window}</span>d'</span>] = item_purchases</span><br><span class="line">            features[<span class="string">f'item_ctr_<span class="subst">{window}</span>d'</span>] = (</span><br><span class="line">                item_purchases / (item_clicks + <span class="number">1e-8</span>)</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># Interaction statistics</span></span><br><span class="line">            interaction_count = self.get_interaction_stat(</span><br><span class="line">                user_id, item_id, window</span><br><span class="line">            )</span><br><span class="line">            features[<span class="string">f'interaction_count_<span class="subst">{window}</span>d'</span>] = interaction_count</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br></pre></td></tr></table></figure>
<h3 id="feature-selection">Feature Selection</h3>
<p>Automatically selecting important features:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> SelectKBest, f_regression, mutual_info_regression</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AutoFeatureSelection</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, method=<span class="string">'mutual_info'</span>, k=<span class="number">100</span></span>):</span><br><span class="line">        self.method = method</span><br><span class="line">        self.k = k</span><br><span class="line">        self.selector = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">self, X, y</span>):</span><br><span class="line">        <span class="string">"""Fit feature selector"""</span></span><br><span class="line">        <span class="keyword">if</span> self.method == <span class="string">'mutual_info'</span>:</span><br><span class="line">            self.selector = SelectKBest(</span><br><span class="line">                mutual_info_regression, k=self.k</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> self.method == <span class="string">'f_test'</span>:</span><br><span class="line">            self.selector = SelectKBest(f_regression, k=self.k)</span><br><span class="line">        </span><br><span class="line">        self.selector.fit(X, y)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">self, X</span>):</span><br><span class="line">        <span class="string">"""Select features"""</span></span><br><span class="line">        <span class="keyword">return</span> self.selector.transform(X)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_selected_features</span>(<span class="params">self, feature_names</span>):</span><br><span class="line">        <span class="string">"""Get names of selected features"""</span></span><br><span class="line">        selected_mask = self.selector.get_support()</span><br><span class="line">        <span class="keyword">return</span> [name <span class="keyword">for</span> name, selected <span class="keyword">in</span> <span class="built_in">zip</span>(feature_names, selected_mask) <span class="keyword">if</span> selected]</span><br></pre></td></tr></table></figure>
<h3 id="feature-store">Feature Store</h3>
<p>Centralized feature management:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FeatureStore</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, feature_ttl=<span class="number">3600</span></span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.ttl = feature_ttl</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_feature</span>(<span class="params">self, entity_type, entity_id, feature_name</span>):</span><br><span class="line">        <span class="string">"""Get feature value"""</span></span><br><span class="line">        key = <span class="string">f"<span class="subst">{entity_type}</span>:<span class="subst">{entity_id}</span>:<span class="subst">{feature_name}</span>"</span></span><br><span class="line">        value = self.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> value:</span><br><span class="line">            <span class="keyword">return</span> json.loads(value)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set_feature</span>(<span class="params">self, entity_type, entity_id, feature_name, value</span>):</span><br><span class="line">        <span class="string">"""Set feature value"""</span></span><br><span class="line">        key = <span class="string">f"<span class="subst">{entity_type}</span>:<span class="subst">{entity_type}</span>:<span class="subst">{feature_name}</span>"</span></span><br><span class="line">        self.redis.setex(</span><br><span class="line">            key,</span><br><span class="line">            self.ttl,</span><br><span class="line">            json.dumps(value)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_get_features</span>(<span class="params">self, entity_type, entity_ids, feature_names</span>):</span><br><span class="line">        <span class="string">"""Batch get features"""</span></span><br><span class="line">        keys = [</span><br><span class="line">            <span class="string">f"<span class="subst">{entity_type}</span>:<span class="subst">{eid}</span>:<span class="subst">{fname}</span>"</span></span><br><span class="line">            <span class="keyword">for</span> eid <span class="keyword">in</span> entity_ids</span><br><span class="line">            <span class="keyword">for</span> fname <span class="keyword">in</span> feature_names</span><br><span class="line">        ]</span><br><span class="line">        values = self.redis.mget(keys)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Reshape to [num_entities, num_features]</span></span><br><span class="line">        num_features = <span class="built_in">len</span>(feature_names)</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            [json.loads(v) <span class="keyword">if</span> v <span class="keyword">else</span> <span class="literal">None</span> <span class="keyword">for</span> v <span class="keyword">in</span> values[i:i+num_features]]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(values), num_features)</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>
<h3 id="qa-feature-engineering">Q&amp;A: Feature Engineering</h3>
<p><strong>Q12: How to balance feature engineering automation and manual
curation?</strong></p>
<p>A: Automate low-level features (statistical, temporal) and use
automation to discover crosses. Manually curate high-level business
features (e.g., user segments, item categories). Use feature importance
to guide manual efforts.</p>
<p><strong>Q13: How often should we refresh features?</strong></p>
<p>A: Real-time features (e.g., recent clicks) update continuously.
Statistical features refresh hourly or daily. Embedding features may
refresh weekly. Monitor feature drift and refresh when distributions
change significantly.</p>
<h2 id="ab-testing-framework">A/B Testing Framework</h2>
<p>A/B testing is crucial for validating improvements and making
data-driven decisions.</p>
<h3 id="experiment-design">Experiment Design</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ABTestFramework</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.experiments = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_experiment</span>(<span class="params">self, experiment_id, variants, traffic_split</span>):</span><br><span class="line">        <span class="string">"""Create A/B test experiment"""</span></span><br><span class="line">        experiment = {</span><br><span class="line">            <span class="string">'id'</span>: experiment_id,</span><br><span class="line">            <span class="string">'variants'</span>: variants,</span><br><span class="line">            <span class="string">'traffic_split'</span>: traffic_split,</span><br><span class="line">            <span class="string">'start_time'</span>: datetime.now(),</span><br><span class="line">            <span class="string">'status'</span>: <span class="string">'running'</span></span><br><span class="line">        }</span><br><span class="line">        self.experiments[experiment_id] = experiment</span><br><span class="line">        self.redis.<span class="built_in">set</span>(</span><br><span class="line">            <span class="string">f"experiment:<span class="subst">{experiment_id}</span>"</span>,</span><br><span class="line">            json.dumps(experiment)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">assign_variant</span>(<span class="params">self, user_id, experiment_id</span>):</span><br><span class="line">        <span class="string">"""Assign user to variant"""</span></span><br><span class="line">        <span class="comment"># Consistent hashing for stable assignment</span></span><br><span class="line">        hash_value = <span class="built_in">hash</span>(<span class="string">f"<span class="subst">{user_id}</span>:<span class="subst">{experiment_id}</span>"</span>) % <span class="number">100</span></span><br><span class="line">        experiment = self.experiments.get(experiment_id)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> experiment:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'control'</span></span><br><span class="line">        </span><br><span class="line">        cumulative = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> variant, split <span class="keyword">in</span> experiment[<span class="string">'traffic_split'</span>].items():</span><br><span class="line">            cumulative += split</span><br><span class="line">            <span class="keyword">if</span> hash_value &lt; cumulative:</span><br><span class="line">                <span class="keyword">return</span> variant</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'control'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_event</span>(<span class="params">self, user_id, experiment_id, variant, event_type, value=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">"""Log experiment event"""</span></span><br><span class="line">        event = {</span><br><span class="line">            <span class="string">'user_id'</span>: user_id,</span><br><span class="line">            <span class="string">'experiment_id'</span>: experiment_id,</span><br><span class="line">            <span class="string">'variant'</span>: variant,</span><br><span class="line">            <span class="string">'event_type'</span>: event_type,</span><br><span class="line">            <span class="string">'value'</span>: value,</span><br><span class="line">            <span class="string">'timestamp'</span>: datetime.now().isoformat()</span><br><span class="line">        }</span><br><span class="line">        self.redis.lpush(</span><br><span class="line">            <span class="string">f"experiment:<span class="subst">{experiment_id}</span>:events"</span>,</span><br><span class="line">            json.dumps(event)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">analyze_results</span>(<span class="params">self, experiment_id, metric=<span class="string">'ctr'</span></span>):</span><br><span class="line">        <span class="string">"""Analyze experiment results"""</span></span><br><span class="line">        events = self._get_events(experiment_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Group by variant</span></span><br><span class="line">        variant_stats = defaultdict(<span class="keyword">lambda</span>: {<span class="string">'impressions'</span>: <span class="number">0</span>, <span class="string">'clicks'</span>: <span class="number">0</span>})</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> event <span class="keyword">in</span> events:</span><br><span class="line">            variant = event[<span class="string">'variant'</span>]</span><br><span class="line">            <span class="keyword">if</span> event[<span class="string">'event_type'</span>] == <span class="string">'impression'</span>:</span><br><span class="line">                variant_stats[variant][<span class="string">'impressions'</span>] += <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> event[<span class="string">'event_type'</span>] == <span class="string">'click'</span>:</span><br><span class="line">                variant_stats[variant][<span class="string">'clicks'</span>] += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Compute metrics</span></span><br><span class="line">        results = {}</span><br><span class="line">        <span class="keyword">for</span> variant, stats <span class="keyword">in</span> variant_stats.items():</span><br><span class="line">            ctr = stats[<span class="string">'clicks'</span>] / (stats[<span class="string">'impressions'</span>] + <span class="number">1e-8</span>)</span><br><span class="line">            results[variant] = {</span><br><span class="line">                <span class="string">'ctr'</span>: ctr,</span><br><span class="line">                <span class="string">'impressions'</span>: stats[<span class="string">'impressions'</span>],</span><br><span class="line">                <span class="string">'clicks'</span>: stats[<span class="string">'clicks'</span>]</span><br><span class="line">            }</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Statistical significance</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'control'</span> <span class="keyword">in</span> results <span class="keyword">and</span> <span class="built_in">len</span>(results) &gt; <span class="number">1</span>:</span><br><span class="line">            control_ctr = results[<span class="string">'control'</span>][<span class="string">'ctr'</span>]</span><br><span class="line">            control_n = results[<span class="string">'control'</span>][<span class="string">'impressions'</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> variant, stats <span class="keyword">in</span> results.items():</span><br><span class="line">                <span class="keyword">if</span> variant != <span class="string">'control'</span>:</span><br><span class="line">                    variant_ctr = stats[<span class="string">'ctr'</span>]</span><br><span class="line">                    variant_n = stats[<span class="string">'impressions'</span>]</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Z-test for proportions</span></span><br><span class="line">                    p_pooled = (results[<span class="string">'control'</span>][<span class="string">'clicks'</span>] + stats[<span class="string">'clicks'</span>]) / \</span><br><span class="line">                               (control_n + variant_n)</span><br><span class="line">                    se = np.sqrt(p_pooled * (<span class="number">1</span> - p_pooled) * (<span class="number">1</span>/control_n + <span class="number">1</span>/variant_n))</span><br><span class="line">                    z_score = (variant_ctr - control_ctr) / (se + <span class="number">1e-8</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># Two-tailed test</span></span><br><span class="line">                    p_value = <span class="number">2</span> * (<span class="number">1</span> - norm.cdf(<span class="built_in">abs</span>(z_score)))</span><br><span class="line">                    </span><br><span class="line">                    stats[<span class="string">'lift'</span>] = (variant_ctr - control_ctr) / (control_ctr + <span class="number">1e-8</span>)</span><br><span class="line">                    stats[<span class="string">'p_value'</span>] = p_value</span><br><span class="line">                    stats[<span class="string">'significant'</span>] = p_value &lt; <span class="number">0.05</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure>
<h3 id="qa-ab-testing">Q&amp;A: A/B Testing</h3>
<p><strong>Q14: How long should A/B tests run?</strong></p>
<p>A: Run until statistical significance is reached or minimum sample
size (typically 2-4 weeks). Use power analysis to determine required
sample size before starting. Don't stop early due to early positive
results—wait for full duration.</p>
<p><strong>Q15: How to handle multiple simultaneous
experiments?</strong></p>
<p>A: Use experiment layering and orthogonal assignment. Ensure
experiments don't interfere by using consistent hashing with experiment
IDs. Monitor for interactions between experiments.</p>
<h2 id="performance-optimization">Performance Optimization</h2>
<p>Production systems require careful optimization to meet latency and
throughput requirements.</p>
<h3 id="model-optimization">Model Optimization</h3>
<p><strong>1. Model Quantization</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.quantization <span class="keyword">as</span> quantization</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelQuantizer</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">quantize_model</span>(<span class="params">self, model, calibration_data</span>):</span><br><span class="line">        <span class="string">"""Quantize model to INT8"""</span></span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Prepare for quantization</span></span><br><span class="line">        model.qconfig = quantization.get_default_qconfig(<span class="string">'fbgemm'</span>)</span><br><span class="line">        quantization.prepare(model, inplace=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Calibrate</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="keyword">for</span> batch <span class="keyword">in</span> calibration_data:</span><br><span class="line">                model(batch)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Convert to quantized</span></span><br><span class="line">        quantized_model = quantization.convert(model, inplace=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> quantized_model</span><br></pre></td></tr></table></figure>
<p><strong>2. Model Pruning</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch.nn.utils.prune <span class="keyword">as</span> prune</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelPruner</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">prune_model</span>(<span class="params">self, model, pruning_ratio=<span class="number">0.3</span></span>):</span><br><span class="line">        <span class="string">"""Prune model weights"""</span></span><br><span class="line">        <span class="keyword">for</span> name, module <span class="keyword">in</span> model.named_modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.Linear):</span><br><span class="line">                prune.l1_unstructured(module, name=<span class="string">'weight'</span>, amount=pruning_ratio)</span><br><span class="line">                prune.remove(module, <span class="string">'weight'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>
<p><strong>3. Knowledge Distillation</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">KnowledgeDistillation</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, teacher_model, student_model, temperature=<span class="number">3.0</span></span>):</span><br><span class="line">        self.teacher = teacher_model</span><br><span class="line">        self.student = student_model</span><br><span class="line">        self.temperature = temperature</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">distill_loss</span>(<span class="params">self, student_logits, teacher_logits, labels, alpha=<span class="number">0.7</span></span>):</span><br><span class="line">        <span class="string">"""Compute distillation loss"""</span></span><br><span class="line">        <span class="comment"># Soft targets from teacher</span></span><br><span class="line">        teacher_soft = F.softmax(teacher_logits / self.temperature, dim=<span class="number">1</span>)</span><br><span class="line">        student_soft = F.log_softmax(student_logits / self.temperature, dim=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Distillation loss</span></span><br><span class="line">        distillation_loss = F.kl_div(</span><br><span class="line">            student_soft, teacher_soft, reduction=<span class="string">'batchmean'</span></span><br><span class="line">        ) * (self.temperature ** <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Hard targets</span></span><br><span class="line">        hard_loss = F.cross_entropy(student_logits, labels)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Combined</span></span><br><span class="line">        <span class="keyword">return</span> alpha * distillation_loss + (<span class="number">1</span> - alpha) * hard_loss</span><br></pre></td></tr></table></figure>
<h3 id="serving-optimization">Serving Optimization</h3>
<p><strong>1. Batch Inference</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BatchInference</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model, batch_size=<span class="number">32</span>, max_wait_ms=<span class="number">10</span></span>):</span><br><span class="line">        self.model = model</span><br><span class="line">        self.batch_size = batch_size</span><br><span class="line">        self.max_wait_ms = max_wait_ms</span><br><span class="line">        self.queue = Queue()</span><br><span class="line">        self.results = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, request_id, features</span>):</span><br><span class="line">        <span class="string">"""Batch prediction"""</span></span><br><span class="line">        self.queue.put((request_id, features, asyncio.Event()))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Wait for batch</span></span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(self.max_wait_ms / <span class="number">1000</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Process batch</span></span><br><span class="line">        batch = []</span><br><span class="line">        request_events = []</span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(batch) &lt; self.batch_size <span class="keyword">and</span> <span class="keyword">not</span> self.queue.empty():</span><br><span class="line">            req_id, feat, event = self.queue.get()</span><br><span class="line">            batch.append(feat)</span><br><span class="line">            request_events.append((req_id, event))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> batch:</span><br><span class="line">            predictions = self.model.predict(np.array(batch))</span><br><span class="line">            <span class="keyword">for</span> (req_id, event), pred <span class="keyword">in</span> <span class="built_in">zip</span>(request_events, predictions):</span><br><span class="line">                self.results[req_id] = pred</span><br><span class="line">                event.<span class="built_in">set</span>()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Wait for result</span></span><br><span class="line">        event = self.results.get(request_id)</span><br><span class="line">        <span class="keyword">if</span> event:</span><br><span class="line">            <span class="keyword">await</span> event.wait()</span><br><span class="line">            <span class="keyword">return</span> self.results.pop(request_id)</span><br></pre></td></tr></table></figure>
<p><strong>2. Caching</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PredictionCache</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, ttl=<span class="number">300</span></span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.ttl = ttl</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_cache_key</span>(<span class="params">self, user_id, item_ids</span>):</span><br><span class="line">        <span class="string">"""Generate cache key"""</span></span><br><span class="line">        item_str = <span class="string">','</span>.join(<span class="built_in">sorted</span>(<span class="built_in">map</span>(<span class="built_in">str</span>, item_ids)))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f"pred:<span class="subst">{user_id}</span>:<span class="subst">{<span class="built_in">hash</span>(item_str)}</span>"</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, user_id, item_ids</span>):</span><br><span class="line">        <span class="string">"""Get cached predictions"""</span></span><br><span class="line">        key = self.get_cache_key(user_id, item_ids)</span><br><span class="line">        cached = self.redis.get(key)</span><br><span class="line">        <span class="keyword">if</span> cached:</span><br><span class="line">            <span class="keyword">return</span> json.loads(cached)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, user_id, item_ids, predictions</span>):</span><br><span class="line">        <span class="string">"""Cache predictions"""</span></span><br><span class="line">        key = self.get_cache_key(user_id, item_ids)</span><br><span class="line">        self.redis.setex(key, self.ttl, json.dumps(predictions))</span><br></pre></td></tr></table></figure>
<p><strong>3. Feature Precomputation</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FeaturePrecomputation</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, feature_store</span>):</span><br><span class="line">        self.feature_store = feature_store</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">precompute_user_features</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="string">"""Precompute user features"""</span></span><br><span class="line">        features = {</span><br><span class="line">            <span class="string">'stats_7d'</span>: self.compute_user_stats(user_id, days=<span class="number">7</span>),</span><br><span class="line">            <span class="string">'stats_30d'</span>: self.compute_user_stats(user_id, days=<span class="number">30</span>),</span><br><span class="line">            <span class="string">'embeddings'</span>: self.get_user_embeddings(user_id),</span><br><span class="line">            <span class="string">'preferences'</span>: self.get_user_preferences(user_id)</span><br><span class="line">        }</span><br><span class="line">        self.feature_store.set_feature(<span class="string">'user'</span>, user_id, <span class="string">'precomputed'</span>, features)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">precompute_item_features</span>(<span class="params">self, item_id</span>):</span><br><span class="line">        <span class="string">"""Precompute item features"""</span></span><br><span class="line">        features = {</span><br><span class="line">            <span class="string">'popularity'</span>: self.compute_popularity(item_id),</span><br><span class="line">            <span class="string">'quality_score'</span>: self.compute_quality_score(item_id),</span><br><span class="line">            <span class="string">'embeddings'</span>: self.get_item_embeddings(item_id),</span><br><span class="line">            <span class="string">'metadata'</span>: self.get_item_metadata(item_id)</span><br><span class="line">        }</span><br><span class="line">        self.feature_store.set_feature(<span class="string">'item'</span>, item_id, <span class="string">'precomputed'</span>, features)</span><br></pre></td></tr></table></figure>
<h3 id="qa-performance-optimization">Q&amp;A: Performance
Optimization</h3>
<p><strong>Q16: How to choose between quantization, pruning, and
distillation?</strong></p>
<p>A: Quantization for fastest inference (2-4x speedup). Pruning for
model size reduction. Distillation for accuracy preservation with
smaller models. Often combine: distill → prune → quantize for maximum
optimization.</p>
<p><strong>Q17: What's the trade-off between batch size and
latency?</strong></p>
<p>A: Larger batches improve throughput but increase latency (waiting
for batch to fill). Find the sweet spot: typically batch_size=16-32 with
max_wait=5-10ms works well. Monitor p95 latency, not just average.</p>
<h2 id="deployment-and-monitoring">Deployment and Monitoring</h2>
<p>Production deployment requires robust infrastructure and
comprehensive monitoring.</p>
<h3 id="deployment-pipeline">Deployment Pipeline</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DeploymentPipeline</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_registry, serving_cluster</span>):</span><br><span class="line">        self.model_registry = model_registry</span><br><span class="line">        self.serving_cluster = serving_cluster</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">deploy</span>(<span class="params">self, model_version, traffic_percentage=<span class="number">10</span></span>):</span><br><span class="line">        <span class="string">"""Gradual rollout deployment"""</span></span><br><span class="line">        <span class="comment"># 1. Validate model</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.validate_model(model_version):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"Model validation failed"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. Deploy to staging</span></span><br><span class="line">        staging_endpoint = self.serving_cluster.deploy(</span><br><span class="line">            model_version, environment=<span class="string">'staging'</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. Smoke tests</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.run_smoke_tests(staging_endpoint):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"Smoke tests failed"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. Canary deployment</span></span><br><span class="line">        canary_endpoint = self.serving_cluster.deploy(</span><br><span class="line">            model_version, environment=<span class="string">'production'</span>, traffic_percentage=traffic_percentage</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 5. Monitor metrics</span></span><br><span class="line">        metrics = self.monitor_metrics(canary_endpoint, duration_minutes=<span class="number">60</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 6. Full rollout or rollback</span></span><br><span class="line">        <span class="keyword">if</span> self.should_rollout(metrics):</span><br><span class="line">            self.serving_cluster.update_traffic(canary_endpoint, <span class="number">100</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.serving_cluster.rollback(canary_endpoint)</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"Canary deployment failed metrics check"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">validate_model</span>(<span class="params">self, model_version</span>):</span><br><span class="line">        <span class="string">"""Validate model before deployment"""</span></span><br><span class="line">        model = self.model_registry.load_model(model_version)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check model structure</span></span><br><span class="line">        <span class="comment"># Check prediction format</span></span><br><span class="line">        <span class="comment"># Check performance on holdout set</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run_smoke_tests</span>(<span class="params">self, endpoint</span>):</span><br><span class="line">        <span class="string">"""Run basic smoke tests"""</span></span><br><span class="line">        test_cases = [</span><br><span class="line">            {<span class="string">'user_id'</span>: <span class="number">1</span>, <span class="string">'item_ids'</span>: [<span class="number">100</span>, <span class="number">200</span>, <span class="number">300</span>]},</span><br><span class="line">            {<span class="string">'user_id'</span>: <span class="number">2</span>, <span class="string">'item_ids'</span>: [<span class="number">150</span>, <span class="number">250</span>, <span class="number">350</span>]}</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> test_case <span class="keyword">in</span> test_cases:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response = self.serving_cluster.predict(endpoint, test_case)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> response <span class="keyword">or</span> <span class="built_in">len</span>(response) == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(<span class="string">f"Smoke test failed: <span class="subst">{e}</span>"</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">should_rollout</span>(<span class="params">self, metrics</span>):</span><br><span class="line">        <span class="string">"""Decide if rollout should continue"""</span></span><br><span class="line">        <span class="comment"># Check latency</span></span><br><span class="line">        <span class="keyword">if</span> metrics[<span class="string">'p95_latency'</span>] &gt; <span class="number">100</span>:  <span class="comment"># ms</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check error rate</span></span><br><span class="line">        <span class="keyword">if</span> metrics[<span class="string">'error_rate'</span>] &gt; <span class="number">0.01</span>:  <span class="comment"># 1%</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check prediction quality (if available)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'prediction_quality'</span> <span class="keyword">in</span> metrics:</span><br><span class="line">            <span class="keyword">if</span> metrics[<span class="string">'prediction_quality'</span>] &lt; <span class="number">0.95</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h3 id="monitoring">Monitoring</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RecommendationMonitor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, metrics_client</span>):</span><br><span class="line">        self.metrics = metrics_client</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_prediction</span>(<span class="params">self, user_id, item_ids, scores, latency_ms</span>):</span><br><span class="line">        <span class="string">"""Log prediction metrics"""</span></span><br><span class="line">        self.metrics.histogram(<span class="string">'prediction.latency'</span>, latency_ms)</span><br><span class="line">        self.metrics.gauge(<span class="string">'prediction.batch_size'</span>, <span class="built_in">len</span>(item_ids))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Score distribution</span></span><br><span class="line">        <span class="keyword">for</span> score <span class="keyword">in</span> scores:</span><br><span class="line">            self.metrics.histogram(<span class="string">'prediction.scores'</span>, score)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_serving_error</span>(<span class="params">self, error_type, error_message</span>):</span><br><span class="line">        <span class="string">"""Log serving errors"""</span></span><br><span class="line">        self.metrics.increment(<span class="string">f'serving.errors.<span class="subst">{error_type}</span>'</span>)</span><br><span class="line">        self.metrics.log_event(<span class="string">'serving_error'</span>, {</span><br><span class="line">            <span class="string">'type'</span>: error_type,</span><br><span class="line">            <span class="string">'message'</span>: error_message,</span><br><span class="line">            <span class="string">'timestamp'</span>: datetime.now().isoformat()</span><br><span class="line">        })</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">log_feature_stats</span>(<span class="params">self, feature_name, value</span>):</span><br><span class="line">        <span class="string">"""Log feature statistics"""</span></span><br><span class="line">        self.metrics.histogram(<span class="string">f'features.<span class="subst">{feature_name}</span>'</span>, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_anomalies</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""Check for anomalies"""</span></span><br><span class="line">        <span class="comment"># Check latency spike</span></span><br><span class="line">        recent_latency = self.metrics.get_recent(<span class="string">'prediction.latency'</span>, minutes=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> recent_latency <span class="keyword">and</span> recent_latency[<span class="string">'p95'</span>] &gt; <span class="number">150</span>:</span><br><span class="line">            self.alert(<span class="string">'high_latency'</span>, recent_latency)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check error rate spike</span></span><br><span class="line">        error_rate = self.metrics.get_error_rate(minutes=<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">if</span> error_rate &gt; <span class="number">0.05</span>:  <span class="comment"># 5%</span></span><br><span class="line">            self.alert(<span class="string">'high_error_rate'</span>, error_rate)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Check prediction distribution shift</span></span><br><span class="line">        recent_scores = self.metrics.get_recent(<span class="string">'prediction.scores'</span>, minutes=<span class="number">30</span>)</span><br><span class="line">        baseline_scores = self.metrics.get_baseline(<span class="string">'prediction.scores'</span>)</span><br><span class="line">        <span class="keyword">if</span> self.detect_distribution_shift(recent_scores, baseline_scores):</span><br><span class="line">            self.alert(<span class="string">'distribution_shift'</span>, {</span><br><span class="line">                <span class="string">'recent'</span>: recent_scores,</span><br><span class="line">                <span class="string">'baseline'</span>: baseline_scores</span><br><span class="line">            })</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">detect_distribution_shift</span>(<span class="params">self, recent, baseline</span>):</span><br><span class="line">        <span class="string">"""Detect distribution shift using KL divergence"""</span></span><br><span class="line">        <span class="comment"># Simplified: compare means and stds</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(recent[<span class="string">'mean'</span>] - baseline[<span class="string">'mean'</span>]) &gt; <span class="number">2</span> * baseline[<span class="string">'std'</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h3 id="qa-deployment-and-monitoring">Q&amp;A: Deployment and
Monitoring</h3>
<p><strong>Q18: How to handle model versioning?</strong></p>
<p>A: Use semantic versioning (major.minor.patch). Store models in a
model registry (MLflow, DVC, or custom). Tag models with metadata
(training data version, hyperparameters, metrics). Maintain version
compatibility for gradual rollouts.</p>
<p><strong>Q19: What metrics should we monitor?</strong></p>
<p>A: System metrics (latency p50/p95/p99, throughput, error rate),
prediction metrics (score distribution, prediction quality), business
metrics (CTR, conversion rate, revenue). Set up alerts for anomalies in
all metrics.</p>
<h2 id="complete-project-example">Complete Project Example</h2>
<p>Let's build a complete recommendation system from scratch.</p>
<h3 id="project-structure">Project Structure</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">recommendation-system/</span><br><span class="line">├── config/</span><br><span class="line">│   ├── model_config.yaml</span><br><span class="line">│   └── feature_config.yaml</span><br><span class="line">├── src/</span><br><span class="line">│   ├── recall/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── collaborative_filtering.py</span><br><span class="line">│   │   ├── deep_learning.py</span><br><span class="line">│   │   └── multi_channel.py</span><br><span class="line">│   ├── ranking/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── coarse_ranking.py</span><br><span class="line">│   │   ├── fine_ranking.py</span><br><span class="line">│   │   └── reranking.py</span><br><span class="line">│   ├── features/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── extractor.py</span><br><span class="line">│   │   └── store.py</span><br><span class="line">│   ├── serving/</span><br><span class="line">│   │   ├── __init__.py</span><br><span class="line">│   │   ├── api.py</span><br><span class="line">│   │   └── predictor.py</span><br><span class="line">│   └── utils/</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       └── monitoring.py</span><br><span class="line">├── training/</span><br><span class="line">│   ├── train_coarse.py</span><br><span class="line">│   ├── train_fine.py</span><br><span class="line">│   └── evaluate.py</span><br><span class="line">├── tests/</span><br><span class="line">│   ├── test_recall.py</span><br><span class="line">│   ├── test_ranking.py</span><br><span class="line">│   └── test_serving.py</span><br><span class="line">└── requirements.txt</span><br></pre></td></tr></table></figure>
<h3 id="main-api-server">Main API Server</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/serving/api.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">from</span> src.serving.predictor <span class="keyword">import</span> RecommendationPredictor</span><br><span class="line"><span class="keyword">from</span> src.utils.monitoring <span class="keyword">import</span> RecommendationMonitor</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">predictor = RecommendationPredictor()</span><br><span class="line">monitor = RecommendationMonitor()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/health'</span>, methods=[<span class="string">'GET'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">health</span>():</span><br><span class="line">    <span class="keyword">return</span> jsonify({<span class="string">'status'</span>: <span class="string">'healthy'</span>})</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/recommend'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recommend</span>():</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data = request.json</span><br><span class="line">        user_id = data[<span class="string">'user_id'</span>]</span><br><span class="line">        context = data.get(<span class="string">'context'</span>, {})</span><br><span class="line">        top_k = data.get(<span class="string">'top_k'</span>, <span class="number">20</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Get recommendations</span></span><br><span class="line">        recommendations = predictor.predict(user_id, context, top_k)</span><br><span class="line">        </span><br><span class="line">        latency_ms = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Log metrics</span></span><br><span class="line">        monitor.log_prediction(</span><br><span class="line">            user_id,</span><br><span class="line">            [r[<span class="string">'item_id'</span>] <span class="keyword">for</span> r <span class="keyword">in</span> recommendations],</span><br><span class="line">            [r[<span class="string">'score'</span>] <span class="keyword">for</span> r <span class="keyword">in</span> recommendations],</span><br><span class="line">            latency_ms</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> jsonify({</span><br><span class="line">            <span class="string">'recommendations'</span>: recommendations,</span><br><span class="line">            <span class="string">'latency_ms'</span>: latency_ms</span><br><span class="line">        })</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        monitor.log_serving_error(<span class="string">'prediction_error'</span>, <span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">return</span> jsonify({<span class="string">'error'</span>: <span class="built_in">str</span>(e)}), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<h3 id="complete-predictor">Complete Predictor</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/serving/predictor.py</span></span><br><span class="line"><span class="keyword">from</span> src.recall.multi_channel <span class="keyword">import</span> MultiChannelRecall</span><br><span class="line"><span class="keyword">from</span> src.ranking.coarse_ranking <span class="keyword">import</span> CoarseRankingModel</span><br><span class="line"><span class="keyword">from</span> src.ranking.fine_ranking <span class="keyword">import</span> FineRankingModel</span><br><span class="line"><span class="keyword">from</span> src.ranking.reranking <span class="keyword">import</span> DiversityReranker, BusinessRulesReranker</span><br><span class="line"><span class="keyword">from</span> src.features.extractor <span class="keyword">import</span> FeatureExtractor</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RecommendationPredictor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Initialize components</span></span><br><span class="line">        self.recall = MultiChannelRecall(...)</span><br><span class="line">        self.coarse_ranking = CoarseRankingModel(...)</span><br><span class="line">        self.fine_ranking = FineRankingModel(...)</span><br><span class="line">        self.reranker = DiversityReranker(...)</span><br><span class="line">        self.business_rules = BusinessRulesReranker(...)</span><br><span class="line">        self.feature_extractor = FeatureExtractor(...)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, user_id, context, top_k=<span class="number">20</span></span>):</span><br><span class="line">        <span class="string">"""Complete recommendation pipeline"""</span></span><br><span class="line">        <span class="comment"># 1. Recall</span></span><br><span class="line">        candidates = self.recall.recall(user_id, context, target_size=<span class="number">2000</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. Coarse ranking</span></span><br><span class="line">        coarse_features = [</span><br><span class="line">            self.feature_extractor.extract_coarse(user_id, item_id, context)</span><br><span class="line">            <span class="keyword">for</span> item_id <span class="keyword">in</span> candidates</span><br><span class="line">        ]</span><br><span class="line">        coarse_scores = self.coarse_ranking.predict(coarse_features)</span><br><span class="line">        coarse_ranked = <span class="built_in">sorted</span>(</span><br><span class="line">            <span class="built_in">zip</span>(candidates, coarse_scores),</span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>],</span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )[:<span class="number">200</span>]  <span class="comment"># Reduce to 200</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. Fine ranking</span></span><br><span class="line">        fine_candidates = [item_id <span class="keyword">for</span> item_id, _ <span class="keyword">in</span> coarse_ranked]</span><br><span class="line">        fine_features = [</span><br><span class="line">            self.feature_extractor.extract_fine(user_id, item_id, context)</span><br><span class="line">            <span class="keyword">for</span> item_id <span class="keyword">in</span> fine_candidates</span><br><span class="line">        ]</span><br><span class="line">        fine_scores = self.fine_ranking.predict(fine_features)</span><br><span class="line">        fine_ranked = <span class="built_in">sorted</span>(</span><br><span class="line">            <span class="built_in">zip</span>(fine_candidates, fine_scores),</span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>],</span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. Reranking</span></span><br><span class="line">        rerank_candidates = [item_id <span class="keyword">for</span> item_id, _ <span class="keyword">in</span> fine_ranked[:<span class="number">50</span>]]</span><br><span class="line">        item_metadata = self.feature_extractor.get_item_metadata(rerank_candidates)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Diversity reranking</span></span><br><span class="line">        diversity_ranked = self.reranker.rerank(</span><br><span class="line">            rerank_candidates,</span><br><span class="line">            [score <span class="keyword">for</span> _, score <span class="keyword">in</span> fine_ranked[:<span class="number">50</span>]],</span><br><span class="line">            item_metadata,</span><br><span class="line">            top_k=top_k</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Business rules</span></span><br><span class="line">        final_ranked = self.business_rules.rerank(</span><br><span class="line">            diversity_ranked,</span><br><span class="line">            [score <span class="keyword">for</span> item_id, score <span class="keyword">in</span> fine_ranked <span class="keyword">if</span> item_id <span class="keyword">in</span> diversity_ranked],</span><br><span class="line">            item_metadata</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Format results</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            {</span><br><span class="line">                <span class="string">'item_id'</span>: item_id,</span><br><span class="line">                <span class="string">'score'</span>: <span class="built_in">next</span>(</span><br><span class="line">                    score <span class="keyword">for</span> iid, score <span class="keyword">in</span> fine_ranked <span class="keyword">if</span> iid == item_id</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">'rank'</span>: idx + <span class="number">1</span></span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">for</span> idx, item_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(final_ranked)</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>
<h3 id="training-script">Training Script</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># training/train_fine.py</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset, DataLoader</span><br><span class="line"><span class="keyword">from</span> src.ranking.fine_ranking <span class="keyword">import</span> FineRankingModel</span><br><span class="line"><span class="keyword">from</span> src.features.extractor <span class="keyword">import</span> FeatureExtractor</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RankingDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, data_path, feature_extractor</span>):</span><br><span class="line">        self.data = pd.read_parquet(data_path)</span><br><span class="line">        self.feature_extractor = feature_extractor</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.data)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        row = self.data.iloc[idx]</span><br><span class="line">        features = self.feature_extractor.extract_fine(</span><br><span class="line">            row[<span class="string">'user_id'</span>],</span><br><span class="line">            row[<span class="string">'item_id'</span>],</span><br><span class="line">            row[<span class="string">'context'</span>]</span><br><span class="line">        )</span><br><span class="line">        label = row[<span class="string">'label'</span>]  <span class="comment"># 0 or 1</span></span><br><span class="line">        <span class="keyword">return</span> features, label</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>():</span><br><span class="line">    <span class="comment"># Load data</span></span><br><span class="line">    train_dataset = RankingDataset(<span class="string">'data/train.parquet'</span>, FeatureExtractor())</span><br><span class="line">    val_dataset = RankingDataset(<span class="string">'data/val.parquet'</span>, FeatureExtractor())</span><br><span class="line">    </span><br><span class="line">    train_loader = DataLoader(train_dataset, batch_size=<span class="number">256</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line">    val_loader = DataLoader(val_dataset, batch_size=<span class="number">256</span>, shuffle=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Initialize model</span></span><br><span class="line">    model = FineRankingModel(input_dim=<span class="number">500</span>)</span><br><span class="line">    optimizer = torch.optim.Adam(model.parameters(), lr=<span class="number">0.001</span>)</span><br><span class="line">    criterion = nn.BCEWithLogitsLoss()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Training loop</span></span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        model.train()</span><br><span class="line">        train_loss = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> features, labels <span class="keyword">in</span> train_loader:</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            predictions = model(features)</span><br><span class="line">            loss = criterion(predictions, labels.<span class="built_in">float</span>())</span><br><span class="line">            loss.backward()</span><br><span class="line">            optimizer.step()</span><br><span class="line">            train_loss += loss.item()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Validation</span></span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        val_loss = <span class="number">0</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="keyword">for</span> features, labels <span class="keyword">in</span> val_loader:</span><br><span class="line">                predictions = model(features)</span><br><span class="line">                loss = criterion(predictions, labels.<span class="built_in">float</span>())</span><br><span class="line">                val_loss += loss.item()</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"Epoch <span class="subst">{epoch}</span>: Train Loss=<span class="subst">{train_loss/<span class="built_in">len</span>(train_loader):<span class="number">.4</span>f}</span>, "</span></span><br><span class="line">              <span class="string">f"Val Loss=<span class="subst">{val_loss/<span class="built_in">len</span>(val_loader):<span class="number">.4</span>f}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Save model</span></span><br><span class="line">    torch.save(model.state_dict(), <span class="string">'models/fine_ranking_model.pt'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    train()</span><br></pre></td></tr></table></figure>
<h3 id="qa-complete-system">Q&amp;A: Complete System</h3>
<p><strong>Q20: How to handle cold start for new users?</strong></p>
<p>A: Use content-based features and popular items as fallback. For new
items, use content features and category-based similarity. Consider
using graph methods (like LONGER) that can propagate information through
the graph.</p>
<p><strong>Q21: How to ensure system reliability?</strong></p>
<p>A: Implement circuit breakers, timeouts, and fallbacks at every
stage. Use health checks and graceful degradation. Monitor error rates
and latency. Have rollback procedures ready. Test failure scenarios
regularly.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Building industrial recommendation systems requires careful attention
to architecture, performance, and operations. The multi-stage pipeline
(recall → coarse ranking → fine ranking → reranking) provides a scalable
framework for handling millions of users and items.</p>
<p>Key takeaways:</p>
<ol type="1">
<li><strong>Multi-channel recall</strong> is essential for diversity and
coverage</li>
<li><strong>Staged ranking</strong> balances accuracy and latency</li>
<li><strong>Feature engineering automation</strong> enables rapid
iteration</li>
<li><strong>A/B testing</strong> ensures data-driven improvements</li>
<li><strong>Performance optimization</strong> is critical for scale</li>
<li><strong>Monitoring and deployment</strong> practices ensure
reliability</li>
</ol>
<p>The frameworks and practices discussed—from EasyRec to
LONGER—represent years of production experience. Adapt them to your
specific use case, and always measure the impact of changes through
rigorous experimentation.</p>
<p>As recommendation systems continue to evolve, new techniques like
graph neural networks, transformer-based models, and reinforcement
learning are pushing the boundaries. However, the fundamental principles
of scalable architecture, careful feature engineering, and rigorous
evaluation remain constant.</p>
<h2 id="references">References</h2>
<ol type="1">
<li>Alibaba EasyRec: <a class="link" target="_blank" rel="noopener" href="https://github.com/alibaba/EasyRec">https://github.com/alibaba/EasyRec<i class="fas fa-external-link-alt"></i></a></li>
<li>Zhou, G., et al. "Deep Interest Network for Click-Through Rate
Prediction." KDD 2018. <a class="link" target="_blank" rel="noopener" href="https://arxiv.org/abs/1706.06978">arXiv:1706.06978<i class="fas fa-external-link-alt"></i></a></li>
<li>Guo, H., et al. "DeepFM: A Factorization-Machine based Neural
Network for CTR Prediction." IJCAI 2017. <a class="link" target="_blank" rel="noopener" href="https://arxiv.org/abs/1703.04247">arXiv:1703.04247<i class="fas fa-external-link-alt"></i></a></li>
<li>Cheng, H., et al. "Wide &amp; Deep Learning for Recommender
Systems." DLRS 2016. <a class="link" target="_blank" rel="noopener" href="https://arxiv.org/abs/1606.07792">arXiv:1606.07792<i class="fas fa-external-link-alt"></i></a></li>
</ol>
<hr>
<p><em>This article is part of a series on recommendation systems. For
more articles, see the <a href="/categories/Recommendation-Systems/">Recommendation Systems
category</a>.</em></p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    
    
    
    
    
    
    <ul>
        <li>Post title：Recommendation Systems (16): Industrial Architecture and Best Practices</li>
        <li>Post author：Chen Kai</li>
        <li>Create time：2025-12-29 00:00:00</li>
        <li>
            Post link：https://www.chenk.top/en/recommendation-systems-16-industrial-practice/
        </li>
        <li>
            Copyright Notice：All articles in this blog are licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en">BY-NC-SA</a> unless stating additionally.
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/en/tags/Recommendation-Systems/">#Recommendation Systems</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/en/tags/Industrial-Practice/">#Industrial Practice</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/en/tags/System-Architecture/">#System Architecture</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/en/recommendation-systems-2-collaborative-filtering/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Recommendation Systems (2): Collaborative Filtering and Matrix Factorization</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/en/recommendation-systems-13-fairness-explainability/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Recommendation Systems (13): Fairness, Debiasing, and Explainability</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'p2Cu9MgjoKzo3VmulhNLIusH-gzGzoHsz',
                    appKey: 'QThQHg3c8sVwGpzg9lu8zEG3',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情赞美帅气伟大的ck吧~',
                    lang: 'en'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Chen Kai';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2026&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Chen Kai</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
            </div>
        
        <div class="theme-info info-item">
            <!-- Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a> -->
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#industrial-recommendation-system-landscape"><span class="nav-number">2.</span> <span class="nav-text">Industrial
Recommendation System Landscape</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#architecture-overview"><span class="nav-number">2.1.</span> <span class="nav-text">Architecture Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key-design-principles"><span class="nav-number">2.2.</span> <span class="nav-text">Key Design Principles</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#multi-channel-recall-design"><span class="nav-number">3.</span> <span class="nav-text">Multi-Channel Recall Design</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#channel-types"><span class="nav-number">3.1.</span> <span class="nav-text">Channel Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#multi-channel-fusion"><span class="nav-number">3.2.</span> <span class="nav-text">Multi-Channel Fusion</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-multi-channel-recall"><span class="nav-number">3.3.</span> <span class="nav-text">Q&amp;A: Multi-Channel Recall</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#coarse-ranking"><span class="nav-number">4.</span> <span class="nav-text">Coarse Ranking</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#lightweight-model-design"><span class="nav-number">4.1.</span> <span class="nav-text">Lightweight Model Design</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-coarse-ranking"><span class="nav-number">4.2.</span> <span class="nav-text">Q&amp;A: Coarse Ranking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fine-ranking"><span class="nav-number">5.</span> <span class="nav-text">Fine Ranking</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#deep-learning-models"><span class="nav-number">5.1.</span> <span class="nav-text">Deep Learning Models</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#feature-engineering-for-fine-ranking"><span class="nav-number">5.2.</span> <span class="nav-text">Feature Engineering for
Fine Ranking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-fine-ranking"><span class="nav-number">5.3.</span> <span class="nav-text">Q&amp;A: Fine Ranking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reranking"><span class="nav-number">6.</span> <span class="nav-text">Reranking</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#diversity-reranking"><span class="nav-number">6.1.</span> <span class="nav-text">Diversity Reranking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#business-rules-reranking"><span class="nav-number">6.2.</span> <span class="nav-text">Business Rules Reranking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#freshness-reranking"><span class="nav-number">6.3.</span> <span class="nav-text">Freshness Reranking</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-reranking"><span class="nav-number">6.4.</span> <span class="nav-text">Q&amp;A: Reranking</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#alibaba-easyrec-framework"><span class="nav-number">7.</span> <span class="nav-text">Alibaba EasyRec Framework</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#architecture-overview-1"><span class="nav-number">7.1.</span> <span class="nav-text">Architecture Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key-components"><span class="nav-number">7.2.</span> <span class="nav-text">Key Components</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easyrec-best-practices"><span class="nav-number">7.3.</span> <span class="nav-text">EasyRec Best Practices</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-easyrec"><span class="nav-number">7.4.</span> <span class="nav-text">Q&amp;A: EasyRec</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bytedance-longer-system"><span class="nav-number">8.</span> <span class="nav-text">ByteDance LONGER System</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#architecture"><span class="nav-number">8.1.</span> <span class="nav-text">Architecture</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#key-innovations"><span class="nav-number">8.2.</span> <span class="nav-text">Key Innovations</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#longer-advantages"><span class="nav-number">8.3.</span> <span class="nav-text">LONGER Advantages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-longer"><span class="nav-number">8.4.</span> <span class="nav-text">Q&amp;A: LONGER</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#feature-engineering-automation"><span class="nav-number">9.</span> <span class="nav-text">Feature Engineering
Automation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#automated-feature-generation"><span class="nav-number">9.1.</span> <span class="nav-text">Automated Feature Generation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#feature-selection"><span class="nav-number">9.2.</span> <span class="nav-text">Feature Selection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#feature-store"><span class="nav-number">9.3.</span> <span class="nav-text">Feature Store</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-feature-engineering"><span class="nav-number">9.4.</span> <span class="nav-text">Q&amp;A: Feature Engineering</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ab-testing-framework"><span class="nav-number">10.</span> <span class="nav-text">A&#x2F;B Testing Framework</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#experiment-design"><span class="nav-number">10.1.</span> <span class="nav-text">Experiment Design</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-ab-testing"><span class="nav-number">10.2.</span> <span class="nav-text">Q&amp;A: A&#x2F;B Testing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#performance-optimization"><span class="nav-number">11.</span> <span class="nav-text">Performance Optimization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#model-optimization"><span class="nav-number">11.1.</span> <span class="nav-text">Model Optimization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#serving-optimization"><span class="nav-number">11.2.</span> <span class="nav-text">Serving Optimization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-performance-optimization"><span class="nav-number">11.3.</span> <span class="nav-text">Q&amp;A: Performance
Optimization</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#deployment-and-monitoring"><span class="nav-number">12.</span> <span class="nav-text">Deployment and Monitoring</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#deployment-pipeline"><span class="nav-number">12.1.</span> <span class="nav-text">Deployment Pipeline</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#monitoring"><span class="nav-number">12.2.</span> <span class="nav-text">Monitoring</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-deployment-and-monitoring"><span class="nav-number">12.3.</span> <span class="nav-text">Q&amp;A: Deployment and
Monitoring</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#complete-project-example"><span class="nav-number">13.</span> <span class="nav-text">Complete Project Example</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#project-structure"><span class="nav-number">13.1.</span> <span class="nav-text">Project Structure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#main-api-server"><span class="nav-number">13.2.</span> <span class="nav-text">Main API Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#complete-predictor"><span class="nav-number">13.3.</span> <span class="nav-text">Complete Predictor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#training-script"><span class="nav-number">13.4.</span> <span class="nav-text">Training Script</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qa-complete-system"><span class="nav-number">13.5.</span> <span class="nav-text">Q&amp;A: Complete System</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#conclusion"><span class="nav-number">14.</span> <span class="nav-text">Conclusion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#references"><span class="nav-number">15.</span> <span class="nav-text">References</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/lang-switch.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
