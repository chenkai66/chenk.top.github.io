<!DOCTYPE html>



<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Chen Kai">
    
    <title>
        
            云计算（七）运维与DevOps实践 |
        
        Chen Kai Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chenk.top","root":"/","language":"zh-CN","default_language":"zh-CN","languages":["zh-CN","en"],"path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Chen Kai Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    
    
    
    
    

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Chen Kai Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    <li class="menu-item lang-switch lang-switch-trigger" title="Language">
                        <i class="fas fa-globe"></i>
                    </li>
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item lang-switch-trigger"><i class="fas fa-globe"></i></div>
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    
    
    
    

    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">云计算（七）运维与DevOps实践</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Chen Kai</span>
                        
                            <span class="author-label">BOSS</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    
    
    
    
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2024-01-29 00:00:00</span>
        <span class="mobile">2024-01-29 00:00</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Cloud-Computing/">Cloud Computing</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">云计算</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/DevOps/">DevOps</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E8%BF%90%E7%BB%B4/">运维</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E7%9B%91%E6%8E%A7/">监控</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/">自动化</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>12.8k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>58 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>云计算的本质是将基础设施抽象化，但抽象不等于消失。当应用部署到云端，运维工作并没有减少，而是发生了根本性的转变：从物理机房的硬件维护，转向了云资源的编排、监控、优化和自动化。DevOps
理念的引入，让开发与运维的边界逐渐模糊，形成了"你构建它，你运行它"的文化。</p>
<p>这篇文章将深入探讨云运维的核心流程、基础设施即代码实践、监控与日志体系、自动化运维、成本优化，以及
SRE
最佳实践。通过实战案例和工具链介绍，帮助读者构建完整的云运维知识体系。</p>
<span id="more"></span>
<h2 id="云运维核心流程与职责">云运维核心流程与职责</h2>
<p>传统运维关注的是服务器、网络、存储等物理资源，而云运维的核心是<strong>资源生命周期管理</strong>和<strong>服务可用性保障</strong>。云运维团队的主要职责包括：</p>
<h3 id="基础设施管理">基础设施管理</h3>
<p>基础设施管理不再是购买服务器、安装操作系统，而是通过云控制台或 API
创建和管理虚拟资源。运维人员需要：</p>
<ul>
<li><strong>资源规划</strong>：根据业务需求选择合适的云服务类型（计算、存储、网络）</li>
<li><strong>资源创建</strong>：通过控制台、CLI 或代码创建和管理资源</li>
<li><strong>配置管理</strong>：确保资源配置符合安全策略和最佳实践</li>
<li><strong>资源回收</strong>：及时清理不再使用的资源，避免成本浪费</li>
</ul>
<h3 id="应用部署与发布">应用部署与发布</h3>
<p>云环境下的应用部署通常采用容器化或 Serverless 架构：</p>
<ul>
<li><strong>容器编排</strong>：使用 Kubernetes、Docker Swarm
等管理容器生命周期</li>
<li><strong>CI/CD 流水线</strong>：自动化构建、测试、部署流程</li>
<li><strong>蓝绿部署/金丝雀发布</strong>：降低发布风险，实现零停机更新</li>
<li><strong>回滚机制</strong>：快速恢复到上一个稳定版本</li>
</ul>
<h3 id="监控与告警">监控与告警</h3>
<p>监控是云运维的眼睛，需要覆盖多个维度：</p>
<ul>
<li><strong>基础设施监控</strong>：CPU、内存、磁盘、网络等资源使用情况</li>
<li><strong>应用监控</strong>：请求量、响应时间、错误率、吞吐量等业务指标</li>
<li><strong>日志监控</strong>：应用日志、系统日志、审计日志的收集与分析</li>
<li><strong>告警管理</strong>：设置合理的告警阈值，避免告警疲劳</li>
</ul>
<h3 id="故障处理与恢复">故障处理与恢复</h3>
<p>云环境下的故障处理需要快速定位和恢复：</p>
<ul>
<li><strong>故障定位</strong>：通过监控、日志、链路追踪快速定位问题根因</li>
<li><strong>应急响应</strong>：建立故障响应流程，明确责任人和处理步骤</li>
<li><strong>自动恢复</strong>：利用云服务的自动恢复能力（如健康检查、自动重启）</li>
<li><strong>事后复盘</strong>：分析故障原因，优化系统架构和流程</li>
</ul>
<h3 id="安全与合规">安全与合规</h3>
<p>云环境的安全责任是共担的：</p>
<ul>
<li><strong>身份与访问管理</strong>：IAM 策略、RBAC、最小权限原则</li>
<li><strong>网络安全</strong>：VPC、安全组、防火墙规则配置</li>
<li><strong>数据安全</strong>：加密传输、加密存储、密钥管理</li>
<li><strong>合规审计</strong>：满足行业合规要求，定期进行安全审计</li>
</ul>
<h2 id="基础设施即代码iac">基础设施即代码（IaC）</h2>
<p>基础设施即代码（Infrastructure as Code,
IaC）是云运维的核心实践。它将基础设施的定义、配置和管理以代码的形式描述，实现版本控制、可重复性和自动化。</p>
<h3 id="terraform">Terraform</h3>
<p>Terraform 是 HashiCorp 开源的 IaC
工具，支持多云平台。它使用声明式语言描述期望的基础设施状态，通过
<code>terraform plan</code> 预览变更，<code>terraform apply</code>
执行变更。</p>
<h4 id="terraform-基础语法">Terraform 基础语法</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"># provider.tf - 配置云服务提供商</span><br><span class="line">terraform &#123;</span><br><span class="line">  required_providers &#123;</span><br><span class="line">    aws = &#123;</span><br><span class="line">      source  = &quot;hashicorp/aws&quot;</span><br><span class="line">      version = &quot;~&gt; 5.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  region = &quot;cn-north-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># vpc.tf - 创建 VPC 网络</span><br><span class="line">resource &quot;aws_vpc&quot; &quot;main&quot; &#123;</span><br><span class="line">  cidr_block           = &quot;10.0.0.0/16&quot;</span><br><span class="line">  enable_dns_hostnames = true</span><br><span class="line">  enable_dns_support   = true</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;production-vpc&quot;</span><br><span class="line">    Environment = &quot;prod&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># subnet.tf - 创建子网</span><br><span class="line">resource &quot;aws_subnet&quot; &quot;public&quot; &#123;</span><br><span class="line">  count             = 2</span><br><span class="line">  vpc_id            = aws_vpc.main.id</span><br><span class="line">  cidr_block        = &quot;10.0.$&#123;count.index + 1&#125;.0/24&quot;</span><br><span class="line">  availability_zone = data.aws_availability_zones.available.names[count.index]</span><br><span class="line"></span><br><span class="line">  map_public_ip_on_launch = true</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;public-subnet-$&#123;count.index + 1&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_subnet&quot; &quot;private&quot; &#123;</span><br><span class="line">  count             = 2</span><br><span class="line">  vpc_id            = aws_vpc.main.id</span><br><span class="line">  cidr_block        = &quot;10.0.$&#123;count.index + 10&#125;.0/24&quot;</span><br><span class="line">  availability_zone = data.aws_availability_zones.available.names[count.index]</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;private-subnet-$&#123;count.index + 1&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># security-group.tf - 安全组配置</span><br><span class="line">resource &quot;aws_security_group&quot; &quot;web&quot; &#123;</span><br><span class="line">  name        = &quot;web-sg&quot;</span><br><span class="line">  description = &quot;Security group for web servers&quot;</span><br><span class="line">  vpc_id      = aws_vpc.main.id</span><br><span class="line"></span><br><span class="line">  ingress &#123;</span><br><span class="line">    description = &quot;HTTP&quot;</span><br><span class="line">    from_port   = 80</span><br><span class="line">    to_port     = 80</span><br><span class="line">    protocol    = &quot;tcp&quot;</span><br><span class="line">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ingress &#123;</span><br><span class="line">    description = &quot;HTTPS&quot;</span><br><span class="line">    from_port   = 443</span><br><span class="line">    to_port     = 443</span><br><span class="line">    protocol    = &quot;tcp&quot;</span><br><span class="line">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  egress &#123;</span><br><span class="line">    from_port   = 0</span><br><span class="line">    to_port     = 0</span><br><span class="line">    protocol    = &quot;-1&quot;</span><br><span class="line">    cidr_blocks = [&quot;0.0.0.0/0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;web-security-group&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># ec2.tf - EC2 实例配置</span><br><span class="line">resource &quot;aws_instance&quot; &quot;web&quot; &#123;</span><br><span class="line">  count                  = 2</span><br><span class="line">  ami                    = data.aws_ami.ubuntu.id</span><br><span class="line">  instance_type          = &quot;t3.medium&quot;</span><br><span class="line">  subnet_id              = aws_subnet.public[count.index].id</span><br><span class="line">  vpc_security_group_ids = [aws_security_group.web.id]</span><br><span class="line"></span><br><span class="line">  user_data = &lt;&lt;-EOF</span><br><span class="line">              #!/bin/bash</span><br><span class="line">              apt-get update</span><br><span class="line">              apt-get install -y nginx</span><br><span class="line">              systemctl start nginx</span><br><span class="line">              systemctl enable nginx</span><br><span class="line">              EOF</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;web-server-$&#123;count.index + 1&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># data.tf - 数据源定义</span><br><span class="line">data &quot;aws_availability_zones&quot; &quot;available&quot; &#123;</span><br><span class="line">  state = &quot;available&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;aws_ami&quot; &quot;ubuntu&quot; &#123;</span><br><span class="line">  most_recent = true</span><br><span class="line">  owners      = [&quot;099720109477&quot;] # Canonical</span><br><span class="line"></span><br><span class="line">  filter &#123;</span><br><span class="line">    name   = &quot;name&quot;</span><br><span class="line">    values = [&quot;ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># output.tf - 输出值</span><br><span class="line">output &quot;vpc_id&quot; &#123;</span><br><span class="line">  value = aws_vpc.main.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;public_subnet_ids&quot; &#123;</span><br><span class="line">  value = aws_subnet.public[*].id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;web_server_ips&quot; &#123;</span><br><span class="line">  value = aws_instance.web[*].public_ip</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="terraform-模块化">Terraform 模块化</h4>
<p>模块化可以提高代码复用性和可维护性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># modules/ec2/main.tf</span><br><span class="line">variable &quot;instance_type&quot; &#123;</span><br><span class="line">  description = &quot;EC2 instance type&quot;</span><br><span class="line">  type        = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;subnet_id&quot; &#123;</span><br><span class="line">  description = &quot;Subnet ID&quot;</span><br><span class="line">  type        = string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;security_group_ids&quot; &#123;</span><br><span class="line">  description = &quot;Security group IDs&quot;</span><br><span class="line">  type        = list(string)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_instance&quot; &quot;this&quot; &#123;</span><br><span class="line">  ami                    = var.ami_id</span><br><span class="line">  instance_type          = var.instance_type</span><br><span class="line">  subnet_id              = var.subnet_id</span><br><span class="line">  vpc_security_group_ids = var.security_group_ids</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &quot;instance_id&quot; &#123;</span><br><span class="line">  value = aws_instance.this.id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># main.tf - 使用模块</span><br><span class="line">module &quot;web_server&quot; &#123;</span><br><span class="line">  source = &quot;./modules/ec2&quot;</span><br><span class="line"></span><br><span class="line">  instance_type      = &quot;t3.medium&quot;</span><br><span class="line">  subnet_id          = aws_subnet.public[0].id</span><br><span class="line">  security_group_ids = [aws_security_group.web.id]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="terraform-状态管理">Terraform 状态管理</h4>
<p>Terraform 状态文件记录了资源的实际状态，需要安全存储：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># backend.tf - 使用 S3 作为后端存储</span><br><span class="line">terraform &#123;</span><br><span class="line">  backend &quot;s3&quot; &#123;</span><br><span class="line">    bucket         = &quot;terraform-state-bucket&quot;</span><br><span class="line">    key            = &quot;production/terraform.tfstate&quot;</span><br><span class="line">    region         = &quot;cn-north-1&quot;</span><br><span class="line">    encrypt        = true</span><br><span class="line">    dynamodb_table = &quot;terraform-state-lock&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ansible">Ansible</h3>
<p>Ansible 是 Red Hat 开源的配置管理工具，使用 YAML 语法描述配置，通过
SSH 执行任务，无需在目标机器安装 agent。</p>
<h4 id="ansible-playbook-示例">Ansible Playbook 示例</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># playbook.yml - 部署 Nginx 服务器</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">web</span> <span class="string">servers</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">become:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">nginx_version:</span> <span class="string">&quot;1.24.0&quot;</span></span><br><span class="line">    <span class="attr">worker_processes:</span> <span class="number">4</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Update</span> <span class="string">apt</span> <span class="string">cache</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">cache_valid_time:</span> <span class="number">3600</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Enable</span> <span class="string">and</span> <span class="string">start</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">systemd:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># inventory.yml - 主机清单</span></span><br><span class="line"><span class="attr">all:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">web_servers:</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">        <span class="attr">web1:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.10</span></span><br><span class="line">        <span class="attr">web2:</span></span><br><span class="line">          <span class="attr">ansible_host:</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">ansible_user:</span> <span class="string">ubuntu</span></span><br><span class="line">        <span class="attr">ansible_ssh_private_key_file:</span> <span class="string">~/.ssh/id_rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx.conf.j2 - Jinja2 模板</span></span><br><span class="line"><span class="string">user</span> <span class="string">www-data;</span></span><br><span class="line"><span class="string">worker_processes</span> &#123;&#123; <span class="string">worker_processes</span> &#125;&#125;<span class="string">;</span></span><br><span class="line"><span class="string">pid</span> <span class="string">/run/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> &#123;</span><br><span class="line">    <span class="string">worker_connections</span> <span class="number">1024</span><span class="string">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">http</span> &#123;</span><br><span class="line">    <span class="string">include</span> <span class="string">/etc/nginx/mime.types;</span></span><br><span class="line">    <span class="string">default_type</span> <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">log_format</span> <span class="string">main</span> <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                    <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">access_log</span> <span class="string">/var/log/nginx/access.log</span> <span class="string">main;</span></span><br><span class="line">    <span class="string">error_log</span> <span class="string">/var/log/nginx/error.log;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sendfile</span> <span class="string">on;</span></span><br><span class="line">    <span class="string">tcp_nopush</span> <span class="string">on;</span></span><br><span class="line">    <span class="string">tcp_nodelay</span> <span class="string">on;</span></span><br><span class="line">    <span class="string">keepalive_timeout</span> <span class="number">65</span><span class="string">;</span></span><br><span class="line">    <span class="string">types_hash_max_size</span> <span class="number">2048</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">server</span> &#123;</span><br><span class="line">        <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">        <span class="string">server_name</span> <span class="string">_;</span></span><br><span class="line"></span><br><span class="line">        <span class="string">location</span> <span class="string">/</span> &#123;</span><br><span class="line">            <span class="string">proxy_pass</span> <span class="string">http://backend;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">Host</span> <span class="string">$host;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Real-IP</span> <span class="string">$remote_addr;</span></span><br><span class="line">            <span class="string">proxy_set_header</span> <span class="string">X-Forwarded-For</span> <span class="string">$proxy_add_x_forwarded_for;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ansible-roles">Ansible Roles</h4>
<p>Roles 用于组织复杂的 Playbook：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># roles/nginx/tasks/main.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">nginx.conf.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Start</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">systemd:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># site.yml - 使用 Role</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web_servers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">role:</span> <span class="string">monitoring</span>, <span class="attr">tags:</span> [<span class="string">&#x27;monitoring&#x27;</span>] &#125;</span><br></pre></td></tr></table></figure>
<h3 id="aws-cloudformation">AWS CloudFormation</h3>
<p>CloudFormation 是 AWS 原生的 IaC 工具，使用 JSON 或 YAML 格式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cloudformation-template.yml</span></span><br><span class="line"><span class="attr">AWSTemplateFormatVersion:</span> <span class="string">&#x27;2010-09-09&#x27;</span></span><br><span class="line"><span class="attr">Description:</span> <span class="string">&#x27;Web application infrastructure&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Parameters:</span></span><br><span class="line">  <span class="attr">InstanceType:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">String</span></span><br><span class="line">    <span class="attr">Default:</span> <span class="string">t3.medium</span></span><br><span class="line">    <span class="attr">AllowedValues:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">t3.small</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">t3.medium</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">t3.large</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Resources:</span></span><br><span class="line">  <span class="attr">VPC:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::VPC</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span></span><br><span class="line">      <span class="attr">EnableDnsHostnames:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">Tags:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">Key:</span> <span class="string">Name</span></span><br><span class="line">          <span class="attr">Value:</span> <span class="string">ProductionVPC</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">PublicSubnet:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Subnet</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line">      <span class="attr">CidrBlock:</span> <span class="number">10.0</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line">      <span class="attr">AvailabilityZone:</span> <span class="type">!Select</span> [<span class="number">0</span>, <span class="type">!GetAZs</span> <span class="string">&#x27;&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="attr">WebServer:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::Instance</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">ImageId:</span> <span class="string">ami-0c55b159cbfafe1f0</span></span><br><span class="line">      <span class="attr">InstanceType:</span> <span class="type">!Ref</span> <span class="string">InstanceType</span></span><br><span class="line">      <span class="attr">SubnetId:</span> <span class="type">!Ref</span> <span class="string">PublicSubnet</span></span><br><span class="line">      <span class="attr">SecurityGroupIds:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="type">!Ref</span> <span class="string">WebSecurityGroup</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">WebSecurityGroup:</span></span><br><span class="line">    <span class="attr">Type:</span> <span class="string">AWS::EC2::SecurityGroup</span></span><br><span class="line">    <span class="attr">Properties:</span></span><br><span class="line">      <span class="attr">GroupDescription:</span> <span class="string">Security</span> <span class="string">group</span> <span class="string">for</span> <span class="string">web</span> <span class="string">servers</span></span><br><span class="line">      <span class="attr">VpcId:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line">      <span class="attr">SecurityGroupIngress:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">          <span class="attr">FromPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">ToPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">IpProtocol:</span> <span class="string">tcp</span></span><br><span class="line">          <span class="attr">FromPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">ToPort:</span> <span class="number">443</span></span><br><span class="line">          <span class="attr">CidrIp:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Outputs:</span></span><br><span class="line">  <span class="attr">VPCId:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">VPC</span> <span class="string">ID</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!Ref</span> <span class="string">VPC</span></span><br><span class="line">    <span class="attr">Export:</span></span><br><span class="line">      <span class="attr">Name:</span> <span class="type">!Sub</span> <span class="string">&#x27;$&#123;AWS::StackName&#125;-VPCId&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">WebServerIP:</span></span><br><span class="line">    <span class="attr">Description:</span> <span class="string">Web</span> <span class="string">server</span> <span class="string">public</span> <span class="string">IP</span></span><br><span class="line">    <span class="attr">Value:</span> <span class="type">!GetAtt</span> <span class="string">WebServer.PublicIp</span></span><br></pre></td></tr></table></figure>
<h3 id="iac-最佳实践">IaC 最佳实践</h3>
<ol type="1">
<li><strong>版本控制</strong>：所有 IaC 代码纳入 Git
管理，使用分支策略</li>
<li><strong>代码审查</strong>：通过 Pull Request 审查基础设施变更</li>
<li><strong>环境隔离</strong>：开发、测试、生产环境使用独立的配置和状态</li>
<li><strong>状态锁定</strong>：使用 DynamoDB、Consul
等实现状态文件锁定</li>
<li><strong>变更预览</strong>：执行变更前先预览，确认无误后再应用</li>
<li><strong>回滚计划</strong>：保留历史状态，支持快速回滚</li>
<li><strong>文档化</strong>：为每个模块和资源添加清晰的注释和文档</li>
</ol>
<h2 id="监控体系">监控体系</h2>
<p>监控是云运维的基石，需要建立多层次的监控体系，覆盖基础设施、应用、业务等各个层面。</p>
<h3 id="prometheus">Prometheus</h3>
<p>Prometheus 是 CNCF 毕业的开源监控系统，采用拉取模式收集指标，使用
PromQL 查询语言。</p>
<h4 id="prometheus-配置">Prometheus 配置</h4>
<p><strong>问题背景</strong>：
Prometheus采用拉取（Pull）模式收集指标，需要配置抓取目标（scrape
targets）和告警规则。在Kubernetes环境中，Pod是动态创建和销毁的，需要自动发现监控目标。合理的Prometheus配置可以确保指标收集的完整性和告警的及时性。</p>
<p><strong>解决思路</strong>： -
全局配置：设置统一的抓取间隔和评估间隔，平衡数据精度和资源消耗 -
服务发现：使用Kubernetes服务发现自动发现Pod，无需手动配置目标列表 -
标签重写：使用relabel_configs重写标签，统一指标格式，便于查询和告警 -
告警集成：配置Alertmanager地址，将告警规则评估结果发送到告警管理器</p>
<p><strong>设计考虑</strong>： -
抓取间隔：较短的间隔（15s）提供更实时数据，但增加Prometheus负载；建议根据指标重要性调整
-
外部标签：为所有指标添加外部标签（如cluster、environment），便于多集群管理
- 服务发现：Kubernetes服务发现自动发现Pod，通过Pod注解控制是否抓取 -
安全配置：访问Kubernetes API需要TLS证书和Bearer Token</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># prometheus.yml</span></span><br><span class="line"><span class="comment"># Prometheus主配置文件</span></span><br><span class="line"><span class="comment"># 用途：配置指标抓取目标、告警规则和Alertmanager集成</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置：应用于所有抓取作业的默认设置</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="comment"># 抓取间隔：Prometheus从目标抓取指标的频率</span></span><br><span class="line">  <span class="comment"># 15秒：平衡数据精度和Prometheus负载</span></span><br><span class="line">  <span class="comment"># 注意：可以在每个job中覆盖此设置</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 评估间隔：Prometheus评估告警规则的频率</span></span><br><span class="line">  <span class="comment"># 应与scrape_interval相同或略大，确保有足够数据评估告警</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 外部标签：添加到所有时间序列的标签</span></span><br><span class="line">  <span class="comment"># 用途：在多集群环境中标识数据来源，便于数据聚合和查询</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">&#x27;production&#x27;</span>      <span class="comment"># 集群标识</span></span><br><span class="line">    <span class="attr">environment:</span> <span class="string">&#x27;prod&#x27;</span>        <span class="comment"># 环境标识</span></span><br><span class="line">    <span class="comment"># 可以添加更多标签，如region、team等</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 告警规则文件：定义告警条件和通知内容</span></span><br><span class="line"><span class="comment"># 注意：文件路径相对于Prometheus配置文件所在目录</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;alert_rules.yml&quot;</span></span><br><span class="line">  <span class="comment"># 可以包含多个规则文件，按功能分类</span></span><br><span class="line">  <span class="comment"># - &quot;infrastructure_alerts.yml&quot;</span></span><br><span class="line">  <span class="comment"># - &quot;application_alerts.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取配置：定义Prometheus从哪里抓取指标</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Job 1: Prometheus自身监控</span></span><br><span class="line">  <span class="comment"># 用途：监控Prometheus自身的性能指标</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">    <span class="comment"># 静态配置：手动指定目标列表</span></span><br><span class="line">    <span class="comment"># 适用场景：固定IP/域名的服务</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;localhost:9090&#x27;</span>]</span><br><span class="line">        <span class="comment"># 可以添加标签，用于区分不同实例</span></span><br><span class="line">        <span class="comment"># labels:</span></span><br><span class="line">        <span class="comment">#   instance: &#x27;prometheus-1&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Job 2: Node Exporter监控</span></span><br><span class="line">  <span class="comment"># 用途：监控节点（服务器）的基础设施指标（CPU、内存、磁盘等）</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;node-exporter&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;node-exporter:9100&#x27;</span>]</span><br><span class="line">        <span class="comment"># 可以监控多个节点</span></span><br><span class="line">        <span class="comment"># - targets: [&#x27;node-exporter-1:9100&#x27;, &#x27;node-exporter-2:9100&#x27;]</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Job 3: Kubernetes Pod自动发现</span></span><br><span class="line">  <span class="comment"># 用途：自动发现Kubernetes集群中的Pod，抓取应用指标</span></span><br><span class="line">  <span class="comment"># 优势：无需手动配置，自动适应Pod创建和销毁</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-pods&#x27;</span></span><br><span class="line">    <span class="comment"># Kubernetes服务发现配置</span></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span>  <span class="comment"># 发现Pod资源</span></span><br><span class="line">        <span class="comment"># 可选：限制命名空间</span></span><br><span class="line">        <span class="comment"># namespaces:</span></span><br><span class="line">        <span class="comment">#   names:</span></span><br><span class="line">        <span class="comment">#     - production</span></span><br><span class="line">        <span class="comment">#     - staging</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 标签重写配置：修改或过滤发现的targets</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="comment"># 规则1：只抓取带有prometheus.io/scrape=true注解的Pod</span></span><br><span class="line">      <span class="comment"># 用途：选择性监控，避免抓取所有Pod</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span>  <span class="comment"># 保留匹配的targets</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span>    <span class="comment"># 匹配值为true的注解</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 规则2：使用Pod注解指定metrics路径</span></span><br><span class="line">      <span class="comment"># 用途：支持自定义metrics端点路径</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span>  <span class="comment"># Prometheus内置标签</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span>  <span class="comment"># 匹配任何非空值</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 规则3：使用Pod注解指定metrics端口</span></span><br><span class="line">      <span class="comment"># 用途：支持非标准端口（默认9090）</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span>  <span class="comment"># 提取IP和端口</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span>              <span class="comment"># 组合为IP:Port格式</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 可选：添加自定义标签，便于查询和告警</span></span><br><span class="line">      <span class="comment"># - source_labels: [__meta_kubernetes_pod_name]</span></span><br><span class="line">      <span class="comment">#   target_label: pod_name</span></span><br><span class="line">      <span class="comment"># - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line">      <span class="comment">#   target_label: namespace</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Job 4: Kubernetes API Server监控</span></span><br><span class="line">  <span class="comment"># 用途：监控Kubernetes API Server的性能指标</span></span><br><span class="line">  <span class="comment"># 安全：需要ServiceAccount权限和TLS配置</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;kubernetes-apiservers&#x27;</span></span><br><span class="line">    <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span>  <span class="comment"># 发现Endpoints资源</span></span><br><span class="line">    <span class="comment"># HTTPS配置：API Server使用HTTPS</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">tls_config:</span></span><br><span class="line">      <span class="comment"># CA证书：验证API Server证书</span></span><br><span class="line">      <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">    <span class="comment"># Bearer Token：用于API Server认证</span></span><br><span class="line">    <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="comment"># 只监控default命名空间的kubernetes服务</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>, <span class="string">__meta_kubernetes_service_name</span>, <span class="string">__meta_kubernetes_endpoint_port_name</span>]</span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 告警配置：配置Alertmanager地址</span></span><br><span class="line"><span class="comment"># 用途：将触发的告警发送到Alertmanager进行路由和通知</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">&#x27;alertmanager:9093&#x27;</span></span><br><span class="line">          <span class="comment"># 可以配置多个Alertmanager实现高可用</span></span><br><span class="line">          <span class="comment"># - &#x27;alertmanager-1:9093&#x27;</span></span><br><span class="line">          <span class="comment"># - &#x27;alertmanager-2:9093&#x27;</span></span><br></pre></td></tr></table></figure>
<p><strong>关键点解读</strong>： -
<strong>服务发现机制</strong>：Kubernetes服务发现自动发现Pod，通过Pod注解（<code>prometheus.io/scrape</code>）控制是否抓取，实现零配置监控
-
<strong>标签重写</strong>：relabel_configs在抓取前修改target标签，可以过滤、重命名、添加标签，统一指标格式
-
<strong>抓取间隔</strong>：较短的间隔提供更实时数据，但增加Prometheus和网络负载；建议关键指标15s，非关键指标30s-60s
-
<strong>外部标签</strong>：添加到所有时间序列，便于在多集群环境中聚合和查询数据</p>
<p><strong>设计权衡</strong>： - <strong>抓取频率 vs
资源消耗</strong>：更频繁的抓取提供更实时数据，但增加Prometheus
CPU和存储消耗；建议根据指标重要性调整 - <strong>服务发现 vs
静态配置</strong>：服务发现自动适应变化但配置复杂，静态配置简单但需要手动维护；建议混合使用
- <strong>标签数量 vs
查询性能</strong>：更多标签提供更细粒度查询，但增加存储和查询开销；建议只添加必要的标签</p>
<p><strong>常见问题</strong>： - <strong>Q:
如何只监控特定命名空间的Pod？</strong> A:
在kubernetes_sd_configs中添加namespaces配置，或在relabel_configs中过滤 -
<strong>Q: Pod注解的格式是什么？</strong> A:
<code>prometheus.io/scrape: "true"</code>、<code>prometheus.io/port: "8080"</code>、<code>prometheus.io/path: "/metrics"</code>
- <strong>Q: 如何减少Prometheus存储占用？</strong> A:
增加抓取间隔、减少保留时间、使用记录规则预聚合指标</p>
<p><strong>生产实践</strong>： -
使用ConfigMap管理Prometheus配置，实现配置版本控制和自动化部署 -
为不同环境（生产、测试）使用不同的外部标签，便于数据隔离和查询 -
定期审查抓取配置，移除不再使用的job，优化Prometheus性能 - 使用Prometheus
Operator简化Kubernetes环境下的Prometheus管理 -
配置合理的保留时间（retention），平衡存储成本和历史数据需求 -
使用记录规则（recording rules）预聚合常用查询，提高查询性能 -
监控Prometheus自身指标（如<code>prometheus_target_scrapes_exceeded_sample_limit_total</code>），及时发现配置问题</p>
<h4 id="prometheus-告警规则">Prometheus 告警规则</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># alert_rules.yml</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">infrastructure</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighCPUUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="number">100</span> <span class="bullet">-</span> <span class="string">(avg</span> <span class="string">by(instance)</span> <span class="string">(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m]))</span> <span class="string">*</span> <span class="number">100</span><span class="string">)</span> <span class="string">&gt;</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High CPU usage detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;CPU usage is above 80% for <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighMemoryUsage</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(1</span> <span class="bullet">-</span> <span class="string">(node_memory_MemAvailable_bytes</span> <span class="string">/</span> <span class="string">node_memory_MemTotal_bytes))</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">85</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High memory usage detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Memory usage is above 85% for <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">DiskSpaceLow</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">(node_filesystem_avail_bytes&#123;mountpoint=&quot;/&quot;&#125;</span> <span class="string">/</span> <span class="string">node_filesystem_size_bytes&#123;mountpoint=&quot;/&quot;&#125;)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&lt;</span> <span class="number">15</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;Disk space is running low&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Disk space is below 15% for <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">application</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighErrorRate</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">rate(http_requests_total&#123;status=~&quot;5..&quot;&#125;[5m])</span> <span class="string">/</span> <span class="string">rate(http_requests_total[5m])</span> <span class="string">&gt;</span> <span class="number">0.05</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High error rate detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Error rate is above 5% for <span class="template-variable">&#123;&#123; $labels.service &#125;&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">HighLatency</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">histogram_quantile(0.95,</span> <span class="string">rate(http_request_duration_seconds_bucket[5m]))</span> <span class="string">&gt;</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">warning</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;High latency detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;95th percentile latency is above 1s for <span class="template-variable">&#123;&#123; $labels.service &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="promql-查询示例">PromQL 查询示例</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># CPU 使用率</span><br><span class="line">100 - (avg by(instance) (irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) * 100)</span><br><span class="line"></span><br><span class="line"># 内存使用率</span><br><span class="line">(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100</span><br><span class="line"></span><br><span class="line"># HTTP 请求 QPS</span><br><span class="line">sum(rate(http_requests_total[5m])) by (service)</span><br><span class="line"></span><br><span class="line"># 错误率</span><br><span class="line">sum(rate(http_requests_total&#123;status=~&quot;5..&quot;&#125;[5m])) by (service) / sum(rate(http_requests_total[5m])) by (service)</span><br><span class="line"></span><br><span class="line"># P95 延迟</span><br><span class="line">histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service))</span><br></pre></td></tr></table></figure>
<h3 id="grafana">Grafana</h3>
<p>Grafana
是开源的可视化平台，支持多种数据源，提供丰富的图表类型和告警功能。</p>
<h4 id="grafana-dashboard-json-示例">Grafana Dashboard JSON 示例</h4>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;dashboard&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Infrastructure Monitoring&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;panels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;CPU Usage&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;100 - (avg by(instance) (irate(node_cpu_seconds_total&#123;mode=\&quot;idle\&quot;&#125;[5m])) * 100)&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;instance&#125;&#125;&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;percent&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Memory Usage&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;instance&#125;&#125;&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;percent&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;max&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;min&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HTTP Request Rate&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;graph&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;targets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;expr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sum(rate(http_requests_total[5m])) by (service)&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;legendFormat&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;&#123;service&#125;&#125;&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;yaxes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span> <span class="string">&quot;reqps&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="云监控服务">云监控服务</h3>
<p>各大云厂商都提供了原生的监控服务：</p>
<h4 id="aws-cloudwatch">AWS CloudWatch</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 CloudWatch 告警</span></span><br><span class="line">aws cloudwatch put-metric-alarm \</span><br><span class="line">  --alarm-name high-cpu-usage \</span><br><span class="line">  --alarm-description <span class="string">&quot;Alert when CPU exceeds 80%&quot;</span> \</span><br><span class="line">  --metric-name CPUUtilization \</span><br><span class="line">  --namespace AWS/EC2 \</span><br><span class="line">  --statistic Average \</span><br><span class="line">  --period 300 \</span><br><span class="line">  --threshold 80 \</span><br><span class="line">  --comparison-operator GreaterThanThreshold \</span><br><span class="line">  --evaluation-periods 2 \</span><br><span class="line">  --alarm-actions arn:aws:sns:cn-north-1:123456789012:alerts-topic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送自定义指标</span></span><br><span class="line">aws cloudwatch put-metric-data \</span><br><span class="line">  --namespace MyApp \</span><br><span class="line">  --metric-name RequestCount \</span><br><span class="line">  --value 100 \</span><br><span class="line">  --unit Count</span><br></pre></td></tr></table></figure>
<h4 id="阿里云云监控">阿里云云监控</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python SDK 发送自定义指标</span></span><br><span class="line"><span class="keyword">from</span> aliyunsdkcore.client <span class="keyword">import</span> AcsClient</span><br><span class="line"><span class="keyword">from</span> aliyunsdkcms.request.v20190101 <span class="keyword">import</span> PutCustomMetricRequest</span><br><span class="line"></span><br><span class="line">client = AcsClient(<span class="string">&#x27;your-access-key-id&#x27;</span>, <span class="string">&#x27;your-access-key-secret&#x27;</span>, <span class="string">&#x27;cn-hangzhou&#x27;</span>)</span><br><span class="line"></span><br><span class="line">request = PutCustomMetricRequest.PutCustomMetricRequest()</span><br><span class="line">request.set_MetricList([</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;MetricName&quot;</span>: <span class="string">&quot;RequestCount&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Value&quot;</span>: <span class="string">&quot;100&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Unit&quot;</span>: <span class="string">&quot;Count&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Dimensions&quot;</span>: <span class="string">&quot;&#123;\&quot;service\&quot;:\&quot;api\&quot;&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">response = client.do_action_with_exception(request)</span><br></pre></td></tr></table></figure>
<h3 id="监控最佳实践">监控最佳实践</h3>
<ol type="1">
<li><strong>分层监控</strong>：基础设施层、应用层、业务层分别监控</li>
<li><strong>指标选择</strong>：关注关键指标（黄金信号：延迟、流量、错误、饱和度）</li>
<li><strong>告警收敛</strong>：避免告警风暴，使用告警分组和抑制规则</li>
<li><strong>SLO 驱动</strong>：基于 SLO 设置告警阈值</li>
<li><strong>可观测性</strong>：指标、日志、链路追踪三位一体</li>
<li><strong>成本控制</strong>：合理设置指标保留期，避免存储成本过高</li>
</ol>
<h2 id="日志管理">日志管理</h2>
<p>日志是故障排查和审计的重要依据。云环境下的日志管理需要解决收集、存储、检索和分析等问题。</p>
<h3 id="elk-stack">ELK Stack</h3>
<p>ELK
Stack（Elasticsearch、Logstash、Kibana）是经典的日志管理方案。</p>
<h4 id="logstash-配置">Logstash 配置</h4>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># logstash.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">&quot;/var/log/nginx/access.log&quot;</span></span><br><span class="line">    type =&gt; <span class="string">&quot;nginx-access&quot;</span></span><br><span class="line">    start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">&quot;/var/log/nginx/error.log&quot;</span></span><br><span class="line">    type =&gt; <span class="string">&quot;nginx-error&quot;</span></span><br><span class="line">    start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; <span class="number">5044</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  <span class="keyword">if</span> [type] == <span class="string">&quot;nginx-access&quot;</span> &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      match =&gt; &#123; <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    geoip &#123;</span><br><span class="line">      source =&gt; <span class="string">&quot;clientip&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> [type] == <span class="string">&quot;nginx-error&quot;</span> &#123;</span><br><span class="line">    grok &#123;</span><br><span class="line">      match =&gt; &#123; <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;(?&lt;timestamp&gt;\d&#123;4&#125;/\d&#123;2&#125;/\d&#123;2&#125; \d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;) \[%&#123;LOGLEVEL:severity&#125;\] %&#123;GREEDYDATA:message&#125;&quot;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">&quot;elasticsearch:9200&quot;</span>]</span><br><span class="line">    index =&gt; <span class="string">&quot;logs-%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="filebeat-配置">Filebeat 配置</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filebeat.yml</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/log/app/*.log</span></span><br><span class="line">    <span class="attr">fields:</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">api-server</span></span><br><span class="line">      <span class="attr">environment:</span> <span class="string">production</span></span><br><span class="line">    <span class="attr">fields_under_root:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">multiline.pattern:</span> <span class="string">&#x27;^\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125;&#x27;</span></span><br><span class="line">    <span class="attr">multiline.negate:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;/var/lib/docker/containers/*/*.log&#x27;</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_docker_metadata:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">&quot;unix:///var/run/docker.sock&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_host_metadata:</span></span><br><span class="line">      <span class="attr">when.not.contains.tags:</span> <span class="string">forwarded</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span> <span class="string">~</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;logstash:5044&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">logging.level:</span> <span class="string">info</span></span><br><span class="line"><span class="attr">logging.to_files:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">logging.files:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/var/log/filebeat</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">keepfiles:</span> <span class="number">7</span></span><br><span class="line">  <span class="attr">permissions:</span> <span class="number">0644</span></span><br></pre></td></tr></table></figure>
<h4 id="elasticsearch-索引模板">Elasticsearch 索引模板</h4>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;index_patterns&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;logs-*&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;template&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index.lifecycle.name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logs-policy&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;index.lifecycle.rollover_alias&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logs&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@timestamp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;date&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;standard&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;service&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keyword&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ip&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="云日志服务">云日志服务</h3>
<h4 id="aws-cloudwatch-logs">AWS CloudWatch Logs</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建日志组</span></span><br><span class="line">aws logs create-log-group --log-group-name /aws/ec2/myapp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送日志</span></span><br><span class="line">aws logs put-log-events \</span><br><span class="line">  --log-group-name /aws/ec2/myapp \</span><br><span class="line">  --log-stream-name stream1 \</span><br><span class="line">  --log-events timestamp=1234567890000,message=<span class="string">&quot;Log message&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询日志</span></span><br><span class="line">aws logs filter-log-events \</span><br><span class="line">  --log-group-name /aws/ec2/myapp \</span><br><span class="line">  --filter-pattern <span class="string">&quot;ERROR&quot;</span> \</span><br><span class="line">  --start-time 1234567890000</span><br></pre></td></tr></table></figure>
<h4 id="阿里云日志服务sls">阿里云日志服务（SLS）</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python SDK 发送日志</span></span><br><span class="line"><span class="keyword">from</span> aliyun.log <span class="keyword">import</span> LogClient</span><br><span class="line"><span class="keyword">from</span> aliyun.log.putlogsrequest <span class="keyword">import</span> PutLogsRequest</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">client = LogClient(<span class="string">&#x27;cn-hangzhou&#x27;</span>, <span class="string">&#x27;your-access-key-id&#x27;</span>, <span class="string">&#x27;your-access-key-secret&#x27;</span>)</span><br><span class="line"></span><br><span class="line">log_group = &#123;</span><br><span class="line">    <span class="string">&#x27;loggroup&#x27;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&#x27;logs&#x27;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;time&#x27;</span>: <span class="built_in">int</span>(time.time()),</span><br><span class="line">                    <span class="string">&#x27;contents&#x27;</span>: [</span><br><span class="line">                        &#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;level&#x27;</span>, <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;INFO&#x27;</span>&#125;,</span><br><span class="line">                        &#123;<span class="string">&#x27;key&#x27;</span>: <span class="string">&#x27;message&#x27;</span>, <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;Application started&#x27;</span>&#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">request = PutLogsRequest(</span><br><span class="line">    project=<span class="string">&#x27;my-project&#x27;</span>,</span><br><span class="line">    logstore=<span class="string">&#x27;my-logstore&#x27;</span>,</span><br><span class="line">    topic=<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    source=<span class="string">&#x27;api-server&#x27;</span>,</span><br><span class="line">    logitems=log_group[<span class="string">&#x27;loggroup&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;logs&#x27;</span>]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">response = client.put_logs(request)</span><br></pre></td></tr></table></figure>
<h3 id="日志分析实践">日志分析实践</h3>
<h4 id="日志查询示例">日志查询示例</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Elasticsearch Query DSL</span></span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;level&quot;: &quot;ERROR&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;@timestamp&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: &quot;now-1h&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;errors_by_service&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;service.keyword&quot;,</span><br><span class="line">        &quot;size&quot;: <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="日志告警规则">日志告警规则</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ElastAlert 规则</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">High</span> <span class="string">Error</span> <span class="string">Rate</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">frequency</span></span><br><span class="line"><span class="attr">index:</span> <span class="string">logs-*</span></span><br><span class="line"><span class="attr">num_events:</span> <span class="number">100</span></span><br><span class="line"><span class="attr">timeframe:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">filter:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">term:</span></span><br><span class="line">      <span class="attr">level:</span> <span class="string">&quot;ERROR&quot;</span></span><br><span class="line"><span class="attr">alert:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;email&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;slack&quot;</span></span><br><span class="line"><span class="attr">email:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;ops@example.com&quot;</span></span><br><span class="line"><span class="attr">slack:</span></span><br><span class="line">  <span class="attr">slack_webhook_url:</span> <span class="string">&quot;https://hooks.slack.com/services/...&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="日志管理最佳实践">日志管理最佳实践</h3>
<ol type="1">
<li><strong>结构化日志</strong>：使用 JSON 格式，便于解析和查询</li>
<li><strong>日志级别</strong>：合理使用 DEBUG、INFO、WARN、ERROR</li>
<li><strong>敏感信息</strong>：避免记录密码、token 等敏感信息</li>
<li><strong>日志轮转</strong>：设置合理的保留策略，控制存储成本</li>
<li><strong>集中收集</strong>：统一收集所有服务的日志，便于关联分析</li>
<li><strong>实时监控</strong>：对错误日志设置实时告警</li>
</ol>
<h2 id="apm-应用性能监控">APM 应用性能监控</h2>
<p>APM（Application Performance
Monitoring）专注于应用层面的性能监控，帮助定位性能瓶颈和优化点。</p>
<h3 id="apm-核心指标">APM 核心指标</h3>
<ul>
<li><strong>响应时间</strong>：请求从发起到收到响应的时间</li>
<li><strong>吞吐量</strong>：单位时间内处理的请求数</li>
<li><strong>错误率</strong>：失败请求占总请求的比例</li>
<li><strong>资源使用</strong>：CPU、内存、数据库连接等资源消耗</li>
<li><strong>依赖调用</strong>：外部服务、数据库、缓存等调用情况</li>
</ul>
<h3 id="分布式追踪">分布式追踪</h3>
<p>分布式追踪用于跟踪请求在微服务架构中的完整路径。</p>
<h4 id="opentelemetry-集成">OpenTelemetry 集成</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Python 应用集成 OpenTelemetry</span></span><br><span class="line"><span class="keyword">from</span> opentelemetry <span class="keyword">import</span> trace</span><br><span class="line"><span class="keyword">from</span> opentelemetry.sdk.trace <span class="keyword">import</span> TracerProvider</span><br><span class="line"><span class="keyword">from</span> opentelemetry.sdk.trace.export <span class="keyword">import</span> BatchSpanProcessor</span><br><span class="line"><span class="keyword">from</span> opentelemetry.exporter.jaeger.thrift <span class="keyword">import</span> JaegerExporter</span><br><span class="line"><span class="keyword">from</span> opentelemetry.instrumentation.flask <span class="keyword">import</span> FlaskInstrumentor</span><br><span class="line"><span class="keyword">from</span> opentelemetry.instrumentation.requests <span class="keyword">import</span> RequestsInstrumentor</span><br><span class="line"></span><br><span class="line">trace.set_tracer_provider(TracerProvider())</span><br><span class="line">tracer = trace.get_tracer(__name__)</span><br><span class="line"></span><br><span class="line">jaeger_exporter = JaegerExporter(</span><br><span class="line">    agent_host_name=<span class="string">&quot;jaeger&quot;</span>,</span><br><span class="line">    agent_port=<span class="number">6831</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">span_processor = BatchSpanProcessor(jaeger_exporter)</span><br><span class="line">trace.get_tracer_provider().add_span_processor(span_processor)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自动注入 Flask 和 Requests</span></span><br><span class="line">FlaskInstrumentor().instrument_app(app)</span><br><span class="line">RequestsInstrumentor().instrument()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动创建 Span</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_order</span>(<span class="params">order_id</span>):</span><br><span class="line">    <span class="keyword">with</span> tracer.start_as_current_span(<span class="string">&quot;process_order&quot;</span>) <span class="keyword">as</span> span:</span><br><span class="line">        span.set_attribute(<span class="string">&quot;order.id&quot;</span>, order_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 调用外部服务</span></span><br><span class="line">        <span class="keyword">with</span> tracer.start_as_current_span(<span class="string">&quot;payment_service&quot;</span>) <span class="keyword">as</span> payment_span:</span><br><span class="line">            payment_span.set_attribute(<span class="string">&quot;payment.amount&quot;</span>, <span class="number">100.0</span>)</span><br><span class="line">            <span class="comment"># 调用支付服务</span></span><br><span class="line">            result = call_payment_service(order_id)</span><br><span class="line">            payment_span.set_status(trace.Status(trace.StatusCode.OK))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<h4 id="jaeger-配置">Jaeger 配置</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jaeger:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">jaegertracing/all-in-one:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;16686:16686&quot;</span>  <span class="comment"># UI</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6831:6831/udp&quot;</span>  <span class="comment"># Agent</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6832:6832/udp&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;14268:14268&quot;</span>  <span class="comment"># Collector HTTP</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">COLLECTOR_ZIPKIN_HTTP_PORT=9411</span></span><br></pre></td></tr></table></figure>
<h3 id="apm-工具">APM 工具</h3>
<h4 id="new-relic">New Relic</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># New Relic Python Agent</span></span><br><span class="line"><span class="keyword">import</span> newrelic.agent</span><br><span class="line"></span><br><span class="line">newrelic.agent.initialize(<span class="string">&#x27;newrelic.ini&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@newrelic.agent.function_trace()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">expensive_operation</span>():</span><br><span class="line">    <span class="comment"># 业务逻辑</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义指标</span></span><br><span class="line">newrelic.agent.record_custom_metric(<span class="string">&#x27;Custom/OrderCount&#x27;</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义事件</span></span><br><span class="line">newrelic.agent.record_custom_event(<span class="string">&#x27;OrderCreated&#x27;</span>, &#123;</span><br><span class="line">    <span class="string">&#x27;order_id&#x27;</span>: <span class="string">&#x27;12345&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;amount&#x27;</span>: <span class="number">99.99</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="datadog-apm">Datadog APM</h4>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Datadog Python APM</span></span><br><span class="line"><span class="keyword">from</span> ddtrace <span class="keyword">import</span> patch_all</span><br><span class="line">patch_all()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/api/orders&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_orders</span>():</span><br><span class="line">    <span class="comment"># 自动追踪</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&#x27;orders&#x27;</span>: []&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义 Span</span></span><br><span class="line"><span class="keyword">from</span> ddtrace <span class="keyword">import</span> tracer</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tracer.trace(<span class="string">&quot;custom.operation&quot;</span>) <span class="keyword">as</span> span:</span><br><span class="line">    span.set_tag(<span class="string">&quot;order.id&quot;</span>, <span class="string">&quot;12345&quot;</span>)</span><br><span class="line">    <span class="comment"># 业务逻辑</span></span><br></pre></td></tr></table></figure>
<h3 id="apm-最佳实践">APM 最佳实践</h3>
<ol type="1">
<li><strong>采样策略</strong>：合理设置采样率，平衡监控覆盖和性能开销</li>
<li><strong>关键路径追踪</strong>：重点监控核心业务流程</li>
<li><strong>异常捕获</strong>：自动捕获和上报异常信息</li>
<li><strong>性能基线</strong>：建立性能基线，及时发现性能退化</li>
<li><strong>依赖分析</strong>：识别慢依赖，优化调用链</li>
</ol>
<h2 id="自动化运维实践">自动化运维实践</h2>
<p>自动化是 DevOps
的核心，通过自动化减少人工操作，提高效率和可靠性。</p>
<h3 id="自动化部署脚本">自动化部署脚本</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># deploy.sh - 自动化部署脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e  <span class="comment"># 遇到错误立即退出</span></span><br><span class="line"></span><br><span class="line">ENVIRONMENT=<span class="variable">$&#123;1:-production&#125;</span></span><br><span class="line">VERSION=<span class="variable">$&#123;2:-latest&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Deploying version <span class="variable">$VERSION</span> to <span class="variable">$ENVIRONMENT</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 拉取最新代码</span></span><br><span class="line">git fetch origin</span><br><span class="line">git checkout <span class="variable">$VERSION</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 构建镜像</span></span><br><span class="line">docker build -t myapp:<span class="variable">$VERSION</span> .</span><br><span class="line">docker tag myapp:<span class="variable">$VERSION</span> registry.example.com/myapp:<span class="variable">$VERSION</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 推送镜像</span></span><br><span class="line">docker push registry.example.com/myapp:<span class="variable">$VERSION</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 更新 Kubernetes 部署</span></span><br><span class="line">kubectl <span class="built_in">set</span> image deployment/myapp \</span><br><span class="line">  app=registry.example.com/myapp:<span class="variable">$VERSION</span> \</span><br><span class="line">  -n <span class="variable">$ENVIRONMENT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 等待部署完成</span></span><br><span class="line">kubectl rollout status deployment/myapp -n <span class="variable">$ENVIRONMENT</span> --<span class="built_in">timeout</span>=5m</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 健康检查</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> curl -f http://myapp.<span class="variable">$ENVIRONMENT</span>.example.com/health; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Health check passed&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">sleep</span> 10</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Health check failed&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure>
<h3 id="自动化备份脚本">自动化备份脚本</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># backup.sh - 数据库备份脚本</span></span><br><span class="line"></span><br><span class="line">BACKUP_DIR=<span class="string">&quot;/backups&quot;</span></span><br><span class="line">DATE=$(<span class="built_in">date</span> +%Y%m%d_%H%M%S)</span><br><span class="line">RETENTION_DAYS=30</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL 备份</span></span><br><span class="line">mysqldump -h db.example.com -u backup_user -p<span class="variable">$DB_PASSWORD</span> \</span><br><span class="line">  --single-transaction \</span><br><span class="line">  --routines \</span><br><span class="line">  --triggers \</span><br><span class="line">  myapp &gt; <span class="variable">$BACKUP_DIR</span>/mysql_<span class="variable">$DATE</span>.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 压缩备份</span></span><br><span class="line">gzip <span class="variable">$BACKUP_DIR</span>/mysql_<span class="variable">$DATE</span>.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上传到 S3</span></span><br><span class="line">aws s3 <span class="built_in">cp</span> <span class="variable">$BACKUP_DIR</span>/mysql_<span class="variable">$DATE</span>.sql.gz \</span><br><span class="line">  s3://backup-bucket/mysql/<span class="variable">$DATE</span>.sql.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理本地旧备份</span></span><br><span class="line">find <span class="variable">$BACKUP_DIR</span> -name <span class="string">&quot;mysql_*.sql.gz&quot;</span> -mtime +<span class="variable">$RETENTION_DAYS</span> -delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 清理 S3 旧备份</span></span><br><span class="line">aws s3 <span class="built_in">ls</span> s3://backup-bucket/mysql/ | \</span><br><span class="line">  awk <span class="string">&#x27;&#123;print $4&#125;&#x27;</span> | \</span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">read</span> file; <span class="keyword">do</span></span><br><span class="line">    file_date=$(<span class="built_in">echo</span> <span class="variable">$file</span> | <span class="built_in">cut</span> -d<span class="string">&#x27;_&#x27;</span> -f2 | <span class="built_in">cut</span> -d<span class="string">&#x27;.&#x27;</span> -f1)</span><br><span class="line">    <span class="keyword">if</span> [ $(<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$file_date</span>&quot;</span> +%s) -lt $(<span class="built_in">date</span> -d <span class="string">&quot;<span class="variable">$RETENTION_DAYS</span> days ago&quot;</span> +%s) ]; <span class="keyword">then</span></span><br><span class="line">      aws s3 <span class="built_in">rm</span> s3://backup-bucket/mysql/<span class="variable">$file</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h3 id="自动化测试脚本">自动化测试脚本</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># test.sh - 自动化测试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running unit tests...&quot;</span></span><br><span class="line">npm <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running integration tests...&quot;</span></span><br><span class="line">docker-compose -f docker-compose.test.yml up -d</span><br><span class="line"><span class="built_in">sleep</span> 10</span><br><span class="line">npm run <span class="built_in">test</span>:integration</span><br><span class="line">docker-compose -f docker-compose.test.yml down</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running E2E tests...&quot;</span></span><br><span class="line">npm run <span class="built_in">test</span>:e2e</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;All tests passed!&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="cicd-流水线">CI/CD 流水线</h3>
<h4 id="jenkins-pipeline">Jenkins Pipeline</h4>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Jenkinsfile</span></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    </span><br><span class="line">    environment &#123;</span><br><span class="line">        DOCKER_REGISTRY = <span class="string">&#x27;registry.example.com&#x27;</span></span><br><span class="line">        KUBERNETES_NAMESPACE = <span class="string">&#x27;production&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Checkout&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout scm</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker build -t $&#123;DOCKER_REGISTRY&#125;/myapp:$&#123;BUILD_NUMBER&#125; .&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker run --rm $&#123;DOCKER_REGISTRY&#125;/myapp:$&#123;BUILD_NUMBER&#125; npm test&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Security Scan&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;trivy image $&#123;DOCKER_REGISTRY&#125;/myapp:$&#123;BUILD_NUMBER&#125;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Push&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;docker push $&#123;DOCKER_REGISTRY&#125;/myapp:$&#123;BUILD_NUMBER&#125;&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;docker tag $&#123;DOCKER_REGISTRY&#125;/myapp:$&#123;BUILD_NUMBER&#125; $&#123;DOCKER_REGISTRY&#125;/myapp:latest&#x27;</span></span><br><span class="line">                sh <span class="string">&#x27;docker push $&#123;DOCKER_REGISTRY&#125;/myapp:latest&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        stage(<span class="string">&#x27;Deploy&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    kubectl set image deployment/myapp \</span></span><br><span class="line"><span class="string">                      app=$&#123;DOCKER_REGISTRY&#125;/myapp:$&#123;BUILD_NUMBER&#125; \</span></span><br><span class="line"><span class="string">                      -n $&#123;KUBERNETES_NAMESPACE&#125;</span></span><br><span class="line"><span class="string">                    kubectl rollout status deployment/myapp -n $&#123;KUBERNETES_NAMESPACE&#125;</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            slackSend(</span><br><span class="line">                <span class="symbol">channel:</span> <span class="string">&#x27;#deployments&#x27;</span>,</span><br><span class="line">                <span class="symbol">color:</span> <span class="string">&#x27;good&#x27;</span>,</span><br><span class="line">                <span class="symbol">message:</span> <span class="string">&quot;Deployment successful: $&#123;BUILD_NUMBER&#125;&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            slackSend(</span><br><span class="line">                <span class="symbol">channel:</span> <span class="string">&#x27;#deployments&#x27;</span>,</span><br><span class="line">                <span class="symbol">color:</span> <span class="string">&#x27;danger&#x27;</span>,</span><br><span class="line">                <span class="symbol">message:</span> <span class="string">&quot;Deployment failed: $&#123;BUILD_NUMBER&#125;&quot;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="gitlab-cicd">GitLab CI/CD</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># .gitlab-ci.yml</span></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">test</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">security</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line">  <span class="attr">DOCKER_DRIVER:</span> <span class="string">overlay2</span></span><br><span class="line">  <span class="attr">DOCKER_TLS_CERTDIR:</span> <span class="string">&quot;/certs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">tag</span> <span class="string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span> <span class="string">$CI_REGISTRY_IMAGE:latest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$CI_REGISTRY_IMAGE:latest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span> <span class="string">npm</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security-scan:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">security</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-v</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">        <span class="string">aquasec/trivy</span> <span class="string">image</span> <span class="string">$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">set</span> <span class="string">image</span> <span class="string">deployment/myapp</span> <span class="string">app=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA</span> <span class="string">-n</span> <span class="string">production</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubectl</span> <span class="string">rollout</span> <span class="string">status</span> <span class="string">deployment/myapp</span> <span class="string">-n</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="string">main</span></span><br></pre></td></tr></table></figure>
<h3 id="自动化运维最佳实践">自动化运维最佳实践</h3>
<ol type="1">
<li><strong>幂等性</strong>：确保脚本可以安全地重复执行</li>
<li><strong>错误处理</strong>：完善的错误处理和回滚机制</li>
<li><strong>日志记录</strong>：详细记录每个步骤的执行情况</li>
<li><strong>通知机制</strong>：及时通知相关人员部署状态</li>
<li><strong>版本控制</strong>：所有脚本纳入版本控制</li>
<li><strong>测试验证</strong>：在测试环境验证后再应用到生产</li>
</ol>
<h2 id="弹性伸缩策略">弹性伸缩策略</h2>
<p>弹性伸缩是云计算的核心优势，根据负载自动调整资源规模。</p>
<h3 id="kubernetes-hpahorizontal-pod-autoscaler">Kubernetes
HPA（Horizontal Pod Autoscaler）</h3>
<p>HPA 根据 CPU、内存等指标水平扩展 Pod 数量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hpa.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">          <span class="attr">averageUtilization:</span> <span class="number">70</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">          <span class="attr">averageUtilization:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">      <span class="attr">pods:</span></span><br><span class="line">        <span class="attr">metric:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http_requests_per_second</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">          <span class="attr">averageValue:</span> <span class="string">&quot;100&quot;</span></span><br><span class="line">  <span class="attr">behavior:</span></span><br><span class="line">    <span class="attr">scaleDown:</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">300</span></span><br><span class="line">      <span class="attr">policies:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">50</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">scaleUp:</span></span><br><span class="line">      <span class="attr">stabilizationWindowSeconds:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">policies:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Percent</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">100</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">15</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">          <span class="attr">value:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">15</span></span><br><span class="line">      <span class="attr">selectPolicy:</span> <span class="string">Max</span></span><br></pre></td></tr></table></figure>
<h3 id="kubernetes-vpavertical-pod-autoscaler">Kubernetes VPA（Vertical
Pod Autoscaler）</h3>
<p>VPA 根据历史使用情况垂直调整 Pod 的资源请求和限制。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vpa.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VerticalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-vpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">targetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">updatePolicy:</span></span><br><span class="line">    <span class="attr">updateMode:</span> <span class="string">&quot;Auto&quot;</span></span><br><span class="line">  <span class="attr">resourcePolicy:</span></span><br><span class="line">    <span class="attr">containerPolicies:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">containerName:</span> <span class="string">app</span></span><br><span class="line">        <span class="attr">minAllowed:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">        <span class="attr">maxAllowed:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="number">4</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">8Gi</span></span><br><span class="line">        <span class="attr">controlledResources:</span> [<span class="string">&quot;cpu&quot;</span>, <span class="string">&quot;memory&quot;</span>]</span><br></pre></td></tr></table></figure>
<h3 id="kubernetes-cacluster-autoscaler">Kubernetes CA（Cluster
Autoscaler）</h3>
<p>CA 根据 Pod 调度需求自动调整节点数量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cluster-autoscaler.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">k8s.gcr.io/autoscaling/cluster-autoscaler:v1.27.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cluster-autoscaler</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./cluster-autoscaler</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--v=4</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--stderrthreshold=info</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--cloud-provider=aws</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--skip-nodes-with-local-storage=false</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--expander=least-waste</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">--node-group-auto-discovery=asg:tag=k8s.io/cluster-autoscaler/enabled,k8s.io/cluster-autoscaler/production</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line"></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AWS_REGION</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">cn-north-1</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">300Mi</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">300Mi</span></span><br></pre></td></tr></table></figure>
<h3 id="aws-auto-scaling">AWS Auto Scaling</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"># Terraform 配置 Auto Scaling Group</span><br><span class="line">resource &quot;aws_launch_template&quot; &quot;web&quot; &#123;</span><br><span class="line">  name_prefix   = &quot;web-&quot;</span><br><span class="line">  image_id      = data.aws_ami.ubuntu.id</span><br><span class="line">  instance_type = &quot;t3.medium&quot;</span><br><span class="line"></span><br><span class="line">  vpc_security_group_ids = [aws_security_group.web.id]</span><br><span class="line"></span><br><span class="line">  user_data = base64encode(&lt;&lt;-EOF</span><br><span class="line">    #!/bin/bash</span><br><span class="line">    apt-get update</span><br><span class="line">    apt-get install -y nginx</span><br><span class="line">    systemctl start nginx</span><br><span class="line">  EOF</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_autoscaling_group&quot; &quot;web&quot; &#123;</span><br><span class="line">  name                = &quot;web-asg&quot;</span><br><span class="line">  vpc_zone_identifier = aws_subnet.public[*].id</span><br><span class="line">  target_group_arns   = [aws_lb_target_group.web.arn]</span><br><span class="line">  health_check_type   = &quot;ELB&quot;</span><br><span class="line">  health_check_grace_period = 300</span><br><span class="line"></span><br><span class="line">  min_size         = 2</span><br><span class="line">  max_size         = 10</span><br><span class="line">  desired_capacity = 2</span><br><span class="line"></span><br><span class="line">  launch_template &#123;</span><br><span class="line">    id      = aws_launch_template.web.id</span><br><span class="line">    version = &quot;$Latest&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tag &#123;</span><br><span class="line">    key                 = &quot;Name&quot;</span><br><span class="line">    value               = &quot;web-server&quot;</span><br><span class="line">    propagate_at_launch = true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_autoscaling_policy&quot; &quot;scale_up&quot; &#123;</span><br><span class="line">  name                   = &quot;scale-up&quot;</span><br><span class="line">  scaling_adjustment     = 2</span><br><span class="line">  adjustment_type        = &quot;ChangeInCapacity&quot;</span><br><span class="line">  cooldown               = 300</span><br><span class="line">  autoscaling_group_name = aws_autoscaling_group.web.name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_cloudwatch_metric_alarm&quot; &quot;cpu_high&quot; &#123;</span><br><span class="line">  alarm_name          = &quot;cpu-high&quot;</span><br><span class="line">  comparison_operator = &quot;GreaterThanThreshold&quot;</span><br><span class="line">  evaluation_periods  = 2</span><br><span class="line">  metric_name         = &quot;CPUUtilization&quot;</span><br><span class="line">  namespace           = &quot;AWS/EC2&quot;</span><br><span class="line">  period              = 300</span><br><span class="line">  statistic           = &quot;Average&quot;</span><br><span class="line">  threshold           = 70</span><br><span class="line">  alarm_description   = &quot;This metric monitors ec2 cpu utilization&quot;</span><br><span class="line">  alarm_actions       = [aws_autoscaling_policy.scale_up.arn]</span><br><span class="line"></span><br><span class="line">  dimensions = &#123;</span><br><span class="line">    AutoScalingGroupName = aws_autoscaling_group.web.name</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="弹性伸缩最佳实践">弹性伸缩最佳实践</h3>
<ol type="1">
<li><strong>预热时间</strong>：设置合理的冷却期，避免频繁伸缩</li>
<li><strong>预测性伸缩</strong>：基于历史数据预测负载变化</li>
<li><strong>多指标策略</strong>：结合 CPU、内存、请求量等多个指标</li>
<li><strong>成本平衡</strong>：在性能和成本之间找到平衡点</li>
<li><strong>节点池分离</strong>：不同类型的工作负载使用不同的节点池</li>
</ol>
<h2 id="成本优化方法">成本优化方法</h2>
<p>云成本优化是运维的重要职责，需要在性能和成本之间找到平衡。</p>
<h3 id="reserved-instances预留实例">Reserved Instances（预留实例）</h3>
<p>预留实例可以大幅降低云资源成本，适合稳定负载。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># AWS CLI 购买预留实例</span></span><br><span class="line">aws ec2 purchase-reserved-instances-offering \</span><br><span class="line">  --reserved-instances-offering-id <span class="string">&quot;12345678-1234-1234-1234-123456789012&quot;</span> \</span><br><span class="line">  --instance-count 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询预留实例</span></span><br><span class="line">aws ec2 describe-reserved-instances \</span><br><span class="line">  --filters <span class="string">&quot;Name=state,Values=active&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="spot-instances竞价实例">Spot Instances（竞价实例）</h3>
<p>Spot 实例价格低廉，适合可中断的工作负载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># Terraform 配置 Spot 实例</span><br><span class="line">resource &quot;aws_spot_instance_request&quot; &quot;worker&quot; &#123;</span><br><span class="line">  ami                    = data.aws_ami.ubuntu.id</span><br><span class="line">  instance_type          = &quot;t3.large&quot;</span><br><span class="line">  spot_price             = &quot;0.05&quot;</span><br><span class="line">  wait_for_fulfillment   = true</span><br><span class="line">  vpc_security_group_ids = [aws_security_group.worker.id]</span><br><span class="line"></span><br><span class="line">  tags = &#123;</span><br><span class="line">    Name = &quot;spot-worker&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Spot Fleet</span><br><span class="line">resource &quot;aws_spot_fleet_request&quot; &quot;workers&quot; &#123;</span><br><span class="line">  iam_fleet_role      = aws_iam_role.spot_fleet.arn</span><br><span class="line">  allocation_strategy = &quot;lowestPrice&quot;</span><br><span class="line">  target_capacity     = 10</span><br><span class="line">  valid_until         = &quot;2025-12-31T23:59:59Z&quot;</span><br><span class="line"></span><br><span class="line">  launch_specification &#123;</span><br><span class="line">    instance_type     = &quot;t3.medium&quot;</span><br><span class="line">    ami               = data.aws_ami.ubuntu.id</span><br><span class="line">    spot_price        = &quot;0.05&quot;</span><br><span class="line">    availability_zone = &quot;cn-north-1a&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  launch_specification &#123;</span><br><span class="line">    instance_type     = &quot;t3.large&quot;</span><br><span class="line">    ami               = data.aws_ami.ubuntu.id</span><br><span class="line">    spot_price        = &quot;0.08&quot;</span><br><span class="line">    availability_zone = &quot;cn-north-1b&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="savings-plans">Savings Plans</h3>
<p>Savings Plans 提供灵活的折扣，适用于各种计算服务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Savings Plan</span></span><br><span class="line">aws savingsplans create-savings-plan \</span><br><span class="line">  --savings-plan-offering-id <span class="string">&quot;sp-1234567890abcdef0&quot;</span> \</span><br><span class="line">  --commitment <span class="string">&quot;1000&quot;</span> \</span><br><span class="line">  --upfront-payment-amount <span class="string">&quot;0&quot;</span> \</span><br><span class="line">  --purchase-time <span class="string">&quot;2025-01-01T00:00:00Z&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="成本优化脚本">成本优化脚本</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cost_optimizer.py - 成本优化脚本</span></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_unused_volumes</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找未使用的 EBS 卷&quot;&quot;&quot;</span></span><br><span class="line">    ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    volumes = ec2.describe_volumes(</span><br><span class="line">        Filters=[&#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;status&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [<span class="string">&#x27;available&#x27;</span>]&#125;]</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    unused = []</span><br><span class="line">    <span class="keyword">for</span> volume <span class="keyword">in</span> volumes[<span class="string">&#x27;Volumes&#x27;</span>]:</span><br><span class="line">        <span class="comment"># 检查是否有关联的快照</span></span><br><span class="line">        snapshots = ec2.describe_snapshots(</span><br><span class="line">            Filters=[&#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;volume-id&#x27;</span>, <span class="string">&#x27;Values&#x27;</span>: [volume[<span class="string">&#x27;VolumeId&#x27;</span>]]&#125;]</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> snapshots[<span class="string">&#x27;Snapshots&#x27;</span>]:</span><br><span class="line">            unused.append(&#123;</span><br><span class="line">                <span class="string">&#x27;VolumeId&#x27;</span>: volume[<span class="string">&#x27;VolumeId&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;Size&#x27;</span>: volume[<span class="string">&#x27;Size&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;CreateTime&#x27;</span>: volume[<span class="string">&#x27;CreateTime&#x27;</span>]</span><br><span class="line">            &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> unused</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_idle_instances</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找空闲的 EC2 实例&quot;&quot;&quot;</span></span><br><span class="line">    cloudwatch = boto3.client(<span class="string">&#x27;cloudwatch&#x27;</span>)</span><br><span class="line">    ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    end_time = datetime.utcnow()</span><br><span class="line">    start_time = end_time - timedelta(days=<span class="number">7</span>)</span><br><span class="line">    </span><br><span class="line">    instances = ec2.describe_instances()</span><br><span class="line">    idle_instances = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> reservation <span class="keyword">in</span> instances[<span class="string">&#x27;Reservations&#x27;</span>]:</span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> reservation[<span class="string">&#x27;Instances&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> instance[<span class="string">&#x27;State&#x27;</span>][<span class="string">&#x27;Name&#x27;</span>] != <span class="string">&#x27;running&#x27;</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 检查 CPU 使用率</span></span><br><span class="line">            response = cloudwatch.get_metric_statistics(</span><br><span class="line">                Namespace=<span class="string">&#x27;AWS/EC2&#x27;</span>,</span><br><span class="line">                MetricName=<span class="string">&#x27;CPUUtilization&#x27;</span>,</span><br><span class="line">                Dimensions=[</span><br><span class="line">                    &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;InstanceId&#x27;</span>, <span class="string">&#x27;Value&#x27;</span>: instance[<span class="string">&#x27;InstanceId&#x27;</span>]&#125;</span><br><span class="line">                ],</span><br><span class="line">                StartTime=start_time,</span><br><span class="line">                EndTime=end_time,</span><br><span class="line">                Period=<span class="number">3600</span>,</span><br><span class="line">                Statistics=[<span class="string">&#x27;Average&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            avg_cpu = <span class="built_in">sum</span>(</span><br><span class="line">                point[<span class="string">&#x27;Average&#x27;</span>] <span class="keyword">for</span> point <span class="keyword">in</span> response[<span class="string">&#x27;Datapoints&#x27;</span>]</span><br><span class="line">            ) / <span class="built_in">len</span>(response[<span class="string">&#x27;Datapoints&#x27;</span>]) <span class="keyword">if</span> response[<span class="string">&#x27;Datapoints&#x27;</span>] <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> avg_cpu &lt; <span class="number">5</span>:  <span class="comment"># CPU 使用率低于 5%</span></span><br><span class="line">                idle_instances.append(&#123;</span><br><span class="line">                    <span class="string">&#x27;InstanceId&#x27;</span>: instance[<span class="string">&#x27;InstanceId&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;InstanceType&#x27;</span>: instance[<span class="string">&#x27;InstanceType&#x27;</span>],</span><br><span class="line">                    <span class="string">&#x27;AvgCPU&#x27;</span>: avg_cpu</span><br><span class="line">                &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> idle_instances</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">optimize_rightsizing</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;实例规格优化建议&quot;&quot;&quot;</span></span><br><span class="line">    cloudwatch = boto3.client(<span class="string">&#x27;cloudwatch&#x27;</span>)</span><br><span class="line">    ec2 = boto3.client(<span class="string">&#x27;ec2&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    end_time = datetime.utcnow()</span><br><span class="line">    start_time = end_time - timedelta(days=<span class="number">14</span>)</span><br><span class="line">    </span><br><span class="line">    instances = ec2.describe_instances()</span><br><span class="line">    recommendations = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> reservation <span class="keyword">in</span> instances[<span class="string">&#x27;Reservations&#x27;</span>]:</span><br><span class="line">        <span class="keyword">for</span> instance <span class="keyword">in</span> reservation[<span class="string">&#x27;Instances&#x27;</span>]:</span><br><span class="line">            <span class="keyword">if</span> instance[<span class="string">&#x27;State&#x27;</span>][<span class="string">&#x27;Name&#x27;</span>] != <span class="string">&#x27;running&#x27;</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 获取 CPU 和内存使用率</span></span><br><span class="line">            cpu_response = cloudwatch.get_metric_statistics(</span><br><span class="line">                Namespace=<span class="string">&#x27;AWS/EC2&#x27;</span>,</span><br><span class="line">                MetricName=<span class="string">&#x27;CPUUtilization&#x27;</span>,</span><br><span class="line">                Dimensions=[</span><br><span class="line">                    &#123;<span class="string">&#x27;Name&#x27;</span>: <span class="string">&#x27;InstanceId&#x27;</span>, <span class="string">&#x27;Value&#x27;</span>: instance[<span class="string">&#x27;InstanceId&#x27;</span>]&#125;</span><br><span class="line">                ],</span><br><span class="line">                StartTime=start_time,</span><br><span class="line">                EndTime=end_time,</span><br><span class="line">                Period=<span class="number">3600</span>,</span><br><span class="line">                Statistics=[<span class="string">&#x27;Average&#x27;</span>, <span class="string">&#x27;Maximum&#x27;</span>]</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 分析使用率，给出优化建议</span></span><br><span class="line">            <span class="comment"># ... 优化逻辑 ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> recommendations</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Finding unused volumes...&quot;</span>)</span><br><span class="line">    unused_volumes = find_unused_volumes()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(unused_volumes)&#125;</span> unused volumes&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Finding idle instances...&quot;</span>)</span><br><span class="line">    idle_instances = find_idle_instances()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Found <span class="subst">&#123;<span class="built_in">len</span>(idle_instances)&#125;</span> idle instances&quot;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="成本优化最佳实践">成本优化最佳实践</h3>
<ol type="1">
<li><strong>资源标签</strong>：使用标签追踪资源成本和归属</li>
<li><strong>定期审查</strong>：定期审查资源使用情况，清理闲置资源</li>
<li><strong>自动化优化</strong>：使用脚本自动识别和优化资源</li>
<li><strong>预算告警</strong>：设置预算告警，及时发现问题</li>
<li><strong>多账户管理</strong>：使用多账户隔离不同环境，便于成本管理</li>
<li><strong>使用 Spot 实例</strong>：对可中断工作负载使用 Spot 实例</li>
<li><strong>预留实例规划</strong>：分析历史使用情况，合理购买预留实例</li>
</ol>
<h2 id="故障排查与恢复">故障排查与恢复</h2>
<p>故障是不可避免的，快速定位和恢复是运维的核心能力。</p>
<h3 id="故障排查流程">故障排查流程</h3>
<ol type="1">
<li><strong>确认故障</strong>：验证故障是否真实存在</li>
<li><strong>收集信息</strong>：收集日志、监控数据、用户反馈</li>
<li><strong>定位根因</strong>：分析数据，定位问题根因</li>
<li><strong>制定方案</strong>：制定恢复和修复方案</li>
<li><strong>执行恢复</strong>：执行恢复操作</li>
<li><strong>验证修复</strong>：验证问题是否解决</li>
<li><strong>事后复盘</strong>：分析故障原因，优化系统</li>
</ol>
<h3 id="常见故障场景">常见故障场景</h3>
<h4 id="服务不可用">服务不可用</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查服务状态</span></span><br><span class="line">kubectl get pods -n production</span><br><span class="line">kubectl describe pod &lt;pod-name&gt; -n production</span><br><span class="line">kubectl logs &lt;pod-name&gt; -n production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务端点</span></span><br><span class="line">kubectl get endpoints -n production</span><br><span class="line">kubectl get svc -n production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查节点状态</span></span><br><span class="line">kubectl get nodes</span><br><span class="line">kubectl describe node &lt;node-name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查资源使用</span></span><br><span class="line">kubectl top nodes</span><br><span class="line">kubectl top pods -n production</span><br></pre></td></tr></table></figure>
<h4 id="性能问题">性能问题</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分析 CPU 使用</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -n production -- top</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析内存使用</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -n production -- free -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析网络连接</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -n production -- netstat -an</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析进程</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it &lt;pod-name&gt; -n production -- ps aux</span><br></pre></td></tr></table></figure>
<h4 id="数据库问题">数据库问题</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 检查连接数</span></span><br><span class="line"><span class="keyword">SHOW</span> PROCESSLIST;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查慢查询</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> mysql.slow_log <span class="keyword">ORDER</span> <span class="keyword">BY</span> start_time <span class="keyword">DESC</span> LIMIT <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查锁等待</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_locks;</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_lock_waits;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 检查表大小</span></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    table_schema,</span><br><span class="line">    table_name,</span><br><span class="line">    ROUND(((data_length <span class="operator">+</span> index_length) <span class="operator">/</span> <span class="number">1024</span> <span class="operator">/</span> <span class="number">1024</span>), <span class="number">2</span>) <span class="keyword">AS</span> size_mb</span><br><span class="line"><span class="keyword">FROM</span> information_schema.tables</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> size_mb <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>
<h3 id="故障恢复脚本">故障恢复脚本</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># disaster_recovery.sh - 灾难恢复脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">BACKUP_BUCKET=<span class="string">&quot;s3://backup-bucket&quot;</span></span><br><span class="line">RESTORE_DATE=<span class="variable">$&#123;1:-$(date +%Y%m%d)&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Starting disaster recovery for date: <span class="variable">$RESTORE_DATE</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 恢复数据库</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Restoring database...&quot;</span></span><br><span class="line">aws s3 <span class="built_in">cp</span> <span class="variable">$BACKUP_BUCKET</span>/mysql_<span class="variable">$&#123;RESTORE_DATE&#125;</span>.sql.gz /tmp/</span><br><span class="line">gunzip /tmp/mysql_<span class="variable">$&#123;RESTORE_DATE&#125;</span>.sql.gz</span><br><span class="line">mysql -h db.example.com -u admin -p<span class="variable">$DB_PASSWORD</span> myapp &lt; /tmp/mysql_<span class="variable">$&#123;RESTORE_DATE&#125;</span>.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 恢复文件存储</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Restoring file storage...&quot;</span></span><br><span class="line">aws s3 <span class="built_in">sync</span> <span class="variable">$BACKUP_BUCKET</span>/files_<span class="variable">$&#123;RESTORE_DATE&#125;</span>/ /var/www/files/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 重启服务</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Restarting services...&quot;</span></span><br><span class="line">kubectl rollout restart deployment/myapp -n production</span><br><span class="line">kubectl rollout status deployment/myapp -n production</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 验证服务</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Verifying services...&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..30&#125;; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> curl -f http://myapp.example.com/health; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Service is healthy&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">sleep</span> 10</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Service verification failed&quot;</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure>
<h3 id="故障排查最佳实践">故障排查最佳实践</h3>
<ol type="1">
<li><strong>建立 Runbook</strong>：为常见故障建立标准处理流程</li>
<li><strong>监控告警</strong>：设置完善的监控和告警</li>
<li><strong>日志集中</strong>：集中收集所有日志，便于关联分析</li>
<li><strong>演练培训</strong>：定期进行故障演练，提高团队能力</li>
<li><strong>文档记录</strong>：详细记录故障处理过程，形成知识库</li>
</ol>
<h2 id="sre-最佳实践">SRE 最佳实践</h2>
<p>SRE（Site Reliability Engineering）是 Google
提出的运维理念，强调通过工程方法保障服务可靠性。</p>
<h3 id="错误预算error-budget">错误预算（Error Budget）</h3>
<p>错误预算是允许的不可靠性上限，等于 100% 减去 SLO。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">错误预算 = 1 - SLO</span><br></pre></td></tr></table></figure>
<p>例如，SLO 为 99.9%，错误预算为 0.1%。</p>
<h3 id="sloservice-level-objective">SLO（Service Level Objective）</h3>
<p>SLO 是服务可靠性目标，通常用可用性或延迟表示。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SLO 定义示例</span></span><br><span class="line"><span class="attr">slo:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-availability</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">API</span> <span class="string">availability</span> <span class="string">SLO</span></span><br><span class="line">  <span class="attr">target:</span> <span class="number">99.9</span><span class="string">%</span></span><br><span class="line">  <span class="attr">window:</span> <span class="number">30</span> <span class="string">days</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">availability</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ratio</span></span><br><span class="line">      <span class="attr">numerator:</span> <span class="string">successful_requests</span></span><br><span class="line">      <span class="attr">denominator:</span> <span class="string">total_requests</span></span><br><span class="line">      <span class="attr">threshold:</span> <span class="number">0.999</span></span><br></pre></td></tr></table></figure>
<h3 id="sliservice-level-indicator">SLI（Service Level Indicator）</h3>
<p>SLI 是衡量服务可靠性的指标。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 可用性 SLI</span><br><span class="line">sum(rate(http_requests_total&#123;status!~&quot;5..&quot;&#125;[5m])) </span><br><span class="line">/ </span><br><span class="line">sum(rate(http_requests_total[5m]))</span><br><span class="line"></span><br><span class="line"># 延迟 SLI</span><br><span class="line">histogram_quantile(0.95, </span><br><span class="line">  sum(rate(http_request_duration_seconds_bucket[5m])) by (le)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="sre-实践">SRE 实践</h3>
<h4 id="监控-slo">监控 SLO</h4>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Prometheus SLO 监控</span></span><br><span class="line"><span class="attr">groups:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">slo</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">slo:availability:ratio</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sum(rate(http_requests_total&#123;status!~&quot;5..&quot;&#125;[5m]))</span></span><br><span class="line"><span class="string">          /</span></span><br><span class="line"><span class="string">          sum(rate(http_requests_total[5m]))</span></span><br><span class="line"><span class="string"></span>      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">SLOBreach</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          (</span></span><br><span class="line"><span class="string">            (1 - slo:availability:ratio) * 86400 * 30</span></span><br><span class="line"><span class="string">          ) &gt; (</span></span><br><span class="line"><span class="string">            (1 - 0.999) * 86400 * 30</span></span><br><span class="line"><span class="string">          )</span></span><br><span class="line"><span class="string"></span>        <span class="attr">for:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">&quot;SLO breach detected&quot;</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">&quot;Error budget consumption exceeds threshold&quot;</span></span><br></pre></td></tr></table></figure>
<h4 id="错误预算策略">错误预算策略</h4>
<ul>
<li><strong>预算充足</strong>：可以发布新功能，承担一定风险</li>
<li><strong>预算紧张</strong>：暂停新功能发布，专注于稳定性</li>
<li><strong>预算耗尽</strong>：停止所有变更，全力修复问题</li>
</ul>
<h3 id="sre-最佳实践-1">SRE 最佳实践</h3>
<ol type="1">
<li><strong>定义清晰的 SLO</strong>：基于用户需求定义合理的 SLO</li>
<li><strong>监控错误预算</strong>：实时监控错误预算消耗情况</li>
<li><strong>自动化运维</strong>：通过自动化减少人为错误</li>
<li><strong>容量规划</strong>：提前规划容量，避免资源不足</li>
<li><strong>变更管理</strong>：严格控制变更，降低故障风险</li>
<li><strong>事后复盘</strong>：每次故障后进行复盘，持续改进</li>
</ol>
<h2 id="devops-工具链">DevOps 工具链</h2>
<p>DevOps 工具链覆盖开发、构建、测试、部署、监控等各个环节。</p>
<h3 id="版本控制">版本控制</h3>
<ul>
<li><strong>Git</strong>：分布式版本控制系统</li>
<li><strong>GitHub/GitLab</strong>：代码托管和协作平台</li>
<li><strong>Git Flow</strong>：分支管理策略</li>
</ul>
<h3 id="cicd">CI/CD</h3>
<ul>
<li><strong>Jenkins</strong>：开源 CI/CD 平台</li>
<li><strong>GitLab CI/CD</strong>：集成在 GitLab 中的 CI/CD</li>
<li><strong>GitHub Actions</strong>：GitHub 的 CI/CD 服务</li>
<li><strong>CircleCI</strong>：云原生 CI/CD 平台</li>
<li><strong>Travis CI</strong>：持续集成服务</li>
</ul>
<h3 id="容器化">容器化</h3>
<ul>
<li><strong>Docker</strong>：容器运行时</li>
<li><strong>Kubernetes</strong>：容器编排平台</li>
<li><strong>Helm</strong>：Kubernetes 包管理工具</li>
<li><strong>Docker Compose</strong>：多容器应用编排</li>
</ul>
<h3 id="配置管理">配置管理</h3>
<ul>
<li><strong>Ansible</strong>：自动化配置管理</li>
<li><strong>Chef</strong>：基础设施自动化</li>
<li><strong>Puppet</strong>：配置管理工具</li>
<li><strong>SaltStack</strong>：事件驱动的自动化</li>
</ul>
<h3 id="监控与日志">监控与日志</h3>
<ul>
<li><strong>Prometheus</strong>：监控系统</li>
<li><strong>Grafana</strong>：可视化平台</li>
<li><strong>ELK Stack</strong>：日志管理</li>
<li><strong>Jaeger</strong>：分布式追踪</li>
<li><strong>New Relic</strong>：APM 平台</li>
<li><strong>Datadog</strong>：监控和分析平台</li>
</ul>
<h3 id="安全">安全</h3>
<ul>
<li><strong>Vault</strong>：密钥管理</li>
<li><strong>Trivy</strong>：容器安全扫描</li>
<li><strong>OWASP ZAP</strong>：安全测试工具</li>
<li><strong>SonarQube</strong>：代码质量分析</li>
</ul>
<h2 id="gitops-实践">GitOps 实践</h2>
<p>GitOps 是一种基于 Git 的运维实践，将基础设施和应用的配置存储在 Git
仓库中，通过 Git 操作触发部署。</p>
<h3 id="gitops-工作流">GitOps 工作流</h3>
<ol type="1">
<li><strong>开发提交代码</strong>：开发者提交代码到 Git 仓库</li>
<li><strong>CI 构建镜像</strong>：CI 系统构建 Docker
镜像并推送到镜像仓库</li>
<li><strong>更新配置</strong>：更新 Kubernetes 配置文件中的镜像版本</li>
<li><strong>Git 提交</strong>：提交配置变更到 Git 仓库</li>
<li><strong>GitOps 工具同步</strong>：ArgoCD 或 Flux
检测到变更并同步到集群</li>
<li><strong>自动部署</strong>：应用自动部署到 Kubernetes 集群</li>
</ol>
<h3 id="argocd">ArgoCD</h3>
<p>ArgoCD 是 CNCF 的 GitOps 工具，提供 Web UI 和 CLI。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># argocd-application.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Application</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">argocd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">project:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">source:</span></span><br><span class="line">    <span class="attr">repoURL:</span> <span class="string">https://github.com/example/myapp.git</span></span><br><span class="line">    <span class="attr">targetRevision:</span> <span class="string">main</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">k8s</span></span><br><span class="line">  <span class="attr">destination:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://kubernetes.default.svc</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">production</span></span><br><span class="line">  <span class="attr">syncPolicy:</span></span><br><span class="line">    <span class="attr">automated:</span></span><br><span class="line">      <span class="attr">prune:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">selfHeal:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">syncOptions:</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CreateNamespace=true</span></span><br></pre></td></tr></table></figure>
<h3 id="flux">Flux</h3>
<p>Flux 是另一个流行的 GitOps 工具。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># flux-kustomization.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.toolkit.fluxcd.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">flux-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">./k8s</span></span><br><span class="line">  <span class="attr">prune:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">sourceRef:</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">GitRepository</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">myapp</span></span><br><span class="line">  <span class="attr">validation:</span> <span class="string">client</span></span><br></pre></td></tr></table></figure>
<h3 id="gitops-最佳实践">GitOps 最佳实践</h3>
<ol type="1">
<li><strong>单一事实来源</strong>：Git 仓库是配置的唯一来源</li>
<li><strong>声明式配置</strong>：使用声明式配置，而非命令式操作</li>
<li><strong>自动化同步</strong>：自动检测和同步配置变更</li>
<li><strong>环境隔离</strong>：不同环境使用不同的 Git 分支或目录</li>
<li><strong>审计追踪</strong>：所有变更通过 Git 提交记录，便于审计</li>
</ol>
<h2 id="实战案例">实战案例</h2>
<h3 id="案例一微服务架构的监控体系建设">案例一：微服务架构的监控体系建设</h3>
<p>某电商平台采用微服务架构，包含用户服务、订单服务、支付服务等 20+
个服务。需要建立统一的监控体系。</p>
<h4 id="挑战">挑战</h4>
<ul>
<li>服务数量多，监控指标复杂</li>
<li>服务间调用链长，故障定位困难</li>
<li>需要实时监控业务指标</li>
</ul>
<h4 id="解决方案">解决方案</h4>
<ol type="1">
<li><p><strong>Prometheus + Grafana 监控基础设施</strong></p>
<ul>
<li>每个服务暴露 Prometheus 指标</li>
<li>使用 ServiceMonitor 自动发现</li>
<li>建立统一的 Grafana Dashboard</li>
</ul></li>
<li><p><strong>Jaeger 分布式追踪</strong></p>
<ul>
<li>集成 OpenTelemetry SDK</li>
<li>追踪所有服务间调用</li>
<li>建立调用链可视化</li>
</ul></li>
<li><p><strong>ELK Stack 日志管理</strong></p>
<ul>
<li>Filebeat 收集所有服务日志</li>
<li>Logstash 解析和丰富日志</li>
<li>Elasticsearch 存储和检索</li>
<li>Kibana 可视化分析</li>
</ul></li>
<li><p><strong>告警规则</strong></p>
<ul>
<li>基于 SLO 设置告警阈值</li>
<li>使用 Alertmanager 分组和抑制</li>
<li>集成 Slack 和 PagerDuty</li>
</ul></li>
</ol>
<h4 id="效果">效果</h4>
<ul>
<li>故障定位时间从 30 分钟降低到 5 分钟</li>
<li>告警准确率提升到 95%</li>
<li>业务指标可视化，便于决策</li>
</ul>
<h3 id="案例二kubernetes-集群的弹性伸缩优化">案例二：Kubernetes
集群的弹性伸缩优化</h3>
<p>某 SaaS 平台运行在 Kubernetes 上，面临流量波动大、成本高的问题。</p>
<h4 id="挑战-1">挑战</h4>
<ul>
<li>流量波动大，高峰期是平均值的 10 倍</li>
<li>固定资源导致成本浪费</li>
<li>需要快速响应流量变化</li>
</ul>
<h4 id="解决方案-1">解决方案</h4>
<ol type="1">
<li><p><strong>HPA 水平伸缩</strong> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">api-hpa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">api-server</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">          <span class="attr">averageUtilization:</span> <span class="number">70</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Pods</span></span><br><span class="line">      <span class="attr">pods:</span></span><br><span class="line">        <span class="attr">metric:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http_requests_per_second</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">          <span class="attr">averageValue:</span> <span class="string">&quot;100&quot;</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>VPA 垂直伸缩</strong></p>
<ul>
<li>分析历史资源使用</li>
<li>自动调整资源请求和限制</li>
<li>减少资源浪费</li>
</ul></li>
<li><p><strong>Cluster Autoscaler</strong></p>
<ul>
<li>自动添加和移除节点</li>
<li>使用 Spot 实例降低成本</li>
<li>多可用区部署提高可用性</li>
</ul></li>
<li><p><strong>预测性伸缩</strong></p>
<ul>
<li>基于历史数据预测流量</li>
<li>提前扩容，避免流量突增</li>
</ul></li>
</ol>
<h4 id="效果-1">效果</h4>
<ul>
<li>成本降低 40%</li>
<li>高峰期自动扩容，无服务降级</li>
<li>资源利用率提升到 75%</li>
</ul>
<h3 id="案例三多环境基础设施即代码实践">案例三：多环境基础设施即代码实践</h3>
<p>某金融公司需要在 AWS
上部署开发、测试、生产三个环境，要求环境一致性和快速部署。</p>
<h4 id="挑战-2">挑战</h4>
<ul>
<li>三个环境配置差异大</li>
<li>手动部署容易出错</li>
<li>环境一致性难以保证</li>
</ul>
<h4 id="解决方案-2">解决方案</h4>
<ol type="1">
<li><p><strong>Terraform 模块化</strong> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">terraform/</span><br><span class="line">├── modules/</span><br><span class="line">│   ├── vpc/</span><br><span class="line">│   ├── ec2/</span><br><span class="line">│   ├── rds/</span><br><span class="line">│   └── eks/</span><br><span class="line">├── environments/</span><br><span class="line">│   ├── dev/</span><br><span class="line">│   ├── test/</span><br><span class="line">│   └── prod/</span><br><span class="line">└── main.tf</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>环境配置分离</strong> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># environments/dev/main.tf</span><br><span class="line">module &quot;infrastructure&quot; &#123;</span><br><span class="line">  source = &quot;../../modules&quot;</span><br><span class="line">  </span><br><span class="line">  environment = &quot;dev&quot;</span><br><span class="line">  instance_type = &quot;t3.small&quot;</span><br><span class="line">  min_size = 1</span><br><span class="line">  max_size = 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># environments/prod/main.tf</span><br><span class="line">module &quot;infrastructure&quot; &#123;</span><br><span class="line">  source = &quot;../../modules&quot;</span><br><span class="line">  </span><br><span class="line">  environment = &quot;prod&quot;</span><br><span class="line">  instance_type = &quot;t3.large&quot;</span><br><span class="line">  min_size = 3</span><br><span class="line">  max_size = 10</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>CI/CD 集成</strong></p>
<ul>
<li>Git 提交触发 Terraform Plan</li>
<li>代码审查后执行 Apply</li>
<li>状态文件存储在 S3</li>
<li>使用 DynamoDB 锁定状态</li>
</ul></li>
<li><p><strong>合规检查</strong></p>
<ul>
<li>使用 Checkov 检查配置</li>
<li>集成安全策略检查</li>
<li>自动生成合规报告</li>
</ul></li>
</ol>
<h4 id="效果-2">效果</h4>
<ul>
<li>环境部署时间从 2 天降低到 2 小时</li>
<li>环境一致性 100%</li>
<li>配置变更可追溯、可回滚</li>
</ul>
<h2 id="qa-云运维与devops常见问题">❓ Q&amp;A:
云运维与DevOps常见问题</h2>
<h3 id="q1-如何选择合适的监控工具">Q1: 如何选择合适的监控工具？</h3>
<p><strong>A:</strong> 选择监控工具需要考虑以下因素：</p>
<ol type="1">
<li><strong>需求分析</strong>：明确需要监控的指标类型（基础设施、应用、业务）</li>
<li><strong>技术栈</strong>：考虑与现有技术栈的集成能力</li>
<li><strong>成本</strong>：开源工具免费但需要自运维，商业工具功能完善但成本高</li>
<li><strong>社区支持</strong>：选择活跃的开源项目或成熟的商业产品</li>
<li><strong>扩展性</strong>：考虑未来业务增长的需求</li>
</ol>
<p>推荐组合：Prometheus + Grafana（开源监控）+ ELK Stack（日志管理）+
Jaeger（分布式追踪）</p>
<h3 id="q2-如何设置合理的告警阈值">Q2: 如何设置合理的告警阈值？</h3>
<p><strong>A:</strong> 告警阈值设置应该基于：</p>
<ol type="1">
<li><strong>SLO 目标</strong>：根据 SLO 计算错误预算，设置告警阈值</li>
<li><strong>历史数据</strong>：分析历史监控数据，了解正常波动范围</li>
<li><strong>业务影响</strong>：考虑对业务的实际影响，设置不同严重级别</li>
<li><strong>渐进式告警</strong>：设置多个阈值（警告、严重、紧急），避免告警疲劳</li>
<li><strong>动态调整</strong>：根据实际情况持续调整阈值</li>
</ol>
<p>例如，如果 SLO 是 99.9%，可以设置：</p>
<ul>
<li>警告：错误率 &gt; 0.05%（消耗 50% 错误预算）</li>
<li>严重：错误率 &gt; 0.08%（消耗 80% 错误预算）</li>
<li>紧急：错误率 &gt; 0.1%（SLO 违反）</li>
</ul>
<h3 id="q3-kubernetes-中如何实现零停机部署">Q3: Kubernetes
中如何实现零停机部署？</h3>
<p><strong>A:</strong> 实现零停机部署的方法：</p>
<ol type="1">
<li><p><strong>滚动更新</strong>：Kubernetes 默认的更新策略，逐步替换
Pod <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span>  <span class="comment"># 确保始终有可用 Pod</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>就绪探针</strong>：确保新 Pod 就绪后再接收流量
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/health</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>蓝绿部署</strong>：使用两个完全相同的环境切换</p></li>
<li><p><strong>金丝雀发布</strong>：逐步将流量切换到新版本</p></li>
<li><p><strong>服务网格</strong>：使用 Istio
等工具实现更精细的流量控制</p></li>
</ol>
<h3 id="q4-如何优化云成本">Q4: 如何优化云成本？</h3>
<p><strong>A:</strong> 云成本优化策略：</p>
<ol type="1">
<li><strong>资源标签</strong>：使用标签追踪资源成本和归属</li>
<li><strong>定期审查</strong>：定期审查资源使用，清理闲置资源</li>
<li><strong>预留实例</strong>：对稳定负载使用预留实例，节省 30-70%
成本</li>
<li><strong>Spot 实例</strong>：对可中断工作负载使用 Spot 实例，节省
50-90% 成本</li>
<li><strong>自动伸缩</strong>：根据负载自动调整资源规模</li>
<li><strong>实例规格优化</strong>：根据实际使用情况选择合适的实例规格</li>
<li><strong>存储优化</strong>：使用合适的存储类型，定期清理旧数据</li>
<li><strong>网络优化</strong>：优化数据传输，减少跨区域流量</li>
</ol>
<h3 id="q5-如何建立有效的故障响应流程">Q5:
如何建立有效的故障响应流程？</h3>
<p><strong>A:</strong> 故障响应流程应该包括：</p>
<ol type="1">
<li><strong>故障分级</strong>：根据影响范围和时间定义故障级别（P0/P1/P2/P3）</li>
<li><strong>响应团队</strong>：建立 On-Call 轮值制度，明确责任人</li>
<li><strong>沟通渠道</strong>：建立故障沟通群组，及时同步信息</li>
<li><strong>处理流程</strong>：确认故障 → 收集信息 → 定位根因 → 制定方案
→ 执行恢复 → 验证修复</li>
<li><strong>升级机制</strong>：设置升级规则，严重故障及时上报</li>
<li><strong>事后复盘</strong>：每次故障后进行复盘，形成改进措施</li>
<li><strong>工具支持</strong>：使用 PagerDuty、Opsgenie 等工具管理
On-Call</li>
</ol>
<h3 id="q6-gitops-相比传统部署方式有什么优势">Q6: GitOps
相比传统部署方式有什么优势？</h3>
<p><strong>A:</strong> GitOps 的优势：</p>
<ol type="1">
<li><strong>版本控制</strong>：所有配置变更都有 Git
历史记录，可追溯、可回滚</li>
<li><strong>一致性</strong>：Git 是唯一事实来源，保证环境一致性</li>
<li><strong>自动化</strong>：自动检测和同步配置变更，减少人工操作</li>
<li><strong>安全性</strong>：通过 Git
权限控制配置访问，审计所有变更</li>
<li><strong>协作性</strong>：通过 Pull Request
进行配置审查，提高质量</li>
<li><strong>可扩展性</strong>：易于扩展到多个环境和集群</li>
</ol>
<h3 id="q7-如何选择合适的-cicd-工具">Q7: 如何选择合适的 CI/CD
工具？</h3>
<p><strong>A:</strong> 选择 CI/CD 工具考虑因素：</p>
<ol type="1">
<li><strong>集成能力</strong>：与代码仓库、镜像仓库、部署平台的集成</li>
<li><strong>功能需求</strong>：是否需要支持多语言、多平台、并行构建等</li>
<li><strong>易用性</strong>：配置是否简单，学习曲线是否平缓</li>
<li><strong>扩展性</strong>：是否支持插件和自定义扩展</li>
<li><strong>成本</strong>：开源免费 vs 商业授权</li>
<li><strong>社区支持</strong>：文档、社区活跃度、问题解决速度</li>
</ol>
<p>推荐：</p>
<ul>
<li><strong>Jenkins</strong>：功能强大，插件丰富，适合复杂场景</li>
<li><strong>GitLab CI/CD</strong>：与 GitLab 深度集成，配置简单</li>
<li><strong>GitHub Actions</strong>：与 GitHub 集成，适合开源项目</li>
<li><strong>CircleCI</strong>：云原生，配置简单，适合中小团队</li>
</ul>
<h3 id="q8-如何实现基础设施的灾难恢复">Q8:
如何实现基础设施的灾难恢复？</h3>
<p><strong>A:</strong> 灾难恢复策略：</p>
<ol type="1">
<li><p><strong>备份策略</strong>：</p>
<ul>
<li>数据库：定期全量备份 + 实时增量备份</li>
<li>文件存储：定期快照 + 跨区域复制</li>
<li>配置：Git 版本控制 + 配置备份</li>
</ul></li>
<li><p><strong>多区域部署</strong>：在多个可用区或区域部署，提高可用性</p></li>
<li><p><strong>自动化恢复</strong>：编写恢复脚本，自动化恢复流程</p></li>
<li><p><strong>定期演练</strong>：定期进行灾难恢复演练，验证恢复流程</p></li>
<li><p><strong>RTO/RPO
目标</strong>：定义恢复时间目标（RTO）和恢复点目标（RPO）</p></li>
<li><p><strong>监控告警</strong>：实时监控系统状态，及时发现故障</p></li>
</ol>
<h3 id="q9-如何建立有效的-slo">Q9: 如何建立有效的 SLO？</h3>
<p><strong>A:</strong> 建立 SLO 的步骤：</p>
<ol type="1">
<li><strong>用户需求分析</strong>：了解用户对服务的期望</li>
<li><strong>选择 SLI</strong>：选择能够反映用户体验的指标</li>
<li><strong>设定目标</strong>：基于历史数据和用户需求设定目标</li>
<li><strong>错误预算计算</strong>：错误预算 = 1 - SLO</li>
<li><strong>监控和告警</strong>：实时监控 SLO，设置告警</li>
<li><strong>持续优化</strong>：根据实际情况调整 SLO</li>
</ol>
<p>示例：</p>
<ul>
<li><strong>可用性 SLO</strong>：99.9%（每月最多 43 分钟不可用）</li>
<li><strong>延迟 SLO</strong>：P95 延迟 &lt; 200ms</li>
<li><strong>错误率 SLO</strong>：错误率 &lt; 0.1%</li>
</ul>
<h3 id="q10-云原生架构下的运维与传统运维有什么区别">Q10:
云原生架构下的运维与传统运维有什么区别？</h3>
<p><strong>A:</strong> 主要区别：</p>
<ol type="1">
<li><p><strong>基础设施</strong>：</p>
<ul>
<li>传统：物理服务器、虚拟机</li>
<li>云原生：容器、Kubernetes、Serverless</li>
</ul></li>
<li><p><strong>部署方式</strong>：</p>
<ul>
<li>传统：手动部署、脚本部署</li>
<li>云原生：容器化部署、自动化 CI/CD</li>
</ul></li>
<li><p><strong>监控方式</strong>：</p>
<ul>
<li>传统：服务器监控、应用监控分离</li>
<li>云原生：统一监控、可观测性（指标、日志、追踪）</li>
</ul></li>
<li><p><strong>扩展方式</strong>：</p>
<ul>
<li>传统：手动扩容、垂直扩展</li>
<li>云原生：自动伸缩、水平扩展</li>
</ul></li>
<li><p><strong>故障处理</strong>：</p>
<ul>
<li>传统：人工排查、手动恢复</li>
<li>云原生：自动化恢复、自愈能力</li>
</ul></li>
<li><p><strong>运维工具</strong>：</p>
<ul>
<li>传统：Shell 脚本、配置管理工具</li>
<li>云原生：IaC、GitOps、服务网格</li>
</ul></li>
<li><p><strong>团队协作</strong>：</p>
<ul>
<li>传统：开发运维分离</li>
<li>云原生：DevOps、SRE 文化</li>
</ul></li>
</ol>
<h2 id="总结">总结</h2>
<p>云运维和 DevOps
实践是一个持续演进的过程。从基础设施即代码到监控告警，从自动化部署到成本优化，每个环节都需要深入理解和实践。关键是要建立适合自己团队的流程和工具链，持续优化和改进。</p>
<p>随着云原生技术的普及，运维工作正在从"救火"转向"预防"，从"手动"转向"自动"，从"被动"转向"主动"。掌握这些实践，不仅能提高运维效率，更能保障业务的稳定性和可靠性。</p>
<hr>
<p><em>本文是云计算系列文章的第七篇，后续将继续探讨云安全、云架构设计等主题。</em></p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    
    
    
    
    
    
    <ul>
        <li>本文标题：云计算（七）运维与DevOps实践</li>
        <li>本文作者：Chen Kai</li>
        <li>创建时间：2024-01-29 00:00:00</li>
        <li>
            本文链接：https://www.chenk.top/cloud-computing-operations-devops/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/">#云计算</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/DevOps/">#DevOps</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E8%BF%90%E7%BB%B4/">#运维</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E7%9B%91%E6%8E%A7/">#监控</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/">#自动化</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/cloud-computing-storage-systems/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">云计算（三）存储系统与分布式架构</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/cloud-computing-fundamentals/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">云计算（一）基础概念与架构体系</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'p2Cu9MgjoKzo3VmulhNLIusH-gzGzoHsz',
                    appKey: 'QThQHg3c8sVwGpzg9lu8zEG3',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情赞美帅气伟大的ck吧~',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Chen Kai';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2026&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Chen Kai</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
            </div>
        
        <div class="theme-info info-item">
            <!-- 由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a> -->
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%91%E8%BF%90%E7%BB%B4%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E4%B8%8E%E8%81%8C%E8%B4%A3"><span class="nav-number">1.</span> <span class="nav-text">云运维核心流程与职责</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E7%AE%A1%E7%90%86"><span class="nav-number">1.1.</span> <span class="nav-text">基础设施管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2%E4%B8%8E%E5%8F%91%E5%B8%83"><span class="nav-number">1.2.</span> <span class="nav-text">应用部署与发布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6"><span class="nav-number">1.3.</span> <span class="nav-text">监控与告警</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="nav-number">1.4.</span> <span class="nav-text">故障处理与恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E4%B8%8E%E5%90%88%E8%A7%84"><span class="nav-number">1.5.</span> <span class="nav-text">安全与合规</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%8D%B3%E4%BB%A3%E7%A0%81iac"><span class="nav-number">2.</span> <span class="nav-text">基础设施即代码（IaC）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#terraform"><span class="nav-number">2.1.</span> <span class="nav-text">Terraform</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#terraform-%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95"><span class="nav-number">2.1.1.</span> <span class="nav-text">Terraform 基础语法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#terraform-%E6%A8%A1%E5%9D%97%E5%8C%96"><span class="nav-number">2.1.2.</span> <span class="nav-text">Terraform 模块化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#terraform-%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="nav-number">2.1.3.</span> <span class="nav-text">Terraform 状态管理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible"><span class="nav-number">2.2.</span> <span class="nav-text">Ansible</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ansible-playbook-%E7%A4%BA%E4%BE%8B"><span class="nav-number">2.2.1.</span> <span class="nav-text">Ansible Playbook 示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ansible-roles"><span class="nav-number">2.2.2.</span> <span class="nav-text">Ansible Roles</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aws-cloudformation"><span class="nav-number">2.3.</span> <span class="nav-text">AWS CloudFormation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iac-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">2.4.</span> <span class="nav-text">IaC 最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E4%BD%93%E7%B3%BB"><span class="nav-number">3.</span> <span class="nav-text">监控体系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#prometheus"><span class="nav-number">3.1.</span> <span class="nav-text">Prometheus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#prometheus-%E9%85%8D%E7%BD%AE"><span class="nav-number">3.1.1.</span> <span class="nav-text">Prometheus 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prometheus-%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="nav-number">3.1.2.</span> <span class="nav-text">Prometheus 告警规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#promql-%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.1.3.</span> <span class="nav-text">PromQL 查询示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#grafana"><span class="nav-number">3.2.</span> <span class="nav-text">Grafana</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#grafana-dashboard-json-%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.2.1.</span> <span class="nav-text">Grafana Dashboard JSON 示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%91%E7%9B%91%E6%8E%A7%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.3.</span> <span class="nav-text">云监控服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#aws-cloudwatch"><span class="nav-number">3.3.1.</span> <span class="nav-text">AWS CloudWatch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E4%BA%91%E7%9B%91%E6%8E%A7"><span class="nav-number">3.3.2.</span> <span class="nav-text">阿里云云监控</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">3.4.</span> <span class="nav-text">监控最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">日志管理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#elk-stack"><span class="nav-number">4.1.</span> <span class="nav-text">ELK Stack</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#logstash-%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.1.</span> <span class="nav-text">Logstash 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#filebeat-%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.2.</span> <span class="nav-text">Filebeat 配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#elasticsearch-%E7%B4%A2%E5%BC%95%E6%A8%A1%E6%9D%BF"><span class="nav-number">4.1.3.</span> <span class="nav-text">Elasticsearch 索引模板</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%91%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.2.</span> <span class="nav-text">云日志服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#aws-cloudwatch-logs"><span class="nav-number">4.2.1.</span> <span class="nav-text">AWS CloudWatch Logs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%BF%E9%87%8C%E4%BA%91%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1sls"><span class="nav-number">4.2.2.</span> <span class="nav-text">阿里云日志服务（SLS）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.3.</span> <span class="nav-text">日志分析实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E6%9F%A5%E8%AF%A2%E7%A4%BA%E4%BE%8B"><span class="nav-number">4.3.1.</span> <span class="nav-text">日志查询示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E5%91%8A%E8%AD%A6%E8%A7%84%E5%88%99"><span class="nav-number">4.3.2.</span> <span class="nav-text">日志告警规则</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.4.</span> <span class="nav-text">日志管理最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#apm-%E5%BA%94%E7%94%A8%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="nav-number">5.</span> <span class="nav-text">APM 应用性能监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#apm-%E6%A0%B8%E5%BF%83%E6%8C%87%E6%A0%87"><span class="nav-number">5.1.</span> <span class="nav-text">APM 核心指标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E8%BF%BD%E8%B8%AA"><span class="nav-number">5.2.</span> <span class="nav-text">分布式追踪</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#opentelemetry-%E9%9B%86%E6%88%90"><span class="nav-number">5.2.1.</span> <span class="nav-text">OpenTelemetry 集成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jaeger-%E9%85%8D%E7%BD%AE"><span class="nav-number">5.2.2.</span> <span class="nav-text">Jaeger 配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#apm-%E5%B7%A5%E5%85%B7"><span class="nav-number">5.3.</span> <span class="nav-text">APM 工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#new-relic"><span class="nav-number">5.3.1.</span> <span class="nav-text">New Relic</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#datadog-apm"><span class="nav-number">5.3.2.</span> <span class="nav-text">Datadog APM</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#apm-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">5.4.</span> <span class="nav-text">APM 最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E8%B7%B5"><span class="nav-number">6.</span> <span class="nav-text">自动化运维实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="nav-number">6.1.</span> <span class="nav-text">自动化部署脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC"><span class="nav-number">6.2.</span> <span class="nav-text">自动化备份脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC"><span class="nav-number">6.3.</span> <span class="nav-text">自动化测试脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cicd-%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="nav-number">6.4.</span> <span class="nav-text">CI&#x2F;CD 流水线</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#jenkins-pipeline"><span class="nav-number">6.4.1.</span> <span class="nav-text">Jenkins Pipeline</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#gitlab-cicd"><span class="nav-number">6.4.2.</span> <span class="nav-text">GitLab CI&#x2F;CD</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">6.5.</span> <span class="nav-text">自动化运维最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E7%AD%96%E7%95%A5"><span class="nav-number">7.</span> <span class="nav-text">弹性伸缩策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubernetes-hpahorizontal-pod-autoscaler"><span class="nav-number">7.1.</span> <span class="nav-text">Kubernetes
HPA（Horizontal Pod Autoscaler）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubernetes-vpavertical-pod-autoscaler"><span class="nav-number">7.2.</span> <span class="nav-text">Kubernetes VPA（Vertical
Pod Autoscaler）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubernetes-cacluster-autoscaler"><span class="nav-number">7.3.</span> <span class="nav-text">Kubernetes CA（Cluster
Autoscaler）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#aws-auto-scaling"><span class="nav-number">7.4.</span> <span class="nav-text">AWS Auto Scaling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">7.5.</span> <span class="nav-text">弹性伸缩最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E4%BC%98%E5%8C%96%E6%96%B9%E6%B3%95"><span class="nav-number">8.</span> <span class="nav-text">成本优化方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#reserved-instances%E9%A2%84%E7%95%99%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.1.</span> <span class="nav-text">Reserved Instances（预留实例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#spot-instances%E7%AB%9E%E4%BB%B7%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.2.</span> <span class="nav-text">Spot Instances（竞价实例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#savings-plans"><span class="nav-number">8.3.</span> <span class="nav-text">Savings Plans</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E4%BC%98%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="nav-number">8.4.</span> <span class="nav-text">成本优化脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">8.5.</span> <span class="nav-text">成本优化最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E4%B8%8E%E6%81%A2%E5%A4%8D"><span class="nav-number">9.</span> <span class="nav-text">故障排查与恢复</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%B5%81%E7%A8%8B"><span class="nav-number">9.1.</span> <span class="nav-text">故障排查流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E6%95%85%E9%9A%9C%E5%9C%BA%E6%99%AF"><span class="nav-number">9.2.</span> <span class="nav-text">常见故障场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E4%B8%8D%E5%8F%AF%E7%94%A8"><span class="nav-number">9.2.1.</span> <span class="nav-text">服务不可用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98"><span class="nav-number">9.2.2.</span> <span class="nav-text">性能问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%97%AE%E9%A2%98"><span class="nav-number">9.2.3.</span> <span class="nav-text">数据库问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E8%84%9A%E6%9C%AC"><span class="nav-number">9.3.</span> <span class="nav-text">故障恢复脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">9.4.</span> <span class="nav-text">故障排查最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sre-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">10.</span> <span class="nav-text">SRE 最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E9%A2%84%E7%AE%97error-budget"><span class="nav-number">10.1.</span> <span class="nav-text">错误预算（Error Budget）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sloservice-level-objective"><span class="nav-number">10.2.</span> <span class="nav-text">SLO（Service Level Objective）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sliservice-level-indicator"><span class="nav-number">10.3.</span> <span class="nav-text">SLI（Service Level Indicator）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sre-%E5%AE%9E%E8%B7%B5"><span class="nav-number">10.4.</span> <span class="nav-text">SRE 实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7-slo"><span class="nav-number">10.4.1.</span> <span class="nav-text">监控 SLO</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%94%99%E8%AF%AF%E9%A2%84%E7%AE%97%E7%AD%96%E7%95%A5"><span class="nav-number">10.4.2.</span> <span class="nav-text">错误预算策略</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sre-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-1"><span class="nav-number">10.5.</span> <span class="nav-text">SRE 最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#devops-%E5%B7%A5%E5%85%B7%E9%93%BE"><span class="nav-number">11.</span> <span class="nav-text">DevOps 工具链</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6"><span class="nav-number">11.1.</span> <span class="nav-text">版本控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cicd"><span class="nav-number">11.2.</span> <span class="nav-text">CI&#x2F;CD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%8C%96"><span class="nav-number">11.3.</span> <span class="nav-text">容器化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="nav-number">11.4.</span> <span class="nav-text">配置管理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%97%A5%E5%BF%97"><span class="nav-number">11.5.</span> <span class="nav-text">监控与日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8"><span class="nav-number">11.6.</span> <span class="nav-text">安全</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gitops-%E5%AE%9E%E8%B7%B5"><span class="nav-number">12.</span> <span class="nav-text">GitOps 实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#gitops-%E5%B7%A5%E4%BD%9C%E6%B5%81"><span class="nav-number">12.1.</span> <span class="nav-text">GitOps 工作流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#argocd"><span class="nav-number">12.2.</span> <span class="nav-text">ArgoCD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flux"><span class="nav-number">12.3.</span> <span class="nav-text">Flux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gitops-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">12.4.</span> <span class="nav-text">GitOps 最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="nav-number">13.</span> <span class="nav-text">实战案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E7%9B%91%E6%8E%A7%E4%BD%93%E7%B3%BB%E5%BB%BA%E8%AE%BE"><span class="nav-number">13.1.</span> <span class="nav-text">案例一：微服务架构的监控体系建设</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%91%E6%88%98"><span class="nav-number">13.1.1.</span> <span class="nav-text">挑战</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">13.1.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C"><span class="nav-number">13.1.3.</span> <span class="nav-text">效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8Ckubernetes-%E9%9B%86%E7%BE%A4%E7%9A%84%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E4%BC%98%E5%8C%96"><span class="nav-number">13.2.</span> <span class="nav-text">案例二：Kubernetes
集群的弹性伸缩优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%91%E6%88%98-1"><span class="nav-number">13.2.1.</span> <span class="nav-text">挑战</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-number">13.2.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C-1"><span class="nav-number">13.2.3.</span> <span class="nav-text">效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%E5%A4%9A%E7%8E%AF%E5%A2%83%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E5%8D%B3%E4%BB%A3%E7%A0%81%E5%AE%9E%E8%B7%B5"><span class="nav-number">13.3.</span> <span class="nav-text">案例三：多环境基础设施即代码实践</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8C%91%E6%88%98-2"><span class="nav-number">13.3.1.</span> <span class="nav-text">挑战</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="nav-number">13.3.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%88%E6%9E%9C-2"><span class="nav-number">13.3.3.</span> <span class="nav-text">效果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#qa-%E4%BA%91%E8%BF%90%E7%BB%B4%E4%B8%8Edevops%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">14.</span> <span class="nav-text">❓ Q&amp;A:
云运维与DevOps常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#q1-%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84%E7%9B%91%E6%8E%A7%E5%B7%A5%E5%85%B7"><span class="nav-number">14.1.</span> <span class="nav-text">Q1: 如何选择合适的监控工具？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q2-%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E5%90%88%E7%90%86%E7%9A%84%E5%91%8A%E8%AD%A6%E9%98%88%E5%80%BC"><span class="nav-number">14.2.</span> <span class="nav-text">Q2: 如何设置合理的告警阈值？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q3-kubernetes-%E4%B8%AD%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E9%9B%B6%E5%81%9C%E6%9C%BA%E9%83%A8%E7%BD%B2"><span class="nav-number">14.3.</span> <span class="nav-text">Q3: Kubernetes
中如何实现零停机部署？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q4-%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%E4%BA%91%E6%88%90%E6%9C%AC"><span class="nav-number">14.4.</span> <span class="nav-text">Q4: 如何优化云成本？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q5-%E5%A6%82%E4%BD%95%E5%BB%BA%E7%AB%8B%E6%9C%89%E6%95%88%E7%9A%84%E6%95%85%E9%9A%9C%E5%93%8D%E5%BA%94%E6%B5%81%E7%A8%8B"><span class="nav-number">14.5.</span> <span class="nav-text">Q5:
如何建立有效的故障响应流程？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q6-gitops-%E7%9B%B8%E6%AF%94%E4%BC%A0%E7%BB%9F%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E5%8A%BF"><span class="nav-number">14.6.</span> <span class="nav-text">Q6: GitOps
相比传统部署方式有什么优势？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q7-%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E5%90%88%E9%80%82%E7%9A%84-cicd-%E5%B7%A5%E5%85%B7"><span class="nav-number">14.7.</span> <span class="nav-text">Q7: 如何选择合适的 CI&#x2F;CD
工具？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q8-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E7%9A%84%E7%81%BE%E9%9A%BE%E6%81%A2%E5%A4%8D"><span class="nav-number">14.8.</span> <span class="nav-text">Q8:
如何实现基础设施的灾难恢复？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q9-%E5%A6%82%E4%BD%95%E5%BB%BA%E7%AB%8B%E6%9C%89%E6%95%88%E7%9A%84-slo"><span class="nav-number">14.9.</span> <span class="nav-text">Q9: 如何建立有效的 SLO？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q10-%E4%BA%91%E5%8E%9F%E7%94%9F%E6%9E%B6%E6%9E%84%E4%B8%8B%E7%9A%84%E8%BF%90%E7%BB%B4%E4%B8%8E%E4%BC%A0%E7%BB%9F%E8%BF%90%E7%BB%B4%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB"><span class="nav-number">14.10.</span> <span class="nav-text">Q10:
云原生架构下的运维与传统运维有什么区别？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">15.</span> <span class="nav-text">总结</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/lang-switch.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
