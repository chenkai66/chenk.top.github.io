<!DOCTYPE html>



<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Chen Kai">
    
    <title>
        
            推荐系统（十六）—— 工业级架构与最佳实践 |
        
        Chen Kai Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chenk.top","root":"/","language":"zh-CN","default_language":"zh-CN","languages":["zh-CN","en"],"path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Chen Kai Blog" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    
    
    
    
    

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Chen Kai Blog
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            
                            
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    <li class="menu-item lang-switch lang-switch-trigger" title="Language">
                        <i class="fas fa-globe"></i>
                    </li>
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item lang-switch-trigger"><i class="fas fa-globe"></i></div>
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    
                    
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    
    
    
    

    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">推荐系统（十六）—— 工业级架构与最佳实践</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Chen Kai</span>
                        
                            <span class="author-label">BOSS</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    
    
    
    
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2025-12-29 00:00:00</span>
        <span class="mobile">2025-12-29 00:00</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Recommendation-Systems/">Recommendation Systems</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Recommendation-Systems/">Recommendation Systems</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/Industrial-Practice/">Industrial Practice</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/System-Architecture/">System Architecture</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>10.3k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>48 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>推荐系统从实验室走向生产环境，面临的是完全不同的挑战。单机训练、离线评估的模型在真实流量面前往往不堪一击。工业级推荐系统需要处理每秒百万级的请求、毫秒级的响应延迟、实时特征更新、A/B
测试分流、模型热更新、异常监控等复杂问题。本文将深入探讨工业推荐系统的完整架构设计，从召回、粗排、精排到重排序的每一层，结合阿里巴巴
EasyRec、字节跳动 LONGER 等业界最佳实践，提供可落地的工程方案。</p>
<span id="more"></span>
<h2 id="工业推荐系统全景">工业推荐系统全景</h2>
<h3 id="系统架构概览">系统架构概览</h3>
<p>工业级推荐系统通常采用<strong>分层漏斗架构</strong>，从海量候选集中逐步筛选出最相关的物品。典型的架构包含以下层次：</p>
<ol type="1">
<li><strong>召回层（Recall）</strong>：从百万级候选集中快速召回数千个相关物品</li>
<li><strong>粗排层（Coarse
Ranking）</strong>：对召回结果进行初步排序，筛选出数百个候选</li>
<li><strong>精排层（Fine
Ranking）</strong>：使用复杂模型对候选进行精确打分</li>
<li><strong>重排序层（Re-ranking）</strong>：考虑多样性、新颖性、业务规则等因素进行最终调整</li>
</ol>
<p><strong>代码目的：</strong>
实现工业级推荐系统的主流程，展示分层漏斗架构的完整实现。工业级推荐系统通过多阶段逐步筛选，在保证推荐质量的同时满足毫秒级响应要求。</p>
<p><strong>整体思路：</strong> 1.
<strong>召回层</strong>：从百万级候选集中快速召回数千个相关物品，使用多种召回策略（协同过滤、内容、热门等）
2.
<strong>粗排层</strong>：使用轻量级模型快速筛选到数百个候选，平衡准确性和效率
3.
<strong>精排层</strong>：使用复杂模型精确打分，考虑用户特征、物品特征、上下文等
4.
<strong>重排序层</strong>：考虑多样性、新颖性、业务规则等因素进行最终调整</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IndustrialRecommendationSystem</span>:</span><br><span class="line">    <span class="string">"""工业级推荐系统主流程"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.recall_engine = MultiChannelRecall()</span><br><span class="line">        self.coarse_ranker = CoarseRanker()</span><br><span class="line">        self.fine_ranker = FineRanker()</span><br><span class="line">        self.re_ranker = ReRanker()</span><br><span class="line">        self.feature_service = FeatureService()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recommend</span>(<span class="params">self, user_id, context=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">"""推荐主流程"""</span></span><br><span class="line">        <span class="comment"># 1. 召回：从百万级候选集中召回数千个</span></span><br><span class="line">        recall_items = self.recall_engine.recall(user_id, top_k=<span class="number">5000</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 粗排：快速筛选到数百个</span></span><br><span class="line">        coarse_items = self.coarse_ranker.rank(</span><br><span class="line">            recall_items, user_id, top_k=<span class="number">500</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 精排：精确打分</span></span><br><span class="line">        fine_items = self.fine_ranker.rank(</span><br><span class="line">            coarse_items, user_id, context, top_k=<span class="number">100</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. 重排序：考虑多样性等</span></span><br><span class="line">        final_items = self.re_ranker.re_rank(</span><br><span class="line">            fine_items, user_id, top_k=<span class="number">20</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> final_items</span><br></pre></td></tr></table></figure>
<h3 id="性能指标与-sla">性能指标与 SLA</h3>
<p>工业系统需要明确的性能指标：</p>
<ul>
<li><strong>QPS（每秒查询数）</strong>：通常需要支持 10K+ QPS</li>
<li><strong>P99 延迟</strong>：召回层 &lt; 50ms，粗排 &lt; 20ms，精排
&lt; 100ms</li>
<li><strong>可用性</strong>：99.9%+ 可用性，故障自动降级</li>
<li><strong>吞吐量</strong>：支持峰值流量 3-5 倍扩容</li>
</ul>
<p><strong>代码目的：</strong>
实现性能监控系统，实时监控推荐系统各阶段的延迟指标，确保满足SLA要求。工业级系统需要持续监控P99延迟、QPS等关键指标，及时发现性能问题。</p>
<p><strong>整体思路：</strong> 1.
<strong>延迟记录</strong>：记录召回、粗排、精排、总延迟等各阶段的耗时 2.
<strong>P99监控</strong>：计算P99延迟，及时发现性能瓶颈 3.
<strong>告警机制</strong>：当延迟超过阈值时触发告警，支持自动降级</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceMonitor</span>:</span><br><span class="line">    <span class="string">"""性能监控"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.metrics = {</span><br><span class="line">            <span class="string">'recall_latency'</span>: [],</span><br><span class="line">            <span class="string">'coarse_latency'</span>: [],</span><br><span class="line">            <span class="string">'fine_latency'</span>: [],</span><br><span class="line">            <span class="string">'total_latency'</span>: []</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_latency</span>(<span class="params">self, stage, latency_ms</span>):</span><br><span class="line">        <span class="string">"""记录延迟"""</span></span><br><span class="line">        self.metrics[<span class="string">f'<span class="subst">{stage}</span>_latency'</span>].append(latency_ms)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># P99 延迟监控</span></span><br><span class="line">        <span class="keyword">if</span> stage == <span class="string">'total'</span>:</span><br><span class="line">            p99 = np.percentile(self.metrics[<span class="string">'total_latency'</span>], <span class="number">99</span>)</span><br><span class="line">            <span class="keyword">if</span> p99 &gt; <span class="number">200</span>:  <span class="comment"># 超过 200ms 告警</span></span><br><span class="line">                self.alert(<span class="string">f'P99 latency exceeds threshold: <span class="subst">{p99}</span>ms'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="召回层设计多路召回策略">召回层设计：多路召回策略</h2>
<p>召回层是推荐系统的第一道防线，需要在极短时间内从百万级候选集中找出数千个相关物品。单一召回策略往往无法覆盖所有场景，因此工业系统普遍采用<strong>多路召回</strong>策略。</p>
<h3 id="协同过滤召回">协同过滤召回</h3>
<p>协同过滤（Collaborative
Filtering）是最经典的召回方法，包括用户协同过滤（UserCF）和物品协同过滤（ItemCF）。</p>
<h4 id="用户协同过滤usercf">用户协同过滤（UserCF）</h4>
<p>UserCF 基于"相似用户喜欢相似物品"的假设：</p>
<p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.76ex;" xmlns="http://www.w3.org/2000/svg" width="32.953ex" height="6.163ex" role="img" focusable="false" viewbox="0 -1504.2 14565.2 2724.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"/></g><g data-mml-node="mi" transform="translate(469,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(814,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1692,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(2081,0)"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(2980,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="msub" transform="translate(3424.6,0)"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(4370.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(5037.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(6093.5,0)"><g data-mml-node="mrow" transform="translate(813.5,754.2)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(1166,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1555,0)"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(2454,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(3065.2,0)"><path data-c="2229" d="M88 -21T75 -21T55 -7V200Q55 231 55 280Q56 414 60 428Q61 430 61 431Q77 500 152 549T332 598Q443 598 522 544T610 405Q611 399 611 194V-7Q604 -22 591 -22Q582 -22 572 -9L570 405Q563 433 556 449T529 485Q498 519 445 538T334 558Q251 558 179 518T96 401Q95 396 95 193V-7Q88 -21 75 -21Z"/></g><g data-mml-node="mi" transform="translate(3954.4,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(4842.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(5231.4,0)"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(6177.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(6566.7,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g></g><g data-mml-node="msqrt" transform="translate(220,-915.4)"><g transform="translate(1020,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(1166,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1555,0)"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(2454,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2843,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mo" transform="translate(3343.2,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/></g><g data-mml-node="mo" transform="translate(3843.4,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(4121.4,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(5009.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(5398.4,0)"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(6344.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(6733.7,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g></g><g data-mml-node="mo" transform="translate(0,45.4)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="7011.7" height="60" x="1020" y="835.4"/></g><rect width="8231.7" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span></p>
<p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.803ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2565 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(888,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1277,0)"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(2176,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span> 表示用户 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.034ex" height="1.357ex" role="img" focusable="false" viewbox="0 -442 899 599.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g></g></g></svg></mjx-container></span> 交互过的物品集合。</p>
<p><strong>代码目的：</strong>
实现用户协同过滤（UserCF）召回算法，基于"相似用户喜欢相似物品"的假设，从百万级候选集中快速召回相关物品。UserCF是工业级推荐系统中最常用的召回策略之一。</p>
<p><strong>整体思路：</strong> 1.
<strong>相似度计算</strong>：使用余弦相似度计算用户之间的相似度 2.
<strong>相似用户查找</strong>：找到与目标用户最相似的top-k个用户 3.
<strong>物品推荐</strong>：基于相似用户的历史行为，计算物品推荐分数 4.
<strong>去重排序</strong>：去除用户已交互的物品，按分数排序返回top-n</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserCFRecall</span>:</span><br><span class="line">    <span class="string">"""用户协同过滤召回"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_item_matrix, top_k=<span class="number">100</span></span>):</span><br><span class="line">        self.user_item_matrix = user_item_matrix  <span class="comment"># 用户-物品矩阵</span></span><br><span class="line">        self.top_k = top_k</span><br><span class="line">        self.user_similarity = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_user_similarity</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算用户相似度矩阵"""</span></span><br><span class="line">        <span class="comment"># 使用余弦相似度</span></span><br><span class="line">        <span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line">        self.user_similarity = cosine_similarity(</span><br><span class="line">            self.user_item_matrix</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> self.user_similarity</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_n=<span class="number">500</span></span>):</span><br><span class="line">        <span class="string">"""召回 top_n 个物品"""</span></span><br><span class="line">        <span class="keyword">if</span> self.user_similarity <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.compute_user_similarity()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找到最相似的 top_k 个用户</span></span><br><span class="line">        similar_users = np.argsort(</span><br><span class="line">            self.user_similarity[user_id]</span><br><span class="line">        )[-self.top_k-<span class="number">1</span>:-<span class="number">1</span>][::-<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算推荐分数</span></span><br><span class="line">        scores = {}</span><br><span class="line">        user_items = <span class="built_in">set</span>(self.user_item_matrix[user_id].nonzero()[<span class="number">1</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> similar_user <span class="keyword">in</span> similar_users:</span><br><span class="line">            similarity = self.user_similarity[user_id, similar_user]</span><br><span class="line">            similar_user_items = self.user_item_matrix[similar_user].nonzero()[<span class="number">1</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> item_id <span class="keyword">in</span> similar_user_items:</span><br><span class="line">                <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> user_items:</span><br><span class="line">                    scores[item_id] = scores.get(item_id, <span class="number">0</span>) + similarity</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回 top_n</span></span><br><span class="line">        top_items = <span class="built_in">sorted</span>(scores.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, score <span class="keyword">in</span> top_items[:top_n]]</span><br></pre></td></tr></table></figure>
<h4 id="物品协同过滤itemcf">物品协同过滤（ItemCF）</h4>
<p>ItemCF 基于"喜欢物品 A 的用户也喜欢物品
B"的假设，通常效果更好且更稳定：</p>
<p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.76ex;" xmlns="http://www.w3.org/2000/svg" width="30.914ex" height="6.163ex" role="img" focusable="false" viewbox="0 -1504.2 13664.1 2724.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"/></g><g data-mml-node="mi" transform="translate(469,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(814,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1692,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(2081,0)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(2800.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="msub" transform="translate(3245,0)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g><g data-mml-node="mo" transform="translate(4041.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(4708.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mfrac" transform="translate(5764,0)"><g data-mml-node="mrow" transform="translate(813.5,754.2)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"/></g><g data-mml-node="mo" transform="translate(1045,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1434,0)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(2153.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2764.6,0)"><path data-c="2229" d="M88 -21T75 -21T55 -7V200Q55 231 55 280Q56 414 60 428Q61 430 61 431Q77 500 152 549T332 598Q443 598 522 544T610 405Q611 399 611 194V-7Q604 -22 591 -22Q582 -22 572 -9L570 405Q563 433 556 449T529 485Q498 519 445 538T334 558Q251 558 179 518T96 401Q95 396 95 193V-7Q88 -21 75 -21Z"/></g><g data-mml-node="mi" transform="translate(3653.8,0)"><path data-c="1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"/></g><g data-mml-node="mo" transform="translate(4420.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(4809.8,0)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g><g data-mml-node="mo" transform="translate(5606.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(5995.2,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g></g><g data-mml-node="msqrt" transform="translate(220,-915.4)"><g transform="translate(1020,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(278,0)"><path data-c="1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"/></g><g data-mml-node="mo" transform="translate(1045,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1434,0)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(2153.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2542.3,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mo" transform="translate(3042.6,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"/></g><g data-mml-node="mo" transform="translate(3542.8,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="mi" transform="translate(3820.8,0)"><path data-c="1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"/></g><g data-mml-node="mo" transform="translate(4587.8,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(4976.8,0)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g><g data-mml-node="mo" transform="translate(5773.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(6162.2,0) translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g></g><g data-mml-node="mo" transform="translate(0,45.4)"><path data-c="221A" d="M263 249Q264 249 315 130T417 -108T470 -228L725 302Q981 837 982 839Q989 850 1001 850Q1008 850 1013 844T1020 832V826L741 243Q645 43 540 -176Q479 -303 469 -324T453 -348Q449 -350 436 -350L424 -349L315 -96Q206 156 205 156L171 130Q138 104 137 104L111 130L263 249Z"/></g><rect width="6440.2" height="60" x="1020" y="835.4"/></g><rect width="7660.2" height="60" x="120" y="220"/></g></g></g></svg></mjx-container></span></p>
<p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="5.123ex" height="2.363ex" role="img" focusable="false" viewbox="0 -750 2264.3 1044.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D448" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"/></g><g data-mml-node="mo" transform="translate(767,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1156,0)"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(1875.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span> 表示喜欢物品 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="1.627ex" height="2.161ex" role="img" focusable="false" viewbox="0 -661 719.3 955.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(378,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container></span> 的用户集合。</p>
<p><strong>代码目的：</strong>
实现物品协同过滤（ItemCF）召回算法，基于"喜欢物品A的用户也喜欢物品B"的假设进行召回。ItemCF通常比UserCF效果更好且更稳定，是工业级推荐系统的核心召回策略。</p>
<p><strong>整体思路：</strong> 1.
<strong>物品相似度计算</strong>：转置用户-物品矩阵，计算物品之间的余弦相似度
2. <strong>历史物品扩展</strong>：基于用户历史交互的物品，找到相似物品
3.
<strong>加权评分</strong>：考虑用户对历史物品的偏好强度，加权计算推荐分数
4. <strong>排序返回</strong>：按分数排序，返回top-n个物品</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ItemCFRecall</span>:</span><br><span class="line">    <span class="string">"""物品协同过滤召回"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_item_matrix, top_k=<span class="number">100</span></span>):</span><br><span class="line">        self.user_item_matrix = user_item_matrix</span><br><span class="line">        self.top_k = top_k</span><br><span class="line">        self.item_similarity = <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compute_item_similarity</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算物品相似度矩阵"""</span></span><br><span class="line">        <span class="comment"># 转置矩阵，计算物品相似度</span></span><br><span class="line">        item_user_matrix = self.user_item_matrix.T</span><br><span class="line">        <span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line">        self.item_similarity = cosine_similarity(item_user_matrix)</span><br><span class="line">        <span class="keyword">return</span> self.item_similarity</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_n=<span class="number">500</span></span>):</span><br><span class="line">        <span class="string">"""基于用户历史行为召回"""</span></span><br><span class="line">        <span class="comment"># 用户历史交互物品</span></span><br><span class="line">        user_items = self.user_item_matrix[user_id].nonzero()[<span class="number">1</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(user_items) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算每个候选物品的得分</span></span><br><span class="line">        scores = {}</span><br><span class="line">        <span class="keyword">for</span> item_id <span class="keyword">in</span> user_items:</span><br><span class="line">            <span class="comment"># 找到与 item_id 最相似的 top_k 个物品</span></span><br><span class="line">            similar_items = np.argsort(</span><br><span class="line">                self.item_similarity[item_id]</span><br><span class="line">            )[-self.top_k-<span class="number">1</span>:-<span class="number">1</span>][::-<span class="number">1</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> similar_item <span class="keyword">in</span> similar_items:</span><br><span class="line">                <span class="keyword">if</span> similar_item <span class="keyword">not</span> <span class="keyword">in</span> user_items:</span><br><span class="line">                    similarity = self.item_similarity[item_id, similar_item]</span><br><span class="line">                    <span class="comment"># 考虑用户对 item_id 的偏好强度</span></span><br><span class="line">                    user_preference = self.user_item_matrix[user_id, item_id]</span><br><span class="line">                    scores[similar_item] = scores.get(</span><br><span class="line">                        similar_item, <span class="number">0</span></span><br><span class="line">                    ) + similarity * user_preference</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 返回 top_n</span></span><br><span class="line">        top_items = <span class="built_in">sorted</span>(scores.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, score <span class="keyword">in</span> top_items[:top_n]]</span><br></pre></td></tr></table></figure>
<h3 id="内容召回">内容召回</h3>
<p>内容召回基于物品的文本、图像、类别等特征，计算用户与物品的内容相似度。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ContentBasedRecall</span>:</span><br><span class="line">    <span class="string">"""基于内容的召回"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, item_features, user_profile</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        item_features: dict{item_id: feature_vector}</span></span><br><span class="line"><span class="string">        user_profile: dict{user_id: feature_vector}</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.item_features = item_features</span><br><span class="line">        self.user_profile = user_profile</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_n=<span class="number">500</span></span>):</span><br><span class="line">        <span class="string">"""基于内容相似度召回"""</span></span><br><span class="line">        <span class="keyword">if</span> user_id <span class="keyword">not</span> <span class="keyword">in</span> self.user_profile:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        </span><br><span class="line">        user_vector = self.user_profile[user_id]</span><br><span class="line">        scores = {}</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> item_id, item_vector <span class="keyword">in</span> self.item_features.items():</span><br><span class="line">            <span class="comment"># 计算余弦相似度</span></span><br><span class="line">            similarity = cosine_similarity(</span><br><span class="line">                user_vector.reshape(<span class="number">1</span>, -<span class="number">1</span>),</span><br><span class="line">                item_vector.reshape(<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">            )[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">            scores[item_id] = similarity</span><br><span class="line">        </span><br><span class="line">        top_items = <span class="built_in">sorted</span>(scores.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, score <span class="keyword">in</span> top_items[:top_n]]</span><br></pre></td></tr></table></figure>
<h3 id="热门召回">热门召回</h3>
<p>热门召回保证系统的覆盖度和新鲜度，避免过度个性化导致的"信息茧房"。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PopularRecall</span>:</span><br><span class="line">    <span class="string">"""热门物品召回"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, time_window_hours=<span class="number">24</span></span>):</span><br><span class="line">        self.time_window_hours = time_window_hours</span><br><span class="line">        self.popular_items = []</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_popular_items</span>(<span class="params">self, click_logs</span>):</span><br><span class="line">        <span class="string">"""更新热门物品列表"""</span></span><br><span class="line">        <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">        <span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta</span><br><span class="line">        </span><br><span class="line">        cutoff_time = datetime.now() - timedelta(</span><br><span class="line">            hours=self.time_window_hours</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计时间窗口内的点击量</span></span><br><span class="line">        recent_clicks = click_logs[</span><br><span class="line">            click_logs[<span class="string">'timestamp'</span>] &gt;= cutoff_time</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        item_counts = recent_clicks.groupby(<span class="string">'item_id'</span>).size()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 考虑时间衰减</span></span><br><span class="line">        item_scores = {}</span><br><span class="line">        <span class="keyword">for</span> item_id, count <span class="keyword">in</span> item_counts.items():</span><br><span class="line">            <span class="comment"># 简单的时间衰减：越近的点击权重越高</span></span><br><span class="line">            latest_time = recent_clicks[</span><br><span class="line">                recent_clicks[<span class="string">'item_id'</span>] == item_id</span><br><span class="line">            ][<span class="string">'timestamp'</span>].<span class="built_in">max</span>()</span><br><span class="line">            </span><br><span class="line">            hours_ago = (datetime.now() - latest_time).total_seconds() / <span class="number">3600</span></span><br><span class="line">            decay = np.exp(-hours_ago / self.time_window_hours)</span><br><span class="line">            item_scores[item_id] = count * decay</span><br><span class="line">        </span><br><span class="line">        self.popular_items = <span class="built_in">sorted</span>(</span><br><span class="line">            item_scores.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_n=<span class="number">200</span></span>):</span><br><span class="line">        <span class="string">"""召回热门物品"""</span></span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, score <span class="keyword">in</span> self.popular_items[:top_n]]</span><br></pre></td></tr></table></figure>
<h3 id="实时召回">实时召回</h3>
<p>实时召回基于用户最近的交互行为，捕捉用户的即时兴趣变化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealTimeRecall</span>:</span><br><span class="line">    <span class="string">"""实时召回"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, time_window_minutes=<span class="number">30</span></span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.time_window_minutes = time_window_minutes</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_user_action</span>(<span class="params">self, user_id, item_id, action_type=<span class="string">'click'</span></span>):</span><br><span class="line">        <span class="string">"""记录用户行为"""</span></span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        key = <span class="string">f"realtime:user:<span class="subst">{user_id}</span>"</span></span><br><span class="line">        timestamp = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 存储到 Redis，使用 sorted set 按时间排序</span></span><br><span class="line">        self.redis.zadd(</span><br><span class="line">            key, </span><br><span class="line">            {<span class="string">f"<span class="subst">{item_id}</span>:<span class="subst">{action_type}</span>"</span>: timestamp}</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 只保留最近 time_window_minutes 的行为</span></span><br><span class="line">        cutoff_time = timestamp - self.time_window_minutes * <span class="number">60</span></span><br><span class="line">        self.redis.zremrangebyscore(key, <span class="number">0</span>, cutoff_time)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_n=<span class="number">200</span></span>):</span><br><span class="line">        <span class="string">"""基于实时行为召回"""</span></span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        key = <span class="string">f"realtime:user:<span class="subst">{user_id}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取最近的行为</span></span><br><span class="line">        cutoff_time = time.time() - self.time_window_minutes * <span class="number">60</span></span><br><span class="line">        recent_actions = self.redis.zrangebyscore(</span><br><span class="line">            key, cutoff_time, time.time(), withscores=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> recent_actions:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基于实时行为找到相似物品（简化版）</span></span><br><span class="line">        <span class="comment"># 实际中可以使用向量检索或图遍历</span></span><br><span class="line">        recent_items = <span class="built_in">set</span>()</span><br><span class="line">        <span class="keyword">for</span> action_data, timestamp <span class="keyword">in</span> recent_actions:</span><br><span class="line">            item_id = action_data.split(<span class="string">':'</span>)[<span class="number">0</span>]</span><br><span class="line">            recent_items.add(<span class="built_in">int</span>(item_id))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 这里简化处理，实际应该基于物品相似度扩展</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(recent_items)[:top_n]</span><br></pre></td></tr></table></figure>
<h3 id="多路召回融合">多路召回融合</h3>
<p>多路召回的结果需要融合，常见策略包括：</p>
<ol type="1">
<li><strong>加权融合</strong>：不同召回通道设置不同权重</li>
<li><strong>去重合并</strong>：相同物品取最高分</li>
<li><strong>多样性保证</strong>：确保各通道都有一定比例</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MultiChannelRecall</span>:</span><br><span class="line">    <span class="string">"""多路召回融合"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.recall_channels = {</span><br><span class="line">            <span class="string">'itemcf'</span>: ItemCFRecall(...),</span><br><span class="line">            <span class="string">'content'</span>: ContentBasedRecall(...),</span><br><span class="line">            <span class="string">'popular'</span>: PopularRecall(...),</span><br><span class="line">            <span class="string">'realtime'</span>: RealTimeRecall(...)</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 各通道权重</span></span><br><span class="line">        self.weights = {</span><br><span class="line">            <span class="string">'itemcf'</span>: <span class="number">0.4</span>,</span><br><span class="line">            <span class="string">'content'</span>: <span class="number">0.2</span>,</span><br><span class="line">            <span class="string">'popular'</span>: <span class="number">0.2</span>,</span><br><span class="line">            <span class="string">'realtime'</span>: <span class="number">0.2</span></span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 各通道召回数量</span></span><br><span class="line">        self.recall_sizes = {</span><br><span class="line">            <span class="string">'itemcf'</span>: <span class="number">2000</span>,</span><br><span class="line">            <span class="string">'content'</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">'popular'</span>: <span class="number">1000</span>,</span><br><span class="line">            <span class="string">'realtime'</span>: <span class="number">1000</span></span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall</span>(<span class="params">self, user_id, top_k=<span class="number">5000</span></span>):</span><br><span class="line">        <span class="string">"""多路召回并融合"""</span></span><br><span class="line">        all_items = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 各通道召回</span></span><br><span class="line">        <span class="keyword">for</span> channel_name, recaller <span class="keyword">in</span> self.recall_channels.items():</span><br><span class="line">            items = recaller.recall(</span><br><span class="line">                user_id, </span><br><span class="line">                top_n=self.recall_sizes[channel_name]</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 归一化分数并加权</span></span><br><span class="line">            <span class="keyword">if</span> items:</span><br><span class="line">                max_score = <span class="built_in">len</span>(items)</span><br><span class="line">                <span class="keyword">for</span> rank, item_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(items):</span><br><span class="line">                    normalized_score = (max_score - rank) / max_score</span><br><span class="line">                    weighted_score = normalized_score * self.weights[channel_name]</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> all_items:</span><br><span class="line">                        all_items[item_id] = <span class="number">0</span></span><br><span class="line">                    all_items[item_id] += weighted_score</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 去重并排序</span></span><br><span class="line">        sorted_items = <span class="built_in">sorted</span>(</span><br><span class="line">            all_items.items(), </span><br><span class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], </span><br><span class="line">            reverse=<span class="literal">True</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [item_id <span class="keyword">for</span> item_id, score <span class="keyword">in</span> sorted_items[:top_k]]</span><br></pre></td></tr></table></figure>
<h2 id="粗排与精排">粗排与精排</h2>
<h3 id="粗排层设计">粗排层设计</h3>
<p>粗排层需要在召回和精排之间做平衡：既要保证效果，又要控制计算成本。粗排通常使用<strong>轻量级模型</strong>，如双塔模型、浅层神经网络。</p>
<h4 id="双塔模型粗排">双塔模型粗排</h4>
<p>双塔模型将用户和物品分别编码为向量，通过向量内积计算匹配分数：</p>
<p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="19.888ex" height="2.583ex" role="img" focusable="false" viewbox="0 -891.7 8790.4 1141.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"/></g><g data-mml-node="mo" transform="translate(469,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(858,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1430,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mi" transform="translate(1874.7,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2219.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2886.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3942.2,0)"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mi" transform="translate(523,-150) scale(0.707)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(4919.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(5308.7,0)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msup" transform="translate(5880.7,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mi" transform="translate(422,413) scale(0.707)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g></g><g data-mml-node="msub" transform="translate(6850.5,0)"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mi" transform="translate(523,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(7667.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(8056.4,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(8401.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span></p>
<p>其中 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="2.211ex" height="2.059ex" role="img" focusable="false" viewbox="0 -705 977.5 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mi" transform="translate(523,-150) scale(0.707)"><path data-c="1D462" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></g></svg></mjx-container></span> 和 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.848ex" height="2.059ex" role="img" focusable="false" viewbox="0 -705 817 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"/></g><g data-mml-node="mi" transform="translate(523,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g></g></g></svg></mjx-container></span> 分别是用户塔和物品塔的编码函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CoarseRankerDualTower</span>(nn.Module):</span><br><span class="line">    <span class="string">"""双塔模型粗排"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_feature_dim, item_feature_dim, embedding_dim=<span class="number">128</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 用户塔</span></span><br><span class="line">        self.user_tower = nn.Sequential(</span><br><span class="line">            nn.Linear(user_feature_dim, <span class="number">256</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(<span class="number">256</span>, embedding_dim)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 物品塔</span></span><br><span class="line">        self.item_tower = nn.Sequential(</span><br><span class="line">            nn.Linear(item_feature_dim, <span class="number">256</span>),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(<span class="number">256</span>, embedding_dim)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, user_features, item_features</span>):</span><br><span class="line">        <span class="string">"""前向传播"""</span></span><br><span class="line">        user_emb = self.user_tower(user_features)</span><br><span class="line">        item_emb = self.item_tower(item_features)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># L2 归一化</span></span><br><span class="line">        user_emb = nn.functional.normalize(user_emb, p=<span class="number">2</span>, dim=<span class="number">1</span>)</span><br><span class="line">        item_emb = nn.functional.normalize(item_emb, p=<span class="number">2</span>, dim=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 内积计算相似度</span></span><br><span class="line">        score = torch.<span class="built_in">sum</span>(user_emb * item_emb, dim=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> score</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rank</span>(<span class="params">self, user_features, item_features_list, top_k=<span class="number">500</span></span>):</span><br><span class="line">        <span class="string">"""批量排序"""</span></span><br><span class="line">        self.<span class="built_in">eval</span>()</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            user_emb = self.user_tower(user_features)</span><br><span class="line">            user_emb = nn.functional.normalize(user_emb, p=<span class="number">2</span>, dim=<span class="number">1</span>)</span><br><span class="line">            </span><br><span class="line">            scores = []</span><br><span class="line">            batch_size = <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(item_features_list), batch_size):</span><br><span class="line">                batch_items = item_features_list[i:i+batch_size]</span><br><span class="line">                item_batch = torch.stack(batch_items)</span><br><span class="line">                </span><br><span class="line">                item_emb = self.item_tower(item_batch)</span><br><span class="line">                item_emb = nn.functional.normalize(item_emb, p=<span class="number">2</span>, dim=<span class="number">1</span>)</span><br><span class="line">                </span><br><span class="line">                batch_scores = torch.matmul(user_emb, item_emb.T)</span><br><span class="line">                scores.extend(batch_scores.cpu().numpy().tolist()[<span class="number">0</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 返回 top_k</span></span><br><span class="line">            top_indices = np.argsort(scores)[-top_k:][::-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">return</span> top_indices</span><br></pre></td></tr></table></figure>
<h4 id="粗排优化技巧">粗排优化技巧</h4>
<ol type="1">
<li><strong>特征缓存</strong>：物品特征可以离线计算并缓存</li>
<li><strong>批量计算</strong>：使用 GPU 批量计算提高吞吐</li>
<li><strong>模型量化</strong>：使用 INT8 量化减少内存和计算</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OptimizedCoarseRanker</span>:</span><br><span class="line">    <span class="string">"""优化的粗排器"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model, item_feature_cache</span>):</span><br><span class="line">        self.model = model</span><br><span class="line">        self.item_feature_cache = item_feature_cache  <span class="comment"># 预计算的物品特征</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">rank</span>(<span class="params">self, user_id, item_ids, top_k=<span class="number">500</span></span>):</span><br><span class="line">        <span class="string">"""优化的排序流程"""</span></span><br><span class="line">        <span class="comment"># 1. 获取用户特征（实时）</span></span><br><span class="line">        user_features = self.get_user_features(user_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 批量获取物品特征（从缓存）</span></span><br><span class="line">        item_features = [</span><br><span class="line">            self.item_feature_cache[item_id] </span><br><span class="line">            <span class="keyword">for</span> item_id <span class="keyword">in</span> item_ids</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 批量计算分数（GPU）</span></span><br><span class="line">        scores = self.model.batch_score(</span><br><span class="line">            user_features, </span><br><span class="line">            item_features</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. Top-K 选择</span></span><br><span class="line">        top_indices = np.argsort(scores)[-top_k:][::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> [item_ids[i] <span class="keyword">for</span> i <span class="keyword">in</span> top_indices]</span><br></pre></td></tr></table></figure>
<h3 id="精排层设计">精排层设计</h3>
<p>精排层使用<strong>复杂模型</strong>进行精确打分，常见模型包括
Wide&amp;Deep、DeepFM、DCN、xDeepFM 等。</p>
<h4 id="deepfm-精排模型">DeepFM 精排模型</h4>
<p>DeepFM 结合了因子分解机（FM）和深度神经网络：</p>
<p><span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -3.014ex;" xmlns="http://www.w3.org/2000/svg" width="50.88ex" height="6.549ex" role="img" focusable="false" viewbox="0 -1562.5 22489 2894.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(767.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(1823.6,0)"><g data-mml-node="mi"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"/></g><g data-mml-node="mn" transform="translate(749,-150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g><g data-mml-node="mo" transform="translate(3198.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="munderover" transform="translate(4198.6,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"/></g><g data-mml-node="TeXAtom" transform="translate(148.2,-1087.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="mi" transform="translate(509.9,1150) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="msub" transform="translate(5809.2,0)"><g data-mml-node="mi"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"/></g><g data-mml-node="mi" transform="translate(749,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="msub" transform="translate(6852.2,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(7973.3,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="munderover" transform="translate(8973.6,0)"><g data-mml-node="mo"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"/></g><g data-mml-node="TeXAtom" transform="translate(148.2,-1087.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="mi" transform="translate(509.9,1150) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="munderover" transform="translate(10584.2,0)"><g data-mml-node="mo" transform="translate(272.5,0)"><path data-c="2211" d="M60 948Q63 950 665 950H1267L1325 815Q1384 677 1388 669H1348L1341 683Q1320 724 1285 761Q1235 809 1174 838T1033 881T882 898T699 902H574H543H251L259 891Q722 258 724 252Q725 250 724 246Q721 243 460 -56L196 -356Q196 -357 407 -357Q459 -357 548 -357T676 -358Q812 -358 896 -353T1063 -332T1204 -283T1307 -196Q1328 -170 1348 -124H1388Q1388 -125 1381 -145T1356 -210T1325 -294L1267 -449L666 -450Q64 -450 61 -448Q55 -446 55 -439Q55 -437 57 -433L590 177Q590 178 557 222T452 366T322 544L56 909L55 924Q55 945 60 948Z"/></g><g data-mml-node="TeXAtom" transform="translate(0,-1087.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(1190,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1535,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(2313,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="mi" transform="translate(782.4,1150) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(12573.3,0)"><path data-c="27E8" d="M333 -232Q332 -239 327 -244T313 -250Q303 -250 296 -240Q293 -233 202 6T110 250T201 494T296 740Q299 745 306 749L309 750Q312 750 313 750Q331 750 333 732Q333 727 243 489Q152 252 152 250T243 11Q333 -227 333 -232Z"/></g><g data-mml-node="msub" transform="translate(12962.3,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(13774.3,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="msub" transform="translate(14218.9,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(15078.3,0)"><path data-c="27E9" d="M55 732Q56 739 61 744T75 750Q85 750 92 740Q95 733 186 494T278 250T187 6T92 -240Q85 -250 75 -250Q67 -250 62 -245T55 -232Q55 -227 145 11Q236 248 236 250T145 489Q55 727 55 732Z"/></g><g data-mml-node="msub" transform="translate(15467.3,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="msub" transform="translate(16366.2,0)"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(17534.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(18535,0)"><path data-c="1D437" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"/></g><g data-mml-node="mi" transform="translate(19363,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mi" transform="translate(20251,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(21139,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(21528,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g><g data-mml-node="mo" transform="translate(22100,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DeepFM</span>(nn.Module):</span><br><span class="line">    <span class="string">"""DeepFM 模型"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, field_dims, embed_dim=<span class="number">16</span>, mlp_dims=[<span class="number">128</span>, <span class="number">64</span>]</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.field_dims = field_dims</span><br><span class="line">        self.embed_dim = embed_dim</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 线性部分</span></span><br><span class="line">        self.linear = FeaturesLinear(field_dims)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FM 部分</span></span><br><span class="line">        self.fm = FactorizationMachine(reduce_sum=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 嵌入层</span></span><br><span class="line">        self.embedding = FeaturesEmbedding(field_dims, embed_dim)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Deep 部分</span></span><br><span class="line">        input_dim = <span class="built_in">len</span>(field_dims) * embed_dim</span><br><span class="line">        self.mlp = MultiLayerPerceptron(input_dim, mlp_dims, dropout=<span class="number">0.2</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        x: (batch_size, num_fields)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># 线性部分</span></span><br><span class="line">        linear_score = self.linear(x)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># FM 部分</span></span><br><span class="line">        x_emb = self.embedding(x)</span><br><span class="line">        fm_score = self.fm(x_emb)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Deep 部分</span></span><br><span class="line">        deep_input = x_emb.view(x_emb.size(<span class="number">0</span>), -<span class="number">1</span>)</span><br><span class="line">        deep_score = self.mlp(deep_input)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 组合</span></span><br><span class="line">        score = linear_score + fm_score + deep_score</span><br><span class="line">        <span class="keyword">return</span> torch.sigmoid(score)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FactorizationMachine</span>(nn.Module):</span><br><span class="line">    <span class="string">"""因子分解机"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, reduce_sum=<span class="literal">True</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.reduce_sum = reduce_sum</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        x: (batch_size, num_fields, embed_dim)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        square_of_sum = torch.<span class="built_in">sum</span>(x, dim=<span class="number">1</span>) ** <span class="number">2</span></span><br><span class="line">        sum_of_square = torch.<span class="built_in">sum</span>(x ** <span class="number">2</span>, dim=<span class="number">1</span>)</span><br><span class="line">        ix = square_of_sum - sum_of_square</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.reduce_sum:</span><br><span class="line">            ix = torch.<span class="built_in">sum</span>(ix, dim=<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.5</span> * ix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MultiLayerPerceptron</span>(nn.Module):</span><br><span class="line">    <span class="string">"""多层感知机"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_dim, hidden_dims, dropout=<span class="number">0.0</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        layers = []</span><br><span class="line">        dims = [input_dim] + hidden_dims</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(dims) - <span class="number">1</span>):</span><br><span class="line">            layers.append(nn.Linear(dims[i], dims[i+<span class="number">1</span>]))</span><br><span class="line">            layers.append(nn.ReLU())</span><br><span class="line">            <span class="keyword">if</span> dropout &gt; <span class="number">0</span>:</span><br><span class="line">                layers.append(nn.Dropout(dropout))</span><br><span class="line">        </span><br><span class="line">        self.mlp = nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="keyword">return</span> self.mlp(x)</span><br></pre></td></tr></table></figure>
<h4 id="特征工程">特征工程</h4>
<p>精排模型的效果很大程度上依赖于特征质量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FeatureEngineering</span>:</span><br><span class="line">    <span class="string">"""特征工程"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.feature_encoders = {}</span><br><span class="line">        self.statistics = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_user_features</span>(<span class="params">self, user_id, user_profile, behavior_history</span>):</span><br><span class="line">        <span class="string">"""构建用户特征"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基础特征</span></span><br><span class="line">        features[<span class="string">'user_id'</span>] = user_id</span><br><span class="line">        features[<span class="string">'age'</span>] = user_profile.get(<span class="string">'age'</span>, <span class="number">0</span>)</span><br><span class="line">        features[<span class="string">'gender'</span>] = user_profile.get(<span class="string">'gender'</span>, <span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计特征</span></span><br><span class="line">        features[<span class="string">'click_count_7d'</span>] = self.count_recent_actions(</span><br><span class="line">            behavior_history, days=<span class="number">7</span>, action=<span class="string">'click'</span></span><br><span class="line">        )</span><br><span class="line">        features[<span class="string">'purchase_count_30d'</span>] = self.count_recent_actions(</span><br><span class="line">            behavior_history, days=<span class="number">30</span>, action=<span class="string">'purchase'</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 序列特征</span></span><br><span class="line">        features[<span class="string">'recent_item_ids'</span>] = self.get_recent_items(</span><br><span class="line">            behavior_history, top_k=<span class="number">10</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 交叉特征</span></span><br><span class="line">        features[<span class="string">'age_gender'</span>] = <span class="string">f"<span class="subst">{features[<span class="string">'age'</span>]}</span>_<span class="subst">{features[<span class="string">'gender'</span>]}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_item_features</span>(<span class="params">self, item_id, item_info</span>):</span><br><span class="line">        <span class="string">"""构建物品特征"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基础特征</span></span><br><span class="line">        features[<span class="string">'item_id'</span>] = item_id</span><br><span class="line">        features[<span class="string">'category'</span>] = item_info.get(<span class="string">'category'</span>, <span class="string">''</span>)</span><br><span class="line">        features[<span class="string">'price'</span>] = item_info.get(<span class="string">'price'</span>, <span class="number">0.0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 统计特征</span></span><br><span class="line">        features[<span class="string">'click_count_24h'</span>] = item_info.get(<span class="string">'click_count_24h'</span>, <span class="number">0</span>)</span><br><span class="line">        features[<span class="string">'ctr_7d'</span>] = item_info.get(<span class="string">'ctr_7d'</span>, <span class="number">0.0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_context_features</span>(<span class="params">self, context</span>):</span><br><span class="line">        <span class="string">"""构建上下文特征"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">import</span> datetime</span><br><span class="line">        now = datetime.datetime.now()</span><br><span class="line">        </span><br><span class="line">        features[<span class="string">'hour'</span>] = now.hour</span><br><span class="line">        features[<span class="string">'day_of_week'</span>] = now.weekday()</span><br><span class="line">        features[<span class="string">'is_weekend'</span>] = <span class="number">1</span> <span class="keyword">if</span> now.weekday() &gt;= <span class="number">5</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 设备特征</span></span><br><span class="line">        features[<span class="string">'device_type'</span>] = context.get(<span class="string">'device_type'</span>, <span class="string">'unknown'</span>)</span><br><span class="line">        features[<span class="string">'platform'</span>] = context.get(<span class="string">'platform'</span>, <span class="string">'unknown'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_interaction_features</span>(<span class="params">self, user_features, item_features</span>):</span><br><span class="line">        <span class="string">"""构建交互特征"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 用户-物品交叉</span></span><br><span class="line">        features[<span class="string">'user_item_category_match'</span>] = (</span><br><span class="line">            <span class="number">1</span> <span class="keyword">if</span> user_features.get(<span class="string">'preferred_category'</span>) == </span><br><span class="line">               item_features.get(<span class="string">'category'</span>) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 价格偏好匹配</span></span><br><span class="line">        user_price_range = user_features.get(<span class="string">'price_range'</span>, [<span class="number">0</span>, <span class="number">1000</span>])</span><br><span class="line">        item_price = item_features.get(<span class="string">'price'</span>, <span class="number">0</span>)</span><br><span class="line">        features[<span class="string">'price_match'</span>] = (</span><br><span class="line">            <span class="number">1</span> <span class="keyword">if</span> user_price_range[<span class="number">0</span>] &lt;= item_price &lt;= user_price_range[<span class="number">1</span>] </span><br><span class="line">            <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br></pre></td></tr></table></figure>
<h2 id="重排序策略">重排序策略</h2>
<p>重排序层在精排结果基础上，考虑多样性、新颖性、业务规则等因素进行最终调整。</p>
<h3 id="多样性重排序">多样性重排序</h3>
<p>多样性保证推荐结果的丰富程度，避免结果过于相似：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DiversityReRanker</span>:</span><br><span class="line">    <span class="string">"""多样性重排序"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, item_similarity_matrix, lambda_diversity=<span class="number">0.5</span></span>):</span><br><span class="line">        self.item_similarity = item_similarity_matrix</span><br><span class="line">        self.lambda_diversity = lambda_diversity</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">re_rank</span>(<span class="params">self, ranked_items, scores, top_k=<span class="number">20</span></span>):</span><br><span class="line">        <span class="string">"""MMR (Maximal Marginal Relevance) 重排序"""</span></span><br><span class="line">        selected = []</span><br><span class="line">        remaining = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(ranked_items)))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 第一个选择最高分的</span></span><br><span class="line">        <span class="keyword">if</span> remaining:</span><br><span class="line">            selected.append(remaining.pop(<span class="number">0</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 迭代选择：平衡相关性和多样性</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(selected) &lt; top_k <span class="keyword">and</span> remaining:</span><br><span class="line">            best_idx = <span class="literal">None</span></span><br><span class="line">            best_score = -<span class="built_in">float</span>(<span class="string">'inf'</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> remaining:</span><br><span class="line">                <span class="comment"># 相关性分数</span></span><br><span class="line">                relevance = scores[idx]</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 多样性：与已选物品的最大相似度</span></span><br><span class="line">                max_sim = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> sel_idx <span class="keyword">in</span> selected:</span><br><span class="line">                    sim = self.item_similarity[</span><br><span class="line">                        ranked_items[idx], </span><br><span class="line">                        ranked_items[sel_idx]</span><br><span class="line">                    ]</span><br><span class="line">                    max_sim = <span class="built_in">max</span>(max_sim, sim)</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># MMR 分数</span></span><br><span class="line">                mmr_score = (</span><br><span class="line">                    self.lambda_diversity * relevance - </span><br><span class="line">                    (<span class="number">1</span> - self.lambda_diversity) * max_sim</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> mmr_score &gt; best_score:</span><br><span class="line">                    best_score = mmr_score</span><br><span class="line">                    best_idx = idx</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> best_idx <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                selected.append(best_idx)</span><br><span class="line">                remaining.remove(best_idx)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [ranked_items[i] <span class="keyword">for</span> i <span class="keyword">in</span> selected]</span><br></pre></td></tr></table></figure>
<h3 id="新颖性重排序">新颖性重排序</h3>
<p>新颖性保证推荐结果的新鲜度，避免重复推荐用户已经看过的内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NoveltyReRanker</span>:</span><br><span class="line">    <span class="string">"""新颖性重排序"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_history, novelty_weight=<span class="number">0.3</span></span>):</span><br><span class="line">        self.user_history = user_history  <span class="comment"># 用户历史交互集合</span></span><br><span class="line">        self.novelty_weight = novelty_weight</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">re_rank</span>(<span class="params">self, ranked_items, scores, top_k=<span class="number">20</span></span>):</span><br><span class="line">        <span class="string">"""基于新颖性重排序"""</span></span><br><span class="line">        novelty_scores = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> item_id <span class="keyword">in</span> ranked_items:</span><br><span class="line">            <span class="comment"># 新颖性：用户是否交互过</span></span><br><span class="line">            is_novel = <span class="number">1</span> <span class="keyword">if</span> item_id <span class="keyword">not</span> <span class="keyword">in</span> self.user_history <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 时间衰减：如果交互过，时间越久新颖性越高</span></span><br><span class="line">            <span class="keyword">if</span> item_id <span class="keyword">in</span> self.user_history:</span><br><span class="line">                last_interaction_time = self.user_history[item_id]</span><br><span class="line">                hours_ago = (</span><br><span class="line">                    time.time() - last_interaction_time</span><br><span class="line">                ) / <span class="number">3600</span></span><br><span class="line">                novelty = np.exp(-hours_ago / <span class="number">720</span>)  <span class="comment"># 30 天半衰期</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                novelty = <span class="number">1.0</span></span><br><span class="line">            </span><br><span class="line">            novelty_scores.append(novelty)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 组合分数</span></span><br><span class="line">        combined_scores = [</span><br><span class="line">            (<span class="number">1</span> - self.novelty_weight) * score + </span><br><span class="line">            self.novelty_weight * novelty</span><br><span class="line">            <span class="keyword">for</span> score, novelty <span class="keyword">in</span> <span class="built_in">zip</span>(scores, novelty_scores)</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 重新排序</span></span><br><span class="line">        sorted_indices = np.argsort(combined_scores)[::-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> [ranked_items[i] <span class="keyword">for</span> i <span class="keyword">in</span> sorted_indices[:top_k]]</span><br></pre></td></tr></table></figure>
<h3 id="业务规则重排序">业务规则重排序</h3>
<p>业务规则重排序考虑运营需求，如新品扶持、品类平衡等：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BusinessRuleReRanker</span>:</span><br><span class="line">    <span class="string">"""业务规则重排序"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, rules</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        rules: dict, 例如 {</span></span><br><span class="line"><span class="string">            'new_item_boost': 1.2,  # 新品加权</span></span><br><span class="line"><span class="string">            'category_balance': True,  # 品类平衡</span></span><br><span class="line"><span class="string">            'max_items_per_category': 5  # 每个品类最多推荐数</span></span><br><span class="line"><span class="string">        }</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.rules = rules</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">re_rank</span>(<span class="params">self, ranked_items, item_metadata, top_k=<span class="number">20</span></span>):</span><br><span class="line">        <span class="string">"""应用业务规则"""</span></span><br><span class="line">        result = []</span><br><span class="line">        category_count = {}</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> item_id <span class="keyword">in</span> ranked_items:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(result) &gt;= top_k:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">            item_info = item_metadata[item_id]</span><br><span class="line">            category = item_info.get(<span class="string">'category'</span>, <span class="string">'other'</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 品类平衡检查</span></span><br><span class="line">            <span class="keyword">if</span> self.rules.get(<span class="string">'category_balance'</span>, <span class="literal">False</span>):</span><br><span class="line">                max_per_category = self.rules.get(</span><br><span class="line">                    <span class="string">'max_items_per_category'</span>, </span><br><span class="line">                    <span class="built_in">float</span>(<span class="string">'inf'</span>)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">if</span> category_count.get(category, <span class="number">0</span>) &gt;= max_per_category:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 新品加权</span></span><br><span class="line">            <span class="keyword">if</span> self.rules.get(<span class="string">'new_item_boost'</span>, <span class="number">1.0</span>) &gt; <span class="number">1.0</span>:</span><br><span class="line">                is_new = item_info.get(<span class="string">'is_new'</span>, <span class="literal">False</span>)</span><br><span class="line">                <span class="keyword">if</span> is_new <span class="keyword">and</span> <span class="built_in">len</span>(result) &lt; top_k:</span><br><span class="line">                    result.append(item_id)</span><br><span class="line">                    category_count[category] = category_count.get(category, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">            result.append(item_id)</span><br><span class="line">            category_count[category] = category_count.get(category, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<h2 id="easyrec-框架实践">EasyRec 框架实践</h2>
<p>EasyRec
是阿里巴巴开源的推荐算法框架，提供了完整的推荐系统解决方案。</p>
<h3 id="easyrec-架构">EasyRec 架构</h3>
<p>EasyRec
采用<strong>配置化</strong>的方式构建推荐模型，支持多种模型结构：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EasyRec 配置示例</span></span><br><span class="line">easyrec_config = {</span><br><span class="line">    <span class="string">"model_config"</span>: {</span><br><span class="line">        <span class="string">"model_class"</span>: <span class="string">"MultiTower"</span>,</span><br><span class="line">        <span class="string">"feature_groups"</span>: [</span><br><span class="line">            {</span><br><span class="line">                <span class="string">"group_name"</span>: <span class="string">"user"</span>,</span><br><span class="line">                <span class="string">"features"</span>: [</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"user_id"</span>, <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>},</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"age"</span>, <span class="string">"feature_type"</span>: <span class="string">"raw_feature"</span>},</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"gender"</span>, <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>}</span><br><span class="line">                ]</span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">                <span class="string">"group_name"</span>: <span class="string">"item"</span>,</span><br><span class="line">                <span class="string">"features"</span>: [</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"item_id"</span>, <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>},</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"category"</span>, <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>},</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"price"</span>, <span class="string">"feature_type"</span>: <span class="string">"raw_feature"</span>}</span><br><span class="line">                ]</span><br><span class="line">            },</span><br><span class="line">            {</span><br><span class="line">                <span class="string">"group_name"</span>: <span class="string">"context"</span>,</span><br><span class="line">                <span class="string">"features"</span>: [</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"hour"</span>, <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>},</span><br><span class="line">                    {<span class="string">"feature_name"</span>: <span class="string">"device"</span>, <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>}</span><br><span class="line">                ]</span><br><span class="line">            }</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"wide_and_deep"</span>: {</span><br><span class="line">            <span class="string">"dnn"</span>: {</span><br><span class="line">                <span class="string">"hidden_units"</span>: [<span class="number">512</span>, <span class="number">256</span>, <span class="number">128</span>],</span><br><span class="line">                <span class="string">"dropout_rate"</span>: <span class="number">0.2</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">    <span class="string">"data_config"</span>: {</span><br><span class="line">        <span class="string">"input_fields"</span>: [<span class="string">"user_id"</span>, <span class="string">"item_id"</span>, <span class="string">"label"</span>],</span><br><span class="line">        <span class="string">"label_fields"</span>: [<span class="string">"label"</span>]</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="easyrec-使用示例">EasyRec 使用示例</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> easy_rec.python <span class="keyword">import</span> easy_rec_predictor</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EasyRecRecommender</span>:</span><br><span class="line">    <span class="string">"""基于 EasyRec 的推荐器"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_path, config_path</span>):</span><br><span class="line">        self.predictor = easy_rec_predictor.EasyRecPredictor(</span><br><span class="line">            model_path=model_path,</span><br><span class="line">            config_path=config_path</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, user_features, item_features, context_features</span>):</span><br><span class="line">        <span class="string">"""预测用户对物品的偏好"""</span></span><br><span class="line">        <span class="comment"># 构建输入</span></span><br><span class="line">        inputs = {</span><br><span class="line">            <span class="string">'user_id'</span>: user_features[<span class="string">'user_id'</span>],</span><br><span class="line">            <span class="string">'item_id'</span>: item_features[<span class="string">'item_id'</span>],</span><br><span class="line">            <span class="string">'age'</span>: user_features[<span class="string">'age'</span>],</span><br><span class="line">            <span class="string">'gender'</span>: user_features[<span class="string">'gender'</span>],</span><br><span class="line">            <span class="string">'category'</span>: item_features[<span class="string">'category'</span>],</span><br><span class="line">            <span class="string">'price'</span>: item_features[<span class="string">'price'</span>],</span><br><span class="line">            <span class="string">'hour'</span>: context_features[<span class="string">'hour'</span>],</span><br><span class="line">            <span class="string">'device'</span>: context_features[<span class="string">'device'</span>]</span><br><span class="line">        }</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 预测</span></span><br><span class="line">        predictions = self.predictor.predict(inputs)</span><br><span class="line">        <span class="keyword">return</span> predictions[<span class="string">'probs'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">batch_predict</span>(<span class="params">self, user_id, item_ids, context</span>):</span><br><span class="line">        <span class="string">"""批量预测"""</span></span><br><span class="line">        user_features = self.get_user_features(user_id)</span><br><span class="line">        context_features = self.get_context_features(context)</span><br><span class="line">        </span><br><span class="line">        scores = []</span><br><span class="line">        <span class="keyword">for</span> item_id <span class="keyword">in</span> item_ids:</span><br><span class="line">            item_features = self.get_item_features(item_id)</span><br><span class="line">            score = self.predict(user_features, item_features, context_features)</span><br><span class="line">            scores.append(score[<span class="number">0</span>])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> scores</span><br></pre></td></tr></table></figure>
<h3 id="easyrec-特征工程">EasyRec 特征工程</h3>
<p>EasyRec 提供了丰富的特征工程能力：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># EasyRec 特征配置</span></span><br><span class="line">feature_config = {</span><br><span class="line">    <span class="string">"features"</span>: [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"feature_name"</span>: <span class="string">"user_id"</span>,</span><br><span class="line">            <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>,</span><br><span class="line">            <span class="string">"embedding_dim"</span>: <span class="number">64</span>,</span><br><span class="line">            <span class="string">"hash_bucket_size"</span>: <span class="number">1000000</span></span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"feature_name"</span>: <span class="string">"item_id"</span>,</span><br><span class="line">            <span class="string">"feature_type"</span>: <span class="string">"id_feature"</span>,</span><br><span class="line">            <span class="string">"embedding_dim"</span>: <span class="number">64</span>,</span><br><span class="line">            <span class="string">"hash_bucket_size"</span>: <span class="number">500000</span></span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"feature_name"</span>: <span class="string">"age"</span>,</span><br><span class="line">            <span class="string">"feature_type"</span>: <span class="string">"raw_feature"</span>,</span><br><span class="line">            <span class="string">"normalizer"</span>: <span class="string">"log"</span></span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"feature_name"</span>: <span class="string">"price"</span>,</span><br><span class="line">            <span class="string">"feature_type"</span>: <span class="string">"raw_feature"</span>,</span><br><span class="line">            <span class="string">"normalizer"</span>: <span class="string">"min_max"</span>,</span><br><span class="line">            <span class="string">"boundaries"</span>: [<span class="number">0</span>, <span class="number">1000</span>]</span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"feature_name"</span>: <span class="string">"user_item_cross"</span>,</span><br><span class="line">            <span class="string">"feature_type"</span>: <span class="string">"sequence_feature"</span>,</span><br><span class="line">            <span class="string">"sequence_combiner"</span>: <span class="string">"mean"</span></span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h2 id="longer-长序列建模">LONGER 长序列建模</h2>
<p>LONGER
是字节跳动提出的长序列推荐模型，能够处理用户的长历史行为序列（数千到数万条）。</p>
<h3 id="长序列挑战">长序列挑战</h3>
<p>传统序列模型（如 GRU、LSTM）难以处理超长序列： 1.
<strong>计算复杂度</strong>：<span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.015ex" height="2.452ex" role="img" focusable="false" viewbox="0 -833.9 2658.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msup" transform="translate(1152,0)"><g data-mml-node="mi"><path data-c="1D43F" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g><g data-mml-node="mn" transform="translate(714,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(2269.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></span>
的注意力机制 2. <strong>内存限制</strong>：无法将整个序列加载到内存 3.
<strong>噪声干扰</strong>：长序列中包含大量噪声</p>
<h3 id="longer-架构">LONGER 架构</h3>
<p>LONGER 采用<strong>分段检索 + 局部建模</strong>的策略：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LONGERModel</span>(nn.Module):</span><br><span class="line">    <span class="string">"""LONGER 长序列模型"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, item_embed_dim=<span class="number">64</span>, hidden_dim=<span class="number">128</span>, num_segments=<span class="number">10</span></span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.item_embed_dim = item_embed_dim</span><br><span class="line">        self.hidden_dim = hidden_dim</span><br><span class="line">        self.num_segments = num_segments</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 物品嵌入层</span></span><br><span class="line">        self.item_embedding = nn.Embedding(</span><br><span class="line">            num_items, item_embed_dim</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 分段检索模块</span></span><br><span class="line">        self.segment_retriever = SegmentRetriever(</span><br><span class="line">            item_embed_dim, hidden_dim</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 局部序列编码器</span></span><br><span class="line">        self.local_encoder = LocalSequenceEncoder(</span><br><span class="line">            item_embed_dim, hidden_dim</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 全局融合层</span></span><br><span class="line">        self.fusion_layer = nn.Sequential(</span><br><span class="line">            nn.Linear(hidden_dim * <span class="number">2</span>, hidden_dim),</span><br><span class="line">            nn.ReLU(),</span><br><span class="line">            nn.Linear(hidden_dim, <span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, user_history, candidate_item</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        user_history: (batch_size, seq_len) 用户历史序列</span></span><br><span class="line"><span class="string">        candidate_item: (batch_size,) 候选物品</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        batch_size = user_history.size(<span class="number">0</span>)</span><br><span class="line">        seq_len = user_history.size(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 物品嵌入</span></span><br><span class="line">        history_emb = self.item_embedding(user_history)  <span class="comment"># (B, L, D)</span></span><br><span class="line">        candidate_emb = self.item_embedding(candidate_item)  <span class="comment"># (B, D)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 分段检索：找到最相关的片段</span></span><br><span class="line">        segment_size = seq_len // self.num_segments</span><br><span class="line">        segments = []</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(self.num_segments):</span><br><span class="line">            start_idx = i * segment_size</span><br><span class="line">            end_idx = <span class="built_in">min</span>((i + <span class="number">1</span>) * segment_size, seq_len)</span><br><span class="line">            segment = history_emb[:, start_idx:end_idx, :]</span><br><span class="line">            segments.append(segment)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算每个片段与候选物品的相关性</span></span><br><span class="line">        segment_scores = []</span><br><span class="line">        <span class="keyword">for</span> segment <span class="keyword">in</span> segments:</span><br><span class="line">            <span class="comment"># 片段平均表示</span></span><br><span class="line">            segment_repr = segment.mean(dim=<span class="number">1</span>)  <span class="comment"># (B, D)</span></span><br><span class="line">            <span class="comment"># 相关性分数</span></span><br><span class="line">            score = torch.<span class="built_in">sum</span>(segment_repr * candidate_emb, dim=<span class="number">1</span>)</span><br><span class="line">            segment_scores.append(score)</span><br><span class="line">        </span><br><span class="line">        segment_scores = torch.stack(segment_scores, dim=<span class="number">1</span>)  <span class="comment"># (B, num_segments)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 选择 top-k 最相关的片段</span></span><br><span class="line">        top_k = <span class="built_in">min</span>(<span class="number">3</span>, self.num_segments)</span><br><span class="line">        top_k_scores, top_k_indices = torch.topk(</span><br><span class="line">            segment_scores, k=top_k, dim=<span class="number">1</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 局部序列编码</span></span><br><span class="line">        selected_segments = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(batch_size):</span><br><span class="line">            selected_indices = top_k_indices[i]</span><br><span class="line">            selected_segment_embs = []</span><br><span class="line">            <span class="keyword">for</span> idx <span class="keyword">in</span> selected_indices:</span><br><span class="line">                seg_idx = idx.item()</span><br><span class="line">                seg_emb = segments[seg_idx][i]  <span class="comment"># (segment_size, D)</span></span><br><span class="line">                selected_segment_embs.append(seg_emb)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 拼接选中的片段</span></span><br><span class="line">            selected_segment = torch.cat(selected_segment_embs, dim=<span class="number">0</span>)</span><br><span class="line">            selected_segments.append(selected_segment)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 填充到相同长度</span></span><br><span class="line">        max_len = <span class="built_in">max</span>(seg.size(<span class="number">0</span>) <span class="keyword">for</span> seg <span class="keyword">in</span> selected_segments)</span><br><span class="line">        padded_segments = []</span><br><span class="line">        <span class="keyword">for</span> seg <span class="keyword">in</span> selected_segments:</span><br><span class="line">            pad_len = max_len - seg.size(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span> pad_len &gt; <span class="number">0</span>:</span><br><span class="line">                pad = torch.zeros(pad_len, self.item_embed_dim).to(seg.device)</span><br><span class="line">                seg = torch.cat([seg, pad], dim=<span class="number">0</span>)</span><br><span class="line">            padded_segments.append(seg)</span><br><span class="line">        </span><br><span class="line">        selected_history = torch.stack(padded_segments, dim=<span class="number">0</span>)  <span class="comment"># (B, max_len, D)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 局部编码</span></span><br><span class="line">        local_repr = self.local_encoder(selected_history)  <span class="comment"># (B, hidden_dim)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 4. 全局融合</span></span><br><span class="line">        global_repr = history_emb.mean(dim=<span class="number">1</span>)  <span class="comment"># (B, D)</span></span><br><span class="line">        global_repr = nn.functional.linear(</span><br><span class="line">            global_repr, </span><br><span class="line">            self.item_embedding.weight[candidate_item]</span><br><span class="line">        )  <span class="comment"># (B, hidden_dim)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 融合</span></span><br><span class="line">        fused_repr = torch.cat([local_repr, global_repr], dim=<span class="number">1</span>)</span><br><span class="line">        score = self.fusion_layer(fused_repr)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> torch.sigmoid(score)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LocalSequenceEncoder</span>(nn.Module):</span><br><span class="line">    <span class="string">"""局部序列编码器"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_dim, hidden_dim</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.transformer = nn.TransformerEncoder(</span><br><span class="line">            nn.TransformerEncoderLayer(</span><br><span class="line">                d_model=input_dim,</span><br><span class="line">                nhead=<span class="number">8</span>,</span><br><span class="line">                dim_feedforward=hidden_dim,</span><br><span class="line">                dropout=<span class="number">0.1</span></span><br><span class="line">            ),</span><br><span class="line">            num_layers=<span class="number">2</span></span><br><span class="line">        )</span><br><span class="line">        self.output_proj = nn.Linear(input_dim, hidden_dim)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        x: (batch_size, seq_len, input_dim)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="comment"># Transformer 编码</span></span><br><span class="line">        x = x.transpose(<span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># (seq_len, batch_size, input_dim)</span></span><br><span class="line">        encoded = self.transformer(x)</span><br><span class="line">        encoded = encoded.transpose(<span class="number">0</span>, <span class="number">1</span>)  <span class="comment"># (batch_size, seq_len, input_dim)</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 取最后一个时间步</span></span><br><span class="line">        output = encoded[:, -<span class="number">1</span>, :]</span><br><span class="line">        output = self.output_proj(output)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> output</span><br></pre></td></tr></table></figure>
<h3 id="longer-优化技巧">LONGER 优化技巧</h3>
<ol type="1">
<li><strong>增量更新</strong>：只对新行为进行编码，避免重复计算</li>
<li><strong>缓存机制</strong>：缓存片段表示，减少计算量</li>
<li><strong>采样策略</strong>：对超长序列进行智能采样</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OptimizedLONGER</span>:</span><br><span class="line">    <span class="string">"""优化的 LONGER 实现"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model, cache_size=<span class="number">10000</span></span>):</span><br><span class="line">        self.model = model</span><br><span class="line">        self.segment_cache = {}  <span class="comment"># 缓存片段表示</span></span><br><span class="line">        self.cache_size = cache_size</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encode_with_cache</span>(<span class="params">self, user_history</span>):</span><br><span class="line">        <span class="string">"""带缓存的编码"""</span></span><br><span class="line">        <span class="comment"># 生成缓存 key</span></span><br><span class="line">        cache_key = self._generate_cache_key(user_history)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> cache_key <span class="keyword">in</span> self.segment_cache:</span><br><span class="line">            <span class="keyword">return</span> self.segment_cache[cache_key]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算并缓存</span></span><br><span class="line">        representation = self.model.encode(user_history)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># LRU 缓存</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.segment_cache) &gt;= self.cache_size:</span><br><span class="line">            <span class="comment"># 删除最旧的</span></span><br><span class="line">            oldest_key = <span class="built_in">next</span>(<span class="built_in">iter</span>(self.segment_cache))</span><br><span class="line">            <span class="keyword">del</span> self.segment_cache[oldest_key]</span><br><span class="line">        </span><br><span class="line">        self.segment_cache[cache_key] = representation</span><br><span class="line">        <span class="keyword">return</span> representation</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">incremental_update</span>(<span class="params">self, old_history, new_actions</span>):</span><br><span class="line">        <span class="string">"""增量更新"""</span></span><br><span class="line">        <span class="comment"># 只对新行为进行编码</span></span><br><span class="line">        new_segment = self.model.encode_segment(new_actions)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 与旧表示融合</span></span><br><span class="line">        old_repr = self.encode_with_cache(old_history)</span><br><span class="line">        updated_repr = self._fuse_representations(old_repr, new_segment)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> updated_repr</span><br></pre></td></tr></table></figure>
<h2 id="特征工程自动化">特征工程自动化</h2>
<p>特征工程是推荐系统的关键环节，自动化特征工程可以大幅提升效率。</p>
<h3 id="自动特征生成">自动特征生成</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AutoFeatureGenerator</span>:</span><br><span class="line">    <span class="string">"""自动特征生成器"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.feature_templates = []</span><br><span class="line">        self._init_templates()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_init_templates</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""初始化特征模板"""</span></span><br><span class="line">        <span class="comment"># 统计特征模板</span></span><br><span class="line">        self.feature_templates.extend([</span><br><span class="line">            <span class="string">'count_{field}_{window}'</span>,  <span class="comment"># 计数特征</span></span><br><span class="line">            <span class="string">'avg_{field}_{window}'</span>,    <span class="comment"># 平均特征</span></span><br><span class="line">            <span class="string">'max_{field}_{window}'</span>,    <span class="comment"># 最大特征</span></span><br><span class="line">            <span class="string">'min_{field}_{window}'</span>,    <span class="comment"># 最小特征</span></span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 交叉特征模板</span></span><br><span class="line">        self.feature_templates.extend([</span><br><span class="line">            <span class="string">'{field1}_{field2}_cross'</span>,  <span class="comment"># 交叉特征</span></span><br><span class="line">            <span class="string">'{field1}_div_{field2}'</span>,    <span class="comment"># 除法特征</span></span><br><span class="line">            <span class="string">'{field1}_mul_{field2}'</span>,    <span class="comment"># 乘法特征</span></span><br><span class="line">        ])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 序列特征模板</span></span><br><span class="line">        self.feature_templates.extend([</span><br><span class="line">            <span class="string">'last_{n}_{field}'</span>,         <span class="comment"># 最近 N 个</span></span><br><span class="line">            <span class="string">'first_{n}_{field}'</span>,       <span class="comment"># 最早 N 个</span></span><br><span class="line">        ])</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generate_features</span>(<span class="params">self, data, target_field=<span class="string">'label'</span></span>):</span><br><span class="line">        <span class="string">"""自动生成特征"""</span></span><br><span class="line">        generated_features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 1. 统计特征</span></span><br><span class="line">        <span class="keyword">for</span> template <span class="keyword">in</span> self.feature_templates:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'count'</span> <span class="keyword">in</span> template <span class="keyword">or</span> <span class="string">'avg'</span> <span class="keyword">in</span> template:</span><br><span class="line">                features = self._generate_stat_features(</span><br><span class="line">                    data, template</span><br><span class="line">                )</span><br><span class="line">                generated_features.update(features)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 交叉特征</span></span><br><span class="line">        cross_features = self._generate_cross_features(data)</span><br><span class="line">        generated_features.update(cross_features)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 3. 序列特征</span></span><br><span class="line">        seq_features = self._generate_sequence_features(data)</span><br><span class="line">        generated_features.update(seq_features)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> generated_features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_stat_features</span>(<span class="params">self, data, template</span>):</span><br><span class="line">        <span class="string">"""生成统计特征"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 解析模板</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'count'</span> <span class="keyword">in</span> template:</span><br><span class="line">            stat_type = <span class="string">'count'</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'avg'</span> <span class="keyword">in</span> template:</span><br><span class="line">            stat_type = <span class="string">'avg'</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'max'</span> <span class="keyword">in</span> template:</span><br><span class="line">            stat_type = <span class="string">'max'</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'min'</span> <span class="keyword">in</span> template:</span><br><span class="line">            stat_type = <span class="string">'min'</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 时间窗口</span></span><br><span class="line">        windows = [<span class="string">'1h'</span>, <span class="string">'24h'</span>, <span class="string">'7d'</span>, <span class="string">'30d'</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> window <span class="keyword">in</span> windows:</span><br><span class="line">            feature_name = template.<span class="built_in">format</span>(</span><br><span class="line">                field=<span class="string">'*'</span>, window=window</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 实际实现中需要根据具体字段和时间窗口计算</span></span><br><span class="line">            features[feature_name] = self._compute_stat(</span><br><span class="line">                data, stat_type, window</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_cross_features</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">"""生成交叉特征"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 选择重要字段进行交叉</span></span><br><span class="line">        important_fields = [<span class="string">'user_id'</span>, <span class="string">'item_id'</span>, <span class="string">'category'</span>, <span class="string">'price'</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, field1 <span class="keyword">in</span> <span class="built_in">enumerate</span>(important_fields):</span><br><span class="line">            <span class="keyword">for</span> field2 <span class="keyword">in</span> important_fields[i+<span class="number">1</span>:]:</span><br><span class="line">                <span class="comment"># 交叉特征</span></span><br><span class="line">                cross_name = <span class="string">f'<span class="subst">{field1}</span>_<span class="subst">{field2}</span>_cross'</span></span><br><span class="line">                features[cross_name] = self._compute_cross(</span><br><span class="line">                    data, field1, field2</span><br><span class="line">                )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_generate_sequence_features</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="string">"""生成序列特征"""</span></span><br><span class="line">        features = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 最近 N 个物品</span></span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">10</span>]:</span><br><span class="line">            feature_name = <span class="string">f'last_<span class="subst">{n}</span>_items'</span></span><br><span class="line">            features[feature_name] = self._get_last_n_items(data, n)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> features</span><br></pre></td></tr></table></figure>
<h3 id="特征选择">特征选择</h3>
<p>自动特征选择可以去除冗余特征，提升模型效果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AutoFeatureSelector</span>:</span><br><span class="line">    <span class="string">"""自动特征选择"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, method=<span class="string">'mutual_info'</span></span>):</span><br><span class="line">        self.method = method</span><br><span class="line">        self.selected_features = []</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">select_features</span>(<span class="params">self, X, y, top_k=<span class="number">100</span></span>):</span><br><span class="line">        <span class="string">"""选择 top_k 个特征"""</span></span><br><span class="line">        <span class="keyword">if</span> self.method == <span class="string">'mutual_info'</span>:</span><br><span class="line">            scores = self._mutual_info_score(X, y)</span><br><span class="line">        <span class="keyword">elif</span> self.method == <span class="string">'chi2'</span>:</span><br><span class="line">            scores = self._chi2_score(X, y)</span><br><span class="line">        <span class="keyword">elif</span> self.method == <span class="string">'f_score'</span>:</span><br><span class="line">            scores = self._f_score(X, y)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">f"Unknown method: <span class="subst">{self.method}</span>"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 选择 top_k</span></span><br><span class="line">        top_indices = np.argsort(scores)[-top_k:][::-<span class="number">1</span>]</span><br><span class="line">        self.selected_features = top_indices</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> self.selected_features</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_mutual_info_score</span>(<span class="params">self, X, y</span>):</span><br><span class="line">        <span class="string">"""互信息分数"""</span></span><br><span class="line">        <span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> mutual_info_classif</span><br><span class="line">        scores = mutual_info_classif(X, y, random_state=<span class="number">42</span>)</span><br><span class="line">        <span class="keyword">return</span> scores</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_chi2_score</span>(<span class="params">self, X, y</span>):</span><br><span class="line">        <span class="string">"""卡方分数"""</span></span><br><span class="line">        <span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> chi2</span><br><span class="line">        scores, _ = chi2(X, y)</span><br><span class="line">        <span class="keyword">return</span> scores</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_f_score</span>(<span class="params">self, X, y</span>):</span><br><span class="line">        <span class="string">"""F 分数"""</span></span><br><span class="line">        <span class="keyword">from</span> sklearn.feature_selection <span class="keyword">import</span> f_classif</span><br><span class="line">        scores, _ = f_classif(X, y)</span><br><span class="line">        <span class="keyword">return</span> scores</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transform</span>(<span class="params">self, X</span>):</span><br><span class="line">        <span class="string">"""转换数据，只保留选中的特征"""</span></span><br><span class="line">        <span class="keyword">return</span> X[:, self.selected_features]</span><br></pre></td></tr></table></figure>
<h2 id="ab-测试方法论">A/B 测试方法论</h2>
<p>A/B 测试是评估推荐系统改进效果的标准方法。</p>
<h3 id="ab-测试框架">A/B 测试框架</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ABTestFramework</span>:</span><br><span class="line">    <span class="string">"""A/B 测试框架"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client</span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.experiments = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_experiment</span>(<span class="params">self, exp_name, variants, traffic_split</span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        创建实验</span></span><br><span class="line"><span class="string">        variants: ['control', 'treatment']</span></span><br><span class="line"><span class="string">        traffic_split: {'control': 0.5, 'treatment': 0.5}</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.experiments[exp_name] = {</span><br><span class="line">            <span class="string">'variants'</span>: variants,</span><br><span class="line">            <span class="string">'traffic_split'</span>: traffic_split,</span><br><span class="line">            <span class="string">'start_time'</span>: time.time(),</span><br><span class="line">            <span class="string">'metrics'</span>: {v: [] <span class="keyword">for</span> v <span class="keyword">in</span> variants}</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">assign_variant</span>(<span class="params">self, user_id, exp_name</span>):</span><br><span class="line">        <span class="string">"""分配用户到实验组"""</span></span><br><span class="line">        <span class="keyword">if</span> exp_name <span class="keyword">not</span> <span class="keyword">in</span> self.experiments:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'control'</span></span><br><span class="line">        </span><br><span class="line">        exp = self.experiments[exp_name]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 使用用户 ID 的哈希值保证一致性</span></span><br><span class="line">        hash_value = <span class="built_in">hash</span>(<span class="string">f"<span class="subst">{user_id}</span>_<span class="subst">{exp_name}</span>"</span>) % <span class="number">100</span></span><br><span class="line">        </span><br><span class="line">        cumulative = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> variant, split <span class="keyword">in</span> exp[<span class="string">'traffic_split'</span>].items():</span><br><span class="line">            cumulative += split * <span class="number">100</span></span><br><span class="line">            <span class="keyword">if</span> hash_value &lt; cumulative:</span><br><span class="line">                <span class="keyword">return</span> variant</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'control'</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_event</span>(<span class="params">self, user_id, exp_name, event_type, value=<span class="number">1</span></span>):</span><br><span class="line">        <span class="string">"""记录事件"""</span></span><br><span class="line">        variant = self.assign_variant(user_id, exp_name)</span><br><span class="line">        </span><br><span class="line">        key = <span class="string">f"abtest:<span class="subst">{exp_name}</span>:<span class="subst">{variant}</span>:<span class="subst">{event_type}</span>"</span></span><br><span class="line">        self.redis.incrby(key, value)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_metrics</span>(<span class="params">self, exp_name</span>):</span><br><span class="line">        <span class="string">"""获取实验指标"""</span></span><br><span class="line">        <span class="keyword">if</span> exp_name <span class="keyword">not</span> <span class="keyword">in</span> self.experiments:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        exp = self.experiments[exp_name]</span><br><span class="line">        metrics = {}</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> variant <span class="keyword">in</span> exp[<span class="string">'variants'</span>]:</span><br><span class="line">            variant_metrics = {}</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 从 Redis 获取指标</span></span><br><span class="line">            clicks = <span class="built_in">int</span>(self.redis.get(</span><br><span class="line">                <span class="string">f"abtest:<span class="subst">{exp_name}</span>:<span class="subst">{variant}</span>:click"</span></span><br><span class="line">            ) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">            impressions = <span class="built_in">int</span>(self.redis.get(</span><br><span class="line">                <span class="string">f"abtest:<span class="subst">{exp_name}</span>:<span class="subst">{variant}</span>:impression"</span></span><br><span class="line">            ) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">            conversions = <span class="built_in">int</span>(self.redis.get(</span><br><span class="line">                <span class="string">f"abtest:<span class="subst">{exp_name}</span>:<span class="subst">{variant}</span>:conversion"</span></span><br><span class="line">            ) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">            </span><br><span class="line">            variant_metrics[<span class="string">'ctr'</span>] = clicks / impressions <span class="keyword">if</span> impressions &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            variant_metrics[<span class="string">'cvr'</span>] = conversions / clicks <span class="keyword">if</span> clicks &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            variant_metrics[<span class="string">'clicks'</span>] = clicks</span><br><span class="line">            variant_metrics[<span class="string">'impressions'</span>] = impressions</span><br><span class="line">            </span><br><span class="line">            metrics[variant] = variant_metrics</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metrics</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">statistical_significance_test</span>(<span class="params">self, exp_name</span>):</span><br><span class="line">        <span class="string">"""统计显著性检验"""</span></span><br><span class="line">        metrics = self.get_metrics(exp_name)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> metrics:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">from</span> scipy <span class="keyword">import</span> stats</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取 control 和 treatment 的数据</span></span><br><span class="line">        control_clicks = metrics[<span class="string">'control'</span>][<span class="string">'clicks'</span>]</span><br><span class="line">        control_impressions = metrics[<span class="string">'control'</span>][<span class="string">'impressions'</span>]</span><br><span class="line">        treatment_clicks = metrics[<span class="string">'treatment'</span>][<span class="string">'clicks'</span>]</span><br><span class="line">        treatment_impressions = metrics[<span class="string">'treatment'</span>][<span class="string">'impressions'</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 双样本比例检验</span></span><br><span class="line">        control_ctr = control_clicks / control_impressions</span><br><span class="line">        treatment_ctr = treatment_clicks / treatment_impressions</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Z 检验</span></span><br><span class="line">        p1 = control_ctr</span><br><span class="line">        p2 = treatment_ctr</span><br><span class="line">        n1 = control_impressions</span><br><span class="line">        n2 = treatment_impressions</span><br><span class="line">        </span><br><span class="line">        p_pooled = (control_clicks + treatment_clicks) / (n1 + n2)</span><br><span class="line">        se = np.sqrt(p_pooled * (<span class="number">1</span> - p_pooled) * (<span class="number">1</span>/n1 + <span class="number">1</span>/n2))</span><br><span class="line">        </span><br><span class="line">        z_score = (p2 - p1) / se</span><br><span class="line">        p_value = <span class="number">2</span> * (<span class="number">1</span> - stats.norm.cdf(<span class="built_in">abs</span>(z_score)))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">'control_ctr'</span>: control_ctr,</span><br><span class="line">            <span class="string">'treatment_ctr'</span>: treatment_ctr,</span><br><span class="line">            <span class="string">'lift'</span>: (treatment_ctr - control_ctr) / control_ctr,</span><br><span class="line">            <span class="string">'p_value'</span>: p_value,</span><br><span class="line">            <span class="string">'significant'</span>: p_value &lt; <span class="number">0.05</span></span><br><span class="line">        }</span><br></pre></td></tr></table></figure>
<h3 id="ab-测试最佳实践">A/B 测试最佳实践</h3>
<ol type="1">
<li><strong>样本量计算</strong>：确保有足够的样本量检测到显著差异</li>
<li><strong>分层实验</strong>：支持多个实验并行运行</li>
<li><strong>灰度发布</strong>：逐步扩大流量，降低风险</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SampleSizeCalculator</span>:</span><br><span class="line">    <span class="string">"""样本量计算器"""</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">calculate_sample_size</span>(<span class="params"></span></span><br><span class="line"><span class="params">        baseline_ctr, </span></span><br><span class="line"><span class="params">        min_detectable_lift, </span></span><br><span class="line"><span class="params">        power=<span class="number">0.8</span>, </span></span><br><span class="line"><span class="params">        alpha=<span class="number">0.05</span></span></span><br><span class="line"><span class="params">    </span>):</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        计算所需样本量</span></span><br><span class="line"><span class="string">        baseline_ctr: 基线 CTR</span></span><br><span class="line"><span class="string">        min_detectable_lift: 最小可检测的提升比例</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">from</span> scipy <span class="keyword">import</span> stats</span><br><span class="line">        </span><br><span class="line">        p1 = baseline_ctr</span><br><span class="line">        p2 = baseline_ctr * (<span class="number">1</span> + min_detectable_lift)</span><br><span class="line">        </span><br><span class="line">        z_alpha = stats.norm.ppf(<span class="number">1</span> - alpha/<span class="number">2</span>)</span><br><span class="line">        z_beta = stats.norm.ppf(power)</span><br><span class="line">        </span><br><span class="line">        p_bar = (p1 + p2) / <span class="number">2</span></span><br><span class="line">        </span><br><span class="line">        n = (</span><br><span class="line">            (z_alpha * np.sqrt(<span class="number">2</span> * p_bar * (<span class="number">1</span> - p_bar)) + </span><br><span class="line">             z_beta * np.sqrt(p1 * (<span class="number">1</span> - p1) + p2 * (<span class="number">1</span> - p2))) ** <span class="number">2</span></span><br><span class="line">        ) / ((p2 - p1) ** <span class="number">2</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(np.ceil(n))</span><br></pre></td></tr></table></figure>
<h2 id="性能优化技巧">性能优化技巧</h2>
<h3 id="模型推理优化">模型推理优化</h3>
<ol type="1">
<li><strong>模型量化</strong>：INT8 量化减少模型大小和推理时间</li>
<li><strong>模型剪枝</strong>：去除冗余参数</li>
<li><strong>批量推理</strong>：提高 GPU 利用率</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelOptimizer</span>:</span><br><span class="line">    <span class="string">"""模型优化器"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">quantize_model</span>(<span class="params">self, model, calibration_data</span>):</span><br><span class="line">        <span class="string">"""模型量化"""</span></span><br><span class="line">        <span class="keyword">import</span> torch.quantization <span class="keyword">as</span> quantization</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 设置量化配置</span></span><br><span class="line">        model.qconfig = quantization.get_default_qconfig(<span class="string">'fbgemm'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 准备量化</span></span><br><span class="line">        quantization.prepare(model, inplace=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 校准</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="keyword">for</span> batch <span class="keyword">in</span> calibration_data:</span><br><span class="line">                model(batch)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 转换</span></span><br><span class="line">        quantized_model = quantization.convert(model, inplace=<span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> quantized_model</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">prune_model</span>(<span class="params">self, model, pruning_rate=<span class="number">0.2</span></span>):</span><br><span class="line">        <span class="string">"""模型剪枝"""</span></span><br><span class="line">        <span class="keyword">import</span> torch.nn.utils.prune <span class="keyword">as</span> prune</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 对线性层进行剪枝</span></span><br><span class="line">        <span class="keyword">for</span> module <span class="keyword">in</span> model.modules():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(module, nn.Linear):</span><br><span class="line">                prune.l1_unstructured(module, name=<span class="string">'weight'</span>, amount=pruning_rate)</span><br><span class="line">                prune.remove(module, <span class="string">'weight'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> model</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">optimize_for_inference</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="string">"""推理优化"""</span></span><br><span class="line">        <span class="comment"># TorchScript 编译</span></span><br><span class="line">        model.<span class="built_in">eval</span>()</span><br><span class="line">        traced_model = torch.jit.trace(model, example_inputs)</span><br><span class="line">        optimized_model = torch.jit.optimize_for_inference(traced_model)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> optimized_model</span><br></pre></td></tr></table></figure>
<h3 id="缓存策略">缓存策略</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CacheStrategy</span>:</span><br><span class="line">    <span class="string">"""缓存策略"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, redis_client, ttl=<span class="number">3600</span></span>):</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.ttl = ttl</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_user_embedding</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="string">"""获取用户嵌入（带缓存）"""</span></span><br><span class="line">        cache_key = <span class="string">f"user_emb:<span class="subst">{user_id}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 尝试从缓存获取</span></span><br><span class="line">        cached = self.redis.get(cache_key)</span><br><span class="line">        <span class="keyword">if</span> cached:</span><br><span class="line">            <span class="keyword">return</span> pickle.loads(cached)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 计算并缓存</span></span><br><span class="line">        embedding = self.compute_user_embedding(user_id)</span><br><span class="line">        self.redis.setex(</span><br><span class="line">            cache_key, </span><br><span class="line">            self.ttl, </span><br><span class="line">            pickle.dumps(embedding)</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> embedding</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_item_embeddings_batch</span>(<span class="params">self, item_ids</span>):</span><br><span class="line">        <span class="string">"""批量获取物品嵌入"""</span></span><br><span class="line">        <span class="comment"># 批量从缓存获取</span></span><br><span class="line">        cache_keys = [<span class="string">f"item_emb:<span class="subst">{item_id}</span>"</span> <span class="keyword">for</span> item_id <span class="keyword">in</span> item_ids]</span><br><span class="line">        cached_values = self.redis.mget(cache_keys)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找出未缓存的</span></span><br><span class="line">        missing_indices = [</span><br><span class="line">            i <span class="keyword">for</span> i, val <span class="keyword">in</span> <span class="built_in">enumerate</span>(cached_values) <span class="keyword">if</span> val <span class="keyword">is</span> <span class="literal">None</span></span><br><span class="line">        ]</span><br><span class="line">        missing_item_ids = [item_ids[i] <span class="keyword">for</span> i <span class="keyword">in</span> missing_indices]</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 批量计算缺失的</span></span><br><span class="line">        <span class="keyword">if</span> missing_item_ids:</span><br><span class="line">            new_embeddings = self.compute_item_embeddings_batch(missing_item_ids)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 批量写入缓存</span></span><br><span class="line">            pipe = self.redis.pipeline()</span><br><span class="line">            <span class="keyword">for</span> item_id, emb <span class="keyword">in</span> <span class="built_in">zip</span>(missing_item_ids, new_embeddings):</span><br><span class="line">                cache_key = <span class="string">f"item_emb:<span class="subst">{item_id}</span>"</span></span><br><span class="line">                pipe.setex(cache_key, self.ttl, pickle.dumps(emb))</span><br><span class="line">            pipe.execute()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 组装结果</span></span><br><span class="line">        embeddings = []</span><br><span class="line">        <span class="keyword">for</span> i, item_id <span class="keyword">in</span> <span class="built_in">enumerate</span>(item_ids):</span><br><span class="line">            <span class="keyword">if</span> cached_values[i]:</span><br><span class="line">                embeddings.append(pickle.loads(cached_values[i]))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                idx = missing_indices.index(i)</span><br><span class="line">                embeddings.append(new_embeddings[idx])</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> embeddings</span><br></pre></td></tr></table></figure>
<h3 id="异步处理">异步处理</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncRecommendationService</span>:</span><br><span class="line">    <span class="string">"""异步推荐服务"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_workers=<span class="number">10</span></span>):</span><br><span class="line">        self.executor = ThreadPoolExecutor(max_workers=max_workers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">recommend_async</span>(<span class="params">self, user_id, context</span>):</span><br><span class="line">        <span class="string">"""异步推荐"""</span></span><br><span class="line">        loop = asyncio.get_event_loop()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 并行执行多个召回通道</span></span><br><span class="line">        recall_tasks = [</span><br><span class="line">            loop.run_in_executor(</span><br><span class="line">                self.executor, </span><br><span class="line">                self.recall_channel, </span><br><span class="line">                channel, </span><br><span class="line">                user_id</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">for</span> channel <span class="keyword">in</span> [<span class="string">'itemcf'</span>, <span class="string">'content'</span>, <span class="string">'popular'</span>, <span class="string">'realtime'</span>]</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        recall_results = <span class="keyword">await</span> asyncio.gather(*recall_tasks)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 合并结果</span></span><br><span class="line">        all_items = []</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> recall_results:</span><br><span class="line">            all_items.extend(result)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 去重</span></span><br><span class="line">        unique_items = <span class="built_in">list</span>(<span class="built_in">set</span>(all_items))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 粗排和精排</span></span><br><span class="line">        coarse_items = <span class="keyword">await</span> loop.run_in_executor(</span><br><span class="line">            self.executor,</span><br><span class="line">            self.coarse_rank,</span><br><span class="line">            unique_items,</span><br><span class="line">            user_id</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        fine_items = <span class="keyword">await</span> loop.run_in_executor(</span><br><span class="line">            self.executor,</span><br><span class="line">            self.fine_rank,</span><br><span class="line">            coarse_items,</span><br><span class="line">            user_id,</span><br><span class="line">            context</span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> fine_items</span><br></pre></td></tr></table></figure>
<h2 id="模型部署与监控">模型部署与监控</h2>
<h3 id="模型服务化">模型服务化</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelServer</span>:</span><br><span class="line">    <span class="string">"""模型服务"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_path</span>):</span><br><span class="line">        self.model = torch.load(model_path)</span><br><span class="line">        self.model.<span class="built_in">eval</span>()</span><br><span class="line">        self.feature_service = FeatureService()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, user_id, item_ids, context</span>):</span><br><span class="line">        <span class="string">"""预测接口"""</span></span><br><span class="line">        <span class="comment"># 获取特征</span></span><br><span class="line">        user_features = self.feature_service.get_user_features(user_id)</span><br><span class="line">        item_features_list = self.feature_service.get_item_features_batch(item_ids)</span><br><span class="line">        context_features = self.feature_service.get_context_features(context)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 批量预测</span></span><br><span class="line">        scores = []</span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            <span class="keyword">for</span> item_features <span class="keyword">in</span> item_features_list:</span><br><span class="line">                <span class="comment"># 构建输入</span></span><br><span class="line">                input_features = self._combine_features(</span><br><span class="line">                    user_features, </span><br><span class="line">                    item_features, </span><br><span class="line">                    context_features</span><br><span class="line">                )</span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 预测</span></span><br><span class="line">                score = self.model(input_features)</span><br><span class="line">                scores.append(score.item())</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> scores</span><br><span class="line"></span><br><span class="line">model_server = ModelServer(<span class="string">'model.pth'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">'/recommend'</span>, methods=[<span class="string">'POST'</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">recommend</span>():</span><br><span class="line">    <span class="string">"""推荐接口"""</span></span><br><span class="line">    data = request.json</span><br><span class="line">    user_id = data[<span class="string">'user_id'</span>]</span><br><span class="line">    item_ids = data.get(<span class="string">'item_ids'</span>, [])</span><br><span class="line">    context = data.get(<span class="string">'context'</span>, {})</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> item_ids:</span><br><span class="line">        <span class="comment"># 如果没有提供候选物品，先召回</span></span><br><span class="line">        item_ids = recall(user_id, top_k=<span class="number">100</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 预测分数</span></span><br><span class="line">    scores = model_server.predict(user_id, item_ids, context)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 排序</span></span><br><span class="line">    ranked_items = [</span><br><span class="line">        {<span class="string">'item_id'</span>: item_id, <span class="string">'score'</span>: score}</span><br><span class="line">        <span class="keyword">for</span> item_id, score <span class="keyword">in</span> <span class="built_in">zip</span>(item_ids, scores)</span><br><span class="line">    ]</span><br><span class="line">    ranked_items.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">'score'</span>], reverse=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> jsonify({</span><br><span class="line">        <span class="string">'user_id'</span>: user_id,</span><br><span class="line">        <span class="string">'recommendations'</span>: ranked_items[:<span class="number">20</span>]</span><br><span class="line">    })</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>
<h3 id="监控系统">监控系统</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ModelMonitor</span>:</span><br><span class="line">    <span class="string">"""模型监控"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.metrics = {</span><br><span class="line">            <span class="string">'latency'</span>: [],</span><br><span class="line">            <span class="string">'qps'</span>: [],</span><br><span class="line">            <span class="string">'error_rate'</span>: [],</span><br><span class="line">            <span class="string">'prediction_distribution'</span>: []</span><br><span class="line">        }</span><br><span class="line">        self.alert_thresholds = {</span><br><span class="line">            <span class="string">'latency_p99'</span>: <span class="number">200</span>,  <span class="comment"># ms</span></span><br><span class="line">            <span class="string">'error_rate'</span>: <span class="number">0.01</span>,  <span class="comment"># 1%</span></span><br><span class="line">            <span class="string">'qps_drop'</span>: <span class="number">0.2</span>  <span class="comment"># 20% 下降</span></span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">record_prediction</span>(<span class="params">self, latency_ms, score, error=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="string">"""记录预测"""</span></span><br><span class="line">        self.metrics[<span class="string">'latency'</span>].append(latency_ms)</span><br><span class="line">        self.metrics[<span class="string">'prediction_distribution'</span>].append(score)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> error:</span><br><span class="line">            self.metrics[<span class="string">'error_rate'</span>].append(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.metrics[<span class="string">'error_rate'</span>].append(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 检查告警</span></span><br><span class="line">        self._check_alerts()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_check_alerts</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""检查告警条件"""</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.metrics[<span class="string">'latency'</span>]) &lt; <span class="number">100</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># P99 延迟告警</span></span><br><span class="line">        p99_latency = np.percentile(self.metrics[<span class="string">'latency'</span>][-<span class="number">1000</span>:], <span class="number">99</span>)</span><br><span class="line">        <span class="keyword">if</span> p99_latency &gt; self.alert_thresholds[<span class="string">'latency_p99'</span>]:</span><br><span class="line">            self.send_alert(<span class="string">f'P99 latency exceeds threshold: <span class="subst">{p99_latency}</span>ms'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 错误率告警</span></span><br><span class="line">        recent_error_rate = np.mean(self.metrics[<span class="string">'error_rate'</span>][-<span class="number">1000</span>:])</span><br><span class="line">        <span class="keyword">if</span> recent_error_rate &gt; self.alert_thresholds[<span class="string">'error_rate'</span>]:</span><br><span class="line">            self.send_alert(<span class="string">f'Error rate exceeds threshold: <span class="subst">{recent_error_rate}</span>'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 预测分布异常检测</span></span><br><span class="line">        recent_scores = self.metrics[<span class="string">'prediction_distribution'</span>][-<span class="number">1000</span>:]</span><br><span class="line">        mean_score = np.mean(recent_scores)</span><br><span class="line">        std_score = np.std(recent_scores)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 如果预测分数分布发生显著变化，可能模型出现问题</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(mean_score - <span class="number">0.5</span>) &gt; <span class="number">0.3</span>:  <span class="comment"># 假设正常预测应该在 0.5 附近</span></span><br><span class="line">            self.send_alert(</span><br><span class="line">                <span class="string">f'Prediction distribution abnormal: mean=<span class="subst">{mean_score}</span>, std=<span class="subst">{std_score}</span>'</span></span><br><span class="line">            )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_alert</span>(<span class="params">self, message</span>):</span><br><span class="line">        <span class="string">"""发送告警"""</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f"ALERT: <span class="subst">{message}</span>"</span>)</span><br><span class="line">        <span class="comment"># 实际实现中应该发送到监控系统（如 Prometheus、Grafana）</span></span><br></pre></td></tr></table></figure>
<h3 id="模型热更新">模型热更新</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HotModelUpdater</span>:</span><br><span class="line">    <span class="string">"""模型热更新"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model_path, check_interval=<span class="number">300</span></span>):</span><br><span class="line">        self.model_path = model_path</span><br><span class="line">        self.check_interval = check_interval</span><br><span class="line">        self.current_model = <span class="literal">None</span></span><br><span class="line">        self.model_version = <span class="literal">None</span></span><br><span class="line">        self.load_model()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_model</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""加载模型"""</span></span><br><span class="line">        self.current_model = torch.load(self.model_path)</span><br><span class="line">        self.model_version = self._get_model_version()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_model_version</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""获取模型版本"""</span></span><br><span class="line">        <span class="comment"># 从文件修改时间或版本文件读取</span></span><br><span class="line">        <span class="keyword">import</span> os</span><br><span class="line">        mtime = os.path.getmtime(self.model_path)</span><br><span class="line">        <span class="keyword">return</span> mtime</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_and_update</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""检查并更新模型"""</span></span><br><span class="line">        new_version = self._get_model_version()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> new_version != self.model_version:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"New model detected: <span class="subst">{new_version}</span>"</span>)</span><br><span class="line">            self._update_model()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_update_model</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""更新模型"""</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 加载新模型</span></span><br><span class="line">            new_model = torch.load(self.model_path)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 验证模型</span></span><br><span class="line">            <span class="keyword">if</span> self._validate_model(new_model):</span><br><span class="line">                <span class="comment"># 原子性替换</span></span><br><span class="line">                self.current_model = new_model</span><br><span class="line">                self.model_version = self._get_model_version()</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f"Model updated successfully to version <span class="subst">{self.model_version}</span>"</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"New model validation failed, keeping current model"</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f"Error updating model: <span class="subst">{e}</span>"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_validate_model</span>(<span class="params">self, model</span>):</span><br><span class="line">        <span class="string">"""验证模型"""</span></span><br><span class="line">        <span class="comment"># 简单的验证：检查模型结构</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 尝试前向传播</span></span><br><span class="line">            dummy_input = torch.randn(<span class="number">1</span>, <span class="number">100</span>)  <span class="comment"># 根据实际输入维度调整</span></span><br><span class="line">            <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">                _ = model(dummy_input)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">start_background_update</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""后台更新线程"""</span></span><br><span class="line">        <span class="keyword">import</span> threading</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">update_loop</span>():</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                time.sleep(self.check_interval)</span><br><span class="line">                self.check_and_update()</span><br><span class="line">        </span><br><span class="line">        thread = threading.Thread(target=update_loop, daemon=<span class="literal">True</span>)</span><br><span class="line">        thread.start()</span><br></pre></td></tr></table></figure>
<h2 id="完整项目实战">完整项目实战</h2>
<h3 id="项目结构">项目结构</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">recommendation_system/</span><br><span class="line">├── config/</span><br><span class="line">│   ├── model_config.yaml</span><br><span class="line">│   └── feature_config.yaml</span><br><span class="line">├── src/</span><br><span class="line">│   ├── recall/</span><br><span class="line">│   │   ├── itemcf.py</span><br><span class="line">│   │   ├── content.py</span><br><span class="line">│   │   └── multi_channel.py</span><br><span class="line">│   ├── rank/</span><br><span class="line">│   │   ├── coarse_ranker.py</span><br><span class="line">│   │   ├── fine_ranker.py</span><br><span class="line">│   │   └── re_ranker.py</span><br><span class="line">│   ├── feature/</span><br><span class="line">│   │   ├── feature_engineering.py</span><br><span class="line">│   │   └── feature_service.py</span><br><span class="line">│   ├── model/</span><br><span class="line">│   │   ├── deepfm.py</span><br><span class="line">│   │   └── longer.py</span><br><span class="line">│   ├── service/</span><br><span class="line">│   │   ├── recommendation_service.py</span><br><span class="line">│   │   └── model_server.py</span><br><span class="line">│   └── utils/</span><br><span class="line">│       ├── cache.py</span><br><span class="line">│       └── monitor.py</span><br><span class="line">├── tests/</span><br><span class="line">├── scripts/</span><br><span class="line">│   ├── train.py</span><br><span class="line">│   └── deploy.py</span><br><span class="line">└── requirements.txt</span><br></pre></td></tr></table></figure>
<h3 id="完整推荐服务实现">完整推荐服务实现</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CompleteRecommendationService</span>:</span><br><span class="line">    <span class="string">"""完整的推荐服务"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config</span>):</span><br><span class="line">        self.config = config</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 初始化各个组件</span></span><br><span class="line">        self.recall_engine = MultiChannelRecall(config.recall_config)</span><br><span class="line">        self.coarse_ranker = CoarseRankerDualTower(config.coarse_ranker_config)</span><br><span class="line">        self.fine_ranker = DeepFM(config.fine_ranker_config)</span><br><span class="line">        self.re_ranker = DiversityReRanker(config.re_ranker_config)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 特征服务</span></span><br><span class="line">        self.feature_service = FeatureService(config.feature_config)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 缓存</span></span><br><span class="line">        self.cache = CacheStrategy(config.cache_config)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 监控</span></span><br><span class="line">        self.monitor = ModelMonitor()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># A/B 测试</span></span><br><span class="line">        self.ab_test = ABTestFramework(config.ab_test_config)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recommend</span>(<span class="params">self, user_id, context=<span class="literal">None</span>, top_k=<span class="number">20</span></span>):</span><br><span class="line">        <span class="string">"""完整推荐流程"""</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 1. A/B 测试分流</span></span><br><span class="line">            exp_name = self.config.get(<span class="string">'experiment_name'</span>, <span class="string">'default'</span>)</span><br><span class="line">            variant = self.ab_test.assign_variant(user_id, exp_name)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 2. 召回</span></span><br><span class="line">            recall_start = time.time()</span><br><span class="line">            recall_items = self.recall_engine.recall(</span><br><span class="line">                user_id, </span><br><span class="line">                top_k=self.config.recall_top_k</span><br><span class="line">            )</span><br><span class="line">            recall_latency = (time.time() - recall_start) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 3. 粗排</span></span><br><span class="line">            coarse_start = time.time()</span><br><span class="line">            coarse_items = self.coarse_ranker.rank(</span><br><span class="line">                recall_items, </span><br><span class="line">                user_id, </span><br><span class="line">                top_k=self.config.coarse_top_k</span><br><span class="line">            )</span><br><span class="line">            coarse_latency = (time.time() - coarse_start) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 4. 精排</span></span><br><span class="line">            fine_start = time.time()</span><br><span class="line">            fine_items = self.fine_ranker.rank(</span><br><span class="line">                coarse_items,</span><br><span class="line">                user_id,</span><br><span class="line">                context,</span><br><span class="line">                top_k=self.config.fine_top_k</span><br><span class="line">            )</span><br><span class="line">            fine_latency = (time.time() - fine_start) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 5. 重排序</span></span><br><span class="line">            re_rank_start = time.time()</span><br><span class="line">            final_items = self.re_ranker.re_rank(</span><br><span class="line">                fine_items,</span><br><span class="line">                user_id,</span><br><span class="line">                top_k=top_k</span><br><span class="line">            )</span><br><span class="line">            re_rank_latency = (time.time() - re_rank_start) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            total_latency = (time.time() - start_time) * <span class="number">1000</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 记录指标</span></span><br><span class="line">            self.monitor.record_prediction(total_latency, fine_items[<span class="number">0</span>][<span class="string">'score'</span>])</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># A/B 测试记录</span></span><br><span class="line">            self.ab_test.record_event(user_id, exp_name, <span class="string">'impression'</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> {</span><br><span class="line">                <span class="string">'user_id'</span>: user_id,</span><br><span class="line">                <span class="string">'recommendations'</span>: final_items,</span><br><span class="line">                <span class="string">'metrics'</span>: {</span><br><span class="line">                    <span class="string">'recall_latency_ms'</span>: recall_latency,</span><br><span class="line">                    <span class="string">'coarse_latency_ms'</span>: coarse_latency,</span><br><span class="line">                    <span class="string">'fine_latency_ms'</span>: fine_latency,</span><br><span class="line">                    <span class="string">'re_rank_latency_ms'</span>: re_rank_latency,</span><br><span class="line">                    <span class="string">'total_latency_ms'</span>: total_latency</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            self.monitor.record_prediction(</span><br><span class="line">                (time.time() - start_time) * <span class="number">1000</span>,</span><br><span class="line">                <span class="number">0</span>,</span><br><span class="line">                error=e</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>
<h2 id="常见问题-qa">常见问题 Q&amp;A</h2>
<h3 id="q1-召回层应该召回多少物品">Q1: 召回层应该召回多少物品？</h3>
<p><strong>A</strong>: 召回数量需要在效果和效率之间平衡。通常： -
<strong>召回数量</strong>：5000-10000 个物品 -
<strong>考虑因素</strong>： - 候选集大小：百万级候选集需要更多召回 -
精排模型复杂度：复杂模型可以处理更多候选 -
延迟要求：召回更多会增加延迟</p>
<p><strong>经验值</strong>： - 候选集 &lt; 100万：召回 3000-5000 -
候选集 100万-1000万：召回 5000-10000 - 候选集 &gt; 1000万：召回
10000+</p>
<h3 id="q2-如何选择粗排模型">Q2: 如何选择粗排模型？</h3>
<p><strong>A</strong>: 粗排模型选择原则：</p>
<ol type="1">
<li><strong>轻量级</strong>：推理速度快，P99 延迟 &lt; 20ms</li>
<li><strong>效果保证</strong>：与精排的相关性高（Spearman 相关系数 &gt;
0.7）</li>
<li><strong>可扩展</strong>：支持批量推理，GPU 利用率高</li>
</ol>
<p><strong>推荐方案</strong>： -
<strong>双塔模型</strong>：最常用，效果好且速度快 -
<strong>浅层神经网络</strong>：2-3 层，速度快但效果略差 -
<strong>线性模型</strong>：最快但效果一般</p>
<h3 id="q3-特征工程中哪些特征最重要">Q3: 特征工程中哪些特征最重要？</h3>
<p><strong>A</strong>: 重要特征排序（经验值）：</p>
<ol type="1">
<li><strong>用户-物品交互特征</strong>：最重要
<ul>
<li>用户历史点击/购买该物品的次数</li>
<li>用户对该物品类别的偏好</li>
</ul></li>
<li><strong>用户统计特征</strong>：
<ul>
<li>用户活跃度（7天/30天点击量）</li>
<li>用户偏好类别分布</li>
</ul></li>
<li><strong>物品统计特征</strong>：
<ul>
<li>物品 CTR（点击率）</li>
<li>物品热度（24小时点击量）</li>
</ul></li>
<li><strong>上下文特征</strong>：
<ul>
<li>时间特征（小时、星期）</li>
<li>设备特征</li>
</ul></li>
<li><strong>交叉特征</strong>：
<ul>
<li>用户类别 × 物品类别</li>
<li>用户价格偏好 × 物品价格</li>
</ul></li>
</ol>
<h3 id="q4-如何处理冷启动问题">Q4: 如何处理冷启动问题？</h3>
<p><strong>A</strong>: 冷启动分为用户冷启动和物品冷启动：</p>
<p><strong>用户冷启动</strong>： 1.
<strong>利用注册信息</strong>：年龄、性别、地域等 2.
<strong>热门推荐</strong>：推荐热门物品 3.
<strong>内容推荐</strong>：基于用户填写的兴趣标签 4.
<strong>探索策略</strong>：增加探索比例，快速收集用户行为</p>
<p><strong>物品冷启动</strong>： 1.
<strong>内容特征</strong>：文本、图像、类别等 2.
<strong>相似物品</strong>：找到内容相似的热门物品 3.
<strong>流量扶持</strong>：新品加权，增加曝光机会</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ColdStartHandler</span>:</span><br><span class="line">    <span class="string">"""冷启动处理"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recommend_for_new_user</span>(<span class="params">self, user_profile</span>):</span><br><span class="line">        <span class="string">"""新用户推荐"""</span></span><br><span class="line">        <span class="comment"># 1. 基于注册信息的内容推荐</span></span><br><span class="line">        <span class="keyword">if</span> user_profile.get(<span class="string">'interests'</span>):</span><br><span class="line">            items = self.content_based_recommend(</span><br><span class="line">                user_profile[<span class="string">'interests'</span>]</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> items:</span><br><span class="line">                <span class="keyword">return</span> items</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 热门推荐</span></span><br><span class="line">        <span class="keyword">return</span> self.popular_recommend(top_k=<span class="number">20</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recommend_new_item</span>(<span class="params">self, item_content_features</span>):</span><br><span class="line">        <span class="string">"""新物品推荐"""</span></span><br><span class="line">        <span class="comment"># 1. 找到内容相似的热门物品</span></span><br><span class="line">        similar_items = self.find_similar_items(</span><br><span class="line">            item_content_features,</span><br><span class="line">            top_k=<span class="number">100</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 2. 推荐给喜欢相似物品的用户</span></span><br><span class="line">        target_users = self.get_users_like_items(similar_items)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> target_users</span><br></pre></td></tr></table></figure>
<h3 id="q5-如何平衡准确性和多样性">Q5: 如何平衡准确性和多样性？</h3>
<p><strong>A</strong>: 多样性-准确性权衡：</p>
<ol type="1">
<li><strong>MMR 算法</strong>：在重排序层使用，可调节 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.027ex;" xmlns="http://www.w3.org/2000/svg" width="1.319ex" height="1.597ex" role="img" focusable="false" viewbox="0 -694 583 706"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g></g></g></svg></mjx-container></span> 参数</li>
<li><strong>类别多样性</strong>：限制每个类别的推荐数量</li>
<li><strong>时间多样性</strong>：避免重复推荐最近看过的内容</li>
</ol>
<p><strong>参数调优</strong>： - <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="7.228ex" height="1.756ex" role="img" focusable="false" viewbox="0 -694 3194.6 776"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="mo" transform="translate(860.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1916.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"/><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(778,0)"/></g></g></g></svg></mjx-container></span>：偏向准确性 - <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="7.228ex" height="1.756ex" role="img" focusable="false" viewbox="0 -694 3194.6 776"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="mo" transform="translate(860.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1916.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"/><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(778,0)"/></g></g></g></svg></mjx-container></span>：平衡 - <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="7.228ex" height="1.756ex" role="img" focusable="false" viewbox="0 -694 3194.6 776"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D706" d="M166 673Q166 685 183 694H202Q292 691 316 644Q322 629 373 486T474 207T524 67Q531 47 537 34T546 15T551 6T555 2T556 -2T550 -11H482Q457 3 450 18T399 152L354 277L340 262Q327 246 293 207T236 141Q211 112 174 69Q123 9 111 -1T83 -12Q47 -12 47 20Q47 37 61 52T199 187Q229 216 266 252T321 306L338 322Q338 323 288 462T234 612Q214 657 183 657Q166 657 166 673Z"/></g><g data-mml-node="mo" transform="translate(860.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1916.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"/><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(778,0)"/></g></g></g></svg></mjx-container></span>：偏向多样性</p>
<h3 id="q6-模型训练数据如何构建">Q6: 模型训练数据如何构建？</h3>
<p><strong>A</strong>: 训练数据构建要点：</p>
<ol type="1">
<li><strong>负样本采样</strong>：
<ul>
<li><strong>随机负采样</strong>：简单但可能引入噪声</li>
<li><strong>曝光未点击</strong>：更真实，推荐使用</li>
<li><strong>困难负样本</strong>：提升模型区分能力</li>
</ul></li>
<li><strong>时间窗口</strong>：
<ul>
<li>使用最近 30-90 天的数据</li>
<li>避免使用太旧的数据（用户兴趣会变化）</li>
</ul></li>
<li><strong>样本平衡</strong>：
<ul>
<li>正负样本比例 1:1 到 1:4</li>
<li>不同用户/物品的样本数量尽量平衡</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TrainingDataBuilder</span>:</span><br><span class="line">    <span class="string">"""训练数据构建"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_training_data</span>(<span class="params">self, click_logs, impressions, negative_ratio=<span class="number">4</span></span>):</span><br><span class="line">        <span class="string">"""构建训练数据"""</span></span><br><span class="line">        positive_samples = []</span><br><span class="line">        negative_samples = []</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 正样本：点击的</span></span><br><span class="line">        <span class="keyword">for</span> _, row <span class="keyword">in</span> click_logs.iterrows():</span><br><span class="line">            positive_samples.append({</span><br><span class="line">                <span class="string">'user_id'</span>: row[<span class="string">'user_id'</span>],</span><br><span class="line">                <span class="string">'item_id'</span>: row[<span class="string">'item_id'</span>],</span><br><span class="line">                <span class="string">'label'</span>: <span class="number">1</span>,</span><br><span class="line">                <span class="string">'timestamp'</span>: row[<span class="string">'timestamp'</span>]</span><br><span class="line">            })</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 负样本：曝光未点击</span></span><br><span class="line">        <span class="keyword">for</span> _, row <span class="keyword">in</span> impressions.iterrows():</span><br><span class="line">            <span class="keyword">if</span> row[<span class="string">'clicked'</span>] == <span class="number">0</span>:</span><br><span class="line">                negative_samples.append({</span><br><span class="line">                    <span class="string">'user_id'</span>: row[<span class="string">'user_id'</span>],</span><br><span class="line">                    <span class="string">'item_id'</span>: row[<span class="string">'item_id'</span>],</span><br><span class="line">                    <span class="string">'label'</span>: <span class="number">0</span>,</span><br><span class="line">                    <span class="string">'timestamp'</span>: row[<span class="string">'timestamp'</span>]</span><br><span class="line">                })</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 负样本采样</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(negative_samples) &gt; <span class="built_in">len</span>(positive_samples) * negative_ratio:</span><br><span class="line">            negative_samples = random.sample(</span><br><span class="line">                negative_samples,</span><br><span class="line">                <span class="built_in">len</span>(positive_samples) * negative_ratio</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 合并</span></span><br><span class="line">        training_data = positive_samples + negative_samples</span><br><span class="line">        random.shuffle(training_data)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> training_data</span><br></pre></td></tr></table></figure>
<h3 id="q7-如何评估推荐系统效果">Q7: 如何评估推荐系统效果？</h3>
<p><strong>A</strong>: 推荐系统评估指标：</p>
<p><strong>离线指标</strong>： 1. <strong>准确率指标</strong>： -
Precision@K：前 K 个推荐中相关的比例 - Recall@K：覆盖了多少相关物品 -
NDCG@K：考虑位置的排序质量</p>
<ol start="2" type="1">
<li><strong>覆盖率</strong>：
<ul>
<li>推荐物品的多样性</li>
<li>长尾物品的覆盖度</li>
</ul></li>
<li><strong>新颖性</strong>：
<ul>
<li>推荐物品的平均热度（越低越新颖）</li>
</ul></li>
</ol>
<p><strong>在线指标</strong>： 1.
<strong>CTR（点击率）</strong>：最重要的业务指标 2.
<strong>CVR（转化率）</strong>：购买/下载等转化行为 3.
<strong>停留时长</strong>：用户对推荐内容的参与度 4.
<strong>GMV（成交总额）</strong>：电商场景的核心指标</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RecommendationEvaluator</span>:</span><br><span class="line">    <span class="string">"""推荐系统评估器"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">evaluate_offline</span>(<span class="params">self, recommendations, ground_truth</span>):</span><br><span class="line">        <span class="string">"""离线评估"""</span></span><br><span class="line">        metrics = {}</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Precision@K</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> [<span class="number">5</span>, <span class="number">10</span>, <span class="number">20</span>]:</span><br><span class="line">            precision = self.precision_at_k(</span><br><span class="line">                recommendations, ground_truth, k</span><br><span class="line">            )</span><br><span class="line">            metrics[<span class="string">f'precision@<span class="subst">{k}</span>'</span>] = precision</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Recall@K</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> [<span class="number">5</span>, <span class="number">10</span>, <span class="number">20</span>]:</span><br><span class="line">            recall = self.recall_at_k(</span><br><span class="line">                recommendations, ground_truth, k</span><br><span class="line">            )</span><br><span class="line">            metrics[<span class="string">f'recall@<span class="subst">{k}</span>'</span>] = recall</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># NDCG@K</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> [<span class="number">5</span>, <span class="number">10</span>, <span class="number">20</span>]:</span><br><span class="line">            ndcg = self.ndcg_at_k(</span><br><span class="line">                recommendations, ground_truth, k</span><br><span class="line">            )</span><br><span class="line">            metrics[<span class="string">f'ndcg@<span class="subst">{k}</span>'</span>] = ndcg</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> metrics</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">precision_at_k</span>(<span class="params">self, recommendations, ground_truth, k</span>):</span><br><span class="line">        <span class="string">"""Precision@K"""</span></span><br><span class="line">        top_k = recommendations[:k]</span><br><span class="line">        relevant = <span class="built_in">set</span>(ground_truth)</span><br><span class="line">        hits = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> item <span class="keyword">in</span> top_k <span class="keyword">if</span> item <span class="keyword">in</span> relevant)</span><br><span class="line">        <span class="keyword">return</span> hits / k</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recall_at_k</span>(<span class="params">self, recommendations, ground_truth, k</span>):</span><br><span class="line">        <span class="string">"""Recall@K"""</span></span><br><span class="line">        top_k = recommendations[:k]</span><br><span class="line">        relevant = <span class="built_in">set</span>(ground_truth)</span><br><span class="line">        hits = <span class="built_in">sum</span>(<span class="number">1</span> <span class="keyword">for</span> item <span class="keyword">in</span> top_k <span class="keyword">if</span> item <span class="keyword">in</span> relevant)</span><br><span class="line">        <span class="keyword">return</span> hits / <span class="built_in">len</span>(relevant) <span class="keyword">if</span> relevant <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ndcg_at_k</span>(<span class="params">self, recommendations, ground_truth, k</span>):</span><br><span class="line">        <span class="string">"""NDCG@K"""</span></span><br><span class="line">        <span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> ndcg_score</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 构建 relevance 向量</span></span><br><span class="line">        y_true = [<span class="number">1</span> <span class="keyword">if</span> item <span class="keyword">in</span> ground_truth <span class="keyword">else</span> <span class="number">0</span> </span><br><span class="line">                  <span class="keyword">for</span> item <span class="keyword">in</span> recommendations[:k]]</span><br><span class="line">        y_score = <span class="built_in">list</span>(<span class="built_in">range</span>(k, <span class="number">0</span>, -<span class="number">1</span>))  <span class="comment"># 假设分数递减</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">sum</span>(y_true) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> ndcg_score([y_true], [y_score], k=k)</span><br></pre></td></tr></table></figure>
<h3 id="q8-如何处理数据稀疏性问题">Q8: 如何处理数据稀疏性问题？</h3>
<p><strong>A</strong>: 数据稀疏性处理：</p>
<ol type="1">
<li><strong>矩阵分解</strong>：SVD、NMF 等降维方法</li>
<li><strong>深度学习</strong>：Embedding 层学习稠密表示</li>
<li><strong>迁移学习</strong>：利用其他域的数据</li>
<li><strong>内容特征</strong>：补充协同过滤的不足</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SparseDataHandler</span>:</span><br><span class="line">    <span class="string">"""稀疏数据处理"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, user_item_matrix</span>):</span><br><span class="line">        self.user_item_matrix = user_item_matrix</span><br><span class="line">        self.sparsity = self._calculate_sparsity()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_calculate_sparsity</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""计算稀疏度"""</span></span><br><span class="line">        total = self.user_item_matrix.size</span><br><span class="line">        non_zero = self.user_item_matrix.nnz</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> - (non_zero / total)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">handle_sparsity</span>(<span class="params">self, method=<span class="string">'embedding'</span></span>):</span><br><span class="line">        <span class="string">"""处理稀疏性"""</span></span><br><span class="line">        <span class="keyword">if</span> method == <span class="string">'embedding'</span>:</span><br><span class="line">            <span class="comment"># 使用 Embedding 学习稠密表示</span></span><br><span class="line">            <span class="keyword">return</span> self._learn_embeddings()</span><br><span class="line">        <span class="keyword">elif</span> method == <span class="string">'matrix_factorization'</span>:</span><br><span class="line">            <span class="comment"># 矩阵分解</span></span><br><span class="line">            <span class="keyword">return</span> self._matrix_factorization()</span><br><span class="line">        <span class="keyword">elif</span> method == <span class="string">'content_boost'</span>:</span><br><span class="line">            <span class="comment"># 内容特征增强</span></span><br><span class="line">            <span class="keyword">return</span> self._content_boost()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_learn_embeddings</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""学习 Embedding"""</span></span><br><span class="line">        <span class="keyword">from</span> gensim.models <span class="keyword">import</span> Word2Vec</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将用户-物品交互序列化</span></span><br><span class="line">        sequences = []</span><br><span class="line">        <span class="keyword">for</span> user_id <span class="keyword">in</span> <span class="built_in">range</span>(self.user_item_matrix.shape[<span class="number">0</span>]):</span><br><span class="line">            items = self.user_item_matrix[user_id].nonzero()[<span class="number">1</span>].tolist()</span><br><span class="line">            sequences.append([<span class="built_in">str</span>(item) <span class="keyword">for</span> item <span class="keyword">in</span> items])</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 训练 Word2Vec</span></span><br><span class="line">        model = Word2Vec(sequences, vector_size=<span class="number">64</span>, window=<span class="number">5</span>, min_count=<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>
<h3 id="q9-推荐系统如何应对流量峰值">Q9: 推荐系统如何应对流量峰值？</h3>
<p><strong>A</strong>: 流量峰值应对策略：</p>
<ol type="1">
<li><strong>水平扩容</strong>：
<ul>
<li>无状态服务，支持多实例部署</li>
<li>使用负载均衡分发请求</li>
</ul></li>
<li><strong>缓存策略</strong>：
<ul>
<li>热门用户/物品的推荐结果缓存</li>
<li>特征缓存减少计算</li>
</ul></li>
<li><strong>降级策略</strong>：
<ul>
<li>流量过大时简化模型（如只用召回+粗排）</li>
<li>返回缓存结果</li>
</ul></li>
<li><strong>限流</strong>：
<ul>
<li>对非核心用户限流</li>
<li>保护核心服务</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TrafficPeakHandler</span>:</span><br><span class="line">    <span class="string">"""流量峰值处理"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, max_qps=<span class="number">10000</span></span>):</span><br><span class="line">        self.max_qps = max_qps</span><br><span class="line">        self.current_qps = <span class="number">0</span></span><br><span class="line">        self.cache = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">recommend_with_fallback</span>(<span class="params">self, user_id, context</span>):</span><br><span class="line">        <span class="string">"""带降级的推荐"""</span></span><br><span class="line">        <span class="comment"># 检查 QPS</span></span><br><span class="line">        <span class="keyword">if</span> self.current_qps &gt; self.max_qps:</span><br><span class="line">            <span class="comment"># 降级：返回缓存或简化推荐</span></span><br><span class="line">            <span class="keyword">if</span> user_id <span class="keyword">in</span> self.cache:</span><br><span class="line">                <span class="keyword">return</span> self.cache[user_id]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> self.simple_recommend(user_id)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 正常流程</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = self.full_recommend(user_id, context)</span><br><span class="line">            <span class="comment"># 缓存结果</span></span><br><span class="line">            self.cache[user_id] = result</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 异常时降级</span></span><br><span class="line">            <span class="keyword">return</span> self.simple_recommend(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">simple_recommend</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="string">"""简化推荐（只用召回）"""</span></span><br><span class="line">        <span class="keyword">return</span> self.recall_engine.recall(user_id, top_k=<span class="number">20</span>)</span><br></pre></td></tr></table></figure>
<h3 id="q10-如何实现实时推荐">Q10: 如何实现实时推荐？</h3>
<p><strong>A</strong>: 实时推荐实现：</p>
<ol type="1">
<li><strong>实时特征</strong>：
<ul>
<li>使用 Kafka/Flink 处理实时数据流</li>
<li>Redis 存储实时特征</li>
</ul></li>
<li><strong>实时召回</strong>：
<ul>
<li>基于用户最近行为快速召回</li>
<li>向量检索（如 Faiss）加速</li>
</ul></li>
<li><strong>模型更新</strong>：
<ul>
<li>增量学习：只训练新数据</li>
<li>在线学习：流式更新模型参数</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">RealTimeRecommendation</span>:</span><br><span class="line">    <span class="string">"""实时推荐"""</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, kafka_consumer, redis_client</span>):</span><br><span class="line">        self.kafka_consumer = kafka_consumer</span><br><span class="line">        self.redis = redis_client</span><br><span class="line">        self.user_recent_actions = {}</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_real_time_events</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">"""处理实时事件流"""</span></span><br><span class="line">        <span class="keyword">for</span> message <span class="keyword">in</span> self.kafka_consumer:</span><br><span class="line">            event = json.loads(message.value)</span><br><span class="line">            user_id = event[<span class="string">'user_id'</span>]</span><br><span class="line">            item_id = event[<span class="string">'item_id'</span>]</span><br><span class="line">            action_type = event[<span class="string">'action_type'</span>]</span><br><span class="line">            timestamp = event[<span class="string">'timestamp'</span>]</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 更新用户实时行为</span></span><br><span class="line">            self.update_user_actions(user_id, item_id, action_type, timestamp)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 触发实时推荐更新</span></span><br><span class="line">            <span class="keyword">if</span> action_type <span class="keyword">in</span> [<span class="string">'click'</span>, <span class="string">'purchase'</span>]:</span><br><span class="line">                self.update_recommendations(user_id)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_user_actions</span>(<span class="params">self, user_id, item_id, action_type, timestamp</span>):</span><br><span class="line">        <span class="string">"""更新用户行为"""</span></span><br><span class="line">        key = <span class="string">f"realtime:user:<span class="subst">{user_id}</span>"</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 存储到 Redis sorted set</span></span><br><span class="line">        self.redis.zadd(key, {<span class="string">f"<span class="subst">{item_id}</span>:<span class="subst">{action_type}</span>"</span>: timestamp})</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 只保留最近 1 小时</span></span><br><span class="line">        cutoff = timestamp - <span class="number">3600</span></span><br><span class="line">        self.redis.zremrangebyscore(key, <span class="number">0</span>, cutoff)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">update_recommendations</span>(<span class="params">self, user_id</span>):</span><br><span class="line">        <span class="string">"""更新推荐结果"""</span></span><br><span class="line">        <span class="comment"># 获取实时行为</span></span><br><span class="line">        recent_items = self.get_recent_items(user_id, minutes=<span class="number">30</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 基于实时行为召回</span></span><br><span class="line">        realtime_items = self.realtime_recall(user_id, recent_items)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 更新推荐缓存</span></span><br><span class="line">        cache_key = <span class="string">f"recommendations:<span class="subst">{user_id}</span>"</span></span><br><span class="line">        self.redis.setex(cache_key, <span class="number">300</span>, json.dumps(realtime_items))</span><br></pre></td></tr></table></figure>
<h2 id="总结">总结</h2>
<p>工业级推荐系统是一个复杂的系统工程，涉及召回、排序、重排序多个层次，需要综合考虑效果、性能、可维护性等多个方面。本文从架构设计、模型选择、特征工程、A/B
测试、性能优化、部署监控等角度全面介绍了工业推荐系统的最佳实践。</p>
<p>关键要点：</p>
<ol type="1">
<li><strong>分层架构</strong>：召回-粗排-精排-重排序的漏斗设计，平衡效果和效率</li>
<li><strong>多路召回</strong>：协同过滤、内容、热门、实时等多通道融合</li>
<li><strong>特征工程</strong>：自动化特征生成和选择，提升模型效果</li>
<li><strong>A/B 测试</strong>：科学评估模型改进，确保线上效果</li>
<li><strong>性能优化</strong>：模型量化、缓存、异步处理等技巧</li>
<li><strong>监控告警</strong>：实时监控系统健康，及时发现问题</li>
</ol>
<p>推荐系统的优化是一个持续迭代的过程，需要不断根据业务反馈调整策略和模型。希望本文能为构建工业级推荐系统提供有价值的参考。</p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    
    
    
    
    
    
    <ul>
        <li>本文标题：推荐系统（十六）—— 工业级架构与最佳实践</li>
        <li>本文作者：Chen Kai</li>
        <li>创建时间：2025-12-29 00:00:00</li>
        <li>
            本文链接：https://www.chenk.top/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%EF%BC%88%E5%8D%81%E5%85%AD%EF%BC%89%E2%80%94%E2%80%94-%E5%B7%A5%E4%B8%9A%E7%BA%A7%E6%9E%B6%E6%9E%84%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/
        </li>
        <li>
            版权声明：本博客所有文章除特别声明外，均采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> 许可协议。转载请注明出处！
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Recommendation-Systems/">#Recommendation Systems</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/Industrial-Practice/">#Industrial Practice</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/System-Architecture/">#System Architecture</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97%EF%BC%9A%E4%BB%8E%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%88%B0%E9%AB%98%E7%BA%A7%E4%BC%98%E5%8C%96/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">提示词工程完全指南：从零基础到高级优化</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89%E2%80%94%E2%80%94-%E5%AE%9E%E6%97%B6%E6%8E%A8%E8%8D%90%E4%B8%8E%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">推荐系统（十五）—— 实时推荐与在线学习</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div class="valine-container">
        <script data-pjax
                src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
        <div id="vcomments"></div>
        <script data-pjax>
            function loadValine() {
                new Valine({
                    el: '#vcomments',
                    appId: 'p2Cu9MgjoKzo3VmulhNLIusH-gzGzoHsz',
                    appKey: 'QThQHg3c8sVwGpzg9lu8zEG3',
                    meta: ['nick', 'mail', 'link'],
                    avatar: 'wavatar',
                    enableQQ: true,
                    placeholder: '😜 尽情赞美帅气伟大的ck吧~',
                    lang: 'zh-CN'.toLowerCase()
                });

                function getAuthor(language) {
                    switch (language) {
                        case 'en':
                            return 'Author';
                        case 'zh-CN':
                            return '博主';
                        default:
                            return 'Master';
                    }
                }

                // Add "Author" identify
                const getValineDomTimer = setInterval(() => {
                    const vcards = document.querySelectorAll('#vcomments .vcards .vcard');
                    if (vcards.length > 0) {
                        let author = 'Chen Kai';

                        if (author) {
                            for (let vcard of vcards) {
                                const vnick_dom = vcard.querySelector('.vhead .vnick');
                                const vnick = vnick_dom.innerHTML;
                                if (vnick === author) {
                                    vnick_dom.innerHTML = `${vnick} <span class="author">${getAuthor(KEEP.hexo_config.language)}</span>`
                                }
                            }
                        }
                        clearInterval(getValineDomTimer);
                    } else {
                        clearInterval(getValineDomTimer);
                    }
                }, 2000);
            }

            if ('true') {
                const loadValineTimeout = setTimeout(() => {
                    loadValine();
                    clearTimeout(loadValineTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadValine);
            }
        </script>
    </div>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2026&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Chen Kai</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
            </div>
        
        <div class="theme-info info-item">
            <!-- 由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a> -->
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B7%A5%E4%B8%9A%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%85%A8%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">工业推荐系统全景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88"><span class="nav-number">1.1.</span> <span class="nav-text">系统架构概览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E4%B8%8E-sla"><span class="nav-number">1.2.</span> <span class="nav-text">性能指标与 SLA</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%AC%E5%9B%9E%E5%B1%82%E8%AE%BE%E8%AE%A1%E5%A4%9A%E8%B7%AF%E5%8F%AC%E5%9B%9E%E7%AD%96%E7%95%A5"><span class="nav-number">2.</span> <span class="nav-text">召回层设计：多路召回策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8F%E5%90%8C%E8%BF%87%E6%BB%A4%E5%8F%AC%E5%9B%9E"><span class="nav-number">2.1.</span> <span class="nav-text">协同过滤召回</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%8D%8F%E5%90%8C%E8%BF%87%E6%BB%A4usercf"><span class="nav-number">2.1.1.</span> <span class="nav-text">用户协同过滤（UserCF）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%A9%E5%93%81%E5%8D%8F%E5%90%8C%E8%BF%87%E6%BB%A4itemcf"><span class="nav-number">2.1.2.</span> <span class="nav-text">物品协同过滤（ItemCF）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AE%B9%E5%8F%AC%E5%9B%9E"><span class="nav-number">2.2.</span> <span class="nav-text">内容召回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E9%97%A8%E5%8F%AC%E5%9B%9E"><span class="nav-number">2.3.</span> <span class="nav-text">热门召回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E6%97%B6%E5%8F%AC%E5%9B%9E"><span class="nav-number">2.4.</span> <span class="nav-text">实时召回</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E8%B7%AF%E5%8F%AC%E5%9B%9E%E8%9E%8D%E5%90%88"><span class="nav-number">2.5.</span> <span class="nav-text">多路召回融合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B2%97%E6%8E%92%E4%B8%8E%E7%B2%BE%E6%8E%92"><span class="nav-number">3.</span> <span class="nav-text">粗排与精排</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B2%97%E6%8E%92%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.1.</span> <span class="nav-text">粗排层设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8C%E5%A1%94%E6%A8%A1%E5%9E%8B%E7%B2%97%E6%8E%92"><span class="nav-number">3.1.1.</span> <span class="nav-text">双塔模型粗排</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B2%97%E6%8E%92%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-number">3.1.2.</span> <span class="nav-text">粗排优化技巧</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B2%BE%E6%8E%92%E5%B1%82%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.2.</span> <span class="nav-text">精排层设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#deepfm-%E7%B2%BE%E6%8E%92%E6%A8%A1%E5%9E%8B"><span class="nav-number">3.2.1.</span> <span class="nav-text">DeepFM 精排模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B"><span class="nav-number">3.2.2.</span> <span class="nav-text">特征工程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%8D%E6%8E%92%E5%BA%8F%E7%AD%96%E7%95%A5"><span class="nav-number">4.</span> <span class="nav-text">重排序策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%A0%B7%E6%80%A7%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="nav-number">4.1.</span> <span class="nav-text">多样性重排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E9%A2%96%E6%80%A7%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="nav-number">4.2.</span> <span class="nav-text">新颖性重排序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E8%A7%84%E5%88%99%E9%87%8D%E6%8E%92%E5%BA%8F"><span class="nav-number">4.3.</span> <span class="nav-text">业务规则重排序</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#easyrec-%E6%A1%86%E6%9E%B6%E5%AE%9E%E8%B7%B5"><span class="nav-number">5.</span> <span class="nav-text">EasyRec 框架实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#easyrec-%E6%9E%B6%E6%9E%84"><span class="nav-number">5.1.</span> <span class="nav-text">EasyRec 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easyrec-%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="nav-number">5.2.</span> <span class="nav-text">EasyRec 使用示例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easyrec-%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B"><span class="nav-number">5.3.</span> <span class="nav-text">EasyRec 特征工程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#longer-%E9%95%BF%E5%BA%8F%E5%88%97%E5%BB%BA%E6%A8%A1"><span class="nav-number">6.</span> <span class="nav-text">LONGER 长序列建模</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%95%BF%E5%BA%8F%E5%88%97%E6%8C%91%E6%88%98"><span class="nav-number">6.1.</span> <span class="nav-text">长序列挑战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#longer-%E6%9E%B6%E6%9E%84"><span class="nav-number">6.2.</span> <span class="nav-text">LONGER 架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#longer-%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-number">6.3.</span> <span class="nav-text">LONGER 优化技巧</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B%E8%87%AA%E5%8A%A8%E5%8C%96"><span class="nav-number">7.</span> <span class="nav-text">特征工程自动化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E7%89%B9%E5%BE%81%E7%94%9F%E6%88%90"><span class="nav-number">7.1.</span> <span class="nav-text">自动特征生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%89%B9%E5%BE%81%E9%80%89%E6%8B%A9"><span class="nav-number">7.2.</span> <span class="nav-text">特征选择</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ab-%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95%E8%AE%BA"><span class="nav-number">8.</span> <span class="nav-text">A&#x2F;B 测试方法论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ab-%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6"><span class="nav-number">8.1.</span> <span class="nav-text">A&#x2F;B 测试框架</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ab-%E6%B5%8B%E8%AF%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">8.2.</span> <span class="nav-text">A&#x2F;B 测试最佳实践</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%8A%80%E5%B7%A7"><span class="nav-number">9.</span> <span class="nav-text">性能优化技巧</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86%E4%BC%98%E5%8C%96"><span class="nav-number">9.1.</span> <span class="nav-text">模型推理优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5"><span class="nav-number">9.2.</span> <span class="nav-text">缓存策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E5%A4%84%E7%90%86"><span class="nav-number">9.3.</span> <span class="nav-text">异步处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E9%83%A8%E7%BD%B2%E4%B8%8E%E7%9B%91%E6%8E%A7"><span class="nav-number">10.</span> <span class="nav-text">模型部署与监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%8C%96"><span class="nav-number">10.1.</span> <span class="nav-text">模型服务化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%91%E6%8E%A7%E7%B3%BB%E7%BB%9F"><span class="nav-number">10.2.</span> <span class="nav-text">监控系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-number">10.3.</span> <span class="nav-text">模型热更新</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98"><span class="nav-number">11.</span> <span class="nav-text">完整项目实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">11.1.</span> <span class="nav-text">项目结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E6%8E%A8%E8%8D%90%E6%9C%8D%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="nav-number">11.2.</span> <span class="nav-text">完整推荐服务实现</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-qa"><span class="nav-number">12.</span> <span class="nav-text">常见问题 Q&amp;A</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#q1-%E5%8F%AC%E5%9B%9E%E5%B1%82%E5%BA%94%E8%AF%A5%E5%8F%AC%E5%9B%9E%E5%A4%9A%E5%B0%91%E7%89%A9%E5%93%81"><span class="nav-number">12.1.</span> <span class="nav-text">Q1: 召回层应该召回多少物品？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q2-%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9%E7%B2%97%E6%8E%92%E6%A8%A1%E5%9E%8B"><span class="nav-number">12.2.</span> <span class="nav-text">Q2: 如何选择粗排模型？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q3-%E7%89%B9%E5%BE%81%E5%B7%A5%E7%A8%8B%E4%B8%AD%E5%93%AA%E4%BA%9B%E7%89%B9%E5%BE%81%E6%9C%80%E9%87%8D%E8%A6%81"><span class="nav-number">12.3.</span> <span class="nav-text">Q3: 特征工程中哪些特征最重要？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q4-%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E5%86%B7%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98"><span class="nav-number">12.4.</span> <span class="nav-text">Q4: 如何处理冷启动问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q5-%E5%A6%82%E4%BD%95%E5%B9%B3%E8%A1%A1%E5%87%86%E7%A1%AE%E6%80%A7%E5%92%8C%E5%A4%9A%E6%A0%B7%E6%80%A7"><span class="nav-number">12.5.</span> <span class="nav-text">Q5: 如何平衡准确性和多样性？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q6-%E6%A8%A1%E5%9E%8B%E8%AE%AD%E7%BB%83%E6%95%B0%E6%8D%AE%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA"><span class="nav-number">12.6.</span> <span class="nav-text">Q6: 模型训练数据如何构建？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q7-%E5%A6%82%E4%BD%95%E8%AF%84%E4%BC%B0%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E6%95%88%E6%9E%9C"><span class="nav-number">12.7.</span> <span class="nav-text">Q7: 如何评估推荐系统效果？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q8-%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E7%A8%80%E7%96%8F%E6%80%A7%E9%97%AE%E9%A2%98"><span class="nav-number">12.8.</span> <span class="nav-text">Q8: 如何处理数据稀疏性问题？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q9-%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E6%B5%81%E9%87%8F%E5%B3%B0%E5%80%BC"><span class="nav-number">12.9.</span> <span class="nav-text">Q9: 推荐系统如何应对流量峰值？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#q10-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%8E%A8%E8%8D%90"><span class="nav-number">12.10.</span> <span class="nav-text">Q10: 如何实现实时推荐？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">13.</span> <span class="nav-text">总结</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>

<script src="/js/lang-switch.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
